# 第六阶段: 支付系统开发计划

## 阶段概述
**时间周期**: 1.5周  
**优先级**: 高  
**依赖**: 积分系统、套餐管理系统完成  
**目标**: 集成现有mall系统支付功能，实现积分购买和套餐订阅的完整支付流程，支持购买后自动发货

## 功能需求详细分析

### 核心功能清单
1. **订单管理系统** - 为积分和套餐购买创建订单
2. **支付宝集成** - 复用现有支付宝支付功能
3. **支付成功回调** - 处理支付成功后的业务逻辑
4. **自动发货机制** - 积分自动到账、套餐自动激活
5. **订单状态管理** - 支付中、已支付、已发货、已完成等状态
6. **退款处理** - 支持订单退款和积分/套餐回退
7. **支付记录查询** - 用户查看支付历史记录

### 业务规则设计
```
支付系统业务规则：
1. 订单30分钟内未支付自动取消
2. 积分购买支付成功后立即发放
3. 套餐购买支付成功后立即激活
4. 支持7天无理由退款
5. 退款后积分按使用情况部分退还
6. 套餐退款按剩余时间比例计算
7. 重复支付自动退款处理
```

## 技术架构设计

### 支付流程设计
```
用户购买流程：
1. 选择商品（积分包/套餐）
2. 创建订单并生成支付参数
3. 跳转支付宝进行支付
4. 支付完成后回调处理
5. 自动发货（积分到账/套餐激活）
6. 发送确认通知

技术实现：
- 复用mall-portal现有支付宝集成
- 扩展订单表支持积分和套餐商品
- 实现支付后钩子机制
- 添加自动发货逻辑
```

## 数据库设计扩展

### 订单系统扩展
```sql
-- 扩展订单表，添加商品类型字段
ALTER TABLE oms_order ADD COLUMN product_type TINYINT DEFAULT 1 COMMENT '商品类型: 1-普通商品, 2-积分商品, 3-套餐商品';
ALTER TABLE oms_order ADD COLUMN auto_delivery TINYINT DEFAULT 0 COMMENT '是否自动发货: 0-否, 1-是';
ALTER TABLE oms_order ADD COLUMN delivery_status TINYINT DEFAULT 0 COMMENT '发货状态: 0-未发货, 1-已发货, 2-发货失败';
ALTER TABLE oms_order ADD COLUMN delivery_time DATETIME COMMENT '发货时间';
ALTER TABLE oms_order ADD COLUMN callback_data JSON COMMENT '支付回调数据';

-- 订单商品表扩展
ALTER TABLE oms_order_item ADD COLUMN product_type TINYINT DEFAULT 1 COMMENT '商品类型: 1-普通商品, 2-积分商品, 3-套餐商品';
ALTER TABLE oms_order_item ADD COLUMN credits_amount INT COMMENT '积分数量(积分商品时使用)';
ALTER TABLE oms_order_item ADD COLUMN subscription_months INT COMMENT '订阅月数(套餐商品时使用)';

-- 支付记录表
CREATE TABLE oms_payment_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    member_id BIGINT NOT NULL COMMENT '会员ID',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    order_sn VARCHAR(64) NOT NULL COMMENT '订单编号',
    payment_method VARCHAR(32) NOT NULL COMMENT '支付方式: alipay, wechat',
    payment_amount DECIMAL(10,2) NOT NULL COMMENT '支付金额',
    trade_no VARCHAR(128) COMMENT '第三方交易号',
    payment_status TINYINT DEFAULT 0 COMMENT '支付状态: 0-待支付, 1-支付成功, 2-支付失败, 3-已退款',
    payment_time DATETIME COMMENT '支付时间',
    callback_time DATETIME COMMENT '回调时间',
    refund_amount DECIMAL(10,2) DEFAULT 0 COMMENT '退款金额',
    refund_time DATETIME COMMENT '退款时间',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_member_id (member_id),
    INDEX idx_order_id (order_id),
    INDEX idx_trade_no (trade_no),
    INDEX idx_payment_time (payment_time)
);

-- 自动发货记录表
CREATE TABLE oms_delivery_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL COMMENT '订单ID',
    member_id BIGINT NOT NULL COMMENT '会员ID',
    product_type TINYINT NOT NULL COMMENT '商品类型',
    delivery_type VARCHAR(32) NOT NULL COMMENT '发货类型: credits, subscription',
    delivery_data JSON COMMENT '发货数据',
    delivery_status TINYINT DEFAULT 0 COMMENT '发货状态: 0-待发货, 1-发货成功, 2-发货失败',
    retry_count INT DEFAULT 0 COMMENT '重试次数',
    error_message TEXT COMMENT '错误信息',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_order_id (order_id),
    INDEX idx_member_id (member_id),
    INDEX idx_status (delivery_status)
);
```

## 详细开发任务

### 第1-2天: 订单系统扩展

#### 1.1 扩展订单服务
```java
// PaymentOrderService.java
@Service
@Transactional
public class PaymentOrderServiceImpl implements PaymentOrderService {
    
    @Autowired
    private OmsOrderMapper orderMapper;
    
    @Autowired
    private OmsOrderItemMapper orderItemMapper;
    
    @Autowired
    private PmsCreditProductService creditProductService;
    
    @Autowired
    private UmsSubscriptionPlansService subscriptionService;
    
    @Override
    public OmsOrder createCreditsOrder(Long memberId, Long productId) {
        PmsCreditProduct product = creditProductService.getById(productId);
        if (product == null || product.getStatus() != 1) {
            throw new BusinessException("商品不存在或已下架");
        }
        
        // 创建订单
        OmsOrder order = new OmsOrder();
        order.setMemberId(memberId);
        order.setOrderSn(generateOrderSn());
        order.setProductType(2); // 积分商品
        order.setAutoDelivery(1); // 自动发货
        order.setTotalAmount(product.getPrice());
        order.setPayAmount(product.getPrice());
        order.setStatus(0); // 待付款
        order.setOrderType(1); // 正常订单
        order.setSourceType(1); // PC订单
        order.setCreateTime(new Date());
        
        orderMapper.insert(order);
        
        // 创建订单项
        OmsOrderItem orderItem = new OmsOrderItem();
        orderItem.setOrderId(order.getId());
        orderItem.setOrderSn(order.getOrderSn());
        orderItem.setProductId(productId);
        orderItem.setProductName(product.getName());
        orderItem.setProductType(2); // 积分商品
        orderItem.setCreditsAmount(product.getCreditAmount());
        orderItem.setProductPrice(product.getPrice());
        orderItem.setProductQuantity(1);
        orderItem.setProductPic(""); // 可以设置默认图片
        orderItem.setRealAmount(product.getPrice());
        
        orderItemMapper.insert(orderItem);
        
        return order;
    }
    
    @Override
    public OmsOrder createSubscriptionOrder(Long memberId, Long planId, BillingCycle billingCycle) {
        UmsSubscriptionPlans plan = subscriptionService.getPlanById(planId);
        if (plan == null || plan.getIsActive() != 1) {
            throw new BusinessException("套餐不存在或已停用");
        }
        
        BigDecimal price = billingCycle == BillingCycle.MONTHLY ? 
            plan.getPriceMonthly() : plan.getPriceYearly();
        int months = billingCycle == BillingCycle.MONTHLY ? 1 : 12;
        
        // 创建订单
        OmsOrder order = new OmsOrder();
        order.setMemberId(memberId);
        order.setOrderSn(generateOrderSn());
        order.setProductType(3); // 套餐商品
        order.setAutoDelivery(1); // 自动发货
        order.setTotalAmount(price);
        order.setPayAmount(price);
        order.setStatus(0); // 待付款
        order.setOrderType(1); // 正常订单
        order.setSourceType(1); // PC订单
        order.setCreateTime(new Date());
        
        orderMapper.insert(order);
        
        // 创建订单项
        OmsOrderItem orderItem = new OmsOrderItem();
        orderItem.setOrderId(order.getId());
        orderItem.setOrderSn(order.getOrderSn());
        orderItem.setProductId(planId);
        orderItem.setProductName(plan.getName() + "套餐");
        orderItem.setProductType(3); // 套餐商品
        orderItem.setSubscriptionMonths(months);
        orderItem.setProductPrice(price);
        orderItem.setProductQuantity(1);
        orderItem.setRealAmount(price);
        
        orderItemMapper.insert(orderItem);
        
        return order;
    }
    
    @Override
    public String generateOrderSn() {
        return "OD" + System.currentTimeMillis() + 
               String.format("%04d", new Random().nextInt(10000));
    }
    
    @Override
    public void cancelExpiredOrders() {
        // 取消30分钟内未支付的订单
        LocalDateTime expiredTime = LocalDateTime.now().minusMinutes(30);
        List<OmsOrder> expiredOrders = orderMapper.selectExpiredUnpaidOrders(
            Timestamp.valueOf(expiredTime));
            
        for (OmsOrder order : expiredOrders) {
            order.setStatus(4); // 已取消
            orderMapper.updateByPrimaryKey(order);
            
            log.info("Order {} has been automatically canceled due to timeout", 
                order.getOrderSn());
        }
    }
    
    @Scheduled(cron = "0 */10 * * * ?") // 每10分钟执行一次
    public void scheduleCancelExpiredOrders() {
        cancelExpiredOrders();
    }
}
```

#### 1.2 支付控制器扩展
```java
// PaymentController.java
@RestController
@RequestMapping("/api/payment")
public class PaymentController {
    
    @Autowired
    private PaymentOrderService paymentOrderService;
    
    @Autowired
    private AlipayService alipayService;
    
    @PostMapping("/create-credits-order")
    @ApiOperation("创建积分购买订单")
    public CommonResult<?> createCreditsOrder(@RequestBody CreateCreditsOrderRequest request) {
        Long memberId = getCurrentMemberId();
        
        OmsOrder order = paymentOrderService.createCreditsOrder(memberId, request.getProductId());
        
        // 生成支付参数
        String payHtml = alipayService.pay(order.getOrderSn(), order.getPayAmount(), 
            "积分购买", request.getReturnUrl());
        
        return CommonResult.success(Map.of(
            "orderId", order.getId(),
            "orderSn", order.getOrderSn(),
            "payAmount", order.getPayAmount(),
            "payHtml", payHtml
        ));
    }
    
    @PostMapping("/create-subscription-order")
    @ApiOperation("创建套餐订购订单")
    public CommonResult<?> createSubscriptionOrder(@RequestBody CreateSubscriptionOrderRequest request) {
        Long memberId = getCurrentMemberId();
        
        OmsOrder order = paymentOrderService.createSubscriptionOrder(
            memberId, 
            request.getPlanId(), 
            BillingCycle.valueOf(request.getBillingCycle().toUpperCase())
        );
        
        // 生成支付参数
        String payHtml = alipayService.pay(order.getOrderSn(), order.getPayAmount(), 
            "套餐订购", request.getReturnUrl());
        
        return CommonResult.success(Map.of(
            "orderId", order.getId(),
            "orderSn", order.getOrderSn(),
            "payAmount", order.getPayAmount(),
            "payHtml", payHtml
        ));
    }
    
    @GetMapping("/orders")
    @ApiOperation("获取支付记录")
    public CommonResult<CommonPage<PaymentOrderVO>> getPaymentOrders(
            @RequestParam(defaultValue = "1") Integer pageNum,
            @RequestParam(defaultValue = "20") Integer pageSize) {
        
        Long memberId = getCurrentMemberId();
        PageHelper.startPage(pageNum, pageSize);
        
        List<OmsOrder> orders = paymentOrderService.getMemberOrders(memberId);
        List<PaymentOrderVO> voList = orders.stream()
            .map(this::convertToVO)
            .collect(Collectors.toList());
            
        return CommonResult.success(CommonPage.restPage(voList));
    }
    
    @PostMapping("/refund/{orderSn}")
    @ApiOperation("申请退款")
    public CommonResult<?> requestRefund(@PathVariable String orderSn, 
            @RequestBody RefundRequest request) {
        Long memberId = getCurrentMemberId();
        
        RefundResult result = paymentOrderService.processRefund(memberId, orderSn, request.getReason());
        
        return CommonResult.success(result);
    }
}
```

### 第3-4天: 支付宝集成扩展

#### 3.1 扩展支付宝服务
```java
// AlipayServiceImpl.java (扩展现有服务)
@Service
public class AlipayServiceImpl implements AlipayService {
    
    // 现有支付宝配置和基础功能保持不变...
    
    @Override
    public String pay(String orderSn, BigDecimal amount, String subject, String returnUrl) {
        try {
            AlipayTradePagePayRequest request = new AlipayTradePagePayRequest();
            
            // 设置回调地址
            request.setNotifyUrl(alipayConfig.getNotifyUrl());
            request.setReturnUrl(returnUrl != null ? returnUrl : alipayConfig.getReturnUrl());
            
            // 设置请求参数
            AlipayTradePagePayModel model = new AlipayTradePagePayModel();
            model.setOutTradeNo(orderSn);
            model.setTotalAmount(amount.toString());
            model.setSubject(subject);
            model.setProductCode("FAST_INSTANT_TRADE_PAY");
            model.setTimeoutExpress("30m"); // 30分钟过期
            
            request.setBizModel(model);
            
            // 生成支付表单
            return alipayClient.pageExecute(request).getBody();
            
        } catch (AlipayApiException e) {
            log.error("支付宝支付调用失败", e);
            throw new BusinessException("支付失败");
        }
    }
    
    @Override
    public void processNotify(Map<String, String> params) {
        try {
            // 验证签名
            boolean signVerified = AlipaySignature.rsaCheckV1(
                params, 
                alipayConfig.getAlipayPublicKey(), 
                AlipayConstants.CHARSET_UTF8, 
                AlipayConstants.SIGN_TYPE_RSA2
            );
            
            if (!signVerified) {
                log.error("支付宝回调签名验证失败");
                return;
            }
            
            String orderSn = params.get("out_trade_no");
            String tradeStatus = params.get("trade_status");
            String tradeNo = params.get("trade_no");
            String totalAmount = params.get("total_amount");
            
            // 处理支付成功回调
            if ("TRADE_SUCCESS".equals(tradeStatus) || "TRADE_FINISHED".equals(tradeStatus)) {
                processPaymentSuccess(orderSn, tradeNo, new BigDecimal(totalAmount), params);
            }
            
        } catch (Exception e) {
            log.error("处理支付宝回调失败", e);
        }
    }
    
    private void processPaymentSuccess(String orderSn, String tradeNo, 
            BigDecimal amount, Map<String, String> callbackData) {
        
        OmsOrder order = orderMapper.selectByOrderSn(orderSn);
        if (order == null) {
            log.error("订单不存在: {}", orderSn);
            return;
        }
        
        // 防止重复处理
        if (order.getStatus() == 1) {
            log.info("订单已支付，跳过处理: {}", orderSn);
            return;
        }
        
        // 验证金额
        if (order.getPayAmount().compareTo(amount) != 0) {
            log.error("订单金额不匹配，订单: {}, 支付: {}", order.getPayAmount(), amount);
            return;
        }
        
        // 更新订单状态
        order.setStatus(1); // 已付款
        order.setPaymentTime(new Date());
        orderMapper.updateByPrimaryKey(order);
        
        // 记录支付信息
        recordPayment(order, tradeNo, amount, callbackData);
        
        // 自动发货
        if (order.getAutoDelivery() == 1) {
            autoDelivery(order);
        }
        
        // 发送支付成功通知
        sendPaymentNotification(order);
    }
    
    private void recordPayment(OmsOrder order, String tradeNo, 
            BigDecimal amount, Map<String, String> callbackData) {
        
        OmsPaymentRecords paymentRecord = new OmsPaymentRecords();
        paymentRecord.setMemberId(order.getMemberId());
        paymentRecord.setOrderId(order.getId());
        paymentRecord.setOrderSn(order.getOrderSn());
        paymentRecord.setPaymentMethod("alipay");
        paymentRecord.setPaymentAmount(amount);
        paymentRecord.setTradeNo(tradeNo);
        paymentRecord.setPaymentStatus(1); // 支付成功
        paymentRecord.setPaymentTime(new Date());
        paymentRecord.setCallbackTime(new Date());
        
        paymentRecordsMapper.insert(paymentRecord);
    }
}
```

### 第5-6天: 自动发货系统开发

#### 5.1 自动发货服务
```java
// AutoDeliveryService.java
@Service
@Transactional
public class AutoDeliveryServiceImpl implements AutoDeliveryService {
    
    @Autowired
    private CreditsService creditsService;
    
    @Autowired
    private SubscriptionService subscriptionService;
    
    @Autowired
    private OmsDeliveryRecordsMapper deliveryRecordsMapper;
    
    @Override
    public void processAutoDelivery(OmsOrder order) {
        if (order.getAutoDelivery() != 1) {
            return;
        }
        
        try {
            switch (order.getProductType()) {
                case 2: // 积分商品
                    deliveryCredits(order);
                    break;
                case 3: // 套餐商品
                    deliverySubscription(order);
                    break;
                default:
                    log.warn("不支持的商品类型自动发货: {}", order.getProductType());
            }
        } catch (Exception e) {
            log.error("自动发货失败，订单: {}", order.getOrderSn(), e);
            recordDeliveryFailure(order, e.getMessage());
        }
    }
    
    private void deliveryCredits(OmsOrder order) {
        List<OmsOrderItem> orderItems = orderItemMapper.selectByOrderId(order.getId());
        
        int totalCredits = 0;
        for (OmsOrderItem item : orderItems) {
            if (item.getProductType() == 2 && item.getCreditsAmount() != null) {
                totalCredits += item.getCreditsAmount() * item.getProductQuantity();
            }
        }
        
        if (totalCredits > 0) {
            // 发放积分
            creditsService.addCredits(
                order.getMemberId(), 
                totalCredits, 
                ChangeType.PURCHASE, 
                String.format("购买积分包 - 订单号: %s", order.getOrderSn()),
                order.getId()
            );
            
            // 记录发货成功
            recordDeliverySuccess(order, "credits", Map.of("credits", totalCredits));
            
            // 更新订单发货状态
            updateOrderDeliveryStatus(order, 1);
            
            log.info("积分发货成功，用户: {}, 积分: {}, 订单: {}", 
                order.getMemberId(), totalCredits, order.getOrderSn());
        }
    }
    
    private void deliverySubscription(OmsOrder order) {
        List<OmsOrderItem> orderItems = orderItemMapper.selectByOrderId(order.getId());
        
        for (OmsOrderItem item : orderItems) {
            if (item.getProductType() == 3) {
                BillingCycle billingCycle = item.getSubscriptionMonths() == 1 ? 
                    BillingCycle.MONTHLY : BillingCycle.YEARLY;
                
                // 激活套餐
                UmsMemberSubscriptions subscription = subscriptionService.subscribeToPlan(
                    order.getMemberId(), 
                    item.getProductId(), 
                    billingCycle
                );
                subscription.setOrderId(order.getId());
                subscriptionsMapper.updateByPrimaryKey(subscription);
                
                // 记录发货成功
                recordDeliverySuccess(order, "subscription", Map.of(
                    "planId", item.getProductId(),
                    "subscriptionId", subscription.getId(),
                    "billingCycle", billingCycle.name()
                ));
                
                log.info("套餐激活成功，用户: {}, 套餐: {}, 订单: {}", 
                    order.getMemberId(), item.getProductName(), order.getOrderSn());
            }
        }
        
        // 更新订单发货状态
        updateOrderDeliveryStatus(order, 1);
    }
    
    private void recordDeliverySuccess(OmsOrder order, String deliveryType, Map<String, Object> data) {
        OmsDeliveryRecords record = new OmsDeliveryRecords();
        record.setOrderId(order.getId());
        record.setMemberId(order.getMemberId());
        record.setProductType(order.getProductType());
        record.setDeliveryType(deliveryType);
        record.setDeliveryData(JsonUtils.objectToJson(data));
        record.setDeliveryStatus(1); // 发货成功
        record.setRetryCount(0);
        
        deliveryRecordsMapper.insert(record);
    }
    
    private void recordDeliveryFailure(OmsOrder order, String errorMessage) {
        OmsDeliveryRecords record = new OmsDeliveryRecords();
        record.setOrderId(order.getId());
        record.setMemberId(order.getMemberId());
        record.setProductType(order.getProductType());
        record.setDeliveryStatus(2); // 发货失败
        record.setErrorMessage(errorMessage);
        
        deliveryRecordsMapper.insert(record);
        
        // 更新订单发货状态为失败
        updateOrderDeliveryStatus(order, 2);
    }
    
    private void updateOrderDeliveryStatus(OmsOrder order, int deliveryStatus) {
        order.setDeliveryStatus(deliveryStatus);
        order.setDeliveryTime(new Date());
        orderMapper.updateByPrimaryKey(order);
    }
    
    @Override
    @Scheduled(cron = "0 */5 * * * ?") // 每5分钟重试一次
    public void retryFailedDeliveries() {
        List<OmsDeliveryRecords> failedRecords = deliveryRecordsMapper
            .selectFailedRecordsForRetry(3); // 最多重试3次
            
        for (OmsDeliveryRecords record : failedRecords) {
            try {
                OmsOrder order = orderMapper.selectByPrimaryKey(record.getOrderId());
                if (order != null && order.getStatus() == 1) { // 已支付状态
                    processAutoDelivery(order);
                    
                    // 更新重试次数
                    record.setRetryCount(record.getRetryCount() + 1);
                    deliveryRecordsMapper.updateByPrimaryKey(record);
                }
            } catch (Exception e) {
                log.error("重试自动发货失败，记录ID: {}", record.getId(), e);
                
                record.setRetryCount(record.getRetryCount() + 1);
                record.setErrorMessage(e.getMessage());
                deliveryRecordsMapper.updateByPrimaryKey(record);
            }
        }
    }
}
```

### 第7-8天: 前端支付流程开发

#### 7.1 支付API接口
```typescript
// api/payment.ts
import { request } from '@/utils/request';

export const paymentAPI = {
  // 创建积分购买订单
  createCreditsOrder: (data: CreateCreditsOrderParams) => 
    request.post<CreateOrderResult>('/payment/create-credits-order', data),

  // 创建套餐订购订单
  createSubscriptionOrder: (data: CreateSubscriptionOrderParams) => 
    request.post<CreateOrderResult>('/payment/create-subscription-order', data),

  // 获取支付记录
  getPaymentOrders: (params: { pageNum: number; pageSize: number }) => 
    request.get<PageResult<PaymentOrder>>('/payment/orders', { params }),

  // 查询订单状态
  queryOrderStatus: (orderSn: string) => 
    request.get<OrderStatus>(`/payment/order-status/${orderSn}`),

  // 申请退款
  requestRefund: (orderSn: string, data: RefundParams) => 
    request.post(`/payment/refund/${orderSn}`, data),
};

// 类型定义
export interface CreateCreditsOrderParams {
  productId: number;
  returnUrl?: string;
}

export interface CreateSubscriptionOrderParams {
  planId: number;
  billingCycle: 'monthly' | 'yearly';
  returnUrl?: string;
}

export interface CreateOrderResult {
  orderId: number;
  orderSn: string;
  payAmount: number;
  payHtml: string;
}

export interface PaymentOrder {
  id: number;
  orderSn: string;
  productName: string;
  productType: number;
  totalAmount: number;
  status: number;
  paymentTime: string;
  createTime: string;
}

export interface OrderStatus {
  orderSn: string;
  status: number;
  statusText: string;
  paymentTime?: string;
  deliveryStatus: number;
}

export interface RefundParams {
  reason: string;
}
```

#### 7.2 支付弹窗组件
```typescript
// components/PaymentModal.tsx
import React, { useEffect, useState } from 'react';
import { Modal, Button, Steps, Result, Spin, message } from 'antd';
import { 
  AlipayOutlined, 
  CheckCircleOutlined, 
  LoadingOutlined,
  CloseCircleOutlined 
} from '@ant-design/icons';
import { paymentAPI } from '@/api/payment';

const { Step } = Steps;

interface PaymentModalProps {
  visible: boolean;
  order: {
    orderId: number;
    orderSn: string;
    payAmount: number;
    payHtml: string;
  } | null;
  onSuccess: () => void;
  onCancel: () => void;
}

const PaymentModal: React.FC<PaymentModalProps> = ({
  visible,
  order,
  onSuccess,
  onCancel,
}) => {
  const [currentStep, setCurrentStep] = useState(0);
  const [paymentStatus, setPaymentStatus] = useState<'pending' | 'success' | 'failed'>('pending');
  const [polling, setPolling] = useState(false);
  const [paymentWindow, setPaymentWindow] = useState<Window | null>(null);

  useEffect(() => {
    if (visible && order) {
      setCurrentStep(0);
      setPaymentStatus('pending');
      setPolling(false);
    }
  }, [visible, order]);

  useEffect(() => {
    // 清理支付窗口
    return () => {
      if (paymentWindow && !paymentWindow.closed) {
        paymentWindow.close();
      }
    };
  }, [paymentWindow]);

  const handlePayment = () => {
    if (!order) return;

    try {
      // 创建支付表单并提交
      const form = document.createElement('form');
      form.innerHTML = order.payHtml;
      form.style.display = 'none';
      document.body.appendChild(form);

      // 在新窗口中提交表单
      const newWindow = window.open('', '_blank', 'width=800,height=600');
      if (newWindow) {
        setPaymentWindow(newWindow);
        newWindow.document.body.appendChild(form);
        form.submit();
        
        setCurrentStep(1);
        startPolling();
        
        // 监听窗口关闭
        const checkClosed = setInterval(() => {
          if (newWindow.closed) {
            clearInterval(checkClosed);
            if (paymentStatus === 'pending') {
              message.info('支付窗口已关闭，请检查支付结果');
            }
          }
        }, 1000);
      } else {
        message.error('无法打开支付窗口，请检查浏览器设置');
      }
      
      document.body.removeChild(form);
    } catch (error) {
      message.error('启动支付失败');
    }
  };

  const startPolling = () => {
    if (!order || polling) return;

    setPolling(true);
    const pollInterval = setInterval(async () => {
      try {
        const result = await paymentAPI.queryOrderStatus(order.orderSn);
        
        if (result.data.status === 1) { // 支付成功
          clearInterval(pollInterval);
          setPolling(false);
          setCurrentStep(2);
          setPaymentStatus('success');
          
          if (paymentWindow && !paymentWindow.closed) {
            paymentWindow.close();
          }
          
          setTimeout(() => {
            onSuccess();
          }, 2000);
        } else if (result.data.status === 4) { // 支付失败或取消
          clearInterval(pollInterval);
          setPolling(false);
          setPaymentStatus('failed');
        }
      } catch (error) {
        // 继续轮询
      }
    }, 3000); // 每3秒查询一次

    // 5分钟后停止轮询
    setTimeout(() => {
      if (polling) {
        clearInterval(pollInterval);
        setPolling(false);
        if (paymentStatus === 'pending') {
          message.warning('支付状态查询超时，请手动刷新页面确认');
        }
      }
    }, 300000);
  };

  const renderStepContent = () => {
    switch (currentStep) {
      case 0:
        return (
          <div className="text-center py-8">
            <div className="text-6xl mb-4">
              <AlipayOutlined className="text-blue-500" />
            </div>
            <div className="text-xl font-semibold mb-2">
              支付金额：¥{order?.payAmount.toFixed(2)}
            </div>
            <div className="text-gray-500 mb-6">
              订单号：{order?.orderSn}
            </div>
            <Button 
              type="primary" 
              size="large"
              onClick={handlePayment}
              className="min-w-[120px]"
            >
              立即支付
            </Button>
          </div>
        );
      
      case 1:
        return (
          <div className="text-center py-8">
            <div className="text-6xl mb-4">
              <LoadingOutlined className="text-blue-500" />
            </div>
            <div className="text-xl font-semibold mb-2">
              等待支付确认
            </div>
            <div className="text-gray-500 mb-4">
              请在新打开的窗口中完成支付
            </div>
            <Spin size="large" />
            <div className="mt-4 text-sm text-gray-400">
              支付完成后将自动跳转，请勿关闭此窗口
            </div>
          </div>
        );
      
      case 2:
        return (
          <Result
            status={paymentStatus === 'success' ? 'success' : 'error'}
            title={paymentStatus === 'success' ? '支付成功' : '支付失败'}
            subTitle={
              paymentStatus === 'success' 
                ? '积分/套餐已自动到账，感谢您的购买！' 
                : '支付过程中出现问题，请重试或联系客服'
            }
            extra={
              paymentStatus === 'success' ? (
                <Button type="primary" onClick={onSuccess}>
                  确定
                </Button>
              ) : (
                <div className="space-x-2">
                  <Button onClick={onCancel}>取消</Button>
                  <Button type="primary" onClick={() => setCurrentStep(0)}>
                    重试支付
                  </Button>
                </div>
              )
            }
          />
        );
      
      default:
        return null;
    }
  };

  return (
    <Modal
      title="支付确认"
      open={visible}
      onCancel={onCancel}
      footer={null}
      width={500}
      maskClosable={false}
    >
      <div className="mb-6">
        <Steps current={currentStep} size="small">
          <Step title="确认支付" icon={<AlipayOutlined />} />
          <Step title="支付中" icon={polling ? <LoadingOutlined /> : undefined} />
          <Step title="完成" icon={
            paymentStatus === 'success' ? <CheckCircleOutlined /> :
            paymentStatus === 'failed' ? <CloseCircleOutlined /> : undefined
          } />
        </Steps>
      </div>
      
      {renderStepContent()}
    </Modal>
  );
};

export default PaymentModal;
```

### 第9-10天: 退款处理系统

#### 9.1 退款服务实现
```java
// RefundService.java
@Service
@Transactional
public class RefundServiceImpl implements RefundService {
    
    @Autowired
    private OmsOrderMapper orderMapper;
    
    @Autowired
    private OmsPaymentRecordsMapper paymentRecordsMapper;
    
    @Autowired
    private AlipayClient alipayClient;
    
    @Autowired
    private CreditsService creditsService;
    
    @Autowired
    private SubscriptionService subscriptionService;
    
    @Override
    public RefundResult processRefund(Long memberId, String orderSn, String reason) {
        OmsOrder order = orderMapper.selectByOrderSn(orderSn);
        
        // 验证订单
        if (order == null || !order.getMemberId().equals(memberId)) {
            throw new BusinessException("订单不存在");
        }
        
        if (order.getStatus() != 1) {
            throw new BusinessException("订单状态不支持退款");
        }
        
        // 检查退款时限（7天内）
        if (isRefundExpired(order)) {
            throw new BusinessException("超过退款时限");
        }
        
        // 计算退款金额
        BigDecimal refundAmount = calculateRefundAmount(order);
        
        if (refundAmount.compareTo(BigDecimal.ZERO) <= 0) {
            throw new BusinessException("无可退款金额");
        }
        
        // 执行第三方退款
        boolean refundSuccess = processThirdPartyRefund(order, refundAmount, reason);
        
        if (refundSuccess) {
            // 回退业务逻辑
            rollbackBusinessLogic(order);
            
            // 更新订单状态
            order.setStatus(3); // 已退款
            orderMapper.updateByPrimaryKey(order);
            
            // 记录退款信息
            recordRefund(order, refundAmount, reason);
            
            return new RefundResult(true, refundAmount, "退款成功");
        } else {
            return new RefundResult(false, BigDecimal.ZERO, "退款失败");
        }
    }
    
    private boolean isRefundExpired(OmsOrder order) {
        LocalDateTime paymentTime = order.getPaymentTime().toInstant()
            .atZone(ZoneId.systemDefault()).toLocalDateTime();
        LocalDateTime expiredTime = paymentTime.plusDays(7);
        return LocalDateTime.now().isAfter(expiredTime);
    }
    
    private BigDecimal calculateRefundAmount(OmsOrder order) {
        switch (order.getProductType()) {
            case 2: // 积分商品
                return calculateCreditsRefund(order);
            case 3: // 套餐商品
                return calculateSubscriptionRefund(order);
            default:
                return order.getPayAmount();
        }
    }
    
    private BigDecimal calculateCreditsRefund(OmsOrder order) {
        // 检查积分使用情况，按使用比例退款
        List<OmsOrderItem> items = orderItemMapper.selectByOrderId(order.getId());
        int totalCredits = items.stream()
            .filter(item -> item.getProductType() == 2)
            .mapToInt(item -> item.getCreditsAmount() * item.getProductQuantity())
            .sum();
        
        // 查询积分使用情况
        int usedCredits = creditsService.getCreditsUsedAfterOrder(
            order.getMemberId(), order.getId());
        
        if (usedCredits >= totalCredits) {
            return BigDecimal.ZERO; // 积分已使用完，无法退款
        }
        
        // 按剩余积分比例退款
        double refundRatio = (double)(totalCredits - usedCredits) / totalCredits;
        return order.getPayAmount().multiply(BigDecimal.valueOf(refundRatio));
    }
    
    private BigDecimal calculateSubscriptionRefund(OmsOrder order) {
        // 按套餐剩余时间比例退款
        UmsMemberSubscriptions subscription = subscriptionsMapper.selectByOrderId(order.getId());
        
        if (subscription == null || subscription.getStatus() != 1) {
            return BigDecimal.ZERO;
        }
        
        LocalDateTime now = LocalDateTime.now();
        LocalDateTime startTime = subscription.getStartDate().toLocalDateTime();
        LocalDateTime endTime = subscription.getEndDate().toLocalDateTime();
        
        long totalDays = ChronoUnit.DAYS.between(startTime, endTime);
        long remainingDays = ChronoUnit.DAYS.between(now, endTime);
        
        if (remainingDays <= 0) {
            return BigDecimal.ZERO;
        }
        
        double refundRatio = (double) remainingDays / totalDays;
        return order.getPayAmount().multiply(BigDecimal.valueOf(refundRatio));
    }
    
    private boolean processThirdPartyRefund(OmsOrder order, BigDecimal refundAmount, String reason) {
        try {
            OmsPaymentRecords paymentRecord = paymentRecordsMapper.selectByOrderId(order.getId());
            if (paymentRecord == null || paymentRecord.getTradeNo() == null) {
                return false;
            }
            
            // 调用支付宝退款接口
            AlipayTradeRefundRequest request = new AlipayTradeRefundRequest();
            AlipayTradeRefundModel model = new AlipayTradeRefundModel();
            model.setOutTradeNo(order.getOrderSn());
            model.setTradeNo(paymentRecord.getTradeNo());
            model.setRefundAmount(refundAmount.toString());
            model.setRefundReason(reason);
            model.setOutRequestNo("RF" + System.currentTimeMillis()); // 退款请求号
            
            request.setBizModel(model);
            
            AlipayTradeRefundResponse response = alipayClient.execute(request);
            
            if (response.isSuccess() && "10000".equals(response.getCode())) {
                // 更新支付记录
                paymentRecord.setRefundAmount(refundAmount);
                paymentRecord.setRefundTime(new Date());
                paymentRecord.setPaymentStatus(3); // 已退款
                paymentRecordsMapper.updateByPrimaryKey(paymentRecord);
                
                return true;
            } else {
                log.error("支付宝退款失败: {}", response.getMsg());
                return false;
            }
            
        } catch (AlipayApiException e) {
            log.error("支付宝退款接口调用失败", e);
            return false;
        }
    }
    
    private void rollbackBusinessLogic(OmsOrder order) {
        switch (order.getProductType()) {
            case 2: // 积分商品退款
                rollbackCredits(order);
                break;
            case 3: // 套餐商品退款
                rollbackSubscription(order);
                break;
        }
    }
    
    private void rollbackCredits(OmsOrder order) {
        // 扣除已发放的积分（如果没有被使用）
        List<OmsOrderItem> items = orderItemMapper.selectByOrderId(order.getId());
        int totalCredits = items.stream()
            .filter(item -> item.getProductType() == 2)
            .mapToInt(item -> item.getCreditsAmount() * item.getProductQuantity())
            .sum();
        
        int usedCredits = creditsService.getCreditsUsedAfterOrder(
            order.getMemberId(), order.getId());
        
        int creditsToDeduct = totalCredits - usedCredits;
        if (creditsToDeduct > 0) {
            creditsService.deductCredits(
                order.getMemberId(),
                creditsToDeduct,
                ChangeType.REFUND_DEDUCT,
                String.format("退款扣除积分 - 订单号: %s", order.getOrderSn()),
                order.getId()
            );
        }
    }
    
    private void rollbackSubscription(OmsOrder order) {
        // 取消套餐订阅
        UmsMemberSubscriptions subscription = subscriptionsMapper.selectByOrderId(order.getId());
        if (subscription != null && subscription.getStatus() == 1) {
            subscription.setStatus(3); // 已取消
            subscriptionsMapper.updateByPrimaryKey(subscription);
        }
    }
}
```

### 第11天: 支付记录查询页面

#### 11.1 支付记录页面
```typescript
// pages/PaymentHistoryPage.tsx
import React, { useEffect, useState } from 'react';
import { 
  Card, 
  Table, 
  Tag, 
  Button, 
  DatePicker, 
  Select, 
  Row, 
  Col, 
  Modal,
  message,
  Descriptions
} from 'antd';
import { 
  AlipayOutlined,
  ShoppingCartOutlined,
  CrownOutlined,
  ExclamationCircleOutlined 
} from '@ant-design/icons';
import { useAppDispatch } from '@/hooks/redux';
import { paymentAPI } from '@/api/payment';
import dayjs from 'dayjs';

const { RangePicker } = DatePicker;
const { Option } = Select;
const { confirm } = Modal;

const PaymentHistoryPage: React.FC = () => {
  const [orders, setOrders] = useState<PaymentOrder[]>([]);
  const [loading, setLoading] = useState(false);
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 20,
    total: 0,
  });
  const [filters, setFilters] = useState({
    dateRange: null as any,
    status: null as number | null,
    productType: null as number | null,
  });

  useEffect(() => {
    fetchOrders();
  }, [pagination.current, pagination.pageSize, filters]);

  const fetchOrders = async () => {
    setLoading(true);
    try {
      const response = await paymentAPI.getPaymentOrders({
        pageNum: pagination.current,
        pageSize: pagination.pageSize,
        ...filters
      });
      
      setOrders(response.data.list);
      setPagination(prev => ({
        ...prev,
        total: response.data.total,
      }));
    } catch (error) {
      message.error('获取支付记录失败');
    } finally {
      setLoading(false);
    }
  };

  const handleRefund = (record: PaymentOrder) => {
    confirm({
      title: '确认申请退款',
      icon: <ExclamationCircleOutlined />,
      content: (
        <div>
          <p>订单号：{record.orderSn}</p>
          <p>商品：{record.productName}</p>
          <p>金额：¥{record.totalAmount.toFixed(2)}</p>
          <p>退款将在3-7个工作日内到账</p>
        </div>
      ),
      async onOk() {
        try {
          await paymentAPI.requestRefund(record.orderSn, {
            reason: '用户主动申请退款'
          });
          message.success('退款申请已提交');
          fetchOrders();
        } catch (error: any) {
          message.error(error.message || '退款申请失败');
        }
      },
    });
  };

  const getStatusTag = (status: number) => {
    const statusMap = {
      0: { text: '待支付', color: 'orange' },
      1: { text: '已支付', color: 'green' },
      2: { text: '支付失败', color: 'red' },
      3: { text: '已退款', color: 'purple' },
      4: { text: '已取消', color: 'default' },
    };
    
    const config = statusMap[status as keyof typeof statusMap];
    return <Tag color={config.color}>{config.text}</Tag>;
  };

  const getProductTypeIcon = (type: number) => {
    const typeMap = {
      2: { icon: <ShoppingCartOutlined />, text: '积分商品', color: 'blue' },
      3: { icon: <CrownOutlined />, text: '套餐商品', color: 'gold' },
    };
    
    const config = typeMap[type as keyof typeof typeMap];
    return config ? (
      <Tag icon={config.icon} color={config.color}>
        {config.text}
      </Tag>
    ) : null;
  };

  const columns = [
    {
      title: '订单号',
      dataIndex: 'orderSn',
      key: 'orderSn',
      width: 200,
    },
    {
      title: '商品信息',
      dataIndex: 'productName',
      key: 'productName',
      render: (text: string, record: PaymentOrder) => (
        <div>
          <div>{text}</div>
          <div className="text-sm text-gray-500">
            {getProductTypeIcon(record.productType)}
          </div>
        </div>
      ),
    },
    {
      title: '支付金额',
      dataIndex: 'totalAmount',
      key: 'totalAmount',
      render: (amount: number) => (
        <span className="font-semibold text-red-500">
          ¥{amount.toFixed(2)}
        </span>
      ),
    },
    {
      title: '支付方式',
      key: 'paymentMethod',
      render: () => (
        <Tag icon={<AlipayOutlined />} color="blue">
          支付宝
        </Tag>
      ),
    },
    {
      title: '订单状态',
      dataIndex: 'status',
      key: 'status',
      render: getStatusTag,
    },
    {
      title: '创建时间',
      dataIndex: 'createTime',
      key: 'createTime',
      render: (time: string) => dayjs(time).format('YYYY-MM-DD HH:mm:ss'),
    },
    {
      title: '支付时间',
      dataIndex: 'paymentTime',
      key: 'paymentTime',
      render: (time: string) => time ? dayjs(time).format('YYYY-MM-DD HH:mm:ss') : '-',
    },
    {
      title: '操作',
      key: 'actions',
      render: (_, record: PaymentOrder) => (
        <div className="space-x-2">
          {record.status === 1 && (
            <Button 
              size="small" 
              onClick={() => handleRefund(record)}
            >
              申请退款
            </Button>
          )}
          {record.status === 0 && (
            <Button size="small" type="primary">
              继续支付
            </Button>
          )}
        </div>
      ),
    },
  ];

  const handleTableChange = (paginationConfig: any) => {
    setPagination({
      ...pagination,
      current: paginationConfig.current,
      pageSize: paginationConfig.pageSize,
    });
  };

  return (
    <div className="max-w-7xl mx-auto p-6">
      <Card title="支付记录" className="mb-6">
        <Row gutter={16} className="mb-4">
          <Col xs={24} sm={12} md={6}>
            <RangePicker
              placeholder={['开始日期', '结束日期']}
              value={filters.dateRange}
              onChange={(dates) => setFilters({ ...filters, dateRange: dates })}
              className="w-full"
            />
          </Col>
          <Col xs={24} sm={12} md={4}>
            <Select
              placeholder="订单状态"
              value={filters.status}
              onChange={(value) => setFilters({ ...filters, status: value })}
              className="w-full"
              allowClear
            >
              <Option value={0}>待支付</Option>
              <Option value={1}>已支付</Option>
              <Option value={2}>支付失败</Option>
              <Option value={3}>已退款</Option>
              <Option value={4}>已取消</Option>
            </Select>
          </Col>
          <Col xs={24} sm={12} md={4}>
            <Select
              placeholder="商品类型"
              value={filters.productType}
              onChange={(value) => setFilters({ ...filters, productType: value })}
              className="w-full"
              allowClear
            >
              <Option value={2}>积分商品</Option>
              <Option value={3}>套餐商品</Option>
            </Select>
          </Col>
          <Col xs={24} sm={12} md={4}>
            <Button onClick={fetchOrders}>
              查询
            </Button>
          </Col>
        </Row>

        <Table
          dataSource={orders}
          columns={columns}
          loading={loading}
          pagination={{
            ...pagination,
            showSizeChanger: true,
            showQuickJumper: true,
            showTotal: (total, range) => 
              `第 ${range[0]}-${range[1]} 条/共 ${total} 条`,
          }}
          onChange={handleTableChange}
          rowKey="id"
          scroll={{ x: 1200 }}
        />
      </Card>
    </div>
  );
};

export default PaymentHistoryPage;
```

### 第12天: 系统测试和优化

#### 12.1 支付流程测试用例
```typescript
// __tests__/payment.test.ts
describe('支付系统测试', () => {
  
  test('积分购买流程', async () => {
    // 1. 创建积分购买订单
    const orderResponse = await paymentAPI.createCreditsOrder({
      productId: 1,
      returnUrl: 'http://localhost:3000/payment/success'
    });
    
    expect(orderResponse.data.orderId).toBeDefined();
    expect(orderResponse.data.payHtml).toContain('form');
    
    // 2. 模拟支付成功回调
    // 这里需要模拟支付宝回调
    
    // 3. 验证积分到账
    const creditsResponse = await creditsAPI.getBalance();
    expect(creditsResponse.data.totalCredits).toBeGreaterThan(0);
  });
  
  test('套餐购买流程', async () => {
    // 1. 创建套餐订购订单
    const orderResponse = await paymentAPI.createSubscriptionOrder({
      planId: 2,
      billingCycle: 'monthly'
    });
    
    expect(orderResponse.data.orderId).toBeDefined();
    
    // 2. 模拟支付成功
    // ...
    
    // 3. 验证套餐激活
    const subscriptionResponse = await subscriptionAPI.getCurrent();
    expect(subscriptionResponse.data.planCode).toBe('basic');
  });
  
  test('退款流程', async () => {
    // 1. 创建并完成支付
    // ...
    
    // 2. 申请退款
    const refundResponse = await paymentAPI.requestRefund('OD123456789', {
      reason: '测试退款'
    });
    
    expect(refundResponse.data.success).toBe(true);
    
    // 3. 验证积分/套餐回退
    // ...
  });
});
```

#### 12.2 性能优化配置
```java
// PaymentConfig.java
@Configuration
public class PaymentConfig {
    
    @Bean
    @Primary
    public ThreadPoolTaskExecutor paymentThreadPool() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("payment-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
    
    @Bean
    public CacheManager paymentCacheManager() {
        RedisCacheManager.Builder builder = RedisCacheManager
            .RedisCacheManagerBuilder
            .fromConnectionFactory(redisConnectionFactory)
            .cacheDefaults(cacheConfiguration());
            
        return builder.build();
    }
    
    private RedisCacheConfiguration cacheConfiguration() {
        return RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(10))
            .serializeKeysWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new GenericJackson2JsonRedisSerializer()));
    }
}
```

## 质量保证

### 功能测试清单
- [ ] 积分购买完整流程
- [ ] 套餐订购完整流程
- [ ] 支付成功回调处理
- [ ] 自动发货机制
- [ ] 订单状态管理
- [ ] 退款流程处理
- [ ] 支付记录查询

### 安全测试
- [ ] 支付签名验证
- [ ] 重复支付防护
- [ ] 订单金额校验
- [ ] 恶意回调防护
- [ ] 退款权限验证

### 性能测试
- [ ] 支付并发处理
- [ ] 回调处理性能
- [ ] 订单查询性能
- [ ] 自动发货响应时间

## 交付物

### 前端代码
- [ ] 支付API接口
- [ ] 支付弹窗组件
- [ ] 支付记录页面
- [ ] 支付状态轮询

### 后端代码
- [ ] 订单服务扩展
- [ ] 支付宝集成扩展
- [ ] 自动发货服务
- [ ] 退款处理服务
- [ ] 支付回调处理

### 配置文件
- [ ] 支付宝配置
- [ ] 定时任务配置
- [ ] 缓存配置

## 验收标准

1. **功能完整性**: 支付流程各环节100%可用
2. **安全性**: 通过安全审计，防止支付漏洞
3. **稳定性**: 支付成功率 > 99%，回调处理 100% 可靠
4. **性能指标**: 订单创建 < 1s，回调处理 < 3s
5. **用户体验**: 支付流程顺畅，状态反馈及时

## 风险控制

### 业务风险
1. **重复支付**: 实现幂等性控制
2. **恶意退款**: 实现退款审核机制
3. **资金安全**: 严格的金额校验

### 技术风险
1. **支付接口故障**: 实现降级和重试机制
2. **回调丢失**: 实现主动查询补偿
3. **数据不一致**: 使用分布式事务确保一致性

完成此阶段后，整个系统将拥有完整的商业化支付能力，用户可以便捷地购买积分和订阅套餐，实现系统的商业价值闭环。