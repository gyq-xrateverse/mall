# 第五阶段: 套餐管理系统开发计划

## 阶段概述
**时间周期**: 2周  
**优先级**: 高  
**依赖**: 用户认证系统、积分系统完成  
**目标**: 实现完整的会员套餐管理系统，包括套餐展示、购买升级、权益管理、Usage Details等功能

## 功能需求详细分析

### 核心功能清单
1. **套餐展示系统** - 在升级弹窗中展示不同套餐选项
2. **套餐购买流程** - 用户选择和购买套餐的完整流程
3. **会员权益管理** - 不同套餐级别的功能权限控制
4. **Usage Details页面** - 详细的使用情况统计和分析
5. **套餐到期提醒** - 套餐即将到期的通知机制
6. **自动降级处理** - 套餐到期后的自动处理逻辑
7. **套餐升级/续费** - 现有套餐的升级和续费功能

### 业务规则设计
```
套餐系统业务规则：
1. 用户默认为Free套餐，享有基础功能
2. 付费套餐按月或年计费
3. 套餐升级立即生效，降级在到期后生效
4. 套餐包含的积分在购买时立即发放
5. 套餐到期前7天开始提醒
6. 到期后自动降级为Free套餐
7. 支持套餐退款（按比例退款）
```

## 数据库设计

### 数据表结构
```sql
-- 套餐方案表
CREATE TABLE ums_subscription_plans (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    plan_code VARCHAR(50) UNIQUE NOT NULL COMMENT '套餐代码',
    name VARCHAR(100) NOT NULL COMMENT '套餐名称',
    description TEXT COMMENT '套餐描述',
    price_monthly DECIMAL(10,2) COMMENT '月付价格',
    price_yearly DECIMAL(10,2) COMMENT '年付价格',
    credits_included INT DEFAULT 0 COMMENT '包含的积分数',
    max_projects INT DEFAULT -1 COMMENT '最大项目数(-1为无限制)',
    max_storage_gb INT DEFAULT -1 COMMENT '最大存储空间GB(-1为无限制)',
    max_team_members INT DEFAULT 1 COMMENT '最大团队成员数',
    features JSON COMMENT '功能特性列表',
    limitations JSON COMMENT '限制条件',
    priority_level INT DEFAULT 0 COMMENT '优先级等级(数字越大优先级越高)',
    is_popular TINYINT DEFAULT 0 COMMENT '是否热门套餐',
    is_active TINYINT DEFAULT 1 COMMENT '是否启用',
    sort_order INT DEFAULT 0 COMMENT '排序顺序',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 用户套餐订阅表
CREATE TABLE ums_member_subscriptions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    member_id BIGINT NOT NULL COMMENT '会员ID',
    plan_id BIGINT NOT NULL COMMENT '套餐ID',
    plan_code VARCHAR(50) NOT NULL COMMENT '套餐代码(冗余存储)',
    billing_cycle ENUM('monthly', 'yearly') NOT NULL COMMENT '计费周期',
    start_date DATETIME NOT NULL COMMENT '开始时间',
    end_date DATETIME NOT NULL COMMENT '结束时间',
    status TINYINT DEFAULT 1 COMMENT '状态: 1-生效, 2-过期, 3-取消, 4-暂停',
    auto_renew TINYINT DEFAULT 0 COMMENT '是否自动续费',
    order_id BIGINT COMMENT '购买订单ID',
    credits_granted INT DEFAULT 0 COMMENT '已发放积分数',
    used_projects INT DEFAULT 0 COMMENT '已使用项目数',
    used_storage_mb INT DEFAULT 0 COMMENT '已使用存储空间MB',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_member_id (member_id),
    INDEX idx_end_date (end_date),
    INDEX idx_status (status)
);

-- 套餐使用统计表
CREATE TABLE ums_subscription_usage (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    member_id BIGINT NOT NULL COMMENT '会员ID',
    subscription_id BIGINT NOT NULL COMMENT '订阅ID',
    usage_date DATE NOT NULL COMMENT '使用日期',
    ai_tasks_count INT DEFAULT 0 COMMENT 'AI任务次数',
    credits_consumed INT DEFAULT 0 COMMENT '消费积分数',
    projects_created INT DEFAULT 0 COMMENT '创建项目数',
    storage_used_mb INT DEFAULT 0 COMMENT '使用存储空间MB',
    api_calls_count INT DEFAULT 0 COMMENT 'API调用次数',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_member_date (member_id, usage_date),
    INDEX idx_subscription_id (subscription_id)
);

-- 套餐权益配置表
CREATE TABLE ums_subscription_features (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    plan_id BIGINT NOT NULL COMMENT '套餐ID',
    feature_code VARCHAR(100) NOT NULL COMMENT '功能代码',
    feature_name VARCHAR(200) NOT NULL COMMENT '功能名称',
    feature_value VARCHAR(500) COMMENT '功能值',
    is_enabled TINYINT DEFAULT 1 COMMENT '是否启用',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_plan_id (plan_id),
    UNIQUE KEY uk_plan_feature (plan_id, feature_code)
);

-- 初始化套餐数据
INSERT INTO ums_subscription_plans (plan_code, name, description, price_monthly, price_yearly, credits_included, features, priority_level, is_popular) VALUES
('free', 'Free', '免费套餐，适合个人轻度使用', 0.00, 0.00, 0, '["基础AI功能", "每日200免费积分", "最多3个项目", "1GB存储空间"]', 0, 0),
('basic', 'Basic', '基础套餐，适合个人用户', 29.90, 299.00, 3000, '["所有AI功能", "3000积分/月", "无限项目", "10GB存储空间", "优先处理"]', 1, 0),
('pro', 'Pro', '专业套餐，适合专业用户', 59.90, 599.00, 8000, '["所有AI功能", "8000积分/月", "无限项目", "50GB存储空间", "优先处理", "高级模型访问", "批量处理"]', 2, 1),
('team', 'Team', '团队套餐，适合小团队', 99.90, 999.00, 15000, '["所有AI功能", "15000积分/月", "无限项目", "200GB存储空间", "优先处理", "高级模型访问", "批量处理", "团队协作", "5个成员"]', 3, 1),
('enterprise', 'Enterprise', '企业套餐，适合大型企业', 299.90, 2999.00, 50000, '["所有AI功能", "50000积分/月", "无限项目", "1TB存储空间", "最高优先级", "所有模型访问", "批量处理", "团队协作", "无限成员", "专属客服", "API访问", "数据导出"]', 4, 0);

-- 初始化套餐功能配置
INSERT INTO ums_subscription_features (plan_id, feature_code, feature_name, feature_value, is_enabled) VALUES
(1, 'max_projects', '最大项目数', '3', 1),
(1, 'max_storage_gb', '最大存储空间', '1', 1),
(1, 'ai_model_access', 'AI模型访问', 'basic', 1),
(1, 'priority_level', '优先级等级', '0', 1),

(2, 'max_projects', '最大项目数', '-1', 1),
(2, 'max_storage_gb', '最大存储空间', '10', 1),
(2, 'ai_model_access', 'AI模型访问', 'standard', 1),
(2, 'priority_level', '优先级等级', '1', 1),

(3, 'max_projects', '最大项目数', '-1', 1),
(3, 'max_storage_gb', '最大存储空间', '50', 1),
(3, 'ai_model_access', 'AI模型访问', 'advanced', 1),
(3, 'priority_level', '优先级等级', '2', 1),
(3, 'batch_processing', '批量处理', 'true', 1),

(4, 'max_projects', '最大项目数', '-1', 1),
(4, 'max_storage_gb', '最大存储空间', '200', 1),
(4, 'ai_model_access', 'AI模型访问', 'advanced', 1),
(4, 'priority_level', '优先级等级', '3', 1),
(4, 'batch_processing', '批量处理', 'true', 1),
(4, 'team_collaboration', '团队协作', 'true', 1),
(4, 'max_team_members', '最大团队成员', '5', 1),

(5, 'max_projects', '最大项目数', '-1', 1),
(5, 'max_storage_gb', '最大存储空间', '1024', 1),
(5, 'ai_model_access', 'AI模型访问', 'premium', 1),
(5, 'priority_level', '优先级等级', '4', 1),
(5, 'batch_processing', '批量处理', 'true', 1),
(5, 'team_collaboration', '团队协作', 'true', 1),
(5, 'max_team_members', '最大团队成员', '-1', 1),
(5, 'api_access', 'API访问', 'true', 1),
(5, 'dedicated_support', '专属客服', 'true', 1),
(5, 'data_export', '数据导出', 'true', 1);
```

## 详细开发任务

### 第1-2天: 后端套餐服务开发

#### 1.1 套餐服务核心类
```java
// SubscriptionService.java
@Service
@Transactional
public class SubscriptionServiceImpl implements SubscriptionService {
    
    @Autowired
    private UmsSubscriptionPlansMapper plansMapper;
    
    @Autowired
    private UmsMemberSubscriptionsMapper subscriptionsMapper;
    
    @Autowired
    private UmsSubscriptionUsageMapper usageMapper;
    
    @Autowired
    private CreditsService creditsService;
    
    @Override
    public List<UmsSubscriptionPlans> getAllPlans() {
        return plansMapper.selectActiveOrderBySort();
    }
    
    @Override
    public UmsMemberSubscriptions getCurrentSubscription(Long memberId) {
        return subscriptionsMapper.selectCurrentByMemberId(memberId);
    }
    
    @Override
    public UmsMemberSubscriptions subscribeToPlan(Long memberId, Long planId, 
            BillingCycle billingCycle) {
        
        UmsSubscriptionPlans plan = plansMapper.selectByPrimaryKey(planId);
        if (plan == null || plan.getIsActive() == 0) {
            throw new BusinessException("套餐不存在或已停用");
        }
        
        // 检查当前是否有有效订阅
        UmsMemberSubscriptions currentSub = getCurrentSubscription(memberId);
        if (currentSub != null && currentSub.getStatus() == 1) {
            // 处理套餐升级逻辑
            return upgradePlan(memberId, currentSub, planId, billingCycle);
        }
        
        // 创建新订阅
        UmsMemberSubscriptions subscription = new UmsMemberSubscriptions();
        subscription.setMemberId(memberId);
        subscription.setPlanId(planId);
        subscription.setPlanCode(plan.getPlanCode());
        subscription.setBillingCycle(billingCycle);
        
        LocalDateTime startTime = LocalDateTime.now();
        LocalDateTime endTime = billingCycle == BillingCycle.MONTHLY ? 
            startTime.plusMonths(1) : startTime.plusYears(1);
            
        subscription.setStartDate(Timestamp.valueOf(startTime));
        subscription.setEndDate(Timestamp.valueOf(endTime));
        subscription.setStatus(1);
        subscription.setCreditsGranted(plan.getCreditsIncluded());
        
        subscriptionsMapper.insert(subscription);
        
        // 发放套餐积分
        if (plan.getCreditsIncluded() > 0) {
            creditsService.addCredits(memberId, plan.getCreditsIncluded(), 
                ChangeType.SUBSCRIPTION_GRANT, 
                String.format("订阅%s套餐获得积分", plan.getName()), 
                null);
        }
        
        // 发送订阅成功通知
        sendSubscriptionNotification(memberId, subscription, NotificationType.SUBSCRIBED);
        
        return subscription;
    }
    
    @Override
    public SubscriptionUsageDTO getUsageDetails(Long memberId) {
        UmsMemberSubscriptions subscription = getCurrentSubscription(memberId);
        if (subscription == null) {
            return getDefaultUsageDetails(memberId);
        }
        
        // 获取当前计费周期的使用统计
        LocalDate startDate = subscription.getStartDate().toLocalDateTime().toLocalDate();
        LocalDate endDate = subscription.getEndDate().toLocalDateTime().toLocalDate();
        
        List<UmsSubscriptionUsage> usageList = usageMapper.selectByMemberIdAndDateRange(
            memberId, startDate, endDate);
            
        // 聚合统计数据
        SubscriptionUsageDTO usageDTO = new SubscriptionUsageDTO();
        usageDTO.setSubscription(subscription);
        usageDTO.setTotalAiTasks(usageList.stream().mapToInt(UmsSubscriptionUsage::getAiTasksCount).sum());
        usageDTO.setTotalCreditsConsumed(usageList.stream().mapToInt(UmsSubscriptionUsage::getCreditsConsumed).sum());
        usageDTO.setTotalProjectsCreated(usageList.stream().mapToInt(UmsSubscriptionUsage::getProjectsCreated).sum());
        usageDTO.setTotalStorageUsedMb(usageList.stream().mapToInt(UmsSubscriptionUsage::getStorageUsedMb).sum());
        usageDTO.setTotalApiCalls(usageList.stream().mapToInt(UmsSubscriptionUsage::getApiCallsCount).sum());
        usageDTO.setUsageHistory(usageList);
        
        // 获取套餐限制信息
        UmsSubscriptionPlans plan = plansMapper.selectByPrimaryKey(subscription.getPlanId());
        usageDTO.setPlanLimits(plan);
        
        return usageDTO;
    }
    
    @Override
    public void recordUsage(Long memberId, UsageType type, int amount) {
        UmsMemberSubscriptions subscription = getCurrentSubscription(memberId);
        if (subscription == null) {
            return; // Free用户不记录详细使用统计
        }
        
        LocalDate today = LocalDate.now();
        UmsSubscriptionUsage usage = usageMapper.selectByMemberIdAndDate(memberId, today);
        
        if (usage == null) {
            usage = new UmsSubscriptionUsage();
            usage.setMemberId(memberId);
            usage.setSubscriptionId(subscription.getId());
            usage.setUsageDate(Date.valueOf(today));
            
            switch (type) {
                case AI_TASKS:
                    usage.setAiTasksCount(amount);
                    break;
                case CREDITS_CONSUMED:
                    usage.setCreditsConsumed(amount);
                    break;
                case PROJECTS_CREATED:
                    usage.setProjectsCreated(amount);
                    break;
                case STORAGE_USED:
                    usage.setStorageUsedMb(amount);
                    break;
                case API_CALLS:
                    usage.setApiCallsCount(amount);
                    break;
            }
            
            usageMapper.insert(usage);
        } else {
            switch (type) {
                case AI_TASKS:
                    usage.setAiTasksCount(usage.getAiTasksCount() + amount);
                    break;
                case CREDITS_CONSUMED:
                    usage.setCreditsConsumed(usage.getCreditsConsumed() + amount);
                    break;
                case PROJECTS_CREATED:
                    usage.setProjectsCreated(usage.getProjectsCreated() + amount);
                    break;
                case STORAGE_USED:
                    usage.setStorageUsedMb(usage.getStorageUsedMb() + amount);
                    break;
                case API_CALLS:
                    usage.setApiCallsCount(usage.getApiCallsCount() + amount);
                    break;
            }
            
            usageMapper.updateByPrimaryKey(usage);
        }
    }
    
    @Override
    @Scheduled(cron = "0 0 9 * * ?") // 每天上午9点检查
    public void checkExpiringSubscriptions() {
        // 查找7天内到期的订阅
        LocalDateTime sevenDaysLater = LocalDateTime.now().plusDays(7);
        List<UmsMemberSubscriptions> expiring = subscriptionsMapper
            .selectExpiringBefore(Timestamp.valueOf(sevenDaysLater));
            
        for (UmsMemberSubscriptions sub : expiring) {
            sendExpiryReminder(sub);
        }
        
        // 处理已过期的订阅
        LocalDateTime now = LocalDateTime.now();
        List<UmsMemberSubscriptions> expired = subscriptionsMapper
            .selectExpiredBefore(Timestamp.valueOf(now));
            
        for (UmsMemberSubscriptions sub : expired) {
            handleExpiredSubscription(sub);
        }
    }
    
    private void handleExpiredSubscription(UmsMemberSubscriptions subscription) {
        subscription.setStatus(2); // 设置为过期状态
        subscriptionsMapper.updateByPrimaryKey(subscription);
        
        // 发送过期通知
        sendSubscriptionNotification(subscription.getMemberId(), subscription, 
            NotificationType.EXPIRED);
    }
    
    @Override
    public boolean hasFeature(Long memberId, String featureCode) {
        UmsMemberSubscriptions subscription = getCurrentSubscription(memberId);
        if (subscription == null) {
            // 免费用户的功能检查
            return checkFreeUserFeature(featureCode);
        }
        
        UmsSubscriptionFeatures feature = featuresMapper.selectByPlanIdAndCode(
            subscription.getPlanId(), featureCode);
            
        return feature != null && feature.getIsEnabled() == 1;
    }
    
    @Override
    public String getFeatureValue(Long memberId, String featureCode) {
        UmsMemberSubscriptions subscription = getCurrentSubscription(memberId);
        if (subscription == null) {
            return getFreeUserFeatureValue(featureCode);
        }
        
        UmsSubscriptionFeatures feature = featuresMapper.selectByPlanIdAndCode(
            subscription.getPlanId(), featureCode);
            
        return feature != null ? feature.getFeatureValue() : null;
    }
}
```

#### 1.2 套餐控制器
```java
// SubscriptionController.java
@RestController
@RequestMapping("/api/subscription")
public class SubscriptionController {
    
    @Autowired
    private SubscriptionService subscriptionService;
    
    @GetMapping("/plans")
    @ApiOperation("获取所有套餐")
    public CommonResult<List<SubscriptionPlanVO>> getAllPlans() {
        List<UmsSubscriptionPlans> plans = subscriptionService.getAllPlans();
        List<SubscriptionPlanVO> voList = plans.stream()
            .map(this::convertToPlanVO)
            .collect(Collectors.toList());
            
        return CommonResult.success(voList);
    }
    
    @GetMapping("/current")
    @ApiOperation("获取当前套餐")
    public CommonResult<CurrentSubscriptionVO> getCurrentSubscription() {
        Long memberId = getCurrentMemberId();
        UmsMemberSubscriptions subscription = subscriptionService.getCurrentSubscription(memberId);
        
        CurrentSubscriptionVO vo = new CurrentSubscriptionVO();
        if (subscription != null) {
            vo = convertToCurrentVO(subscription);
        } else {
            vo.setPlanCode("free");
            vo.setPlanName("Free");
            vo.setStatus("active");
            vo.setIsExpiring(false);
        }
        
        return CommonResult.success(vo);
    }
    
    @PostMapping("/subscribe")
    @ApiOperation("订阅套餐")
    public CommonResult<?> subscribeToPlan(@RequestBody SubscribeRequest request) {
        Long memberId = getCurrentMemberId();
        
        UmsMemberSubscriptions subscription = subscriptionService.subscribeToPlan(
            memberId, 
            request.getPlanId(), 
            BillingCycle.valueOf(request.getBillingCycle().toUpperCase())
        );
        
        return CommonResult.success(Map.of(
            "subscriptionId", subscription.getId(),
            "message", "订阅成功"
        ));
    }
    
    @GetMapping("/usage")
    @ApiOperation("获取使用详情")
    public CommonResult<SubscriptionUsageVO> getUsageDetails() {
        Long memberId = getCurrentMemberId();
        SubscriptionUsageDTO usageDTO = subscriptionService.getUsageDetails(memberId);
        
        SubscriptionUsageVO vo = convertToUsageVO(usageDTO);
        return CommonResult.success(vo);
    }
    
    @PostMapping("/cancel")
    @ApiOperation("取消订阅")
    public CommonResult<?> cancelSubscription(@RequestParam Long subscriptionId) {
        Long memberId = getCurrentMemberId();
        subscriptionService.cancelSubscription(memberId, subscriptionId);
        
        return CommonResult.success("订阅取消成功，将在到期后停止续费");
    }
    
    @PostMapping("/renew")
    @ApiOperation("续费订阅")
    public CommonResult<?> renewSubscription(@RequestBody RenewRequest request) {
        Long memberId = getCurrentMemberId();
        
        UmsMemberSubscriptions subscription = subscriptionService.renewSubscription(
            memberId, 
            request.getSubscriptionId(),
            BillingCycle.valueOf(request.getBillingCycle().toUpperCase())
        );
        
        return CommonResult.success(subscription);
    }
    
    @GetMapping("/features/{featureCode}")
    @ApiOperation("检查功能权限")
    public CommonResult<FeatureCheckVO> checkFeature(@PathVariable String featureCode) {
        Long memberId = getCurrentMemberId();
        
        boolean hasFeature = subscriptionService.hasFeature(memberId, featureCode);
        String featureValue = subscriptionService.getFeatureValue(memberId, featureCode);
        
        FeatureCheckVO vo = new FeatureCheckVO();
        vo.setFeatureCode(featureCode);
        vo.setHasFeature(hasFeature);
        vo.setFeatureValue(featureValue);
        
        return CommonResult.success(vo);
    }
}
```

### 第3-4天: 前端套餐状态管理

#### 3.1 套餐状态切片
```typescript
// store/subscription/subscriptionSlice.ts
import { createSlice, createAsyncThunk } from '@reduxjs/toolkit';
import { subscriptionAPI } from '@/api/subscription';

interface SubscriptionState {
  plans: SubscriptionPlan[];
  currentSubscription: CurrentSubscription | null;
  usage: SubscriptionUsage | null;
  loading: boolean;
  error: string | null;
  subscribeLoading: boolean;
}

const initialState: SubscriptionState = {
  plans: [],
  currentSubscription: null,
  usage: null,
  loading: false,
  error: null,
  subscribeLoading: false,
};

// 异步thunks
export const fetchPlans = createAsyncThunk(
  'subscription/fetchPlans',
  async () => {
    const response = await subscriptionAPI.getPlans();
    return response.data;
  }
);

export const fetchCurrentSubscription = createAsyncThunk(
  'subscription/fetchCurrent',
  async () => {
    const response = await subscriptionAPI.getCurrent();
    return response.data;
  }
);

export const fetchUsageDetails = createAsyncThunk(
  'subscription/fetchUsage',
  async () => {
    const response = await subscriptionAPI.getUsage();
    return response.data;
  }
);

export const subscribeToPlan = createAsyncThunk(
  'subscription/subscribe',
  async (params: SubscribeParams) => {
    const response = await subscriptionAPI.subscribe(params);
    return response.data;
  }
);

export const checkFeature = createAsyncThunk(
  'subscription/checkFeature',
  async (featureCode: string) => {
    const response = await subscriptionAPI.checkFeature(featureCode);
    return response.data;
  }
);

const subscriptionSlice = createSlice({
  name: 'subscription',
  initialState,
  reducers: {
    clearError: (state) => {
      state.error = null;
    },
    updateUsage: (state, action) => {
      if (state.usage) {
        state.usage = { ...state.usage, ...action.payload };
      }
    },
  },
  extraReducers: (builder) => {
    builder
      // 获取套餐列表
      .addCase(fetchPlans.pending, (state) => {
        state.loading = true;
        state.error = null;
      })
      .addCase(fetchPlans.fulfilled, (state, action) => {
        state.loading = false;
        state.plans = action.payload;
      })
      .addCase(fetchPlans.rejected, (state, action) => {
        state.loading = false;
        state.error = action.error.message || '获取套餐列表失败';
      })
      // 获取当前订阅
      .addCase(fetchCurrentSubscription.fulfilled, (state, action) => {
        state.currentSubscription = action.payload;
      })
      // 获取使用详情
      .addCase(fetchUsageDetails.fulfilled, (state, action) => {
        state.usage = action.payload;
      })
      // 订阅套餐
      .addCase(subscribeToPlan.pending, (state) => {
        state.subscribeLoading = true;
        state.error = null;
      })
      .addCase(subscribeToPlan.fulfilled, (state) => {
        state.subscribeLoading = false;
        // 订阅成功后重新获取当前订阅信息
      })
      .addCase(subscribeToPlan.rejected, (state, action) => {
        state.subscribeLoading = false;
        state.error = action.error.message || '订阅失败';
      });
  },
});

export const { clearError, updateUsage } = subscriptionSlice.actions;
export default subscriptionSlice.reducer;
```

#### 3.2 套餐API接口
```typescript
// api/subscription.ts
import { request } from '@/utils/request';

export const subscriptionAPI = {
  // 获取所有套餐
  getPlans: () => 
    request.get<SubscriptionPlan[]>('/subscription/plans'),

  // 获取当前订阅
  getCurrent: () => 
    request.get<CurrentSubscription>('/subscription/current'),

  // 订阅套餐
  subscribe: (data: SubscribeParams) => 
    request.post('/subscription/subscribe', data),

  // 获取使用详情
  getUsage: () => 
    request.get<SubscriptionUsage>('/subscription/usage'),

  // 取消订阅
  cancel: (subscriptionId: number) => 
    request.post('/subscription/cancel', { subscriptionId }),

  // 续费订阅
  renew: (data: RenewParams) => 
    request.post('/subscription/renew', data),

  // 检查功能权限
  checkFeature: (featureCode: string) => 
    request.get<FeatureCheck>(`/subscription/features/${featureCode}`),
};

// 类型定义
export interface SubscriptionPlan {
  id: number;
  planCode: string;
  name: string;
  description: string;
  priceMonthly: number;
  priceYearly: number;
  creditsIncluded: number;
  features: string[];
  isPopular: boolean;
  priorityLevel: number;
}

export interface CurrentSubscription {
  id?: number;
  planCode: string;
  planName: string;
  billingCycle?: string;
  startDate?: string;
  endDate?: string;
  status: string;
  isExpiring: boolean;
  daysUntilExpiry?: number;
  autoRenew?: boolean;
}

export interface SubscriptionUsage {
  subscription: CurrentSubscription;
  totalAiTasks: number;
  totalCreditsConsumed: number;
  totalProjectsCreated: number;
  totalStorageUsedMb: number;
  totalApiCalls: number;
  planLimits: {
    maxProjects: number;
    maxStorageGb: number;
    creditsIncluded: number;
  };
  usageHistory: DailyUsage[];
}

export interface DailyUsage {
  usageDate: string;
  aiTasksCount: number;
  creditsConsumed: number;
  projectsCreated: number;
  storageUsedMb: number;
  apiCallsCount: number;
}

export interface SubscribeParams {
  planId: number;
  billingCycle: 'monthly' | 'yearly';
}

export interface RenewParams {
  subscriptionId: number;
  billingCycle: 'monthly' | 'yearly';
}

export interface FeatureCheck {
  featureCode: string;
  hasFeature: boolean;
  featureValue?: string;
}
```

### 第5-6天: 套餐升级弹窗开发

#### 5.1 套餐升级弹窗组件
```typescript
// components/SubscriptionUpgradeModal.tsx
import React, { useEffect, useState } from 'react';
import { 
  Modal, 
  Card, 
  Row, 
  Col, 
  Button, 
  Switch, 
  Badge, 
  Typography, 
  Divider,
  List,
  message 
} from 'antd';
import { 
  CrownOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  ThunderboltOutlined,
  FireOutlined 
} from '@ant-design/icons';
import { useAppSelector, useAppDispatch } from '@/hooks/redux';
import { fetchPlans, subscribeToPlan } from '@/store/subscription/subscriptionSlice';

const { Title, Text } = Typography;

interface SubscriptionUpgradeModalProps {
  visible: boolean;
  onCancel: () => void;
  onSuccess?: () => void;
}

const SubscriptionUpgradeModal: React.FC<SubscriptionUpgradeModalProps> = ({
  visible,
  onCancel,
  onSuccess,
}) => {
  const dispatch = useAppDispatch();
  const { plans, subscribeLoading, currentSubscription } = useAppSelector(state => state.subscription);
  const [billingCycle, setBillingCycle] = useState<'monthly' | 'yearly'>('monthly');
  const [selectedPlan, setSelectedPlan] = useState<number | null>(null);

  useEffect(() => {
    if (visible) {
      dispatch(fetchPlans());
    }
  }, [visible, dispatch]);

  const handleSubscribe = async (planId: number) => {
    if (currentSubscription?.planCode !== 'free' && 
        planId <= (plans.find(p => p.planCode === currentSubscription?.planCode)?.id || 0)) {
      message.warning('无法降级到更低等级的套餐');
      return;
    }

    try {
      setSelectedPlan(planId);
      await dispatch(subscribeToPlan({ planId, billingCycle })).unwrap();
      message.success('订阅成功！');
      onSuccess?.();
      onCancel();
    } catch (error: any) {
      message.error(error.message || '订阅失败');
    } finally {
      setSelectedPlan(null);
    }
  };

  const calculateYearlyDiscount = (monthly: number, yearly: number) => {
    const yearlyEquivalent = monthly * 12;
    const discount = Math.round(((yearlyEquivalent - yearly) / yearlyEquivalent) * 100);
    return discount;
  };

  const formatPrice = (price: number) => {
    return `¥${price.toFixed(2)}`;
  };

  const getCurrentPlanId = () => {
    if (!currentSubscription || currentSubscription.planCode === 'free') return 0;
    return plans.find(p => p.planCode === currentSubscription.planCode)?.id || 0;
  };

  const isPlanCurrent = (planId: number) => {
    return planId === getCurrentPlanId();
  };

  const isPlanDowngrade = (planId: number) => {
    const currentPlanId = getCurrentPlanId();
    return currentPlanId > 0 && planId < currentPlanId;
  };

  const getPlanIcon = (plan: any) => {
    if (plan.planCode === 'free') return '🆓';
    if (plan.isPopular) return <FireOutlined className="text-red-500" />;
    return <CrownOutlined className="text-yellow-500" />;
  };

  const getPlanBadge = (plan: any) => {
    if (plan.isPopular) return <Badge.Ribbon text="最受欢迎" color="red" />;
    if (plan.planCode === 'enterprise') return <Badge.Ribbon text="企业首选" color="purple" />;
    return null;
  };

  return (
    <Modal
      title={null}
      open={visible}
      onCancel={onCancel}
      footer={null}
      width={1200}
      bodyStyle={{ padding: 0 }}
      className="subscription-modal"
    >
      <div className="p-8">
        <div className="text-center mb-8">
          <Title level={2}>选择适合的套餐</Title>
          <Text type="secondary" className="text-lg">
            升级套餐，享受更多功能和服务
          </Text>
          
          <div className="flex justify-center items-center mt-6 gap-4">
            <Text>月付</Text>
            <Switch 
              checked={billingCycle === 'yearly'}
              onChange={(checked) => setBillingCycle(checked ? 'yearly' : 'monthly')}
            />
            <Text>年付 <span className="text-green-500">(节省更多)</span></Text>
          </div>
        </div>

        <Row gutter={[24, 24]}>
          {plans.map((plan) => {
            const price = billingCycle === 'monthly' ? plan.priceMonthly : plan.priceYearly;
            const yearlyDiscount = calculateYearlyDiscount(plan.priceMonthly, plan.priceYearly);
            const isCurrent = isPlanCurrent(plan.id);
            const isDowngrade = isPlanDowngrade(plan.id);

            return (
              <Col key={plan.id} xs={24} sm={12} lg={8} xl={6}>
                {getPlanBadge(plan)}
                <Card
                  className={`h-full transition-all duration-300 hover:shadow-lg ${
                    plan.isPopular ? 'border-red-400 shadow-md' : ''
                  } ${isCurrent ? 'border-blue-400 bg-blue-50' : ''}`}
                  bodyStyle={{ padding: '24px' }}
                >
                  <div className="text-center">
                    <div className="text-4xl mb-4">
                      {getPlanIcon(plan)}
                    </div>
                    
                    <Title level={4} className="mb-2">
                      {plan.name}
                      {isCurrent && <Badge count="当前套餐" className="ml-2" />}
                    </Title>
                    
                    <Text type="secondary" className="block mb-4">
                      {plan.description}
                    </Text>
                    
                    <div className="mb-4">
                      <div className="text-3xl font-bold text-blue-500 mb-1">
                        {plan.planCode === 'free' ? '免费' : formatPrice(price)}
                      </div>
                      {billingCycle === 'yearly' && yearlyDiscount > 0 && plan.planCode !== 'free' && (
                        <div className="text-sm text-green-500">
                          年付节省{yearlyDiscount}%
                        </div>
                      )}
                      {plan.planCode !== 'free' && (
                        <div className="text-sm text-gray-500">
                          {billingCycle === 'monthly' ? '/月' : '/年'}
                        </div>
                      )}
                    </div>
                    
                    {plan.creditsIncluded > 0 && (
                      <div className="mb-4 p-2 bg-yellow-50 rounded-lg">
                        <ThunderboltOutlined className="text-yellow-500 mr-1" />
                        <span className="text-sm">包含 {plan.creditsIncluded.toLocaleString()} 积分</span>
                      </div>
                    )}
                    
                    <Divider />
                    
                    <div className="text-left mb-6">
                      <List
                        size="small"
                        dataSource={plan.features}
                        renderItem={(feature) => (
                          <List.Item className="border-0 px-0 py-1">
                            <CheckCircleOutlined className="text-green-500 mr-2" />
                            <span className="text-sm">{feature}</span>
                          </List.Item>
                        )}
                      />
                    </div>
                    
                    <Button
                      type={plan.isPopular ? 'primary' : isCurrent ? 'default' : 'default'}
                      size="large"
                      block
                      disabled={isCurrent || isDowngrade}
                      loading={selectedPlan === plan.id && subscribeLoading}
                      onClick={() => handleSubscribe(plan.id)}
                      className={
                        plan.isPopular ? 'bg-gradient-to-r from-red-500 to-pink-500 border-0' : 
                        isCurrent ? 'border-blue-400 text-blue-500' : ''
                      }
                    >
                      {isCurrent ? '当前套餐' : 
                       isDowngrade ? '无法降级' :
                       plan.planCode === 'free' ? '免费使用' : '立即订阅'}
                    </Button>
                    
                    {isDowngrade && (
                      <div className="mt-2 text-xs text-gray-500">
                        <CloseCircleOutlined className="mr-1" />
                        不支持降级到更低等级套餐
                      </div>
                    )}
                  </div>
                </Card>
              </Col>
            );
          })}
        </Row>
        
        <div className="text-center mt-8">
          <Text type="secondary" className="text-sm">
            • 支持随时取消订阅 • 30天无理由退款 • 专业客服支持
          </Text>
        </div>
      </div>
    </Modal>
  );
};

export default SubscriptionUpgradeModal;
```

### 第7-8天: Usage Details页面开发

#### 7.1 Usage Details页面
```typescript
// pages/UsageDetailsPage.tsx
import React, { useEffect, useState } from 'react';
import { 
  Card, 
  Row, 
  Col, 
  Progress, 
  Statistic, 
  Typography, 
  DatePicker, 
  Table,
  Tag,
  Button,
  Tooltip,
  Space
} from 'antd';
import { 
  ThunderboltOutlined,
  ProjectOutlined,
  CloudOutlined,
  ApiOutlined,
  CalendarOutlined,
  UpgradeOutlined 
} from '@ant-design/icons';
import { useAppSelector, useAppDispatch } from '@/hooks/redux';
import { fetchUsageDetails, fetchCurrentSubscription } from '@/store/subscription/subscriptionSlice';
import { Line } from '@ant-design/plots';
import dayjs from 'dayjs';

const { Title, Text } = Typography;
const { RangePicker } = DatePicker;

const UsageDetailsPage: React.FC = () => {
  const dispatch = useAppDispatch();
  const { usage, currentSubscription, loading } = useAppSelector(state => state.subscription);
  const [dateRange, setDateRange] = useState<[dayjs.Dayjs, dayjs.Dayjs] | null>(null);

  useEffect(() => {
    dispatch(fetchCurrentSubscription());
    dispatch(fetchUsageDetails());
  }, [dispatch]);

  const formatStorageSize = (sizeInMB: number) => {
    if (sizeInMB < 1024) {
      return `${sizeInMB.toFixed(1)} MB`;
    }
    return `${(sizeInMB / 1024).toFixed(1)} GB`;
  };

  const calculateProgress = (used: number, limit: number) => {
    if (limit === -1) return 0; // 无限制
    return Math.min((used / limit) * 100, 100);
  };

  const getProgressColor = (percent: number) => {
    if (percent < 50) return '#52c41a';
    if (percent < 80) return '#faad14';
    return '#ff4d4f';
  };

  const renderUsageCard = (title: string, used: number | string, limit: number | string, 
                          icon: React.ReactNode, unit: string = '') => {
    const isUnlimited = limit === -1 || limit === '无限';
    const usedNum = typeof used === 'string' ? 0 : used;
    const limitNum = typeof limit === 'string' ? 0 : limit;
    const percent = isUnlimited ? 0 : calculateProgress(usedNum, limitNum);
    
    return (
      <Card>
        <Statistic
          title={title}
          value={used}
          suffix={unit}
          prefix={icon}
          valueStyle={{ fontSize: '24px' }}
        />
        <div className="mt-4">
          {isUnlimited ? (
            <div className="text-green-500 text-sm">无限制使用</div>
          ) : (
            <>
              <Progress
                percent={percent}
                strokeColor={getProgressColor(percent)}
                showInfo={false}
              />
              <div className="flex justify-between text-sm text-gray-500 mt-1">
                <span>已使用 {used}{unit}</span>
                <span>总计 {limit}{unit}</span>
              </div>
            </>
          )}
        </div>
      </Card>
    );
  };

  const getUsageChartData = () => {
    if (!usage?.usageHistory) return [];
    
    return usage.usageHistory.map(item => ({
      date: item.usageDate,
      value: item.creditsConsumed,
      type: '积分消费',
    }));
  };

  const chartConfig = {
    data: getUsageChartData(),
    xField: 'date',
    yField: 'value',
    seriesField: 'type',
    smooth: true,
    point: {
      size: 3,
      shape: 'circle',
    },
    tooltip: {
      formatter: (datum: any) => {
        return {
          name: datum.type,
          value: `${datum.value} 积分`,
        };
      },
    },
  };

  const historyColumns = [
    {
      title: '日期',
      dataIndex: 'usageDate',
      key: 'usageDate',
      render: (date: string) => dayjs(date).format('YYYY-MM-DD'),
    },
    {
      title: 'AI任务',
      dataIndex: 'aiTasksCount',
      key: 'aiTasksCount',
      render: (count: number) => `${count} 次`,
    },
    {
      title: '积分消费',
      dataIndex: 'creditsConsumed',
      key: 'creditsConsumed',
      render: (credits: number) => (
        <span>
          <ThunderboltOutlined className="mr-1 text-blue-500" />
          {credits}
        </span>
      ),
    },
    {
      title: '项目创建',
      dataIndex: 'projectsCreated',
      key: 'projectsCreated',
      render: (count: number) => `${count} 个`,
    },
    {
      title: '存储使用',
      dataIndex: 'storageUsedMb',
      key: 'storageUsedMb',
      render: (size: number) => formatStorageSize(size),
    },
    {
      title: 'API调用',
      dataIndex: 'apiCallsCount',
      key: 'apiCallsCount',
      render: (count: number) => `${count} 次`,
    },
  ];

  if (!usage || !currentSubscription) {
    return <Card loading />;
  }

  return (
    <div className="max-w-7xl mx-auto p-6">
      <div className="flex justify-between items-center mb-6">
        <div>
          <Title level={2}>Usage Details</Title>
          <Text type="secondary">
            当前套餐：
            <Tag color="blue" className="ml-2">
              {currentSubscription.planName}
            </Tag>
            {currentSubscription.endDate && (
              <span className="ml-2">
                到期时间：{dayjs(currentSubscription.endDate).format('YYYY-MM-DD')}
              </span>
            )}
          </Text>
        </div>
        
        <Button type="primary" icon={<UpgradeOutlined />}>
          升级套餐
        </Button>
      </div>

      {/* 使用概况 */}
      <Row gutter={[24, 24]} className="mb-6">
        <Col xs={24} sm={12} lg={6}>
          {renderUsageCard(
            '项目数量',
            usage.totalProjectsCreated,
            usage.planLimits.maxProjects === -1 ? '无限' : usage.planLimits.maxProjects,
            <ProjectOutlined className="text-blue-500" />,
            '个'
          )}
        </Col>
        
        <Col xs={24} sm={12} lg={6}>
          {renderUsageCard(
            '存储使用',
            (usage.totalStorageUsedMb / 1024).toFixed(1),
            usage.planLimits.maxStorageGb === -1 ? '无限' : usage.planLimits.maxStorageGb,
            <CloudOutlined className="text-green-500" />,
            'GB'
          )}
        </Col>
        
        <Col xs={24} sm={12} lg={6}>
          {renderUsageCard(
            '积分消费',
            usage.totalCreditsConsumed,
            usage.planLimits.creditsIncluded,
            <ThunderboltOutlined className="text-orange-500" />,
            '积分'
          )}
        </Col>
        
        <Col xs={24} sm={12} lg={6}>
          {renderUsageCard(
            'AI任务',
            usage.totalAiTasks,
            '无限',
            <ApiOutlined className="text-purple-500" />,
            '次'
          )}
        </Col>
      </Row>

      {/* 使用趋势图 */}
      <Card title="使用趋势" className="mb-6">
        <div className="mb-4">
          <RangePicker
            value={dateRange}
            onChange={(dates) => setDateRange(dates as [dayjs.Dayjs, dayjs.Dayjs])}
            placeholder={['开始日期', '结束日期']}
          />
        </div>
        <Line {...chartConfig} height={300} />
      </Card>

      {/* 详细使用记录 */}
      <Card
        title="使用详情"
        extra={
          <Space>
            <CalendarOutlined />
            <Text type="secondary">最近30天记录</Text>
          </Space>
        }
      >
        <Table
          dataSource={usage.usageHistory}
          columns={historyColumns}
          pagination={{
            pageSize: 10,
            showSizeChanger: true,
            showQuickJumper: true,
          }}
          rowKey="usageDate"
          loading={loading}
        />
      </Card>

      {/* 套餐建议 */}
      {currentSubscription.planCode === 'free' && (
        <Card className="mt-6 border-yellow-200 bg-yellow-50">
          <div className="text-center">
            <Title level={4} className="text-yellow-700">
              <CrownOutlined className="mr-2" />
              升级套餐，解锁更多功能
            </Title>
            <Text className="text-yellow-600">
              当前使用的免费套餐功能有限，升级到付费套餐可享受更多积分、存储空间和高级功能
            </Text>
            <div className="mt-4">
              <Button type="primary" size="large">
                查看套餐选项
              </Button>
            </div>
          </div>
        </Card>
      )}
    </div>
  );
};

export default UsageDetailsPage;
```

### 第9-10天: 权限控制系统开发

#### 9.1 权限检查Hook
```typescript
// hooks/useSubscriptionFeatures.ts
import { useEffect, useState } from 'react';
import { useAppSelector, useAppDispatch } from '@/hooks/redux';
import { checkFeature, fetchCurrentSubscription } from '@/store/subscription/subscriptionSlice';

export const useSubscriptionFeatures = () => {
  const dispatch = useAppDispatch();
  const { currentSubscription } = useAppSelector(state => state.subscription);
  
  useEffect(() => {
    if (!currentSubscription) {
      dispatch(fetchCurrentSubscription());
    }
  }, [dispatch, currentSubscription]);

  const hasFeature = async (featureCode: string): Promise<boolean> => {
    try {
      const result = await dispatch(checkFeature(featureCode)).unwrap();
      return result.hasFeature;
    } catch {
      return false;
    }
  };

  const getFeatureValue = async (featureCode: string): Promise<string | null> => {
    try {
      const result = await dispatch(checkFeature(featureCode)).unwrap();
      return result.featureValue || null;
    } catch {
      return null;
    }
  };

  const isPlanActive = (): boolean => {
    return currentSubscription?.status === 'active';
  };

  const isFreePlan = (): boolean => {
    return !currentSubscription || currentSubscription.planCode === 'free';
  };

  const getPlanLevel = (): number => {
    if (!currentSubscription || currentSubscription.planCode === 'free') return 0;
    
    const planLevels = {
      'basic': 1,
      'pro': 2,
      'team': 3,
      'enterprise': 4,
    };
    
    return planLevels[currentSubscription.planCode as keyof typeof planLevels] || 0;
  };

  return {
    currentSubscription,
    hasFeature,
    getFeatureValue,
    isPlanActive,
    isFreePlan,
    getPlanLevel,
  };
};
```

#### 9.2 功能权限组件
```typescript
// components/FeatureGate.tsx
import React from 'react';
import { Button, Card, Typography } from 'antd';
import { CrownOutlined, LockOutlined } from '@ant-design/icons';
import { useSubscriptionFeatures } from '@/hooks/useSubscriptionFeatures';

const { Title, Text } = Typography;

interface FeatureGateProps {
  featureCode: string;
  requiredPlan?: string;
  children: React.ReactNode;
  fallback?: React.ReactNode;
  onUpgradeClick?: () => void;
}

const FeatureGate: React.FC<FeatureGateProps> = ({
  featureCode,
  requiredPlan,
  children,
  fallback,
  onUpgradeClick,
}) => {
  const { hasFeature, currentSubscription } = useSubscriptionFeatures();
  const [hasAccess, setHasAccess] = React.useState<boolean | null>(null);

  React.useEffect(() => {
    const checkAccess = async () => {
      const access = await hasFeature(featureCode);
      setHasAccess(access);
    };
    
    checkAccess();
  }, [featureCode, hasFeature]);

  if (hasAccess === null) {
    // 加载中状态
    return <div>检查权限中...</div>;
  }

  if (hasAccess) {
    return <>{children}</>;
  }

  // 没有权限时显示的内容
  if (fallback) {
    return <>{fallback}</>;
  }

  // 默认的升级提示
  return (
    <Card className="text-center border-orange-200 bg-orange-50">
      <div className="py-8">
        <LockOutlined className="text-4xl text-orange-500 mb-4" />
        <Title level={4} className="text-orange-700">
          此功能需要升级套餐
        </Title>
        <Text className="text-orange-600 block mb-4">
          当前 {currentSubscription?.planName || 'Free'} 套餐无法使用此功能
          {requiredPlan && `, 请升级到 ${requiredPlan} 或更高级别套餐`}
        </Text>
        <Button
          type="primary"
          size="large"
          icon={<CrownOutlined />}
          onClick={onUpgradeClick}
          className="bg-orange-500 border-orange-500 hover:bg-orange-600"
        >
          立即升级
        </Button>
      </div>
    </Card>
  );
};

export default FeatureGate;
```

#### 9.3 项目限制检查示例
```typescript
// components/ProjectCreationButton.tsx
import React, { useState } from 'react';
import { Button, message } from 'antd';
import { PlusOutlined } from '@ant-design/icons';
import { useSubscriptionFeatures } from '@/hooks/useSubscriptionFeatures';
import SubscriptionUpgradeModal from './SubscriptionUpgradeModal';

const ProjectCreationButton: React.FC = () => {
  const { getFeatureValue, isFreePlan } = useSubscriptionFeatures();
  const [showUpgradeModal, setShowUpgradeModal] = useState(false);
  const [loading, setLoading] = useState(false);

  const handleCreateProject = async () => {
    setLoading(true);
    
    try {
      // 检查项目数量限制
      const maxProjects = await getFeatureValue('max_projects');
      const currentProjects = await getCurrentProjectCount(); // 假设这个函数存在
      
      if (maxProjects !== '-1' && currentProjects >= parseInt(maxProjects)) {
        message.warning('已达到当前套餐的项目数量上限');
        setShowUpgradeModal(true);
        return;
      }

      // 创建项目逻辑
      await createProject();
      message.success('项目创建成功');
      
    } catch (error: any) {
      message.error(error.message || '创建项目失败');
    } finally {
      setLoading(false);
    }
  };

  const getCurrentProjectCount = async (): Promise<number> => {
    // 模拟获取当前项目数量
    return 3;
  };

  const createProject = async () => {
    // 模拟创建项目
    return new Promise(resolve => setTimeout(resolve, 1000));
  };

  return (
    <>
      <Button
        type="primary"
        icon={<PlusOutlined />}
        onClick={handleCreateProject}
        loading={loading}
      >
        新建项目
      </Button>
      
      <SubscriptionUpgradeModal
        visible={showUpgradeModal}
        onCancel={() => setShowUpgradeModal(false)}
        onSuccess={() => setShowUpgradeModal(false)}
      />
    </>
  );
};

export default ProjectCreationButton;
```

### 第11-12天: 套餐到期提醒和自动处理

#### 11.1 到期提醒组件
```typescript
// components/ExpiryReminderBanner.tsx
import React, { useEffect } from 'react';
import { Alert, Button } from 'antd';
import { ClockCircleOutlined, CrownOutlined } from '@ant-design/icons';
import { useAppSelector, useAppDispatch } from '@/hooks/redux';
import { fetchCurrentSubscription } from '@/store/subscription/subscriptionSlice';
import dayjs from 'dayjs';

const ExpiryReminderBanner: React.FC = () => {
  const dispatch = useAppDispatch();
  const { currentSubscription } = useAppSelector(state => state.subscription);

  useEffect(() => {
    dispatch(fetchCurrentSubscription());
  }, [dispatch]);

  if (!currentSubscription || 
      currentSubscription.planCode === 'free' || 
      !currentSubscription.isExpiring) {
    return null;
  }

  const daysUntilExpiry = currentSubscription.daysUntilExpiry || 0;
  const expiryDate = dayjs(currentSubscription.endDate).format('YYYY年MM月DD日');

  const getAlertType = () => {
    if (daysUntilExpiry <= 3) return 'error';
    if (daysUntilExpiry <= 7) return 'warning';
    return 'info';
  };

  const getMessage = () => {
    if (daysUntilExpiry <= 0) {
      return `您的 ${currentSubscription.planName} 套餐已过期，已自动降级为免费套餐`;
    }
    
    return `您的 ${currentSubscription.planName} 套餐将在 ${daysUntilExpiry} 天后（${expiryDate}）到期`;
  };

  return (
    <Alert
      type={getAlertType()}
      message={
        <div className="flex items-center justify-between">
          <div className="flex items-center">
            <ClockCircleOutlined className="mr-2" />
            <span>{getMessage()}</span>
          </div>
          
          <div className="flex gap-2">
            <Button
              type="primary"
              size="small"
              icon={<CrownOutlined />}
            >
              立即续费
            </Button>
            <Button size="small">
              查看详情
            </Button>
          </div>
        </div>
      }
      banner
      closable
      className="mb-4"
    />
  );
};

export default ExpiryReminderBanner;
```

#### 11.2 定时任务处理过期订阅
```java
// SubscriptionScheduleService.java
@Service
public class SubscriptionScheduleService {
    
    @Autowired
    private UmsMemberSubscriptionsMapper subscriptionsMapper;
    
    @Autowired
    private NotificationService notificationService;
    
    @Scheduled(cron = "0 0 9 * * ?") // 每天上午9点执行
    public void processExpiringAndExpiredSubscriptions() {
        processExpiringSubscriptions();
        processExpiredSubscriptions();
    }
    
    private void processExpiringSubscriptions() {
        // 获取7天内即将到期的订阅
        LocalDateTime sevenDaysLater = LocalDateTime.now().plusDays(7);
        List<UmsMemberSubscriptions> expiring = subscriptionsMapper
            .selectExpiringBefore(Timestamp.valueOf(sevenDaysLater));
            
        for (UmsMemberSubscriptions subscription : expiring) {
            int daysUntilExpiry = (int) ChronoUnit.DAYS.between(
                LocalDateTime.now(), 
                subscription.getEndDate().toLocalDateTime()
            );
            
            // 发送不同程度的提醒
            if (daysUntilExpiry == 7 || daysUntilExpiry == 3 || daysUntilExpiry == 1) {
                sendExpiryReminder(subscription, daysUntilExpiry);
            }
        }
    }
    
    private void processExpiredSubscriptions() {
        // 获取已过期但状态仍为生效的订阅
        LocalDateTime now = LocalDateTime.now();
        List<UmsMemberSubscriptions> expired = subscriptionsMapper
            .selectExpiredButActive(Timestamp.valueOf(now));
            
        for (UmsMemberSubscriptions subscription : expired) {
            handleExpiredSubscription(subscription);
        }
    }
    
    private void sendExpiryReminder(UmsMemberSubscriptions subscription, int daysLeft) {
        NotificationDTO notification = new NotificationDTO();
        notification.setMemberId(subscription.getMemberId());
        notification.setType(NotificationType.SUBSCRIPTION_EXPIRY_REMINDER);
        notification.setTitle(String.format("套餐即将到期提醒"));
        notification.setContent(String.format(
            "您的%s套餐将在%d天后到期，请及时续费以免影响使用。",
            getPlanName(subscription.getPlanId()),
            daysLeft
        ));
        
        notificationService.sendNotification(notification);
        
        // 发送邮件提醒
        sendEmailReminder(subscription, daysLeft);
    }
    
    private void handleExpiredSubscription(UmsMemberSubscriptions subscription) {
        // 更新订阅状态为过期
        subscription.setStatus(2);
        subscriptionsMapper.updateByPrimaryKey(subscription);
        
        // 发送过期通知
        NotificationDTO notification = new NotificationDTO();
        notification.setMemberId(subscription.getMemberId());
        notification.setType(NotificationType.SUBSCRIPTION_EXPIRED);
        notification.setTitle("套餐已过期");
        notification.setContent(String.format(
            "您的%s套餐已过期，已自动降级为免费套餐。如需继续享受高级功能，请重新订阅。",
            getPlanName(subscription.getPlanId())
        ));
        
        notificationService.sendNotification(notification);
        
        // 记录日志
        log.info("Subscription {} for member {} has been expired and downgraded", 
            subscription.getId(), subscription.getMemberId());
    }
}
```

## 质量保证

### 功能测试清单
- [ ] 套餐展示正确
- [ ] 套餐购买流程完整
- [ ] 权限控制准确
- [ ] 使用统计正确
- [ ] 到期提醒及时
- [ ] 自动降级处理
- [ ] 套餐升级生效

### 性能测试
- [ ] 套餐查询响应时间 < 500ms
- [ ] 权限检查高效
- [ ] 使用统计查询优化
- [ ] 大量用户到期处理稳定

### 安全测试
- [ ] 套餐权限验证严格
- [ ] 恶意升级防护
- [ ] 数据统计准确
- [ ] 订阅状态一致性

## 交付物

### 前端代码
- [ ] 套餐状态管理
- [ ] 套餐升级弹窗
- [ ] Usage Details页面
- [ ] 权限控制组件
- [ ] 到期提醒组件

### 后端代码
- [ ] 套餐服务实现
- [ ] 套餐API接口
- [ ] 权限检查机制
- [ ] 使用统计收集
- [ ] 定时任务处理

### 数据库设计
- [ ] 套餐相关数据表
- [ ] 使用统计表
- [ ] 权限配置表

## 验收标准

1. **功能完整性**: 套餐管理各功能100%可用
2. **权限准确性**: 权限控制准确无误
3. **数据一致性**: 使用统计数据准确
4. **用户体验**: 套餐操作流畅，提示友好
5. **性能指标**: 查询 < 500ms，权限检查 < 100ms

## 风险控制

### 业务风险
1. **权限绕过**: 实现多层权限验证
2. **数据不一致**: 使用事务确保一致性
3. **恶意升级**: 实现升级验证机制

### 技术风险
1. **并发问题**: 使用锁机制处理并发订阅
2. **性能问题**: 实现权限缓存优化
3. **定时任务故障**: 实现任务监控和重试

完成此阶段后，用户将拥有完整的套餐管理体验，不同级别用户享受对应的功能权限，为整个系统的商业化运营奠定基础。