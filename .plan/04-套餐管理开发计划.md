# ç¬¬äº”é˜¶æ®µ: å¥—é¤ç®¡ç†ç³»ç»Ÿå¼€å‘è®¡åˆ’

## é˜¶æ®µæ¦‚è¿°
**æ—¶é—´å‘¨æœŸ**: 2å‘¨  
**ä¼˜å…ˆçº§**: é«˜  
**ä¾èµ–**: ç”¨æˆ·è®¤è¯ç³»ç»Ÿã€ç§¯åˆ†ç³»ç»Ÿå®Œæˆ  
**ç›®æ ‡**: å®ç°å®Œæ•´çš„ä¼šå‘˜å¥—é¤ç®¡ç†ç³»ç»Ÿï¼ŒåŒ…æ‹¬å¥—é¤å±•ç¤ºã€è´­ä¹°å‡çº§ã€æƒç›Šç®¡ç†ã€Usage Detailsç­‰åŠŸèƒ½

## åŠŸèƒ½éœ€æ±‚è¯¦ç»†åˆ†æ

### æ ¸å¿ƒåŠŸèƒ½æ¸…å•
1. **å¥—é¤å±•ç¤ºç³»ç»Ÿ** - åœ¨å‡çº§å¼¹çª—ä¸­å±•ç¤ºä¸åŒå¥—é¤é€‰é¡¹
2. **å¥—é¤è´­ä¹°æµç¨‹** - ç”¨æˆ·é€‰æ‹©å’Œè´­ä¹°å¥—é¤çš„å®Œæ•´æµç¨‹
3. **ä¼šå‘˜æƒç›Šç®¡ç†** - ä¸åŒå¥—é¤çº§åˆ«çš„åŠŸèƒ½æƒé™æ§åˆ¶
4. **Usage Detailsé¡µé¢** - è¯¦ç»†çš„ä½¿ç”¨æƒ…å†µç»Ÿè®¡å’Œåˆ†æ
5. **å¥—é¤åˆ°æœŸæé†’** - å¥—é¤å³å°†åˆ°æœŸçš„é€šçŸ¥æœºåˆ¶
6. **è‡ªåŠ¨é™çº§å¤„ç†** - å¥—é¤åˆ°æœŸåçš„è‡ªåŠ¨å¤„ç†é€»è¾‘
7. **å¥—é¤å‡çº§/ç»­è´¹** - ç°æœ‰å¥—é¤çš„å‡çº§å’Œç»­è´¹åŠŸèƒ½

### ä¸šåŠ¡è§„åˆ™è®¾è®¡
```
å¥—é¤ç³»ç»Ÿä¸šåŠ¡è§„åˆ™ï¼š
1. ç”¨æˆ·é»˜è®¤ä¸ºFreeå¥—é¤ï¼Œäº«æœ‰åŸºç¡€åŠŸèƒ½
2. ä»˜è´¹å¥—é¤æŒ‰æœˆæˆ–å¹´è®¡è´¹
3. å¥—é¤å‡çº§ç«‹å³ç”Ÿæ•ˆï¼Œé™çº§åœ¨åˆ°æœŸåç”Ÿæ•ˆ
4. å¥—é¤åŒ…å«çš„ç§¯åˆ†åœ¨è´­ä¹°æ—¶ç«‹å³å‘æ”¾
5. å¥—é¤åˆ°æœŸå‰7å¤©å¼€å§‹æé†’
6. åˆ°æœŸåè‡ªåŠ¨é™çº§ä¸ºFreeå¥—é¤
7. æ”¯æŒå¥—é¤é€€æ¬¾ï¼ˆæŒ‰æ¯”ä¾‹é€€æ¬¾ï¼‰
```

## æ•°æ®åº“è®¾è®¡

### æ•°æ®è¡¨ç»“æ„
```sql
-- å¥—é¤æ–¹æ¡ˆè¡¨
CREATE TABLE ums_subscription_plans (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    plan_code VARCHAR(50) UNIQUE NOT NULL COMMENT 'å¥—é¤ä»£ç ',
    name VARCHAR(100) NOT NULL COMMENT 'å¥—é¤åç§°',
    description TEXT COMMENT 'å¥—é¤æè¿°',
    price_monthly DECIMAL(10,2) COMMENT 'æœˆä»˜ä»·æ ¼',
    price_yearly DECIMAL(10,2) COMMENT 'å¹´ä»˜ä»·æ ¼',
    credits_included INT DEFAULT 0 COMMENT 'åŒ…å«çš„ç§¯åˆ†æ•°',
    max_projects INT DEFAULT -1 COMMENT 'æœ€å¤§é¡¹ç›®æ•°(-1ä¸ºæ— é™åˆ¶)',
    max_storage_gb INT DEFAULT -1 COMMENT 'æœ€å¤§å­˜å‚¨ç©ºé—´GB(-1ä¸ºæ— é™åˆ¶)',
    max_team_members INT DEFAULT 1 COMMENT 'æœ€å¤§å›¢é˜Ÿæˆå‘˜æ•°',
    features JSON COMMENT 'åŠŸèƒ½ç‰¹æ€§åˆ—è¡¨',
    limitations JSON COMMENT 'é™åˆ¶æ¡ä»¶',
    priority_level INT DEFAULT 0 COMMENT 'ä¼˜å…ˆçº§ç­‰çº§(æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜)',
    is_popular TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦çƒ­é—¨å¥—é¤',
    is_active TINYINT DEFAULT 1 COMMENT 'æ˜¯å¦å¯ç”¨',
    sort_order INT DEFAULT 0 COMMENT 'æ’åºé¡ºåº',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- ç”¨æˆ·å¥—é¤è®¢é˜…è¡¨
CREATE TABLE ums_member_subscriptions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    member_id BIGINT NOT NULL COMMENT 'ä¼šå‘˜ID',
    plan_id BIGINT NOT NULL COMMENT 'å¥—é¤ID',
    plan_code VARCHAR(50) NOT NULL COMMENT 'å¥—é¤ä»£ç (å†—ä½™å­˜å‚¨)',
    billing_cycle ENUM('monthly', 'yearly') NOT NULL COMMENT 'è®¡è´¹å‘¨æœŸ',
    start_date DATETIME NOT NULL COMMENT 'å¼€å§‹æ—¶é—´',
    end_date DATETIME NOT NULL COMMENT 'ç»“æŸæ—¶é—´',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€: 1-ç”Ÿæ•ˆ, 2-è¿‡æœŸ, 3-å–æ¶ˆ, 4-æš‚åœ',
    auto_renew TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦è‡ªåŠ¨ç»­è´¹',
    order_id BIGINT COMMENT 'è´­ä¹°è®¢å•ID',
    credits_granted INT DEFAULT 0 COMMENT 'å·²å‘æ”¾ç§¯åˆ†æ•°',
    used_projects INT DEFAULT 0 COMMENT 'å·²ä½¿ç”¨é¡¹ç›®æ•°',
    used_storage_mb INT DEFAULT 0 COMMENT 'å·²ä½¿ç”¨å­˜å‚¨ç©ºé—´MB',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_member_id (member_id),
    INDEX idx_end_date (end_date),
    INDEX idx_status (status)
);

-- å¥—é¤ä½¿ç”¨ç»Ÿè®¡è¡¨
CREATE TABLE ums_subscription_usage (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    member_id BIGINT NOT NULL COMMENT 'ä¼šå‘˜ID',
    subscription_id BIGINT NOT NULL COMMENT 'è®¢é˜…ID',
    usage_date DATE NOT NULL COMMENT 'ä½¿ç”¨æ—¥æœŸ',
    ai_tasks_count INT DEFAULT 0 COMMENT 'AIä»»åŠ¡æ¬¡æ•°',
    credits_consumed INT DEFAULT 0 COMMENT 'æ¶ˆè´¹ç§¯åˆ†æ•°',
    projects_created INT DEFAULT 0 COMMENT 'åˆ›å»ºé¡¹ç›®æ•°',
    storage_used_mb INT DEFAULT 0 COMMENT 'ä½¿ç”¨å­˜å‚¨ç©ºé—´MB',
    api_calls_count INT DEFAULT 0 COMMENT 'APIè°ƒç”¨æ¬¡æ•°',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_member_date (member_id, usage_date),
    INDEX idx_subscription_id (subscription_id)
);

-- å¥—é¤æƒç›Šé…ç½®è¡¨
CREATE TABLE ums_subscription_features (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    plan_id BIGINT NOT NULL COMMENT 'å¥—é¤ID',
    feature_code VARCHAR(100) NOT NULL COMMENT 'åŠŸèƒ½ä»£ç ',
    feature_name VARCHAR(200) NOT NULL COMMENT 'åŠŸèƒ½åç§°',
    feature_value VARCHAR(500) COMMENT 'åŠŸèƒ½å€¼',
    is_enabled TINYINT DEFAULT 1 COMMENT 'æ˜¯å¦å¯ç”¨',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_plan_id (plan_id),
    UNIQUE KEY uk_plan_feature (plan_id, feature_code)
);

-- åˆå§‹åŒ–å¥—é¤æ•°æ®
INSERT INTO ums_subscription_plans (plan_code, name, description, price_monthly, price_yearly, credits_included, features, priority_level, is_popular) VALUES
('free', 'Free', 'å…è´¹å¥—é¤ï¼Œé€‚åˆä¸ªäººè½»åº¦ä½¿ç”¨', 0.00, 0.00, 0, '["åŸºç¡€AIåŠŸèƒ½", "æ¯æ—¥200å…è´¹ç§¯åˆ†", "æœ€å¤š3ä¸ªé¡¹ç›®", "1GBå­˜å‚¨ç©ºé—´"]', 0, 0),
('basic', 'Basic', 'åŸºç¡€å¥—é¤ï¼Œé€‚åˆä¸ªäººç”¨æˆ·', 29.90, 299.00, 3000, '["æ‰€æœ‰AIåŠŸèƒ½", "3000ç§¯åˆ†/æœˆ", "æ— é™é¡¹ç›®", "10GBå­˜å‚¨ç©ºé—´", "ä¼˜å…ˆå¤„ç†"]', 1, 0),
('pro', 'Pro', 'ä¸“ä¸šå¥—é¤ï¼Œé€‚åˆä¸“ä¸šç”¨æˆ·', 59.90, 599.00, 8000, '["æ‰€æœ‰AIåŠŸèƒ½", "8000ç§¯åˆ†/æœˆ", "æ— é™é¡¹ç›®", "50GBå­˜å‚¨ç©ºé—´", "ä¼˜å…ˆå¤„ç†", "é«˜çº§æ¨¡å‹è®¿é—®", "æ‰¹é‡å¤„ç†"]', 2, 1),
('team', 'Team', 'å›¢é˜Ÿå¥—é¤ï¼Œé€‚åˆå°å›¢é˜Ÿ', 99.90, 999.00, 15000, '["æ‰€æœ‰AIåŠŸèƒ½", "15000ç§¯åˆ†/æœˆ", "æ— é™é¡¹ç›®", "200GBå­˜å‚¨ç©ºé—´", "ä¼˜å…ˆå¤„ç†", "é«˜çº§æ¨¡å‹è®¿é—®", "æ‰¹é‡å¤„ç†", "å›¢é˜Ÿåä½œ", "5ä¸ªæˆå‘˜"]', 3, 1),
('enterprise', 'Enterprise', 'ä¼ä¸šå¥—é¤ï¼Œé€‚åˆå¤§å‹ä¼ä¸š', 299.90, 2999.00, 50000, '["æ‰€æœ‰AIåŠŸèƒ½", "50000ç§¯åˆ†/æœˆ", "æ— é™é¡¹ç›®", "1TBå­˜å‚¨ç©ºé—´", "æœ€é«˜ä¼˜å…ˆçº§", "æ‰€æœ‰æ¨¡å‹è®¿é—®", "æ‰¹é‡å¤„ç†", "å›¢é˜Ÿåä½œ", "æ— é™æˆå‘˜", "ä¸“å±å®¢æœ", "APIè®¿é—®", "æ•°æ®å¯¼å‡º"]', 4, 0);

-- åˆå§‹åŒ–å¥—é¤åŠŸèƒ½é…ç½®
INSERT INTO ums_subscription_features (plan_id, feature_code, feature_name, feature_value, is_enabled) VALUES
(1, 'max_projects', 'æœ€å¤§é¡¹ç›®æ•°', '3', 1),
(1, 'max_storage_gb', 'æœ€å¤§å­˜å‚¨ç©ºé—´', '1', 1),
(1, 'ai_model_access', 'AIæ¨¡å‹è®¿é—®', 'basic', 1),
(1, 'priority_level', 'ä¼˜å…ˆçº§ç­‰çº§', '0', 1),

(2, 'max_projects', 'æœ€å¤§é¡¹ç›®æ•°', '-1', 1),
(2, 'max_storage_gb', 'æœ€å¤§å­˜å‚¨ç©ºé—´', '10', 1),
(2, 'ai_model_access', 'AIæ¨¡å‹è®¿é—®', 'standard', 1),
(2, 'priority_level', 'ä¼˜å…ˆçº§ç­‰çº§', '1', 1),

(3, 'max_projects', 'æœ€å¤§é¡¹ç›®æ•°', '-1', 1),
(3, 'max_storage_gb', 'æœ€å¤§å­˜å‚¨ç©ºé—´', '50', 1),
(3, 'ai_model_access', 'AIæ¨¡å‹è®¿é—®', 'advanced', 1),
(3, 'priority_level', 'ä¼˜å…ˆçº§ç­‰çº§', '2', 1),
(3, 'batch_processing', 'æ‰¹é‡å¤„ç†', 'true', 1),

(4, 'max_projects', 'æœ€å¤§é¡¹ç›®æ•°', '-1', 1),
(4, 'max_storage_gb', 'æœ€å¤§å­˜å‚¨ç©ºé—´', '200', 1),
(4, 'ai_model_access', 'AIæ¨¡å‹è®¿é—®', 'advanced', 1),
(4, 'priority_level', 'ä¼˜å…ˆçº§ç­‰çº§', '3', 1),
(4, 'batch_processing', 'æ‰¹é‡å¤„ç†', 'true', 1),
(4, 'team_collaboration', 'å›¢é˜Ÿåä½œ', 'true', 1),
(4, 'max_team_members', 'æœ€å¤§å›¢é˜Ÿæˆå‘˜', '5', 1),

(5, 'max_projects', 'æœ€å¤§é¡¹ç›®æ•°', '-1', 1),
(5, 'max_storage_gb', 'æœ€å¤§å­˜å‚¨ç©ºé—´', '1024', 1),
(5, 'ai_model_access', 'AIæ¨¡å‹è®¿é—®', 'premium', 1),
(5, 'priority_level', 'ä¼˜å…ˆçº§ç­‰çº§', '4', 1),
(5, 'batch_processing', 'æ‰¹é‡å¤„ç†', 'true', 1),
(5, 'team_collaboration', 'å›¢é˜Ÿåä½œ', 'true', 1),
(5, 'max_team_members', 'æœ€å¤§å›¢é˜Ÿæˆå‘˜', '-1', 1),
(5, 'api_access', 'APIè®¿é—®', 'true', 1),
(5, 'dedicated_support', 'ä¸“å±å®¢æœ', 'true', 1),
(5, 'data_export', 'æ•°æ®å¯¼å‡º', 'true', 1);
```

## è¯¦ç»†å¼€å‘ä»»åŠ¡

### ç¬¬1-2å¤©: åç«¯å¥—é¤æœåŠ¡å¼€å‘

#### 1.1 å¥—é¤æœåŠ¡æ ¸å¿ƒç±»
```java
// SubscriptionService.java
@Service
@Transactional
public class SubscriptionServiceImpl implements SubscriptionService {
    
    @Autowired
    private UmsSubscriptionPlansMapper plansMapper;
    
    @Autowired
    private UmsMemberSubscriptionsMapper subscriptionsMapper;
    
    @Autowired
    private UmsSubscriptionUsageMapper usageMapper;
    
    @Autowired
    private CreditsService creditsService;
    
    @Override
    public List<UmsSubscriptionPlans> getAllPlans() {
        return plansMapper.selectActiveOrderBySort();
    }
    
    @Override
    public UmsMemberSubscriptions getCurrentSubscription(Long memberId) {
        return subscriptionsMapper.selectCurrentByMemberId(memberId);
    }
    
    @Override
    public UmsMemberSubscriptions subscribeToPlan(Long memberId, Long planId, 
            BillingCycle billingCycle) {
        
        UmsSubscriptionPlans plan = plansMapper.selectByPrimaryKey(planId);
        if (plan == null || plan.getIsActive() == 0) {
            throw new BusinessException("å¥—é¤ä¸å­˜åœ¨æˆ–å·²åœç”¨");
        }
        
        // æ£€æŸ¥å½“å‰æ˜¯å¦æœ‰æœ‰æ•ˆè®¢é˜…
        UmsMemberSubscriptions currentSub = getCurrentSubscription(memberId);
        if (currentSub != null && currentSub.getStatus() == 1) {
            // å¤„ç†å¥—é¤å‡çº§é€»è¾‘
            return upgradePlan(memberId, currentSub, planId, billingCycle);
        }
        
        // åˆ›å»ºæ–°è®¢é˜…
        UmsMemberSubscriptions subscription = new UmsMemberSubscriptions();
        subscription.setMemberId(memberId);
        subscription.setPlanId(planId);
        subscription.setPlanCode(plan.getPlanCode());
        subscription.setBillingCycle(billingCycle);
        
        LocalDateTime startTime = LocalDateTime.now();
        LocalDateTime endTime = billingCycle == BillingCycle.MONTHLY ? 
            startTime.plusMonths(1) : startTime.plusYears(1);
            
        subscription.setStartDate(Timestamp.valueOf(startTime));
        subscription.setEndDate(Timestamp.valueOf(endTime));
        subscription.setStatus(1);
        subscription.setCreditsGranted(plan.getCreditsIncluded());
        
        subscriptionsMapper.insert(subscription);
        
        // å‘æ”¾å¥—é¤ç§¯åˆ†
        if (plan.getCreditsIncluded() > 0) {
            creditsService.addCredits(memberId, plan.getCreditsIncluded(), 
                ChangeType.SUBSCRIPTION_GRANT, 
                String.format("è®¢é˜…%så¥—é¤è·å¾—ç§¯åˆ†", plan.getName()), 
                null);
        }
        
        // å‘é€è®¢é˜…æˆåŠŸé€šçŸ¥
        sendSubscriptionNotification(memberId, subscription, NotificationType.SUBSCRIBED);
        
        return subscription;
    }
    
    @Override
    public SubscriptionUsageDTO getUsageDetails(Long memberId) {
        UmsMemberSubscriptions subscription = getCurrentSubscription(memberId);
        if (subscription == null) {
            return getDefaultUsageDetails(memberId);
        }
        
        // è·å–å½“å‰è®¡è´¹å‘¨æœŸçš„ä½¿ç”¨ç»Ÿè®¡
        LocalDate startDate = subscription.getStartDate().toLocalDateTime().toLocalDate();
        LocalDate endDate = subscription.getEndDate().toLocalDateTime().toLocalDate();
        
        List<UmsSubscriptionUsage> usageList = usageMapper.selectByMemberIdAndDateRange(
            memberId, startDate, endDate);
            
        // èšåˆç»Ÿè®¡æ•°æ®
        SubscriptionUsageDTO usageDTO = new SubscriptionUsageDTO();
        usageDTO.setSubscription(subscription);
        usageDTO.setTotalAiTasks(usageList.stream().mapToInt(UmsSubscriptionUsage::getAiTasksCount).sum());
        usageDTO.setTotalCreditsConsumed(usageList.stream().mapToInt(UmsSubscriptionUsage::getCreditsConsumed).sum());
        usageDTO.setTotalProjectsCreated(usageList.stream().mapToInt(UmsSubscriptionUsage::getProjectsCreated).sum());
        usageDTO.setTotalStorageUsedMb(usageList.stream().mapToInt(UmsSubscriptionUsage::getStorageUsedMb).sum());
        usageDTO.setTotalApiCalls(usageList.stream().mapToInt(UmsSubscriptionUsage::getApiCallsCount).sum());
        usageDTO.setUsageHistory(usageList);
        
        // è·å–å¥—é¤é™åˆ¶ä¿¡æ¯
        UmsSubscriptionPlans plan = plansMapper.selectByPrimaryKey(subscription.getPlanId());
        usageDTO.setPlanLimits(plan);
        
        return usageDTO;
    }
    
    @Override
    public void recordUsage(Long memberId, UsageType type, int amount) {
        UmsMemberSubscriptions subscription = getCurrentSubscription(memberId);
        if (subscription == null) {
            return; // Freeç”¨æˆ·ä¸è®°å½•è¯¦ç»†ä½¿ç”¨ç»Ÿè®¡
        }
        
        LocalDate today = LocalDate.now();
        UmsSubscriptionUsage usage = usageMapper.selectByMemberIdAndDate(memberId, today);
        
        if (usage == null) {
            usage = new UmsSubscriptionUsage();
            usage.setMemberId(memberId);
            usage.setSubscriptionId(subscription.getId());
            usage.setUsageDate(Date.valueOf(today));
            
            switch (type) {
                case AI_TASKS:
                    usage.setAiTasksCount(amount);
                    break;
                case CREDITS_CONSUMED:
                    usage.setCreditsConsumed(amount);
                    break;
                case PROJECTS_CREATED:
                    usage.setProjectsCreated(amount);
                    break;
                case STORAGE_USED:
                    usage.setStorageUsedMb(amount);
                    break;
                case API_CALLS:
                    usage.setApiCallsCount(amount);
                    break;
            }
            
            usageMapper.insert(usage);
        } else {
            switch (type) {
                case AI_TASKS:
                    usage.setAiTasksCount(usage.getAiTasksCount() + amount);
                    break;
                case CREDITS_CONSUMED:
                    usage.setCreditsConsumed(usage.getCreditsConsumed() + amount);
                    break;
                case PROJECTS_CREATED:
                    usage.setProjectsCreated(usage.getProjectsCreated() + amount);
                    break;
                case STORAGE_USED:
                    usage.setStorageUsedMb(usage.getStorageUsedMb() + amount);
                    break;
                case API_CALLS:
                    usage.setApiCallsCount(usage.getApiCallsCount() + amount);
                    break;
            }
            
            usageMapper.updateByPrimaryKey(usage);
        }
    }
    
    @Override
    @Scheduled(cron = "0 0 9 * * ?") // æ¯å¤©ä¸Šåˆ9ç‚¹æ£€æŸ¥
    public void checkExpiringSubscriptions() {
        // æŸ¥æ‰¾7å¤©å†…åˆ°æœŸçš„è®¢é˜…
        LocalDateTime sevenDaysLater = LocalDateTime.now().plusDays(7);
        List<UmsMemberSubscriptions> expiring = subscriptionsMapper
            .selectExpiringBefore(Timestamp.valueOf(sevenDaysLater));
            
        for (UmsMemberSubscriptions sub : expiring) {
            sendExpiryReminder(sub);
        }
        
        // å¤„ç†å·²è¿‡æœŸçš„è®¢é˜…
        LocalDateTime now = LocalDateTime.now();
        List<UmsMemberSubscriptions> expired = subscriptionsMapper
            .selectExpiredBefore(Timestamp.valueOf(now));
            
        for (UmsMemberSubscriptions sub : expired) {
            handleExpiredSubscription(sub);
        }
    }
    
    private void handleExpiredSubscription(UmsMemberSubscriptions subscription) {
        subscription.setStatus(2); // è®¾ç½®ä¸ºè¿‡æœŸçŠ¶æ€
        subscriptionsMapper.updateByPrimaryKey(subscription);
        
        // å‘é€è¿‡æœŸé€šçŸ¥
        sendSubscriptionNotification(subscription.getMemberId(), subscription, 
            NotificationType.EXPIRED);
    }
    
    @Override
    public boolean hasFeature(Long memberId, String featureCode) {
        UmsMemberSubscriptions subscription = getCurrentSubscription(memberId);
        if (subscription == null) {
            // å…è´¹ç”¨æˆ·çš„åŠŸèƒ½æ£€æŸ¥
            return checkFreeUserFeature(featureCode);
        }
        
        UmsSubscriptionFeatures feature = featuresMapper.selectByPlanIdAndCode(
            subscription.getPlanId(), featureCode);
            
        return feature != null && feature.getIsEnabled() == 1;
    }
    
    @Override
    public String getFeatureValue(Long memberId, String featureCode) {
        UmsMemberSubscriptions subscription = getCurrentSubscription(memberId);
        if (subscription == null) {
            return getFreeUserFeatureValue(featureCode);
        }
        
        UmsSubscriptionFeatures feature = featuresMapper.selectByPlanIdAndCode(
            subscription.getPlanId(), featureCode);
            
        return feature != null ? feature.getFeatureValue() : null;
    }
}
```

#### 1.2 å¥—é¤æ§åˆ¶å™¨
```java
// SubscriptionController.java
@RestController
@RequestMapping("/api/subscription")
public class SubscriptionController {
    
    @Autowired
    private SubscriptionService subscriptionService;
    
    @GetMapping("/plans")
    @ApiOperation("è·å–æ‰€æœ‰å¥—é¤")
    public CommonResult<List<SubscriptionPlanVO>> getAllPlans() {
        List<UmsSubscriptionPlans> plans = subscriptionService.getAllPlans();
        List<SubscriptionPlanVO> voList = plans.stream()
            .map(this::convertToPlanVO)
            .collect(Collectors.toList());
            
        return CommonResult.success(voList);
    }
    
    @GetMapping("/current")
    @ApiOperation("è·å–å½“å‰å¥—é¤")
    public CommonResult<CurrentSubscriptionVO> getCurrentSubscription() {
        Long memberId = getCurrentMemberId();
        UmsMemberSubscriptions subscription = subscriptionService.getCurrentSubscription(memberId);
        
        CurrentSubscriptionVO vo = new CurrentSubscriptionVO();
        if (subscription != null) {
            vo = convertToCurrentVO(subscription);
        } else {
            vo.setPlanCode("free");
            vo.setPlanName("Free");
            vo.setStatus("active");
            vo.setIsExpiring(false);
        }
        
        return CommonResult.success(vo);
    }
    
    @PostMapping("/subscribe")
    @ApiOperation("è®¢é˜…å¥—é¤")
    public CommonResult<?> subscribeToPlan(@RequestBody SubscribeRequest request) {
        Long memberId = getCurrentMemberId();
        
        UmsMemberSubscriptions subscription = subscriptionService.subscribeToPlan(
            memberId, 
            request.getPlanId(), 
            BillingCycle.valueOf(request.getBillingCycle().toUpperCase())
        );
        
        return CommonResult.success(Map.of(
            "subscriptionId", subscription.getId(),
            "message", "è®¢é˜…æˆåŠŸ"
        ));
    }
    
    @GetMapping("/usage")
    @ApiOperation("è·å–ä½¿ç”¨è¯¦æƒ…")
    public CommonResult<SubscriptionUsageVO> getUsageDetails() {
        Long memberId = getCurrentMemberId();
        SubscriptionUsageDTO usageDTO = subscriptionService.getUsageDetails(memberId);
        
        SubscriptionUsageVO vo = convertToUsageVO(usageDTO);
        return CommonResult.success(vo);
    }
    
    @PostMapping("/cancel")
    @ApiOperation("å–æ¶ˆè®¢é˜…")
    public CommonResult<?> cancelSubscription(@RequestParam Long subscriptionId) {
        Long memberId = getCurrentMemberId();
        subscriptionService.cancelSubscription(memberId, subscriptionId);
        
        return CommonResult.success("è®¢é˜…å–æ¶ˆæˆåŠŸï¼Œå°†åœ¨åˆ°æœŸååœæ­¢ç»­è´¹");
    }
    
    @PostMapping("/renew")
    @ApiOperation("ç»­è´¹è®¢é˜…")
    public CommonResult<?> renewSubscription(@RequestBody RenewRequest request) {
        Long memberId = getCurrentMemberId();
        
        UmsMemberSubscriptions subscription = subscriptionService.renewSubscription(
            memberId, 
            request.getSubscriptionId(),
            BillingCycle.valueOf(request.getBillingCycle().toUpperCase())
        );
        
        return CommonResult.success(subscription);
    }
    
    @GetMapping("/features/{featureCode}")
    @ApiOperation("æ£€æŸ¥åŠŸèƒ½æƒé™")
    public CommonResult<FeatureCheckVO> checkFeature(@PathVariable String featureCode) {
        Long memberId = getCurrentMemberId();
        
        boolean hasFeature = subscriptionService.hasFeature(memberId, featureCode);
        String featureValue = subscriptionService.getFeatureValue(memberId, featureCode);
        
        FeatureCheckVO vo = new FeatureCheckVO();
        vo.setFeatureCode(featureCode);
        vo.setHasFeature(hasFeature);
        vo.setFeatureValue(featureValue);
        
        return CommonResult.success(vo);
    }
}
```

### ç¬¬3-4å¤©: å‰ç«¯å¥—é¤çŠ¶æ€ç®¡ç†

#### 3.1 å¥—é¤çŠ¶æ€åˆ‡ç‰‡
```typescript
// store/subscription/subscriptionSlice.ts
import { createSlice, createAsyncThunk } from '@reduxjs/toolkit';
import { subscriptionAPI } from '@/api/subscription';

interface SubscriptionState {
  plans: SubscriptionPlan[];
  currentSubscription: CurrentSubscription | null;
  usage: SubscriptionUsage | null;
  loading: boolean;
  error: string | null;
  subscribeLoading: boolean;
}

const initialState: SubscriptionState = {
  plans: [],
  currentSubscription: null,
  usage: null,
  loading: false,
  error: null,
  subscribeLoading: false,
};

// å¼‚æ­¥thunks
export const fetchPlans = createAsyncThunk(
  'subscription/fetchPlans',
  async () => {
    const response = await subscriptionAPI.getPlans();
    return response.data;
  }
);

export const fetchCurrentSubscription = createAsyncThunk(
  'subscription/fetchCurrent',
  async () => {
    const response = await subscriptionAPI.getCurrent();
    return response.data;
  }
);

export const fetchUsageDetails = createAsyncThunk(
  'subscription/fetchUsage',
  async () => {
    const response = await subscriptionAPI.getUsage();
    return response.data;
  }
);

export const subscribeToPlan = createAsyncThunk(
  'subscription/subscribe',
  async (params: SubscribeParams) => {
    const response = await subscriptionAPI.subscribe(params);
    return response.data;
  }
);

export const checkFeature = createAsyncThunk(
  'subscription/checkFeature',
  async (featureCode: string) => {
    const response = await subscriptionAPI.checkFeature(featureCode);
    return response.data;
  }
);

const subscriptionSlice = createSlice({
  name: 'subscription',
  initialState,
  reducers: {
    clearError: (state) => {
      state.error = null;
    },
    updateUsage: (state, action) => {
      if (state.usage) {
        state.usage = { ...state.usage, ...action.payload };
      }
    },
  },
  extraReducers: (builder) => {
    builder
      // è·å–å¥—é¤åˆ—è¡¨
      .addCase(fetchPlans.pending, (state) => {
        state.loading = true;
        state.error = null;
      })
      .addCase(fetchPlans.fulfilled, (state, action) => {
        state.loading = false;
        state.plans = action.payload;
      })
      .addCase(fetchPlans.rejected, (state, action) => {
        state.loading = false;
        state.error = action.error.message || 'è·å–å¥—é¤åˆ—è¡¨å¤±è´¥';
      })
      // è·å–å½“å‰è®¢é˜…
      .addCase(fetchCurrentSubscription.fulfilled, (state, action) => {
        state.currentSubscription = action.payload;
      })
      // è·å–ä½¿ç”¨è¯¦æƒ…
      .addCase(fetchUsageDetails.fulfilled, (state, action) => {
        state.usage = action.payload;
      })
      // è®¢é˜…å¥—é¤
      .addCase(subscribeToPlan.pending, (state) => {
        state.subscribeLoading = true;
        state.error = null;
      })
      .addCase(subscribeToPlan.fulfilled, (state) => {
        state.subscribeLoading = false;
        // è®¢é˜…æˆåŠŸåé‡æ–°è·å–å½“å‰è®¢é˜…ä¿¡æ¯
      })
      .addCase(subscribeToPlan.rejected, (state, action) => {
        state.subscribeLoading = false;
        state.error = action.error.message || 'è®¢é˜…å¤±è´¥';
      });
  },
});

export const { clearError, updateUsage } = subscriptionSlice.actions;
export default subscriptionSlice.reducer;
```

#### 3.2 å¥—é¤APIæ¥å£
```typescript
// api/subscription.ts
import { request } from '@/utils/request';

export const subscriptionAPI = {
  // è·å–æ‰€æœ‰å¥—é¤
  getPlans: () => 
    request.get<SubscriptionPlan[]>('/subscription/plans'),

  // è·å–å½“å‰è®¢é˜…
  getCurrent: () => 
    request.get<CurrentSubscription>('/subscription/current'),

  // è®¢é˜…å¥—é¤
  subscribe: (data: SubscribeParams) => 
    request.post('/subscription/subscribe', data),

  // è·å–ä½¿ç”¨è¯¦æƒ…
  getUsage: () => 
    request.get<SubscriptionUsage>('/subscription/usage'),

  // å–æ¶ˆè®¢é˜…
  cancel: (subscriptionId: number) => 
    request.post('/subscription/cancel', { subscriptionId }),

  // ç»­è´¹è®¢é˜…
  renew: (data: RenewParams) => 
    request.post('/subscription/renew', data),

  // æ£€æŸ¥åŠŸèƒ½æƒé™
  checkFeature: (featureCode: string) => 
    request.get<FeatureCheck>(`/subscription/features/${featureCode}`),
};

// ç±»å‹å®šä¹‰
export interface SubscriptionPlan {
  id: number;
  planCode: string;
  name: string;
  description: string;
  priceMonthly: number;
  priceYearly: number;
  creditsIncluded: number;
  features: string[];
  isPopular: boolean;
  priorityLevel: number;
}

export interface CurrentSubscription {
  id?: number;
  planCode: string;
  planName: string;
  billingCycle?: string;
  startDate?: string;
  endDate?: string;
  status: string;
  isExpiring: boolean;
  daysUntilExpiry?: number;
  autoRenew?: boolean;
}

export interface SubscriptionUsage {
  subscription: CurrentSubscription;
  totalAiTasks: number;
  totalCreditsConsumed: number;
  totalProjectsCreated: number;
  totalStorageUsedMb: number;
  totalApiCalls: number;
  planLimits: {
    maxProjects: number;
    maxStorageGb: number;
    creditsIncluded: number;
  };
  usageHistory: DailyUsage[];
}

export interface DailyUsage {
  usageDate: string;
  aiTasksCount: number;
  creditsConsumed: number;
  projectsCreated: number;
  storageUsedMb: number;
  apiCallsCount: number;
}

export interface SubscribeParams {
  planId: number;
  billingCycle: 'monthly' | 'yearly';
}

export interface RenewParams {
  subscriptionId: number;
  billingCycle: 'monthly' | 'yearly';
}

export interface FeatureCheck {
  featureCode: string;
  hasFeature: boolean;
  featureValue?: string;
}
```

### ç¬¬5-6å¤©: å¥—é¤å‡çº§å¼¹çª—å¼€å‘

#### 5.1 å¥—é¤å‡çº§å¼¹çª—ç»„ä»¶
```typescript
// components/SubscriptionUpgradeModal.tsx
import React, { useEffect, useState } from 'react';
import { 
  Modal, 
  Card, 
  Row, 
  Col, 
  Button, 
  Switch, 
  Badge, 
  Typography, 
  Divider,
  List,
  message 
} from 'antd';
import { 
  CrownOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  ThunderboltOutlined,
  FireOutlined 
} from '@ant-design/icons';
import { useAppSelector, useAppDispatch } from '@/hooks/redux';
import { fetchPlans, subscribeToPlan } from '@/store/subscription/subscriptionSlice';

const { Title, Text } = Typography;

interface SubscriptionUpgradeModalProps {
  visible: boolean;
  onCancel: () => void;
  onSuccess?: () => void;
}

const SubscriptionUpgradeModal: React.FC<SubscriptionUpgradeModalProps> = ({
  visible,
  onCancel,
  onSuccess,
}) => {
  const dispatch = useAppDispatch();
  const { plans, subscribeLoading, currentSubscription } = useAppSelector(state => state.subscription);
  const [billingCycle, setBillingCycle] = useState<'monthly' | 'yearly'>('monthly');
  const [selectedPlan, setSelectedPlan] = useState<number | null>(null);

  useEffect(() => {
    if (visible) {
      dispatch(fetchPlans());
    }
  }, [visible, dispatch]);

  const handleSubscribe = async (planId: number) => {
    if (currentSubscription?.planCode !== 'free' && 
        planId <= (plans.find(p => p.planCode === currentSubscription?.planCode)?.id || 0)) {
      message.warning('æ— æ³•é™çº§åˆ°æ›´ä½ç­‰çº§çš„å¥—é¤');
      return;
    }

    try {
      setSelectedPlan(planId);
      await dispatch(subscribeToPlan({ planId, billingCycle })).unwrap();
      message.success('è®¢é˜…æˆåŠŸï¼');
      onSuccess?.();
      onCancel();
    } catch (error: any) {
      message.error(error.message || 'è®¢é˜…å¤±è´¥');
    } finally {
      setSelectedPlan(null);
    }
  };

  const calculateYearlyDiscount = (monthly: number, yearly: number) => {
    const yearlyEquivalent = monthly * 12;
    const discount = Math.round(((yearlyEquivalent - yearly) / yearlyEquivalent) * 100);
    return discount;
  };

  const formatPrice = (price: number) => {
    return `Â¥${price.toFixed(2)}`;
  };

  const getCurrentPlanId = () => {
    if (!currentSubscription || currentSubscription.planCode === 'free') return 0;
    return plans.find(p => p.planCode === currentSubscription.planCode)?.id || 0;
  };

  const isPlanCurrent = (planId: number) => {
    return planId === getCurrentPlanId();
  };

  const isPlanDowngrade = (planId: number) => {
    const currentPlanId = getCurrentPlanId();
    return currentPlanId > 0 && planId < currentPlanId;
  };

  const getPlanIcon = (plan: any) => {
    if (plan.planCode === 'free') return 'ğŸ†“';
    if (plan.isPopular) return <FireOutlined className="text-red-500" />;
    return <CrownOutlined className="text-yellow-500" />;
  };

  const getPlanBadge = (plan: any) => {
    if (plan.isPopular) return <Badge.Ribbon text="æœ€å—æ¬¢è¿" color="red" />;
    if (plan.planCode === 'enterprise') return <Badge.Ribbon text="ä¼ä¸šé¦–é€‰" color="purple" />;
    return null;
  };

  return (
    <Modal
      title={null}
      open={visible}
      onCancel={onCancel}
      footer={null}
      width={1200}
      bodyStyle={{ padding: 0 }}
      className="subscription-modal"
    >
      <div className="p-8">
        <div className="text-center mb-8">
          <Title level={2}>é€‰æ‹©é€‚åˆçš„å¥—é¤</Title>
          <Text type="secondary" className="text-lg">
            å‡çº§å¥—é¤ï¼Œäº«å—æ›´å¤šåŠŸèƒ½å’ŒæœåŠ¡
          </Text>
          
          <div className="flex justify-center items-center mt-6 gap-4">
            <Text>æœˆä»˜</Text>
            <Switch 
              checked={billingCycle === 'yearly'}
              onChange={(checked) => setBillingCycle(checked ? 'yearly' : 'monthly')}
            />
            <Text>å¹´ä»˜ <span className="text-green-500">(èŠ‚çœæ›´å¤š)</span></Text>
          </div>
        </div>

        <Row gutter={[24, 24]}>
          {plans.map((plan) => {
            const price = billingCycle === 'monthly' ? plan.priceMonthly : plan.priceYearly;
            const yearlyDiscount = calculateYearlyDiscount(plan.priceMonthly, plan.priceYearly);
            const isCurrent = isPlanCurrent(plan.id);
            const isDowngrade = isPlanDowngrade(plan.id);

            return (
              <Col key={plan.id} xs={24} sm={12} lg={8} xl={6}>
                {getPlanBadge(plan)}
                <Card
                  className={`h-full transition-all duration-300 hover:shadow-lg ${
                    plan.isPopular ? 'border-red-400 shadow-md' : ''
                  } ${isCurrent ? 'border-blue-400 bg-blue-50' : ''}`}
                  bodyStyle={{ padding: '24px' }}
                >
                  <div className="text-center">
                    <div className="text-4xl mb-4">
                      {getPlanIcon(plan)}
                    </div>
                    
                    <Title level={4} className="mb-2">
                      {plan.name}
                      {isCurrent && <Badge count="å½“å‰å¥—é¤" className="ml-2" />}
                    </Title>
                    
                    <Text type="secondary" className="block mb-4">
                      {plan.description}
                    </Text>
                    
                    <div className="mb-4">
                      <div className="text-3xl font-bold text-blue-500 mb-1">
                        {plan.planCode === 'free' ? 'å…è´¹' : formatPrice(price)}
                      </div>
                      {billingCycle === 'yearly' && yearlyDiscount > 0 && plan.planCode !== 'free' && (
                        <div className="text-sm text-green-500">
                          å¹´ä»˜èŠ‚çœ{yearlyDiscount}%
                        </div>
                      )}
                      {plan.planCode !== 'free' && (
                        <div className="text-sm text-gray-500">
                          {billingCycle === 'monthly' ? '/æœˆ' : '/å¹´'}
                        </div>
                      )}
                    </div>
                    
                    {plan.creditsIncluded > 0 && (
                      <div className="mb-4 p-2 bg-yellow-50 rounded-lg">
                        <ThunderboltOutlined className="text-yellow-500 mr-1" />
                        <span className="text-sm">åŒ…å« {plan.creditsIncluded.toLocaleString()} ç§¯åˆ†</span>
                      </div>
                    )}
                    
                    <Divider />
                    
                    <div className="text-left mb-6">
                      <List
                        size="small"
                        dataSource={plan.features}
                        renderItem={(feature) => (
                          <List.Item className="border-0 px-0 py-1">
                            <CheckCircleOutlined className="text-green-500 mr-2" />
                            <span className="text-sm">{feature}</span>
                          </List.Item>
                        )}
                      />
                    </div>
                    
                    <Button
                      type={plan.isPopular ? 'primary' : isCurrent ? 'default' : 'default'}
                      size="large"
                      block
                      disabled={isCurrent || isDowngrade}
                      loading={selectedPlan === plan.id && subscribeLoading}
                      onClick={() => handleSubscribe(plan.id)}
                      className={
                        plan.isPopular ? 'bg-gradient-to-r from-red-500 to-pink-500 border-0' : 
                        isCurrent ? 'border-blue-400 text-blue-500' : ''
                      }
                    >
                      {isCurrent ? 'å½“å‰å¥—é¤' : 
                       isDowngrade ? 'æ— æ³•é™çº§' :
                       plan.planCode === 'free' ? 'å…è´¹ä½¿ç”¨' : 'ç«‹å³è®¢é˜…'}
                    </Button>
                    
                    {isDowngrade && (
                      <div className="mt-2 text-xs text-gray-500">
                        <CloseCircleOutlined className="mr-1" />
                        ä¸æ”¯æŒé™çº§åˆ°æ›´ä½ç­‰çº§å¥—é¤
                      </div>
                    )}
                  </div>
                </Card>
              </Col>
            );
          })}
        </Row>
        
        <div className="text-center mt-8">
          <Text type="secondary" className="text-sm">
            â€¢ æ”¯æŒéšæ—¶å–æ¶ˆè®¢é˜… â€¢ 30å¤©æ— ç†ç”±é€€æ¬¾ â€¢ ä¸“ä¸šå®¢æœæ”¯æŒ
          </Text>
        </div>
      </div>
    </Modal>
  );
};

export default SubscriptionUpgradeModal;
```

### ç¬¬7-8å¤©: Usage Detailsé¡µé¢å¼€å‘

#### 7.1 Usage Detailsé¡µé¢
```typescript
// pages/UsageDetailsPage.tsx
import React, { useEffect, useState } from 'react';
import { 
  Card, 
  Row, 
  Col, 
  Progress, 
  Statistic, 
  Typography, 
  DatePicker, 
  Table,
  Tag,
  Button,
  Tooltip,
  Space
} from 'antd';
import { 
  ThunderboltOutlined,
  ProjectOutlined,
  CloudOutlined,
  ApiOutlined,
  CalendarOutlined,
  UpgradeOutlined 
} from '@ant-design/icons';
import { useAppSelector, useAppDispatch } from '@/hooks/redux';
import { fetchUsageDetails, fetchCurrentSubscription } from '@/store/subscription/subscriptionSlice';
import { Line } from '@ant-design/plots';
import dayjs from 'dayjs';

const { Title, Text } = Typography;
const { RangePicker } = DatePicker;

const UsageDetailsPage: React.FC = () => {
  const dispatch = useAppDispatch();
  const { usage, currentSubscription, loading } = useAppSelector(state => state.subscription);
  const [dateRange, setDateRange] = useState<[dayjs.Dayjs, dayjs.Dayjs] | null>(null);

  useEffect(() => {
    dispatch(fetchCurrentSubscription());
    dispatch(fetchUsageDetails());
  }, [dispatch]);

  const formatStorageSize = (sizeInMB: number) => {
    if (sizeInMB < 1024) {
      return `${sizeInMB.toFixed(1)} MB`;
    }
    return `${(sizeInMB / 1024).toFixed(1)} GB`;
  };

  const calculateProgress = (used: number, limit: number) => {
    if (limit === -1) return 0; // æ— é™åˆ¶
    return Math.min((used / limit) * 100, 100);
  };

  const getProgressColor = (percent: number) => {
    if (percent < 50) return '#52c41a';
    if (percent < 80) return '#faad14';
    return '#ff4d4f';
  };

  const renderUsageCard = (title: string, used: number | string, limit: number | string, 
                          icon: React.ReactNode, unit: string = '') => {
    const isUnlimited = limit === -1 || limit === 'æ— é™';
    const usedNum = typeof used === 'string' ? 0 : used;
    const limitNum = typeof limit === 'string' ? 0 : limit;
    const percent = isUnlimited ? 0 : calculateProgress(usedNum, limitNum);
    
    return (
      <Card>
        <Statistic
          title={title}
          value={used}
          suffix={unit}
          prefix={icon}
          valueStyle={{ fontSize: '24px' }}
        />
        <div className="mt-4">
          {isUnlimited ? (
            <div className="text-green-500 text-sm">æ— é™åˆ¶ä½¿ç”¨</div>
          ) : (
            <>
              <Progress
                percent={percent}
                strokeColor={getProgressColor(percent)}
                showInfo={false}
              />
              <div className="flex justify-between text-sm text-gray-500 mt-1">
                <span>å·²ä½¿ç”¨ {used}{unit}</span>
                <span>æ€»è®¡ {limit}{unit}</span>
              </div>
            </>
          )}
        </div>
      </Card>
    );
  };

  const getUsageChartData = () => {
    if (!usage?.usageHistory) return [];
    
    return usage.usageHistory.map(item => ({
      date: item.usageDate,
      value: item.creditsConsumed,
      type: 'ç§¯åˆ†æ¶ˆè´¹',
    }));
  };

  const chartConfig = {
    data: getUsageChartData(),
    xField: 'date',
    yField: 'value',
    seriesField: 'type',
    smooth: true,
    point: {
      size: 3,
      shape: 'circle',
    },
    tooltip: {
      formatter: (datum: any) => {
        return {
          name: datum.type,
          value: `${datum.value} ç§¯åˆ†`,
        };
      },
    },
  };

  const historyColumns = [
    {
      title: 'æ—¥æœŸ',
      dataIndex: 'usageDate',
      key: 'usageDate',
      render: (date: string) => dayjs(date).format('YYYY-MM-DD'),
    },
    {
      title: 'AIä»»åŠ¡',
      dataIndex: 'aiTasksCount',
      key: 'aiTasksCount',
      render: (count: number) => `${count} æ¬¡`,
    },
    {
      title: 'ç§¯åˆ†æ¶ˆè´¹',
      dataIndex: 'creditsConsumed',
      key: 'creditsConsumed',
      render: (credits: number) => (
        <span>
          <ThunderboltOutlined className="mr-1 text-blue-500" />
          {credits}
        </span>
      ),
    },
    {
      title: 'é¡¹ç›®åˆ›å»º',
      dataIndex: 'projectsCreated',
      key: 'projectsCreated',
      render: (count: number) => `${count} ä¸ª`,
    },
    {
      title: 'å­˜å‚¨ä½¿ç”¨',
      dataIndex: 'storageUsedMb',
      key: 'storageUsedMb',
      render: (size: number) => formatStorageSize(size),
    },
    {
      title: 'APIè°ƒç”¨',
      dataIndex: 'apiCallsCount',
      key: 'apiCallsCount',
      render: (count: number) => `${count} æ¬¡`,
    },
  ];

  if (!usage || !currentSubscription) {
    return <Card loading />;
  }

  return (
    <div className="max-w-7xl mx-auto p-6">
      <div className="flex justify-between items-center mb-6">
        <div>
          <Title level={2}>Usage Details</Title>
          <Text type="secondary">
            å½“å‰å¥—é¤ï¼š
            <Tag color="blue" className="ml-2">
              {currentSubscription.planName}
            </Tag>
            {currentSubscription.endDate && (
              <span className="ml-2">
                åˆ°æœŸæ—¶é—´ï¼š{dayjs(currentSubscription.endDate).format('YYYY-MM-DD')}
              </span>
            )}
          </Text>
        </div>
        
        <Button type="primary" icon={<UpgradeOutlined />}>
          å‡çº§å¥—é¤
        </Button>
      </div>

      {/* ä½¿ç”¨æ¦‚å†µ */}
      <Row gutter={[24, 24]} className="mb-6">
        <Col xs={24} sm={12} lg={6}>
          {renderUsageCard(
            'é¡¹ç›®æ•°é‡',
            usage.totalProjectsCreated,
            usage.planLimits.maxProjects === -1 ? 'æ— é™' : usage.planLimits.maxProjects,
            <ProjectOutlined className="text-blue-500" />,
            'ä¸ª'
          )}
        </Col>
        
        <Col xs={24} sm={12} lg={6}>
          {renderUsageCard(
            'å­˜å‚¨ä½¿ç”¨',
            (usage.totalStorageUsedMb / 1024).toFixed(1),
            usage.planLimits.maxStorageGb === -1 ? 'æ— é™' : usage.planLimits.maxStorageGb,
            <CloudOutlined className="text-green-500" />,
            'GB'
          )}
        </Col>
        
        <Col xs={24} sm={12} lg={6}>
          {renderUsageCard(
            'ç§¯åˆ†æ¶ˆè´¹',
            usage.totalCreditsConsumed,
            usage.planLimits.creditsIncluded,
            <ThunderboltOutlined className="text-orange-500" />,
            'ç§¯åˆ†'
          )}
        </Col>
        
        <Col xs={24} sm={12} lg={6}>
          {renderUsageCard(
            'AIä»»åŠ¡',
            usage.totalAiTasks,
            'æ— é™',
            <ApiOutlined className="text-purple-500" />,
            'æ¬¡'
          )}
        </Col>
      </Row>

      {/* ä½¿ç”¨è¶‹åŠ¿å›¾ */}
      <Card title="ä½¿ç”¨è¶‹åŠ¿" className="mb-6">
        <div className="mb-4">
          <RangePicker
            value={dateRange}
            onChange={(dates) => setDateRange(dates as [dayjs.Dayjs, dayjs.Dayjs])}
            placeholder={['å¼€å§‹æ—¥æœŸ', 'ç»“æŸæ—¥æœŸ']}
          />
        </div>
        <Line {...chartConfig} height={300} />
      </Card>

      {/* è¯¦ç»†ä½¿ç”¨è®°å½• */}
      <Card
        title="ä½¿ç”¨è¯¦æƒ…"
        extra={
          <Space>
            <CalendarOutlined />
            <Text type="secondary">æœ€è¿‘30å¤©è®°å½•</Text>
          </Space>
        }
      >
        <Table
          dataSource={usage.usageHistory}
          columns={historyColumns}
          pagination={{
            pageSize: 10,
            showSizeChanger: true,
            showQuickJumper: true,
          }}
          rowKey="usageDate"
          loading={loading}
        />
      </Card>

      {/* å¥—é¤å»ºè®® */}
      {currentSubscription.planCode === 'free' && (
        <Card className="mt-6 border-yellow-200 bg-yellow-50">
          <div className="text-center">
            <Title level={4} className="text-yellow-700">
              <CrownOutlined className="mr-2" />
              å‡çº§å¥—é¤ï¼Œè§£é”æ›´å¤šåŠŸèƒ½
            </Title>
            <Text className="text-yellow-600">
              å½“å‰ä½¿ç”¨çš„å…è´¹å¥—é¤åŠŸèƒ½æœ‰é™ï¼Œå‡çº§åˆ°ä»˜è´¹å¥—é¤å¯äº«å—æ›´å¤šç§¯åˆ†ã€å­˜å‚¨ç©ºé—´å’Œé«˜çº§åŠŸèƒ½
            </Text>
            <div className="mt-4">
              <Button type="primary" size="large">
                æŸ¥çœ‹å¥—é¤é€‰é¡¹
              </Button>
            </div>
          </div>
        </Card>
      )}
    </div>
  );
};

export default UsageDetailsPage;
```

### ç¬¬9-10å¤©: æƒé™æ§åˆ¶ç³»ç»Ÿå¼€å‘

#### 9.1 æƒé™æ£€æŸ¥Hook
```typescript
// hooks/useSubscriptionFeatures.ts
import { useEffect, useState } from 'react';
import { useAppSelector, useAppDispatch } from '@/hooks/redux';
import { checkFeature, fetchCurrentSubscription } from '@/store/subscription/subscriptionSlice';

export const useSubscriptionFeatures = () => {
  const dispatch = useAppDispatch();
  const { currentSubscription } = useAppSelector(state => state.subscription);
  
  useEffect(() => {
    if (!currentSubscription) {
      dispatch(fetchCurrentSubscription());
    }
  }, [dispatch, currentSubscription]);

  const hasFeature = async (featureCode: string): Promise<boolean> => {
    try {
      const result = await dispatch(checkFeature(featureCode)).unwrap();
      return result.hasFeature;
    } catch {
      return false;
    }
  };

  const getFeatureValue = async (featureCode: string): Promise<string | null> => {
    try {
      const result = await dispatch(checkFeature(featureCode)).unwrap();
      return result.featureValue || null;
    } catch {
      return null;
    }
  };

  const isPlanActive = (): boolean => {
    return currentSubscription?.status === 'active';
  };

  const isFreePlan = (): boolean => {
    return !currentSubscription || currentSubscription.planCode === 'free';
  };

  const getPlanLevel = (): number => {
    if (!currentSubscription || currentSubscription.planCode === 'free') return 0;
    
    const planLevels = {
      'basic': 1,
      'pro': 2,
      'team': 3,
      'enterprise': 4,
    };
    
    return planLevels[currentSubscription.planCode as keyof typeof planLevels] || 0;
  };

  return {
    currentSubscription,
    hasFeature,
    getFeatureValue,
    isPlanActive,
    isFreePlan,
    getPlanLevel,
  };
};
```

#### 9.2 åŠŸèƒ½æƒé™ç»„ä»¶
```typescript
// components/FeatureGate.tsx
import React from 'react';
import { Button, Card, Typography } from 'antd';
import { CrownOutlined, LockOutlined } from '@ant-design/icons';
import { useSubscriptionFeatures } from '@/hooks/useSubscriptionFeatures';

const { Title, Text } = Typography;

interface FeatureGateProps {
  featureCode: string;
  requiredPlan?: string;
  children: React.ReactNode;
  fallback?: React.ReactNode;
  onUpgradeClick?: () => void;
}

const FeatureGate: React.FC<FeatureGateProps> = ({
  featureCode,
  requiredPlan,
  children,
  fallback,
  onUpgradeClick,
}) => {
  const { hasFeature, currentSubscription } = useSubscriptionFeatures();
  const [hasAccess, setHasAccess] = React.useState<boolean | null>(null);

  React.useEffect(() => {
    const checkAccess = async () => {
      const access = await hasFeature(featureCode);
      setHasAccess(access);
    };
    
    checkAccess();
  }, [featureCode, hasFeature]);

  if (hasAccess === null) {
    // åŠ è½½ä¸­çŠ¶æ€
    return <div>æ£€æŸ¥æƒé™ä¸­...</div>;
  }

  if (hasAccess) {
    return <>{children}</>;
  }

  // æ²¡æœ‰æƒé™æ—¶æ˜¾ç¤ºçš„å†…å®¹
  if (fallback) {
    return <>{fallback}</>;
  }

  // é»˜è®¤çš„å‡çº§æç¤º
  return (
    <Card className="text-center border-orange-200 bg-orange-50">
      <div className="py-8">
        <LockOutlined className="text-4xl text-orange-500 mb-4" />
        <Title level={4} className="text-orange-700">
          æ­¤åŠŸèƒ½éœ€è¦å‡çº§å¥—é¤
        </Title>
        <Text className="text-orange-600 block mb-4">
          å½“å‰ {currentSubscription?.planName || 'Free'} å¥—é¤æ— æ³•ä½¿ç”¨æ­¤åŠŸèƒ½
          {requiredPlan && `, è¯·å‡çº§åˆ° ${requiredPlan} æˆ–æ›´é«˜çº§åˆ«å¥—é¤`}
        </Text>
        <Button
          type="primary"
          size="large"
          icon={<CrownOutlined />}
          onClick={onUpgradeClick}
          className="bg-orange-500 border-orange-500 hover:bg-orange-600"
        >
          ç«‹å³å‡çº§
        </Button>
      </div>
    </Card>
  );
};

export default FeatureGate;
```

#### 9.3 é¡¹ç›®é™åˆ¶æ£€æŸ¥ç¤ºä¾‹
```typescript
// components/ProjectCreationButton.tsx
import React, { useState } from 'react';
import { Button, message } from 'antd';
import { PlusOutlined } from '@ant-design/icons';
import { useSubscriptionFeatures } from '@/hooks/useSubscriptionFeatures';
import SubscriptionUpgradeModal from './SubscriptionUpgradeModal';

const ProjectCreationButton: React.FC = () => {
  const { getFeatureValue, isFreePlan } = useSubscriptionFeatures();
  const [showUpgradeModal, setShowUpgradeModal] = useState(false);
  const [loading, setLoading] = useState(false);

  const handleCreateProject = async () => {
    setLoading(true);
    
    try {
      // æ£€æŸ¥é¡¹ç›®æ•°é‡é™åˆ¶
      const maxProjects = await getFeatureValue('max_projects');
      const currentProjects = await getCurrentProjectCount(); // å‡è®¾è¿™ä¸ªå‡½æ•°å­˜åœ¨
      
      if (maxProjects !== '-1' && currentProjects >= parseInt(maxProjects)) {
        message.warning('å·²è¾¾åˆ°å½“å‰å¥—é¤çš„é¡¹ç›®æ•°é‡ä¸Šé™');
        setShowUpgradeModal(true);
        return;
      }

      // åˆ›å»ºé¡¹ç›®é€»è¾‘
      await createProject();
      message.success('é¡¹ç›®åˆ›å»ºæˆåŠŸ');
      
    } catch (error: any) {
      message.error(error.message || 'åˆ›å»ºé¡¹ç›®å¤±è´¥');
    } finally {
      setLoading(false);
    }
  };

  const getCurrentProjectCount = async (): Promise<number> => {
    // æ¨¡æ‹Ÿè·å–å½“å‰é¡¹ç›®æ•°é‡
    return 3;
  };

  const createProject = async () => {
    // æ¨¡æ‹Ÿåˆ›å»ºé¡¹ç›®
    return new Promise(resolve => setTimeout(resolve, 1000));
  };

  return (
    <>
      <Button
        type="primary"
        icon={<PlusOutlined />}
        onClick={handleCreateProject}
        loading={loading}
      >
        æ–°å»ºé¡¹ç›®
      </Button>
      
      <SubscriptionUpgradeModal
        visible={showUpgradeModal}
        onCancel={() => setShowUpgradeModal(false)}
        onSuccess={() => setShowUpgradeModal(false)}
      />
    </>
  );
};

export default ProjectCreationButton;
```

### ç¬¬11-12å¤©: å¥—é¤åˆ°æœŸæé†’å’Œè‡ªåŠ¨å¤„ç†

#### 11.1 åˆ°æœŸæé†’ç»„ä»¶
```typescript
// components/ExpiryReminderBanner.tsx
import React, { useEffect } from 'react';
import { Alert, Button } from 'antd';
import { ClockCircleOutlined, CrownOutlined } from '@ant-design/icons';
import { useAppSelector, useAppDispatch } from '@/hooks/redux';
import { fetchCurrentSubscription } from '@/store/subscription/subscriptionSlice';
import dayjs from 'dayjs';

const ExpiryReminderBanner: React.FC = () => {
  const dispatch = useAppDispatch();
  const { currentSubscription } = useAppSelector(state => state.subscription);

  useEffect(() => {
    dispatch(fetchCurrentSubscription());
  }, [dispatch]);

  if (!currentSubscription || 
      currentSubscription.planCode === 'free' || 
      !currentSubscription.isExpiring) {
    return null;
  }

  const daysUntilExpiry = currentSubscription.daysUntilExpiry || 0;
  const expiryDate = dayjs(currentSubscription.endDate).format('YYYYå¹´MMæœˆDDæ—¥');

  const getAlertType = () => {
    if (daysUntilExpiry <= 3) return 'error';
    if (daysUntilExpiry <= 7) return 'warning';
    return 'info';
  };

  const getMessage = () => {
    if (daysUntilExpiry <= 0) {
      return `æ‚¨çš„ ${currentSubscription.planName} å¥—é¤å·²è¿‡æœŸï¼Œå·²è‡ªåŠ¨é™çº§ä¸ºå…è´¹å¥—é¤`;
    }
    
    return `æ‚¨çš„ ${currentSubscription.planName} å¥—é¤å°†åœ¨ ${daysUntilExpiry} å¤©åï¼ˆ${expiryDate}ï¼‰åˆ°æœŸ`;
  };

  return (
    <Alert
      type={getAlertType()}
      message={
        <div className="flex items-center justify-between">
          <div className="flex items-center">
            <ClockCircleOutlined className="mr-2" />
            <span>{getMessage()}</span>
          </div>
          
          <div className="flex gap-2">
            <Button
              type="primary"
              size="small"
              icon={<CrownOutlined />}
            >
              ç«‹å³ç»­è´¹
            </Button>
            <Button size="small">
              æŸ¥çœ‹è¯¦æƒ…
            </Button>
          </div>
        </div>
      }
      banner
      closable
      className="mb-4"
    />
  );
};

export default ExpiryReminderBanner;
```

#### 11.2 å®šæ—¶ä»»åŠ¡å¤„ç†è¿‡æœŸè®¢é˜…
```java
// SubscriptionScheduleService.java
@Service
public class SubscriptionScheduleService {
    
    @Autowired
    private UmsMemberSubscriptionsMapper subscriptionsMapper;
    
    @Autowired
    private NotificationService notificationService;
    
    @Scheduled(cron = "0 0 9 * * ?") // æ¯å¤©ä¸Šåˆ9ç‚¹æ‰§è¡Œ
    public void processExpiringAndExpiredSubscriptions() {
        processExpiringSubscriptions();
        processExpiredSubscriptions();
    }
    
    private void processExpiringSubscriptions() {
        // è·å–7å¤©å†…å³å°†åˆ°æœŸçš„è®¢é˜…
        LocalDateTime sevenDaysLater = LocalDateTime.now().plusDays(7);
        List<UmsMemberSubscriptions> expiring = subscriptionsMapper
            .selectExpiringBefore(Timestamp.valueOf(sevenDaysLater));
            
        for (UmsMemberSubscriptions subscription : expiring) {
            int daysUntilExpiry = (int) ChronoUnit.DAYS.between(
                LocalDateTime.now(), 
                subscription.getEndDate().toLocalDateTime()
            );
            
            // å‘é€ä¸åŒç¨‹åº¦çš„æé†’
            if (daysUntilExpiry == 7 || daysUntilExpiry == 3 || daysUntilExpiry == 1) {
                sendExpiryReminder(subscription, daysUntilExpiry);
            }
        }
    }
    
    private void processExpiredSubscriptions() {
        // è·å–å·²è¿‡æœŸä½†çŠ¶æ€ä»ä¸ºç”Ÿæ•ˆçš„è®¢é˜…
        LocalDateTime now = LocalDateTime.now();
        List<UmsMemberSubscriptions> expired = subscriptionsMapper
            .selectExpiredButActive(Timestamp.valueOf(now));
            
        for (UmsMemberSubscriptions subscription : expired) {
            handleExpiredSubscription(subscription);
        }
    }
    
    private void sendExpiryReminder(UmsMemberSubscriptions subscription, int daysLeft) {
        NotificationDTO notification = new NotificationDTO();
        notification.setMemberId(subscription.getMemberId());
        notification.setType(NotificationType.SUBSCRIPTION_EXPIRY_REMINDER);
        notification.setTitle(String.format("å¥—é¤å³å°†åˆ°æœŸæé†’"));
        notification.setContent(String.format(
            "æ‚¨çš„%så¥—é¤å°†åœ¨%då¤©ååˆ°æœŸï¼Œè¯·åŠæ—¶ç»­è´¹ä»¥å…å½±å“ä½¿ç”¨ã€‚",
            getPlanName(subscription.getPlanId()),
            daysLeft
        ));
        
        notificationService.sendNotification(notification);
        
        // å‘é€é‚®ä»¶æé†’
        sendEmailReminder(subscription, daysLeft);
    }
    
    private void handleExpiredSubscription(UmsMemberSubscriptions subscription) {
        // æ›´æ–°è®¢é˜…çŠ¶æ€ä¸ºè¿‡æœŸ
        subscription.setStatus(2);
        subscriptionsMapper.updateByPrimaryKey(subscription);
        
        // å‘é€è¿‡æœŸé€šçŸ¥
        NotificationDTO notification = new NotificationDTO();
        notification.setMemberId(subscription.getMemberId());
        notification.setType(NotificationType.SUBSCRIPTION_EXPIRED);
        notification.setTitle("å¥—é¤å·²è¿‡æœŸ");
        notification.setContent(String.format(
            "æ‚¨çš„%så¥—é¤å·²è¿‡æœŸï¼Œå·²è‡ªåŠ¨é™çº§ä¸ºå…è´¹å¥—é¤ã€‚å¦‚éœ€ç»§ç»­äº«å—é«˜çº§åŠŸèƒ½ï¼Œè¯·é‡æ–°è®¢é˜…ã€‚",
            getPlanName(subscription.getPlanId())
        ));
        
        notificationService.sendNotification(notification);
        
        // è®°å½•æ—¥å¿—
        log.info("Subscription {} for member {} has been expired and downgraded", 
            subscription.getId(), subscription.getMemberId());
    }
}
```

## è´¨é‡ä¿è¯

### åŠŸèƒ½æµ‹è¯•æ¸…å•
- [ ] å¥—é¤å±•ç¤ºæ­£ç¡®
- [ ] å¥—é¤è´­ä¹°æµç¨‹å®Œæ•´
- [ ] æƒé™æ§åˆ¶å‡†ç¡®
- [ ] ä½¿ç”¨ç»Ÿè®¡æ­£ç¡®
- [ ] åˆ°æœŸæé†’åŠæ—¶
- [ ] è‡ªåŠ¨é™çº§å¤„ç†
- [ ] å¥—é¤å‡çº§ç”Ÿæ•ˆ

### æ€§èƒ½æµ‹è¯•
- [ ] å¥—é¤æŸ¥è¯¢å“åº”æ—¶é—´ < 500ms
- [ ] æƒé™æ£€æŸ¥é«˜æ•ˆ
- [ ] ä½¿ç”¨ç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ–
- [ ] å¤§é‡ç”¨æˆ·åˆ°æœŸå¤„ç†ç¨³å®š

### å®‰å…¨æµ‹è¯•
- [ ] å¥—é¤æƒé™éªŒè¯ä¸¥æ ¼
- [ ] æ¶æ„å‡çº§é˜²æŠ¤
- [ ] æ•°æ®ç»Ÿè®¡å‡†ç¡®
- [ ] è®¢é˜…çŠ¶æ€ä¸€è‡´æ€§

## äº¤ä»˜ç‰©

### å‰ç«¯ä»£ç 
- [ ] å¥—é¤çŠ¶æ€ç®¡ç†
- [ ] å¥—é¤å‡çº§å¼¹çª—
- [ ] Usage Detailsé¡µé¢
- [ ] æƒé™æ§åˆ¶ç»„ä»¶
- [ ] åˆ°æœŸæé†’ç»„ä»¶

### åç«¯ä»£ç 
- [ ] å¥—é¤æœåŠ¡å®ç°
- [ ] å¥—é¤APIæ¥å£
- [ ] æƒé™æ£€æŸ¥æœºåˆ¶
- [ ] ä½¿ç”¨ç»Ÿè®¡æ”¶é›†
- [ ] å®šæ—¶ä»»åŠ¡å¤„ç†

### æ•°æ®åº“è®¾è®¡
- [ ] å¥—é¤ç›¸å…³æ•°æ®è¡¨
- [ ] ä½¿ç”¨ç»Ÿè®¡è¡¨
- [ ] æƒé™é…ç½®è¡¨

## éªŒæ”¶æ ‡å‡†

1. **åŠŸèƒ½å®Œæ•´æ€§**: å¥—é¤ç®¡ç†å„åŠŸèƒ½100%å¯ç”¨
2. **æƒé™å‡†ç¡®æ€§**: æƒé™æ§åˆ¶å‡†ç¡®æ— è¯¯
3. **æ•°æ®ä¸€è‡´æ€§**: ä½¿ç”¨ç»Ÿè®¡æ•°æ®å‡†ç¡®
4. **ç”¨æˆ·ä½“éªŒ**: å¥—é¤æ“ä½œæµç•…ï¼Œæç¤ºå‹å¥½
5. **æ€§èƒ½æŒ‡æ ‡**: æŸ¥è¯¢ < 500msï¼Œæƒé™æ£€æŸ¥ < 100ms

## é£é™©æ§åˆ¶

### ä¸šåŠ¡é£é™©
1. **æƒé™ç»•è¿‡**: å®ç°å¤šå±‚æƒé™éªŒè¯
2. **æ•°æ®ä¸ä¸€è‡´**: ä½¿ç”¨äº‹åŠ¡ç¡®ä¿ä¸€è‡´æ€§
3. **æ¶æ„å‡çº§**: å®ç°å‡çº§éªŒè¯æœºåˆ¶

### æŠ€æœ¯é£é™©
1. **å¹¶å‘é—®é¢˜**: ä½¿ç”¨é”æœºåˆ¶å¤„ç†å¹¶å‘è®¢é˜…
2. **æ€§èƒ½é—®é¢˜**: å®ç°æƒé™ç¼“å­˜ä¼˜åŒ–
3. **å®šæ—¶ä»»åŠ¡æ•…éšœ**: å®ç°ä»»åŠ¡ç›‘æ§å’Œé‡è¯•

å®Œæˆæ­¤é˜¶æ®µåï¼Œç”¨æˆ·å°†æ‹¥æœ‰å®Œæ•´çš„å¥—é¤ç®¡ç†ä½“éªŒï¼Œä¸åŒçº§åˆ«ç”¨æˆ·äº«å—å¯¹åº”çš„åŠŸèƒ½æƒé™ï¼Œä¸ºæ•´ä¸ªç³»ç»Ÿçš„å•†ä¸šåŒ–è¿è¥å¥ å®šåŸºç¡€ã€‚