# 03-3: 前端积分状态管理

## 任务概述
**时间**: 第6-7天  
**目标**: 实现前端积分状态管理和API集成  
**优先级**: 最高  
**依赖**: 03-2 积分API控制器开发完成

## 详细任务清单

### 3.1 积分状态切片

#### 3.1.1 积分状态定义
```typescript
// store/credits/creditsSlice.ts
import { createSlice, createAsyncThunk } from '@reduxjs/toolkit';
import { creditsAPI } from '@/api/credits';

interface CreditsBalance {
  totalCredits: number;
  freeCredits: number;
  usedTodayTotal: number;
  lastResetDate: string | null;
}

interface CreditHistory {
  id: number;
  changeType: number;
  creditType: number;
  changeAmount: number;
  balanceAfter: number;
  description: string;
  businessId?: string;
  createdTime: string;
}

interface CreditProduct {
  id: number;
  name: string;
  description: string;
  creditAmount: number;
  price: number;
  originalPrice?: number;
  discountPercentage: number;
  isHot: boolean;
  isRecommended: boolean;
}

interface CreditsState {
  balance: CreditsBalance | null;
  history: CreditHistory[];
  products: CreditProduct[];
  statistics: any;
  loading: boolean;
  error: string | null;
  purchaseLoading: boolean;
  consumeLoading: boolean;
}

const initialState: CreditsState = {
  balance: null,
  history: [],
  products: [],
  statistics: null,
  loading: false,
  error: null,
  purchaseLoading: false,
  consumeLoading: false,
};
```

#### 3.1.2 异步Actions
```typescript
// 获取积分余额
export const fetchCreditsBalance = createAsyncThunk(
  'credits/fetchBalance',
  async () => {
    const response = await creditsAPI.getBalance();
    return response.data;
  }
);

// 获取积分历史
export const fetchCreditsHistory = createAsyncThunk(
  'credits/fetchHistory',
  async (params: { pageNum: number; pageSize: number; changeType?: number; creditType?: number }) => {
    const response = await creditsAPI.getHistory(params);
    return response.data;
  }
);

// 获取积分商品
export const fetchCreditProducts = createAsyncThunk(
  'credits/fetchProducts',
  async () => {
    const response = await creditsAPI.getProducts();
    return response.data;
  }
);

// 购买积分
export const purchaseCredits = createAsyncThunk(
  'credits/purchase',
  async (productId: number) => {
    const response = await creditsAPI.purchaseCredits({ productId });
    return response.data;
  }
);

// 消费积分
export const consumeCredits = createAsyncThunk(
  'credits/consume',
  async (params: { amount: number; businessId: string; description: string }) => {
    const response = await creditsAPI.consumeCredits(params);
    return response.data;
  }
);

// 检查积分余额
export const checkCreditsBalance = createAsyncThunk(
  'credits/checkBalance',
  async (amount: number) => {
    const response = await creditsAPI.checkBalance({ amount });
    return response.data;
  }
);
```

#### 3.1.3 Slice实现
```typescript
const creditsSlice = createSlice({
  name: 'credits',
  initialState,
  reducers: {
    clearError: (state) => {
      state.error = null;
    },
    
    // 实时更新积分余额 (用于WebSocket推送)
    updateBalance: (state, action) => {
      state.balance = action.payload;
    },
    
    // 添加历史记录
    addHistoryRecord: (state, action) => {
      state.history.unshift(action.payload);
    },
    
    // 清空历史记录
    clearHistory: (state) => {
      state.history = [];
    },
  },
  
  extraReducers: (builder) => {
    builder
      // 获取积分余额
      .addCase(fetchCreditsBalance.pending, (state) => {
        state.loading = true;
        state.error = null;
      })
      .addCase(fetchCreditsBalance.fulfilled, (state, action) => {
        state.loading = false;
        state.balance = action.payload;
      })
      .addCase(fetchCreditsBalance.rejected, (state, action) => {
        state.loading = false;
        state.error = action.error.message || '获取积分余额失败';
      })
      
      // 获取积分历史
      .addCase(fetchCreditsHistory.pending, (state) => {
        state.loading = true;
      })
      .addCase(fetchCreditsHistory.fulfilled, (state, action) => {
        state.loading = false;
        state.history = action.payload.list || action.payload;
      })
      .addCase(fetchCreditsHistory.rejected, (state, action) => {
        state.loading = false;
        state.error = action.error.message || '获取积分历史失败';
      })
      
      // 获取积分商品
      .addCase(fetchCreditProducts.fulfilled, (state, action) => {
        state.products = action.payload;
      })
      
      // 购买积分
      .addCase(purchaseCredits.pending, (state) => {
        state.purchaseLoading = true;
        state.error = null;
      })
      .addCase(purchaseCredits.fulfilled, (state, action) => {
        state.purchaseLoading = false;
        // 购买成功后通常会跳转到支付页面
      })
      .addCase(purchaseCredits.rejected, (state, action) => {
        state.purchaseLoading = false;
        state.error = action.error.message || '购买失败';
      })
      
      // 消费积分
      .addCase(consumeCredits.pending, (state) => {
        state.consumeLoading = true;
        state.error = null;
      })
      .addCase(consumeCredits.fulfilled, (state, action) => {
        state.consumeLoading = false;
        // 更新余额信息
        if (action.payload.totalCredits !== undefined) {
          state.balance = {
            ...state.balance!,
            totalCredits: action.payload.totalCredits,
            freeCredits: action.payload.freeCredits,
          };
        }
      })
      .addCase(consumeCredits.rejected, (state, action) => {
        state.consumeLoading = false;
        state.error = action.error.message || '积分消费失败';
      });
  },
});

export const { 
  clearError, 
  updateBalance, 
  addHistoryRecord, 
  clearHistory 
} = creditsSlice.actions;

export default creditsSlice.reducer;
```

**验收标准**:
- [x] 状态结构合理完整
- [x] 异步操作正确处理
- [x] 错误处理机制完善
- [x] 状态更新逻辑正确

### 3.2 RTK Query API集成

#### 3.2.1 积分API定义
```typescript
// api/creditsApi.ts
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react';
import type { RootState } from '@/store';

export const creditsApi = createApi({
  reducerPath: 'creditsApi',
  baseQuery: fetchBaseQuery({
    baseUrl: '/api/credits',
    prepareHeaders: (headers, { getState }) => {
      const state = getState() as RootState;
      const token = state.auth.token;
      
      if (token) {
        headers.set('authorization', `Bearer ${token}`);
      }
      
      return headers;
    },
  }),
  tagTypes: ['Credits', 'CreditHistory', 'CreditProducts'],
  
  endpoints: (builder) => ({
    // 获取积分余额
    getCreditsBalance: builder.query<CreditsBalance, void>({
      query: () => '/balance',
      providesTags: ['Credits'],
    }),
    
    // 获取积分历史
    getCreditsHistory: builder.query<any, {
      pageNum?: number;
      pageSize?: number;
      changeType?: number;
      creditType?: number;
    }>({
      query: (params) => ({
        url: '/history',
        params,
      }),
      providesTags: ['CreditHistory'],
    }),
    
    // 获取积分商品
    getCreditProducts: builder.query<CreditProduct[], void>({
      query: () => '/products',
      providesTags: ['CreditProducts'],
    }),
    
    // 消费积分
    consumeCredits: builder.mutation<any, {
      amount: number;
      businessId: string;
      description: string;
    }>({
      query: (data) => ({
        url: '/consume',
        method: 'POST',
        body: data,
      }),
      invalidatesTags: ['Credits', 'CreditHistory'],
    }),
    
    // 检查余额
    checkCreditsBalance: builder.query<{
      sufficient: boolean;
      available: number;
      required: number;
      shortage: number;
    }, number>({
      query: (amount) => ({
        url: '/check-balance',
        method: 'POST',
        body: { amount },
      }),
    }),
    
    // 购买积分
    purchaseCredits: builder.mutation<any, { productId: number }>({
      query: (data) => ({
        url: '/purchase',
        method: 'POST',
        body: data,
      }),
    }),
  }),
});

export const {
  useGetCreditsBalanceQuery,
  useGetCreditsHistoryQuery,
  useGetCreditProductsQuery,
  useConsumeCreditsMutation,
  useCheckCreditsBalanceQuery,
  usePurchaseCreditsMutation,
} = creditsApi;
```

**验收标准**:
- [x] RTK Query API定义完整
- [x] 自动缓存和失效机制
- [x] 类型安全的API调用
- [x] 错误处理和重试机制

### 3.3 自定义Hooks

#### 3.3.1 积分管理Hook
```typescript
// hooks/useCredits.ts
import { useAppSelector, useAppDispatch } from './redux';
import { 
  fetchCreditsBalance,
  consumeCredits,
  clearError 
} from '@/store/credits/creditsSlice';
import { useGetCreditsBalanceQuery } from '@/api/creditsApi';

export const useCredits = () => {
  const dispatch = useAppDispatch();
  const credits = useAppSelector(state => state.credits);
  
  // 使用RTK Query获取实时数据
  const { 
    data: balance, 
    isLoading, 
    error,
    refetch 
  } = useGetCreditsBalanceQuery();

  const refreshBalance = () => {
    refetch();
  };

  const clearCreditsError = () => {
    dispatch(clearError());
  };

  // 计算总可用积分
  const totalAvailable = balance 
    ? balance.totalCredits + balance.freeCredits 
    : 0;

  return {
    balance: balance || credits.balance,
    totalAvailable,
    isLoading: isLoading || credits.loading,
    error: error || credits.error,
    refreshBalance,
    clearCreditsError,
  };
};
```

#### 3.3.2 积分消费Hook
```typescript
// hooks/useCreditsConsume.ts
import { useState } from 'react';
import { message } from 'antd';
import { useAppDispatch } from './redux';
import { consumeCredits, fetchCreditsBalance } from '@/store/credits/creditsSlice';
import { useConsumeCreditsMutation } from '@/api/creditsApi';

export const useCreditsConsume = () => {
  const dispatch = useAppDispatch();
  const [consuming, setConsuming] = useState(false);
  const [consumeCredits, { isLoading }] = useConsumeCreditsMutation();

  const consume = async (
    amount: number, 
    businessId: string, 
    description: string
  ): Promise<boolean> => {
    try {
      setConsuming(true);
      
      const result = await consumeCredits({
        amount,
        businessId,
        description
      }).unwrap();
      
      message.success(`消费 ${amount} 积分成功`);
      
      // 刷新余额
      dispatch(fetchCreditsBalance());
      
      return true;
      
    } catch (error: any) {
      const errorMessage = error.data?.message || error.message || '积分消费失败';
      
      if (errorMessage.includes('积分不足')) {
        message.error('积分不足，请购买积分或等待每日免费积分重置');
      } else {
        message.error(errorMessage);
      }
      
      return false;
      
    } finally {
      setConsuming(false);
    }
  };

  return {
    consume,
    consuming: consuming || isLoading,
  };
};
```

#### 3.3.3 积分检查Hook
```typescript
// hooks/useCreditsCheck.ts
import { useMemo } from 'react';
import { useCredits } from './useCredits';

export const useCreditsCheck = (requiredAmount: number) => {
  const { balance, totalAvailable } = useCredits();
  
  const checkResult = useMemo(() => {
    const sufficient = totalAvailable >= requiredAmount;
    const shortage = sufficient ? 0 : requiredAmount - totalAvailable;
    
    return {
      sufficient,
      available: totalAvailable,
      required: requiredAmount,
      shortage,
      // 积分使用策略
      usage: calculateUsageStrategy(balance, requiredAmount),
    };
  }, [balance, totalAvailable, requiredAmount]);
  
  return checkResult;
};

function calculateUsageStrategy(
  balance: any, 
  requiredAmount: number
): { freeCredits: number; permanentCredits: number } {
  if (!balance) {
    return { freeCredits: 0, permanentCredits: 0 };
  }
  
  const freeAvailable = balance.freeCredits;
  const permanentAvailable = balance.totalCredits;
  
  // 优先使用免费积分
  const freeToUse = Math.min(freeAvailable, requiredAmount);
  const permanentToUse = Math.max(0, requiredAmount - freeToUse);
  
  return {
    freeCredits: freeToUse,
    permanentCredits: permanentToUse,
  };
}
```

**验收标准**:
- [x] 自定义Hooks功能完整
- [x] 状态管理逻辑正确
- [x] 错误处理友好
- [x] 性能优化合理

## 交付物
- [x] 积分Redux状态切片
- [x] RTK Query API集成
- [x] 积分相关自定义Hooks
- [x] 类型定义和接口

## 验证测试
1. 测试积分状态管理
2. 验证API自动缓存
3. 测试积分消费流程
4. 检查错误处理机制
5. 验证实时状态更新

## 风险控制
- **状态同步**: 确保前后端状态同步
- **缓存策略**: 合理的缓存失效机制
- **错误处理**: 完善的错误处理和用户提示

## 下一步
完成后进入 `03-4-积分界面组件开发`