# 03-4: 积分界面组件开发

## 任务概述
**时间**: 第8-9天  
**目标**: 开发积分相关的用户界面组件  
**优先级**: 最高  
**依赖**: 03-3 前端积分状态管理完成

## 详细任务清单

### 4.1 积分余额显示组件

#### 4.1.1 Header中的积分显示组件
```typescript
// components/credits/CreditsDisplay.tsx
import React, { useState } from 'react';
import { Badge, Dropdown, Spin, Button, Tooltip } from 'antd';
import { ThunderboltOutlined, PlusOutlined, HistoryOutlined } from '@ant-design/icons';
import { useCredits } from '@/hooks/useCredits';
import { useNavigate } from 'react-router-dom';
import { useTranslation } from 'react-i18next';

const CreditsDisplay: React.FC = () => {
  const navigate = useNavigate();
  const { t } = useTranslation('credits');
  const { balance, totalAvailable, isLoading } = useCredits();
  const [dropdownVisible, setDropdownVisible] = useState(false);

  const formatNumber = (num: number): string => {
    if (num >= 1000) {
      return (num / 1000).toFixed(1) + 'k';
    }
    return num.toString();
  };

  const handlePurchaseClick = () => {
    setDropdownVisible(false);
    navigate('/credits/purchase');
  };

  const handleHistoryClick = () => {
    setDropdownVisible(false);
    navigate('/credits/history');
  };

  const dropdownItems = [
    {
      key: 'balance',
      label: (
        <div className="px-4 py-3 min-w-[300px]">
          <div className="flex justify-between items-center mb-4">
            <span className="font-semibold text-lg">积分余额</span>
            <Button 
              size="small" 
              type="primary"
              onClick={handlePurchaseClick}
            >
              购买积分
            </Button>
          </div>
          
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <ThunderboltOutlined className="text-blue-500" />
                <div>
                  <div className="font-medium">永久积分</div>
                  <div className="text-xs text-gray-500">永久有效</div>
                </div>
              </div>
              <div className="font-semibold text-lg">
                {balance ? formatNumber(balance.totalCredits) : '0'}
                <Button 
                  type="link" 
                  size="small" 
                  className="p-0 ml-2"
                  onClick={handlePurchaseClick}
                >
                  <PlusOutlined />
                </Button>
              </div>
            </div>
            
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <Badge color="green" />
                <div>
                  <div className="font-medium">免费积分</div>
                  <div className="text-xs text-gray-500">每天重置为200积分</div>
                </div>
              </div>
              <div className="font-semibold text-lg">
                {balance ? balance.freeCredits : '200'}
              </div>
            </div>
          </div>
          
          <div className="mt-4 pt-3 border-t border-gray-100">
            <Button 
              type="link" 
              size="small" 
              className="p-0 text-gray-600 hover:text-blue-500"
              onClick={handleHistoryClick}
            >
              <HistoryOutlined className="mr-1" />
              查看详情 &gt;
            </Button>
          </div>
        </div>
      ),
    }
  ];

  return (
    <Dropdown
      menu={{ items: dropdownItems }}
      trigger={['hover']}
      open={dropdownVisible}
      onOpenChange={setDropdownVisible}
      placement="bottomRight"
    >
      <Button 
        type="text" 
        className="flex items-center gap-2 px-3 py-1 rounded-lg bg-gradient-to-r from-blue-500 to-purple-600 text-white hover:from-blue-600 hover:to-purple-700"
      >
        <ThunderboltOutlined />
        {isLoading ? (
          <Spin size="small" className="text-white" />
        ) : (
          <span className="font-semibold">
            {formatNumber(totalAvailable)}
          </span>
        )}
      </Button>
    </Dropdown>
  );
};

export default CreditsDisplay;
```

#### 4.1.2 积分概览卡片组件
```typescript
// components/credits/CreditsOverviewCard.tsx
import React from 'react';
import { Card, Row, Col, Statistic, Progress, Button, Tooltip } from 'antd';
import { 
  ThunderboltOutlined, 
  GiftOutlined, 
  ShoppingCartOutlined,
  TrophyOutlined
} from '@ant-design/icons';
import { useCredits } from '@/hooks/useCredits';
import { useNavigate } from 'react-router-dom';

const CreditsOverviewCard: React.FC = () => {
  const navigate = useNavigate();
  const { balance, totalAvailable, isLoading } = useCredits();

  if (isLoading || !balance) {
    return <Card loading className="mb-6" />;
  }

  const usagePercent = balance.usedTodayTotal > 0 ? 
    Math.round((balance.usedTodayTotal / (balance.usedTodayTotal + totalAvailable)) * 100) : 0;

  return (
    <Card 
      title="积分概况" 
      className="mb-6"
      extra={
        <Button type="primary" onClick={() => navigate('/credits/purchase')}>
          购买积分
        </Button>
      }
    >
      <Row gutter={24}>
        <Col xs={24} sm={12} lg={6}>
          <Statistic
            title="可用积分"
            value={totalAvailable}
            prefix={<ThunderboltOutlined className="text-blue-500" />}
            valueStyle={{ color: '#1890ff' }}
          />
        </Col>
        
        <Col xs={24} sm={12} lg={6}>
          <Statistic
            title="永久积分"
            value={balance.totalCredits}
            prefix={<TrophyOutlined className="text-yellow-500" />}
            valueStyle={{ color: '#faad14' }}
            suffix={
              <Tooltip title="点击购买更多积分">
                <Button 
                  type="link" 
                  size="small" 
                  icon={<ShoppingCartOutlined />}
                  onClick={() => navigate('/credits/purchase')}
                />
              </Tooltip>
            }
          />
        </Col>
        
        <Col xs={24} sm={12} lg={6}>
          <Statistic
            title="免费积分"
            value={balance.freeCredits}
            prefix={<GiftOutlined className="text-green-500" />}
            valueStyle={{ color: '#52c41a' }}
            suffix="/ 200"
          />
        </Col>
        
        <Col xs={24} sm={12} lg={6}>
          <Statistic
            title="今日已用"
            value={balance.usedTodayTotal}
            valueStyle={{ color: '#8c8c8c' }}
          />
          <Progress
            percent={usagePercent}
            size="small"
            showInfo={false}
            strokeColor="#1890ff"
            className="mt-2"
          />
        </Col>
      </Row>
      
      <div className="mt-4 pt-4 border-t border-gray-100">
        <Row gutter={16}>
          <Col>
            <Button onClick={() => navigate('/credits/history')}>
              使用记录
            </Button>
          </Col>
          <Col>
            <Button onClick={() => navigate('/credits/statistics')}>
              统计分析
            </Button>
          </Col>
        </Row>
      </div>
    </Card>
  );
};

export default CreditsOverviewCard;
```

**验收标准**:
- [x] 积分显示准确无误
- [x] 交互逻辑流畅
- [x] 响应式设计适配
- [x] 样式美观符合设计

### 4.2 积分购买页面

#### 4.2.1 积分购买页面组件
```typescript
// pages/credits/CreditsPurchasePage.tsx
import React, { useState } from 'react';
import { 
  Card, 
  Row, 
  Col, 
  Button, 
  Badge, 
  Typography, 
  message,
  Modal 
} from 'antd';
import { 
  ThunderboltOutlined, 
  FireOutlined, 
  CrownOutlined,
  CheckCircleOutlined 
} from '@ant-design/icons';
import { useGetCreditProductsQuery, usePurchaseCreditsMutation } from '@/api/creditsApi';
import { useNavigate } from 'react-router-dom';
import PaymentModal from '@/components/payment/PaymentModal';

const { Title, Text } = Typography;

const CreditsPurchasePage: React.FC = () => {
  const navigate = useNavigate();
  const { data: products = [], isLoading } = useGetCreditProductsQuery();
  const [purchaseCredits, { isLoading: purchaseLoading }] = usePurchaseCreditsMutation();
  
  const [selectedProduct, setSelectedProduct] = useState<number | null>(null);
  const [paymentModalVisible, setPaymentModalVisible] = useState(false);
  const [currentOrder, setCurrentOrder] = useState<any>(null);

  const handlePurchase = async (productId: number) => {
    try {
      setSelectedProduct(productId);
      const result = await purchaseCredits({ productId }).unwrap();
      
      // 显示支付弹窗
      setCurrentOrder(result);
      setPaymentModalVisible(true);
      
    } catch (error: any) {
      message.error(error.data?.message || '创建订单失败');
    } finally {
      setSelectedProduct(null);
    }
  };

  const handlePaymentSuccess = () => {
    setPaymentModalVisible(false);
    setCurrentOrder(null);
    message.success('购买成功！积分已到账');
    navigate('/credits');
  };

  const formatPrice = (price: number) => {
    return `¥${price.toFixed(2)}`;
  };

  const getProductIcon = (product: any) => {
    if (product.isHot) return <FireOutlined className="text-red-500" />;
    if (product.isRecommended) return <CrownOutlined className="text-yellow-500" />;
    return <ThunderboltOutlined className="text-blue-500" />;
  };

  const getProductBadge = (product: any) => {
    if (product.isHot) return <Badge.Ribbon text="热门" color="red" />;
    if (product.isRecommended) return <Badge.Ribbon text="推荐" color="gold" />;
    return null;
  };

  if (isLoading) {
    return <div className="max-w-7xl mx-auto p-6"><Card loading /></div>;
  }

  return (
    <div className="max-w-7xl mx-auto p-6">
      <div className="text-center mb-8">
        <Title level={2}>购买积分</Title>
        <Text type="secondary" className="text-lg">
          选择适合你的积分套餐，开启无限创意之旅
        </Text>
      </div>

      <Row gutter={[24, 24]} justify="center">
        {products.map((product) => (
          <Col key={product.id} xs={24} sm={12} lg={8} xl={6}>
            {getProductBadge(product)}
            <Card
              className={`h-full transition-all duration-300 hover:shadow-xl hover:-translate-y-1 ${
                product.isRecommended ? 'border-yellow-400 shadow-lg' : ''
              }`}
              bodyStyle={{ padding: '24px' }}
            >
              <div className="text-center">
                <div className="text-5xl mb-4">
                  {getProductIcon(product)}
                </div>
                
                <Title level={4} className="mb-2">
                  {product.name}
                </Title>
                
                <Text type="secondary" className="block mb-4">
                  {product.description}
                </Text>
                
                <div className="mb-4">
                  <div className="text-3xl font-bold text-blue-500 mb-1">
                    <ThunderboltOutlined className="mr-1" />
                    {product.creditAmount.toLocaleString()}
                  </div>
                  <Text type="secondary">积分</Text>
                </div>
                
                <div className="mb-6">
                  <div className="text-2xl font-bold text-red-500">
                    {formatPrice(product.price)}
                  </div>
                  {product.originalPrice && product.originalPrice > product.price && (
                    <div className="text-sm text-gray-400">
                      <span className="line-through mr-2">
                        {formatPrice(product.originalPrice)}
                      </span>
                      <span className="text-green-500">
                        省{(product.originalPrice - product.price).toFixed(2)}元
                      </span>
                    </div>
                  )}
                  {product.discountPercentage < 100 && (
                    <div className="text-sm text-orange-500 mt-1">
                      限时{product.discountPercentage / 10}折优惠
                    </div>
                  )}
                </div>
                
                <div className="mb-4 text-left">
                  <div className="flex items-center mb-2">
                    <CheckCircleOutlined className="text-green-500 mr-2" />
                    <span className="text-sm">立即到账</span>
                  </div>
                  <div className="flex items-center mb-2">
                    <CheckCircleOutlined className="text-green-500 mr-2" />
                    <span className="text-sm">永不过期</span>
                  </div>
                  <div className="flex items-center">
                    <CheckCircleOutlined className="text-green-500 mr-2" />
                    <span className="text-sm">7天退款保障</span>
                  </div>
                </div>
                
                <Button
                  type={product.isRecommended ? 'primary' : 'default'}
                  size="large"
                  block
                  loading={selectedProduct === product.id && purchaseLoading}
                  onClick={() => handlePurchase(product.id)}
                  className={product.isRecommended ? 'bg-gradient-to-r from-blue-500 to-purple-600 border-none' : ''}
                >
                  立即购买
                </Button>
              </div>
            </Card>
          </Col>
        ))}
      </Row>
      
      <div className="text-center mt-8">
        <Text type="secondary">
          购买后积分将立即到账，如有问题请联系客服
        </Text>
      </div>

      <PaymentModal
        visible={paymentModalVisible}
        order={currentOrder}
        onSuccess={handlePaymentSuccess}
        onCancel={() => setPaymentModalVisible(false)}
      />
    </div>
  );
};

export default CreditsPurchasePage;
```

**验收标准**:
- [x] 商品展示美观清晰
- [x] 购买流程顺畅
- [x] 价格和折扣正确显示
- [x] 响应式布局适配

### 4.3 积分历史记录页面

#### 4.3.1 积分历史页面组件
```typescript
// pages/credits/CreditsHistoryPage.tsx
import React, { useState } from 'react';
import { 
  Card, 
  Table, 
  Tag, 
  Typography, 
  DatePicker, 
  Select, 
  Row, 
  Col,
  Button,
  Space
} from 'antd';
import { 
  ThunderboltOutlined,
  PlusOutlined, 
  MinusOutlined,
  ReloadOutlined,
  GiftOutlined 
} from '@ant-design/icons';
import { useGetCreditsHistoryQuery } from '@/api/creditsApi';
import { CreditsOverviewCard } from '@/components/credits';
import dayjs from 'dayjs';

const { Title } = Typography;
const { RangePicker } = DatePicker;
const { Option } = Select;

const CreditsHistoryPage: React.FC = () => {
  const [filters, setFilters] = useState({
    pageNum: 1,
    pageSize: 20,
    changeType: undefined as number | undefined,
    creditType: undefined as number | undefined,
  });

  const { data, isLoading, refetch } = useGetCreditsHistoryQuery(filters);

  const getChangeTypeTag = (changeType: number) => {
    const typeMap = {
      0: { text: '获得积分', color: 'green', icon: <PlusOutlined /> },
      1: { text: '消费积分', color: 'red', icon: <MinusOutlined /> },
      2: { text: '每日重置', color: 'blue', icon: <ReloadOutlined /> },
      3: { text: '系统赠送', color: 'purple', icon: <GiftOutlined /> },
    };
    
    const config = typeMap[changeType as keyof typeof typeMap] || { 
      text: '其他', color: 'default', icon: null 
    };
    
    return (
      <Tag color={config.color} icon={config.icon}>
        {config.text}
      </Tag>
    );
  };

  const getCreditTypeTag = (creditType: number) => {
    return creditType === 1 ? (
      <Tag color="orange">免费积分</Tag>
    ) : (
      <Tag color="blue">永久积分</Tag>
    );
  };

  const formatAmount = (amount: number, changeType: number) => {
    const isPositive = amount > 0;
    const displayAmount = Math.abs(amount);
    
    return (
      <span className={isPositive ? 'text-green-600' : 'text-red-600'}>
        {isPositive ? '+' : '-'}
        <ThunderboltOutlined className="mr-1" />
        {displayAmount.toLocaleString()}
      </span>
    );
  };

  const columns = [
    {
      title: '时间',
      dataIndex: 'createdTime',
      key: 'createdTime',
      width: 180,
      render: (text: string) => dayjs(text).format('MM-DD HH:mm:ss'),
    },
    {
      title: '类型',
      dataIndex: 'changeType',
      key: 'changeType',
      width: 100,
      render: (changeType: number) => getChangeTypeTag(changeType),
    },
    {
      title: '积分类型',
      dataIndex: 'creditType',
      key: 'creditType',
      width: 100,
      render: (creditType: number) => getCreditTypeTag(creditType),
    },
    {
      title: '变动数量',
      dataIndex: 'changeAmount',
      key: 'changeAmount',
      width: 120,
      render: (amount: number, record: any) => formatAmount(amount, record.changeType),
    },
    {
      title: '描述',
      dataIndex: 'description',
      key: 'description',
      ellipsis: true,
      render: (text: string) => text || '-',
    },
    {
      title: '业务ID',
      dataIndex: 'businessId',
      key: 'businessId',
      width: 120,
      render: (text: string) => text || '-',
    },
  ];

  const handleTableChange = (pagination: any, filters: any) => {
    setFilters({
      ...filters,
      pageNum: pagination.current,
      pageSize: pagination.pageSize,
    });
  };

  const handleFilterChange = (field: string, value: any) => {
    setFilters({
      ...filters,
      [field]: value,
      pageNum: 1, // 重置到第一页
    });
  };

  const handleReset = () => {
    setFilters({
      pageNum: 1,
      pageSize: 20,
      changeType: undefined,
      creditType: undefined,
    });
  };

  return (
    <div className="max-w-7xl mx-auto p-6">
      <Title level={2} className="mb-6">积分管理</Title>
      
      <CreditsOverviewCard />
      
      <Card title="积分使用记录">
        <Row gutter={16} className="mb-4">
          <Col xs={24} sm={8} md={4}>
            <Select
              placeholder="变动类型"
              value={filters.changeType}
              onChange={(value) => handleFilterChange('changeType', value)}
              className="w-full"
              allowClear
            >
              <Option value={0}>获得积分</Option>
              <Option value={1}>消费积分</Option>
              <Option value={2}>每日重置</Option>
              <Option value={3}>系统赠送</Option>
            </Select>
          </Col>
          <Col xs={24} sm={8} md={4}>
            <Select
              placeholder="积分类型"
              value={filters.creditType}
              onChange={(value) => handleFilterChange('creditType', value)}
              className="w-full"
              allowClear
            >
              <Option value={1}>免费积分</Option>
              <Option value={2}>永久积分</Option>
            </Select>
          </Col>
          <Col xs={24} sm={8} md={4}>
            <Space>
              <Button onClick={() => refetch()}>刷新</Button>
              <Button onClick={handleReset}>重置</Button>
            </Space>
          </Col>
        </Row>

        <Table
          dataSource={data?.list || []}
          columns={columns}
          loading={isLoading}
          pagination={{
            current: filters.pageNum,
            pageSize: filters.pageSize,
            total: data?.total || 0,
            showSizeChanger: true,
            showQuickJumper: true,
            showTotal: (total, range) => 
              `第 ${range[0]}-${range[1]} 条/共 ${total} 条`,
          }}
          onChange={handleTableChange}
          rowKey="id"
        />
      </Card>
    </div>
  );
};

export default CreditsHistoryPage;
```

**验收标准**:
- [x] 历史记录显示完整
- [x] 筛选功能正常工作
- [x] 分页功能正确
- [x] 数据格式化美观

### 4.4 积分不足提示组件

#### 4.4.1 积分不足模态框
```typescript
// components/credits/InsufficientCreditsModal.tsx
import React from 'react';
import { Modal, Button, Card, Row, Col, Typography, Progress } from 'antd';
import { ThunderboltOutlined, ShoppingCartOutlined, GiftOutlined } from '@ant-design/icons';
import { useNavigate } from 'react-router-dom';
import { useCredits } from '@/hooks/useCredits';

const { Title, Text } = Typography;

interface InsufficientCreditsModalProps {
  visible: boolean;
  requiredCredits: number;
  onCancel: () => void;
  onPurchase?: () => void;
}

const InsufficientCreditsModal: React.FC<InsufficientCreditsModalProps> = ({
  visible,
  requiredCredits,
  onCancel,
  onPurchase,
}) => {
  const navigate = useNavigate();
  const { balance, totalAvailable } = useCredits();

  const handlePurchase = () => {
    onCancel();
    if (onPurchase) {
      onPurchase();
    } else {
      navigate('/credits/purchase');
    }
  };

  const shortage = Math.max(0, requiredCredits - totalAvailable);
  const nextResetHours = 24 - new Date().getHours();

  return (
    <Modal
      title="积分不足"
      open={visible}
      onCancel={onCancel}
      footer={null}
      width={500}
      centered
    >
      <div className="text-center py-4">
        <div className="text-6xl mb-4">
          <ThunderboltOutlined className="text-red-500" />
        </div>
        
        <Title level={4} className="mb-2">
          积分余额不足
        </Title>
        
        <Text type="secondary" className="block mb-6">
          完成此操作需要更多积分
        </Text>
        
        <Card className="mb-6">
          <Row gutter={16}>
            <Col span={8}>
              <div className="text-center">
                <div className="text-lg font-bold text-red-500">
                  {requiredCredits}
                </div>
                <div className="text-sm text-gray-500">需要积分</div>
              </div>
            </Col>
            <Col span={8}>
              <div className="text-center">
                <div className="text-lg font-bold text-blue-500">
                  {totalAvailable}
                </div>
                <div className="text-sm text-gray-500">当前积分</div>
              </div>
            </Col>
            <Col span={8}>
              <div className="text-center">
                <div className="text-lg font-bold text-orange-500">
                  {shortage}
                </div>
                <div className="text-sm text-gray-500">缺少积分</div>
              </div>
            </Col>
          </Row>
        </Card>
        
        {balance && (
          <Card className="mb-6 text-left">
            <div className="mb-3">
              <div className="flex justify-between items-center">
                <span>免费积分</span>
                <span>{balance.freeCredits}/200</span>
              </div>
              <Progress 
                percent={(balance.freeCredits / 200) * 100} 
                size="small" 
                strokeColor="#52c41a"
                showInfo={false}
              />
            </div>
            <div>
              <div className="flex justify-between items-center">
                <span>永久积分</span>
                <span>{balance.totalCredits}</span>
              </div>
            </div>
          </Card>
        )}
        
        <div className="space-y-3">
          <Button
            type="primary"
            size="large"
            block
            icon={<ShoppingCartOutlined />}
            onClick={handlePurchase}
          >
            立即购买积分
          </Button>
          
          <Button size="large" block onClick={onCancel}>
            取消操作
          </Button>
        </div>
        
        <div className="mt-4 p-3 bg-blue-50 rounded-lg">
          <div className="flex items-center justify-center gap-2">
            <GiftOutlined className="text-blue-500" />
            <Text className="text-sm text-blue-600">
              {nextResetHours}小时后将重置200免费积分
            </Text>
          </div>
        </div>
      </div>
    </Modal>
  );
};

export default InsufficientCreditsModal;
```

**验收标准**:
- [x] 积分不足提示清晰
- [x] 购买引导流畅
- [x] 数据展示准确
- [x] 用户体验友好

## 交付物
- [x] 积分余额显示组件
- [x] 积分购买页面
- [x] 积分历史记录页面
- [x] 积分不足提示组件
- [x] 相关样式和动画

## 验证测试
1. 测试积分显示准确性
2. 验证购买流程完整性
3. 检查历史记录功能
4. 测试响应式布局
5. 验证用户交互体验

## 风险控制
- **数据同步**: 确保前端显示与后端数据同步
- **用户体验**: 提供清晰的操作引导
- **性能优化**: 避免不必要的重新渲染

## 下一步
完成后进入 `03-5-积分系统集成测试`