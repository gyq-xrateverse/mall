# 03-1-2: 积分核心服务实现

## 任务概述
**时间估算**: 30-45分钟  
**优先级**: 最高  
**依赖关系**: 需要完成数据库表结构扩展(03-1-1)  
**技术栈**: Java/Spring Boot, MyBatis  
**复杂度**: 中等

## 详细任务清单

### 1. 积分服务接口定义
- [ ] 创建CreditsService接口
- [ ] 定义getMemberCredits方法
- [ ] 定义consumeCredits方法
- [ ] 定义addCredits方法
- [ ] 定义resetDailyCredits方法
- [ ] 定义getCreditsHistory方法

### 2. 积分服务实现
- [ ] 创建CreditsServiceImpl类
- [ ] 实现双积分体系逻辑
- [ ] 实现优先使用免费积分的策略
- [ ] 实现每日积分重置机制
- [ ] 实现积分历史记录功能
- [ ] 添加事务管理和异常处理

### 3. 核心业务逻辑
- [ ] 实现积分余额查询逻辑
- [ ] 实现积分消费验证逻辑
- [ ] 实现积分变动记录逻辑
- [ ] 实现每日重置检查逻辑
- [ ] 实现并发安全控制

### 4. 数据访问层扩展
- [ ] 扩展UmsMemberMapper接口
- [ ] 扩展UmsIntegrationChangeHistoryMapper接口
- [ ] 添加selectMembersForDailyReset方法
- [ ] 添加积分相关的查询方法

## 验收标准

### 功能验收
- [ ] 积分服务接口定义完整，方法签名正确
- [ ] 双积分体系逻辑实现正确(优先消费免费积分)
- [ ] 每日重置机制正常工作
- [ ] 积分消费和增加功能正确
- [ ] 历史记录记录准确

### 质量验收  
- [ ] 代码遵循Spring Boot最佳实践
- [ ] 事务管理正确配置
- [ ] 异常处理完善
- [ ] 日志记录合理
- [ ] 并发安全控制到位

### 性能验收
- [ ] 积分查询响应时间 < 100ms
- [ ] 积分消费操作响应时间 < 200ms
- [ ] 支持适当的并发操作

## 交付物
- [ ] CreditsService.java接口文件
- [ ] CreditsServiceImpl.java实现文件  
- [ ] MemberCreditsVO.java数据传输对象
- [ ] 相关Mapper方法扩展
- [ ] 单元测试用例

## 技术要点

### 双积分体系设计
- 免费积分(每日200): 优先消费，每日重置
- 永久积分: 付费购买，永久有效
- 消费顺序: 免费积分 -> 永久积分

### 数据一致性保证
- 使用@Transactional确保操作原子性
- 数据库乐观锁防止并发问题
- 积分变动历史完整记录

### 每日重置机制
- 定时任务每日0点执行批量重置
- 用户操作时检查并按需重置
- 重置操作记录历史日志

## 下一步
完成后进入 `03-1-3-积分商品初始化` 任务

## 注意事项
1. 必须确保积分消费操作的原子性
2. 注意处理边界情况(如积分为0、负数等)
3. 记录详细的操作日志用于问题排查
4. 考虑高并发场景下的数据安全性
5. 所有金额和积分相关计算使用精确数值类型