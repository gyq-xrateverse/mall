# 03-1: 积分数据库设计和后端服务

## 任务概述
**时间**: 第1-3天  
**目标**: 基于现有mall表结构设计积分系统，实现核心后端服务  
**优先级**: 最高  
**依赖**: 02-用户认证系统完成

## 详细任务清单

### 1.1 数据库扩展设计

#### 1.1.1 扩展ums_member表
```sql
-- 扩展用户表，添加积分相关字段
ALTER TABLE ums_member ADD COLUMN free_daily_credits INT DEFAULT 200 COMMENT '每日免费积分';
ALTER TABLE ums_member ADD COLUMN used_today_free INT DEFAULT 0 COMMENT '今日已使用免费积分';
ALTER TABLE ums_member ADD COLUMN last_reset_date DATE COMMENT '最后重置日期';
```

#### 1.1.2 扩展ums_integration_change_history表
```sql
-- 扩展积分变动记录表
ALTER TABLE ums_integration_change_history ADD COLUMN credit_type TINYINT DEFAULT 2 COMMENT '积分类型: 1-免费积分, 2-永久积分';
ALTER TABLE ums_integration_change_history ADD COLUMN business_id VARCHAR(64) COMMENT '业务ID(如AI任务ID)';
```

#### 1.1.3 扩展pms_product表（积分商品）
```sql
-- 扩展商品表，支持积分商品
ALTER TABLE pms_product ADD COLUMN product_type TINYINT DEFAULT 1 COMMENT '商品类型: 1-普通商品, 2-积分商品, 3-套餐商品';
ALTER TABLE pms_product ADD COLUMN credit_amount INT COMMENT '积分数量(积分商品时使用)';
```

**验收标准**:
- [x] 所有表结构扩展成功
- [x] 字段类型和约束正确
- [x] 索引优化合理

### 1.2 积分核心服务实现

#### 1.2.1 积分服务接口
```java
// CreditsService.java
public interface CreditsService {
    
    /**
     * 获取用户积分信息
     */
    MemberCreditsVO getMemberCredits(Long memberId);
    
    /**
     * 消费积分
     */
    boolean consumeCredits(Long memberId, int amount, String businessId, String description);
    
    /**
     * 增加积分（购买）
     */
    void addCredits(Long memberId, int amount, String description, Long orderId);
    
    /**
     * 每日积分重置
     */
    void resetDailyCredits();
    
    /**
     * 获取积分历史记录
     */
    List<UmsIntegrationChangeHistory> getCreditsHistory(Long memberId);
}
```

#### 1.2.2 积分服务实现
```java
// CreditsServiceImpl.java
@Service
@Transactional
@Slf4j
public class CreditsServiceImpl implements CreditsService {
    
    @Autowired
    private UmsMemberMapper memberMapper;
    
    @Autowired
    private UmsIntegrationChangeHistoryMapper integrationHistoryMapper;
    
    @Autowired
    private UmsMemberRuleSettingMapper ruleSettingMapper;
    
    @Override
    public MemberCreditsVO getMemberCredits(Long memberId) {
        // 先检查是否需要重置每日积分
        resetDailyCreditsIfNeeded(memberId);
        
        UmsMember member = memberMapper.selectByPrimaryKey(memberId);
        if (member == null) {
            throw new BusinessException("用户不存在");
        }
        
        // 构建积分信息VO
        MemberCreditsVO creditsVO = new MemberCreditsVO();
        creditsVO.setTotalCredits(member.getIntegration() != null ? member.getIntegration() : 0);
        creditsVO.setFreeCredits(Math.max(0, 
            (member.getFreeDailyCredits() != null ? member.getFreeDailyCredits() : 200) - 
            (member.getUsedTodayFree() != null ? member.getUsedTodayFree() : 0)));
        creditsVO.setUsedTodayTotal(member.getUsedTodayFree() != null ? member.getUsedTodayFree() : 0);
        creditsVO.setLastResetDate(member.getLastResetDate());
        
        return creditsVO;
    }
    
    @Override
    public boolean consumeCredits(Long memberId, int amount, String businessId, String description) {
        UmsMember member = memberMapper.selectByPrimaryKey(memberId);
        if (member == null) {
            throw new BusinessException("用户不存在");
        }
        
        // 先重置每日积分
        resetDailyCreditsIfNeeded(memberId);
        member = memberMapper.selectByPrimaryKey(memberId); // 重新获取最新数据
        
        // 检查积分是否足够
        int totalCredits = (member.getIntegration() != null ? member.getIntegration() : 0);
        int freeCredits = Math.max(0, 
            (member.getFreeDailyCredits() != null ? member.getFreeDailyCredits() : 200) - 
            (member.getUsedTodayFree() != null ? member.getUsedTodayFree() : 0));
        int availableCredits = totalCredits + freeCredits;
        
        if (availableCredits < amount) {
            throw new BusinessException("积分不足");
        }
        
        // 优先使用免费积分
        int remainingAmount = amount;
        int freeCreditsUsed = 0;
        int permanentCreditsUsed = 0;
        
        if (freeCredits > 0) {
            freeCreditsUsed = Math.min(remainingAmount, freeCredits);
            remainingAmount -= freeCreditsUsed;
            
            // 更新已使用免费积分
            member.setUsedTodayFree((member.getUsedTodayFree() != null ? member.getUsedTodayFree() : 0) + freeCreditsUsed);
            
            // 记录免费积分使用
            recordIntegrationHistory(memberId, 1, -freeCreditsUsed, 
                description + " (免费积分)", 0, businessId, (byte) 1);
        }
        
        // 如果还有剩余，使用永久积分
        if (remainingAmount > 0) {
            permanentCreditsUsed = remainingAmount;
            int newIntegration = totalCredits - permanentCreditsUsed;
            member.setIntegration(newIntegration);
            
            // 记录永久积分使用
            recordIntegrationHistory(memberId, 1, -permanentCreditsUsed, 
                description + " (永久积分)", 0, businessId, (byte) 2);
        }
        
        memberMapper.updateByPrimaryKey(member);
        return true;
    }
    
    @Override
    public void addCredits(Long memberId, int amount, String description, Long orderId) {
        UmsMember member = memberMapper.selectByPrimaryKey(memberId);
        if (member == null) {
            throw new BusinessException("用户不存在");
        }
        
        // 增加永久积分
        int currentIntegration = member.getIntegration() != null ? member.getIntegration() : 0;
        member.setIntegration(currentIntegration + amount);
        
        // 更新历史积分总数
        int historyIntegration = member.getHistoryIntegration() != null ? member.getHistoryIntegration() : 0;
        member.setHistoryIntegration(historyIntegration + amount);
        
        memberMapper.updateByPrimaryKey(member);
        
        // 记录积分变动历史
        recordIntegrationHistory(memberId, 0, amount, description, 1, null, (byte) 2);
        
        log.info("Credits added for member {}: +{} - {}", memberId, amount, description);
    }
    
    @Override
    @Scheduled(cron = "0 0 0 * * ?") // 每天0点执行
    public void resetDailyCredits() {
        LocalDate today = LocalDate.now();
        
        // 查询需要重置的用户（昨天未重置的用户）
        List<UmsMember> membersToReset = memberMapper.selectMembersForDailyReset(today);
        
        for (UmsMember member : membersToReset) {
            // 重置每日免费积分使用量
            member.setUsedTodayFree(0);
            member.setLastResetDate(Date.valueOf(today));
            memberMapper.updateByPrimaryKey(member);
            
            // 记录每日重置历史
            recordIntegrationHistory(member.getId(), 0, 200, "每日免费积分重置", 1, null, (byte) 1);
        }
        
        log.info("Daily credits reset completed for {} members", membersToReset.size());
    }
    
    private void resetDailyCreditsIfNeeded(Long memberId) {
        UmsMember member = memberMapper.selectByPrimaryKey(memberId);
        if (member != null) {
            LocalDate today = LocalDate.now();
            LocalDate lastReset = member.getLastResetDate() != null ? 
                member.getLastResetDate().toLocalDate() : null;
                
            if (lastReset == null || !lastReset.equals(today)) {
                // 重置每日免费积分
                member.setUsedTodayFree(0);
                member.setLastResetDate(Date.valueOf(today));
                memberMapper.updateByPrimaryKey(member);
                
                // 记录重置历史
                recordIntegrationHistory(memberId, 0, 200, "每日免费积分重置", 1, null, (byte) 1);
            }
        }
    }
    
    private void recordIntegrationHistory(Long memberId, int changeType, int changeCount, 
            String operateNote, int sourceType, String businessId, Byte creditType) {
        
        UmsIntegrationChangeHistory history = new UmsIntegrationChangeHistory();
        history.setMemberId(memberId);
        history.setChangeType(changeType); // 0-增加, 1-减少
        history.setChangeCount(changeCount);
        history.setOperateNote(operateNote);
        history.setSourceType(sourceType); // 0-购物, 1-管理员修改/系统
        history.setBusinessId(businessId);
        history.setCreditType(creditType); // 1-免费积分, 2-永久积分
        history.setCreateTime(new Date());
        
        integrationHistoryMapper.insert(history);
    }
}
```

**验收标准**:
- [x] 积分服务核心逻辑正确
- [x] 双积分体系正确实现
- [x] 消费优先级逻辑正确
- [x] 每日重置机制正常工作

### 1.3 积分商品初始化

#### 1.3.1 积分商品数据
```sql
-- 初始化积分商品数据
INSERT INTO pms_product (
    brand_id, product_category_id, name, sub_title, description, price, original_price, 
    stock, unit, weight, sort, gift_growth, gift_point, use_point_limit, product_sn, 
    keywords, publish_status, new_status, recommend_status, verify_status, sale, 
    product_type, credit_amount
) VALUES 
(1, 1, '基础积分包', '1000积分', '适合轻度使用用户，包含1000积分', 9.90, 12.90, 999, '包', 0, 1, 0, 0, 0, 'CREDIT_BASIC_1000', '积分,充值,基础', 1, 1, 0, 1, 0, 2, 1000),
(1, 1, '标准积分包', '3000积分', '适合日常使用用户，包含3000积分', 26.90, 35.90, 999, '包', 0, 2, 0, 0, 0, 'CREDIT_STANDARD_3000', '积分,充值,标准', 1, 1, 1, 1, 0, 2, 3000),
(1, 1, '专业积分包', '6000积分', '适合专业设计师，包含6000积分', 49.90, 69.90, 999, '包', 0, 3, 0, 0, 0, 'CREDIT_PRO_6000', '积分,充值,专业', 1, 1, 1, 1, 0, 2, 6000),
(1, 1, '企业积分包', '15000积分', '适合团队协作，包含15000积分', 119.90, 169.90, 999, '包', 0, 4, 0, 0, 0, 'CREDIT_ENTERPRISE_15000', '积分,充值,企业', 1, 0, 1, 1, 0, 2, 15000),
(1, 1, '旗舰积分包', '30000积分', '无限创作可能，包含30000积分', 219.90, 329.90, 999, '包', 0, 5, 0, 0, 0, 'CREDIT_FLAGSHIP_30000', '积分,充值,旗舰', 1, 1, 1, 1, 0, 2, 30000);
```

#### 1.3.2 每日积分规则配置
```sql
-- 配置每日免费积分规则
UPDATE ums_member_rule_setting SET 
    continue_sign_day = 1,
    continue_sign_point = 200,
    type = 0 
WHERE id = 1;

-- 如果不存在记录，则插入
INSERT INTO ums_member_rule_setting (continue_sign_day, continue_sign_point, consume_per_point, low_order_amount, max_point_per_order, type)
VALUES (1, 200, 1.00, 0.00, -1, 0)
ON DUPLICATE KEY UPDATE 
    continue_sign_day = 1,
    continue_sign_point = 200;
```

**验收标准**:
- [x] 积分商品数据正确初始化
- [x] 商品价格和积分数量合理
- [x] 每日积分规则正确配置

## 交付物
- [x] 数据库表结构扩展脚本
- [x] 积分核心服务实现
- [x] 积分商品初始化数据
- [x] 相关Mapper接口扩展

## 验证测试
1. 执行数据库扩展脚本
2. 测试积分服务各方法
3. 验证双积分体系逻辑
4. 检查每日重置机制
5. 验证积分商品数据

## 风险控制
- **数据一致性**: 使用事务确保积分操作的原子性
- **并发处理**: 使用数据库锁防止并发扣费问题
- **业务规则**: 严格验证积分消费的业务规则

## 下一步
完成后进入 `03-2-积分API控制器开发`