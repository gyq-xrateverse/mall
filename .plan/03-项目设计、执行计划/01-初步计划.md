# 前提

管理后端前端项目：/mnt/d/software/beilv-agent/mall/mall-admin-web

管理后端后端项目：/mnt/d/software/beilv-agent/mall/mall/mall-admin

用户端前端项目：/mnt/d/software/beilv-agent/mall/beilv-agent-web

用户端后端项目：/mnt/d/software/beilv-agent/mall/mall/mall-portal

智能体python后端项目：/mnt/d/software/beilv-agent/mall/beilv-agent

# 工具

python后端会通过langchain 注册支持的工具，每个工具函数都需要有唯一且固定的uuid，便于数据库记录后，后端程序通过uuid定位对应的函数

1. 图片理解（第三方api）
2. 生成图片提示词（第三方api）
3. 生成视频提示词（第三方api）
4. 文生图（第三方api）
5. 图生图（第三方api）
6. 图生视频（第三方api）
7. 背景音乐生成（第三方api）
8. 背景音乐选择（本地接口：从本地音乐库中选择）
9. 口播文案生成（第三方api）
10. 文案转语音（第三方api）
11. 语音生成字幕（第三方api）
12. 视频合并（本地接口）
13. 音视频合并（本地接口）
14. 字幕视频合并（本地接口）

# 任务执行页面



用户端前端项目有一个首页/mnt/d/software/beilv-agent/mall/beilv-agent-web/src/pages/Home.tsx

其中有一个输入框点击提交时会跳转到【任务中心页面】（http://localhost:3000/ai-task），但目前的任务执行页面 我需要 重构 

参考这个截图的设计：/mnt/d/software/beilv-agent/任务执行页面.png

左侧显示历史项目，点击项目可以加载，在右侧查看详细内容，右侧是一个对话框，但只支持一轮对话，在这里用户可以输入任意要求，例如：/mnt/d/software/beilv-agent/任务提示词.md

提交提示词后，后端会按顺序输出中间结果：例如先生成图片，对话框中服务端返回 就会先预览图片，然后下一步生成视频，服务端生成成功后就返回视频，对话框中就会继续预览视频，在下一步，创建背景音乐，返回到前端对话框预览，在下一步，创建广告口播，返回到前端对话框预览，最后一步，合成视频，后端合成所有视频片段以及背景音乐以及口播，最终返回视频，在对话框中预览



# 项目任务创建流程

用户提交提示词后（包含6张图片）后端就会创建一个空项目

这是项目为初始状态

下一步是分析提示词

得到工作流的json对象，简单来说像下面这中有顺序的：细节上需要补充一些字段目前执行位置，每个节点的入参、出参（是否需要创建工具的入参、出参数据模型），每个节点生成的文件都需要上传到文件存储中，同时返回objectName保存到接点输出字段中以便下一个或后面的节点使用

图片理解1->图片理解2->图片理解3-->生成图片提示词1->生成图片提示词2->生成图片提示词3->图生图1->图生图2->图生图3->生成视频提示词1->生成视频提示词2->生成视频提示词3->图生视频1->图生视频2->图生视频3->口播文案生成->文案转语音->语音生成字幕->背景音乐选择->视频合并->音视频合并1->音视频合并2->字幕视频合并





# 项目任务执行流程

java后端会调用一个python后端接口提交这个提示词，python端通过 LLM 分析提示词动态创建一个工作流，然后执行，例如：

图片理解1：理解第4张上传的场景图片->场景图片信息1

图片理解2：理解第5张上传的场景图片->场景图片信息2

图片理解3：理解第6张上传的场景图片->场景图片信息3

生成图片提示词1：场景图片信息1+从整体提示词中分析得到需要生成什么样的图片的基础提示词->生成图片提示词1

生成图片提示词2：场景图片信息2+从整体提示词中分析得到需要生成什么样的图片的基础提示词->生成图片提示词2

生成图片提示词3：场景图片信息3+从整体提示词中分析得到需要生成什么样的图片的基础提示词->生成图片提示词3

图生图1：上传的第1张图+生成图片提示词1->结果图片1

图生图2：上传的第2张图+生成图片提示词1->结果图片2

图生图3：上传的第3张图+生成图片提示词1->结果图片3

生成视频提示词1：结果图片1+从整体提示词中分析得到需要生成什么样的视频的基础提示词->生成视频提示词1

生成视频提示词2：结果图片2+从整体提示词中分析得到需要生成什么样的视频的基础提示词->生成视频提示词2

生成视频提示词3：结果图片3+从整体提示词中分析得到需要生成什么样的视频的基础提示词->生成视频提示词3

图生视频1：结果图片1+生成视频提示词1->结果视频1

图生视频2：结果图片2+生成视频提示词2->结果视频2

图生视频3：结果图片3+生成视频提示词3->结果视频3

口播文案生成：从整体提示词中分析得到需要生成什么样的口播文案->口播文案

文案转语音：口播文案->口播语音

语音生成字幕：口播语音->口播文案字幕

背景音乐选择：从整体提示词中分析得到需要什么样的背景音乐->背景音乐

视频合并:图生视频1+图生视频2+图生视频3：合并结果视频1

音视频合并1：合并结果视频1+背景音乐：合并结果视频2

音视频合并2：合并结果视频2+口播语音：合并结果视频3

字幕视频合并：合并结果视频3+口播文案字幕：合并结果视频4

以上是整体流程，根据用户不同的描述 会 动态的去规划整体流程，每个阶段输出的文件都需要反馈到前端对话框中显示预览

# 问题

如何保证动态生成的工作流（工具链）能够正常执行衔接，不至于入参混乱错误，因为工作流是动态的无法固定，所以参数传递依靠的是大模型能力，例如：

1. 生成视频提示词1步骤中，结果图片1参数拿错了导致 缺少图片无法生成
2. 图生视频2步骤中，结果图片2参数拿错了导致 缺少图片无法生成
3. 等等

如何能够在工作流运行中突然宕机然后重启后能够继续恢复任务

如何能够自动下载需要的文件数据以及自动上传输出的文件数据，例如

1. 图生视频3，步骤中，结果图片3需要从文件存储中下载下来，最终生成的结果视频3需要上传到文件存储

如何设置工具链中，哪些工具的结果需要返回前端并预览，哪些工具结果不做预览 直接下一步

如何在工作流运行中动态返回生成的结果：分镜头图片、分镜头视频、口播文案、口播音频、背景音乐、最终合并视频

如何实时交互通知前端显示流程中间结果