# 05-2-2: 支付回调控制器

## 任务概述
**时间估算**: 40分钟  
**优先级**: 高  
**依赖关系**: 05-2-1-支付控制器实现完成  
**技术栈**: Java/Spring Boot, 支付宝SDK, 事件发布  

## 详细任务清单

### 1. 支付宝回调接口
- [ ] 创建AlipayCallbackController回调控制器
- [ ] 实现alipayNotify异步通知接口
- [ ] 实现alipayReturn同步返回接口
- [ ] 添加签名验证机制
- [ ] 处理支付结果状态判断

### 2. 回调参数处理
- [ ] 解析支付宝POST参数
- [ ] 处理中文编码问题
- [ ] 提取关键支付信息
- [ ] 验证订单号和金额
- [ ] 记录详细回调日志

### 3. 事件发布机制
- [ ] 发布PaymentSuccessEvent成功事件
- [ ] 发布PaymentFailureEvent失败事件
- [ ] 实现异步事件处理
- [ ] 添加事件参数封装
- [ ] 确保事件发布可靠性

### 4. 支付事件定义
- [ ] 定义PaymentSuccessEvent成功事件类
- [ ] 定义PaymentFailureEvent失败事件类
- [ ] 添加事件数据字段
- [ ] 实现事件继承结构
- [ ] 支持序列化机制

## 核心代码实现

### AlipayCallbackController.java
```java
@RestController
@RequestMapping("/api/payment/alipay")
@Slf4j
public class AlipayCallbackController {
    
    @Autowired
    private AlipayService alipayService;
    
    @Autowired
    private PaymentService paymentService;
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    @PostMapping("/notify")
    @ApiOperation("支付宝异步通知")
    public String alipayNotify(HttpServletRequest request) {
        try {
            // 获取支付宝POST过来反馈信息
            Map<String, String> params = new HashMap<>();
            Map<String, String[]> requestParams = request.getParameterMap();
            
            for (String name : requestParams.keySet()) {
                String[] values = requestParams.get(name);
                String valueStr = "";
                for (int i = 0; i < values.length; i++) {
                    valueStr = (i == values.length - 1) ? valueStr + values[i]
                            : valueStr + values[i] + ",";
                }
                // 乱码解决
                valueStr = new String(valueStr.getBytes("ISO-8859-1"), "utf-8");
                params.put(name, valueStr);
            }
            
            log.info("Alipay notify received: {}", params);
            
            // 验证签名
            boolean signVerified = alipayService.verifyNotify(params);
            if (!signVerified) {
                log.error("Alipay notify signature verification failed");
                return "failure";
            }
            
            // 获取通知参数
            String tradeStatus = params.get("trade_status");
            String outTradeNo = params.get("out_trade_no");
            String tradeNo = params.get("trade_no");
            String totalAmount = params.get("total_amount");
            
            log.info("Alipay notify - orderSn: {}, tradeNo: {}, status: {}, amount: {}", 
                outTradeNo, tradeNo, tradeStatus, totalAmount);
            
            // 处理支付结果
            if ("TRADE_SUCCESS".equals(tradeStatus) || "TRADE_FINISHED".equals(tradeStatus)) {
                // 支付成功
                PaymentSuccessEvent event = new PaymentSuccessEvent(this);
                event.setOrderSn(outTradeNo);
                event.setTransactionId(tradeNo);
                event.setAmount(new BigDecimal(totalAmount));
                event.setPaymentMethod("alipay");
                
                eventPublisher.publishEvent(event);
                
                return "success";
                
            } else if ("TRADE_CLOSED".equals(tradeStatus)) {
                // 支付关闭
                PaymentFailureEvent event = new PaymentFailureEvent(this);
                event.setOrderSn(outTradeNo);
                event.setReason("支付已关闭");
                
                eventPublisher.publishEvent(event);
                
                return "success";
            }
            
            return "success";
            
        } catch (Exception e) {
            log.error("Process alipay notify failed", e);
            return "failure";
        }
    }
    
    @GetMapping("/return")
    @ApiOperation("支付宝同步返回")
    public String alipayReturn(HttpServletRequest request, Model model) {
        try {
            Map<String, String> params = new HashMap<>();
            Map<String, String[]> requestParams = request.getParameterMap();
            
            for (String name : requestParams.keySet()) {
                String[] values = requestParams.get(name);
                String valueStr = "";
                for (int i = 0; i < values.length; i++) {
                    valueStr = (i == values.length - 1) ? valueStr + values[i]
                            : valueStr + values[i] + ",";
                }
                valueStr = new String(valueStr.getBytes("ISO-8859-1"), "utf-8");
                params.put(name, valueStr);
            }
            
            // 验证签名
            boolean signVerified = alipayService.verifyNotify(params);
            if (!signVerified) {
                model.addAttribute("message", "支付验证失败");
                return "payment/result";
            }
            
            String outTradeNo = params.get("out_trade_no");
            String tradeNo = params.get("trade_no");
            
            // 查询支付状态
            PaymentStatusVO status = paymentService.getPaymentStatus(outTradeNo);
            model.addAttribute("paymentStatus", status);
            
            return "payment/result";
            
        } catch (Exception e) {
            log.error("Process alipay return failed", e);
            model.addAttribute("message", "支付结果查询失败");
            return "payment/result";
        }
    }
}
```

### 支付事件定义
```java
// PaymentSuccessEvent.java
@Data
public class PaymentSuccessEvent extends ApplicationEvent {
    private String orderSn;
    private String transactionId;
    private BigDecimal amount;
    private String paymentMethod;
    private Date eventTime;
    
    public PaymentSuccessEvent(Object source) {
        super(source);
        this.eventTime = new Date();
    }
}

// PaymentFailureEvent.java
@Data
public class PaymentFailureEvent extends ApplicationEvent {
    private String orderSn;
    private String reason;
    private String paymentMethod;
    private Date eventTime;
    
    public PaymentFailureEvent(Object source) {
        super(source);
        this.eventTime = new Date();
    }
}
```

### 微信支付回调扩展
```java
@RestController
@RequestMapping("/api/payment/wechat")
@Slf4j
public class WechatCallbackController {
    
    @Autowired
    private WechatPayService wechatPayService;
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    @PostMapping("/notify")
    @ApiOperation("微信支付异步通知")
    public String wechatNotify(HttpServletRequest request) {
        try {
            // 读取微信支付回调数据
            String xmlData = readRequestBody(request);
            log.info("Wechat notify received: {}", xmlData);
            
            // 验证签名
            boolean signVerified = wechatPayService.verifyNotify(xmlData);
            if (!signVerified) {
                log.error("Wechat notify signature verification failed");
                return buildWechatFailureResponse("签名验证失败");
            }
            
            // 解析XML数据
            Map<String, String> params = parseXmlToMap(xmlData);
            
            String returnCode = params.get("return_code");
            String resultCode = params.get("result_code");
            String outTradeNo = params.get("out_trade_no");
            String transactionId = params.get("transaction_id");
            String totalFee = params.get("total_fee");
            
            if ("SUCCESS".equals(returnCode) && "SUCCESS".equals(resultCode)) {
                // 支付成功
                PaymentSuccessEvent event = new PaymentSuccessEvent(this);
                event.setOrderSn(outTradeNo);
                event.setTransactionId(transactionId);
                event.setAmount(new BigDecimal(totalFee).divide(new BigDecimal(100))); // 分转元
                event.setPaymentMethod("wechat");
                
                eventPublisher.publishEvent(event);
                
                return buildWechatSuccessResponse();
            } else {
                // 支付失败
                PaymentFailureEvent event = new PaymentFailureEvent(this);
                event.setOrderSn(outTradeNo);
                event.setReason(params.get("err_code_des"));
                event.setPaymentMethod("wechat");
                
                eventPublisher.publishEvent(event);
                
                return buildWechatSuccessResponse();
            }
            
        } catch (Exception e) {
            log.error("Process wechat notify failed", e);
            return buildWechatFailureResponse("处理失败");
        }
    }
    
    private String readRequestBody(HttpServletRequest request) throws IOException {
        BufferedReader reader = request.getReader();
        StringBuilder sb = new StringBuilder();
        String line;
        while ((line = reader.readLine()) != null) {
            sb.append(line);
        }
        return sb.toString();
    }
    
    private String buildWechatSuccessResponse() {
        return "<xml><return_code><![CDATA[SUCCESS]]></return_code><return_msg><![CDATA[OK]]></return_msg></xml>";
    }
    
    private String buildWechatFailureResponse(String message) {
        return String.format("<xml><return_code><![CDATA[FAIL]]></return_code><return_msg><![CDATA[%s]]></return_msg></xml>", message);
    }
}
```

## 验收标准
1. **回调接口安全性**: 100%验证签名有效性
2. **参数解析准确性**: 正确解析所有回调参数
3. **事件发布可靠性**: 事件发布成功率100%
4. **异常处理完善性**: 所有异常情况正确处理
5. **日志记录详细性**: 完整记录回调处理过程

## 交付物
- [x] AlipayCallbackController.java 支付宝回调控制器
- [x] WechatCallbackController.java 微信支付回调控制器
- [x] PaymentSuccessEvent.java 支付成功事件
- [x] PaymentFailureEvent.java 支付失败事件
- [x] 回调参数处理机制

## 技术要点
1. **签名验证**: 确保回调数据安全性
2. **编码处理**: 正确处理中文字符编码
3. **事件驱动**: 使用Spring Event解耦处理逻辑
4. **异常处理**: 确保回调接口稳定性
5. **日志记录**: 详细记录回调处理过程

## 测试检查点
- [ ] 支付宝成功回调测试
- [ ] 支付宝失败回调测试
- [ ] 微信支付成功回调测试
- [ ] 微信支付失败回调测试
- [ ] 签名验证功能测试
- [ ] 参数解析功能测试
- [ ] 事件发布功能测试
- [ ] 异常处理测试

## 下一步
完成后进入 `05-2-3-支付管理接口`，开发支付记录查询和管理员支付管理功能。