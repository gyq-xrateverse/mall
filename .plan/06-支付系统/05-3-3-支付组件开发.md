# 05-3-3: 支付组件开发

## 任务概述
**时间估算**: 45分钟  
**优先级**: 高  
**依赖关系**: 05-3-2-RTK Query API集成完成  
**技术栈**: React/TypeScript, Ant Design, 组件化开发  

## 详细任务清单

### 1. 支付方式选择组件
- [ ] 创建PaymentMethodSelector支付方式选择器
- [ ] 实现支付方式图标显示
- [ ] 添加支付方式描述和优惠信息
- [ ] 支持单选和确认操作
- [ ] 实现loading和disabled状态

### 2. 支付状态监控组件
- [ ] 创建PaymentStatusMonitor状态监控器
- [ ] 实现支付状态轮询查询
- [ ] 添加支付进度步骤显示
- [ ] 支持支付成功/失败结果展示
- [ ] 实现取消支付功能

### 3. 支付页面组件
- [ ] 创建PaymentPage完整支付页面
- [ ] 集成支付方式选择和状态监控
- [ ] 实现支付流程步骤控制
- [ ] 添加订单信息显示
- [ ] 支持不同业务类型的支付跳转

### 4. 支付记录组件
- [ ] 创建PaymentRecordList支付记录列表
- [ ] 实现分页和筛选功能
- [ ] 添加支付状态展示
- [ ] 支持查看支付详情
- [ ] 实现退款申请功能

## 核心代码实现

### PaymentMethodSelector.tsx
```tsx
// components/payment/PaymentMethodSelector.tsx
import React from 'react';
import { Card, Radio, Button, Alert } from 'antd';
import { AlipayOutlined, WechatOutlined } from '@ant-design/icons';
import { useGetPaymentMethodsQuery } from '@/api/paymentApi';

interface PaymentMethodSelectorProps {
  selectedMethod: string;
  onMethodChange: (method: string) => void;
  onConfirm: () => void;
  loading?: boolean;
  disabled?: boolean;
}

export const PaymentMethodSelector: React.FC<PaymentMethodSelectorProps> = ({
  selectedMethod,
  onMethodChange,
  onConfirm,
  loading = false,
  disabled = false,
}) => {
  const { data: methods, isLoading } = useGetPaymentMethodsQuery();

  const getMethodIcon = (method: string) => {
    switch (method) {
      case 'alipay':
        return <AlipayOutlined className="text-blue-500 text-2xl" />;
      case 'wechat':
        return <WechatOutlined className="text-green-500 text-2xl" />;
      default:
        return null;
    }
  };

  const getMethodName = (method: string) => {
    switch (method) {
      case 'alipay': return '支付宝';
      case 'wechat': return '微信支付';
      default: return method;
    }
  };

  if (isLoading) {
    return <div>加载支付方式...</div>;
  }

  return (
    <Card title="选择支付方式" className="w-full">
      {!methods || methods.length === 0 ? (
        <Alert message="暂无可用的支付方式" type="warning" />
      ) : (
        <>
          <Radio.Group
            value={selectedMethod}
            onChange={(e) => onMethodChange(e.target.value)}
            className="w-full"
            disabled={disabled}
          >
            <div className="space-y-3">
              {methods.map((method) => (
                <Radio key={method.code} value={method.code} className="w-full">
                  <div className="flex items-center justify-between w-full p-3 border border-gray-200 rounded-lg hover:border-blue-400 transition-colors">
                    <div className="flex items-center space-x-3">
                      {getMethodIcon(method.code)}
                      <div>
                        <div className="font-medium">{getMethodName(method.code)}</div>
                        {method.description && (
                          <div className="text-sm text-gray-500">{method.description}</div>
                        )}
                      </div>
                    </div>
                    
                    {method.discount && method.discount > 0 && (
                      <div className="text-red-500 text-sm">
                        减免 ¥{method.discount}
                      </div>
                    )}
                  </div>
                </Radio>
              ))}
            </div>
          </Radio.Group>
          
          <div className="mt-6 flex justify-center">
            <Button
              type="primary"
              size="large"
              onClick={onConfirm}
              loading={loading}
              disabled={!selectedMethod || disabled}
              className="px-12"
            >
              确认支付
            </Button>
          </div>
        </>
      )}
    </Card>
  );
};
```

### PaymentStatusMonitor.tsx
```tsx
// components/payment/PaymentStatusMonitor.tsx
import React, { useEffect, useState } from 'react';
import { Card, Steps, Button, Result, Spin, Alert } from 'antd';
import { LoadingOutlined, CheckCircleOutlined, CloseCircleOutlined } from '@ant-design/icons';
import { useGetPaymentStatusQuery } from '@/api/paymentApi';

interface PaymentStatusMonitorProps {
  orderSn: string;
  paymentMethod: string;
  amount: number;
  onPaymentSuccess: () => void;
  onPaymentFailure: (reason: string) => void;
  onCancel: () => void;
}

export const PaymentStatusMonitor: React.FC<PaymentStatusMonitorProps> = ({
  orderSn,
  paymentMethod,
  amount,
  onPaymentSuccess,
  onPaymentFailure,
  onCancel,
}) => {
  const [pollingEnabled, setPollingEnabled] = useState(true);
  
  const { data: paymentStatus, isLoading, error } = useGetPaymentStatusQuery(orderSn, {
    pollingInterval: pollingEnabled ? 2000 : 0,
    skip: !orderSn,
  });

  useEffect(() => {
    if (paymentStatus) {
      switch (paymentStatus.paymentStatus) {
        case 1: // 支付成功
          setPollingEnabled(false);
          onPaymentSuccess();
          break;
        case 2: // 支付失败
          setPollingEnabled(false);
          onPaymentFailure(paymentStatus.failureReason || '支付失败');
          break;
        case 3: // 已取消
          setPollingEnabled(false);
          break;
      }
    }
  }, [paymentStatus, onPaymentSuccess, onPaymentFailure]);

  const renderPaymentResult = () => {
    if (!paymentStatus) return null;

    switch (paymentStatus.paymentStatus) {
      case 1:
        return (
          <Result
            status="success"
            title="支付成功"
            subTitle={`支付金额：¥${amount} | 交易号：${paymentStatus.transactionId}`}
            extra={[
              <Button type="primary" key="continue">
                继续使用
              </Button>,
            ]}
          />
        );
      
      case 2:
        return (
          <Result
            status="error"
            title="支付失败"
            subTitle={paymentStatus.failureReason || '支付过程中发生错误'}
            extra={[
              <Button type="primary" key="retry">
                重新支付
              </Button>,
              <Button key="cancel" onClick={onCancel}>
                取消
              </Button>,
            ]}
          />
        );
      
      case 3:
        return (
          <Result
            status="warning"
            title="支付已取消"
            subTitle="您取消了本次支付"
            extra={[
              <Button type="primary" key="retry">
                重新支付
              </Button>,
            ]}
          />
        );
      
      default:
        return null;
    }
  };

  if (error) {
    return (
      <Alert
        message="查询支付状态失败"
        description="请刷新页面重试"
        type="error"
        showIcon
      />
    );
  }

  if (paymentStatus && paymentStatus.paymentStatus !== 0) {
    return renderPaymentResult();
  }

  return (
    <Card title="支付状态" className="w-full">
      <div className="text-center mb-6">
        <Spin size="large" />
        <div className="mt-4 text-lg">正在等待支付...</div>
        <div className="text-gray-500">支付金额：¥{amount}</div>
      </div>
      
      <Steps
        current={0}
        items={[
          {
            title: '发起支付',
            status: 'finish',
            icon: <CheckCircleOutlined />,
          },
          {
            title: '确认支付',
            status: paymentStatus?.paymentStatus === 0 ? 'process' : 'wait',
            icon: paymentStatus?.paymentStatus === 0 ? <LoadingOutlined /> : null,
          },
          {
            title: '支付完成',
            status: 'wait',
          },
        ]}
      />
      
      <div className="mt-6 text-center">
        <Button onClick={onCancel} disabled={isLoading}>
          取消支付
        </Button>
      </div>
      
      <Alert
        message="请在新打开的页面完成支付"
        description="支付完成后本页面将自动更新状态"
        type="info"
        showIcon
        className="mt-4"
      />
    </Card>
  );
};
```

### PaymentPage.tsx
```tsx
// pages/payment/PaymentPage.tsx
import React, { useState, useEffect } from 'react';
import { useParams, useLocation, useNavigate } from 'react-router-dom';
import { Card, Steps, message } from 'antd';
import { PaymentMethodSelector } from '@/components/payment/PaymentMethodSelector';
import { PaymentStatusMonitor } from '@/components/payment/PaymentStatusMonitor';
import { useCreatePaymentMutation } from '@/api/paymentApi';

const PaymentPage: React.FC = () => {
  const { orderId } = useParams<{ orderId: string }>();
  const location = useLocation();
  const navigate = useNavigate();
  
  const [currentStep, setCurrentStep] = useState(0);
  const [selectedMethod, setSelectedMethod] = useState('alipay');
  const [paymentOrder, setPaymentOrder] = useState<any>(null);
  
  const [createPayment, { isLoading: createLoading }] = useCreatePaymentMutation();
  
  const orderData = location.state?.orderData;

  useEffect(() => {
    if (!orderId || !orderData) {
      message.error('订单信息不完整');
      navigate(-1);
    }
  }, [orderId, orderData, navigate]);

  const handleConfirmPayment = async () => {
    if (!orderId) return;

    try {
      const result = await createPayment({
        orderId: parseInt(orderId),
        paymentMethod: selectedMethod,
        clientType: 'web',
      }).unwrap();

      setPaymentOrder(result);
      setCurrentStep(1);

      if (result.paymentUrl) {
        window.open(result.paymentUrl, '_blank');
      }

      setTimeout(() => {
        setCurrentStep(2);
      }, 1000);

    } catch (error: any) {
      message.error(error.data?.message || '创建支付失败');
    }
  };

  const handlePaymentSuccess = () => {
    message.success('支付成功！');
    
    if (orderData.business_type === 1) {
      navigate('/subscription/success', { state: { orderData } });
    } else if (orderData.business_type === 2) {
      navigate('/credits/success', { state: { orderData } });
    } else {
      navigate('/payment/success', { state: { orderData } });
    }
  };

  const handlePaymentFailure = (reason: string) => {
    message.error(`支付失败：${reason}`);
    setCurrentStep(0);
  };

  const handleCancel = () => {
    navigate(-1);
  };

  const stepItems = [
    { title: '选择支付方式', description: '选择您偏好的支付方式' },
    { title: '确认支付', description: '在新页面完成支付' },
    { title: '支付完成', description: '等待支付结果' },
  ];

  return (
    <div className="max-w-2xl mx-auto px-4 py-8">
      <Card title="订单支付" className="mb-6">
        <div className="text-center mb-6">
          <div className="text-2xl font-bold text-gray-800">
            ¥{orderData?.payAmount || orderData?.amount || 0}
          </div>
          <div className="text-gray-500 mt-2">
            订单号：{orderData?.orderSn}
          </div>
        </div>

        <Steps current={currentStep} items={stepItems} className="mb-8" />

        {currentStep === 0 && (
          <PaymentMethodSelector
            selectedMethod={selectedMethod}
            onMethodChange={setSelectedMethod}
            onConfirm={handleConfirmPayment}
            loading={createLoading}
          />
        )}

        {currentStep === 2 && paymentOrder && (
          <PaymentStatusMonitor
            orderSn={paymentOrder.orderSn}
            paymentMethod={selectedMethod}
            amount={orderData?.payAmount || orderData?.amount || 0}
            onPaymentSuccess={handlePaymentSuccess}
            onPaymentFailure={handlePaymentFailure}
            onCancel={handleCancel}
          />
        )}
      </Card>
    </div>
  );
};

export default PaymentPage;
```

## 验收标准
1. **组件功能完整性**: 所有支付相关组件功能完整
2. **用户体验友好性**: 支付流程清晰，操作简单
3. **状态管理准确性**: 支付状态变化及时准确
4. **错误处理完善性**: 各种异常情况友好提示
5. **响应式设计**: 适配不同屏幕尺寸

## 交付物
- [x] PaymentMethodSelector.tsx 支付方式选择组件
- [x] PaymentStatusMonitor.tsx 支付状态监控组件
- [x] PaymentPage.tsx 支付页面组件
- [x] PaymentRecordList.tsx 支付记录列表组件
- [x] 组件样式和交互逻辑

## 技术要点
1. **组件化设计**: 高度可复用的组件设计
2. **状态管理**: 合理的组件状态管理
3. **用户体验**: 流畅的支付流程体验
4. **实时更新**: 支付状态实时轮询更新
5. **错误处理**: 完善的错误处理和用户提示

## 测试检查点
- [ ] 支付方式选择组件测试
- [ ] 支付状态监控组件测试
- [ ] 支付页面流程测试
- [ ] 支付记录列表测试
- [ ] 组件响应式设计测试
- [ ] 错误处理功能测试
- [ ] 用户交互体验测试
- [ ] 支付状态轮询测试

## 下一步
完成后进入 `05-3-4-自定义Hooks`，开发支付相关的自定义React Hooks。