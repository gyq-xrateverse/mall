# 05-2: 支付API控制器开发

## 任务概述
**时间**: 第3天  
**目标**: 开发支付相关的REST API控制器  
**优先级**: 最高  
**依赖**: 05-1 支付服务集成完成

## 详细任务清单

### 2.1 支付控制器实现

#### 2.1.1 支付相关DTO
```java
// 支付订单创建请求
@Data
public class CreatePaymentRequest {
    @NotNull(message = "订单ID不能为空")
    private Long orderId;
    
    @NotBlank(message = "支付方式不能为空")
    private String paymentMethod; // alipay, wechat, etc.
    
    private String clientType = "web"; // web, mobile, app
}

// 支付订单响应
@Data
public class PaymentOrderVO {
    private Long orderId;
    private String orderSn;
    private BigDecimal amount;
    private String paymentMethod;
    private String paymentScene;
    private String paymentUrl;      // 支付跳转URL
    private String qrCodeUrl;      // 二维码URL(移动支付)
    private Date expireTime;       // 支付过期时间
    private String paymentId;      // 支付平台订单号
}

// 支付状态查询响应
@Data
public class PaymentStatusVO {
    private String orderSn;
    private Integer paymentStatus; // 0-待支付, 1-支付成功, 2-支付失败, 3-已取消
    private BigDecimal amount;
    private String paymentMethod;
    private Date paymentTime;
    private String transactionId;
    private String failureReason;
}

// 退款请求
@Data
public class RefundRequest {
    @NotNull(message = "订单ID不能为空")
    private Long orderId;
    
    @NotNull(message = "退款金额不能为空")
    @DecimalMin(value = "0.01", message = "退款金额必须大于0")
    private BigDecimal refundAmount;
    
    @NotBlank(message = "退款原因不能为空")
    private String refundReason;
}

// 退款结果响应
@Data
public class RefundResultVO {
    private String orderSn;
    private String refundId;
    private BigDecimal refundAmount;
    private Integer refundStatus; // 0-退款中, 1-退款成功, 2-退款失败
    private String refundReason;
    private Date refundTime;
}
```

#### 2.1.2 支付控制器实现
```java
// PaymentController.java
@RestController
@RequestMapping("/api/payment")
@Validated
@Slf4j
public class PaymentController {
    
    @Autowired
    private PaymentService paymentService;
    
    @Autowired
    private OmsOrderService orderService;
    
    @PostMapping("/create")
    @ApiOperation("创建支付订单")
    public CommonResult<PaymentOrderVO> createPayment(
            HttpServletRequest request,
            @Valid @RequestBody CreatePaymentRequest paymentRequest) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            
            // 验证订单归属
            OmsOrder order = orderService.getOrderById(paymentRequest.getOrderId());
            if (order == null) {
                return CommonResult.failed("订单不存在");
            }
            
            if (!order.getMemberId().equals(memberId)) {
                return CommonResult.failed("无权限操作此订单");
            }
            
            if (order.getStatus() != 0) {
                return CommonResult.failed("订单状态不正确");
            }
            
            // 创建支付订单
            PaymentOrderVO paymentOrder = paymentService.createPaymentOrder(
                paymentRequest.getOrderId(),
                paymentRequest.getPaymentMethod()
            );
            
            return CommonResult.success(paymentOrder, "支付订单创建成功");
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Create payment failed", e);
            return CommonResult.failed("创建支付订单失败");
        }
    }
    
    @GetMapping("/status/{orderSn}")
    @ApiOperation("查询支付状态")
    public CommonResult<PaymentStatusVO> getPaymentStatus(
            HttpServletRequest request,
            @PathVariable String orderSn) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            
            // 验证订单归属权限
            OmsOrder order = orderService.getOrderByOrderSn(orderSn);
            if (order == null) {
                return CommonResult.failed("订单不存在");
            }
            
            if (!order.getMemberId().equals(memberId)) {
                return CommonResult.failed("无权限查询此订单");
            }
            
            PaymentStatusVO status = paymentService.getPaymentStatus(orderSn);
            return CommonResult.success(status);
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Get payment status failed for orderSn: " + orderSn, e);
            return CommonResult.failed("查询支付状态失败");
        }
    }
    
    @PostMapping("/cancel/{orderSn}")
    @ApiOperation("取消支付")
    public CommonResult<String> cancelPayment(
            HttpServletRequest request,
            @PathVariable String orderSn) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            
            // 验证订单归属权限
            OmsOrder order = orderService.getOrderByOrderSn(orderSn);
            if (order == null) {
                return CommonResult.failed("订单不存在");
            }
            
            if (!order.getMemberId().equals(memberId)) {
                return CommonResult.failed("无权限操作此订单");
            }
            
            boolean success = paymentService.cancelPayment(orderSn);
            
            if (success) {
                return CommonResult.success("支付已取消");
            } else {
                return CommonResult.failed("取消支付失败");
            }
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Cancel payment failed for orderSn: " + orderSn, e);
            return CommonResult.failed("取消支付失败");
        }
    }
    
    @PostMapping("/refund")
    @ApiOperation("申请退款")
    public CommonResult<RefundResultVO> requestRefund(
            HttpServletRequest request,
            @Valid @RequestBody RefundRequest refundRequest) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            
            // 验证订单归属权限
            OmsOrder order = orderService.getOrderById(refundRequest.getOrderId());
            if (order == null) {
                return CommonResult.failed("订单不存在");
            }
            
            if (!order.getMemberId().equals(memberId)) {
                return CommonResult.failed("无权限操作此订单");
            }
            
            if (order.getStatus() != 1) {
                return CommonResult.failed("订单状态不支持退款");
            }
            
            RefundResultVO result = paymentService.refundOrder(
                refundRequest.getOrderId(),
                refundRequest.getRefundAmount(),
                refundRequest.getRefundReason()
            );
            
            return CommonResult.success(result, "退款申请提交成功");
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Request refund failed", e);
            return CommonResult.failed("申请退款失败");
        }
    }
    
    @GetMapping("/methods")
    @ApiOperation("获取支付方式列表")
    public CommonResult<List<PaymentMethodVO>> getPaymentMethods() {
        try {
            List<PaymentMethodVO> methods = paymentService.getAvailablePaymentMethods();
            return CommonResult.success(methods);
            
        } catch (Exception e) {
            log.error("Get payment methods failed", e);
            return CommonResult.failed("获取支付方式失败");
        }
    }
    
    private Long getCurrentMemberId(HttpServletRequest request) {
        String token = extractTokenFromRequest(request);
        if (!StringUtils.hasText(token)) {
            throw new BusinessException("未登录");
        }
        
        return JwtUtils.getMemberIdFromToken(token);
    }
    
    private String extractTokenFromRequest(HttpServletRequest request) {
        String authHeader = request.getHeader("Authorization");
        if (StringUtils.hasText(authHeader) && authHeader.startsWith("Bearer ")) {
            return authHeader.substring(7);
        }
        return null;
    }
}
```

**验收标准**:
- [x] 所有API接口功能完整
- [x] 权限验证严格准确
- [x] 错误处理和日志完善
- [x] 响应格式统一规范

### 2.2 支付回调控制器

#### 2.2.1 支付宝回调接口
```java
// AlipayCallbackController.java
@RestController
@RequestMapping("/api/payment/alipay")
@Slf4j
public class AlipayCallbackController {
    
    @Autowired
    private AlipayService alipayService;
    
    @Autowired
    private PaymentService paymentService;
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    @PostMapping("/notify")
    @ApiOperation("支付宝异步通知")
    public String alipayNotify(HttpServletRequest request) {
        try {
            // 获取支付宝POST过来反馈信息
            Map<String, String> params = new HashMap<>();
            Map<String, String[]> requestParams = request.getParameterMap();
            
            for (String name : requestParams.keySet()) {
                String[] values = requestParams.get(name);
                String valueStr = "";
                for (int i = 0; i < values.length; i++) {
                    valueStr = (i == values.length - 1) ? valueStr + values[i]
                            : valueStr + values[i] + ",";
                }
                // 乱码解决
                valueStr = new String(valueStr.getBytes("ISO-8859-1"), "utf-8");
                params.put(name, valueStr);
            }
            
            log.info("Alipay notify received: {}", params);
            
            // 验证签名
            boolean signVerified = alipayService.verifyNotify(params);
            if (!signVerified) {
                log.error("Alipay notify signature verification failed");
                return "failure";
            }
            
            // 获取通知参数
            String tradeStatus = params.get("trade_status");
            String outTradeNo = params.get("out_trade_no");
            String tradeNo = params.get("trade_no");
            String totalAmount = params.get("total_amount");
            
            log.info("Alipay notify - orderSn: {}, tradeNo: {}, status: {}, amount: {}", 
                outTradeNo, tradeNo, tradeStatus, totalAmount);
            
            // 处理支付结果
            if ("TRADE_SUCCESS".equals(tradeStatus) || "TRADE_FINISHED".equals(tradeStatus)) {
                // 支付成功
                PaymentSuccessEvent event = new PaymentSuccessEvent(this);
                event.setOrderSn(outTradeNo);
                event.setTransactionId(tradeNo);
                event.setAmount(new BigDecimal(totalAmount));
                event.setPaymentMethod("alipay");
                
                eventPublisher.publishEvent(event);
                
                return "success";
                
            } else if ("TRADE_CLOSED".equals(tradeStatus)) {
                // 支付关闭
                PaymentFailureEvent event = new PaymentFailureEvent(this);
                event.setOrderSn(outTradeNo);
                event.setReason("支付已关闭");
                
                eventPublisher.publishEvent(event);
                
                return "success";
            }
            
            return "success";
            
        } catch (Exception e) {
            log.error("Process alipay notify failed", e);
            return "failure";
        }
    }
    
    @GetMapping("/return")
    @ApiOperation("支付宝同步返回")
    public String alipayReturn(HttpServletRequest request, Model model) {
        try {
            Map<String, String> params = new HashMap<>();
            Map<String, String[]> requestParams = request.getParameterMap();
            
            for (String name : requestParams.keySet()) {
                String[] values = requestParams.get(name);
                String valueStr = "";
                for (int i = 0; i < values.length; i++) {
                    valueStr = (i == values.length - 1) ? valueStr + values[i]
                            : valueStr + values[i] + ",";
                }
                valueStr = new String(valueStr.getBytes("ISO-8859-1"), "utf-8");
                params.put(name, valueStr);
            }
            
            // 验证签名
            boolean signVerified = alipayService.verifyNotify(params);
            if (!signVerified) {
                model.addAttribute("message", "支付验证失败");
                return "payment/result";
            }
            
            String outTradeNo = params.get("out_trade_no");
            String tradeNo = params.get("trade_no");
            
            // 查询支付状态
            PaymentStatusVO status = paymentService.getPaymentStatus(outTradeNo);
            model.addAttribute("paymentStatus", status);
            
            return "payment/result";
            
        } catch (Exception e) {
            log.error("Process alipay return failed", e);
            model.addAttribute("message", "支付结果查询失败");
            return "payment/result";
        }
    }
}
```

#### 2.2.2 支付事件定义
```java
// PaymentSuccessEvent.java
@Data
public class PaymentSuccessEvent extends ApplicationEvent {
    private String orderSn;
    private String transactionId;
    private BigDecimal amount;
    private String paymentMethod;
    
    public PaymentSuccessEvent(Object source) {
        super(source);
    }
}

// PaymentFailureEvent.java
@Data
public class PaymentFailureEvent extends ApplicationEvent {
    private String orderSn;
    private String reason;
    private String paymentMethod;
    
    public PaymentFailureEvent(Object source) {
        super(source);
    }
}
```

**验收标准**:
- [x] 支付回调接口安全可靠
- [x] 签名验证严格执行
- [x] 事件发布机制正常
- [x] 异常处理完善

### 2.3 支付管理接口

#### 2.3.1 支付记录查询
```java
// PaymentRecordController.java
@RestController
@RequestMapping("/api/payment/record")
@Validated
@Slf4j
public class PaymentRecordController {
    
    @Autowired
    private PaymentService paymentService;
    
    @GetMapping("/list")
    @ApiOperation("获取支付记录列表")
    public CommonResult<CommonPage<PaymentRecordVO>> getPaymentRecords(
            HttpServletRequest request,
            @RequestParam(defaultValue = "1") Integer pageNum,
            @RequestParam(defaultValue = "10") Integer pageSize,
            @RequestParam(required = false) Integer paymentStatus,
            @RequestParam(required = false) String paymentMethod,
            @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate startDate,
            @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate endDate) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            
            PaymentRecordQuery query = new PaymentRecordQuery();
            query.setMemberId(memberId);
            query.setPageNum(pageNum);
            query.setPageSize(pageSize);
            query.setPaymentStatus(paymentStatus);
            query.setPaymentMethod(paymentMethod);
            query.setStartDate(startDate);
            query.setEndDate(endDate);
            
            CommonPage<PaymentRecordVO> records = paymentService.getPaymentRecords(query);
            
            return CommonResult.success(records);
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Get payment records failed", e);
            return CommonResult.failed("获取支付记录失败");
        }
    }
    
    @GetMapping("/detail/{paymentId}")
    @ApiOperation("获取支付详情")
    public CommonResult<PaymentDetailVO> getPaymentDetail(
            HttpServletRequest request,
            @PathVariable Long paymentId) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            
            PaymentDetailVO detail = paymentService.getPaymentDetail(paymentId, memberId);
            
            return CommonResult.success(detail);
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Get payment detail failed for paymentId: " + paymentId, e);
            return CommonResult.failed("获取支付详情失败");
        }
    }
    
    @GetMapping("/statistics")
    @ApiOperation("获取支付统计")
    public CommonResult<PaymentStatisticsVO> getPaymentStatistics(
            HttpServletRequest request,
            @RequestParam(defaultValue = "30") Integer days) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            
            PaymentStatisticsVO statistics = paymentService.getPaymentStatistics(memberId, days);
            
            return CommonResult.success(statistics);
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Get payment statistics failed", e);
            return CommonResult.failed("获取支付统计失败");
        }
    }
    
    private Long getCurrentMemberId(HttpServletRequest request) {
        String token = extractTokenFromRequest(request);
        if (!StringUtils.hasText(token)) {
            throw new BusinessException("未登录");
        }
        
        return JwtUtils.getMemberIdFromToken(token);
    }
    
    private String extractTokenFromRequest(HttpServletRequest request) {
        String authHeader = request.getHeader("Authorization");
        if (StringUtils.hasText(authHeader) && authHeader.startsWith("Bearer ")) {
            return authHeader.substring(7);
        }
        return null;
    }
}
```

#### 2.3.2 管理员支付接口
```java
// AdminPaymentController.java
@RestController
@RequestMapping("/api/admin/payment")
@Validated
@Slf4j
public class AdminPaymentController {
    
    @Autowired
    private PaymentService paymentService;
    
    @GetMapping("/orders")
    @ApiOperation("获取支付订单列表")
    @PreAuthorize("hasRole('ADMIN')")
    public CommonResult<CommonPage<PaymentOrderVO>> getPaymentOrders(
            @RequestParam(defaultValue = "1") Integer pageNum,
            @RequestParam(defaultValue = "20") Integer pageSize,
            @RequestParam(required = false) Integer paymentStatus,
            @RequestParam(required = false) String orderSn,
            @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate startDate,
            @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate endDate) {
        
        try {
            PaymentOrderQuery query = new PaymentOrderQuery();
            query.setPageNum(pageNum);
            query.setPageSize(pageSize);
            query.setPaymentStatus(paymentStatus);
            query.setOrderSn(orderSn);
            query.setStartDate(startDate);
            query.setEndDate(endDate);
            
            CommonPage<PaymentOrderVO> orders = paymentService.getAdminPaymentOrders(query);
            
            return CommonResult.success(orders);
            
        } catch (Exception e) {
            log.error("Get admin payment orders failed", e);
            return CommonResult.failed("获取支付订单失败");
        }
    }
    
    @PostMapping("/refund/approve/{refundId}")
    @ApiOperation("审批退款")
    @PreAuthorize("hasRole('ADMIN')")
    public CommonResult<String> approveRefund(
            @PathVariable Long refundId,
            @RequestBody Map<String, Object> params) {
        
        try {
            Boolean approved = (Boolean) params.get("approved");
            String reason = (String) params.get("reason");
            
            boolean success = paymentService.processRefundApproval(refundId, approved, reason);
            
            if (success) {
                return CommonResult.success(approved ? "退款已批准" : "退款已拒绝");
            } else {
                return CommonResult.failed("处理退款审批失败");
            }
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Approve refund failed for refundId: " + refundId, e);
            return CommonResult.failed("处理退款审批失败");
        }
    }
    
    @GetMapping("/statistics/dashboard")
    @ApiOperation("获取支付统计仪表盘")
    @PreAuthorize("hasRole('ADMIN')")
    public CommonResult<PaymentDashboardVO> getPaymentDashboard(
            @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate startDate,
            @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate endDate) {
        
        try {
            if (startDate == null) startDate = LocalDate.now().minusDays(30);
            if (endDate == null) endDate = LocalDate.now();
            
            PaymentDashboardVO dashboard = paymentService.getPaymentDashboard(startDate, endDate);
            
            return CommonResult.success(dashboard);
            
        } catch (Exception e) {
            log.error("Get payment dashboard failed", e);
            return CommonResult.failed("获取支付统计失败");
        }
    }
}
```

**验收标准**:
- [x] 支付记录查询功能完整
- [x] 管理员权限控制正确
- [x] 统计数据准确详细
- [x] 退款审批流程规范

## 交付物
- [x] 完整的支付API控制器
- [x] 支付回调处理接口
- [x] 支付记录管理接口
- [x] 管理员支付管理接口

## 验证测试
1. 测试支付订单创建
2. 验证支付回调处理
3. 测试支付状态查询
4. 检查退款流程
5. 验证管理员功能

## 风险控制
- **权限安全**: 严格的订单归属权验证
- **签名验证**: 支付回调签名安全验证
- **幂等性**: 防止重复处理和重复支付

## 下一步
完成后进入 `05-3-前端支付集成`