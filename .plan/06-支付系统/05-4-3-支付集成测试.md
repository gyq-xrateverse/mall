# 05-4-3: 支付集成测试

## 任务概述
**时间估算**: 45-60分钟  
**优先级**: 最高  
**依赖关系**: 05-4-2-支付性能测试 完成

## 详细任务清单

### 1. 前后端集成测试
- [ ] 前端支付流程与后端API集成测试
- [ ] 支付状态轮询机制验证
- [ ] 支付页面状态同步测试
- [ ] 支付结果页面集成测试

### 2. 支付与业务系统集成测试
- [ ] 套餐支付成功后自动激活测试
- [ ] 积分充值支付后积分增加验证
- [ ] 支付失败不影响业务状态测试
- [ ] 支付与订单状态同步测试

### 3. 第三方支付集成测试
- [ ] 支付宝沙箱环境集成测试
- [ ] 支付回调接收和处理测试
- [ ] 支付签名验证集成测试
- [ ] 支付异常情况处理测试

### 4. 数据一致性测试
- [ ] 支付状态与订单状态一致性
- [ ] 支付记录与业务数据一致性
- [ ] 分布式事务一致性测试
- [ ] 数据回滚和恢复测试

## 验收标准
- [ ] 前后端数据同步正确
- [ ] 业务系统集成正常
- [ ] 状态变更准确及时
- [ ] 异常情况处理正确
- [ ] 数据一致性保证

## 交付物
- [ ] 前后端集成测试报告
- [ ] 业务系统集成验证文档
- [ ] 第三方支付集成测试结果
- [ ] 数据一致性测试报告

## 技术要点

### 前后端集成测试
```typescript
// 前端支付流程集成测试
describe('前后端支付集成测试', () => {
  it('应该完整支持支付流程', async () => {
    // 渲染支付页面
    const orderData = {
      id: 123,
      orderSn: 'TEST_ORDER_123',
      payAmount: 29.90,
      business_type: 1 // 套餐订阅
    };
    
    const { getByText, getByRole } = render(
      <PaymentPage />, 
      {
        initialState: { location: { state: { orderData } } }
      }
    );
    
    // 选择支付方式
    const alipayOption = getByText('支付宝');
    fireEvent.click(alipayOption);
    
    // 确认支付
    const confirmButton = getByText('确认支付');
    fireEvent.click(confirmButton);
    
    // 等待支付订单创建
    await waitFor(() => {
      expect(getByText('正在等待支付')).toBeInTheDocument();
    });
    
    // 模拟支付成功
    mockPaymentSuccess(orderData.orderSn);
    
    // 等待支付成功页面
    await waitFor(() => {
      expect(getByText('支付成功')).toBeInTheDocument();
    }, { timeout: 10000 });
  });
});
```

### 业务系统集成测试
```typescript
describe('支付与业务系统集成测试', () => {
  it('套餐支付成功后应自动激活', async () => {
    const memberId = 1001;
    const planId = 2; // 标准月套餐
    
    // 创建套餐订单
    const subscriptionOrder = await createSubscriptionOrder(memberId, planId);
    
    // 创建支付订单
    const paymentOrder = await createPaymentOrder(subscriptionOrder.id, 'alipay');
    
    // 模拟支付成功
    await simulatePaymentSuccess(paymentOrder.orderSn, paymentOrder.amount);
    
    // 验证套餐激活
    const subscription = await getUserSubscription(memberId);
    expect(subscription.subscriptionLevel).toBe(2);
    expect(subscription.subscriptionStatus).toBe(1);
    expect(subscription.dailyCreditsLimit).toBe(1200);
    
    // 验证用户权限
    const hasAdvancedAI = await checkPermission(memberId, 'advanced_ai');
    expect(hasAdvancedAI).toBe(true);
  });
  
  it('积分充值支付成功后应增加积分', async () => {
    const memberId = 1002;
    const creditProductId = 5; // 1000积分包
    
    // 获取充值前积分
    const initialCredits = await getUserCredits(memberId);
    
    // 创建积分充值订单
    const creditOrder = await createCreditOrder(memberId, creditProductId);
    
    // 创建支付订单并完成支付
    const paymentOrder = await createPaymentOrder(creditOrder.id, 'alipay');
    await simulatePaymentSuccess(paymentOrder.orderSn, paymentOrder.amount);
    
    // 验证积分增加
    const finalCredits = await getUserCredits(memberId);
    expect(finalCredits.totalCredits).toBe(initialCredits.totalCredits + 1000);
    
    // 验证积分历史记录
    const history = await getCreditsHistory(memberId);
    const latestRecord = history[0];
    expect(latestRecord.changeType).toBe(0); // 增加
    expect(latestRecord.changeAmount).toBe(1000);
    expect(latestRecord.businessId).toBe(creditOrder.id.toString());
  });
  
  it('支付失败不应影响业务状态', async () => {
    const memberId = 1003;
    const planId = 3;
    
    // 记录初始状态
    const initialSubscription = await getUserSubscription(memberId);
    const initialCredits = await getUserCredits(memberId);
    
    // 创建订单并模拟支付失败
    const order = await createSubscriptionOrder(memberId, planId);
    const paymentOrder = await createPaymentOrder(order.id, 'alipay');
    await simulatePaymentFailure(paymentOrder.orderSn);
    
    // 验证状态没有改变
    const finalSubscription = await getUserSubscription(memberId);
    const finalCredits = await getUserCredits(memberId);
    
    expect(finalSubscription).toEqual(initialSubscription);
    expect(finalCredits).toEqual(initialCredits);
  });
});
```

### 支付轮询机制测试
```typescript
it('支付状态轮询应该正常工作', async () => {
  const mockOrderSn = 'TEST_POLLING';
  let callCount = 0;
  
  // Mock API响应
  server.use(
    rest.get(`/api/payment/status/${mockOrderSn}`, (req, res, ctx) => {
      callCount++;
      
      // 前几次返回待支付状态
      if (callCount < 3) {
        return res(ctx.json({
          code: 200,
          data: {
            orderSn: mockOrderSn,
            paymentStatus: 0, // 待支付
            amount: 29.90
          }
        }));
      }
      
      // 第3次返回支付成功
      return res(ctx.json({
        code: 200,
        data: {
          orderSn: mockOrderSn,
          paymentStatus: 1, // 支付成功
          amount: 29.90,
          transactionId: 'ALIPAY_SUCCESS'
        }
      }));
    })
  );
  
  const { result } = renderHook(() => 
    usePaymentPolling(mockOrderSn, {
      onSuccess: jest.fn(),
      interval: 1000
    })
  );
  
  // 等待轮询完成
  await waitFor(() => {
    expect(result.current.paymentStatus?.paymentStatus).toBe(1);
  }, { timeout: 5000 });
  
  expect(callCount).toBeGreaterThanOrEqual(3);
});
```

### 数据一致性测试
```java
@Test
@Transactional
public void testPaymentDataConsistency() {
    // 创建订单
    OmsOrder order = createTestOrder();
    Long orderId = order.getId();
    
    // 创建支付记录
    OmsOrderPayment payment = createPaymentRecord(orderId);
    
    try {
        // 模拟支付成功处理
        paymentService.handlePaymentSuccess(
            order.getOrderSn(),
            "TEST_TRANSACTION_" + System.currentTimeMillis(),
            order.getPayAmount()
        );
        
        // 验证订单状态更新
        OmsOrder updatedOrder = orderService.getOrderById(orderId);
        assertEquals("Order status should be paid", Integer.valueOf(1), updatedOrder.getStatus());
        assertNotNull("Payment time should be set", updatedOrder.getPaymentTime());
        
        // 验证支付记录状态
        OmsOrderPayment updatedPayment = paymentService.getPaymentByOrderId(orderId);
        assertEquals("Payment status should be success", Integer.valueOf(1), updatedPayment.getStatus());
        assertEquals("Callback status should be processed", Integer.valueOf(1), updatedPayment.getCallbackStatus());
        
        // 验证业务状态（如套餐激活）
        if (order.getOrderType() == 1) {
            UmsMember member = memberService.getMemberById(order.getMemberId());
            assertNotNull("Subscription should be activated", member.getCurrentSubscriptionId());
            assertTrue("Subscription level should be updated", member.getSubscriptionLevel() > 0);
        }
        
    } catch (Exception e) {
        fail("Payment processing should not fail: " + e.getMessage());
    }
}
```

## 下一步
完成后继续 `05-4-4-支付压力测试`