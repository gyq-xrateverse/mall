# 05-4-2: 支付性能测试

## 任务概述
**时间估算**: 45-60分钟  
**优先级**: 高  
**依赖关系**: 05-4-1-支付功能测试 完成

## 详细任务清单

### 1. 并发支付测试
- [ ] 多用户同时创建支付订单测试
- [ ] 并发支付处理能力验证
- [ ] 数据库连接池性能测试
- [ ] 系统资源使用监控

### 2. 支付回调处理性能测试
- [ ] 高并发回调处理测试
- [ ] 回调处理响应时间测试
- [ ] 分布式锁性能验证
- [ ] 事件发布机制性能

### 3. 支付状态查询性能测试
- [ ] 大数据量支付记录查询性能
- [ ] 复杂条件查询优化验证
- [ ] 数据库索引效果测试
- [ ] 缓存机制性能测试

### 4. 系统资源监控测试
- [ ] 内存使用情况监控
- [ ] CPU使用率监控
- [ ] 数据库连接数监控
- [ ] 网络I/O性能监控

## 验收标准
- [ ] 并发支付处理正常（支持50+TPS）
- [ ] 回调处理性能达标（<200ms）
- [ ] 查询性能满足要求（<100ms）
- [ ] 系统资源使用合理（内存<500MB增长）
- [ ] 无内存泄漏和资源回收正常

## 交付物
- [ ] 并发支付测试报告
- [ ] 回调处理性能测试数据
- [ ] 数据库查询性能分析
- [ ] 系统资源使用报告

## 技术要点

### 并发支付测试实现
```java
@Test
public void testConcurrentPaymentCreation() {
    int threadCount = 20;
    CountDownLatch latch = new CountDownLatch(threadCount);
    AtomicInteger successCount = new AtomicInteger(0);
    AtomicInteger failureCount = new AtomicInteger(0);
    
    for (int i = 0; i < threadCount; i++) {
        final int index = i;
        executor.submit(() -> {
            try {
                // 创建不同用户的不同订单
                Long memberId = (long) (1000 + index);
                Long orderId = (long) (2000 + index);
                
                PaymentOrderVO result = paymentService.createPaymentOrder(
                    orderId, "alipay"
                );
                
                if (result != null) {
                    successCount.incrementAndGet();
                }
                
            } catch (Exception e) {
                failureCount.incrementAndGet();
                log.error("Concurrent payment creation failed: {}", e.getMessage());
            } finally {
                latch.countDown();
            }
        });
    }
    
    latch.await();
    
    // 验证结果
    assertTrue("Most payments should succeed", successCount.get() >= threadCount * 0.9);
    assertTrue("Failure rate should be low", failureCount.get() <= threadCount * 0.1);
}
```

### 回调处理性能测试
```java
@Test
public void testPaymentCallbackPerformance() {
    int callbackCount = 100;
    List<String> orderSns = new ArrayList<>();
    
    // 创建测试订单
    for (int i = 0; i < callbackCount; i++) {
        OmsOrder order = createTestOrder();
        orderSns.add(order.getOrderSn());
    }
    
    long startTime = System.currentTimeMillis();
    
    // 并发处理支付回调
    orderSns.parallelStream().forEach(orderSn -> {
        try {
            paymentService.handlePaymentSuccess(
                orderSn, 
                "ALIPAY_" + System.currentTimeMillis(),
                new BigDecimal("29.90")
            );
        } catch (Exception e) {
            log.error("Payment callback failed for {}: {}", orderSn, e.getMessage());
        }
    });
    
    long endTime = System.currentTimeMillis();
    long avgTime = (endTime - startTime) / callbackCount;
    
    assertTrue("Average callback processing time should be less than 100ms", avgTime < 100);
}
```

### 查询性能测试
```java
@Test
public void testPaymentStatusQueryPerformance() {
    // 创建大量支付记录
    createLargePaymentData(5000);
    
    String testOrderSn = "PERF_TEST_ORDER";
    
    // 执行性能测试
    long startTime = System.currentTimeMillis();
    
    for (int i = 0; i < 1000; i++) {
        paymentService.getPaymentStatus(testOrderSn);
    }
    
    long endTime = System.currentTimeMillis();
    long avgTime = (endTime - startTime) / 1000;
    
    assertTrue("Payment status query should be fast", avgTime < 10); // 平均小于10ms
}
```

### 资源使用监控
```java
@Test
public void testPaymentResourceUsage() {
    Runtime runtime = Runtime.getRuntime();
    
    // 记录初始内存使用
    long initialMemory = runtime.totalMemory() - runtime.freeMemory();
    
    // 执行大量支付操作
    for (int i = 0; i < 10000; i++) {
        try {
            Long orderId = createTestOrder().getId();
            PaymentOrderVO payment = paymentService.createPaymentOrder(orderId, "alipay");
            
            // 模拟支付成功
            paymentService.handlePaymentSuccess(
                payment.getOrderSn(),
                "MEMORY_TEST_" + i,
                payment.getAmount()
            );
            
            if (i % 1000 == 0) {
                // 强制垃圾回收并检查内存使用
                System.gc();
                Thread.sleep(100);
                
                long currentMemory = runtime.totalMemory() - runtime.freeMemory();
                long memoryGrowth = currentMemory - initialMemory;
                
                log.info("After {} payments, memory growth: {} MB", 
                    i, memoryGrowth / 1024 / 1024);
                
                // 内存增长不应该超过500MB
                assertTrue("Memory growth should be reasonable", 
                    memoryGrowth < 500 * 1024 * 1024);
            }
            
        } catch (Exception e) {
            log.error("Payment operation failed in memory test", e);
        }
    }
}
```

## 下一步
完成后继续 `05-4-3-支付集成测试`