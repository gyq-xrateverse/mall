# 05-4-5: 支付端到端测试

## 任务概述
**时间估算**: 45-60分钟  
**优先级**: 最高  
**依赖关系**: 05-4-4-支付压力测试 完成

## 详细任务清单

### 1. 完整用户场景测试
- [ ] 用户完整购买套餐流程测试
- [ ] 用户积分充值完整流程测试
- [ ] 支付失败重试流程测试
- [ ] 支付取消流程测试

### 2. 多端支付测试
- [ ] Web端支付流程测试
- [ ] 移动端支付流程测试
- [ ] 不同浏览器兼容性测试
- [ ] 移动设备适配测试

### 3. 业务场景覆盖测试
- [ ] 不同套餐类型支付测试
- [ ] 不同积分包购买测试
- [ ] 自动续费场景测试
- [ ] 套餐升级降级测试

### 4. 异常恢复测试
- [ ] 网络中断恢复测试
- [ ] 页面刷新状态恢复测试
- [ ] 支付超时处理测试
- [ ] 系统异常恢复测试

## 验收标准
- [ ] 端到端流程顺畅
- [ ] 用户体验良好
- [ ] 业务逻辑正确
- [ ] 数据一致性保证
- [ ] 异常处理完善

## 交付物
- [ ] 端到端测试用例集合
- [ ] 用户场景测试报告
- [ ] 多端兼容性测试报告
- [ ] 异常恢复测试文档

## 技术要点

### 完整套餐购买流程测试
```javascript
describe('端到端支付场景测试', () => {
  it('用户完整购买套餐流程', async () => {
    // 1. 用户登录
    await userLogin('testuser@example.com', 'password');
    
    // 2. 浏览套餐页面
    await navigateToSubscriptionPlans();
    
    // 3. 选择套餐
    await selectSubscriptionPlan('标准月套餐');
    
    // 4. 确认订阅
    await confirmSubscription(false); // 不自动续费
    
    // 5. 跳转到支付页面
    await waitForPaymentPage();
    
    // 6. 选择支付方式
    await selectPaymentMethod('alipay');
    
    // 7. 确认支付
    await confirmPayment();
    
    // 8. 等待支付完成
    await waitForPaymentSuccess();
    
    // 9. 验证套餐激活
    const subscription = await getCurrentUserSubscription();
    expect(subscription.subscriptionLevel).toBe(2);
    expect(subscription.subscriptionStatus).toBe(1);
    
    // 10. 验证权限解锁
    const canUseAdvanced = await checkAdvancedFeatures();
    expect(canUseAdvanced).toBe(true);
  });
  
  it('用户积分充值完整流程', async () => {
    // 1. 用户登录
    await userLogin('testuser2@example.com', 'password');
    
    // 2. 查看当前积分
    const initialCredits = await getCurrentCredits();
    
    // 3. 进入积分充值页面
    await navigateToCreditsPage();
    
    // 4. 选择积分包
    await selectCreditsPackage('基础积分包'); // 1000积分
    
    // 5. 创建订单
    await createCreditsOrder();
    
    // 6. 支付流程
    await selectPaymentMethod('alipay');
    await confirmPayment();
    await waitForPaymentSuccess();
    
    // 7. 验证积分到账
    const finalCredits = await getCurrentCredits();
    expect(finalCredits.totalCredits).toBe(initialCredits.totalCredits + 1000);
    
    // 8. 验证历史记录
    const history = await getCreditsHistory();
    const latestRecord = history[0];
    expect(latestRecord.changeAmount).toBe(1000);
    expect(latestRecord.description).toContain('积分充值');
  });
});
```

### 支付异常处理测试
```javascript
describe('支付异常处理测试', () => {
  it('网络中断后应能恢复支付状态', async () => {
    // 1. 开始支付流程
    await userLogin('testuser@example.com', 'password');
    const orderData = await createTestOrder();
    await navigateToPaymentPage(orderData);
    
    // 2. 选择支付方式并确认
    await selectPaymentMethod('alipay');
    await confirmPayment();
    
    // 3. 模拟网络中断
    await simulateNetworkDisconnection();
    
    // 4. 等待网络恢复
    setTimeout(async () => {
      await restoreNetworkConnection();
    }, 5000);
    
    // 5. 页面应该能够恢复支付状态查询
    await waitFor(() => {
      expect(screen.getByText('正在查询支付状态')).toBeInTheDocument();
    }, { timeout: 10000 });
    
    // 6. 模拟支付成功
    await mockPaymentSuccess(orderData.orderSn);
    
    // 7. 验证最终状态正确
    await waitFor(() => {
      expect(screen.getByText('支付成功')).toBeInTheDocument();
    });
  });
  
  it('页面刷新后应能恢复支付状态', async () => {
    // 1. 开始支付并进入状态监控
    await userLogin('testuser@example.com', 'password');
    const orderData = await createTestOrder();
    await navigateToPaymentPage(orderData);
    await selectPaymentMethod('alipay');
    await confirmPayment();
    
    // 2. 等待进入状态监控页面
    await waitFor(() => {
      expect(screen.getByText('正在等待支付')).toBeInTheDocument();
    });
    
    // 3. 刷新页面
    await page.reload();
    
    // 4. 页面应该能够恢复到支付状态监控
    await waitFor(() => {
      expect(screen.getByText('正在等待支付')).toBeInTheDocument();
    }, { timeout: 5000 });
    
    // 5. 支付状态轮询应该继续工作
    await mockPaymentSuccess(orderData.orderSn);
    
    await waitFor(() => {
      expect(screen.getByText('支付成功')).toBeInTheDocument();
    });
  });
  
  it('支付超时后应提供重试选项', async () => {
    // 1. 开始支付流程
    await userLogin('testuser@example.com', 'password');
    const orderData = await createTestOrder();
    await navigateToPaymentPage(orderData);
    
    // 2. 选择支付方式并确认
    await selectPaymentMethod('alipay');
    await confirmPayment();
    
    // 3. 模拟支付超时（长时间无响应）
    await waitFor(() => {
      expect(screen.getByText('正在等待支付')).toBeInTheDocument();
    });
    
    // 4. 等待足够长的时间触发超时
    await waitFor(() => {
      expect(screen.getByText('支付超时')).toBeInTheDocument();
    }, { timeout: 30000 });
    
    // 5. 应该提供重试按钮
    const retryButton = screen.getByText('重新支付');
    expect(retryButton).toBeInTheDocument();
    
    // 6. 点击重试应该重新开始支付流程
    await fireEvent.click(retryButton);
    
    await waitFor(() => {
      expect(screen.getByText('选择支付方式')).toBeInTheDocument();
    });
  });
});
```

### 多端兼容性测试
```javascript
describe('多端支付兼容性测试', () => {
  const testDevices = [
    { name: 'Desktop Chrome', viewport: { width: 1920, height: 1080 } },
    { name: 'iPad', viewport: { width: 768, height: 1024 } },
    { name: 'iPhone', viewport: { width: 375, height: 667 } },
    { name: 'Android', viewport: { width: 360, height: 640 } }
  ];
  
  testDevices.forEach(device => {
    it(`${device.name}上支付流程应该正常`, async () => {
      // 设置设备视口
      await page.setViewport(device.viewport);
      
      // 执行标准支付流程
      await userLogin('testuser@example.com', 'password');
      const orderData = await createTestOrder();
      await navigateToPaymentPage(orderData);
      
      // 验证页面布局适配
      const paymentContainer = await page.$('.payment-container');
      const isVisible = await paymentContainer.isIntersectingViewport();
      expect(isVisible).toBe(true);
      
      // 选择支付方式
      await selectPaymentMethod('alipay');
      
      // 验证支付按钮可点击
      const confirmButton = await page.$('button:contains("确认支付")');
      const isClickable = await confirmButton.isIntersectingViewport();
      expect(isClickable).toBe(true);
      
      // 确认支付
      await confirmButton.click();
      
      // 验证支付状态页面适配
      await waitFor(() => {
        expect(screen.getByText('正在等待支付')).toBeInTheDocument();
      });
      
      // 模拟支付成功
      await mockPaymentSuccess(orderData.orderSn);
      
      // 验证成功页面适配
      await waitFor(() => {
        expect(screen.getByText('支付成功')).toBeInTheDocument();
      });
    });
  });
  
  it('移动端应该支持二维码支付', async () => {
    await page.setViewport({ width: 375, height: 667 });
    
    await userLogin('testuser@example.com', 'password');
    const orderData = await createTestOrder();
    await navigateToPaymentPage(orderData);
    
    // 移动端选择支付宝应该显示二维码
    await selectPaymentMethod('alipay');
    await confirmPayment();
    
    // 检查是否显示二维码
    const qrCode = await page.$('.qr-code');
    if (qrCode) {
      const isVisible = await qrCode.isIntersectingViewport();
      expect(isVisible).toBe(true);
    }
    
    // 验证移动端支付提示
    const mobileHint = screen.queryByText('请使用支付宝扫码支付');
    if (mobileHint) {
      expect(mobileHint).toBeInTheDocument();
    }
  });
});
```

### 业务场景全覆盖测试
```javascript
describe('业务场景全覆盖测试', () => {
  const subscriptionPlans = [
    { id: 1, name: '基础月套餐', level: 1 },
    { id: 2, name: '标准月套餐', level: 2 },
    { id: 3, name: '专业月套餐', level: 3 },
    { id: 4, name: '企业月套餐', level: 4 }
  ];
  
  subscriptionPlans.forEach(plan => {
    it(`${plan.name}支付流程应该正常`, async () => {
      await userLogin('testuser@example.com', 'password');
      
      // 选择特定套餐
      await navigateToSubscriptionPlans();
      await selectSubscriptionPlan(plan.name);
      await confirmSubscription(false);
      
      // 完成支付
      await waitForPaymentPage();
      await selectPaymentMethod('alipay');
      await confirmPayment();
      await waitForPaymentSuccess();
      
      // 验证套餐激活
      const subscription = await getCurrentUserSubscription();
      expect(subscription.subscriptionLevel).toBe(plan.level);
      expect(subscription.subscriptionStatus).toBe(1);
    });
  });
  
  const creditPackages = [
    { id: 1, name: '基础积分包', amount: 500 },
    { id: 2, name: '标准积分包', amount: 1000 },
    { id: 3, name: '专业积分包', amount: 2000 },
    { id: 4, name: '企业积分包', amount: 5000 }
  ];
  
  creditPackages.forEach(pkg => {
    it(`${pkg.name}充值流程应该正常`, async () => {
      await userLogin('testuser2@example.com', 'password');
      
      const initialCredits = await getCurrentCredits();
      
      // 选择特定积分包
      await navigateToCreditsPage();
      await selectCreditsPackage(pkg.name);
      await createCreditsOrder();
      
      // 完成支付
      await selectPaymentMethod('alipay');
      await confirmPayment();
      await waitForPaymentSuccess();
      
      // 验证积分增加
      const finalCredits = await getCurrentCredits();
      expect(finalCredits.totalCredits).toBe(initialCredits.totalCredits + pkg.amount);
    });
  });
  
  it('自动续费套餐应该正确处理', async () => {
    await userLogin('autorenew@example.com', 'password');
    
    // 选择自动续费套餐
    await navigateToSubscriptionPlans();
    await selectSubscriptionPlan('标准月套餐');
    await confirmSubscription(true); // 启用自动续费
    
    // 完成初次支付
    await waitForPaymentPage();
    await selectPaymentMethod('alipay');
    await confirmPayment();
    await waitForPaymentSuccess();
    
    // 验证自动续费设置
    const subscription = await getCurrentUserSubscription();
    expect(subscription.autoRenew).toBe(true);
    expect(subscription.subscriptionStatus).toBe(1);
    
    // 验证自动续费记录
    const autoRenewConfig = await getAutoRenewConfig(subscription.id);
    expect(autoRenewConfig).toBeDefined();
    expect(autoRenewConfig.status).toBe(1); // 启用状态
  });
});
```

### 数据一致性端到端验证
```javascript
describe('数据一致性端到端验证', () => {
  it('支付成功后所有相关数据应保持一致', async () => {
    const testUser = await createTestUser();
    await userLogin(testUser.email, 'password');
    
    // 记录初始状态
    const initialSubscription = await getUserSubscription(testUser.id);
    const initialCredits = await getUserCredits(testUser.id);
    const initialOrderCount = await getOrderCount(testUser.id);
    
    // 执行套餐购买
    const orderData = await createSubscriptionOrder(testUser.id, 2); // 标准套餐
    await navigateToPaymentPage(orderData);
    await selectPaymentMethod('alipay');
    await confirmPayment();
    await waitForPaymentSuccess();
    
    // 验证数据一致性
    const finalSubscription = await getUserSubscription(testUser.id);
    const finalCredits = await getUserCredits(testUser.id);
    const finalOrderCount = await getOrderCount(testUser.id);
    const paymentRecord = await getPaymentRecord(orderData.orderSn);
    
    // 订单状态一致
    expect(finalOrderCount).toBe(initialOrderCount + 1);
    expect(paymentRecord.paymentStatus).toBe(1); // 支付成功
    
    // 套餐状态一致
    expect(finalSubscription.subscriptionLevel).toBe(2);
    expect(finalSubscription.subscriptionStatus).toBe(1);
    expect(finalSubscription.currentSubscriptionId).toBe(orderData.id);
    
    // 用户状态同步
    const userInfo = await getUserInfo(testUser.id);
    expect(userInfo.subscriptionLevel).toBe(2);
    expect(userInfo.dailyCreditsLimit).toBeGreaterThan(initialSubscription.dailyCreditsLimit || 0);
    
    // 审计日志完整
    const auditLogs = await getAuditLogs(testUser.id, 'subscription');
    expect(auditLogs.length).toBeGreaterThan(0);
    expect(auditLogs[0].action).toBe('subscription_activated');
  });
});
```

## 下一步
所有支付系统测试模块完成，形成完整的测试体系