# 05-2-1: 支付控制器实现

## 任务概述
**时间估算**: 45分钟  
**优先级**: 高  
**依赖关系**: 05-1-3-支付回调处理完成  
**技术栈**: Java/Spring Boot, REST API, JWT认证  

## 详细任务清单

### 1. DTO数据传输对象
- [ ] 创建CreatePaymentRequest支付创建请求DTO
- [ ] 创建PaymentOrderVO支付订单响应DTO
- [ ] 创建PaymentStatusVO支付状态响应DTO
- [ ] 创建RefundRequest退款请求DTO
- [ ] 创建RefundResultVO退款结果响应DTO

### 2. 核心支付接口
- [ ] 实现createPayment创建支付订单接口
- [ ] 实现getPaymentStatus查询支付状态接口
- [ ] 实现cancelPayment取消支付接口
- [ ] 实现requestRefund申请退款接口
- [ ] 实现getPaymentMethods获取支付方式接口

### 3. 权限验证机制
- [ ] 实现JWT token验证
- [ ] 验证订单归属权限
- [ ] 检查订单状态有效性
- [ ] 实现用户身份识别
- [ ] 添加操作权限检查

### 4. 异常处理和日志
- [ ] 实现统一异常处理
- [ ] 添加详细操作日志
- [ ] 实现参数验证
- [ ] 添加错误码和错误信息
- [ ] 实现响应格式统一

## 核心代码实现

### 数据传输对象
```java
// CreatePaymentRequest.java - 支付创建请求
@Data
public class CreatePaymentRequest {
    @NotNull(message = "订单ID不能为空")
    private Long orderId;
    
    @NotBlank(message = "支付方式不能为空")
    private String paymentMethod; // alipay, wechat, etc.
    
    private String clientType = "web"; // web, mobile, app
}

// PaymentOrderVO.java - 支付订单响应
@Data
public class PaymentOrderVO {
    private Long orderId;
    private String orderSn;
    private BigDecimal amount;
    private String paymentMethod;
    private String paymentScene;
    private String paymentUrl;      // 支付跳转URL
    private String qrCodeUrl;      // 二维码URL(移动支付)
    private Date expireTime;       // 支付过期时间
    private String paymentId;      // 支付平台订单号
}

// PaymentStatusVO.java - 支付状态响应
@Data
public class PaymentStatusVO {
    private String orderSn;
    private Integer paymentStatus; // 0-待支付, 1-支付成功, 2-支付失败, 3-已取消
    private BigDecimal amount;
    private String paymentMethod;
    private Date paymentTime;
    private String transactionId;
    private String failureReason;
}

// RefundRequest.java - 退款请求
@Data
public class RefundRequest {
    @NotNull(message = "订单ID不能为空")
    private Long orderId;
    
    @NotNull(message = "退款金额不能为空")
    @DecimalMin(value = "0.01", message = "退款金额必须大于0")
    private BigDecimal refundAmount;
    
    @NotBlank(message = "退款原因不能为空")
    private String refundReason;
}
```

### PaymentController.java
```java
@RestController
@RequestMapping("/api/payment")
@Validated
@Slf4j
public class PaymentController {
    
    @Autowired
    private PaymentService paymentService;
    
    @Autowired
    private OmsOrderService orderService;
    
    @PostMapping("/create")
    @ApiOperation("创建支付订单")
    public CommonResult<PaymentOrderVO> createPayment(
            HttpServletRequest request,
            @Valid @RequestBody CreatePaymentRequest paymentRequest) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            
            // 验证订单归属
            OmsOrder order = orderService.getOrderById(paymentRequest.getOrderId());
            if (order == null) {
                return CommonResult.failed("订单不存在");
            }
            
            if (!order.getMemberId().equals(memberId)) {
                return CommonResult.failed("无权限操作此订单");
            }
            
            if (order.getStatus() != 0) {
                return CommonResult.failed("订单状态不正确");
            }
            
            // 创建支付订单
            PaymentOrderVO paymentOrder = paymentService.createPaymentOrder(
                paymentRequest.getOrderId(),
                paymentRequest.getPaymentMethod()
            );
            
            return CommonResult.success(paymentOrder, "支付订单创建成功");
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Create payment failed", e);
            return CommonResult.failed("创建支付订单失败");
        }
    }
    
    @GetMapping("/status/{orderSn}")
    @ApiOperation("查询支付状态")
    public CommonResult<PaymentStatusVO> getPaymentStatus(
            HttpServletRequest request,
            @PathVariable String orderSn) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            
            // 验证订单归属权限
            OmsOrder order = orderService.getOrderByOrderSn(orderSn);
            if (order == null) {
                return CommonResult.failed("订单不存在");
            }
            
            if (!order.getMemberId().equals(memberId)) {
                return CommonResult.failed("无权限查询此订单");
            }
            
            PaymentStatusVO status = paymentService.getPaymentStatus(orderSn);
            return CommonResult.success(status);
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Get payment status failed for orderSn: " + orderSn, e);
            return CommonResult.failed("查询支付状态失败");
        }
    }
    
    @PostMapping("/cancel/{orderSn}")
    @ApiOperation("取消支付")
    public CommonResult<String> cancelPayment(
            HttpServletRequest request,
            @PathVariable String orderSn) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            
            // 验证订单归属权限
            OmsOrder order = orderService.getOrderByOrderSn(orderSn);
            if (order == null) {
                return CommonResult.failed("订单不存在");
            }
            
            if (!order.getMemberId().equals(memberId)) {
                return CommonResult.failed("无权限操作此订单");
            }
            
            boolean success = paymentService.cancelPayment(orderSn);
            
            if (success) {
                return CommonResult.success("支付已取消");
            } else {
                return CommonResult.failed("取消支付失败");
            }
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Cancel payment failed for orderSn: " + orderSn, e);
            return CommonResult.failed("取消支付失败");
        }
    }
    
    @PostMapping("/refund")
    @ApiOperation("申请退款")
    public CommonResult<RefundResultVO> requestRefund(
            HttpServletRequest request,
            @Valid @RequestBody RefundRequest refundRequest) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            
            // 验证订单归属权限
            OmsOrder order = orderService.getOrderById(refundRequest.getOrderId());
            if (order == null) {
                return CommonResult.failed("订单不存在");
            }
            
            if (!order.getMemberId().equals(memberId)) {
                return CommonResult.failed("无权限操作此订单");
            }
            
            if (order.getStatus() != 1) {
                return CommonResult.failed("订单状态不支持退款");
            }
            
            RefundResultVO result = paymentService.refundOrder(
                refundRequest.getOrderId(),
                refundRequest.getRefundAmount(),
                refundRequest.getRefundReason()
            );
            
            return CommonResult.success(result, "退款申请提交成功");
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Request refund failed", e);
            return CommonResult.failed("申请退款失败");
        }
    }
    
    @GetMapping("/methods")
    @ApiOperation("获取支付方式列表")
    public CommonResult<List<PaymentMethodVO>> getPaymentMethods() {
        try {
            List<PaymentMethodVO> methods = paymentService.getAvailablePaymentMethods();
            return CommonResult.success(methods);
            
        } catch (Exception e) {
            log.error("Get payment methods failed", e);
            return CommonResult.failed("获取支付方式失败");
        }
    }
    
    private Long getCurrentMemberId(HttpServletRequest request) {
        String token = extractTokenFromRequest(request);
        if (!StringUtils.hasText(token)) {
            throw new BusinessException("未登录");
        }
        
        return JwtUtils.getMemberIdFromToken(token);
    }
    
    private String extractTokenFromRequest(HttpServletRequest request) {
        String authHeader = request.getHeader("Authorization");
        if (StringUtils.hasText(authHeader) && authHeader.startsWith("Bearer ")) {
            return authHeader.substring(7);
        }
        return null;
    }
}
```

## 验收标准
1. **API功能完整性**: 所有支付相关接口正常工作
2. **权限验证准确性**: 100%验证用户操作权限
3. **参数验证有效性**: 所有输入参数正确验证
4. **异常处理完善性**: 所有异常情况正确处理
5. **响应格式统一性**: 所有接口返回格式一致

## 交付物
- [x] CreatePaymentRequest.java 支付创建请求DTO
- [x] PaymentOrderVO.java 支付订单响应DTO
- [x] PaymentStatusVO.java 支付状态响应DTO
- [x] RefundRequest.java 退款请求DTO
- [x] PaymentController.java 支付控制器

## 技术要点
1. **RESTful API设计**: 符合REST规范的API设计
2. **权限验证**: JWT token验证和订单归属验证
3. **参数验证**: JSR-303注解验证请求参数
4. **异常处理**: 统一的异常处理和错误响应
5. **日志记录**: 详细的操作日志和错误日志

## 测试检查点
- [ ] 创建支付订单接口测试
- [ ] 查询支付状态接口测试
- [ ] 取消支付接口测试
- [ ] 申请退款接口测试
- [ ] 获取支付方式接口测试
- [ ] 权限验证功能测试
- [ ] 参数验证功能测试
- [ ] 异常处理测试

## 下一步
完成后进入 `05-2-2-支付回调控制器`，实现支付宝等第三方支付平台的回调接口。