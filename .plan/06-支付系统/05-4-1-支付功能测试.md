# 05-4-1: 支付功能测试

## 任务概述
**时间估算**: 30-45分钟  
**优先级**: 最高  
**依赖关系**: 05-3-3-支付组件开发 完成

## 详细任务清单

### 1. 支付流程测试
- [ ] 完整支付流程端到端测试
- [ ] 支付订单创建验证
- [ ] 支付成功业务逻辑处理
- [ ] 支付失败情况处理

### 2. 支付安全测试  
- [ ] 支付回调签名验证测试
- [ ] 支付金额篡改防护测试
- [ ] 重复支付回调防护测试
- [ ] 支付请求防重放攻击

### 3. 支付权限测试
- [ ] 订单归属权限验证
- [ ] 支付状态权限检查
- [ ] 跨用户支付防护测试
- [ ] 管理员权限测试

### 4. 支付异常测试
- [ ] 网络异常情况处理
- [ ] 支付超时处理
- [ ] 支付取消流程
- [ ] 系统异常恢复

## 验收标准
- [ ] 所有功能测试用例通过
- [ ] 支付安全机制有效
- [ ] 权限验证准确
- [ ] 异常处理完善
- [ ] 测试覆盖率达到95%以上

## 交付物
- [ ] 完整的支付流程测试用例
- [ ] 支付安全测试报告
- [ ] 权限测试验证文档
- [ ] 异常场景测试结果

## 技术要点

### 测试框架配置
```javascript
// 测试用例：完整支付流程
describe('支付流程测试', () => {
  it('应该正确创建支付订单', async () => {
    // 创建套餐订单
    const subscriptionOrder = await createSubscriptionOrder({
      memberId: testMemberId,
      planId: 1,
      autoRenew: false
    });
    
    // 创建支付订单
    const paymentOrder = await request(app)
      .post('/api/payment/create')
      .set('Authorization', `Bearer ${userToken}`)
      .send({
        orderId: subscriptionOrder.id,
        paymentMethod: 'alipay',
        clientType: 'web'
      })
      .expect(200);
    
    expect(paymentOrder.body.data.paymentUrl).toBeDefined();
    expect(paymentOrder.body.data.amount).toBe(29.90);
    expect(paymentOrder.body.data.paymentMethod).toBe('alipay');
  });
});
```

### 安全测试实现
```javascript
describe('支付安全测试', () => {
  it('应该验证支付回调签名', async () => {
    const invalidParams = {
      out_trade_no: 'TEST_ORDER',
      trade_no: 'FAKE_TRADE',
      total_amount: '100.00',
      trade_status: 'TRADE_SUCCESS',
      sign: 'INVALID_SIGN' // 无效签名
    };
    
    const response = await request(app)
      .post('/api/payment/alipay/notify')
      .send(invalidParams)
      .expect(200);
    
    expect(response.text).toBe('failure');
  });
});
```

### 权限测试验证
```javascript
describe('支付权限测试', () => {
  it('不应该允许操作他人订单', async () => {
    // 用户A的订单
    const orderA = await createOrderForUser(userA.id);
    
    // 用户B尝试为用户A的订单创建支付
    const response = await request(app)
      .post('/api/payment/create')
      .set('Authorization', `Bearer ${userB.token}`)
      .send({
        orderId: orderA.id,
        paymentMethod: 'alipay'
      })
      .expect(400);
    
    expect(response.body.message).toContain('无权限');
  });
});
```

## 下一步
完成后继续 `05-4-2-支付性能测试`