# 05-2-3: 支付管理接口

## 任务概述
**时间估算**: 40分钟  
**优先级**: 中  
**依赖关系**: 05-2-2-支付回调控制器完成  
**技术栈**: Java/Spring Boot, 分页查询, 权限控制  

## 详细任务清单

### 1. 支付记录查询接口
- [ ] 创建PaymentRecordController记录查询控制器
- [ ] 实现getPaymentRecords分页查询接口
- [ ] 实现getPaymentDetail支付详情接口
- [ ] 实现getPaymentStatistics支付统计接口
- [ ] 添加多条件查询支持

### 2. 管理员支付管理
- [ ] 创建AdminPaymentController管理员控制器
- [ ] 实现getPaymentOrders管理员订单查询
- [ ] 实现approveRefund退款审批接口
- [ ] 实现getPaymentDashboard统计仪表盘
- [ ] 添加管理员权限验证

### 3. 查询条件和分页
- [ ] 支持按支付状态筛选
- [ ] 支持按支付方式筛选
- [ ] 支持按时间范围筛选
- [ ] 实现分页参数处理
- [ ] 添加排序功能

### 4. 数据权限控制
- [ ] 用户只能查询自己的支付记录
- [ ] 管理员可以查询所有记录
- [ ] 实现权限注解验证
- [ ] 添加敏感信息脱敏
- [ ] 记录操作日志

## 核心代码实现

### PaymentRecordController.java
```java
@RestController
@RequestMapping("/api/payment/record")
@Validated
@Slf4j
public class PaymentRecordController {
    
    @Autowired
    private PaymentService paymentService;
    
    @GetMapping("/list")
    @ApiOperation("获取支付记录列表")
    public CommonResult<CommonPage<PaymentRecordVO>> getPaymentRecords(
            HttpServletRequest request,
            @RequestParam(defaultValue = "1") Integer pageNum,
            @RequestParam(defaultValue = "10") Integer pageSize,
            @RequestParam(required = false) Integer paymentStatus,
            @RequestParam(required = false) String paymentMethod,
            @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate startDate,
            @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate endDate) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            
            PaymentRecordQuery query = new PaymentRecordQuery();
            query.setMemberId(memberId);
            query.setPageNum(pageNum);
            query.setPageSize(pageSize);
            query.setPaymentStatus(paymentStatus);
            query.setPaymentMethod(paymentMethod);
            query.setStartDate(startDate);
            query.setEndDate(endDate);
            
            CommonPage<PaymentRecordVO> records = paymentService.getPaymentRecords(query);
            
            return CommonResult.success(records);
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Get payment records failed", e);
            return CommonResult.failed("获取支付记录失败");
        }
    }
    
    @GetMapping("/detail/{paymentId}")
    @ApiOperation("获取支付详情")
    public CommonResult<PaymentDetailVO> getPaymentDetail(
            HttpServletRequest request,
            @PathVariable Long paymentId) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            
            PaymentDetailVO detail = paymentService.getPaymentDetail(paymentId, memberId);
            
            return CommonResult.success(detail);
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Get payment detail failed for paymentId: " + paymentId, e);
            return CommonResult.failed("获取支付详情失败");
        }
    }
    
    @GetMapping("/statistics")
    @ApiOperation("获取支付统计")
    public CommonResult<PaymentStatisticsVO> getPaymentStatistics(
            HttpServletRequest request,
            @RequestParam(defaultValue = "30") Integer days) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            
            PaymentStatisticsVO statistics = paymentService.getPaymentStatistics(memberId, days);
            
            return CommonResult.success(statistics);
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Get payment statistics failed", e);
            return CommonResult.failed("获取支付统计失败");
        }
    }
    
    private Long getCurrentMemberId(HttpServletRequest request) {
        String token = extractTokenFromRequest(request);
        if (!StringUtils.hasText(token)) {
            throw new BusinessException("未登录");
        }
        
        return JwtUtils.getMemberIdFromToken(token);
    }
    
    private String extractTokenFromRequest(HttpServletRequest request) {
        String authHeader = request.getHeader("Authorization");
        if (StringUtils.hasText(authHeader) && authHeader.startsWith("Bearer ")) {
            return authHeader.substring(7);
        }
        return null;
    }
}
```

### AdminPaymentController.java
```java
@RestController
@RequestMapping("/api/admin/payment")
@Validated
@Slf4j
public class AdminPaymentController {
    
    @Autowired
    private PaymentService paymentService;
    
    @GetMapping("/orders")
    @ApiOperation("获取支付订单列表")
    @PreAuthorize("hasRole('ADMIN')")
    public CommonResult<CommonPage<PaymentOrderVO>> getPaymentOrders(
            @RequestParam(defaultValue = "1") Integer pageNum,
            @RequestParam(defaultValue = "20") Integer pageSize,
            @RequestParam(required = false) Integer paymentStatus,
            @RequestParam(required = false) String orderSn,
            @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate startDate,
            @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate endDate) {
        
        try {
            PaymentOrderQuery query = new PaymentOrderQuery();
            query.setPageNum(pageNum);
            query.setPageSize(pageSize);
            query.setPaymentStatus(paymentStatus);
            query.setOrderSn(orderSn);
            query.setStartDate(startDate);
            query.setEndDate(endDate);
            
            CommonPage<PaymentOrderVO> orders = paymentService.getAdminPaymentOrders(query);
            
            return CommonResult.success(orders);
            
        } catch (Exception e) {
            log.error("Get admin payment orders failed", e);
            return CommonResult.failed("获取支付订单失败");
        }
    }
    
    @PostMapping("/refund/approve/{refundId}")
    @ApiOperation("审批退款")
    @PreAuthorize("hasRole('ADMIN')")
    public CommonResult<String> approveRefund(
            @PathVariable Long refundId,
            @RequestBody Map<String, Object> params) {
        
        try {
            Boolean approved = (Boolean) params.get("approved");
            String reason = (String) params.get("reason");
            
            boolean success = paymentService.processRefundApproval(refundId, approved, reason);
            
            if (success) {
                return CommonResult.success(approved ? "退款已批准" : "退款已拒绝");
            } else {
                return CommonResult.failed("处理退款审批失败");
            }
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Approve refund failed for refundId: " + refundId, e);
            return CommonResult.failed("处理退款审批失败");
        }
    }
    
    @GetMapping("/statistics/dashboard")
    @ApiOperation("获取支付统计仪表盘")
    @PreAuthorize("hasRole('ADMIN')")
    public CommonResult<PaymentDashboardVO> getPaymentDashboard(
            @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate startDate,
            @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate endDate) {
        
        try {
            if (startDate == null) startDate = LocalDate.now().minusDays(30);
            if (endDate == null) endDate = LocalDate.now();
            
            PaymentDashboardVO dashboard = paymentService.getPaymentDashboard(startDate, endDate);
            
            return CommonResult.success(dashboard);
            
        } catch (Exception e) {
            log.error("Get payment dashboard failed", e);
            return CommonResult.failed("获取支付统计失败");
        }
    }
    
    @GetMapping("/reconciliation")
    @ApiOperation("获取对账数据")
    @PreAuthorize("hasRole('ADMIN')")
    public CommonResult<List<PaymentReconciliationVO>> getReconciliationData(
            @RequestParam @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate date) {
        
        try {
            List<PaymentReconciliationVO> data = paymentService.getReconciliationData(date);
            
            return CommonResult.success(data);
            
        } catch (Exception e) {
            log.error("Get reconciliation data failed for date: " + date, e);
            return CommonResult.failed("获取对账数据失败");
        }
    }
}
```

### 查询对象和响应VO
```java
// PaymentRecordQuery.java
@Data
public class PaymentRecordQuery {
    private Long memberId;
    private Integer pageNum = 1;
    private Integer pageSize = 10;
    private Integer paymentStatus;
    private String paymentMethod;
    private LocalDate startDate;
    private LocalDate endDate;
    private String orderBy = "create_time DESC";
}

// PaymentRecordVO.java
@Data
public class PaymentRecordVO {
    private Long id;
    private String orderSn;
    private BigDecimal amount;
    private String paymentMethod;
    private String paymentScene;
    private Integer paymentStatus;
    private String paymentStatusText;
    private Date paymentTime;
    private String transactionId;
    private String productName;
    private String businessType;
}

// PaymentDetailVO.java
@Data
public class PaymentDetailVO {
    private Long id;
    private String orderSn;
    private BigDecimal amount;
    private String paymentMethod;
    private String paymentScene;
    private Integer paymentStatus;
    private Date createTime;
    private Date paymentTime;
    private String transactionId;
    private String productInfo;
    private String memberInfo;
    private List<PaymentLogVO> logs;
}

// PaymentStatisticsVO.java
@Data
public class PaymentStatisticsVO {
    private BigDecimal totalAmount;
    private Integer totalCount;
    private BigDecimal successAmount;
    private Integer successCount;
    private Double successRate;
    private Map<String, BigDecimal> amountByMethod;
    private Map<String, Integer> countByMethod;
    private List<DailyPaymentVO> dailyData;
}

// PaymentDashboardVO.java
@Data
public class PaymentDashboardVO {
    private BigDecimal todayAmount;
    private Integer todayCount;
    private BigDecimal monthAmount;
    private Integer monthCount;
    private Double conversionRate;
    private List<PaymentTrendVO> trendData;
    private Map<String, Object> methodDistribution;
    private List<TopProductVO> topProducts;
}
```

## 验收标准
1. **查询功能完整性**: 支持多条件查询和分页
2. **权限控制准确性**: 用户和管理员权限正确区分
3. **数据安全性**: 敏感信息正确脱敏
4. **统计准确性**: 统计数据计算正确
5. **性能要求**: 查询响应时间 < 500ms

## 交付物
- [x] PaymentRecordController.java 支付记录查询控制器
- [x] AdminPaymentController.java 管理员支付管理控制器
- [x] PaymentRecordQuery.java 查询条件对象
- [x] PaymentRecordVO.java 支付记录响应对象
- [x] PaymentStatisticsVO.java 支付统计响应对象

## 技术要点
1. **分页查询**: 支持高效的分页和排序
2. **权限控制**: 基于角色的访问控制
3. **数据脱敏**: 敏感信息安全处理
4. **统计计算**: 复杂的统计数据计算
5. **查询优化**: 数据库查询性能优化

## 测试检查点
- [ ] 支付记录列表查询测试
- [ ] 支付详情查询测试
- [ ] 支付统计功能测试
- [ ] 管理员订单查询测试
- [ ] 退款审批功能测试
- [ ] 权限控制功能测试
- [ ] 分页和筛选功能测试
- [ ] 统计数据准确性测试

## 下一步
完成后进入 `05-3-1-支付状态管理`，开始前端支付功能的状态管理实现。