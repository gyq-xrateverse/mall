# 05-1: 支付服务集成

## 任务概述
**时间**: 第1-2天  
**目标**: 集成现有mall支付系统，扩展支持积分和套餐支付  
**优先级**: 最高  
**依赖**: 04-套餐管理系统完成

## 详细任务清单

### 1.1 支付服务扩展

#### 1.1.1 扩展现有支付表结构
```sql
-- 扩展oms_order表支持新的订单类型
ALTER TABLE oms_order ADD COLUMN order_type TINYINT DEFAULT 0 COMMENT '订单类型: 0-普通商品, 1-套餐订单, 2-积分充值订单';
ALTER TABLE oms_order ADD COLUMN business_type TINYINT DEFAULT 0 COMMENT '业务类型: 0-商品购买, 1-套餐订阅, 2-积分充值, 3-套餐续费';

-- 扩展支付记录表
ALTER TABLE oms_order_payment ADD COLUMN payment_scene VARCHAR(32) COMMENT '支付场景: subscription-套餐订阅, credits-积分充值, renewal-套餐续费';
ALTER TABLE oms_order_payment ADD COLUMN callback_status TINYINT DEFAULT 0 COMMENT '回调处理状态: 0-未处理, 1-处理成功, 2-处理失败';
ALTER TABLE oms_order_payment ADD COLUMN callback_retry_count INT DEFAULT 0 COMMENT '回调重试次数';
```

#### 1.1.2 支付服务接口扩展
```java
// PaymentService.java
public interface PaymentService {
    
    /**
     * 创建支付订单 - 扩展支持套餐和积分
     */
    PaymentOrderVO createPaymentOrder(Long orderId, String paymentMethod);
    
    /**
     * 处理支付成功回调
     */
    void handlePaymentSuccess(String orderSn, String transactionId, BigDecimal amount);
    
    /**
     * 处理支付失败回调
     */
    void handlePaymentFailure(String orderSn, String reason);
    
    /**
     * 获取支付状态
     */
    PaymentStatusVO getPaymentStatus(String orderSn);
    
    /**
     * 支付订单退款
     */
    RefundResultVO refundOrder(Long orderId, BigDecimal amount, String reason);
    
    /**
     * 套餐支付成功处理
     */
    void handleSubscriptionPayment(Long orderId);
    
    /**
     * 积分充值支付成功处理
     */
    void handleCreditsPayment(Long orderId);
}
```

#### 1.1.3 支付服务实现扩展
```java
// PaymentServiceImpl.java
@Service
@Transactional
@Slf4j
public class PaymentServiceImpl implements PaymentService {
    
    @Autowired
    private OmsOrderMapper orderMapper;
    
    @Autowired
    private OmsOrderPaymentMapper paymentMapper;
    
    @Autowired
    private AlipayService alipayService;
    
    @Autowired
    private SubscriptionService subscriptionService;
    
    @Autowired
    private CreditsService creditsService;
    
    @Override
    public PaymentOrderVO createPaymentOrder(Long orderId, String paymentMethod) {
        OmsOrder order = orderMapper.selectByPrimaryKey(orderId);
        if (order == null) {
            throw new BusinessException("订单不存在");
        }
        
        if (order.getStatus() != 0) {
            throw new BusinessException("订单状态不正确");
        }
        
        PaymentOrderVO paymentOrder = new PaymentOrderVO();
        paymentOrder.setOrderId(orderId);
        paymentOrder.setOrderSn(order.getOrderSn());
        paymentOrder.setAmount(order.getPayAmount());
        paymentOrder.setPaymentMethod(paymentMethod);
        
        // 根据订单类型设置支付场景
        String paymentScene = determinePaymentScene(order);
        paymentOrder.setPaymentScene(paymentScene);
        
        // 创建支付记录
        OmsOrderPayment payment = new OmsOrderPayment();
        payment.setOrderId(orderId);
        payment.setPaymentMethod(paymentMethod);
        payment.setPaymentScene(paymentScene);
        payment.setAmount(order.getPayAmount());
        payment.setStatus(0); // 待支付
        payment.setCreateTime(new Date());
        
        paymentMapper.insert(payment);
        
        // 调用具体支付渠道
        if ("alipay".equals(paymentMethod)) {
            String payUrl = alipayService.createPayment(order, paymentScene);
            paymentOrder.setPaymentUrl(payUrl);
        }
        // 可以扩展其他支付方式
        
        return paymentOrder;
    }
    
    @Override
    public void handlePaymentSuccess(String orderSn, String transactionId, BigDecimal amount) {
        OmsOrder order = orderMapper.selectByOrderSn(orderSn);
        if (order == null) {
            log.error("Payment callback: Order not found for orderSn: {}", orderSn);
            return;
        }
        
        // 防重复处理
        if (order.getStatus() == 1) {
            log.warn("Order {} already paid", orderSn);
            return;
        }
        
        try {
            // 更新订单状态
            order.setStatus(1); // 已支付
            order.setPaymentTime(new Date());
            orderMapper.updateByPrimaryKey(order);
            
            // 更新支付记录
            OmsOrderPayment payment = paymentMapper.selectByOrderId(order.getId());
            if (payment != null) {
                payment.setStatus(1); // 支付成功
                payment.setTransactionId(transactionId);
                payment.setPayTime(new Date());
                payment.setCallbackStatus(1);
                paymentMapper.updateByPrimaryKey(payment);
            }
            
            // 根据订单类型执行相应的业务逻辑
            handleBusinessLogic(order);
            
            log.info("Payment success processed for order: {}", orderSn);
            
        } catch (Exception e) {
            log.error("Failed to process payment success for order: " + orderSn, e);
            
            // 更新回调状态为失败
            OmsOrderPayment payment = paymentMapper.selectByOrderId(order.getId());
            if (payment != null) {
                payment.setCallbackStatus(2);
                payment.setCallbackRetryCount(payment.getCallbackRetryCount() + 1);
                paymentMapper.updateByPrimaryKey(payment);
            }
            
            throw e;
        }
    }
    
    @Override
    public void handleSubscriptionPayment(Long orderId) {
        OmsOrder order = orderMapper.selectByPrimaryKey(orderId);
        if (order == null || order.getOrderType() != 1) {
            throw new BusinessException("套餐订单不存在");
        }
        
        try {
            // 激活套餐
            LocalDate startDate = LocalDate.now();
            LocalDate endDate = calculateEndDate(order.getProductId(), startDate);
            
            order.setSubscriptionStartDate(startDate);
            order.setSubscriptionEndDate(endDate);
            order.setSubscriptionStatus(1); // 有效
            orderMapper.updateByPrimaryKey(order);
            
            // 更新用户套餐信息
            updateMemberSubscription(order.getMemberId(), order);
            
            log.info("Subscription activated for member: {}, order: {}", 
                order.getMemberId(), orderId);
            
        } catch (Exception e) {
            log.error("Failed to activate subscription for order: " + orderId, e);
            throw new BusinessException("套餐激活失败");
        }
    }
    
    @Override
    public void handleCreditsPayment(Long orderId) {
        OmsOrder order = orderMapper.selectByPrimaryKey(orderId);
        if (order == null || order.getOrderType() != 2) {
            throw new BusinessException("积分充值订单不存在");
        }
        
        try {
            // 获取积分商品信息
            PmsProduct product = productMapper.selectByPrimaryKey(order.getProductId());
            if (product == null || product.getProductType() != 2) {
                throw new BusinessException("积分商品不存在");
            }
            
            // 给用户增加积分
            creditsService.addCredits(
                order.getMemberId(), 
                product.getCreditAmount(), 
                "积分充值 - " + product.getName(), 
                orderId
            );
            
            log.info("Credits added for member: {}, amount: {}, order: {}", 
                order.getMemberId(), product.getCreditAmount(), orderId);
            
        } catch (Exception e) {
            log.error("Failed to add credits for order: " + orderId, e);
            throw new BusinessException("积分充值失败");
        }
    }
    
    private String determinePaymentScene(OmsOrder order) {
        switch (order.getOrderType()) {
            case 1: // 套餐订单
                return order.getBusinessType() == 3 ? "renewal" : "subscription";
            case 2: // 积分充值
                return "credits";
            default:
                return "purchase";
        }
    }
    
    private void handleBusinessLogic(OmsOrder order) {
        switch (order.getOrderType()) {
            case 1: // 套餐订单
                handleSubscriptionPayment(order.getId());
                break;
            case 2: // 积分充值
                handleCreditsPayment(order.getId());
                break;
            default:
                // 普通商品订单处理逻辑
                break;
        }
    }
    
    private LocalDate calculateEndDate(Long productId, LocalDate startDate) {
        PmsProduct product = productMapper.selectByPrimaryKey(productId);
        if (product != null && product.getSubscriptionPeriod() != null) {
            return startDate.plusDays(product.getSubscriptionPeriod());
        }
        return startDate.plusDays(30); // 默认30天
    }
    
    private void updateMemberSubscription(Long memberId, OmsOrder order) {
        UmsMember member = memberMapper.selectByPrimaryKey(memberId);
        if (member != null) {
            member.setCurrentSubscriptionId(order.getId());
            member.setSubscriptionLevel(determineSubscriptionLevel(order.getProductId()));
            member.setDailyCreditsLimit(getDailyCreditsLimit(order.getProductId()));
            member.setSubscriptionEndDate(order.getSubscriptionEndDate());
            memberMapper.updateByPrimaryKey(member);
        }
    }
    
    private Integer determineSubscriptionLevel(Long productId) {
        // 根据产品ID确定套餐等级
        PmsProduct product = productMapper.selectByPrimaryKey(productId);
        if (product != null) {
            String name = product.getName();
            if (name.contains("基础")) return 1;
            if (name.contains("标准")) return 2;
            if (name.contains("专业")) return 3;
            if (name.contains("企业")) return 4;
        }
        return 0;
    }
    
    private Integer getDailyCreditsLimit(Long productId) {
        PmsProduct product = productMapper.selectByPrimaryKey(productId);
        return product != null ? product.getDailyCredits() : 200;
    }
}
```

**验收标准**:
- [x] 支付表结构扩展正确
- [x] 支付服务接口设计完整
- [x] 业务逻辑处理准确
- [x] 支付回调处理可靠

### 1.2 支付宝集成扩展

#### 1.2.1 支付宝服务扩展
```java
// AlipayService.java
@Service
@Slf4j
public class AlipayService {
    
    @Autowired
    private AlipayConfig alipayConfig;
    
    public String createPayment(OmsOrder order, String paymentScene) {
        try {
            AlipayClient alipayClient = new DefaultAlipayClient(
                alipayConfig.getGatewayUrl(),
                alipayConfig.getAppId(),
                alipayConfig.getPrivateKey(),
                "json",
                "UTF-8",
                alipayConfig.getPublicKey(),
                "RSA2"
            );
            
            AlipayTradePagePayRequest request = new AlipayTradePagePayRequest();
            
            // 设置回调地址
            request.setReturnUrl(alipayConfig.getReturnUrl());
            request.setNotifyUrl(alipayConfig.getNotifyUrl());
            
            // 构建支付参数
            Map<String, Object> bizContent = buildBizContent(order, paymentScene);
            request.setBizContent(JSON.toJSONString(bizContent));
            
            AlipayTradePagePayResponse response = alipayClient.pageExecute(request);
            
            if (response.isSuccess()) {
                return response.getBody();
            } else {
                throw new BusinessException("创建支付失败: " + response.getMsg());
            }
            
        } catch (Exception e) {
            log.error("Create alipay payment failed for order: " + order.getId(), e);
            throw new BusinessException("创建支付失败");
        }
    }
    
    private Map<String, Object> buildBizContent(OmsOrder order, String paymentScene) {
        Map<String, Object> bizContent = new HashMap<>();
        
        bizContent.put("out_trade_no", order.getOrderSn());
        bizContent.put("total_amount", order.getPayAmount().toString());
        bizContent.put("timeout_express", "30m");
        
        // 根据支付场景设置商品信息
        switch (paymentScene) {
            case "subscription":
                bizContent.put("subject", "套餐订阅");
                bizContent.put("body", "白鹿AI套餐订阅服务");
                bizContent.put("product_code", "FAST_INSTANT_TRADE_PAY");
                break;
            case "renewal":
                bizContent.put("subject", "套餐续费");
                bizContent.put("body", "白鹿AI套餐续费服务");
                bizContent.put("product_code", "FAST_INSTANT_TRADE_PAY");
                break;
            case "credits":
                bizContent.put("subject", "积分充值");
                bizContent.put("body", "白鹿AI积分充值服务");
                bizContent.put("product_code", "FAST_INSTANT_TRADE_PAY");
                break;
            default:
                bizContent.put("subject", "商品购买");
                bizContent.put("body", "白鹿AI商品购买");
                bizContent.put("product_code", "FAST_INSTANT_TRADE_PAY");
                break;
        }
        
        return bizContent;
    }
    
    public boolean verifyNotify(Map<String, String> params) {
        try {
            return AlipaySignature.rsaCheckV1(
                params, 
                alipayConfig.getPublicKey(), 
                "UTF-8", 
                "RSA2"
            );
        } catch (Exception e) {
            log.error("Verify alipay notify failed", e);
            return false;
        }
    }
}
```

#### 1.2.2 支付配置管理
```java
// AlipayConfig.java
@Data
@Component
@ConfigurationProperties(prefix = "alipay")
public class AlipayConfig {
    
    private String gatewayUrl;
    private String appId;
    private String privateKey;
    private String publicKey;
    private String returnUrl;
    private String notifyUrl;
    
    // 根据环境自动配置
    @PostConstruct
    public void init() {
        String profile = System.getProperty("spring.profiles.active", "dev");
        
        if ("prod".equals(profile)) {
            this.gatewayUrl = "https://openapi.alipay.com/gateway.do";
            this.returnUrl = "https://your-domain.com/payment/alipay/return";
            this.notifyUrl = "https://your-domain.com/payment/alipay/notify";
        } else {
            this.gatewayUrl = "https://openapi.alipaydev.com/gateway.do";
            this.returnUrl = "http://localhost:3000/payment/alipay/return";
            this.notifyUrl = "http://localhost:8080/api/payment/alipay/notify";
        }
        
        log.info("Alipay config initialized for profile: {}", profile);
    }
}
```

**验收标准**:
- [x] 支付宝集成配置正确
- [x] 支付场景区分清晰
- [x] 回调验证安全可靠
- [x] 环境配置自动适配

### 1.3 支付回调处理

#### 1.3.1 支付回调监听器
```java
// PaymentCallbackListener.java
@Component
@Slf4j
public class PaymentCallbackListener {
    
    @Autowired
    private PaymentService paymentService;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @EventListener
    @Async
    public void handlePaymentSuccess(PaymentSuccessEvent event) {
        String lockKey = "payment_callback:" + event.getOrderSn();
        
        try {
            // 使用分布式锁防止重复处理
            Boolean locked = redisTemplate.opsForValue()
                .setIfAbsent(lockKey, "locked", Duration.ofMinutes(5));
            
            if (Boolean.TRUE.equals(locked)) {
                paymentService.handlePaymentSuccess(
                    event.getOrderSn(),
                    event.getTransactionId(),
                    event.getAmount()
                );
                
                log.info("Payment success event processed: {}", event.getOrderSn());
            } else {
                log.warn("Payment callback already processing: {}", event.getOrderSn());
            }
            
        } catch (Exception e) {
            log.error("Failed to process payment success event: " + event.getOrderSn(), e);
            
            // 发送告警通知
            sendAlertNotification(event, e);
            
        } finally {
            redisTemplate.delete(lockKey);
        }
    }
    
    @EventListener
    @Async
    public void handlePaymentFailure(PaymentFailureEvent event) {
        try {
            paymentService.handlePaymentFailure(event.getOrderSn(), event.getReason());
            log.info("Payment failure event processed: {}", event.getOrderSn());
            
        } catch (Exception e) {
            log.error("Failed to process payment failure event: " + event.getOrderSn(), e);
        }
    }
    
    private void sendAlertNotification(PaymentSuccessEvent event, Exception error) {
        // 发送钉钉/企微告警通知
        try {
            Map<String, Object> alertData = new HashMap<>();
            alertData.put("event", "payment_callback_failed");
            alertData.put("orderSn", event.getOrderSn());
            alertData.put("amount", event.getAmount());
            alertData.put("error", error.getMessage());
            alertData.put("timestamp", new Date());
            
            // 这里可以集成告警系统
            log.error("ALERT: Payment callback failed - {}", alertData);
            
        } catch (Exception e) {
            log.error("Failed to send alert notification", e);
        }
    }
}
```

#### 1.3.2 重试机制实现
```java
// PaymentRetryService.java
@Service
@Slf4j
public class PaymentRetryService {
    
    @Autowired
    private OmsOrderPaymentMapper paymentMapper;
    
    @Autowired
    private PaymentService paymentService;
    
    @Scheduled(fixedDelay = 300000) // 每5分钟执行一次
    public void retryFailedCallbacks() {
        List<OmsOrderPayment> failedPayments = paymentMapper.selectFailedCallbacks();
        
        for (OmsOrderPayment payment : failedPayments) {
            if (payment.getCallbackRetryCount() < 3) { // 最多重试3次
                try {
                    retryCallback(payment);
                } catch (Exception e) {
                    log.error("Retry payment callback failed: " + payment.getId(), e);
                }
            } else {
                log.error("Payment callback max retry exceeded: {}", payment.getId());
                // 发送告警或人工处理
            }
        }
    }
    
    private void retryCallback(OmsOrderPayment payment) {
        OmsOrder order = orderMapper.selectByPrimaryKey(payment.getOrderId());
        if (order == null) return;
        
        try {
            paymentService.handlePaymentSuccess(
                order.getOrderSn(),
                payment.getTransactionId(),
                payment.getAmount()
            );
            
            // 更新重试状态
            payment.setCallbackStatus(1);
            payment.setCallbackRetryCount(payment.getCallbackRetryCount() + 1);
            paymentMapper.updateByPrimaryKey(payment);
            
            log.info("Payment callback retry success: {}", payment.getId());
            
        } catch (Exception e) {
            payment.setCallbackRetryCount(payment.getCallbackRetryCount() + 1);
            paymentMapper.updateByPrimaryKey(payment);
            throw e;
        }
    }
}
```

**验收标准**:
- [x] 回调处理幂等性保证
- [x] 异常处理和重试机制
- [x] 分布式锁防重复处理
- [x] 告警通知机制完善

## 交付物
- [x] 扩展后的支付服务
- [x] 支付宝集成配置
- [x] 支付回调处理机制
- [x] 重试和告警机制

## 验证测试
1. 测试套餐支付流程
2. 验证积分充值支付
3. 测试支付回调处理
4. 检查重试机制
5. 验证幂等性保证

## 风险控制
- **数据一致性**: 确保支付和业务状态同步
- **安全性**: 支付回调验证和防篡改
- **可靠性**: 支付失败重试和恢复机制

## 下一步
完成后进入 `05-2-支付API控制器开发`