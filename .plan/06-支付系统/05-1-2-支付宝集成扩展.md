# 05-1-2: 支付宝集成扩展

## 任务概述
**时间估算**: 45分钟  
**优先级**: 高  
**依赖关系**: 05-1-1-支付系统枚举类定义完成  
**技术栈**: Java/Spring Boot, 支付宝SDK  

## 详细任务清单

### 1. 支付宝服务核心实现
- [ ] 创建AlipayService服务类
- [ ] 实现createPayment支付创建方法
- [ ] 实现buildBizContent业务参数构建
- [ ] 实现verifyNotify回调验证方法
- [ ] 支持多种支付场景（套餐订阅、积分充值、续费）

### 2. 支付宝配置管理
- [ ] 创建AlipayConfig配置类
- [ ] 实现环境自动配置（开发/生产）
- [ ] 配置支付宝网关地址和密钥
- [ ] 设置回调地址和通知地址
- [ ] 实现配置初始化方法

### 3. 支付场景区分
- [ ] 实现套餐订阅支付场景
- [ ] 实现套餐续费支付场景  
- [ ] 实现积分充值支付场景
- [ ] 实现普通商品购买场景
- [ ] 为不同场景设置商品描述

### 4. 安全验证机制
- [ ] 实现RSA2签名验证
- [ ] 验证支付回调参数完整性
- [ ] 实现防篡改验证
- [ ] 添加异常处理和日志记录

## 核心代码实现

### AlipayService.java
```java
@Service
@Slf4j
public class AlipayService {
    
    @Autowired
    private AlipayConfig alipayConfig;
    
    public String createPayment(OmsOrder order, String paymentScene) {
        try {
            AlipayClient alipayClient = new DefaultAlipayClient(
                alipayConfig.getGatewayUrl(),
                alipayConfig.getAppId(),
                alipayConfig.getPrivateKey(),
                "json",
                "UTF-8",
                alipayConfig.getPublicKey(),
                "RSA2"
            );
            
            AlipayTradePagePayRequest request = new AlipayTradePagePayRequest();
            
            // 设置回调地址
            request.setReturnUrl(alipayConfig.getReturnUrl());
            request.setNotifyUrl(alipayConfig.getNotifyUrl());
            
            // 构建支付参数
            Map<String, Object> bizContent = buildBizContent(order, paymentScene);
            request.setBizContent(JSON.toJSONString(bizContent));
            
            AlipayTradePagePayResponse response = alipayClient.pageExecute(request);
            
            if (response.isSuccess()) {
                return response.getBody();
            } else {
                throw new BusinessException("创建支付失败: " + response.getMsg());
            }
            
        } catch (Exception e) {
            log.error("Create alipay payment failed for order: " + order.getId(), e);
            throw new BusinessException("创建支付失败");
        }
    }
    
    private Map<String, Object> buildBizContent(OmsOrder order, String paymentScene) {
        Map<String, Object> bizContent = new HashMap<>();
        
        bizContent.put("out_trade_no", order.getOrderSn());
        bizContent.put("total_amount", order.getPayAmount().toString());
        bizContent.put("timeout_express", "30m");
        
        // 根据支付场景设置商品信息
        switch (paymentScene) {
            case "subscription":
                bizContent.put("subject", "套餐订阅");
                bizContent.put("body", "白鹿AI套餐订阅服务");
                bizContent.put("product_code", "FAST_INSTANT_TRADE_PAY");
                break;
            case "renewal":
                bizContent.put("subject", "套餐续费");
                bizContent.put("body", "白鹿AI套餐续费服务");
                bizContent.put("product_code", "FAST_INSTANT_TRADE_PAY");
                break;
            case "credits":
                bizContent.put("subject", "积分充值");
                bizContent.put("body", "白鹿AI积分充值服务");
                bizContent.put("product_code", "FAST_INSTANT_TRADE_PAY");
                break;
            default:
                bizContent.put("subject", "商品购买");
                bizContent.put("body", "白鹿AI商品购买");
                bizContent.put("product_code", "FAST_INSTANT_TRADE_PAY");
                break;
        }
        
        return bizContent;
    }
    
    public boolean verifyNotify(Map<String, String> params) {
        try {
            return AlipaySignature.rsaCheckV1(
                params, 
                alipayConfig.getPublicKey(), 
                "UTF-8", 
                "RSA2"
            );
        } catch (Exception e) {
            log.error("Verify alipay notify failed", e);
            return false;
        }
    }
}
```

### AlipayConfig.java
```java
@Data
@Component
@ConfigurationProperties(prefix = "alipay")
public class AlipayConfig {
    
    private String gatewayUrl;
    private String appId;
    private String privateKey;
    private String publicKey;
    private String returnUrl;
    private String notifyUrl;
    
    // 根据环境自动配置
    @PostConstruct
    public void init() {
        String profile = System.getProperty("spring.profiles.active", "dev");
        
        if ("prod".equals(profile)) {
            this.gatewayUrl = "https://openapi.alipay.com/gateway.do";
            this.returnUrl = "https://your-domain.com/payment/alipay/return";
            this.notifyUrl = "https://your-domain.com/payment/alipay/notify";
        } else {
            this.gatewayUrl = "https://openapi.alipaydev.com/gateway.do";
            this.returnUrl = "http://localhost:3000/payment/alipay/return";
            this.notifyUrl = "http://localhost:8080/api/payment/alipay/notify";
        }
        
        log.info("Alipay config initialized for profile: {}", profile);
    }
}
```

## 验收标准
1. **支付创建成功率**: 100%
2. **支付场景区分**: 正确区分4种支付场景
3. **签名验证**: 100%验证成功
4. **环境配置**: 开发/生产环境自动切换
5. **异常处理**: 完善的错误处理和日志记录

## 交付物
- [x] AlipayService.java 支付服务类
- [x] AlipayConfig.java 配置管理类
- [x] 支付场景区分逻辑
- [x] 签名验证机制
- [x] 环境配置自动化

## 技术要点
1. **支付宝SDK集成**: 使用官方Java SDK
2. **多场景支持**: 支持订阅、续费、充值等场景
3. **安全验证**: RSA2签名验证确保安全
4. **环境适配**: 开发/生产环境自动配置
5. **异常处理**: 完善的错误处理机制

## 测试检查点
- [ ] 支付创建功能测试
- [ ] 签名验证功能测试
- [ ] 多场景支付测试
- [ ] 环境配置切换测试
- [ ] 异常处理测试

## 下一步
完成后进入 `05-1-3-支付回调处理`，实现支付回调的监听和处理机制。