# 05-3-1: 支付状态管理

## 任务概述
**时间估算**: 40分钟  
**优先级**: 高  
**依赖关系**: 05-2-3-支付管理接口完成  
**技术栈**: React/TypeScript, Redux Toolkit, RTK Query  

## 详细任务清单

### 1. 支付状态接口定义
- [ ] 定义PaymentOrder支付订单接口
- [ ] 定义PaymentStatus支付状态接口
- [ ] 定义PaymentRecord支付记录接口
- [ ] 定义PaymentMethod支付方式接口
- [ ] 创建PaymentState状态接口

### 2. Redux Slice创建
- [ ] 创建paymentSlice支付状态切片
- [ ] 定义初始状态initialState
- [ ] 实现同步reducer方法
- [ ] 添加状态清理方法
- [ ] 实现状态更新逻辑

### 3. 异步Actions实现
- [ ] 实现createPaymentOrder创建支付订单
- [ ] 实现fetchPaymentStatus查询支付状态
- [ ] 实现cancelPayment取消支付
- [ ] 实现fetchPaymentMethods获取支付方式
- [ ] 实现fetchPaymentRecords获取支付记录

### 4. 状态管理逻辑
- [ ] 实现加载状态管理
- [ ] 实现错误状态处理
- [ ] 添加支付状态更新
- [ ] 实现状态重置功能
- [ ] 添加缓存机制

## 核心代码实现

### 类型定义
```typescript
// types/payment.ts
export interface PaymentOrder {
  orderId: number;
  orderSn: string;
  amount: number;
  paymentMethod: string;
  paymentScene: string;
  paymentUrl: string;
  qrCodeUrl?: string;
  expireTime: string;
  paymentId: string;
}

export interface PaymentStatus {
  orderSn: string;
  paymentStatus: number; // 0-待支付, 1-支付成功, 2-支付失败, 3-已取消
  amount: number;
  paymentMethod: string;
  paymentTime?: string;
  transactionId?: string;
  failureReason?: string;
}

export interface PaymentRecord {
  id: number;
  orderSn: string;
  amount: number;
  paymentMethod: string;
  paymentScene: string;
  paymentStatus: number;
  paymentTime: string;
  transactionId?: string;
  productName: string;
  businessType: string;
}

export interface PaymentMethod {
  code: string;
  name: string;
  description?: string;
  discount?: number;
  enabled: boolean;
}

export interface PaymentState {
  currentPaymentOrder: PaymentOrder | null;
  paymentStatus: PaymentStatus | null;
  paymentRecords: PaymentRecord[];
  availableMethods: PaymentMethod[];
  loading: boolean;
  createLoading: boolean;
  statusLoading: boolean;
  error: string | null;
}
```

### paymentSlice.ts
```typescript
// store/payment/paymentSlice.ts
import { createSlice, createAsyncThunk } from '@reduxjs/toolkit';
import { paymentAPI } from '@/api/payment';
import type { PaymentState, PaymentOrder, PaymentStatus } from '@/types/payment';

const initialState: PaymentState = {
  currentPaymentOrder: null,
  paymentStatus: null,
  paymentRecords: [],
  availableMethods: [],
  loading: false,
  createLoading: false,
  statusLoading: false,
  error: null,
};

// 创建支付订单
export const createPaymentOrder = createAsyncThunk(
  'payment/createOrder',
  async (params: { orderId: number; paymentMethod: string; clientType?: string }) => {
    const response = await paymentAPI.createPayment(params);
    return response.data;
  }
);

// 查询支付状态
export const fetchPaymentStatus = createAsyncThunk(
  'payment/fetchStatus',
  async (orderSn: string) => {
    const response = await paymentAPI.getPaymentStatus(orderSn);
    return response.data;
  }
);

// 取消支付
export const cancelPayment = createAsyncThunk(
  'payment/cancel',
  async (orderSn: string) => {
    const response = await paymentAPI.cancelPayment(orderSn);
    return response.data;
  }
);

// 获取支付方式
export const fetchPaymentMethods = createAsyncThunk(
  'payment/fetchMethods',
  async () => {
    const response = await paymentAPI.getPaymentMethods();
    return response.data;
  }
);

// 获取支付记录
export const fetchPaymentRecords = createAsyncThunk(
  'payment/fetchRecords',
  async (params: {
    pageNum?: number;
    pageSize?: number;
    paymentStatus?: number;
    paymentMethod?: string;
    startDate?: string;
    endDate?: string;
  }) => {
    const response = await paymentAPI.getPaymentRecords(params);
    return response.data;
  }
);

// 申请退款
export const requestRefund = createAsyncThunk(
  'payment/requestRefund',
  async (params: { orderId: number; refundAmount: number; refundReason: string }) => {
    const response = await paymentAPI.requestRefund(params);
    return response.data;
  }
);

const paymentSlice = createSlice({
  name: 'payment',
  initialState,
  reducers: {
    clearError: (state) => {
      state.error = null;
    },
    
    clearPaymentOrder: (state) => {
      state.currentPaymentOrder = null;
    },
    
    updatePaymentStatus: (state, action) => {
      state.paymentStatus = action.payload;
    },
    
    resetPaymentState: (state) => {
      state.currentPaymentOrder = null;
      state.paymentStatus = null;
      state.error = null;
    },
    
    setLoading: (state, action) => {
      state.loading = action.payload;
    },
  },
  
  extraReducers: (builder) => {
    builder
      // 创建支付订单
      .addCase(createPaymentOrder.pending, (state) => {
        state.createLoading = true;
        state.error = null;
      })
      .addCase(createPaymentOrder.fulfilled, (state, action) => {
        state.createLoading = false;
        state.currentPaymentOrder = action.payload;
      })
      .addCase(createPaymentOrder.rejected, (state, action) => {
        state.createLoading = false;
        state.error = action.error.message || '创建支付订单失败';
      })
      
      // 查询支付状态
      .addCase(fetchPaymentStatus.pending, (state) => {
        state.statusLoading = true;
      })
      .addCase(fetchPaymentStatus.fulfilled, (state, action) => {
        state.statusLoading = false;
        state.paymentStatus = action.payload;
      })
      .addCase(fetchPaymentStatus.rejected, (state, action) => {
        state.statusLoading = false;
        state.error = action.error.message || '查询支付状态失败';
      })
      
      // 取消支付
      .addCase(cancelPayment.pending, (state) => {
        state.loading = true;
      })
      .addCase(cancelPayment.fulfilled, (state) => {
        state.loading = false;
        // 更新支付状态为已取消
        if (state.paymentStatus) {
          state.paymentStatus.paymentStatus = 3;
        }
      })
      .addCase(cancelPayment.rejected, (state, action) => {
        state.loading = false;
        state.error = action.error.message || '取消支付失败';
      })
      
      // 获取支付方式
      .addCase(fetchPaymentMethods.fulfilled, (state, action) => {
        state.availableMethods = action.payload;
      })
      
      // 获取支付记录
      .addCase(fetchPaymentRecords.pending, (state) => {
        state.loading = true;
      })
      .addCase(fetchPaymentRecords.fulfilled, (state, action) => {
        state.loading = false;
        state.paymentRecords = action.payload.list || action.payload;
      })
      .addCase(fetchPaymentRecords.rejected, (state, action) => {
        state.loading = false;
        state.error = action.error.message || '获取支付记录失败';
      })
      
      // 申请退款
      .addCase(requestRefund.pending, (state) => {
        state.loading = true;
      })
      .addCase(requestRefund.fulfilled, (state) => {
        state.loading = false;
      })
      .addCase(requestRefund.rejected, (state, action) => {
        state.loading = false;
        state.error = action.error.message || '申请退款失败';
      });
  },
});

export const {
  clearError,
  clearPaymentOrder,
  updatePaymentStatus,
  resetPaymentState,
  setLoading,
} = paymentSlice.actions;

export default paymentSlice.reducer;
```

### 状态选择器
```typescript
// store/payment/selectors.ts
import { RootState } from '@/store';

export const selectPaymentState = (state: RootState) => state.payment;

export const selectCurrentPaymentOrder = (state: RootState) => 
  state.payment.currentPaymentOrder;

export const selectPaymentStatus = (state: RootState) => 
  state.payment.paymentStatus;

export const selectPaymentRecords = (state: RootState) => 
  state.payment.paymentRecords;

export const selectAvailablePaymentMethods = (state: RootState) => 
  state.payment.availableMethods;

export const selectPaymentLoading = (state: RootState) => ({
  loading: state.payment.loading,
  createLoading: state.payment.createLoading,
  statusLoading: state.payment.statusLoading,
});

export const selectPaymentError = (state: RootState) => 
  state.payment.error;

// 计算属性选择器
export const selectPaymentStatusText = (state: RootState) => {
  const status = state.payment.paymentStatus?.paymentStatus;
  switch (status) {
    case 0: return '待支付';
    case 1: return '支付成功';
    case 2: return '支付失败';
    case 3: return '已取消';
    default: return '未知状态';
  }
};

export const selectIsPaymentPending = (state: RootState) => 
  state.payment.paymentStatus?.paymentStatus === 0;

export const selectIsPaymentSuccess = (state: RootState) => 
  state.payment.paymentStatus?.paymentStatus === 1;

export const selectIsPaymentFailed = (state: RootState) => 
  state.payment.paymentStatus?.paymentStatus === 2;
```

## 验收标准
1. **状态结构合理性**: 状态树结构清晰完整
2. **异步操作处理**: 正确处理loading和error状态
3. **状态更新准确性**: 状态更新逻辑正确
4. **类型安全性**: 完整的TypeScript类型定义
5. **性能优化**: 合理的状态分片和选择器

## 交付物
- [x] paymentSlice.ts 支付状态切片
- [x] payment.ts 支付类型定义
- [x] selectors.ts 状态选择器
- [x] 异步Action实现
- [x] 状态管理逻辑

## 技术要点
1. **Redux Toolkit**: 使用现代Redux状态管理
2. **TypeScript**: 完整的类型安全保证
3. **异步处理**: createAsyncThunk处理异步操作
4. **状态分片**: 合理的状态结构设计
5. **选择器**: 高效的状态选择和计算

## 测试检查点
- [ ] 支付订单创建状态测试
- [ ] 支付状态查询测试
- [ ] 支付取消功能测试
- [ ] 支付方式获取测试
- [ ] 支付记录查询测试
- [ ] 错误状态处理测试
- [ ] 加载状态管理测试
- [ ] 状态重置功能测试

## 下一步
完成后进入 `05-3-2-RTK Query API集成`，实现基于RTK Query的API数据获取和缓存机制。