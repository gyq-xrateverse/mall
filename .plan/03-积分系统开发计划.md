# 第四阶段: 积分系统开发计划

## 阶段概述
**时间周期**: 2周  
**优先级**: 高  
**依赖**: 用户认证系统、首页界面完成  
**目标**: 实现完整的用户积分管理系统，包括积分展示、使用记录、购买功能和变动通知

## 功能需求详细分析

### 核心功能清单
1. **积分余额显示** - 实时显示用户总积分、免费积分、永久积分
2. **积分使用记录** - 详细的积分消费和获得历史
3. **积分购买页面** - 不同积分包的展示和购买
4. **积分商品管理** - 后台管理不同积分商品的价格配置
5. **积分消费逻辑** - 优先使用免费积分，再使用永久积分
6. **积分变动通知** - 实时通知用户积分变动情况
7. **每日积分重置** - 每日免费积分自动重置为200

### 业务规则设计
```
积分系统业务规则：
1. 新用户每日获得200免费积分
2. 免费积分每日0点自动重置，不累积
3. 永久积分可累积，不过期
4. 使用优先级：免费积分 > 永久积分
5. 积分购买立即到账
6. 积分最小购买单位：100积分
7. 积分消费记录永久保存
```

## 数据库设计

### 基于现有mall表结构扩展

#### 复用现有表结构
1. **ums_member.integration** - 作为用户永久积分余额
2. **ums_integration_change_history** - 作为积分变动记录表
3. **pms_product** - 复用现有商品表，积分商品也作为普通商品管理

#### 需要的表结构扩展
```sql
-- 1. 扩展用户表，添加免费积分相关字段
ALTER TABLE ums_member ADD COLUMN free_daily_credits INT DEFAULT 200 COMMENT '每日免费积分';
ALTER TABLE ums_member ADD COLUMN used_today_free INT DEFAULT 0 COMMENT '今日已使用免费积分';
ALTER TABLE ums_member ADD COLUMN last_reset_date DATE COMMENT '最后重置日期';

-- 2. 扩展积分变动记录表，添加积分类型和业务ID
ALTER TABLE ums_integration_change_history ADD COLUMN credit_type TINYINT DEFAULT 2 COMMENT '积分类型: 1-免费积分, 2-永久积分';
ALTER TABLE ums_integration_change_history ADD COLUMN business_id VARCHAR(64) COMMENT '业务ID(如AI任务ID)';

-- 3. 扩展商品表，添加积分商品标识
ALTER TABLE pms_product ADD COLUMN product_type TINYINT DEFAULT 1 COMMENT '商品类型: 1-普通商品, 2-积分商品, 3-套餐商品';
ALTER TABLE pms_product ADD COLUMN credit_amount INT COMMENT '积分数量(积分商品时使用)';

-- 4. 更新积分规则设置表，添加每日免费积分规则
UPDATE ums_member_rule_setting SET 
    continue_sign_day = 1,
    continue_sign_point = 200,
    type = 0 
WHERE id = 1;

-- 如果不存在记录，则插入
INSERT INTO ums_member_rule_setting (continue_sign_day, continue_sign_point, consume_per_point, low_order_amount, max_point_per_order, type)
VALUES (1, 200, 1.00, 0.00, -1, 0)
ON DUPLICATE KEY UPDATE 
    continue_sign_day = 1,
    continue_sign_point = 200;

-- 5. 初始化积分商品数据（使用现有pms_product表）
INSERT INTO pms_product (
    brand_id, product_category_id, name, sub_title, description, price, original_price, stock, unit, weight, sort, gift_growth, gift_point, use_point_limit, product_sn, keywords, publish_status, new_status, recommend_status, verify_status, sale, product_type, credit_amount
) VALUES 
(1, 1, '基础积分包', '1000积分', '适合轻度使用用户，包含1000积分', 9.90, 12.90, 999, '包', 0, 1, 0, 0, 0, 'CREDIT_BASIC_1000', '积分,充值,基础', 1, 1, 0, 1, 0, 2, 1000),
(1, 1, '标准积分包', '3000积分', '适合日常使用用户，包含3000积分', 26.90, 35.90, 999, '包', 0, 2, 0, 0, 0, 'CREDIT_STANDARD_3000', '积分,充值,标准', 1, 1, 1, 1, 0, 2, 3000),
(1, 1, '专业积分包', '6000积分', '适合专业设计师，包含6000积分', 49.90, 69.90, 999, '包', 0, 3, 0, 0, 0, 'CREDIT_PRO_6000', '积分,充值,专业', 1, 1, 1, 1, 0, 2, 6000),
(1, 1, '企业积分包', '15000积分', '适合团队协作，包含15000积分', 119.90, 169.90, 999, '包', 0, 4, 0, 0, 0, 'CREDIT_ENTERPRISE_15000', '积分,充值,企业', 1, 0, 1, 1, 0, 2, 15000),
(1, 1, '旗舰积分包', '30000积分', '无限创作可能，包含30000积分', 219.90, 329.90, 999, '包', 0, 5, 0, 0, 0, 'CREDIT_FLAGSHIP_30000', '积分,充值,旗舰', 1, 1, 1, 1, 0, 2, 30000);
```

### 业务规则说明
1. **永久积分**: 存储在 `ums_member.integration`，购买获得，不过期
2. **免费积分**: 存储在 `ums_member.free_daily_credits`，每日200，当天有效
3. **积分消费优先级**: 优先消费免费积分，再消费永久积分
4. **积分商品**: 在现有商品表中，通过 `product_type=2` 标识
5. **每日重置**: 通过定时任务检查 `last_reset_date`，重置免费积分

## 详细开发任务

### 第1-2天: 后端积分服务开发

#### 1.1 积分服务核心类
```java
// CreditsService.java - 基于现有mall表结构实现
@Service
@Transactional
public class CreditsServiceImpl implements CreditsService {
    
    @Autowired
    private UmsMemberMapper memberMapper;
    
    @Autowired
    private UmsIntegrationChangeHistoryMapper integrationHistoryMapper;
    
    @Autowired
    private UmsMemberRuleSettingMapper ruleSettingMapper;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Override
    public MemberCreditsVO getMemberCredits(Long memberId) {
        // 先检查是否需要重置每日积分
        resetDailyCreditsIfNeeded(memberId);
        
        UmsMember member = memberMapper.selectByPrimaryKey(memberId);
        if (member == null) {
            throw new BusinessException("用户不存在");
        }
        
        // 构建积分信息VO
        MemberCreditsVO creditsVO = new MemberCreditsVO();
        creditsVO.setTotalCredits(member.getIntegration() != null ? member.getIntegration() : 0);
        creditsVO.setFreeCredits(Math.max(0, 
            (member.getFreeDailyCredits() != null ? member.getFreeDailyCredits() : 200) - 
            (member.getUsedTodayFree() != null ? member.getUsedTodayFree() : 0)));
        creditsVO.setUsedTodayTotal(member.getUsedTodayFree() != null ? member.getUsedTodayFree() : 0);
        creditsVO.setLastResetDate(member.getLastResetDate());
        
        return creditsVO;
    }
    
    @Override
    public boolean consumeCredits(Long memberId, int amount, String businessId, String description) {
        UmsMember member = memberMapper.selectByPrimaryKey(memberId);
        if (member == null) {
            throw new BusinessException("用户不存在");
        }
        
        // 先重置每日积分
        resetDailyCreditsIfNeeded(memberId);
        member = memberMapper.selectByPrimaryKey(memberId); // 重新获取最新数据
        
        // 检查积分是否足够
        int totalCredits = (member.getIntegration() != null ? member.getIntegration() : 0);
        int freeCredits = Math.max(0, 
            (member.getFreeDailyCredits() != null ? member.getFreeDailyCredits() : 200) - 
            (member.getUsedTodayFree() != null ? member.getUsedTodayFree() : 0));
        int availableCredits = totalCredits + freeCredits;
        
        if (availableCredits < amount) {
            throw new BusinessException("积分不足");
        }
        
        // 优先使用免费积分
        int remainingAmount = amount;
        int freeCreditsUsed = 0;
        int permanentCreditsUsed = 0;
        
        if (freeCredits > 0) {
            freeCreditsUsed = Math.min(remainingAmount, freeCredits);
            remainingAmount -= freeCreditsUsed;
            
            // 更新已使用免费积分
            member.setUsedTodayFree((member.getUsedTodayFree() != null ? member.getUsedTodayFree() : 0) + freeCreditsUsed);
            
            // 记录免费积分使用
            recordIntegrationHistory(memberId, 1, -freeCreditsUsed, 
                description + " (免费积分)", 0, businessId, (byte) 1);
        }
        
        // 如果还有剩余，使用永久积分
        if (remainingAmount > 0) {
            permanentCreditsUsed = remainingAmount;
            int newIntegration = totalCredits - permanentCreditsUsed;
            member.setIntegration(newIntegration);
            
            // 记录永久积分使用
            recordIntegrationHistory(memberId, 1, -permanentCreditsUsed, 
                description + " (永久积分)", 0, businessId, (byte) 2);
        }
        
        memberMapper.updateByPrimaryKey(member);
        return true;
    }
    
    @Override
    public void addCredits(Long memberId, int amount, String description, Long orderId) {
        UmsMember member = memberMapper.selectByPrimaryKey(memberId);
        if (member == null) {
            throw new BusinessException("用户不存在");
        }
        
        // 增加永久积分
        int currentIntegration = member.getIntegration() != null ? member.getIntegration() : 0;
        member.setIntegration(currentIntegration + amount);
        
        // 更新历史积分总数
        int historyIntegration = member.getHistoryIntegration() != null ? member.getHistoryIntegration() : 0;
        member.setHistoryIntegration(historyIntegration + amount);
        
        memberMapper.updateByPrimaryKey(member);
        
        // 记录积分变动历史
        recordIntegrationHistory(memberId, 0, amount, description, 1, null, (byte) 2);
        
        // 发送积分变动通知
        sendCreditsChangeNotification(memberId, amount, description);
    }
    
    @Override
    @Scheduled(cron = "0 0 0 * * ?") // 每天0点执行
    public void resetDailyCredits() {
        LocalDate today = LocalDate.now();
        
        // 查询需要重置的用户（昨天未重置的用户）
        List<UmsMember> membersToReset = memberMapper.selectMembersForDailyReset(today);
        
        for (UmsMember member : membersToReset) {
            // 重置每日免费积分使用量
            member.setUsedTodayFree(0);
            member.setLastResetDate(Date.valueOf(today));
            memberMapper.updateByPrimaryKey(member);
            
            // 记录每日重置历史
            recordIntegrationHistory(member.getId(), 0, 200, "每日免费积分重置", 1, null, (byte) 1);
        }
        
        log.info("Daily credits reset completed for {} members", membersToReset.size());
    }
    
    private void resetDailyCreditsIfNeeded(Long memberId) {
        UmsMember member = memberMapper.selectByPrimaryKey(memberId);
        if (member != null) {
            LocalDate today = LocalDate.now();
            LocalDate lastReset = member.getLastResetDate() != null ? 
                member.getLastResetDate().toLocalDate() : null;
                
            if (lastReset == null || !lastReset.equals(today)) {
                // 重置每日免费积分
                member.setUsedTodayFree(0);
                member.setLastResetDate(Date.valueOf(today));
                memberMapper.updateByPrimaryKey(member);
                
                // 记录重置历史
                recordIntegrationHistory(memberId, 0, 200, "每日免费积分重置", 1, null, (byte) 1);
            }
        }
    }
    
    private void recordIntegrationHistory(Long memberId, int changeType, int changeCount, 
            String operateNote, int sourceType, String businessId, Byte creditType) {
        
        UmsIntegrationChangeHistory history = new UmsIntegrationChangeHistory();
        history.setMemberId(memberId);
        history.setChangeType(changeType); // 0-增加, 1-减少
        history.setChangeCount(changeCount);
        history.setOperateNote(operateNote);
        history.setSourceType(sourceType); // 0-购物, 1-管理员修改/系统
        history.setBusinessId(businessId);
        history.setCreditType(creditType); // 1-免费积分, 2-永久积分
        history.setCreateTime(new Date());
        
        integrationHistoryMapper.insert(history);
    }
    
    private void sendCreditsChangeNotification(Long memberId, int amount, String description) {
        // 发送积分变动通知
        // 可以通过WebSocket推送给前端实时更新
        // 或者通过消息队列异步处理通知
        log.info("Credits changed for member {}: +{} - {}", memberId, amount, description);
    }
}
```

#### 1.2 积分控制器
```java
// CreditsController.java
@RestController
@RequestMapping("/api/credits")
public class CreditsController {
    
    @Autowired
    private CreditsService creditsService;
    
    @Autowired
    private PmsCreditProductService creditProductService;
    
    @GetMapping("/balance")
    @ApiOperation("获取积分余额")
    public CommonResult<CreditsBalanceVO> getCreditsBalance() {
        Long memberId = getCurrentMemberId();
        UmsMemberCredits credits = creditsService.getMemberCredits(memberId);
        
        CreditsBalanceVO vo = new CreditsBalanceVO();
        vo.setTotalCredits(credits.getTotalCredits());
        vo.setFreeCredits(Math.max(0, credits.getFreeDailyCredits() - credits.getUsedTodayFree()));
        vo.setUsedTodayTotal(credits.getUsedTodayTotal());
        vo.setLastResetDate(credits.getLastResetDate());
        
        return CommonResult.success(vo);
    }
    
    @GetMapping("/history")
    @ApiOperation("获取积分变动历史")
    public CommonResult<CommonPage<CreditsHistoryVO>> getCreditsHistory(
            @RequestParam(defaultValue = "1") Integer pageNum,
            @RequestParam(defaultValue = "20") Integer pageSize) {
        
        Long memberId = getCurrentMemberId();
        PageHelper.startPage(pageNum, pageSize);
        
        // 查询积分变动历史记录
        List<UmsIntegrationChangeHistory> historyList = creditsService.getCreditsHistory(memberId);
        List<CreditsHistoryVO> voList = historyList.stream()
            .map(this::convertToVO)
            .collect(Collectors.toList());
            
        return CommonResult.success(CommonPage.restPage(voList));
    }
    
    @GetMapping("/products")
    @ApiOperation("获取积分商品列表")
    public CommonResult<List<CreditProductVO>> getCreditProducts() {
        // 查询积分商品 (product_type = 2)
        List<PmsProduct> products = productService.listByProductType(2);
        List<CreditProductVO> voList = products.stream()
            .map(this::convertToProductVO)
            .collect(Collectors.toList());
            
        return CommonResult.success(voList);
    }
    
    @PostMapping("/purchase")
    @ApiOperation("购买积分")
    public CommonResult<?> purchaseCredits(@RequestBody PurchaseCreditsRequest request) {
        Long memberId = getCurrentMemberId();
        
        // 获取积分商品信息
        PmsProduct product = productService.getById(request.getProductId());
        if (product == null || product.getProductType() != 2) {
            return CommonResult.failed("积分商品不存在");
        }
        
        // 创建订单 - 复用现有mall订单系统
        OmsOrder order = orderService.generateOrder(memberId, Arrays.asList(product.getId()));
        
        return CommonResult.success(Map.of(
            "orderId", order.getId(),
            "orderSn", order.getOrderSn(),
            "payAmount", order.getPayAmount(),
            "creditAmount", product.getCreditAmount()
        ));
    }
    
    @PostMapping("/consume")
    @ApiOperation("消费积分")
    public CommonResult<?> consumeCredits(@RequestBody ConsumeCreditsRequest request) {
        Long memberId = getCurrentMemberId();
        
        boolean success = creditsService.consumeCredits(
            memberId, 
            request.getAmount(), 
            request.getBusinessId(), 
            request.getDescription()
        );
        
        if (success) {
            return CommonResult.success("积分消费成功");
        } else {
            return CommonResult.failed("积分不足");
        }
    }
    
    private Long getCurrentMemberId() {
        // 从JWT token中获取当前用户ID
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication != null && authentication.getPrincipal() instanceof UserPrincipal) {
            UserPrincipal userPrincipal = (UserPrincipal) authentication.getPrincipal();
            return userPrincipal.getId();
        }
        throw new BusinessException("用户未登录");
    }
    
    private CreditsHistoryVO convertToVO(UmsIntegrationChangeHistory history) {
        CreditsHistoryVO vo = new CreditsHistoryVO();
        vo.setId(history.getId());
        vo.setChangeType(history.getChangeType());
        vo.setCreditType(history.getCreditType());
        vo.setChangeAmount(history.getChangeCount());
        vo.setDescription(history.getOperateNote());
        vo.setBusinessId(history.getBusinessId());
        vo.setCreatedTime(history.getCreateTime());
        
        // 计算变动后余额 （需要根据实际业务逻辑调整）
        vo.setBalanceAfter(0); // 这里需要根据实际情况计算
        
        return vo;
    }
    
    private CreditProductVO convertToProductVO(PmsProduct product) {
        CreditProductVO vo = new CreditProductVO();
        vo.setId(product.getId());
        vo.setName(product.getName());
        vo.setDescription(product.getSubTitle());
        vo.setCreditAmount(product.getCreditAmount());
        vo.setPrice(product.getPrice());
        vo.setOriginalPrice(product.getOriginalPrice());
        
        // 计算折扣比例
        if (product.getOriginalPrice() != null && product.getOriginalPrice().compareTo(product.getPrice()) > 0) {
            BigDecimal discount = product.getPrice().divide(product.getOriginalPrice(), 2, RoundingMode.HALF_UP);
            vo.setDiscountPercentage(discount.multiply(new BigDecimal("100")).intValue());
        } else {
            vo.setDiscountPercentage(100);
        }
        
        vo.setIsHot(product.getNewStatus() == 1);
        vo.setIsRecommended(product.getRecommendStatus() == 1);
        
        return vo;
    }
}
```

### 第3-4天: 前端积分状态管理

#### 3.1 积分状态切片
```typescript
// store/credits/creditsSlice.ts
import { createSlice, createAsyncThunk } from '@reduxjs/toolkit';
import { creditsAPI } from '@/api/credits';

interface CreditsState {
  balance: {
    totalCredits: number;
    freeCredits: number;
    usedTodayTotal: number;
    lastResetDate: string | null;
  } | null;
  history: CreditHistory[];
  products: CreditProduct[];
  loading: boolean;
  error: string | null;
  purchaseLoading: boolean;
}

const initialState: CreditsState = {
  balance: null,
  history: [],
  products: [],
  loading: false,
  error: null,
  purchaseLoading: false,
};

// 异步thunks
export const fetchCreditsBalance = createAsyncThunk(
  'credits/fetchBalance',
  async () => {
    const response = await creditsAPI.getBalance();
    return response.data;
  }
);

export const fetchCreditsHistory = createAsyncThunk(
  'credits/fetchHistory',
  async (params: { pageNum: number; pageSize: number }) => {
    const response = await creditsAPI.getHistory(params);
    return response.data;
  }
);

export const fetchCreditProducts = createAsyncThunk(
  'credits/fetchProducts',
  async () => {
    const response = await creditsAPI.getProducts();
    return response.data;
  }
);

export const purchaseCredits = createAsyncThunk(
  'credits/purchase',
  async (productId: number) => {
    const response = await creditsAPI.purchaseCredits({ productId });
    return response.data;
  }
);

export const consumeCredits = createAsyncThunk(
  'credits/consume',
  async (params: ConsumeCreditsParams) => {
    const response = await creditsAPI.consumeCredits(params);
    return response.data;
  }
);

const creditsSlice = createSlice({
  name: 'credits',
  initialState,
  reducers: {
    clearError: (state) => {
      state.error = null;
    },
    // 实时更新积分余额 (WebSocket推送使用)
    updateBalance: (state, action) => {
      state.balance = action.payload;
    },
  },
  extraReducers: (builder) => {
    builder
      // 获取积分余额
      .addCase(fetchCreditsBalance.pending, (state) => {
        state.loading = true;
        state.error = null;
      })
      .addCase(fetchCreditsBalance.fulfilled, (state, action) => {
        state.loading = false;
        state.balance = action.payload;
      })
      .addCase(fetchCreditsBalance.rejected, (state, action) => {
        state.loading = false;
        state.error = action.error.message || '获取积分余额失败';
      })
      // 获取积分历史
      .addCase(fetchCreditsHistory.fulfilled, (state, action) => {
        state.history = action.payload.list;
      })
      // 获取积分商品
      .addCase(fetchCreditProducts.fulfilled, (state, action) => {
        state.products = action.payload;
      })
      // 购买积分
      .addCase(purchaseCredits.pending, (state) => {
        state.purchaseLoading = true;
        state.error = null;
      })
      .addCase(purchaseCredits.fulfilled, (state) => {
        state.purchaseLoading = false;
        // 购买成功后重新获取余额
      })
      .addCase(purchaseCredits.rejected, (state, action) => {
        state.purchaseLoading = false;
        state.error = action.error.message || '购买失败';
      });
  },
});

export const { clearError, updateBalance } = creditsSlice.actions;
export default creditsSlice.reducer;
```

#### 3.2 积分API接口
```typescript
// api/credits.ts
import { request } from '@/utils/request';

export const creditsAPI = {
  // 获取积分余额
  getBalance: () => 
    request.get<CreditsBalance>('/credits/balance'),

  // 获取积分历史记录
  getHistory: (params: { pageNum: number; pageSize: number }) => 
    request.get<PageResult<CreditHistory>>('/credits/history', { params }),

  // 获取积分商品列表
  getProducts: () => 
    request.get<CreditProduct[]>('/credits/products'),

  // 购买积分
  purchaseCredits: (data: { productId: number }) => 
    request.post('/credits/purchase', data),

  // 消费积分
  consumeCredits: (data: ConsumeCreditsParams) => 
    request.post('/credits/consume', data),

  // 获取购买积分的支付信息
  getPaymentInfo: (orderId: number) => 
    request.get(`/credits/payment/${orderId}`),
};

// 类型定义
export interface CreditsBalance {
  totalCredits: number;
  freeCredits: number;
  usedTodayTotal: number;
  lastResetDate: string | null;
}

export interface CreditHistory {
  id: number;
  changeType: number;
  creditType: number;
  changeAmount: number;
  balanceAfter: number;
  description: string;
  businessId?: string;
  orderId?: number;
  createdTime: string;
}

export interface CreditProduct {
  id: number;
  name: string;
  description: string;
  creditAmount: number;
  price: number;
  originalPrice?: number;
  discountPercentage: number;
  isHot: boolean;
  isRecommended: boolean;
}

export interface ConsumeCreditsParams {
  amount: number;
  businessId: string;
  description: string;
}
```

### 第5-6天: 积分余额显示组件

#### 5.1 积分显示组件 (Header中的积分显示)
```typescript
// components/CreditsDisplay.tsx
import React, { useEffect, useState } from 'react';
import { Badge, Dropdown, Spin, Button, message } from 'antd';
import { ThunderboltOutlined, PlusOutlined, HistoryOutlined } from '@ant-design/icons';
import { useAppSelector, useAppDispatch } from '@/hooks/redux';
import { fetchCreditsBalance } from '@/store/credits/creditsSlice';
import { useNavigate } from 'react-router-dom';

const CreditsDisplay: React.FC = () => {
  const dispatch = useAppDispatch();
  const navigate = useNavigate();
  const { balance, loading } = useAppSelector(state => state.credits);
  const [dropdownVisible, setDropdownVisible] = useState(false);

  useEffect(() => {
    dispatch(fetchCreditsBalance());
  }, [dispatch]);

  const formatNumber = (num: number): string => {
    if (num >= 1000) {
      return (num / 1000).toFixed(1) + 'k';
    }
    return num.toString();
  };

  const handlePurchaseClick = () => {
    setDropdownVisible(false);
    navigate('/credits/purchase');
  };

  const handleHistoryClick = () => {
    setDropdownVisible(false);
    navigate('/credits/history');
  };

  const dropdownItems = [
    {
      key: 'balance',
      label: (
        <div className="px-2 py-3">
          <div className="flex justify-between items-center mb-4">
            <span className="font-semibold text-lg">Free</span>
            <Button 
              size="small" 
              type="default"
              onClick={handlePurchaseClick}
            >
              升级
            </Button>
          </div>
          
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <ThunderboltOutlined className="text-yellow-500" />
                <div>
                  <div className="font-medium">永久积分</div>
                  <div className="text-xs text-gray-500">永久有效</div>
                </div>
              </div>
              <div className="font-semibold">
                {balance ? formatNumber(balance.totalCredits) : '0'}
                <Button 
                  type="link" 
                  size="small" 
                  className="p-0 ml-2"
                  onClick={handlePurchaseClick}
                >
                  <PlusOutlined />
                </Button>
              </div>
            </div>
            
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <Badge color="blue" />
                <div>
                  <div className="font-medium">每日免费积分</div>
                  <div className="text-xs text-gray-500">每天重置为200免费积分</div>
                </div>
              </div>
              <div className="font-semibold">
                {balance ? balance.freeCredits : '200'}
              </div>
            </div>
          </div>
          
          <div className="mt-4 pt-3 border-t border-gray-100">
            <Button 
              type="link" 
              size="small" 
              className="p-0 text-gray-600 hover:text-blue-500"
              onClick={handleHistoryClick}
            >
              <HistoryOutlined className="mr-1" />
              Usage details &gt;
            </Button>
          </div>
        </div>
      ),
    }
  ];

  const totalAvailableCredits = balance ? balance.totalCredits + balance.freeCredits : 200;

  return (
    <Dropdown
      menu={{ items: dropdownItems }}
      trigger={['hover']}
      open={dropdownVisible}
      onOpenChange={setDropdownVisible}
      placement="bottomRight"
      overlayStyle={{ minWidth: 320 }}
    >
      <Button 
        type="text" 
        className="flex items-center gap-2 px-3 py-1 rounded-full bg-gray-700 hover:bg-gray-600 text-white"
      >
        <span>升级</span>
        <ThunderboltOutlined />
        {loading ? (
          <Spin size="small" className="text-white" />
        ) : (
          <span className="font-semibold">
            {formatNumber(totalAvailableCredits)}
          </span>
        )}
      </Button>
    </Dropdown>
  );
};

export default CreditsDisplay;
```

#### 5.2 积分余额页面组件
```typescript
// components/CreditsBalanceCard.tsx
import React from 'react';
import { Card, Row, Col, Statistic, Progress, Button, Tooltip } from 'antd';
import { ThunderboltOutlined, GiftOutlined, ShoppingCartOutlined } from '@ant-design/icons';
import { useAppSelector } from '@/hooks/redux';
import { useNavigate } from 'react-router-dom';

const CreditsBalanceCard: React.FC = () => {
  const navigate = useNavigate();
  const { balance } = useAppSelector(state => state.credits);

  if (!balance) {
    return <Card loading />;
  }

  const totalCredits = balance.totalCredits + balance.freeCredits;
  const usagePercent = balance.usedTodayTotal > 0 ? 
    Math.round((balance.usedTodayTotal / (balance.usedTodayTotal + totalCredits)) * 100) : 0;

  return (
    <Card title="积分概况" className="mb-6">
      <Row gutter={24}>
        <Col xs={24} sm={12} lg={6}>
          <Statistic
            title="可用积分"
            value={totalCredits}
            prefix={<ThunderboltOutlined className="text-blue-500" />}
            valueStyle={{ color: '#1890ff' }}
          />
        </Col>
        
        <Col xs={24} sm={12} lg={6}>
          <Statistic
            title="永久积分"
            value={balance.totalCredits}
            prefix={<ThunderboltOutlined className="text-green-500" />}
            valueStyle={{ color: '#52c41a' }}
            suffix={
              <Tooltip title="点击购买更多积分">
                <Button 
                  type="link" 
                  size="small" 
                  icon={<ShoppingCartOutlined />}
                  onClick={() => navigate('/credits/purchase')}
                />
              </Tooltip>
            }
          />
        </Col>
        
        <Col xs={24} sm={12} lg={6}>
          <Statistic
            title="免费积分"
            value={balance.freeCredits}
            prefix={<GiftOutlined className="text-orange-500" />}
            valueStyle={{ color: '#fa8c16' }}
            suffix="/ 200"
          />
        </Col>
        
        <Col xs={24} sm={12} lg={6}>
          <Statistic
            title="今日已用"
            value={balance.usedTodayTotal}
            valueStyle={{ color: '#8c8c8c' }}
          />
          <Progress
            percent={usagePercent}
            size="small"
            showInfo={false}
            strokeColor="#1890ff"
            className="mt-2"
          />
        </Col>
      </Row>
      
      <div className="mt-4 pt-4 border-t border-gray-100">
        <Row gutter={16}>
          <Col>
            <Button type="primary" onClick={() => navigate('/credits/purchase')}>
              购买积分
            </Button>
          </Col>
          <Col>
            <Button onClick={() => navigate('/credits/history')}>
              使用记录
            </Button>
          </Col>
        </Row>
      </div>
    </Card>
  );
};

export default CreditsBalanceCard;
```

### 第7-8天: 积分购买页面开发

#### 7.1 积分购买页面
```typescript
// pages/CreditsPurchasePage.tsx
import React, { useEffect, useState } from 'react';
import { 
  Card, 
  Row, 
  Col, 
  Button, 
  Badge, 
  Typography, 
  Spin, 
  message,
  Modal 
} from 'antd';
import { 
  ThunderboltOutlined, 
  FireOutlined, 
  CrownOutlined,
  CheckCircleOutlined 
} from '@ant-design/icons';
import { useAppSelector, useAppDispatch } from '@/hooks/redux';
import { fetchCreditProducts, purchaseCredits } from '@/store/credits/creditsSlice';
import { useNavigate } from 'react-router-dom';
import PaymentModal from '@/components/PaymentModal';

const { Title, Text } = Typography;

const CreditsPurchasePage: React.FC = () => {
  const dispatch = useAppDispatch();
  const navigate = useNavigate();
  const { products, purchaseLoading } = useAppSelector(state => state.credits);
  const [selectedProduct, setSelectedProduct] = useState<number | null>(null);
  const [paymentModalVisible, setPaymentModalVisible] = useState(false);
  const [currentOrder, setCurrentOrder] = useState<any>(null);

  useEffect(() => {
    dispatch(fetchCreditProducts());
  }, [dispatch]);

  const handlePurchase = async (productId: number) => {
    try {
      setSelectedProduct(productId);
      const result = await dispatch(purchaseCredits(productId)).unwrap();
      
      // 显示支付弹窗
      setCurrentOrder(result);
      setPaymentModalVisible(true);
    } catch (error: any) {
      message.error(error.message || '创建订单失败');
    } finally {
      setSelectedProduct(null);
    }
  };

  const handlePaymentSuccess = () => {
    setPaymentModalVisible(false);
    setCurrentOrder(null);
    message.success('购买成功！积分已到账');
    navigate('/credits');
  };

  const formatPrice = (price: number) => {
    return `¥${price.toFixed(2)}`;
  };

  const calculateSavings = (price: number, originalPrice?: number) => {
    if (!originalPrice || originalPrice <= price) return null;
    const savings = originalPrice - price;
    return `省${savings.toFixed(2)}元`;
  };

  const getProductIcon = (product: any) => {
    if (product.isHot) return <FireOutlined className="text-red-500" />;
    if (product.isRecommended) return <CrownOutlined className="text-yellow-500" />;
    return <ThunderboltOutlined className="text-blue-500" />;
  };

  const getProductBadge = (product: any) => {
    if (product.isHot) return <Badge.Ribbon text="热门" color="red" />;
    if (product.isRecommended) return <Badge.Ribbon text="推荐" color="gold" />;
    return null;
  };

  return (
    <div className="max-w-7xl mx-auto p-6">
      <div className="text-center mb-8">
        <Title level={2}>购买积分</Title>
        <Text type="secondary" className="text-lg">
          选择适合你的积分套餐，开启无限创意之旅
        </Text>
      </div>

      <Row gutter={[24, 24]} justify="center">
        {products.map((product) => (
          <Col key={product.id} xs={24} sm={12} lg={8} xl={6}>
            {getProductBadge(product)}
            <Card
              className={`h-full transition-all duration-300 hover:shadow-lg hover:scale-105 ${
                product.isRecommended ? 'border-yellow-400 shadow-md' : ''
              }`}
              bodyStyle={{ padding: '24px' }}
            >
              <div className="text-center">
                <div className="text-4xl mb-4">
                  {getProductIcon(product)}
                </div>
                
                <Title level={4} className="mb-2">
                  {product.name}
                </Title>
                
                <Text type="secondary" className="block mb-4">
                  {product.description}
                </Text>
                
                <div className="mb-4">
                  <div className="text-3xl font-bold text-blue-500 mb-1">
                    <ThunderboltOutlined className="mr-1" />
                    {product.creditAmount.toLocaleString()}
                  </div>
                  <Text type="secondary">积分</Text>
                </div>
                
                <div className="mb-6">
                  <div className="text-2xl font-bold text-red-500">
                    {formatPrice(product.price)}
                  </div>
                  {product.originalPrice && product.originalPrice > product.price && (
                    <div className="text-sm text-gray-400">
                      <span className="line-through mr-2">
                        {formatPrice(product.originalPrice)}
                      </span>
                      <span className="text-green-500">
                        {calculateSavings(product.price, product.originalPrice)}
                      </span>
                    </div>
                  )}
                  {product.discountPercentage > 0 && (
                    <div className="text-sm text-orange-500 mt-1">
                      限时{product.discountPercentage}折优惠
                    </div>
                  )}
                </div>
                
                <div className="mb-4 text-left">
                  <div className="flex items-center mb-2">
                    <CheckCircleOutlined className="text-green-500 mr-2" />
                    <span className="text-sm">立即到账</span>
                  </div>
                  <div className="flex items-center mb-2">
                    <CheckCircleOutlined className="text-green-500 mr-2" />
                    <span className="text-sm">永不过期</span>
                  </div>
                  <div className="flex items-center">
                    <CheckCircleOutlined className="text-green-500 mr-2" />
                    <span className="text-sm">支持退款</span>
                  </div>
                </div>
                
                <Button
                  type={product.isRecommended ? 'primary' : 'default'}
                  size="large"
                  block
                  loading={selectedProduct === product.id && purchaseLoading}
                  onClick={() => handlePurchase(product.id)}
                  className={product.isRecommended ? 'bg-gradient-to-r from-blue-500 to-purple-600' : ''}
                >
                  立即购买
                </Button>
              </div>
            </Card>
          </Col>
        ))}
      </Row>
      
      <div className="text-center mt-8">
        <Text type="secondary">
          购买后积分将立即到账，如有问题请联系客服
        </Text>
      </div>

      <PaymentModal
        visible={paymentModalVisible}
        order={currentOrder}
        onSuccess={handlePaymentSuccess}
        onCancel={() => setPaymentModalVisible(false)}
      />
    </div>
  );
};

export default CreditsPurchasePage;
```

### 第9-10天: 积分使用记录页面

#### 9.1 积分历史记录页面
```typescript
// pages/CreditsHistoryPage.tsx
import React, { useEffect, useState } from 'react';
import { 
  Card, 
  Table, 
  Tag, 
  Typography, 
  DatePicker, 
  Select, 
  Row, 
  Col,
  Button,
  Space
} from 'antd';
import { 
  ThunderboltOutlined,
  PlusOutlined, 
  MinusOutlined,
  ReloadOutlined,
  GiftOutlined 
} from '@ant-design/icons';
import { useAppSelector, useAppDispatch } from '@/hooks/redux';
import { fetchCreditsHistory } from '@/store/credits/creditsSlice';
import { CreditsBalanceCard } from '@/components';
import dayjs from 'dayjs';

const { Title } = Typography;
const { RangePicker } = DatePicker;
const { Option } = Select;

const CreditsHistoryPage: React.FC = () => {
  const dispatch = useAppDispatch();
  const { history, loading } = useAppSelector(state => state.credits);
  
  const [filters, setFilters] = useState({
    dateRange: null as any,
    changeType: null as number | null,
    creditType: null as number | null,
  });
  
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 20,
    total: 0,
  });

  useEffect(() => {
    fetchData();
  }, [dispatch, pagination.current, pagination.pageSize, filters]);

  const fetchData = () => {
    dispatch(fetchCreditsHistory({
      pageNum: pagination.current,
      pageSize: pagination.pageSize,
      ...filters
    }));
  };

  const getChangeTypeTag = (changeType: number) => {
    const typeMap = {
      1: { text: '购买获得', color: 'green', icon: <PlusOutlined /> },
      2: { text: '使用扣减', color: 'red', icon: <MinusOutlined /> },
      3: { text: '每日重置', color: 'blue', icon: <ReloadOutlined /> },
      4: { text: '系统赠送', color: 'purple', icon: <GiftOutlined /> },
    };
    
    const config = typeMap[changeType as keyof typeof typeMap] || { text: '未知', color: 'default', icon: null };
    
    return (
      <Tag color={config.color} icon={config.icon}>
        {config.text}
      </Tag>
    );
  };

  const getCreditTypeTag = (creditType: number) => {
    return creditType === 1 ? (
      <Tag color="orange">免费积分</Tag>
    ) : (
      <Tag color="blue">永久积分</Tag>
    );
  };

  const formatAmount = (amount: number, changeType: number) => {
    const isPositive = amount > 0;
    const displayAmount = Math.abs(amount);
    
    return (
      <span className={isPositive ? 'text-green-600' : 'text-red-600'}>
        {isPositive ? '+' : '-'}
        <ThunderboltOutlined className="mr-1" />
        {displayAmount.toLocaleString()}
      </span>
    );
  };

  const columns = [
    {
      title: '时间',
      dataIndex: 'createdTime',
      key: 'createdTime',
      width: 180,
      render: (text: string) => dayjs(text).format('YYYY-MM-DD HH:mm:ss'),
    },
    {
      title: '变动类型',
      dataIndex: 'changeType',
      key: 'changeType',
      width: 120,
      render: (changeType: number) => getChangeTypeTag(changeType),
    },
    {
      title: '积分类型',
      dataIndex: 'creditType',
      key: 'creditType',
      width: 100,
      render: (creditType: number) => getCreditTypeTag(creditType),
    },
    {
      title: '变动数量',
      dataIndex: 'changeAmount',
      key: 'changeAmount',
      width: 120,
      render: (amount: number, record: any) => formatAmount(amount, record.changeType),
    },
    {
      title: '变动后余额',
      dataIndex: 'balanceAfter',
      key: 'balanceAfter',
      width: 120,
      render: (balance: number) => (
        <span>
          <ThunderboltOutlined className="mr-1 text-blue-500" />
          {balance.toLocaleString()}
        </span>
      ),
    },
    {
      title: '描述',
      dataIndex: 'description',
      key: 'description',
      ellipsis: true,
      render: (text: string) => text || '-',
    },
    {
      title: '业务ID',
      dataIndex: 'businessId',
      key: 'businessId',
      width: 120,
      render: (text: string) => text || '-',
    },
  ];

  const handleTableChange = (paginationConfig: any) => {
    setPagination({
      ...pagination,
      current: paginationConfig.current,
      pageSize: paginationConfig.pageSize,
    });
  };

  const handleReset = () => {
    setFilters({
      dateRange: null,
      changeType: null,
      creditType: null,
    });
    setPagination({ ...pagination, current: 1 });
  };

  return (
    <div className="max-w-7xl mx-auto p-6">
      <Title level={2} className="mb-6">积分管理</Title>
      
      <CreditsBalanceCard />
      
      <Card title="积分使用记录" className="mb-6">
        <Row gutter={16} className="mb-4">
          <Col xs={24} sm={12} md={6}>
            <RangePicker
              placeholder={['开始日期', '结束日期']}
              value={filters.dateRange}
              onChange={(dates) => setFilters({ ...filters, dateRange: dates })}
              className="w-full"
            />
          </Col>
          <Col xs={24} sm={12} md={4}>
            <Select
              placeholder="变动类型"
              value={filters.changeType}
              onChange={(value) => setFilters({ ...filters, changeType: value })}
              className="w-full"
              allowClear
            >
              <Option value={1}>购买获得</Option>
              <Option value={2}>使用扣减</Option>
              <Option value={3}>每日重置</Option>
              <Option value={4}>系统赠送</Option>
            </Select>
          </Col>
          <Col xs={24} sm={12} md={4}>
            <Select
              placeholder="积分类型"
              value={filters.creditType}
              onChange={(value) => setFilters({ ...filters, creditType: value })}
              className="w-full"
              allowClear
            >
              <Option value={1}>免费积分</Option>
              <Option value={2}>永久积分</Option>
            </Select>
          </Col>
          <Col xs={24} sm={12} md={4}>
            <Space>
              <Button onClick={fetchData}>查询</Button>
              <Button onClick={handleReset}>重置</Button>
            </Space>
          </Col>
        </Row>

        <Table
          dataSource={history}
          columns={columns}
          loading={loading}
          pagination={{
            ...pagination,
            showSizeChanger: true,
            showQuickJumper: true,
            showTotal: (total, range) => 
              `第 ${range[0]}-${range[1]} 条/共 ${total} 条`,
          }}
          onChange={handleTableChange}
          rowKey="id"
        />
      </Card>
    </div>
  );
};

export default CreditsHistoryPage;
```

### 第11-12天: 积分消费逻辑集成

#### 11.1 积分消费Hook
```typescript
// hooks/useCreditsConsume.ts
import { useState } from 'react';
import { message } from 'antd';
import { useAppDispatch } from '@/hooks/redux';
import { consumeCredits, fetchCreditsBalance } from '@/store/credits/creditsSlice';

export const useCreditsConsume = () => {
  const dispatch = useAppDispatch();
  const [consuming, setConsuming] = useState(false);

  const consume = async (amount: number, businessId: string, description: string) => {
    if (consuming) return false;

    setConsuming(true);
    try {
      await dispatch(consumeCredits({
        amount,
        businessId,
        description
      })).unwrap();

      // 刷新余额
      dispatch(fetchCreditsBalance());
      
      message.success(`消费 ${amount} 积分成功`);
      return true;
    } catch (error: any) {
      if (error.message?.includes('积分不足')) {
        message.error('积分不足，请购买积分或等待每日免费积分重置');
      } else {
        message.error(error.message || '积分消费失败');
      }
      return false;
    } finally {
      setConsuming(false);
    }
  };

  return {
    consume,
    consuming,
  };
};
```

#### 11.2 积分不足提示组件
```typescript
// components/InsufficientCreditsModal.tsx
import React from 'react';
import { Modal, Button, Card, Row, Col, Typography } from 'antd';
import { ThunderboltOutlined, ShoppingCartOutlined } from '@ant-design/icons';
import { useNavigate } from 'react-router-dom';

const { Title, Text } = Typography;

interface InsufficientCreditsModalProps {
  visible: boolean;
  requiredCredits: number;
  currentCredits: number;
  onCancel: () => void;
}

const InsufficientCreditsModal: React.FC<InsufficientCreditsModalProps> = ({
  visible,
  requiredCredits,
  currentCredits,
  onCancel,
}) => {
  const navigate = useNavigate();

  const handlePurchase = () => {
    onCancel();
    navigate('/credits/purchase');
  };

  const shortfall = requiredCredits - currentCredits;

  return (
    <Modal
      title="积分不足"
      open={visible}
      onCancel={onCancel}
      footer={null}
      width={500}
    >
      <div className="text-center py-4">
        <div className="text-6xl mb-4">
          <ThunderboltOutlined className="text-red-500" />
        </div>
        
        <Title level={4} className="mb-2">
          积分余额不足
        </Title>
        
        <Text type="secondary" className="block mb-6">
          完成此操作需要更多积分
        </Text>
        
        <Card className="mb-6">
          <Row gutter={16}>
            <Col span={8}>
              <div className="text-center">
                <div className="text-lg font-bold text-red-500">
                  {requiredCredits}
                </div>
                <div className="text-sm text-gray-500">需要积分</div>
              </div>
            </Col>
            <Col span={8}>
              <div className="text-center">
                <div className="text-lg font-bold text-blue-500">
                  {currentCredits}
                </div>
                <div className="text-sm text-gray-500">当前积分</div>
              </div>
            </Col>
            <Col span={8}>
              <div className="text-center">
                <div className="text-lg font-bold text-orange-500">
                  {shortfall}
                </div>
                <div className="text-sm text-gray-500">缺少积分</div>
              </div>
            </Col>
          </Row>
        </Card>
        
        <div className="space-y-3">
          <Button
            type="primary"
            size="large"
            block
            icon={<ShoppingCartOutlined />}
            onClick={handlePurchase}
          >
            立即购买积分
          </Button>
          
          <Button size="large" block onClick={onCancel}>
            取消操作
          </Button>
        </div>
        
        <div className="mt-4 p-3 bg-blue-50 rounded-lg">
          <Text className="text-sm text-blue-600">
            💡 提示：每日0点会自动重置200免费积分
          </Text>
        </div>
      </div>
    </Modal>
  );
};

export default InsufficientCreditsModal;
```

#### 11.3 AI功能中积分消费集成示例
```typescript
// components/AITaskComponent.tsx
import React, { useState } from 'react';
import { Button, message, Input } from 'antd';
import { useAppSelector } from '@/hooks/redux';
import { useCreditsConsume } from '@/hooks/useCreditsConsume';
import InsufficientCreditsModal from '@/components/InsufficientCreditsModal';

const AITaskComponent: React.FC = () => {
  const [taskInput, setTaskInput] = useState('');
  const [processing, setProcessing] = useState(false);
  const [showInsufficientModal, setShowInsufficientModal] = useState(false);
  
  const { balance } = useAppSelector(state => state.credits);
  const { consume, consuming } = useCreditsConsume();

  const TASK_COST = 10; // 每次AI任务消费10积分

  const handleStartTask = async () => {
    if (!taskInput.trim()) {
      message.warning('请输入任务内容');
      return;
    }

    // 检查积分是否足够
    if (balance) {
      const availableCredits = balance.totalCredits + balance.freeCredits;
      if (availableCredits < TASK_COST) {
        setShowInsufficientModal(true);
        return;
      }
    }

    setProcessing(true);
    
    // 先扣除积分
    const businessId = `ai_task_${Date.now()}`;
    const success = await consume(
      TASK_COST, 
      businessId, 
      `AI任务: ${taskInput.substring(0, 20)}...`
    );
    
    if (success) {
      try {
        // 执行AI任务
        await executeAITask(taskInput, businessId);
        message.success('AI任务执行成功');
      } catch (error) {
        // 如果AI任务失败，可以考虑退还积分
        message.error('AI任务执行失败');
      }
    }
    
    setProcessing(false);
  };

  const executeAITask = async (input: string, businessId: string) => {
    // 模拟AI任务执行
    return new Promise((resolve) => {
      setTimeout(resolve, 2000);
    });
  };

  const availableCredits = balance ? balance.totalCredits + balance.freeCredits : 0;

  return (
    <div className="p-4">
      <div className="mb-4">
        <Input.TextArea
          value={taskInput}
          onChange={(e) => setTaskInput(e.target.value)}
          placeholder="输入您的AI任务描述..."
          rows={4}
        />
      </div>
      
      <div className="flex justify-between items-center">
        <div className="text-sm text-gray-600">
          消费积分: {TASK_COST} | 可用积分: {availableCredits}
        </div>
        
        <Button
          type="primary"
          onClick={handleStartTask}
          loading={processing || consuming}
          disabled={availableCredits < TASK_COST}
        >
          开始AI任务 (-{TASK_COST}积分)
        </Button>
      </div>

      <InsufficientCreditsModal
        visible={showInsufficientModal}
        requiredCredits={TASK_COST}
        currentCredits={availableCredits}
        onCancel={() => setShowInsufficientModal(false)}
      />
    </div>
  );
};

export default AITaskComponent;
```

## 质量保证

### 功能测试清单
- [ ] 积分余额正确显示
- [ ] 每日积分重置功能正常
- [ ] 积分购买流程完整
- [ ] 积分消费逻辑正确(优先使用免费积分)
- [ ] 积分变动记录准确
- [ ] 积分不足提示友好
- [ ] 实时积分更新

### 性能测试
- [ ] 积分查询响应时间 < 500ms
- [ ] 积分消费并发处理正确
- [ ] 大量历史记录分页加载正常
- [ ] 积分购买支付流程稳定

### 安全测试
- [ ] 积分消费权限验证
- [ ] 防止重复扣费
- [ ] 积分数据一致性
- [ ] 恶意请求防护

## 后端数据库扩展补充

### 数据库Mapper扩展
```java
// UmsMemberMapper.java 需要扩展的方法
public interface UmsMemberMapper {
    // 原有方法...
    
    /**
     * 查询需要重置每日积分的用户
     */
    @Select("SELECT * FROM ums_member WHERE last_reset_date IS NULL OR last_reset_date < #{today}")
    List<UmsMember> selectMembersForDailyReset(@Param("today") LocalDate today);
}

// UmsIntegrationChangeHistoryMapper.java 需要扩展的方法
public interface UmsIntegrationChangeHistoryMapper {
    // 原有方法...
    
    /**
     * 按用户查询积分变动历史
     */
    @Select("SELECT * FROM ums_integration_change_history WHERE member_id = #{memberId} ORDER BY create_time DESC")
    List<UmsIntegrationChangeHistory> selectByMemberId(@Param("memberId") Long memberId);
    
    /**
     * 按条件查询积分变动历史
     */
    List<UmsIntegrationChangeHistory> selectByMemberIdWithConditions(
        @Param("memberId") Long memberId,
        @Param("startDate") Date startDate,
        @Param("endDate") Date endDate,
        @Param("changeType") Integer changeType,
        @Param("creditType") Byte creditType
    );
}

// PmsProductMapper.java 需要扩展的方法
public interface PmsProductMapper {
    // 原有方法...
    
    /**
     * 按商品类型查询商品列表
     */
    @Select("SELECT * FROM pms_product WHERE product_type = #{productType} AND publish_status = 1 ORDER BY sort ASC")
    List<PmsProduct> selectByProductType(@Param("productType") Integer productType);
}
```

### VO类定义
```java
// MemberCreditsVO.java - 用户积分信息返回对象
public class MemberCreditsVO {
    private Integer totalCredits;      // 永久积分
    private Integer freeCredits;       // 可用免费积分
    private Integer usedTodayTotal;    // 今日已用
    private Date lastResetDate;        // 最后重置日期
    
    // getters and setters...
}

// CreditsBalanceVO.java - 积分余额显示对象 
public class CreditsBalanceVO {
    private Integer totalCredits;
    private Integer freeCredits;
    private Integer usedTodayTotal;
    private Date lastResetDate;
    
    // getters and setters...
}

// CreditsHistoryVO.java - 积分历史记录显示对象
public class CreditsHistoryVO {
    private Long id;
    private Integer changeType;        // 0-获得, 1-消费
    private Byte creditType;          // 1-免费积分, 2-永久积分
    private Integer changeAmount;
    private Integer balanceAfter;
    private String description;
    private String businessId;
    private Date createdTime;
    
    // getters and setters...
}

// CreditProductVO.java - 积分商品显示对象
public class CreditProductVO {
    private Long id;
    private String name;
    private String description;
    private Integer creditAmount;
    private BigDecimal price;
    private BigDecimal originalPrice;
    private Integer discountPercentage;
    private Boolean isHot;
    private Boolean isRecommended;
    
    // getters and setters...
}
```

## 交付物

### 前端代码
- [ ] 积分状态管理 (Redux)
- [ ] 积分显示组件
- [ ] 积分购买页面
- [ ] 积分历史页面
- [ ] 积分消费Hook
- [ ] 积分不足提示组件

### 后端代码
- [ ] 积分服务实现
- [ ] 积分API接口
- [ ] 积分商品管理
- [ ] 每日重置定时任务
- [ ] 积分变动记录

### 数据库设计
- [ ] 积分相关数据表
- [ ] 索引优化
- [ ] 初始化数据脚本

## 验收标准

1. **功能完整性**: 积分系统各功能100%可用
2. **数据准确性**: 积分变动记录准确无误
3. **用户体验**: 积分操作响应及时，提示友好
4. **性能指标**: 积分查询 < 500ms，消费 < 1s
5. **安全性**: 通过安全审计，防止积分滥用

## 风险控制

### 业务风险
1. **积分滥用**: 实现频率限制和行为监控
2. **数据不一致**: 使用事务确保数据一致性
3. **恶意刷积分**: 实现防刷机制

### 技术风险
1. **并发问题**: 使用乐观锁处理并发消费
2. **性能问题**: 实现积分缓存策略
3. **数据丢失**: 做好数据备份和恢复

完成此阶段后，用户将拥有完整的积分管理体验，为后续的套餐管理和支付系统提供基础。