# ç¬¬å››é˜¶æ®µ: ç§¯åˆ†ç³»ç»Ÿå¼€å‘è®¡åˆ’

## é˜¶æ®µæ¦‚è¿°
**æ—¶é—´å‘¨æœŸ**: 2å‘¨  
**ä¼˜å…ˆçº§**: é«˜  
**ä¾èµ–**: ç”¨æˆ·è®¤è¯ç³»ç»Ÿã€é¦–é¡µç•Œé¢å®Œæˆ  
**ç›®æ ‡**: å®ç°å®Œæ•´çš„ç”¨æˆ·ç§¯åˆ†ç®¡ç†ç³»ç»Ÿï¼ŒåŒ…æ‹¬ç§¯åˆ†å±•ç¤ºã€ä½¿ç”¨è®°å½•ã€è´­ä¹°åŠŸèƒ½å’Œå˜åŠ¨é€šçŸ¥

## åŠŸèƒ½éœ€æ±‚è¯¦ç»†åˆ†æ

### æ ¸å¿ƒåŠŸèƒ½æ¸…å•
1. **ç§¯åˆ†ä½™é¢æ˜¾ç¤º** - å®æ—¶æ˜¾ç¤ºç”¨æˆ·æ€»ç§¯åˆ†ã€å…è´¹ç§¯åˆ†ã€æ°¸ä¹…ç§¯åˆ†
2. **ç§¯åˆ†ä½¿ç”¨è®°å½•** - è¯¦ç»†çš„ç§¯åˆ†æ¶ˆè´¹å’Œè·å¾—å†å²
3. **ç§¯åˆ†è´­ä¹°é¡µé¢** - ä¸åŒç§¯åˆ†åŒ…çš„å±•ç¤ºå’Œè´­ä¹°
4. **ç§¯åˆ†å•†å“ç®¡ç†** - åå°ç®¡ç†ä¸åŒç§¯åˆ†å•†å“çš„ä»·æ ¼é…ç½®
5. **ç§¯åˆ†æ¶ˆè´¹é€»è¾‘** - ä¼˜å…ˆä½¿ç”¨å…è´¹ç§¯åˆ†ï¼Œå†ä½¿ç”¨æ°¸ä¹…ç§¯åˆ†
6. **ç§¯åˆ†å˜åŠ¨é€šçŸ¥** - å®æ—¶é€šçŸ¥ç”¨æˆ·ç§¯åˆ†å˜åŠ¨æƒ…å†µ
7. **æ¯æ—¥ç§¯åˆ†é‡ç½®** - æ¯æ—¥å…è´¹ç§¯åˆ†è‡ªåŠ¨é‡ç½®ä¸º200

### ä¸šåŠ¡è§„åˆ™è®¾è®¡
```
ç§¯åˆ†ç³»ç»Ÿä¸šåŠ¡è§„åˆ™ï¼š
1. æ–°ç”¨æˆ·æ¯æ—¥è·å¾—200å…è´¹ç§¯åˆ†
2. å…è´¹ç§¯åˆ†æ¯æ—¥0ç‚¹è‡ªåŠ¨é‡ç½®ï¼Œä¸ç´¯ç§¯
3. æ°¸ä¹…ç§¯åˆ†å¯ç´¯ç§¯ï¼Œä¸è¿‡æœŸ
4. ä½¿ç”¨ä¼˜å…ˆçº§ï¼šå…è´¹ç§¯åˆ† > æ°¸ä¹…ç§¯åˆ†
5. ç§¯åˆ†è´­ä¹°ç«‹å³åˆ°è´¦
6. ç§¯åˆ†æœ€å°è´­ä¹°å•ä½ï¼š100ç§¯åˆ†
7. ç§¯åˆ†æ¶ˆè´¹è®°å½•æ°¸ä¹…ä¿å­˜
```

## æ•°æ®åº“è®¾è®¡

### åŸºäºç°æœ‰mallè¡¨ç»“æ„æ‰©å±•

#### å¤ç”¨ç°æœ‰è¡¨ç»“æ„
1. **ums_member.integration** - ä½œä¸ºç”¨æˆ·æ°¸ä¹…ç§¯åˆ†ä½™é¢
2. **ums_integration_change_history** - ä½œä¸ºç§¯åˆ†å˜åŠ¨è®°å½•è¡¨
3. **pms_product** - å¤ç”¨ç°æœ‰å•†å“è¡¨ï¼Œç§¯åˆ†å•†å“ä¹Ÿä½œä¸ºæ™®é€šå•†å“ç®¡ç†

#### éœ€è¦çš„è¡¨ç»“æ„æ‰©å±•
```sql
-- 1. æ‰©å±•ç”¨æˆ·è¡¨ï¼Œæ·»åŠ å…è´¹ç§¯åˆ†ç›¸å…³å­—æ®µ
ALTER TABLE ums_member ADD COLUMN free_daily_credits INT DEFAULT 200 COMMENT 'æ¯æ—¥å…è´¹ç§¯åˆ†';
ALTER TABLE ums_member ADD COLUMN used_today_free INT DEFAULT 0 COMMENT 'ä»Šæ—¥å·²ä½¿ç”¨å…è´¹ç§¯åˆ†';
ALTER TABLE ums_member ADD COLUMN last_reset_date DATE COMMENT 'æœ€åé‡ç½®æ—¥æœŸ';

-- 2. æ‰©å±•ç§¯åˆ†å˜åŠ¨è®°å½•è¡¨ï¼Œæ·»åŠ ç§¯åˆ†ç±»å‹å’Œä¸šåŠ¡ID
ALTER TABLE ums_integration_change_history ADD COLUMN credit_type TINYINT DEFAULT 2 COMMENT 'ç§¯åˆ†ç±»å‹: 1-å…è´¹ç§¯åˆ†, 2-æ°¸ä¹…ç§¯åˆ†';
ALTER TABLE ums_integration_change_history ADD COLUMN business_id VARCHAR(64) COMMENT 'ä¸šåŠ¡ID(å¦‚AIä»»åŠ¡ID)';

-- 3. æ‰©å±•å•†å“è¡¨ï¼Œæ·»åŠ ç§¯åˆ†å•†å“æ ‡è¯†
ALTER TABLE pms_product ADD COLUMN product_type TINYINT DEFAULT 1 COMMENT 'å•†å“ç±»å‹: 1-æ™®é€šå•†å“, 2-ç§¯åˆ†å•†å“, 3-å¥—é¤å•†å“';
ALTER TABLE pms_product ADD COLUMN credit_amount INT COMMENT 'ç§¯åˆ†æ•°é‡(ç§¯åˆ†å•†å“æ—¶ä½¿ç”¨)';

-- 4. æ›´æ–°ç§¯åˆ†è§„åˆ™è®¾ç½®è¡¨ï¼Œæ·»åŠ æ¯æ—¥å…è´¹ç§¯åˆ†è§„åˆ™
UPDATE ums_member_rule_setting SET 
    continue_sign_day = 1,
    continue_sign_point = 200,
    type = 0 
WHERE id = 1;

-- å¦‚æœä¸å­˜åœ¨è®°å½•ï¼Œåˆ™æ’å…¥
INSERT INTO ums_member_rule_setting (continue_sign_day, continue_sign_point, consume_per_point, low_order_amount, max_point_per_order, type)
VALUES (1, 200, 1.00, 0.00, -1, 0)
ON DUPLICATE KEY UPDATE 
    continue_sign_day = 1,
    continue_sign_point = 200;

-- 5. åˆå§‹åŒ–ç§¯åˆ†å•†å“æ•°æ®ï¼ˆä½¿ç”¨ç°æœ‰pms_productè¡¨ï¼‰
INSERT INTO pms_product (
    brand_id, product_category_id, name, sub_title, description, price, original_price, stock, unit, weight, sort, gift_growth, gift_point, use_point_limit, product_sn, keywords, publish_status, new_status, recommend_status, verify_status, sale, product_type, credit_amount
) VALUES 
(1, 1, 'åŸºç¡€ç§¯åˆ†åŒ…', '1000ç§¯åˆ†', 'é€‚åˆè½»åº¦ä½¿ç”¨ç”¨æˆ·ï¼ŒåŒ…å«1000ç§¯åˆ†', 9.90, 12.90, 999, 'åŒ…', 0, 1, 0, 0, 0, 'CREDIT_BASIC_1000', 'ç§¯åˆ†,å……å€¼,åŸºç¡€', 1, 1, 0, 1, 0, 2, 1000),
(1, 1, 'æ ‡å‡†ç§¯åˆ†åŒ…', '3000ç§¯åˆ†', 'é€‚åˆæ—¥å¸¸ä½¿ç”¨ç”¨æˆ·ï¼ŒåŒ…å«3000ç§¯åˆ†', 26.90, 35.90, 999, 'åŒ…', 0, 2, 0, 0, 0, 'CREDIT_STANDARD_3000', 'ç§¯åˆ†,å……å€¼,æ ‡å‡†', 1, 1, 1, 1, 0, 2, 3000),
(1, 1, 'ä¸“ä¸šç§¯åˆ†åŒ…', '6000ç§¯åˆ†', 'é€‚åˆä¸“ä¸šè®¾è®¡å¸ˆï¼ŒåŒ…å«6000ç§¯åˆ†', 49.90, 69.90, 999, 'åŒ…', 0, 3, 0, 0, 0, 'CREDIT_PRO_6000', 'ç§¯åˆ†,å……å€¼,ä¸“ä¸š', 1, 1, 1, 1, 0, 2, 6000),
(1, 1, 'ä¼ä¸šç§¯åˆ†åŒ…', '15000ç§¯åˆ†', 'é€‚åˆå›¢é˜Ÿåä½œï¼ŒåŒ…å«15000ç§¯åˆ†', 119.90, 169.90, 999, 'åŒ…', 0, 4, 0, 0, 0, 'CREDIT_ENTERPRISE_15000', 'ç§¯åˆ†,å……å€¼,ä¼ä¸š', 1, 0, 1, 1, 0, 2, 15000),
(1, 1, 'æ——èˆ°ç§¯åˆ†åŒ…', '30000ç§¯åˆ†', 'æ— é™åˆ›ä½œå¯èƒ½ï¼ŒåŒ…å«30000ç§¯åˆ†', 219.90, 329.90, 999, 'åŒ…', 0, 5, 0, 0, 0, 'CREDIT_FLAGSHIP_30000', 'ç§¯åˆ†,å……å€¼,æ——èˆ°', 1, 1, 1, 1, 0, 2, 30000);
```

### ä¸šåŠ¡è§„åˆ™è¯´æ˜
1. **æ°¸ä¹…ç§¯åˆ†**: å­˜å‚¨åœ¨ `ums_member.integration`ï¼Œè´­ä¹°è·å¾—ï¼Œä¸è¿‡æœŸ
2. **å…è´¹ç§¯åˆ†**: å­˜å‚¨åœ¨ `ums_member.free_daily_credits`ï¼Œæ¯æ—¥200ï¼Œå½“å¤©æœ‰æ•ˆ
3. **ç§¯åˆ†æ¶ˆè´¹ä¼˜å…ˆçº§**: ä¼˜å…ˆæ¶ˆè´¹å…è´¹ç§¯åˆ†ï¼Œå†æ¶ˆè´¹æ°¸ä¹…ç§¯åˆ†
4. **ç§¯åˆ†å•†å“**: åœ¨ç°æœ‰å•†å“è¡¨ä¸­ï¼Œé€šè¿‡ `product_type=2` æ ‡è¯†
5. **æ¯æ—¥é‡ç½®**: é€šè¿‡å®šæ—¶ä»»åŠ¡æ£€æŸ¥ `last_reset_date`ï¼Œé‡ç½®å…è´¹ç§¯åˆ†

## è¯¦ç»†å¼€å‘ä»»åŠ¡

### ç¬¬1-2å¤©: åç«¯ç§¯åˆ†æœåŠ¡å¼€å‘

#### 1.1 ç§¯åˆ†æœåŠ¡æ ¸å¿ƒç±»
```java
// CreditsService.java - åŸºäºç°æœ‰mallè¡¨ç»“æ„å®ç°
@Service
@Transactional
public class CreditsServiceImpl implements CreditsService {
    
    @Autowired
    private UmsMemberMapper memberMapper;
    
    @Autowired
    private UmsIntegrationChangeHistoryMapper integrationHistoryMapper;
    
    @Autowired
    private UmsMemberRuleSettingMapper ruleSettingMapper;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Override
    public MemberCreditsVO getMemberCredits(Long memberId) {
        // å…ˆæ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®æ¯æ—¥ç§¯åˆ†
        resetDailyCreditsIfNeeded(memberId);
        
        UmsMember member = memberMapper.selectByPrimaryKey(memberId);
        if (member == null) {
            throw new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // æ„å»ºç§¯åˆ†ä¿¡æ¯VO
        MemberCreditsVO creditsVO = new MemberCreditsVO();
        creditsVO.setTotalCredits(member.getIntegration() != null ? member.getIntegration() : 0);
        creditsVO.setFreeCredits(Math.max(0, 
            (member.getFreeDailyCredits() != null ? member.getFreeDailyCredits() : 200) - 
            (member.getUsedTodayFree() != null ? member.getUsedTodayFree() : 0)));
        creditsVO.setUsedTodayTotal(member.getUsedTodayFree() != null ? member.getUsedTodayFree() : 0);
        creditsVO.setLastResetDate(member.getLastResetDate());
        
        return creditsVO;
    }
    
    @Override
    public boolean consumeCredits(Long memberId, int amount, String businessId, String description) {
        UmsMember member = memberMapper.selectByPrimaryKey(memberId);
        if (member == null) {
            throw new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // å…ˆé‡ç½®æ¯æ—¥ç§¯åˆ†
        resetDailyCreditsIfNeeded(memberId);
        member = memberMapper.selectByPrimaryKey(memberId); // é‡æ–°è·å–æœ€æ–°æ•°æ®
        
        // æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
        int totalCredits = (member.getIntegration() != null ? member.getIntegration() : 0);
        int freeCredits = Math.max(0, 
            (member.getFreeDailyCredits() != null ? member.getFreeDailyCredits() : 200) - 
            (member.getUsedTodayFree() != null ? member.getUsedTodayFree() : 0));
        int availableCredits = totalCredits + freeCredits;
        
        if (availableCredits < amount) {
            throw new BusinessException("ç§¯åˆ†ä¸è¶³");
        }
        
        // ä¼˜å…ˆä½¿ç”¨å…è´¹ç§¯åˆ†
        int remainingAmount = amount;
        int freeCreditsUsed = 0;
        int permanentCreditsUsed = 0;
        
        if (freeCredits > 0) {
            freeCreditsUsed = Math.min(remainingAmount, freeCredits);
            remainingAmount -= freeCreditsUsed;
            
            // æ›´æ–°å·²ä½¿ç”¨å…è´¹ç§¯åˆ†
            member.setUsedTodayFree((member.getUsedTodayFree() != null ? member.getUsedTodayFree() : 0) + freeCreditsUsed);
            
            // è®°å½•å…è´¹ç§¯åˆ†ä½¿ç”¨
            recordIntegrationHistory(memberId, 1, -freeCreditsUsed, 
                description + " (å…è´¹ç§¯åˆ†)", 0, businessId, (byte) 1);
        }
        
        // å¦‚æœè¿˜æœ‰å‰©ä½™ï¼Œä½¿ç”¨æ°¸ä¹…ç§¯åˆ†
        if (remainingAmount > 0) {
            permanentCreditsUsed = remainingAmount;
            int newIntegration = totalCredits - permanentCreditsUsed;
            member.setIntegration(newIntegration);
            
            // è®°å½•æ°¸ä¹…ç§¯åˆ†ä½¿ç”¨
            recordIntegrationHistory(memberId, 1, -permanentCreditsUsed, 
                description + " (æ°¸ä¹…ç§¯åˆ†)", 0, businessId, (byte) 2);
        }
        
        memberMapper.updateByPrimaryKey(member);
        return true;
    }
    
    @Override
    public void addCredits(Long memberId, int amount, String description, Long orderId) {
        UmsMember member = memberMapper.selectByPrimaryKey(memberId);
        if (member == null) {
            throw new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // å¢åŠ æ°¸ä¹…ç§¯åˆ†
        int currentIntegration = member.getIntegration() != null ? member.getIntegration() : 0;
        member.setIntegration(currentIntegration + amount);
        
        // æ›´æ–°å†å²ç§¯åˆ†æ€»æ•°
        int historyIntegration = member.getHistoryIntegration() != null ? member.getHistoryIntegration() : 0;
        member.setHistoryIntegration(historyIntegration + amount);
        
        memberMapper.updateByPrimaryKey(member);
        
        // è®°å½•ç§¯åˆ†å˜åŠ¨å†å²
        recordIntegrationHistory(memberId, 0, amount, description, 1, null, (byte) 2);
        
        // å‘é€ç§¯åˆ†å˜åŠ¨é€šçŸ¥
        sendCreditsChangeNotification(memberId, amount, description);
    }
    
    @Override
    @Scheduled(cron = "0 0 0 * * ?") // æ¯å¤©0ç‚¹æ‰§è¡Œ
    public void resetDailyCredits() {
        LocalDate today = LocalDate.now();
        
        // æŸ¥è¯¢éœ€è¦é‡ç½®çš„ç”¨æˆ·ï¼ˆæ˜¨å¤©æœªé‡ç½®çš„ç”¨æˆ·ï¼‰
        List<UmsMember> membersToReset = memberMapper.selectMembersForDailyReset(today);
        
        for (UmsMember member : membersToReset) {
            // é‡ç½®æ¯æ—¥å…è´¹ç§¯åˆ†ä½¿ç”¨é‡
            member.setUsedTodayFree(0);
            member.setLastResetDate(Date.valueOf(today));
            memberMapper.updateByPrimaryKey(member);
            
            // è®°å½•æ¯æ—¥é‡ç½®å†å²
            recordIntegrationHistory(member.getId(), 0, 200, "æ¯æ—¥å…è´¹ç§¯åˆ†é‡ç½®", 1, null, (byte) 1);
        }
        
        log.info("Daily credits reset completed for {} members", membersToReset.size());
    }
    
    private void resetDailyCreditsIfNeeded(Long memberId) {
        UmsMember member = memberMapper.selectByPrimaryKey(memberId);
        if (member != null) {
            LocalDate today = LocalDate.now();
            LocalDate lastReset = member.getLastResetDate() != null ? 
                member.getLastResetDate().toLocalDate() : null;
                
            if (lastReset == null || !lastReset.equals(today)) {
                // é‡ç½®æ¯æ—¥å…è´¹ç§¯åˆ†
                member.setUsedTodayFree(0);
                member.setLastResetDate(Date.valueOf(today));
                memberMapper.updateByPrimaryKey(member);
                
                // è®°å½•é‡ç½®å†å²
                recordIntegrationHistory(memberId, 0, 200, "æ¯æ—¥å…è´¹ç§¯åˆ†é‡ç½®", 1, null, (byte) 1);
            }
        }
    }
    
    private void recordIntegrationHistory(Long memberId, int changeType, int changeCount, 
            String operateNote, int sourceType, String businessId, Byte creditType) {
        
        UmsIntegrationChangeHistory history = new UmsIntegrationChangeHistory();
        history.setMemberId(memberId);
        history.setChangeType(changeType); // 0-å¢åŠ , 1-å‡å°‘
        history.setChangeCount(changeCount);
        history.setOperateNote(operateNote);
        history.setSourceType(sourceType); // 0-è´­ç‰©, 1-ç®¡ç†å‘˜ä¿®æ”¹/ç³»ç»Ÿ
        history.setBusinessId(businessId);
        history.setCreditType(creditType); // 1-å…è´¹ç§¯åˆ†, 2-æ°¸ä¹…ç§¯åˆ†
        history.setCreateTime(new Date());
        
        integrationHistoryMapper.insert(history);
    }
    
    private void sendCreditsChangeNotification(Long memberId, int amount, String description) {
        // å‘é€ç§¯åˆ†å˜åŠ¨é€šçŸ¥
        // å¯ä»¥é€šè¿‡WebSocketæ¨é€ç»™å‰ç«¯å®æ—¶æ›´æ–°
        // æˆ–è€…é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†é€šçŸ¥
        log.info("Credits changed for member {}: +{} - {}", memberId, amount, description);
    }
}
```

#### 1.2 ç§¯åˆ†æ§åˆ¶å™¨
```java
// CreditsController.java
@RestController
@RequestMapping("/api/credits")
public class CreditsController {
    
    @Autowired
    private CreditsService creditsService;
    
    @Autowired
    private PmsCreditProductService creditProductService;
    
    @GetMapping("/balance")
    @ApiOperation("è·å–ç§¯åˆ†ä½™é¢")
    public CommonResult<CreditsBalanceVO> getCreditsBalance() {
        Long memberId = getCurrentMemberId();
        UmsMemberCredits credits = creditsService.getMemberCredits(memberId);
        
        CreditsBalanceVO vo = new CreditsBalanceVO();
        vo.setTotalCredits(credits.getTotalCredits());
        vo.setFreeCredits(Math.max(0, credits.getFreeDailyCredits() - credits.getUsedTodayFree()));
        vo.setUsedTodayTotal(credits.getUsedTodayTotal());
        vo.setLastResetDate(credits.getLastResetDate());
        
        return CommonResult.success(vo);
    }
    
    @GetMapping("/history")
    @ApiOperation("è·å–ç§¯åˆ†å˜åŠ¨å†å²")
    public CommonResult<CommonPage<CreditsHistoryVO>> getCreditsHistory(
            @RequestParam(defaultValue = "1") Integer pageNum,
            @RequestParam(defaultValue = "20") Integer pageSize) {
        
        Long memberId = getCurrentMemberId();
        PageHelper.startPage(pageNum, pageSize);
        
        // æŸ¥è¯¢ç§¯åˆ†å˜åŠ¨å†å²è®°å½•
        List<UmsIntegrationChangeHistory> historyList = creditsService.getCreditsHistory(memberId);
        List<CreditsHistoryVO> voList = historyList.stream()
            .map(this::convertToVO)
            .collect(Collectors.toList());
            
        return CommonResult.success(CommonPage.restPage(voList));
    }
    
    @GetMapping("/products")
    @ApiOperation("è·å–ç§¯åˆ†å•†å“åˆ—è¡¨")
    public CommonResult<List<CreditProductVO>> getCreditProducts() {
        // æŸ¥è¯¢ç§¯åˆ†å•†å“ (product_type = 2)
        List<PmsProduct> products = productService.listByProductType(2);
        List<CreditProductVO> voList = products.stream()
            .map(this::convertToProductVO)
            .collect(Collectors.toList());
            
        return CommonResult.success(voList);
    }
    
    @PostMapping("/purchase")
    @ApiOperation("è´­ä¹°ç§¯åˆ†")
    public CommonResult<?> purchaseCredits(@RequestBody PurchaseCreditsRequest request) {
        Long memberId = getCurrentMemberId();
        
        // è·å–ç§¯åˆ†å•†å“ä¿¡æ¯
        PmsProduct product = productService.getById(request.getProductId());
        if (product == null || product.getProductType() != 2) {
            return CommonResult.failed("ç§¯åˆ†å•†å“ä¸å­˜åœ¨");
        }
        
        // åˆ›å»ºè®¢å• - å¤ç”¨ç°æœ‰mallè®¢å•ç³»ç»Ÿ
        OmsOrder order = orderService.generateOrder(memberId, Arrays.asList(product.getId()));
        
        return CommonResult.success(Map.of(
            "orderId", order.getId(),
            "orderSn", order.getOrderSn(),
            "payAmount", order.getPayAmount(),
            "creditAmount", product.getCreditAmount()
        ));
    }
    
    @PostMapping("/consume")
    @ApiOperation("æ¶ˆè´¹ç§¯åˆ†")
    public CommonResult<?> consumeCredits(@RequestBody ConsumeCreditsRequest request) {
        Long memberId = getCurrentMemberId();
        
        boolean success = creditsService.consumeCredits(
            memberId, 
            request.getAmount(), 
            request.getBusinessId(), 
            request.getDescription()
        );
        
        if (success) {
            return CommonResult.success("ç§¯åˆ†æ¶ˆè´¹æˆåŠŸ");
        } else {
            return CommonResult.failed("ç§¯åˆ†ä¸è¶³");
        }
    }
    
    private Long getCurrentMemberId() {
        // ä»JWT tokenä¸­è·å–å½“å‰ç”¨æˆ·ID
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication != null && authentication.getPrincipal() instanceof UserPrincipal) {
            UserPrincipal userPrincipal = (UserPrincipal) authentication.getPrincipal();
            return userPrincipal.getId();
        }
        throw new BusinessException("ç”¨æˆ·æœªç™»å½•");
    }
    
    private CreditsHistoryVO convertToVO(UmsIntegrationChangeHistory history) {
        CreditsHistoryVO vo = new CreditsHistoryVO();
        vo.setId(history.getId());
        vo.setChangeType(history.getChangeType());
        vo.setCreditType(history.getCreditType());
        vo.setChangeAmount(history.getChangeCount());
        vo.setDescription(history.getOperateNote());
        vo.setBusinessId(history.getBusinessId());
        vo.setCreatedTime(history.getCreateTime());
        
        // è®¡ç®—å˜åŠ¨åä½™é¢ ï¼ˆéœ€è¦æ ¹æ®å®é™…ä¸šåŠ¡é€»è¾‘è°ƒæ•´ï¼‰
        vo.setBalanceAfter(0); // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè®¡ç®—
        
        return vo;
    }
    
    private CreditProductVO convertToProductVO(PmsProduct product) {
        CreditProductVO vo = new CreditProductVO();
        vo.setId(product.getId());
        vo.setName(product.getName());
        vo.setDescription(product.getSubTitle());
        vo.setCreditAmount(product.getCreditAmount());
        vo.setPrice(product.getPrice());
        vo.setOriginalPrice(product.getOriginalPrice());
        
        // è®¡ç®—æŠ˜æ‰£æ¯”ä¾‹
        if (product.getOriginalPrice() != null && product.getOriginalPrice().compareTo(product.getPrice()) > 0) {
            BigDecimal discount = product.getPrice().divide(product.getOriginalPrice(), 2, RoundingMode.HALF_UP);
            vo.setDiscountPercentage(discount.multiply(new BigDecimal("100")).intValue());
        } else {
            vo.setDiscountPercentage(100);
        }
        
        vo.setIsHot(product.getNewStatus() == 1);
        vo.setIsRecommended(product.getRecommendStatus() == 1);
        
        return vo;
    }
}
```

### ç¬¬3-4å¤©: å‰ç«¯ç§¯åˆ†çŠ¶æ€ç®¡ç†

#### 3.1 ç§¯åˆ†çŠ¶æ€åˆ‡ç‰‡
```typescript
// store/credits/creditsSlice.ts
import { createSlice, createAsyncThunk } from '@reduxjs/toolkit';
import { creditsAPI } from '@/api/credits';

interface CreditsState {
  balance: {
    totalCredits: number;
    freeCredits: number;
    usedTodayTotal: number;
    lastResetDate: string | null;
  } | null;
  history: CreditHistory[];
  products: CreditProduct[];
  loading: boolean;
  error: string | null;
  purchaseLoading: boolean;
}

const initialState: CreditsState = {
  balance: null,
  history: [],
  products: [],
  loading: false,
  error: null,
  purchaseLoading: false,
};

// å¼‚æ­¥thunks
export const fetchCreditsBalance = createAsyncThunk(
  'credits/fetchBalance',
  async () => {
    const response = await creditsAPI.getBalance();
    return response.data;
  }
);

export const fetchCreditsHistory = createAsyncThunk(
  'credits/fetchHistory',
  async (params: { pageNum: number; pageSize: number }) => {
    const response = await creditsAPI.getHistory(params);
    return response.data;
  }
);

export const fetchCreditProducts = createAsyncThunk(
  'credits/fetchProducts',
  async () => {
    const response = await creditsAPI.getProducts();
    return response.data;
  }
);

export const purchaseCredits = createAsyncThunk(
  'credits/purchase',
  async (productId: number) => {
    const response = await creditsAPI.purchaseCredits({ productId });
    return response.data;
  }
);

export const consumeCredits = createAsyncThunk(
  'credits/consume',
  async (params: ConsumeCreditsParams) => {
    const response = await creditsAPI.consumeCredits(params);
    return response.data;
  }
);

const creditsSlice = createSlice({
  name: 'credits',
  initialState,
  reducers: {
    clearError: (state) => {
      state.error = null;
    },
    // å®æ—¶æ›´æ–°ç§¯åˆ†ä½™é¢ (WebSocketæ¨é€ä½¿ç”¨)
    updateBalance: (state, action) => {
      state.balance = action.payload;
    },
  },
  extraReducers: (builder) => {
    builder
      // è·å–ç§¯åˆ†ä½™é¢
      .addCase(fetchCreditsBalance.pending, (state) => {
        state.loading = true;
        state.error = null;
      })
      .addCase(fetchCreditsBalance.fulfilled, (state, action) => {
        state.loading = false;
        state.balance = action.payload;
      })
      .addCase(fetchCreditsBalance.rejected, (state, action) => {
        state.loading = false;
        state.error = action.error.message || 'è·å–ç§¯åˆ†ä½™é¢å¤±è´¥';
      })
      // è·å–ç§¯åˆ†å†å²
      .addCase(fetchCreditsHistory.fulfilled, (state, action) => {
        state.history = action.payload.list;
      })
      // è·å–ç§¯åˆ†å•†å“
      .addCase(fetchCreditProducts.fulfilled, (state, action) => {
        state.products = action.payload;
      })
      // è´­ä¹°ç§¯åˆ†
      .addCase(purchaseCredits.pending, (state) => {
        state.purchaseLoading = true;
        state.error = null;
      })
      .addCase(purchaseCredits.fulfilled, (state) => {
        state.purchaseLoading = false;
        // è´­ä¹°æˆåŠŸåé‡æ–°è·å–ä½™é¢
      })
      .addCase(purchaseCredits.rejected, (state, action) => {
        state.purchaseLoading = false;
        state.error = action.error.message || 'è´­ä¹°å¤±è´¥';
      });
  },
});

export const { clearError, updateBalance } = creditsSlice.actions;
export default creditsSlice.reducer;
```

#### 3.2 ç§¯åˆ†APIæ¥å£
```typescript
// api/credits.ts
import { request } from '@/utils/request';

export const creditsAPI = {
  // è·å–ç§¯åˆ†ä½™é¢
  getBalance: () => 
    request.get<CreditsBalance>('/credits/balance'),

  // è·å–ç§¯åˆ†å†å²è®°å½•
  getHistory: (params: { pageNum: number; pageSize: number }) => 
    request.get<PageResult<CreditHistory>>('/credits/history', { params }),

  // è·å–ç§¯åˆ†å•†å“åˆ—è¡¨
  getProducts: () => 
    request.get<CreditProduct[]>('/credits/products'),

  // è´­ä¹°ç§¯åˆ†
  purchaseCredits: (data: { productId: number }) => 
    request.post('/credits/purchase', data),

  // æ¶ˆè´¹ç§¯åˆ†
  consumeCredits: (data: ConsumeCreditsParams) => 
    request.post('/credits/consume', data),

  // è·å–è´­ä¹°ç§¯åˆ†çš„æ”¯ä»˜ä¿¡æ¯
  getPaymentInfo: (orderId: number) => 
    request.get(`/credits/payment/${orderId}`),
};

// ç±»å‹å®šä¹‰
export interface CreditsBalance {
  totalCredits: number;
  freeCredits: number;
  usedTodayTotal: number;
  lastResetDate: string | null;
}

export interface CreditHistory {
  id: number;
  changeType: number;
  creditType: number;
  changeAmount: number;
  balanceAfter: number;
  description: string;
  businessId?: string;
  orderId?: number;
  createdTime: string;
}

export interface CreditProduct {
  id: number;
  name: string;
  description: string;
  creditAmount: number;
  price: number;
  originalPrice?: number;
  discountPercentage: number;
  isHot: boolean;
  isRecommended: boolean;
}

export interface ConsumeCreditsParams {
  amount: number;
  businessId: string;
  description: string;
}
```

### ç¬¬5-6å¤©: ç§¯åˆ†ä½™é¢æ˜¾ç¤ºç»„ä»¶

#### 5.1 ç§¯åˆ†æ˜¾ç¤ºç»„ä»¶ (Headerä¸­çš„ç§¯åˆ†æ˜¾ç¤º)
```typescript
// components/CreditsDisplay.tsx
import React, { useEffect, useState } from 'react';
import { Badge, Dropdown, Spin, Button, message } from 'antd';
import { ThunderboltOutlined, PlusOutlined, HistoryOutlined } from '@ant-design/icons';
import { useAppSelector, useAppDispatch } from '@/hooks/redux';
import { fetchCreditsBalance } from '@/store/credits/creditsSlice';
import { useNavigate } from 'react-router-dom';

const CreditsDisplay: React.FC = () => {
  const dispatch = useAppDispatch();
  const navigate = useNavigate();
  const { balance, loading } = useAppSelector(state => state.credits);
  const [dropdownVisible, setDropdownVisible] = useState(false);

  useEffect(() => {
    dispatch(fetchCreditsBalance());
  }, [dispatch]);

  const formatNumber = (num: number): string => {
    if (num >= 1000) {
      return (num / 1000).toFixed(1) + 'k';
    }
    return num.toString();
  };

  const handlePurchaseClick = () => {
    setDropdownVisible(false);
    navigate('/credits/purchase');
  };

  const handleHistoryClick = () => {
    setDropdownVisible(false);
    navigate('/credits/history');
  };

  const dropdownItems = [
    {
      key: 'balance',
      label: (
        <div className="px-2 py-3">
          <div className="flex justify-between items-center mb-4">
            <span className="font-semibold text-lg">Free</span>
            <Button 
              size="small" 
              type="default"
              onClick={handlePurchaseClick}
            >
              å‡çº§
            </Button>
          </div>
          
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <ThunderboltOutlined className="text-yellow-500" />
                <div>
                  <div className="font-medium">æ°¸ä¹…ç§¯åˆ†</div>
                  <div className="text-xs text-gray-500">æ°¸ä¹…æœ‰æ•ˆ</div>
                </div>
              </div>
              <div className="font-semibold">
                {balance ? formatNumber(balance.totalCredits) : '0'}
                <Button 
                  type="link" 
                  size="small" 
                  className="p-0 ml-2"
                  onClick={handlePurchaseClick}
                >
                  <PlusOutlined />
                </Button>
              </div>
            </div>
            
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <Badge color="blue" />
                <div>
                  <div className="font-medium">æ¯æ—¥å…è´¹ç§¯åˆ†</div>
                  <div className="text-xs text-gray-500">æ¯å¤©é‡ç½®ä¸º200å…è´¹ç§¯åˆ†</div>
                </div>
              </div>
              <div className="font-semibold">
                {balance ? balance.freeCredits : '200'}
              </div>
            </div>
          </div>
          
          <div className="mt-4 pt-3 border-t border-gray-100">
            <Button 
              type="link" 
              size="small" 
              className="p-0 text-gray-600 hover:text-blue-500"
              onClick={handleHistoryClick}
            >
              <HistoryOutlined className="mr-1" />
              Usage details &gt;
            </Button>
          </div>
        </div>
      ),
    }
  ];

  const totalAvailableCredits = balance ? balance.totalCredits + balance.freeCredits : 200;

  return (
    <Dropdown
      menu={{ items: dropdownItems }}
      trigger={['hover']}
      open={dropdownVisible}
      onOpenChange={setDropdownVisible}
      placement="bottomRight"
      overlayStyle={{ minWidth: 320 }}
    >
      <Button 
        type="text" 
        className="flex items-center gap-2 px-3 py-1 rounded-full bg-gray-700 hover:bg-gray-600 text-white"
      >
        <span>å‡çº§</span>
        <ThunderboltOutlined />
        {loading ? (
          <Spin size="small" className="text-white" />
        ) : (
          <span className="font-semibold">
            {formatNumber(totalAvailableCredits)}
          </span>
        )}
      </Button>
    </Dropdown>
  );
};

export default CreditsDisplay;
```

#### 5.2 ç§¯åˆ†ä½™é¢é¡µé¢ç»„ä»¶
```typescript
// components/CreditsBalanceCard.tsx
import React from 'react';
import { Card, Row, Col, Statistic, Progress, Button, Tooltip } from 'antd';
import { ThunderboltOutlined, GiftOutlined, ShoppingCartOutlined } from '@ant-design/icons';
import { useAppSelector } from '@/hooks/redux';
import { useNavigate } from 'react-router-dom';

const CreditsBalanceCard: React.FC = () => {
  const navigate = useNavigate();
  const { balance } = useAppSelector(state => state.credits);

  if (!balance) {
    return <Card loading />;
  }

  const totalCredits = balance.totalCredits + balance.freeCredits;
  const usagePercent = balance.usedTodayTotal > 0 ? 
    Math.round((balance.usedTodayTotal / (balance.usedTodayTotal + totalCredits)) * 100) : 0;

  return (
    <Card title="ç§¯åˆ†æ¦‚å†µ" className="mb-6">
      <Row gutter={24}>
        <Col xs={24} sm={12} lg={6}>
          <Statistic
            title="å¯ç”¨ç§¯åˆ†"
            value={totalCredits}
            prefix={<ThunderboltOutlined className="text-blue-500" />}
            valueStyle={{ color: '#1890ff' }}
          />
        </Col>
        
        <Col xs={24} sm={12} lg={6}>
          <Statistic
            title="æ°¸ä¹…ç§¯åˆ†"
            value={balance.totalCredits}
            prefix={<ThunderboltOutlined className="text-green-500" />}
            valueStyle={{ color: '#52c41a' }}
            suffix={
              <Tooltip title="ç‚¹å‡»è´­ä¹°æ›´å¤šç§¯åˆ†">
                <Button 
                  type="link" 
                  size="small" 
                  icon={<ShoppingCartOutlined />}
                  onClick={() => navigate('/credits/purchase')}
                />
              </Tooltip>
            }
          />
        </Col>
        
        <Col xs={24} sm={12} lg={6}>
          <Statistic
            title="å…è´¹ç§¯åˆ†"
            value={balance.freeCredits}
            prefix={<GiftOutlined className="text-orange-500" />}
            valueStyle={{ color: '#fa8c16' }}
            suffix="/ 200"
          />
        </Col>
        
        <Col xs={24} sm={12} lg={6}>
          <Statistic
            title="ä»Šæ—¥å·²ç”¨"
            value={balance.usedTodayTotal}
            valueStyle={{ color: '#8c8c8c' }}
          />
          <Progress
            percent={usagePercent}
            size="small"
            showInfo={false}
            strokeColor="#1890ff"
            className="mt-2"
          />
        </Col>
      </Row>
      
      <div className="mt-4 pt-4 border-t border-gray-100">
        <Row gutter={16}>
          <Col>
            <Button type="primary" onClick={() => navigate('/credits/purchase')}>
              è´­ä¹°ç§¯åˆ†
            </Button>
          </Col>
          <Col>
            <Button onClick={() => navigate('/credits/history')}>
              ä½¿ç”¨è®°å½•
            </Button>
          </Col>
        </Row>
      </div>
    </Card>
  );
};

export default CreditsBalanceCard;
```

### ç¬¬7-8å¤©: ç§¯åˆ†è´­ä¹°é¡µé¢å¼€å‘

#### 7.1 ç§¯åˆ†è´­ä¹°é¡µé¢
```typescript
// pages/CreditsPurchasePage.tsx
import React, { useEffect, useState } from 'react';
import { 
  Card, 
  Row, 
  Col, 
  Button, 
  Badge, 
  Typography, 
  Spin, 
  message,
  Modal 
} from 'antd';
import { 
  ThunderboltOutlined, 
  FireOutlined, 
  CrownOutlined,
  CheckCircleOutlined 
} from '@ant-design/icons';
import { useAppSelector, useAppDispatch } from '@/hooks/redux';
import { fetchCreditProducts, purchaseCredits } from '@/store/credits/creditsSlice';
import { useNavigate } from 'react-router-dom';
import PaymentModal from '@/components/PaymentModal';

const { Title, Text } = Typography;

const CreditsPurchasePage: React.FC = () => {
  const dispatch = useAppDispatch();
  const navigate = useNavigate();
  const { products, purchaseLoading } = useAppSelector(state => state.credits);
  const [selectedProduct, setSelectedProduct] = useState<number | null>(null);
  const [paymentModalVisible, setPaymentModalVisible] = useState(false);
  const [currentOrder, setCurrentOrder] = useState<any>(null);

  useEffect(() => {
    dispatch(fetchCreditProducts());
  }, [dispatch]);

  const handlePurchase = async (productId: number) => {
    try {
      setSelectedProduct(productId);
      const result = await dispatch(purchaseCredits(productId)).unwrap();
      
      // æ˜¾ç¤ºæ”¯ä»˜å¼¹çª—
      setCurrentOrder(result);
      setPaymentModalVisible(true);
    } catch (error: any) {
      message.error(error.message || 'åˆ›å»ºè®¢å•å¤±è´¥');
    } finally {
      setSelectedProduct(null);
    }
  };

  const handlePaymentSuccess = () => {
    setPaymentModalVisible(false);
    setCurrentOrder(null);
    message.success('è´­ä¹°æˆåŠŸï¼ç§¯åˆ†å·²åˆ°è´¦');
    navigate('/credits');
  };

  const formatPrice = (price: number) => {
    return `Â¥${price.toFixed(2)}`;
  };

  const calculateSavings = (price: number, originalPrice?: number) => {
    if (!originalPrice || originalPrice <= price) return null;
    const savings = originalPrice - price;
    return `çœ${savings.toFixed(2)}å…ƒ`;
  };

  const getProductIcon = (product: any) => {
    if (product.isHot) return <FireOutlined className="text-red-500" />;
    if (product.isRecommended) return <CrownOutlined className="text-yellow-500" />;
    return <ThunderboltOutlined className="text-blue-500" />;
  };

  const getProductBadge = (product: any) => {
    if (product.isHot) return <Badge.Ribbon text="çƒ­é—¨" color="red" />;
    if (product.isRecommended) return <Badge.Ribbon text="æ¨è" color="gold" />;
    return null;
  };

  return (
    <div className="max-w-7xl mx-auto p-6">
      <div className="text-center mb-8">
        <Title level={2}>è´­ä¹°ç§¯åˆ†</Title>
        <Text type="secondary" className="text-lg">
          é€‰æ‹©é€‚åˆä½ çš„ç§¯åˆ†å¥—é¤ï¼Œå¼€å¯æ— é™åˆ›æ„ä¹‹æ—…
        </Text>
      </div>

      <Row gutter={[24, 24]} justify="center">
        {products.map((product) => (
          <Col key={product.id} xs={24} sm={12} lg={8} xl={6}>
            {getProductBadge(product)}
            <Card
              className={`h-full transition-all duration-300 hover:shadow-lg hover:scale-105 ${
                product.isRecommended ? 'border-yellow-400 shadow-md' : ''
              }`}
              bodyStyle={{ padding: '24px' }}
            >
              <div className="text-center">
                <div className="text-4xl mb-4">
                  {getProductIcon(product)}
                </div>
                
                <Title level={4} className="mb-2">
                  {product.name}
                </Title>
                
                <Text type="secondary" className="block mb-4">
                  {product.description}
                </Text>
                
                <div className="mb-4">
                  <div className="text-3xl font-bold text-blue-500 mb-1">
                    <ThunderboltOutlined className="mr-1" />
                    {product.creditAmount.toLocaleString()}
                  </div>
                  <Text type="secondary">ç§¯åˆ†</Text>
                </div>
                
                <div className="mb-6">
                  <div className="text-2xl font-bold text-red-500">
                    {formatPrice(product.price)}
                  </div>
                  {product.originalPrice && product.originalPrice > product.price && (
                    <div className="text-sm text-gray-400">
                      <span className="line-through mr-2">
                        {formatPrice(product.originalPrice)}
                      </span>
                      <span className="text-green-500">
                        {calculateSavings(product.price, product.originalPrice)}
                      </span>
                    </div>
                  )}
                  {product.discountPercentage > 0 && (
                    <div className="text-sm text-orange-500 mt-1">
                      é™æ—¶{product.discountPercentage}æŠ˜ä¼˜æƒ 
                    </div>
                  )}
                </div>
                
                <div className="mb-4 text-left">
                  <div className="flex items-center mb-2">
                    <CheckCircleOutlined className="text-green-500 mr-2" />
                    <span className="text-sm">ç«‹å³åˆ°è´¦</span>
                  </div>
                  <div className="flex items-center mb-2">
                    <CheckCircleOutlined className="text-green-500 mr-2" />
                    <span className="text-sm">æ°¸ä¸è¿‡æœŸ</span>
                  </div>
                  <div className="flex items-center">
                    <CheckCircleOutlined className="text-green-500 mr-2" />
                    <span className="text-sm">æ”¯æŒé€€æ¬¾</span>
                  </div>
                </div>
                
                <Button
                  type={product.isRecommended ? 'primary' : 'default'}
                  size="large"
                  block
                  loading={selectedProduct === product.id && purchaseLoading}
                  onClick={() => handlePurchase(product.id)}
                  className={product.isRecommended ? 'bg-gradient-to-r from-blue-500 to-purple-600' : ''}
                >
                  ç«‹å³è´­ä¹°
                </Button>
              </div>
            </Card>
          </Col>
        ))}
      </Row>
      
      <div className="text-center mt-8">
        <Text type="secondary">
          è´­ä¹°åç§¯åˆ†å°†ç«‹å³åˆ°è´¦ï¼Œå¦‚æœ‰é—®é¢˜è¯·è”ç³»å®¢æœ
        </Text>
      </div>

      <PaymentModal
        visible={paymentModalVisible}
        order={currentOrder}
        onSuccess={handlePaymentSuccess}
        onCancel={() => setPaymentModalVisible(false)}
      />
    </div>
  );
};

export default CreditsPurchasePage;
```

### ç¬¬9-10å¤©: ç§¯åˆ†ä½¿ç”¨è®°å½•é¡µé¢

#### 9.1 ç§¯åˆ†å†å²è®°å½•é¡µé¢
```typescript
// pages/CreditsHistoryPage.tsx
import React, { useEffect, useState } from 'react';
import { 
  Card, 
  Table, 
  Tag, 
  Typography, 
  DatePicker, 
  Select, 
  Row, 
  Col,
  Button,
  Space
} from 'antd';
import { 
  ThunderboltOutlined,
  PlusOutlined, 
  MinusOutlined,
  ReloadOutlined,
  GiftOutlined 
} from '@ant-design/icons';
import { useAppSelector, useAppDispatch } from '@/hooks/redux';
import { fetchCreditsHistory } from '@/store/credits/creditsSlice';
import { CreditsBalanceCard } from '@/components';
import dayjs from 'dayjs';

const { Title } = Typography;
const { RangePicker } = DatePicker;
const { Option } = Select;

const CreditsHistoryPage: React.FC = () => {
  const dispatch = useAppDispatch();
  const { history, loading } = useAppSelector(state => state.credits);
  
  const [filters, setFilters] = useState({
    dateRange: null as any,
    changeType: null as number | null,
    creditType: null as number | null,
  });
  
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 20,
    total: 0,
  });

  useEffect(() => {
    fetchData();
  }, [dispatch, pagination.current, pagination.pageSize, filters]);

  const fetchData = () => {
    dispatch(fetchCreditsHistory({
      pageNum: pagination.current,
      pageSize: pagination.pageSize,
      ...filters
    }));
  };

  const getChangeTypeTag = (changeType: number) => {
    const typeMap = {
      1: { text: 'è´­ä¹°è·å¾—', color: 'green', icon: <PlusOutlined /> },
      2: { text: 'ä½¿ç”¨æ‰£å‡', color: 'red', icon: <MinusOutlined /> },
      3: { text: 'æ¯æ—¥é‡ç½®', color: 'blue', icon: <ReloadOutlined /> },
      4: { text: 'ç³»ç»Ÿèµ é€', color: 'purple', icon: <GiftOutlined /> },
    };
    
    const config = typeMap[changeType as keyof typeof typeMap] || { text: 'æœªçŸ¥', color: 'default', icon: null };
    
    return (
      <Tag color={config.color} icon={config.icon}>
        {config.text}
      </Tag>
    );
  };

  const getCreditTypeTag = (creditType: number) => {
    return creditType === 1 ? (
      <Tag color="orange">å…è´¹ç§¯åˆ†</Tag>
    ) : (
      <Tag color="blue">æ°¸ä¹…ç§¯åˆ†</Tag>
    );
  };

  const formatAmount = (amount: number, changeType: number) => {
    const isPositive = amount > 0;
    const displayAmount = Math.abs(amount);
    
    return (
      <span className={isPositive ? 'text-green-600' : 'text-red-600'}>
        {isPositive ? '+' : '-'}
        <ThunderboltOutlined className="mr-1" />
        {displayAmount.toLocaleString()}
      </span>
    );
  };

  const columns = [
    {
      title: 'æ—¶é—´',
      dataIndex: 'createdTime',
      key: 'createdTime',
      width: 180,
      render: (text: string) => dayjs(text).format('YYYY-MM-DD HH:mm:ss'),
    },
    {
      title: 'å˜åŠ¨ç±»å‹',
      dataIndex: 'changeType',
      key: 'changeType',
      width: 120,
      render: (changeType: number) => getChangeTypeTag(changeType),
    },
    {
      title: 'ç§¯åˆ†ç±»å‹',
      dataIndex: 'creditType',
      key: 'creditType',
      width: 100,
      render: (creditType: number) => getCreditTypeTag(creditType),
    },
    {
      title: 'å˜åŠ¨æ•°é‡',
      dataIndex: 'changeAmount',
      key: 'changeAmount',
      width: 120,
      render: (amount: number, record: any) => formatAmount(amount, record.changeType),
    },
    {
      title: 'å˜åŠ¨åä½™é¢',
      dataIndex: 'balanceAfter',
      key: 'balanceAfter',
      width: 120,
      render: (balance: number) => (
        <span>
          <ThunderboltOutlined className="mr-1 text-blue-500" />
          {balance.toLocaleString()}
        </span>
      ),
    },
    {
      title: 'æè¿°',
      dataIndex: 'description',
      key: 'description',
      ellipsis: true,
      render: (text: string) => text || '-',
    },
    {
      title: 'ä¸šåŠ¡ID',
      dataIndex: 'businessId',
      key: 'businessId',
      width: 120,
      render: (text: string) => text || '-',
    },
  ];

  const handleTableChange = (paginationConfig: any) => {
    setPagination({
      ...pagination,
      current: paginationConfig.current,
      pageSize: paginationConfig.pageSize,
    });
  };

  const handleReset = () => {
    setFilters({
      dateRange: null,
      changeType: null,
      creditType: null,
    });
    setPagination({ ...pagination, current: 1 });
  };

  return (
    <div className="max-w-7xl mx-auto p-6">
      <Title level={2} className="mb-6">ç§¯åˆ†ç®¡ç†</Title>
      
      <CreditsBalanceCard />
      
      <Card title="ç§¯åˆ†ä½¿ç”¨è®°å½•" className="mb-6">
        <Row gutter={16} className="mb-4">
          <Col xs={24} sm={12} md={6}>
            <RangePicker
              placeholder={['å¼€å§‹æ—¥æœŸ', 'ç»“æŸæ—¥æœŸ']}
              value={filters.dateRange}
              onChange={(dates) => setFilters({ ...filters, dateRange: dates })}
              className="w-full"
            />
          </Col>
          <Col xs={24} sm={12} md={4}>
            <Select
              placeholder="å˜åŠ¨ç±»å‹"
              value={filters.changeType}
              onChange={(value) => setFilters({ ...filters, changeType: value })}
              className="w-full"
              allowClear
            >
              <Option value={1}>è´­ä¹°è·å¾—</Option>
              <Option value={2}>ä½¿ç”¨æ‰£å‡</Option>
              <Option value={3}>æ¯æ—¥é‡ç½®</Option>
              <Option value={4}>ç³»ç»Ÿèµ é€</Option>
            </Select>
          </Col>
          <Col xs={24} sm={12} md={4}>
            <Select
              placeholder="ç§¯åˆ†ç±»å‹"
              value={filters.creditType}
              onChange={(value) => setFilters({ ...filters, creditType: value })}
              className="w-full"
              allowClear
            >
              <Option value={1}>å…è´¹ç§¯åˆ†</Option>
              <Option value={2}>æ°¸ä¹…ç§¯åˆ†</Option>
            </Select>
          </Col>
          <Col xs={24} sm={12} md={4}>
            <Space>
              <Button onClick={fetchData}>æŸ¥è¯¢</Button>
              <Button onClick={handleReset}>é‡ç½®</Button>
            </Space>
          </Col>
        </Row>

        <Table
          dataSource={history}
          columns={columns}
          loading={loading}
          pagination={{
            ...pagination,
            showSizeChanger: true,
            showQuickJumper: true,
            showTotal: (total, range) => 
              `ç¬¬ ${range[0]}-${range[1]} æ¡/å…± ${total} æ¡`,
          }}
          onChange={handleTableChange}
          rowKey="id"
        />
      </Card>
    </div>
  );
};

export default CreditsHistoryPage;
```

### ç¬¬11-12å¤©: ç§¯åˆ†æ¶ˆè´¹é€»è¾‘é›†æˆ

#### 11.1 ç§¯åˆ†æ¶ˆè´¹Hook
```typescript
// hooks/useCreditsConsume.ts
import { useState } from 'react';
import { message } from 'antd';
import { useAppDispatch } from '@/hooks/redux';
import { consumeCredits, fetchCreditsBalance } from '@/store/credits/creditsSlice';

export const useCreditsConsume = () => {
  const dispatch = useAppDispatch();
  const [consuming, setConsuming] = useState(false);

  const consume = async (amount: number, businessId: string, description: string) => {
    if (consuming) return false;

    setConsuming(true);
    try {
      await dispatch(consumeCredits({
        amount,
        businessId,
        description
      })).unwrap();

      // åˆ·æ–°ä½™é¢
      dispatch(fetchCreditsBalance());
      
      message.success(`æ¶ˆè´¹ ${amount} ç§¯åˆ†æˆåŠŸ`);
      return true;
    } catch (error: any) {
      if (error.message?.includes('ç§¯åˆ†ä¸è¶³')) {
        message.error('ç§¯åˆ†ä¸è¶³ï¼Œè¯·è´­ä¹°ç§¯åˆ†æˆ–ç­‰å¾…æ¯æ—¥å…è´¹ç§¯åˆ†é‡ç½®');
      } else {
        message.error(error.message || 'ç§¯åˆ†æ¶ˆè´¹å¤±è´¥');
      }
      return false;
    } finally {
      setConsuming(false);
    }
  };

  return {
    consume,
    consuming,
  };
};
```

#### 11.2 ç§¯åˆ†ä¸è¶³æç¤ºç»„ä»¶
```typescript
// components/InsufficientCreditsModal.tsx
import React from 'react';
import { Modal, Button, Card, Row, Col, Typography } from 'antd';
import { ThunderboltOutlined, ShoppingCartOutlined } from '@ant-design/icons';
import { useNavigate } from 'react-router-dom';

const { Title, Text } = Typography;

interface InsufficientCreditsModalProps {
  visible: boolean;
  requiredCredits: number;
  currentCredits: number;
  onCancel: () => void;
}

const InsufficientCreditsModal: React.FC<InsufficientCreditsModalProps> = ({
  visible,
  requiredCredits,
  currentCredits,
  onCancel,
}) => {
  const navigate = useNavigate();

  const handlePurchase = () => {
    onCancel();
    navigate('/credits/purchase');
  };

  const shortfall = requiredCredits - currentCredits;

  return (
    <Modal
      title="ç§¯åˆ†ä¸è¶³"
      open={visible}
      onCancel={onCancel}
      footer={null}
      width={500}
    >
      <div className="text-center py-4">
        <div className="text-6xl mb-4">
          <ThunderboltOutlined className="text-red-500" />
        </div>
        
        <Title level={4} className="mb-2">
          ç§¯åˆ†ä½™é¢ä¸è¶³
        </Title>
        
        <Text type="secondary" className="block mb-6">
          å®Œæˆæ­¤æ“ä½œéœ€è¦æ›´å¤šç§¯åˆ†
        </Text>
        
        <Card className="mb-6">
          <Row gutter={16}>
            <Col span={8}>
              <div className="text-center">
                <div className="text-lg font-bold text-red-500">
                  {requiredCredits}
                </div>
                <div className="text-sm text-gray-500">éœ€è¦ç§¯åˆ†</div>
              </div>
            </Col>
            <Col span={8}>
              <div className="text-center">
                <div className="text-lg font-bold text-blue-500">
                  {currentCredits}
                </div>
                <div className="text-sm text-gray-500">å½“å‰ç§¯åˆ†</div>
              </div>
            </Col>
            <Col span={8}>
              <div className="text-center">
                <div className="text-lg font-bold text-orange-500">
                  {shortfall}
                </div>
                <div className="text-sm text-gray-500">ç¼ºå°‘ç§¯åˆ†</div>
              </div>
            </Col>
          </Row>
        </Card>
        
        <div className="space-y-3">
          <Button
            type="primary"
            size="large"
            block
            icon={<ShoppingCartOutlined />}
            onClick={handlePurchase}
          >
            ç«‹å³è´­ä¹°ç§¯åˆ†
          </Button>
          
          <Button size="large" block onClick={onCancel}>
            å–æ¶ˆæ“ä½œ
          </Button>
        </div>
        
        <div className="mt-4 p-3 bg-blue-50 rounded-lg">
          <Text className="text-sm text-blue-600">
            ğŸ’¡ æç¤ºï¼šæ¯æ—¥0ç‚¹ä¼šè‡ªåŠ¨é‡ç½®200å…è´¹ç§¯åˆ†
          </Text>
        </div>
      </div>
    </Modal>
  );
};

export default InsufficientCreditsModal;
```

#### 11.3 AIåŠŸèƒ½ä¸­ç§¯åˆ†æ¶ˆè´¹é›†æˆç¤ºä¾‹
```typescript
// components/AITaskComponent.tsx
import React, { useState } from 'react';
import { Button, message, Input } from 'antd';
import { useAppSelector } from '@/hooks/redux';
import { useCreditsConsume } from '@/hooks/useCreditsConsume';
import InsufficientCreditsModal from '@/components/InsufficientCreditsModal';

const AITaskComponent: React.FC = () => {
  const [taskInput, setTaskInput] = useState('');
  const [processing, setProcessing] = useState(false);
  const [showInsufficientModal, setShowInsufficientModal] = useState(false);
  
  const { balance } = useAppSelector(state => state.credits);
  const { consume, consuming } = useCreditsConsume();

  const TASK_COST = 10; // æ¯æ¬¡AIä»»åŠ¡æ¶ˆè´¹10ç§¯åˆ†

  const handleStartTask = async () => {
    if (!taskInput.trim()) {
      message.warning('è¯·è¾“å…¥ä»»åŠ¡å†…å®¹');
      return;
    }

    // æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
    if (balance) {
      const availableCredits = balance.totalCredits + balance.freeCredits;
      if (availableCredits < TASK_COST) {
        setShowInsufficientModal(true);
        return;
      }
    }

    setProcessing(true);
    
    // å…ˆæ‰£é™¤ç§¯åˆ†
    const businessId = `ai_task_${Date.now()}`;
    const success = await consume(
      TASK_COST, 
      businessId, 
      `AIä»»åŠ¡: ${taskInput.substring(0, 20)}...`
    );
    
    if (success) {
      try {
        // æ‰§è¡ŒAIä»»åŠ¡
        await executeAITask(taskInput, businessId);
        message.success('AIä»»åŠ¡æ‰§è¡ŒæˆåŠŸ');
      } catch (error) {
        // å¦‚æœAIä»»åŠ¡å¤±è´¥ï¼Œå¯ä»¥è€ƒè™‘é€€è¿˜ç§¯åˆ†
        message.error('AIä»»åŠ¡æ‰§è¡Œå¤±è´¥');
      }
    }
    
    setProcessing(false);
  };

  const executeAITask = async (input: string, businessId: string) => {
    // æ¨¡æ‹ŸAIä»»åŠ¡æ‰§è¡Œ
    return new Promise((resolve) => {
      setTimeout(resolve, 2000);
    });
  };

  const availableCredits = balance ? balance.totalCredits + balance.freeCredits : 0;

  return (
    <div className="p-4">
      <div className="mb-4">
        <Input.TextArea
          value={taskInput}
          onChange={(e) => setTaskInput(e.target.value)}
          placeholder="è¾“å…¥æ‚¨çš„AIä»»åŠ¡æè¿°..."
          rows={4}
        />
      </div>
      
      <div className="flex justify-between items-center">
        <div className="text-sm text-gray-600">
          æ¶ˆè´¹ç§¯åˆ†: {TASK_COST} | å¯ç”¨ç§¯åˆ†: {availableCredits}
        </div>
        
        <Button
          type="primary"
          onClick={handleStartTask}
          loading={processing || consuming}
          disabled={availableCredits < TASK_COST}
        >
          å¼€å§‹AIä»»åŠ¡ (-{TASK_COST}ç§¯åˆ†)
        </Button>
      </div>

      <InsufficientCreditsModal
        visible={showInsufficientModal}
        requiredCredits={TASK_COST}
        currentCredits={availableCredits}
        onCancel={() => setShowInsufficientModal(false)}
      />
    </div>
  );
};

export default AITaskComponent;
```

## è´¨é‡ä¿è¯

### åŠŸèƒ½æµ‹è¯•æ¸…å•
- [ ] ç§¯åˆ†ä½™é¢æ­£ç¡®æ˜¾ç¤º
- [ ] æ¯æ—¥ç§¯åˆ†é‡ç½®åŠŸèƒ½æ­£å¸¸
- [ ] ç§¯åˆ†è´­ä¹°æµç¨‹å®Œæ•´
- [ ] ç§¯åˆ†æ¶ˆè´¹é€»è¾‘æ­£ç¡®(ä¼˜å…ˆä½¿ç”¨å…è´¹ç§¯åˆ†)
- [ ] ç§¯åˆ†å˜åŠ¨è®°å½•å‡†ç¡®
- [ ] ç§¯åˆ†ä¸è¶³æç¤ºå‹å¥½
- [ ] å®æ—¶ç§¯åˆ†æ›´æ–°

### æ€§èƒ½æµ‹è¯•
- [ ] ç§¯åˆ†æŸ¥è¯¢å“åº”æ—¶é—´ < 500ms
- [ ] ç§¯åˆ†æ¶ˆè´¹å¹¶å‘å¤„ç†æ­£ç¡®
- [ ] å¤§é‡å†å²è®°å½•åˆ†é¡µåŠ è½½æ­£å¸¸
- [ ] ç§¯åˆ†è´­ä¹°æ”¯ä»˜æµç¨‹ç¨³å®š

### å®‰å…¨æµ‹è¯•
- [ ] ç§¯åˆ†æ¶ˆè´¹æƒé™éªŒè¯
- [ ] é˜²æ­¢é‡å¤æ‰£è´¹
- [ ] ç§¯åˆ†æ•°æ®ä¸€è‡´æ€§
- [ ] æ¶æ„è¯·æ±‚é˜²æŠ¤

## åç«¯æ•°æ®åº“æ‰©å±•è¡¥å……

### æ•°æ®åº“Mapperæ‰©å±•
```java
// UmsMemberMapper.java éœ€è¦æ‰©å±•çš„æ–¹æ³•
public interface UmsMemberMapper {
    // åŸæœ‰æ–¹æ³•...
    
    /**
     * æŸ¥è¯¢éœ€è¦é‡ç½®æ¯æ—¥ç§¯åˆ†çš„ç”¨æˆ·
     */
    @Select("SELECT * FROM ums_member WHERE last_reset_date IS NULL OR last_reset_date < #{today}")
    List<UmsMember> selectMembersForDailyReset(@Param("today") LocalDate today);
}

// UmsIntegrationChangeHistoryMapper.java éœ€è¦æ‰©å±•çš„æ–¹æ³•
public interface UmsIntegrationChangeHistoryMapper {
    // åŸæœ‰æ–¹æ³•...
    
    /**
     * æŒ‰ç”¨æˆ·æŸ¥è¯¢ç§¯åˆ†å˜åŠ¨å†å²
     */
    @Select("SELECT * FROM ums_integration_change_history WHERE member_id = #{memberId} ORDER BY create_time DESC")
    List<UmsIntegrationChangeHistory> selectByMemberId(@Param("memberId") Long memberId);
    
    /**
     * æŒ‰æ¡ä»¶æŸ¥è¯¢ç§¯åˆ†å˜åŠ¨å†å²
     */
    List<UmsIntegrationChangeHistory> selectByMemberIdWithConditions(
        @Param("memberId") Long memberId,
        @Param("startDate") Date startDate,
        @Param("endDate") Date endDate,
        @Param("changeType") Integer changeType,
        @Param("creditType") Byte creditType
    );
}

// PmsProductMapper.java éœ€è¦æ‰©å±•çš„æ–¹æ³•
public interface PmsProductMapper {
    // åŸæœ‰æ–¹æ³•...
    
    /**
     * æŒ‰å•†å“ç±»å‹æŸ¥è¯¢å•†å“åˆ—è¡¨
     */
    @Select("SELECT * FROM pms_product WHERE product_type = #{productType} AND publish_status = 1 ORDER BY sort ASC")
    List<PmsProduct> selectByProductType(@Param("productType") Integer productType);
}
```

### VOç±»å®šä¹‰
```java
// MemberCreditsVO.java - ç”¨æˆ·ç§¯åˆ†ä¿¡æ¯è¿”å›å¯¹è±¡
public class MemberCreditsVO {
    private Integer totalCredits;      // æ°¸ä¹…ç§¯åˆ†
    private Integer freeCredits;       // å¯ç”¨å…è´¹ç§¯åˆ†
    private Integer usedTodayTotal;    // ä»Šæ—¥å·²ç”¨
    private Date lastResetDate;        // æœ€åé‡ç½®æ—¥æœŸ
    
    // getters and setters...
}

// CreditsBalanceVO.java - ç§¯åˆ†ä½™é¢æ˜¾ç¤ºå¯¹è±¡ 
public class CreditsBalanceVO {
    private Integer totalCredits;
    private Integer freeCredits;
    private Integer usedTodayTotal;
    private Date lastResetDate;
    
    // getters and setters...
}

// CreditsHistoryVO.java - ç§¯åˆ†å†å²è®°å½•æ˜¾ç¤ºå¯¹è±¡
public class CreditsHistoryVO {
    private Long id;
    private Integer changeType;        // 0-è·å¾—, 1-æ¶ˆè´¹
    private Byte creditType;          // 1-å…è´¹ç§¯åˆ†, 2-æ°¸ä¹…ç§¯åˆ†
    private Integer changeAmount;
    private Integer balanceAfter;
    private String description;
    private String businessId;
    private Date createdTime;
    
    // getters and setters...
}

// CreditProductVO.java - ç§¯åˆ†å•†å“æ˜¾ç¤ºå¯¹è±¡
public class CreditProductVO {
    private Long id;
    private String name;
    private String description;
    private Integer creditAmount;
    private BigDecimal price;
    private BigDecimal originalPrice;
    private Integer discountPercentage;
    private Boolean isHot;
    private Boolean isRecommended;
    
    // getters and setters...
}
```

## äº¤ä»˜ç‰©

### å‰ç«¯ä»£ç 
- [ ] ç§¯åˆ†çŠ¶æ€ç®¡ç† (Redux)
- [ ] ç§¯åˆ†æ˜¾ç¤ºç»„ä»¶
- [ ] ç§¯åˆ†è´­ä¹°é¡µé¢
- [ ] ç§¯åˆ†å†å²é¡µé¢
- [ ] ç§¯åˆ†æ¶ˆè´¹Hook
- [ ] ç§¯åˆ†ä¸è¶³æç¤ºç»„ä»¶

### åç«¯ä»£ç 
- [ ] ç§¯åˆ†æœåŠ¡å®ç°
- [ ] ç§¯åˆ†APIæ¥å£
- [ ] ç§¯åˆ†å•†å“ç®¡ç†
- [ ] æ¯æ—¥é‡ç½®å®šæ—¶ä»»åŠ¡
- [ ] ç§¯åˆ†å˜åŠ¨è®°å½•

### æ•°æ®åº“è®¾è®¡
- [ ] ç§¯åˆ†ç›¸å…³æ•°æ®è¡¨
- [ ] ç´¢å¼•ä¼˜åŒ–
- [ ] åˆå§‹åŒ–æ•°æ®è„šæœ¬

## éªŒæ”¶æ ‡å‡†

1. **åŠŸèƒ½å®Œæ•´æ€§**: ç§¯åˆ†ç³»ç»Ÿå„åŠŸèƒ½100%å¯ç”¨
2. **æ•°æ®å‡†ç¡®æ€§**: ç§¯åˆ†å˜åŠ¨è®°å½•å‡†ç¡®æ— è¯¯
3. **ç”¨æˆ·ä½“éªŒ**: ç§¯åˆ†æ“ä½œå“åº”åŠæ—¶ï¼Œæç¤ºå‹å¥½
4. **æ€§èƒ½æŒ‡æ ‡**: ç§¯åˆ†æŸ¥è¯¢ < 500msï¼Œæ¶ˆè´¹ < 1s
5. **å®‰å…¨æ€§**: é€šè¿‡å®‰å…¨å®¡è®¡ï¼Œé˜²æ­¢ç§¯åˆ†æ»¥ç”¨

## é£é™©æ§åˆ¶

### ä¸šåŠ¡é£é™©
1. **ç§¯åˆ†æ»¥ç”¨**: å®ç°é¢‘ç‡é™åˆ¶å’Œè¡Œä¸ºç›‘æ§
2. **æ•°æ®ä¸ä¸€è‡´**: ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
3. **æ¶æ„åˆ·ç§¯åˆ†**: å®ç°é˜²åˆ·æœºåˆ¶

### æŠ€æœ¯é£é™©
1. **å¹¶å‘é—®é¢˜**: ä½¿ç”¨ä¹è§‚é”å¤„ç†å¹¶å‘æ¶ˆè´¹
2. **æ€§èƒ½é—®é¢˜**: å®ç°ç§¯åˆ†ç¼“å­˜ç­–ç•¥
3. **æ•°æ®ä¸¢å¤±**: åšå¥½æ•°æ®å¤‡ä»½å’Œæ¢å¤

å®Œæˆæ­¤é˜¶æ®µåï¼Œç”¨æˆ·å°†æ‹¥æœ‰å®Œæ•´çš„ç§¯åˆ†ç®¡ç†ä½“éªŒï¼Œä¸ºåç»­çš„å¥—é¤ç®¡ç†å’Œæ”¯ä»˜ç³»ç»Ÿæä¾›åŸºç¡€ã€‚