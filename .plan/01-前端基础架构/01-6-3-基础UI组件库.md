# 01-6-3-基础UI组件库

## 任务概述
- **时间估算**: 45分钟
- **优先级**: 中
- **依赖关系**: 
  - 依赖：01-6-2-Ant Design集成（UI组件基础）
  - 依赖：01-4-5-自定义Hooks（工具Hook支持）
  - 前置：Ant Design和Tailwind CSS集成完成
- **执行阶段**: 第一阶段-前端基础架构

## 详细任务清单

### 6.3.1 创建基础组件结构
- [ ] 设计组件目录结构
- [ ] 创建组件基础模板
- [ ] 定义组件接口规范
- [ ] 设置组件样式规范

### 6.3.2 开发表单相关组件
- [ ] 创建增强的Input组件
- [ ] 开发FormItem包装组件
- [ ] 实现Select增强组件
- [ ] 创建DatePicker扩展组件

### 6.3.3 开发展示相关组件
- [ ] 创建数据展示组件
- [ ] 开发状态指示组件
- [ ] 实现头像组件增强
- [ ] 创建标签组件扩展

### 6.3.4 开发交互组件
- [ ] 创建确认对话框组件
- [ ] 开发上传组件增强
- [ ] 实现搜索组件
- [ ] 创建操作按钮组组件

## 验收标准

### 功能验收
- [ ] 所有组件功能正常工作
- [ ] 组件接口设计合理
- [ ] 样式风格统一美观
- [ ] 响应式设计良好

### 代码质量验收
- [ ] 组件代码结构清晰
- [ ] TypeScript类型定义完整
- [ ] 组件复用性良好
- [ ] 文档注释完整

### 用户体验验收
- [ ] 组件交互响应及时
- [ ] 错误处理用户友好
- [ ] 加载状态反馈明确
- [ ] 无障碍性支持良好

## 交付物

### 1. 基础组件库
```
src/components/ui/
├── Input/                 # 输入组件
│   ├── index.tsx
│   ├── types.ts
│   └── styles.module.css
├── Button/                # 按钮组件
├── Select/                # 选择器组件
├── DatePicker/            # 日期选择器
├── Upload/                # 上传组件
└── index.ts               # 组件统一导出
```

### 2. 复合组件库
```
src/components/composite/
├── SearchBox/             # 搜索框组件
├── UserAvatar/            # 用户头像组件
├── StatusBadge/           # 状态徽章组件
├── ActionButtons/         # 操作按钮组
├── DataDisplay/           # 数据展示组件
└── ConfirmDialog/         # 确认对话框
```

### 3. 组件工具函数
```
src/components/utils/
├── componentHelpers.ts    # 组件辅助函数
├── styleUtils.ts          # 样式工具函数
├── validationHelpers.ts   # 验证辅助函数
└── formatters.ts          # 格式化工具
```

## 技术要点

### 增强的Input组件
```typescript
// src/components/ui/Input/index.tsx
import React, { forwardRef, useState } from 'react';
import { Input as AntInput, InputProps as AntInputProps } from 'antd';
import { EyeInvisibleOutlined, EyeTwoTone, ClearOutlined } from '@ant-design/icons';
import { cn } from '@/utils/styles/classNames';
import { InputProps } from './types';

const Input = forwardRef<HTMLInputElement, InputProps>(
  ({
    label,
    error,
    helperText,
    required,
    clearable = false,
    showCount = false,
    className,
    wrapperClassName,
    ...props
  }, ref) => {
    const [focused, setFocused] = useState(false);
    const [value, setValue] = useState(props.value || props.defaultValue || '');

    const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
      setValue(e.target.value);
      props.onChange?.(e);
    };

    const handleClear = () => {
      setValue('');
      props.onChange?.({
        target: { value: '' }
      } as React.ChangeEvent<HTMLInputElement>);
    };

    const inputProps: AntInputProps = {
      ...props,
      ref,
      value: props.value ?? value,
      onChange: handleChange,
      onFocus: (e) => {
        setFocused(true);
        props.onFocus?.(e);
      },
      onBlur: (e) => {
        setFocused(false);
        props.onBlur?.(e);
      },
      status: error ? 'error' : undefined,
      className: cn(
        'transition-all duration-200',
        {
          'border-primary-500 shadow-sm': focused && !error,
          'border-red-500': error,
        },
        className
      ),
    };

    // 添加清除按钮
    if (clearable && value) {
      inputProps.suffix = (
        <ClearOutlined 
          className="cursor-pointer text-gray-400 hover:text-gray-600" 
          onClick={handleClear}
        />
      );
    }

    // 添加字数统计
    if (showCount) {
      inputProps.showCount = {
        formatter: ({ count, maxLength }) => 
          `${count}${maxLength ? ` / ${maxLength}` : ''}`,
      };
    }

    return (
      <div className={cn('flex flex-col gap-1', wrapperClassName)}>
        {label && (
          <label className={cn(
            'text-sm font-medium text-gray-700 dark:text-gray-300',
            { 'after:content-["*"] after:text-red-500 after:ml-1': required }
          )}>
            {label}
          </label>
        )}
        
        <AntInput {...inputProps} />
        
        {(error || helperText) && (
          <div className={cn(
            'text-xs',
            error ? 'text-red-600 dark:text-red-400' : 'text-gray-500 dark:text-gray-400'
          )}>
            {error || helperText}
          </div>
        )}
      </div>
    );
  }
);

Input.displayName = 'Input';

// 密码输入框
Input.Password = forwardRef<HTMLInputElement, InputProps>(
  (props, ref) => {
    return (
      <Input
        {...props}
        ref={ref}
        type="password"
        iconRender={(visible) => 
          visible ? <EyeTwoTone /> : <EyeInvisibleOutlined />
        }
      />
    );
  }
);

// 文本域
Input.TextArea = forwardRef<HTMLTextAreaElement, InputProps>(
  ({ autoSize = { minRows: 3, maxRows: 6 }, ...props }, ref) => {
    return (
      <Input
        {...props}
        ref={ref as any}
        as={AntInput.TextArea}
        autoSize={autoSize}
      />
    );
  }
);

export default Input;
```

### 用户头像组件
```typescript
// src/components/composite/UserAvatar/index.tsx
import React from 'react';
import { Avatar, Badge, Tooltip } from 'antd';
import { UserOutlined } from '@ant-design/icons';
import { cn } from '@/utils/styles/classNames';

export interface UserAvatarProps {
  src?: string;
  name?: string;
  size?: 'small' | 'default' | 'large' | number;
  shape?: 'circle' | 'square';
  status?: 'online' | 'offline' | 'busy' | 'away';
  showStatus?: boolean;
  showTooltip?: boolean;
  className?: string;
  onClick?: () => void;
}

const UserAvatar: React.FC<UserAvatarProps> = ({
  src,
  name,
  size = 'default',
  shape = 'circle',
  status = 'offline',
  showStatus = false,
  showTooltip = true,
  className,
  onClick,
}) => {
  // 状态颜色映射
  const statusColors = {
    online: '#52c41a',
    offline: '#d9d9d9',
    busy: '#ff4d4f',
    away: '#faad14',
  };

  // 生成用户名首字母
  const getInitials = (name: string) => {
    return name
      .split(' ')
      .map(word => word[0])
      .join('')
      .toUpperCase()
      .slice(0, 2);
  };

  // 生成背景色
  const getBackgroundColor = (name: string) => {
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
      hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    
    const colors = [
      '#f56a00', '#7265e6', '#ffbf00', '#00a2ae',
      '#ff4d4f', '#722ed1', '#52c41a', '#fa541c',
      '#fadb14', '#13c2c2', '#eb2f96', '#1890ff'
    ];
    
    return colors[Math.abs(hash) % colors.length];
  };

  const avatarElement = (
    <Avatar
      src={src}
      size={size}
      shape={shape}
      style={
        !src && name
          ? { backgroundColor: getBackgroundColor(name), color: '#fff' }
          : undefined
      }
      icon={!src && !name ? <UserOutlined /> : undefined}
      className={cn(
        'cursor-pointer transition-all duration-200 hover:shadow-md',
        className
      )}
      onClick={onClick}
    >
      {!src && name ? getInitials(name) : null}
    </Avatar>
  );

  const avatarWithStatus = showStatus ? (
    <Badge
      dot
      color={statusColors[status]}
      offset={[-8, 8]}
      className="flex items-center"
    >
      {avatarElement}
    </Badge>
  ) : (
    avatarElement
  );

  return showTooltip ? (
    <Tooltip title={name || '用户'}>
      {avatarWithStatus}
    </Tooltip>
  ) : (
    avatarWithStatus
  );
};

export default UserAvatar;
```

### 状态徽章组件
```typescript
// src/components/composite/StatusBadge/index.tsx
import React from 'react';
import { Badge, Tag } from 'antd';
import { 
  CheckCircleOutlined, 
  ClockCircleOutlined, 
  ExclamationCircleOutlined,
  StopOutlined 
} from '@ant-design/icons';
import { cn } from '@/utils/styles/classNames';

export type StatusType = 'success' | 'processing' | 'error' | 'warning' | 'default';

export interface StatusBadgeProps {
  status: StatusType;
  text?: string;
  showIcon?: boolean;
  variant?: 'badge' | 'tag' | 'dot';
  size?: 'small' | 'default';
  className?: string;
}

const StatusBadge: React.FC<StatusBadgeProps> = ({
  status,
  text,
  showIcon = true,
  variant = 'tag',
  size = 'default',
  className,
}) => {
  // 状态配置
  const statusConfig = {
    success: {
      color: 'success',
      icon: <CheckCircleOutlined />,
      text: text || '成功',
    },
    processing: {
      color: 'processing',
      icon: <ClockCircleOutlined />,
      text: text || '处理中',
    },
    error: {
      color: 'error',
      icon: <ExclamationCircleOutlined />,
      text: text || '失败',
    },
    warning: {
      color: 'warning',
      icon: <ExclamationCircleOutlined />,
      text: text || '警告',
    },
    default: {
      color: 'default',
      icon: <StopOutlined />,
      text: text || '默认',
    },
  };

  const config = statusConfig[status];

  if (variant === 'dot') {
    return (
      <span className={cn('inline-flex items-center gap-2', className)}>
        <Badge status={status} />
        <span className="text-sm text-gray-600 dark:text-gray-300">
          {config.text}
        </span>
      </span>
    );
  }

  if (variant === 'badge') {
    return (
      <Badge
        status={status}
        text={config.text}
        className={className}
      />
    );
  }

  // Tag variant
  return (
    <Tag
      color={config.color}
      icon={showIcon ? config.icon : undefined}
      className={cn(
        'flex items-center gap-1',
        {
          'text-xs px-2 py-1': size === 'small',
        },
        className
      )}
    >
      {config.text}
    </Tag>
  );
};

export default StatusBadge;
```

### 搜索框组件
```typescript
// src/components/composite/SearchBox/index.tsx
import React, { useState, useCallback } from 'react';
import { Input, Button, Dropdown, Space } from 'antd';
import { SearchOutlined, FilterOutlined, DownOutlined } from '@ant-design/icons';
import { useDebouncedCallback } from '@/hooks/useDebounce';
import { cn } from '@/utils/styles/classNames';

const { Search } = Input;

export interface FilterOption {
  key: string;
  label: string;
  value: any;
}

export interface SearchBoxProps {
  placeholder?: string;
  value?: string;
  onSearch?: (value: string, filters?: Record<string, any>) => void;
  onChange?: (value: string) => void;
  filters?: FilterOption[];
  selectedFilters?: Record<string, any>;
  onFilterChange?: (filters: Record<string, any>) => void;
  loading?: boolean;
  debounceMs?: number;
  showFilterButton?: boolean;
  allowClear?: boolean;
  className?: string;
}

const SearchBox: React.FC<SearchBoxProps> = ({
  placeholder = '请输入搜索关键词',
  value,
  onSearch,
  onChange,
  filters = [],
  selectedFilters = {},
  onFilterChange,
  loading = false,
  debounceMs = 300,
  showFilterButton = true,
  allowClear = true,
  className,
}) => {
  const [searchValue, setSearchValue] = useState(value || '');
  const [filterVisible, setFilterVisible] = useState(false);

  // 防抖搜索
  const debouncedSearch = useDebouncedCallback((searchText: string) => {
    onSearch?.(searchText, selectedFilters);
  }, debounceMs);

  const handleChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const newValue = e.target.value;
    setSearchValue(newValue);
    onChange?.(newValue);
    
    if (newValue.trim()) {
      debouncedSearch(newValue);
    }
  }, [onChange, debouncedSearch]);

  const handleSearch = useCallback((searchText: string) => {
    onSearch?.(searchText, selectedFilters);
  }, [onSearch, selectedFilters]);

  const handleFilterChange = useCallback((filterKey: string, filterValue: any) => {
    const newFilters = { ...selectedFilters, [filterKey]: filterValue };
    onFilterChange?.(newFilters);
    
    // 重新搜索
    if (searchValue.trim()) {
      onSearch?.(searchValue, newFilters);
    }
  }, [selectedFilters, onFilterChange, searchValue, onSearch]);

  // 过滤器菜单项
  const filterMenuItems = filters.map(filter => ({
    key: filter.key,
    label: (
      <div className="flex items-center justify-between min-w-32">
        <span>{filter.label}</span>
        <span className={cn(
          'text-xs px-2 py-1 rounded',
          selectedFilters[filter.key] === filter.value
            ? 'bg-primary-100 text-primary-600'
            : 'bg-gray-100 text-gray-500'
        )}>
          {selectedFilters[filter.key] === filter.value ? '已选择' : '未选择'}
        </span>
      </div>
    ),
    onClick: () => handleFilterChange(filter.key, filter.value),
  }));

  const hasActiveFilters = Object.keys(selectedFilters).length > 0;

  return (
    <div className={cn('flex items-center gap-2', className)}>
      <Search
        placeholder={placeholder}
        value={searchValue}
        onChange={handleChange}
        onSearch={handleSearch}
        loading={loading}
        allowClear={allowClear}
        enterButton={<SearchOutlined />}
        className="flex-1"
      />
      
      {showFilterButton && filters.length > 0 && (
        <Dropdown
          menu={{ items: filterMenuItems }}
          trigger={['click']}
          open={filterVisible}
          onOpenChange={setFilterVisible}
        >
          <Button
            icon={<FilterOutlined />}
            className={cn(
              'flex items-center',
              hasActiveFilters && 'border-primary-500 text-primary-600'
            )}
          >
            筛选
            <DownOutlined className="ml-1" />
            {hasActiveFilters && (
              <span className="ml-1 px-1 bg-primary-500 text-white text-xs rounded-full min-w-4 h-4 flex items-center justify-center">
                {Object.keys(selectedFilters).length}
              </span>
            )}
          </Button>
        </Dropdown>
      )}
    </div>
  );
};

export default SearchBox;
```

### 确认对话框组件
```typescript
// src/components/composite/ConfirmDialog/index.tsx
import React from 'react';
import { Modal, Button, Space } from 'antd';
import { ExclamationCircleOutlined, InfoCircleOutlined, CheckCircleOutlined } from '@ant-design/icons';
import { cn } from '@/utils/styles/classNames';

export type ConfirmType = 'warning' | 'error' | 'success' | 'info';

export interface ConfirmDialogProps {
  open: boolean;
  title?: string;
  content?: React.ReactNode;
  type?: ConfirmType;
  confirmText?: string;
  cancelText?: string;
  confirmLoading?: boolean;
  onConfirm?: () => void | Promise<void>;
  onCancel?: () => void;
  className?: string;
}

const ConfirmDialog: React.FC<ConfirmDialogProps> = ({
  open,
  title = '确认操作',
  content,
  type = 'warning',
  confirmText = '确认',
  cancelText = '取消',
  confirmLoading = false,
  onConfirm,
  onCancel,
  className,
}) => {
  // 类型配置
  const typeConfig = {
    warning: {
      icon: <ExclamationCircleOutlined className="text-yellow-500" />,
      confirmButtonType: 'primary' as const,
      confirmButtonClass: 'bg-yellow-500 border-yellow-500 hover:bg-yellow-600',
    },
    error: {
      icon: <ExclamationCircleOutlined className="text-red-500" />,
      confirmButtonType: 'primary' as const,
      confirmButtonClass: 'bg-red-500 border-red-500 hover:bg-red-600',
    },
    success: {
      icon: <CheckCircleOutlined className="text-green-500" />,
      confirmButtonType: 'primary' as const,
      confirmButtonClass: 'bg-green-500 border-green-500 hover:bg-green-600',
    },
    info: {
      icon: <InfoCircleOutlined className="text-blue-500" />,
      confirmButtonType: 'primary' as const,
      confirmButtonClass: 'bg-blue-500 border-blue-500 hover:bg-blue-600',
    },
  };

  const config = typeConfig[type];

  const handleConfirm = async () => {
    try {
      await onConfirm?.();
    } catch (error) {
      console.error('Confirm action failed:', error);
    }
  };

  return (
    <Modal
      open={open}
      title={null}
      footer={null}
      onCancel={onCancel}
      className={cn('confirm-dialog', className)}
      centered
      width={400}
    >
      <div className="flex items-start gap-3 p-4">
        <div className="text-2xl mt-1">
          {config.icon}
        </div>
        
        <div className="flex-1">
          <h3 className="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">
            {title}
          </h3>
          
          {content && (
            <div className="text-gray-600 dark:text-gray-300 mb-6">
              {content}
            </div>
          )}
          
          <Space className="w-full justify-end">
            <Button onClick={onCancel}>
              {cancelText}
            </Button>
            <Button
              type={config.confirmButtonType}
              loading={confirmLoading}
              onClick={handleConfirm}
              className={config.confirmButtonClass}
            >
              {confirmText}
            </Button>
          </Space>
        </div>
      </div>
    </Modal>
  );
};

// Hook版本的确认对话框
export const useConfirmDialog = () => {
  const [dialogState, setDialogState] = React.useState<{
    open: boolean;
    props?: Omit<ConfirmDialogProps, 'open' | 'onConfirm' | 'onCancel'>;
    onConfirm?: () => void | Promise<void>;
  }>({
    open: false,
  });

  const confirm = React.useCallback((
    props: Omit<ConfirmDialogProps, 'open' | 'onConfirm' | 'onCancel'>,
    onConfirm?: () => void | Promise<void>
  ) => {
    return new Promise<boolean>((resolve) => {
      setDialogState({
        open: true,
        props,
        onConfirm: async () => {
          try {
            await onConfirm?.();
            resolve(true);
          } catch (error) {
            resolve(false);
          } finally {
            setDialogState(prev => ({ ...prev, open: false }));
          }
        },
      });
    });
  }, []);

  const handleCancel = React.useCallback(() => {
    setDialogState(prev => ({ ...prev, open: false }));
  }, []);

  const ConfirmDialogComponent = React.useMemo(() => (
    <ConfirmDialog
      {...dialogState.props}
      open={dialogState.open}
      onConfirm={dialogState.onConfirm}
      onCancel={handleCancel}
    />
  ), [dialogState, handleCancel]);

  return {
    confirm,
    ConfirmDialog: ConfirmDialogComponent,
  };
};

export default ConfirmDialog;
```

### 组件统一导出
```typescript
// src/components/ui/index.ts
export { default as Input } from './Input';
export { default as Button } from './Button';
export { default as Select } from './Select';
export { default as DatePicker } from './DatePicker';
export { default as Upload } from './Upload';

// 复合组件导出
export { default as SearchBox } from '../composite/SearchBox';
export { default as UserAvatar } from '../composite/UserAvatar';
export { default as StatusBadge } from '../composite/StatusBadge';
export { default as ConfirmDialog, useConfirmDialog } from '../composite/ConfirmDialog';

// 类型导出
export type { InputProps } from './Input/types';
export type { UserAvatarProps } from '../composite/UserAvatar';
export type { StatusBadgeProps } from '../composite/StatusBadge';
export type { ConfirmDialogProps } from '../composite/ConfirmDialog';
```

## 下一步
- **后续任务**: 01-6-4-图标系统
- **关联任务**: 建立统一的图标管理和使用系统
- **注意事项**: 
  - 组件设计要考虑可复用性和扩展性
  - 保持与Ant Design的设计语言一致性
  - 确保组件的无障碍性支持

## 常见问题解决

### Q1: 组件样式不统一
- 建立统一的设计规范
- 使用统一的样式变量和工具函数
- 定期Review组件样式一致性

### Q2: 组件TypeScript类型错误
- 确保类型定义完整准确
- 使用泛型提高类型复用性
- 继承Ant Design的原生类型

### Q3: 组件性能问题
- 使用React.memo优化不必要渲染
- 合理使用useCallback和useMemo
- 避免在render中创建对象和函数

### Q4: 组件测试覆盖不足
- 为每个组件编写单元测试
- 测试组件的各种状态和交互
- 使用Storybook进行可视化测试