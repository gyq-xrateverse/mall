# 01-4-4-UI状态管理

## 任务概述
- **时间估算**: 45分钟
- **优先级**: 中
- **依赖关系**: 
  - 依赖：01-4-3-Auth状态管理（状态管理基础）
  - 依赖：01-3-3-Layout布局组件（UI组件基础）
  - 前置：Redux Store配置完成
- **执行阶段**: 第一阶段-前端基础架构

## 详细任务清单

### 4.4.1 设计UI状态结构
- [ ] 定义主题配置状态
- [ ] 设计布局控制状态
- [ ] 创建通知消息状态
- [ ] 定义加载状态管理

### 4.4.2 实现UI Slice
- [ ] 创建uiSlice基础结构
- [ ] 实现主题切换逻辑
- [ ] 添加布局控制功能
- [ ] 集成响应式断点管理

### 4.4.3 实现全局UI状态
- [ ] 创建Loading状态管理
- [ ] 实现Modal状态控制
- [ ] 添加Toast通知管理
- [ ] 实现全局错误状态

### 4.4.4 集成用户偏好设置
- [ ] 实现设置持久化
- [ ] 添加多语言状态管理
- [ ] 创建用户界面偏好
- [ ] 集成无障碍设置

## 验收标准

### 功能验收
- [ ] 主题切换功能正常工作
- [ ] 布局状态正确管理
- [ ] 通知系统功能完整
- [ ] 用户偏好正确持久化

### 代码质量验收
- [ ] UI状态管理代码清晰
- [ ] TypeScript类型定义完整
- [ ] 状态更新逻辑合理
- [ ] 组件解耦良好

### 用户体验验收
- [ ] 主题切换过渡流畅
- [ ] 响应式状态准确
- [ ] 加载状态反馈及时
- [ ] 错误提示友好

## 交付物

### 1. UI状态管理文件
```
src/store/slices/
├── uiSlice.ts             # UI主slice
├── uiTypes.ts             # UI相关类型定义
└── uiSelectors.ts         # UI状态选择器
```

### 2. UI Hook文件
```
src/hooks/ui/
├── useTheme.ts            # 主题管理Hook
├── useBreakpoint.ts       # 响应式断点Hook
├── useLoading.ts          # 加载状态Hook
└── useNotification.ts     # 通知管理Hook
```

### 3. UI工具函数
```
src/utils/ui/
├── theme.ts               # 主题工具函数
├── responsive.ts          # 响应式工具
└── storage.ts             # UI设置存储工具
```

## 技术要点

### UI类型定义
```typescript
// src/store/slices/uiTypes.ts
export type ThemeMode = 'light' | 'dark' | 'auto';

export type ColorScheme = {
  primary: string;
  secondary: string;
  success: string;
  warning: string;
  error: string;
  info: string;
};

export type BreakpointKey = 'xs' | 'sm' | 'md' | 'lg' | 'xl' | '2xl';

export interface BreakpointState {
  current: BreakpointKey;
  isXs: boolean;
  isSm: boolean;
  isMd: boolean;
  isLg: boolean;
  isXl: boolean;
  is2Xl: boolean;
  isMobile: boolean;
  isTablet: boolean;
  isDesktop: boolean;
}

export interface LoadingState {
  global: boolean;
  [key: string]: boolean;
}

export interface NotificationItem {
  id: string;
  type: 'success' | 'info' | 'warning' | 'error';
  title: string;
  message?: string;
  duration?: number;
  closable?: boolean;
  actions?: NotificationAction[];
  createdAt: number;
}

export interface NotificationAction {
  label: string;
  onClick: () => void;
  type?: 'primary' | 'default';
}

export interface ModalState {
  [key: string]: {
    visible: boolean;
    props?: any;
    component?: string;
  };
}

export interface UISettings {
  // 主题设置
  theme: ThemeMode;
  colorScheme: 'default' | 'custom';
  customColors?: Partial<ColorScheme>;
  
  // 布局设置
  sidebarCollapsed: boolean;
  sidebarWidth: number;
  headerFixed: boolean;
  footerFixed: boolean;
  
  // 语言设置
  language: string;
  
  // 显示设置
  showBreadcrumb: boolean;
  showTabBar: boolean;
  showFooter: boolean;
  
  // 动画设置
  enableAnimations: boolean;
  reducedMotion: boolean;
  
  // 无障碍设置
  highContrast: boolean;
  fontSize: 'small' | 'medium' | 'large';
  
  // 其他设置
  autoSave: boolean;
  compactMode: boolean;
}

export interface UIState {
  // 基础状态
  initialized: boolean;
  
  // 主题相关
  theme: ThemeMode;
  actualTheme: 'light' | 'dark'; // 实际应用的主题（处理auto模式）
  
  // 响应式状态
  breakpoint: BreakpointState;
  
  // 加载状态
  loading: LoadingState;
  
  // 通知状态
  notifications: NotificationItem[];
  
  // 模态框状态
  modals: ModalState;
  
  // 用户设置
  settings: UISettings;
  
  // 临时状态
  sidebarCollapsed: boolean;
  fullscreenMode: boolean;
  
  // 错误状态
  error: string | null;
}
```

### UI Slice实现
```typescript
// src/store/slices/uiSlice.ts
import { createSlice, PayloadAction, createAsyncThunk } from '@reduxjs/toolkit';
import { UIState, ThemeMode, NotificationItem, UISettings, BreakpointState } from './uiTypes';
import { saveUISettings, loadUISettings } from '@/utils/ui/storage';
import { detectSystemTheme, getBreakpointFromWidth } from '@/utils/ui/theme';

// 初始状态
const defaultSettings: UISettings = {
  theme: 'auto',
  colorScheme: 'default',
  sidebarCollapsed: false,
  sidebarWidth: 240,
  headerFixed: true,
  footerFixed: false,
  language: 'zh-CN',
  showBreadcrumb: true,
  showTabBar: true,
  showFooter: true,
  enableAnimations: true,
  reducedMotion: false,
  highContrast: false,
  fontSize: 'medium',
  autoSave: true,
  compactMode: false,
};

const initialState: UIState = {
  initialized: false,
  theme: 'auto',
  actualTheme: 'light',
  breakpoint: {
    current: 'lg',
    isXs: false,
    isSm: false,
    isMd: false,
    isLg: true,
    isXl: false,
    is2Xl: false,
    isMobile: false,
    isTablet: false,
    isDesktop: true,
  },
  loading: {
    global: false,
  },
  notifications: [],
  modals: {},
  settings: defaultSettings,
  sidebarCollapsed: false,
  fullscreenMode: false,
  error: null,
};

// 异步Actions
export const loadUserPreferencesAsync = createAsyncThunk<
  UISettings,
  void,
  { rejectValue: string }
>('ui/loadPreferences', async (_, { rejectWithValue }) => {
  try {
    const settings = await loadUISettings();
    return settings || defaultSettings;
  } catch (error: any) {
    return rejectWithValue(error.message || '加载用户偏好失败');
  }
});

export const saveUserPreferencesAsync = createAsyncThunk<
  void,
  Partial<UISettings>,
  { state: { ui: UIState } }
>('ui/savePreferences', async (updates, { getState }) => {
  const { ui } = getState();
  const newSettings = { ...ui.settings, ...updates };
  await saveUISettings(newSettings);
});

// UI Slice
const uiSlice = createSlice({
  name: 'ui',
  initialState,
  reducers: {
    // 主题控制
    setTheme: (state, action: PayloadAction<ThemeMode>) => {
      state.theme = action.payload;
      state.settings.theme = action.payload;
      state.actualTheme = action.payload === 'auto' 
        ? detectSystemTheme() 
        : action.payload as 'light' | 'dark';
    },
    
    updateActualTheme: (state, action: PayloadAction<'light' | 'dark'>) => {
      state.actualTheme = action.payload;
    },
    
    // 布局控制
    toggleSidebar: (state) => {
      state.sidebarCollapsed = !state.sidebarCollapsed;
      state.settings.sidebarCollapsed = state.sidebarCollapsed;
    },
    
    setSidebarCollapsed: (state, action: PayloadAction<boolean>) => {
      state.sidebarCollapsed = action.payload;
      state.settings.sidebarCollapsed = action.payload;
    },
    
    setSidebarWidth: (state, action: PayloadAction<number>) => {
      state.settings.sidebarWidth = action.payload;
    },
    
    setFullscreenMode: (state, action: PayloadAction<boolean>) => {
      state.fullscreenMode = action.payload;
    },
    
    // 响应式状态
    updateBreakpoint: (state, action: PayloadAction<number>) => {
      const width = action.payload;
      state.breakpoint = getBreakpointFromWidth(width);
    },
    
    // 加载状态
    setGlobalLoading: (state, action: PayloadAction<boolean>) => {
      state.loading.global = action.payload;
    },
    
    setLoading: (state, action: PayloadAction<{ key: string; loading: boolean }>) => {
      const { key, loading } = action.payload;
      state.loading[key] = loading;
    },
    
    clearAllLoading: (state) => {
      state.loading = { global: false };
    },
    
    // 通知管理
    addNotification: (state, action: PayloadAction<Omit<NotificationItem, 'id' | 'createdAt'>>) => {
      const notification: NotificationItem = {
        ...action.payload,
        id: Date.now().toString(),
        createdAt: Date.now(),
      };
      state.notifications.push(notification);
    },
    
    removeNotification: (state, action: PayloadAction<string>) => {
      state.notifications = state.notifications.filter(
        notification => notification.id !== action.payload
      );
    },
    
    clearAllNotifications: (state) => {
      state.notifications = [];
    },
    
    // 模态框管理
    showModal: (state, action: PayloadAction<{ key: string; props?: any; component?: string }>) => {
      const { key, props, component } = action.payload;
      state.modals[key] = {
        visible: true,
        props,
        component,
      };
    },
    
    hideModal: (state, action: PayloadAction<string>) => {
      const key = action.payload;
      if (state.modals[key]) {
        state.modals[key].visible = false;
      }
    },
    
    clearModal: (state, action: PayloadAction<string>) => {
      const key = action.payload;
      delete state.modals[key];
    },
    
    clearAllModals: (state) => {
      state.modals = {};
    },
    
    // 设置管理
    updateSettings: (state, action: PayloadAction<Partial<UISettings>>) => {
      state.settings = { ...state.settings, ...action.payload };
    },
    
    resetSettings: (state) => {
      state.settings = defaultSettings;
    },
    
    // 语言设置
    setLanguage: (state, action: PayloadAction<string>) => {
      state.settings.language = action.payload;
    },
    
    // 错误处理
    setError: (state, action: PayloadAction<string | null>) => {
      state.error = action.payload;
    },
    
    clearError: (state) => {
      state.error = null;
    },
    
    // 初始化
    setInitialized: (state, action: PayloadAction<boolean>) => {
      state.initialized = action.payload;
    },
    
    // 重置
    resetUI: (state) => {
      return { ...initialState, initialized: state.initialized };
    },
  },
  
  extraReducers: (builder) => {
    builder
      .addCase(loadUserPreferencesAsync.fulfilled, (state, action) => {
        state.settings = action.payload;
        state.theme = action.payload.theme;
        state.sidebarCollapsed = action.payload.sidebarCollapsed;
        state.actualTheme = action.payload.theme === 'auto' 
          ? detectSystemTheme() 
          : action.payload.theme as 'light' | 'dark';
        state.initialized = true;
      })
      .addCase(loadUserPreferencesAsync.rejected, (state, action) => {
        state.error = action.payload || '加载偏好设置失败';
        state.initialized = true;
      })
      .addCase(saveUserPreferencesAsync.rejected, (state, action) => {
        state.error = action.error.message || '保存偏好设置失败';
      });
  },
});

export const {
  setTheme,
  updateActualTheme,
  toggleSidebar,
  setSidebarCollapsed,
  setSidebarWidth,
  setFullscreenMode,
  updateBreakpoint,
  setGlobalLoading,
  setLoading,
  clearAllLoading,
  addNotification,
  removeNotification,
  clearAllNotifications,
  showModal,
  hideModal,
  clearModal,
  clearAllModals,
  updateSettings,
  resetSettings,
  setLanguage,
  setError,
  clearError,
  setInitialized,
  resetUI,
} = uiSlice.actions;

export default uiSlice.reducer;
```

### UI状态选择器
```typescript
// src/store/slices/uiSelectors.ts
import { createSelector } from '@reduxjs/toolkit';
import { RootState } from '../index';

// 基础选择器
export const selectUI = (state: RootState) => state.ui;

// 主题相关
export const selectTheme = createSelector(
  selectUI,
  (ui) => ui.theme
);

export const selectActualTheme = createSelector(
  selectUI,
  (ui) => ui.actualTheme
);

export const selectIsDarkMode = createSelector(
  selectActualTheme,
  (theme) => theme === 'dark'
);

// 布局相关
export const selectSidebarCollapsed = createSelector(
  selectUI,
  (ui) => ui.sidebarCollapsed
);

export const selectSidebarWidth = createSelector(
  selectUI,
  (ui) => ui.settings.sidebarWidth
);

export const selectFullscreenMode = createSelector(
  selectUI,
  (ui) => ui.fullscreenMode
);

// 响应式状态
export const selectBreakpoint = createSelector(
  selectUI,
  (ui) => ui.breakpoint
);

export const selectIsMobile = createSelector(
  selectBreakpoint,
  (breakpoint) => breakpoint.isMobile
);

export const selectIsDesktop = createSelector(
  selectBreakpoint,
  (breakpoint) => breakpoint.isDesktop
);

// 加载状态
export const selectGlobalLoading = createSelector(
  selectUI,
  (ui) => ui.loading.global
);

export const selectLoadingByKey = createSelector(
  selectUI,
  (ui) => (key: string) => ui.loading[key] || false
);

export const selectAnyLoading = createSelector(
  selectUI,
  (ui) => Object.values(ui.loading).some(Boolean)
);

// 通知相关
export const selectNotifications = createSelector(
  selectUI,
  (ui) => ui.notifications
);

export const selectNotificationCount = createSelector(
  selectNotifications,
  (notifications) => notifications.length
);

// 模态框相关
export const selectModals = createSelector(
  selectUI,
  (ui) => ui.modals
);

export const selectModalByKey = createSelector(
  selectModals,
  (modals) => (key: string) => modals[key]
);

export const selectIsModalVisible = createSelector(
  selectModals,
  (modals) => (key: string) => modals[key]?.visible || false
);

// 设置相关
export const selectSettings = createSelector(
  selectUI,
  (ui) => ui.settings
);

export const selectLanguage = createSelector(
  selectSettings,
  (settings) => settings.language
);

// 错误状态
export const selectUIError = createSelector(
  selectUI,
  (ui) => ui.error
);

// 初始化状态
export const selectUIInitialized = createSelector(
  selectUI,
  (ui) => ui.initialized
);
```

### 主题管理Hook
```typescript
// src/hooks/ui/useTheme.ts
import { useCallback } from 'react';
import { useAppSelector, useAppDispatch } from '@/store/hooks';
import { setTheme, updateActualTheme } from '@/store/slices/uiSlice';
import { selectTheme, selectActualTheme, selectIsDarkMode } from '@/store/slices/uiSelectors';
import { ThemeMode } from '@/store/slices/uiTypes';

export const useTheme = () => {
  const dispatch = useAppDispatch();
  const theme = useAppSelector(selectTheme);
  const actualTheme = useAppSelector(selectActualTheme);
  const isDarkMode = useAppSelector(selectIsDarkMode);

  const changeTheme = useCallback((newTheme: ThemeMode) => {
    dispatch(setTheme(newTheme));
  }, [dispatch]);

  const toggleTheme = useCallback(() => {
    const newTheme = actualTheme === 'light' ? 'dark' : 'light';
    dispatch(setTheme(newTheme));
  }, [dispatch, actualTheme]);

  const updateSystemTheme = useCallback((systemTheme: 'light' | 'dark') => {
    dispatch(updateActualTheme(systemTheme));
  }, [dispatch]);

  return {
    theme,
    actualTheme,
    isDarkMode,
    changeTheme,
    toggleTheme,
    updateSystemTheme,
  };
};
```

### 响应式断点Hook
```typescript
// src/hooks/ui/useBreakpoint.ts
import { useCallback, useEffect } from 'react';
import { useAppSelector, useAppDispatch } from '@/store/hooks';
import { updateBreakpoint } from '@/store/slices/uiSlice';
import { selectBreakpoint } from '@/store/slices/uiSelectors';

export const useBreakpoint = () => {
  const dispatch = useAppDispatch();
  const breakpoint = useAppSelector(selectBreakpoint);

  const handleResize = useCallback(() => {
    dispatch(updateBreakpoint(window.innerWidth));
  }, [dispatch]);

  useEffect(() => {
    // 初始化断点
    handleResize();

    // 监听窗口大小变化
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, [handleResize]);

  return breakpoint;
};
```

### 通知管理Hook
```typescript
// src/hooks/ui/useNotification.ts
import { useCallback } from 'react';
import { useAppSelector, useAppDispatch } from '@/store/hooks';
import {
  addNotification,
  removeNotification,
  clearAllNotifications,
} from '@/store/slices/uiSlice';
import {
  selectNotifications,
  selectNotificationCount,
} from '@/store/slices/uiSelectors';
import { NotificationItem } from '@/store/slices/uiTypes';

export const useNotification = () => {
  const dispatch = useAppDispatch();
  const notifications = useAppSelector(selectNotifications);
  const count = useAppSelector(selectNotificationCount);

  const showNotification = useCallback(
    (notification: Omit<NotificationItem, 'id' | 'createdAt'>) => {
      dispatch(addNotification(notification));
    },
    [dispatch]
  );

  const showSuccess = useCallback(
    (title: string, message?: string) => {
      showNotification({ type: 'success', title, message });
    },
    [showNotification]
  );

  const showError = useCallback(
    (title: string, message?: string) => {
      showNotification({ type: 'error', title, message });
    },
    [showNotification]
  );

  const showInfo = useCallback(
    (title: string, message?: string) => {
      showNotification({ type: 'info', title, message });
    },
    [showNotification]
  );

  const showWarning = useCallback(
    (title: string, message?: string) => {
      showNotification({ type: 'warning', title, message });
    },
    [showNotification]
  );

  const hideNotification = useCallback(
    (id: string) => {
      dispatch(removeNotification(id));
    },
    [dispatch]
  );

  const clearAll = useCallback(() => {
    dispatch(clearAllNotifications());
  }, [dispatch]);

  return {
    notifications,
    count,
    showNotification,
    showSuccess,
    showError,
    showInfo,
    showWarning,
    hideNotification,
    clearAll,
  };
};
```

## 下一步
- **后续任务**: 01-4-5-自定义Hooks
- **关联任务**: 基于UI状态管理创建更多实用的Hooks
- **注意事项**: 
  - UI状态要考虑性能优化
  - 主题切换要支持系统偏好
  - 响应式状态要及时更新

## 常见问题解决

### Q1: 主题切换不生效
- 检查CSS变量绑定
- 确认主题状态更新逻辑
- 验证系统主题检测功能

### Q2: 响应式状态不准确
- 确认断点配置正确
- 检查窗口大小监听
- 验证状态更新时机

### Q3: 通知显示异常
- 检查通知组件集成
- 确认状态更新逻辑
- 验证通知自动消失机制

### Q4: 设置持久化失败
- 检查存储权限
- 确认序列化配置
- 验证数据迁移逻辑