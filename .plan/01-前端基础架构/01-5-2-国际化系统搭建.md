# 01-5-2-国际化系统搭建

## 任务概述
- **时间估算**: 45分钟
- **优先级**: 中
- **依赖关系**: 
  - 依赖：01-4-4-UI状态管理（语言切换状态）
  - 依赖：01-5-1-HTTP请求封装（翻译API支持）
  - 前置：React项目基础结构完成
- **执行阶段**: 第一阶段-前端基础架构

## 详细任务清单

### 5.2.1 安装国际化依赖
- [ ] 安装react-i18next核心包
- [ ] 安装i18next相关插件
- [ ] 配置语言检测插件
- [ ] 安装TypeScript类型支持

### 5.2.2 配置国际化系统
- [ ] 创建i18n配置文件
- [ ] 设置语言资源文件
- [ ] 配置语言切换逻辑
- [ ] 集成Redux状态管理

### 5.2.3 创建翻译资源
- [ ] 创建中文翻译文件
- [ ] 创建英文翻译文件
- [ ] 设计翻译文件结构
- [ ] 实现动态加载机制

### 5.2.4 开发国际化工具
- [ ] 创建翻译Hook
- [ ] 实现格式化工具函数
- [ ] 开发语言切换组件
- [ ] 集成日期时间本地化

## 验收标准

### 功能验收
- [ ] 多语言切换功能正常
- [ ] 翻译内容正确显示
- [ ] 语言偏好正确持久化
- [ ] 日期时间本地化正确

### 代码质量验收
- [ ] 国际化代码结构清晰
- [ ] TypeScript类型定义完整
- [ ] 翻译资源组织合理
- [ ] 代码可维护性良好

### 用户体验验收
- [ ] 语言切换响应及时
- [ ] 翻译内容自然流畅
- [ ] 布局适应不同语言
- [ ] 无翻译遗漏或错误

## 交付物

### 1. 国际化配置文件
```
src/i18n/
├── index.ts               # i18n配置入口
├── config.ts              # i18n配置选项
├── detector.ts            # 语言检测配置
└── resources.ts           # 资源加载配置
```

### 2. 翻译资源文件
```
src/locales/
├── zh-CN/
│   ├── common.json        # 通用翻译
│   ├── auth.json          # 认证相关翻译
│   ├── ui.json            # UI界面翻译
│   └── validation.json    # 验证信息翻译
├── en-US/
│   ├── common.json
│   ├── auth.json
│   ├── ui.json
│   └── validation.json
└── index.ts               # 资源导出
```

### 3. 国际化工具函数
```
src/hooks/i18n/
├── useTranslation.ts      # 翻译Hook
├── useLanguage.ts         # 语言管理Hook
└── useLocale.ts           # 本地化Hook
```

### 4. 语言切换组件
```
src/components/LanguageSwitcher/
├── index.tsx              # 语言切换组件
└── styles.module.css      # 样式文件
```

## 技术要点

### 安装国际化依赖
```bash
# 核心依赖
pnpm add react-i18next i18next

# 插件
pnpm add i18next-browser-languagedetector  # 语言检测
pnpm add i18next-http-backend               # HTTP后端加载
pnpm add i18next-resources-to-backend       # 资源转换

# 日期时间本地化
pnpm add dayjs

# TypeScript支持
pnpm add -D @types/i18next
```

### i18n配置文件
```typescript
// src/i18n/index.ts
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import LanguageDetector from 'i18next-browser-languagedetector';
import Backend from 'i18next-http-backend';
import { resources } from './resources';

// 语言检测配置
const detectionOptions = {
  // 检测顺序
  order: [
    'localStorage',
    'sessionStorage',
    'navigator',
    'htmlTag',
    'path',
    'subdomain'
  ],
  
  // 缓存配置
  caches: ['localStorage', 'sessionStorage'],
  
  // 排除的路径
  excludeCacheFor: ['cimode'],
  
  // localStorage键名
  lookupLocalStorage: 'beilv-agent-language',
  lookupSessionStorage: 'beilv-agent-language',
  
  // 检查白名单
  checkWhitelist: true,
};

i18n
  // 语言检测
  .use(LanguageDetector)
  // HTTP后端加载
  .use(Backend)
  // React集成
  .use(initReactI18next)
  // 初始化
  .init({
    // 默认语言
    fallbackLng: 'zh-CN',
    
    // 支持的语言
    supportedLngs: ['zh-CN', 'en-US'],
    
    // 语言白名单
    whitelist: ['zh-CN', 'en-US'],
    
    // 调试模式
    debug: process.env.NODE_ENV === 'development',
    
    // 语言检测配置
    detection: detectionOptions,
    
    // 后端配置
    backend: {
      // 资源加载路径
      loadPath: '/locales/{{lng}}/{{ns}}.json',
      
      // 添加资源路径
      addPath: '/locales/add/{{lng}}/{{ns}}',
      
      // 允许跨域
      crossDomain: true,
    },
    
    // 插值配置
    interpolation: {
      escapeValue: false, // React已经安全处理
      format: (value, format, lng) => {
        if (format === 'number') {
          return new Intl.NumberFormat(lng).format(value);
        }
        if (format === 'currency') {
          return new Intl.NumberFormat(lng, {
            style: 'currency',
            currency: lng?.startsWith('zh') ? 'CNY' : 'USD'
          }).format(value);
        }
        return value;
      },
    },
    
    // 资源配置
    resources,
    
    // 命名空间
    ns: ['common', 'auth', 'ui', 'validation'],
    defaultNS: 'common',
    
    // 缓存配置
    saveMissing: process.env.NODE_ENV === 'development',
    
    // React配置
    react: {
      useSuspense: false,
      bindI18n: 'languageChanged',
      bindI18nStore: '',
      transEmptyNodeValue: '',
      transSupportBasicHtmlNodes: true,
      transKeepBasicHtmlNodesFor: ['br', 'strong', 'i', 'p'],
    },
  });

export default i18n;
```

### 翻译资源文件
```json
// src/locales/zh-CN/common.json
{
  "app": {
    "name": "北旅智能体",
    "description": "智能体管理系统"
  },
  "nav": {
    "dashboard": "控制台",
    "users": "用户管理",
    "settings": "系统设置",
    "profile": "个人中心",
    "logout": "退出登录"
  },
  "actions": {
    "save": "保存",
    "cancel": "取消",
    "delete": "删除",
    "edit": "编辑",
    "create": "创建",
    "update": "更新",
    "search": "搜索",
    "reset": "重置",
    "submit": "提交",
    "confirm": "确认"
  },
  "status": {
    "loading": "加载中...",
    "success": "操作成功",
    "error": "操作失败",
    "pending": "处理中",
    "completed": "已完成"
  },
  "messages": {
    "confirmDelete": "确定要删除这个项目吗？",
    "saveSuccess": "保存成功",
    "deleteSuccess": "删除成功",
    "operationFailed": "操作失败，请重试"
  },
  "time": {
    "now": "刚刚",
    "minutesAgo": "{{count}}分钟前",
    "hoursAgo": "{{count}}小时前",
    "daysAgo": "{{count}}天前",
    "yesterday": "昨天",
    "tomorrow": "明天"
  }
}
```

```json
// src/locales/en-US/common.json
{
  "app": {
    "name": "BeiLv Agent",
    "description": "Agent Management System"
  },
  "nav": {
    "dashboard": "Dashboard",
    "users": "User Management",
    "settings": "Settings",
    "profile": "Profile",
    "logout": "Logout"
  },
  "actions": {
    "save": "Save",
    "cancel": "Cancel",
    "delete": "Delete",
    "edit": "Edit",
    "create": "Create",
    "update": "Update",
    "search": "Search",
    "reset": "Reset",
    "submit": "Submit",
    "confirm": "Confirm"
  },
  "status": {
    "loading": "Loading...",
    "success": "Operation successful",
    "error": "Operation failed",
    "pending": "Processing",
    "completed": "Completed"
  },
  "messages": {
    "confirmDelete": "Are you sure you want to delete this item?",
    "saveSuccess": "Saved successfully",
    "deleteSuccess": "Deleted successfully",
    "operationFailed": "Operation failed, please try again"
  },
  "time": {
    "now": "Now",
    "minutesAgo": "{{count}} minutes ago",
    "hoursAgo": "{{count}} hours ago",
    "daysAgo": "{{count}} days ago",
    "yesterday": "Yesterday",
    "tomorrow": "Tomorrow"
  }
}
```

### 认证相关翻译
```json
// src/locales/zh-CN/auth.json
{
  "login": {
    "title": "用户登录",
    "username": "用户名",
    "password": "密码",
    "rememberMe": "记住我",
    "loginButton": "登录",
    "forgotPassword": "忘记密码？",
    "noAccount": "还没有账户？",
    "register": "立即注册"
  },
  "validation": {
    "usernameRequired": "请输入用户名",
    "passwordRequired": "请输入密码",
    "passwordMinLength": "密码至少需要6个字符",
    "invalidCredentials": "用户名或密码错误"
  },
  "messages": {
    "loginSuccess": "登录成功",
    "loginFailed": "登录失败",
    "logoutSuccess": "已安全退出",
    "sessionExpired": "会话已过期，请重新登录"
  }
}
```

### 翻译Hook实现
```typescript
// src/hooks/i18n/useTranslation.ts
import { useTranslation as useI18nTranslation } from 'react-i18next';
import { useMemo } from 'react';

export const useTranslation = (namespace?: string | string[]) => {
  const { t, i18n, ready } = useI18nTranslation(namespace);

  // 扩展翻译函数，支持更多功能
  const translate = useMemo(() => {
    return {
      // 基础翻译
      t,
      
      // 带默认值的翻译
      td: (key: string, defaultValue: string, options?: any) => {
        const translation = t(key, options);
        return translation === key ? defaultValue : translation;
      },
      
      // 复数形式翻译
      tp: (key: string, count: number, options?: any) => {
        return t(key, { ...options, count });
      },
      
      // 格式化数字
      tn: (value: number, format?: 'number' | 'currency' | 'percent') => {
        const locale = i18n.language;
        const formatOptions: Intl.NumberFormatOptions = {};
        
        switch (format) {
          case 'currency':
            formatOptions.style = 'currency';
            formatOptions.currency = locale.startsWith('zh') ? 'CNY' : 'USD';
            break;
          case 'percent':
            formatOptions.style = 'percent';
            break;
          default:
            formatOptions.style = 'decimal';
        }
        
        return new Intl.NumberFormat(locale, formatOptions).format(value);
      },
      
      // 格式化日期
      tdate: (date: Date | string | number, format?: 'short' | 'medium' | 'long' | 'full') => {
        const dateObj = new Date(date);
        const locale = i18n.language;
        
        const formatOptions: Intl.DateTimeFormatOptions = {};
        switch (format) {
          case 'short':
            formatOptions.dateStyle = 'short';
            break;
          case 'medium':
            formatOptions.dateStyle = 'medium';
            break;
          case 'long':
            formatOptions.dateStyle = 'long';
            break;
          case 'full':
            formatOptions.dateStyle = 'full';
            break;
          default:
            formatOptions.year = 'numeric';
            formatOptions.month = '2-digit';
            formatOptions.day = '2-digit';
        }
        
        return new Intl.DateTimeFormat(locale, formatOptions).format(dateObj);
      },
      
      // 相对时间
      trelative: (date: Date | string | number) => {
        const dateObj = new Date(date);
        const now = new Date();
        const diffMs = now.getTime() - dateObj.getTime();
        const diffSec = Math.floor(diffMs / 1000);
        const diffMin = Math.floor(diffSec / 60);
        const diffHour = Math.floor(diffMin / 60);
        const diffDay = Math.floor(diffHour / 24);
        
        if (diffSec < 60) return t('time.now');
        if (diffMin < 60) return t('time.minutesAgo', { count: diffMin });
        if (diffHour < 24) return t('time.hoursAgo', { count: diffHour });
        if (diffDay < 7) return t('time.daysAgo', { count: diffDay });
        
        return translate.tdate(date, 'short');
      },
    };
  }, [t, i18n.language]);

  return {
    ...translate,
    i18n,
    ready,
    language: i18n.language,
    changeLanguage: i18n.changeLanguage,
  };
};
```

### 语言管理Hook
```typescript
// src/hooks/i18n/useLanguage.ts
import { useCallback } from 'react';
import { useTranslation } from 'react-i18next';
import { useAppSelector, useAppDispatch } from '@/store/hooks';
import { setLanguage } from '@/store/slices/uiSlice';
import { selectLanguage } from '@/store/slices/uiSelectors';

export const useLanguage = () => {
  const dispatch = useAppDispatch();
  const { i18n } = useTranslation();
  const currentLanguage = useAppSelector(selectLanguage);

  // 获取支持的语言列表
  const supportedLanguages = [
    { code: 'zh-CN', name: '中文', flag: '🇨🇳' },
    { code: 'en-US', name: 'English', flag: '🇺🇸' },
  ];

  // 获取当前语言信息
  const currentLanguageInfo = supportedLanguages.find(
    lang => lang.code === currentLanguage
  ) || supportedLanguages[0];

  // 切换语言
  const changeLanguage = useCallback(async (languageCode: string) => {
    try {
      await i18n.changeLanguage(languageCode);
      dispatch(setLanguage(languageCode));
      
      // 更新HTML lang属性
      document.documentElement.lang = languageCode;
      
      // 可以在这里添加其他语言切换后的操作
      // 比如更新页面标题、重新加载某些组件等
      
    } catch (error) {
      console.error('Language change failed:', error);
    }
  }, [i18n, dispatch]);

  // 检测浏览器语言
  const detectBrowserLanguage = useCallback(() => {
    const browserLang = navigator.language || navigator.languages[0];
    const supported = supportedLanguages.find(lang => 
      browserLang.startsWith(lang.code.split('-')[0])
    );
    return supported?.code || 'zh-CN';
  }, []);

  return {
    currentLanguage,
    currentLanguageInfo,
    supportedLanguages,
    changeLanguage,
    detectBrowserLanguage,
    isLoading: !i18n.isInitialized,
  };
};
```

### 语言切换组件
```typescript
// src/components/LanguageSwitcher/index.tsx
import React from 'react';
import { Dropdown, Button } from 'antd';
import { GlobalOutlined } from '@ant-design/icons';
import type { MenuProps } from 'antd';
import { useLanguage } from '@/hooks/i18n/useLanguage';
import styles from './styles.module.css';

const LanguageSwitcher: React.FC = () => {
  const {
    currentLanguageInfo,
    supportedLanguages,
    changeLanguage,
    isLoading,
  } = useLanguage();

  const handleLanguageChange = (languageCode: string) => {
    changeLanguage(languageCode);
  };

  const menuItems: MenuProps['items'] = supportedLanguages.map(language => ({
    key: language.code,
    label: (
      <div className={styles.languageItem}>
        <span className={styles.flag}>{language.flag}</span>
        <span>{language.name}</span>
      </div>
    ),
    onClick: () => handleLanguageChange(language.code),
  }));

  return (
    <Dropdown
      menu={{ items: menuItems }}
      placement="bottomRight"
      trigger={['click']}
      disabled={isLoading}
    >
      <Button
        type="text"
        icon={<GlobalOutlined />}
        className={styles.switcher}
        loading={isLoading}
      >
        <span className={styles.currentFlag}>
          {currentLanguageInfo.flag}
        </span>
        <span className={styles.currentName}>
          {currentLanguageInfo.name}
        </span>
      </Button>
    </Dropdown>
  );
};

export default LanguageSwitcher;
```

### App组件集成
```typescript
// src/App.tsx (更新)
import React, { Suspense, useEffect } from 'react';
import { ConfigProvider } from 'antd';
import { useTranslation } from 'react-i18next';
import zhCN from 'antd/locale/zh_CN';
import enUS from 'antd/locale/en_US';
import dayjs from 'dayjs';
import 'dayjs/locale/zh-cn';
import 'dayjs/locale/en';

const AppContent: React.FC = () => {
  const { i18n } = useTranslation();

  // 根据当前语言设置Ant Design和dayjs的本地化
  useEffect(() => {
    const currentLang = i18n.language;
    
    if (currentLang.startsWith('zh')) {
      dayjs.locale('zh-cn');
    } else {
      dayjs.locale('en');
    }
  }, [i18n.language]);

  // 获取Ant Design本地化配置
  const getAntdLocale = () => {
    return i18n.language.startsWith('zh') ? zhCN : enUS;
  };

  return (
    <ConfigProvider locale={getAntdLocale()}>
      {/* 其他应用内容 */}
    </ConfigProvider>
  );
};

const App: React.FC = () => {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <AppContent />
    </Suspense>
  );
};
```

## 下一步
- **后续任务**: 01-5-3-环境配置和构建优化
- **关联任务**: 配置不同环境的构建和优化策略
- **注意事项**: 
  - 翻译资源要考虑动态加载以减少包大小
  - 语言切换要考虑组件重新渲染的性能影响
  - 需要建立翻译管理和更新机制

## 常见问题解决

### Q1: 翻译不生效或显示key
- 检查i18n初始化配置
- 确认翻译文件路径正确
- 验证命名空间配置

### Q2: 语言切换后部分内容未更新
- 确认组件使用了useTranslation Hook
- 检查组件是否正确订阅语言变化
- 验证翻译key是否正确

### Q3: 动态翻译内容加载失败
- 检查HTTP backend配置
- 确认翻译文件服务器路径
- 验证网络请求状态

### Q4: 日期时间本地化不正确
- 检查dayjs locale设置
- 确认Intl API浏览器支持
- 验证本地化格式配置