# 01-5-3-环境配置和构建优化

## 任务概述
- **时间估算**: 45分钟
- **优先级**: 中
- **依赖关系**: 
  - 依赖：01-1-3-Vite配置优化（基础Vite配置）
  - 依赖：01-5-2-国际化系统搭建（多语言资源）
  - 前置：项目基础构建配置完成
- **执行阶段**: 第一阶段-前端基础架构

## 详细任务清单

### 5.3.1 完善环境变量配置
- [ ] 创建多环境配置文件
- [ ] 设置API端点配置
- [ ] 配置功能开关变量
- [ ] 添加构建时变量验证

### 5.3.2 优化Vite构建配置
- [ ] 配置代码分割策略
- [ ] 优化chunk分包规则
- [ ] 设置资源压缩配置
- [ ] 添加构建分析工具

### 5.3.3 实现构建优化
- [ ] 配置Tree Shaking
- [ ] 实现资源预加载
- [ ] 优化图片资源处理
- [ ] 添加CDN资源配置

### 5.3.4 设置部署配置
- [ ] 创建部署脚本
- [ ] 配置Docker构建
- [ ] 设置CI/CD配置模板
- [ ] 添加健康检查配置

## 验收标准

### 功能验收
- [ ] 多环境配置正确切换
- [ ] 构建产物大小合理
- [ ] 资源加载性能良好
- [ ] 部署流程顺畅

### 代码质量验收
- [ ] 配置文件结构清晰
- [ ] 构建脚本可维护
- [ ] 环境变量管理安全
- [ ] 文档完整准确

### 性能验收
- [ ] 构建时间优化
- [ ] 包体积控制合理
- [ ] 首屏加载速度快
- [ ] 资源缓存有效

## 交付物

### 1. 环境配置文件
```
├── .env                   # 默认环境变量
├── .env.development       # 开发环境配置
├── .env.staging           # 测试环境配置
├── .env.production        # 生产环境配置
└── env.d.ts               # 环境变量类型定义
```

### 2. 构建配置文件
```
├── vite.config.ts         # Vite主配置
├── vite.config.dev.ts     # 开发环境配置
├── vite.config.prod.ts    # 生产环境配置
└── build/                 # 构建相关配置
    ├── plugins.ts         # Vite插件配置
    ├── optimization.ts    # 优化配置
    └── constants.ts       # 构建常量
```

### 3. 部署配置文件
```
├── Dockerfile             # Docker配置
├── docker-compose.yml     # Docker Compose配置
├── nginx.conf             # Nginx配置
└── scripts/               # 部署脚本
    ├── build.sh          # 构建脚本
    ├── deploy.sh         # 部署脚本
    └── health-check.sh   # 健康检查脚本
```

## 技术要点

### 环境变量配置
```env
# .env (默认配置)
VITE_APP_TITLE=BeiLv Agent
VITE_APP_VERSION=1.0.0
VITE_APP_DESCRIPTION=BeiLv Agent Management System

# API配置
VITE_API_BASE_URL=/api
VITE_API_TIMEOUT=30000
VITE_API_RETRY_COUNT=3

# 功能开关
VITE_ENABLE_MOCK=false
VITE_ENABLE_DEVTOOLS=false
VITE_ENABLE_ANALYTICS=false
VITE_ENABLE_ERROR_REPORTING=false

# 第三方服务
VITE_CDN_BASE_URL=https://cdn.example.com
VITE_UPLOAD_BASE_URL=https://upload.example.com

# 安全配置
VITE_ENCRYPT_STORAGE=false
VITE_SESSION_TIMEOUT=3600000
```

```env
# .env.development (开发环境)
VITE_APP_ENV=development

VITE_API_BASE_URL=http://localhost:8080/api
VITE_ENABLE_MOCK=true
VITE_ENABLE_DEVTOOLS=true

# 开发工具
VITE_ENABLE_VCONSOLE=true
VITE_ENABLE_ERUDA=false
```

```env
# .env.production (生产环境)
VITE_APP_ENV=production

VITE_API_BASE_URL=https://api.beilv.com
VITE_ENABLE_ANALYTICS=true
VITE_ENABLE_ERROR_REPORTING=true

# CDN配置
VITE_CDN_BASE_URL=https://cdn.beilv.com
VITE_UPLOAD_BASE_URL=https://upload.beilv.com

# 安全配置
VITE_ENCRYPT_STORAGE=true
```

### 环境变量类型定义
```typescript
// env.d.ts
/// <reference types="vite/client" />

interface ImportMetaEnv {
  // 应用信息
  readonly VITE_APP_TITLE: string;
  readonly VITE_APP_VERSION: string;
  readonly VITE_APP_DESCRIPTION: string;
  readonly VITE_APP_ENV: 'development' | 'staging' | 'production';
  
  // API配置
  readonly VITE_API_BASE_URL: string;
  readonly VITE_API_TIMEOUT: string;
  readonly VITE_API_RETRY_COUNT: string;
  
  // 功能开关
  readonly VITE_ENABLE_MOCK: string;
  readonly VITE_ENABLE_DEVTOOLS: string;
  readonly VITE_ENABLE_ANALYTICS: string;
  readonly VITE_ENABLE_ERROR_REPORTING: string;
  
  // CDN配置
  readonly VITE_CDN_BASE_URL: string;
  readonly VITE_UPLOAD_BASE_URL: string;
  
  // 安全配置
  readonly VITE_ENCRYPT_STORAGE: string;
  readonly VITE_SESSION_TIMEOUT: string;
}

interface ImportMeta {
  readonly env: ImportMetaEnv;
}
```

### 优化的Vite配置
```typescript
// vite.config.ts
import { defineConfig, loadEnv } from 'vite';
import type { ConfigEnv, UserConfig } from 'vite';
import { resolve } from 'path';
import { createVitePlugins } from './build/plugins';
import { createOptimizationConfig } from './build/optimization';
import { VITE_PORT } from './build/constants';

export default defineConfig(({ command, mode }: ConfigEnv): UserConfig => {
  const root = process.cwd();
  const env = loadEnv(mode, root);
  const isBuild = command === 'build';

  return {
    root,
    base: '/',
    
    // 路径解析
    resolve: {
      alias: {
        '@': resolve(__dirname, 'src'),
        '@/components': resolve(__dirname, 'src/components'),
        '@/utils': resolve(__dirname, 'src/utils'),
        '@/hooks': resolve(__dirname, 'src/hooks'),
        '@/services': resolve(__dirname, 'src/services'),
        '@/store': resolve(__dirname, 'src/store'),
        '@/types': resolve(__dirname, 'src/types'),
        '@/assets': resolve(__dirname, 'src/assets'),
      },
    },
    
    // CSS配置
    css: {
      modules: {
        localsConvention: 'camelCaseOnly',
        generateScopedName: isBuild 
          ? '[hash:base64:5]' 
          : '[name]_[local]_[hash:base64:5]',
      },
      preprocessorOptions: {
        scss: {
          additionalData: `@import "@/styles/variables.scss";`,
        },
      },
    },
    
    // 插件配置
    plugins: createVitePlugins(env, isBuild),
    
    // 开发服务器配置
    server: {
      host: '0.0.0.0',
      port: VITE_PORT,
      open: true,
      cors: true,
      proxy: {
        '/api': {
          target: env.VITE_API_BASE_URL || 'http://localhost:8080',
          changeOrigin: true,
          rewrite: (path) => path.replace(/^\/api/, '/api'),
        },
      },
    },
    
    // 构建配置
    build: createOptimizationConfig(env, isBuild),
    
    // 预览配置
    preview: {
      port: 4173,
      host: '0.0.0.0',
    },
    
    // 依赖优化
    optimizeDeps: {
      include: [
        'react',
        'react-dom',
        'react-router-dom',
        'antd',
        '@ant-design/icons',
        'axios',
        'dayjs',
      ],
      exclude: ['@vite/client', '@vite/env'],
    },
    
    // 环境变量
    define: {
      __APP_INFO__: JSON.stringify({
        name: env.VITE_APP_TITLE,
        version: env.VITE_APP_VERSION,
        description: env.VITE_APP_DESCRIPTION,
        buildTime: new Date().toISOString(),
      }),
    },
  };
});
```

### 构建优化配置
```typescript
// build/optimization.ts
import type { BuildOptions } from 'vite';
import { resolve } from 'path';

export const createOptimizationConfig = (
  env: Record<string, string>,
  isBuild: boolean
): BuildOptions => {
  return {
    target: 'es2015',
    outDir: 'dist',
    assetsDir: 'assets',
    assetsInlineLimit: 4096,
    
    // 代码分割
    rollupOptions: {
      input: {
        main: resolve(__dirname, '../index.html'),
      },
      output: {
        // 手动分包
        manualChunks: (id) => {
          // 第三方库分包
          if (id.includes('node_modules')) {
            // React相关
            if (id.includes('react') || id.includes('react-dom')) {
              return 'react-vendor';
            }
            // React Router
            if (id.includes('react-router')) {
              return 'router-vendor';
            }
            // Ant Design
            if (id.includes('antd') || id.includes('@ant-design')) {
              return 'antd-vendor';
            }
            // Redux相关
            if (id.includes('redux') || id.includes('@reduxjs')) {
              return 'redux-vendor';
            }
            // 工具类库
            if (id.includes('lodash') || id.includes('dayjs') || id.includes('axios')) {
              return 'utils-vendor';
            }
            // 其他第三方库
            return 'vendor';
          }
          
          // 业务模块分包
          if (id.includes('src/pages')) {
            const pageName = id.split('/pages/')[1]?.split('/')[0];
            return `page-${pageName}`;
          }
          
          if (id.includes('src/components')) {
            return 'components';
          }
        },
        
        // 文件命名
        chunkFileNames: (chunkInfo) => {
          const facadeModuleId = chunkInfo.facadeModuleId 
            ? chunkInfo.facadeModuleId.split('/').pop()?.replace(/\.\w+$/, '') 
            : 'unknown';
          return `js/[name]-[hash].js`;
        },
        entryFileNames: 'js/[name]-[hash].js',
        assetFileNames: (assetInfo) => {
          const extType = assetInfo.name?.split('.').pop() || '';
          if (/\.(mp4|webm|ogg|mp3|wav|flac|aac)(\?.*)?$/i.test(assetInfo.name || '')) {
            return `media/[name]-[hash].${extType}`;
          }
          if (/\.(png|jpe?g|gif|svg)(\?.*)?$/.test(assetInfo.name || '')) {
            return `images/[name]-[hash].${extType}`;
          }
          if (/\.(woff2?|eot|ttf|otf)(\?.*)?$/i.test(assetInfo.name || '')) {
            return `fonts/[name]-[hash].${extType}`;
          }
          return `assets/[name]-[hash].${extType}`;
        },
      },
      
      // 外部依赖
      external: isBuild ? [] : ['react', 'react-dom'],
    },
    
    // 压缩配置
    minify: isBuild ? 'terser' : false,
    terserOptions: isBuild ? {
      compress: {
        drop_console: true,
        drop_debugger: true,
        pure_funcs: ['console.log', 'console.info'],
      },
      format: {
        comments: false,
      },
    } : undefined,
    
    // 源码映射
    sourcemap: env.VITE_APP_ENV !== 'production',
    
    // 构建报告
    reportCompressedSize: false,
    
    // Chunk大小警告限制
    chunkSizeWarningLimit: 500,
  };
};
```

### Vite插件配置
```typescript
// build/plugins.ts
import type { PluginOption } from 'vite';
import react from '@vitejs/plugin-react-swc';
import { visualizer } from 'rollup-plugin-visualizer';
import { createHtmlPlugin } from 'vite-plugin-html';
import legacy from '@vitejs/plugin-legacy';
import { VitePWA } from 'vite-plugin-pwa';

export const createVitePlugins = (
  env: Record<string, string>,
  isBuild: boolean
): PluginOption[] => {
  const plugins: PluginOption[] = [
    // React支持
    react({
      jsxImportSource: '@emotion/react',
      babel: {
        plugins: [
          ['@babel/plugin-proposal-decorators', { legacy: true }],
        ],
      },
    }),
    
    // HTML模板处理
    createHtmlPlugin({
      inject: {
        data: {
          title: env.VITE_APP_TITLE,
          description: env.VITE_APP_DESCRIPTION,
        },
      },
      minify: isBuild,
    }),
  ];

  // 生产环境插件
  if (isBuild) {
    plugins.push(
      // 兼容性支持
      legacy({
        targets: ['defaults', 'not IE 11'],
      }),
      
      // PWA支持
      VitePWA({
        registerType: 'autoUpdate',
        workbox: {
          cleanupOutdatedCaches: true,
          globPatterns: ['**/*.{js,css,html,ico,png,svg}'],
        },
        manifest: {
          name: env.VITE_APP_TITLE,
          short_name: 'BeiLv Agent',
          description: env.VITE_APP_DESCRIPTION,
          theme_color: '#1890ff',
          background_color: '#ffffff',
          display: 'standalone',
          icons: [
            {
              src: '/icons/icon-192x192.png',
              sizes: '192x192',
              type: 'image/png',
            },
            {
              src: '/icons/icon-512x512.png',
              sizes: '512x512',
              type: 'image/png',
            },
          ],
        },
      }),
      
      // 构建分析
      visualizer({
        filename: 'dist/stats.html',
        open: false,
        gzipSize: true,
        brotliSize: true,
      })
    );
  }

  return plugins;
};
```

### Docker配置
```dockerfile
# Dockerfile
# 构建阶段
FROM node:18-alpine as builder

WORKDIR /app

# 安装pnpm
RUN npm install -g pnpm

# 复制package文件
COPY package.json pnpm-lock.yaml ./

# 安装依赖
RUN pnpm install --frozen-lockfile

# 复制源码
COPY . .

# 构建应用
ARG BUILD_ENV=production
ENV NODE_ENV=production
RUN pnpm build

# 生产阶段
FROM nginx:1.21-alpine

# 复制构建产物
COPY --from=builder /app/dist /usr/share/nginx/html

# 复制nginx配置
COPY nginx.conf /etc/nginx/nginx.conf

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:80 || exit 1

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### Nginx配置
```nginx
# nginx.conf
events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    # 访问日志
    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log;
    
    # 基础配置
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;
    
    server {
        listen 80;
        server_name _;
        root /usr/share/nginx/html;
        index index.html;
        
        # 安全头
        add_header X-Frame-Options SAMEORIGIN always;
        add_header X-Content-Type-Options nosniff always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        
        # 静态资源缓存
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        # HTML文件不缓存
        location ~* \.html$ {
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
        
        # SPA路由支持
        location / {
            try_files $uri $uri/ /index.html;
        }
        
        # API代理
        location /api/ {
            proxy_pass http://backend:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # 健康检查
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
```

### 构建脚本
```bash
#!/bin/bash
# scripts/build.sh

set -e

echo "🚀 Starting build process..."

# 检查Node.js版本
node_version=$(node -v)
echo "Node.js version: $node_version"

# 检查pnpm
if ! command -v pnpm &> /dev/null; then
    echo "pnpm is not installed. Installing..."
    npm install -g pnpm
fi

# 安装依赖
echo "📦 Installing dependencies..."
pnpm install --frozen-lockfile

# 类型检查
echo "🔍 Running type check..."
pnpm run type-check

# 代码检查
echo "🔍 Running ESLint..."
pnpm run lint

# 构建
echo "🏗️ Building for production..."
BUILD_ENV=${BUILD_ENV:-production}
pnpm run build

# 构建分析
echo "📊 Generating build analysis..."
pnpm run build:analyze

echo "✅ Build completed successfully!"
```

## 下一步
- **后续任务**: 01-6-1-Tailwind CSS集成
- **关联任务**: 开始UI组件库集成和样式系统搭建
- **注意事项**: 
  - 构建配置要考虑不同部署环境的需求
  - 环境变量要注意安全性，敏感信息不能暴露
  - 优化配置要平衡构建速度和产物质量

## 常见问题解决

### Q1: 构建产物过大
- 检查代码分割配置
- 优化依赖包引入方式
- 启用Tree Shaking
- 分析构建报告找出大文件

### Q2: 构建时间过长
- 优化Vite配置
- 使用缓存机制
- 减少不必要的插件
- 并行处理构建任务

### Q3: 环境变量不生效
- 检查变量名前缀VITE_
- 确认环境文件加载顺序
- 验证变量类型定义

### Q4: Docker构建失败
- 检查Node.js版本兼容性
- 确认依赖安装完整
- 验证构建脚本权限