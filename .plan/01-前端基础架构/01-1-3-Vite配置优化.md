# 01-1-3: Vite配置优化

## 任务概述
**时间**: 第1天上午 (45分钟)  
**目标**: 优化Vite配置，包括路径别名、代理、构建设置  
**优先级**: 高  
**依赖**: 01-1-2-环境变量配置完成

## 详细任务清单

### 执行步骤

#### 1. 安装path依赖
```bash
npm install -D @types/node
```

#### 2. 更新vite.config.ts
```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'path'

export default defineConfig({
  plugins: [react()],
  
  // 路径别名配置
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
      '@components': path.resolve(__dirname, './src/components'),
      '@pages': path.resolve(__dirname, './src/pages'),
      '@utils': path.resolve(__dirname, './src/utils'),
      '@api': path.resolve(__dirname, './src/api'),
      '@store': path.resolve(__dirname, './src/store'),
      '@hooks': path.resolve(__dirname, './src/hooks'),
      '@types': path.resolve(__dirname, './src/types'),
      '@assets': path.resolve(__dirname, './src/assets'),
      '@styles': path.resolve(__dirname, './src/styles'),
    }
  },
  
  // 开发服务器配置
  server: {
    port: 3000,
    open: true,
    cors: true,
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '/api')
      },
      '/ws': {
        target: 'ws://localhost:8080',
        ws: true,
        changeOrigin: true
      }
    }
  },
  
  // 构建配置优化
  build: {
    outDir: 'dist',
    assetsDir: 'assets',
    sourcemap: false,
    minify: 'terser',
    target: 'es2015',
    rollupOptions: {
      output: {
        chunkFileNames: 'assets/js/[name]-[hash].js',
        entryFileNames: 'assets/js/[name]-[hash].js',
        assetFileNames: 'assets/[ext]/[name]-[hash].[ext]',
        manualChunks: {
          vendor: ['react', 'react-dom'],
          router: ['react-router-dom'],
          ui: ['antd'],
          utils: ['lodash', 'dayjs']
        }
      }
    }
  },
  
  // CSS配置
  css: {
    preprocessorOptions: {
      less: {
        javascriptEnabled: true,
        modifyVars: {
          // Ant Design主题定制
          '@primary-color': '#1890ff',
          '@link-color': '#1890ff',
          '@success-color': '#52c41a',
          '@warning-color': '#faad14',
          '@error-color': '#f5222d',
        },
      },
    },
    modules: {
      localsConvention: 'camelCase'
    }
  },
  
  // 优化配置
  optimizeDeps: {
    include: ['react', 'react-dom', 'react-router-dom', 'antd']
  },
  
  // 环境变量前缀
  envPrefix: 'VITE_'
})
```

#### 3. 安装Terser用于生产环境压缩
```bash
npm install -D terser
```

#### 4. 创建开发环境专用配置
创建 `vite.config.dev.ts` 文件：
```typescript
import { defineConfig } from 'vite'
import baseConfig from './vite.config'

export default defineConfig({
  ...baseConfig,
  server: {
    ...baseConfig.server,
    host: '0.0.0.0', // 允许局域网访问
    hmr: {
      overlay: true // 显示错误覆盖层
    }
  },
  build: {
    ...baseConfig.build,
    sourcemap: true, // 开发构建保留sourcemap
    minify: false    // 开发构建不压缩
  }
})
```

#### 5. 更新package.json脚本
```json
{
  "scripts": {
    "dev": "vite --config vite.config.dev.ts",
    "build": "tsc && vite build",
    "build:dev": "tsc && vite build --mode development",
    "preview": "vite preview --port 5000",
    "type-check": "tsc --noEmit"
  }
}
```

## 验收标准
- [x] 路径别名(@符号)正确配置并能在IDE中识别
- [x] API代理服务器正常工作，能转发到后端
- [x] WebSocket代理配置正确
- [x] 开发服务器在3000端口启动并自动打开浏览器
- [x] 生产构建输出结构合理，资源分类清晰
- [x] 代码分割策略有效，vendor chunks正确生成
- [x] CSS预处理器配置生效
- [x] HMR热更新功能正常

## 交付物
- [x] 优化的`vite.config.ts`配置文件
- [x] 开发环境专用配置`vite.config.dev.ts`
- [x] 更新的package.json构建脚本
- [x] 完整的路径别名系统

## 技术要点
- **路径别名**: 简化import路径，提高开发效率
- **代理配置**: 解决开发环境跨域问题
- **构建优化**: 代码分割、资源压缩、文件命名
- **CSS配置**: 支持Less预处理器和CSS Modules
- **开发体验**: HMR、错误覆盖、自动打开浏览器

## 性能优化
- **代码分割**: 将第三方库单独打包，提高缓存效率
- **压缩优化**: 使用Terser进行JavaScript压缩
- **资源命名**: 使用hash命名，支持长期缓存
- **预构建**: 优化常用依赖的加载速度

## 测试方法
```typescript
// 测试路径别名
import EnvUtils from '@/utils/env'
import Button from '@components/Button'

// 测试API代理
fetch('/api/test').then(res => console.log('Proxy works:', res))
```

## 下一步
完成后进入 `01-1-4-TypeScript配置优化`