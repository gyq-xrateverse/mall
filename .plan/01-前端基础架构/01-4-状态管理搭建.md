# 01-4: çŠ¶æ€ç®¡ç†æ­å»º

## ä»»åŠ¡æ¦‚è¿°
**æ—¶é—´**: ç¬¬4-5å¤©  
**ç›®æ ‡**: ä½¿ç”¨Redux Toolkitæ­å»ºå…¨å±€çŠ¶æ€ç®¡ç†ç³»ç»Ÿ  
**ä¼˜å…ˆçº§**: æœ€é«˜  
**ä¾èµ–**: 01-3 è·¯ç”±ç³»ç»Ÿå®Œæˆ

## è¯¦ç»†ä»»åŠ¡æ¸…å•

### 4.1 å®‰è£…Redux Toolkit
```bash
npm install @reduxjs/toolkit react-redux
npm install --save-dev @types/react-redux
```

### 4.2 Storeé…ç½®
**åˆ›å»º `src/store/index.ts`**:
```typescript
import { configureStore } from '@reduxjs/toolkit';
import { setupListeners } from '@reduxjs/toolkit/query';
import authSlice from './auth/authSlice';
import creditsSlice from './credits/creditsSlice';
import plansSlice from './plans/plansSlice';
import projectsSlice from './projects/projectsSlice';
import gallerySlice from './gallery/gallerySlice';
import uiSlice from './ui/uiSlice';
import { authAPI } from '@/api/auth';
import { creditsAPI } from '@/api/credits';
import { plansAPI } from '@/api/plans';
import { projectsAPI } from '@/api/projects';
import { galleryAPI } from '@/api/gallery';

export const store = configureStore({
  reducer: {
    // åŸºç¡€çŠ¶æ€åˆ‡ç‰‡
    auth: authSlice,
    credits: creditsSlice,
    plans: plansSlice,
    projects: projectsSlice,
    gallery: gallerySlice,
    ui: uiSlice,
    
    // RTK Query APIåˆ‡ç‰‡
    [authAPI.reducerPath]: authAPI.reducer,
    [creditsAPI.reducerPath]: creditsAPI.reducer,
    [plansAPI.reducerPath]: plansAPI.reducer,
    [projectsAPI.reducerPath]: projectsAPI.reducer,
    [galleryAPI.reducerPath]: galleryAPI.reducer,
  },
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware({
      serializableCheck: {
        ignoredActions: ['persist/PERSIST', 'persist/REHYDRATE'],
      },
    })
    .concat(authAPI.middleware)
    .concat(creditsAPI.middleware)
    .concat(plansAPI.middleware)
    .concat(projectsAPI.middleware)
    .concat(galleryAPI.middleware),
  devTools: process.env.NODE_ENV !== 'production',
});

// å¯ç”¨RTK Queryçš„è‡ªåŠ¨é‡æ–°è·å–åŠŸèƒ½
setupListeners(store.dispatch);

export type RootState = ReturnType<typeof store.getState>;
export type AppDispatch = typeof store.dispatch;
```

**éªŒæ”¶æ ‡å‡†**:
- [x] Storeæ­£ç¡®é…ç½®ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦çš„slice
- [x] RTK Queryä¸­é—´ä»¶æ­£ç¡®é…ç½®
- [x] DevToolsåœ¨å¼€å‘ç¯å¢ƒæ­£å¸¸å·¥ä½œ

### 4.3 AuthçŠ¶æ€ç®¡ç†
**åˆ›å»º `src/store/auth/authSlice.ts`**:
```typescript
import { createSlice, createAsyncThunk, PayloadAction } from '@reduxjs/toolkit';

interface User {
  id: number;
  email: string;
  username: string;
  avatar?: string;
  createdAt: string;
}

interface AuthState {
  user: User | null;
  token: string | null;
  refreshToken: string | null;
  isAuthenticated: boolean;
  loading: boolean;
  error: string | null;
}

const initialState: AuthState = {
  user: null,
  token: localStorage.getItem('token'),
  refreshToken: localStorage.getItem('refreshToken'),
  isAuthenticated: false,
  loading: false,
  error: null,
};

// å¼‚æ­¥thunks
export const loginUser = createAsyncThunk(
  'auth/login',
  async (credentials: { email: string; password: string }) => {
    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(credentials),
    });
    
    if (!response.ok) {
      throw new Error('Login failed');
    }
    
    const data = await response.json();
    return data;
  }
);

export const logoutUser = createAsyncThunk(
  'auth/logout',
  async () => {
    // å¯ä»¥è°ƒç”¨åç«¯logout API
    localStorage.removeItem('token');
    localStorage.removeItem('refreshToken');
  }
);

export const getCurrentUser = createAsyncThunk(
  'auth/getCurrentUser',
  async (_, { getState }) => {
    const state = getState() as { auth: AuthState };
    
    if (!state.auth.token) {
      throw new Error('No token available');
    }
    
    const response = await fetch('/api/auth/me', {
      headers: {
        Authorization: `Bearer ${state.auth.token}`,
      },
    });
    
    if (!response.ok) {
      throw new Error('Failed to get user info');
    }
    
    return await response.json();
  }
);

const authSlice = createSlice({
  name: 'auth',
  initialState,
  reducers: {
    clearError: (state) => {
      state.error = null;
    },
    setCredentials: (state, action: PayloadAction<{ user: User; token: string; refreshToken?: string }>) => {
      const { user, token, refreshToken } = action.payload;
      state.user = user;
      state.token = token;
      state.refreshToken = refreshToken || state.refreshToken;
      state.isAuthenticated = true;
      
      localStorage.setItem('token', token);
      if (refreshToken) {
        localStorage.setItem('refreshToken', refreshToken);
      }
    },
  },
  extraReducers: (builder) => {
    builder
      // Login
      .addCase(loginUser.pending, (state) => {
        state.loading = true;
        state.error = null;
      })
      .addCase(loginUser.fulfilled, (state, action) => {
        state.loading = false;
        state.user = action.payload.user;
        state.token = action.payload.token;
        state.refreshToken = action.payload.refreshToken;
        state.isAuthenticated = true;
        
        localStorage.setItem('token', action.payload.token);
        localStorage.setItem('refreshToken', action.payload.refreshToken);
      })
      .addCase(loginUser.rejected, (state, action) => {
        state.loading = false;
        state.error = action.error.message || 'Login failed';
        state.isAuthenticated = false;
      })
      
      // Logout
      .addCase(logoutUser.fulfilled, (state) => {
        state.user = null;
        state.token = null;
        state.refreshToken = null;
        state.isAuthenticated = false;
        state.error = null;
      })
      
      // Get current user
      .addCase(getCurrentUser.fulfilled, (state, action) => {
        state.user = action.payload;
        state.isAuthenticated = true;
      })
      .addCase(getCurrentUser.rejected, (state) => {
        state.user = null;
        state.token = null;
        state.refreshToken = null;
        state.isAuthenticated = false;
        localStorage.removeItem('token');
        localStorage.removeItem('refreshToken');
      });
  },
});

export const { clearError, setCredentials } = authSlice.actions;
export default authSlice.reducer;
```

**éªŒæ”¶æ ‡å‡†**:
- [x] ç”¨æˆ·ç™»å½•çŠ¶æ€æ­£ç¡®ç®¡ç†
- [x] Tokenè‡ªåŠ¨ä¿å­˜åˆ°localStorage
- [x] ç™»å½•/ç™»å‡ºçŠ¶æ€æ­£ç¡®æ›´æ–°

### 4.4 UIçŠ¶æ€ç®¡ç†
**åˆ›å»º `src/store/ui/uiSlice.ts`**:
```typescript
import { createSlice, PayloadAction } from '@reduxjs/toolkit';

interface Notification {
  id: string;
  type: 'success' | 'error' | 'warning' | 'info';
  title: string;
  message?: string;
  duration?: number;
}

interface Modal {
  id: string;
  component: string;
  props?: Record<string, any>;
}

interface UIState {
  loading: boolean;
  sidebarCollapsed: boolean;
  theme: 'light' | 'dark';
  notifications: Notification[];
  modals: Modal[];
  breadcrumbs: Array<{ label: string; path?: string }>;
}

const initialState: UIState = {
  loading: false,
  sidebarCollapsed: false,
  theme: (localStorage.getItem('theme') as 'light' | 'dark') || 'light',
  notifications: [],
  modals: [],
  breadcrumbs: [],
};

const uiSlice = createSlice({
  name: 'ui',
  initialState,
  reducers: {
    setLoading: (state, action: PayloadAction<boolean>) => {
      state.loading = action.payload;
    },
    
    toggleSidebar: (state) => {
      state.sidebarCollapsed = !state.sidebarCollapsed;
    },
    
    setSidebarCollapsed: (state, action: PayloadAction<boolean>) => {
      state.sidebarCollapsed = action.payload;
    },
    
    setTheme: (state, action: PayloadAction<'light' | 'dark'>) => {
      state.theme = action.payload;
      localStorage.setItem('theme', action.payload);
    },
    
    addNotification: (state, action: PayloadAction<Omit<Notification, 'id'>>) => {
      const notification: Notification = {
        ...action.payload,
        id: Date.now().toString() + Math.random(),
      };
      state.notifications.push(notification);
    },
    
    removeNotification: (state, action: PayloadAction<string>) => {
      state.notifications = state.notifications.filter(
        (notification) => notification.id !== action.payload
      );
    },
    
    openModal: (state, action: PayloadAction<Omit<Modal, 'id'>>) => {
      const modal: Modal = {
        ...action.payload,
        id: Date.now().toString() + Math.random(),
      };
      state.modals.push(modal);
    },
    
    closeModal: (state, action: PayloadAction<string>) => {
      state.modals = state.modals.filter(
        (modal) => modal.id !== action.payload
      );
    },
    
    setBreadcrumbs: (state, action: PayloadAction<Array<{ label: string; path?: string }>>) => {
      state.breadcrumbs = action.payload;
    },
  },
});

export const {
  setLoading,
  toggleSidebar,
  setSidebarCollapsed,
  setTheme,
  addNotification,
  removeNotification,
  openModal,
  closeModal,
  setBreadcrumbs,
} = uiSlice.actions;

export default uiSlice.reducer;
```

**éªŒæ”¶æ ‡å‡†**:
- [x] å…¨å±€loadingçŠ¶æ€ç®¡ç†
- [x] é€šçŸ¥ç³»ç»ŸçŠ¶æ€ç®¡ç†
- [x] æ¨¡æ€æ¡†çŠ¶æ€ç®¡ç†
- [x] ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½

### 4.5 è‡ªå®šä¹‰Hooks
**åˆ›å»º `src/hooks/redux.ts`**:
```typescript
import { useDispatch, useSelector, TypedUseSelectorHook } from 'react-redux';
import type { RootState, AppDispatch } from '@/store';

// ä½¿ç”¨è¿™äº›hooksæ›¿ä»£æ™®é€šçš„useDispatchå’ŒuseSelector
export const useAppDispatch = () => useDispatch<AppDispatch>();
export const useAppSelector: TypedUseSelectorHook<RootState> = useSelector;
```

**åˆ›å»ºé€šçŸ¥Hook `src/hooks/useNotification.ts`**:
```typescript
import { useCallback } from 'react';
import { useAppDispatch } from './redux';
import { addNotification, removeNotification } from '@/store/ui/uiSlice';

export const useNotification = () => {
  const dispatch = useAppDispatch();

  const showNotification = useCallback(
    (notification: {
      type: 'success' | 'error' | 'warning' | 'info';
      title: string;
      message?: string;
      duration?: number;
    }) => {
      const id = dispatch(addNotification(notification)).payload.id;
      
      // è‡ªåŠ¨ç§»é™¤é€šçŸ¥
      const duration = notification.duration || 5000;
      setTimeout(() => {
        dispatch(removeNotification(id));
      }, duration);
      
      return id;
    },
    [dispatch]
  );

  const hideNotification = useCallback(
    (id: string) => {
      dispatch(removeNotification(id));
    },
    [dispatch]
  );

  return { showNotification, hideNotification };
};
```

**éªŒæ”¶æ ‡å‡†**:
- [x] ç±»å‹å®‰å…¨çš„Redux hooks
- [x] ä¾¿æ·çš„é€šçŸ¥ç®¡ç†hook
- [x] hooksåœ¨ç»„ä»¶ä¸­æ­£å¸¸å·¥ä½œ

### 4.6 æ•°æ®æŒä¹…åŒ–
**å®‰è£…Redux Persist**:
```bash
npm install redux-persist
```

**åˆ›å»ºæŒä¹…åŒ–é…ç½® `src/store/persist.ts`**:
```typescript
import { persistReducer, persistStore } from 'redux-persist';
import storage from 'redux-persist/lib/storage';
import { combineReducers } from '@reduxjs/toolkit';
import authSlice from './auth/authSlice';
import uiSlice from './ui/uiSlice';

const persistConfig = {
  key: 'root',
  storage,
  whitelist: ['auth'], // åªæŒä¹…åŒ–authçŠ¶æ€
};

const rootReducer = combineReducers({
  auth: authSlice,
  ui: uiSlice,
  // å…¶ä»–éæŒä¹…åŒ–çš„reducer
});

export const persistedReducer = persistReducer(persistConfig, rootReducer);
export const persistor = persistStore(store);
```

**éªŒæ”¶æ ‡å‡†**:
- [x] ç”¨æˆ·ç™»å½•çŠ¶æ€åœ¨åˆ·æ–°åä¿æŒ
- [x] æ•æ„Ÿæ•°æ®ä¸è¢«æŒä¹…åŒ–
- [x] æŒä¹…åŒ–çŠ¶æ€æ­£ç¡®æ¢å¤

## äº¤ä»˜ç‰©
- [x] å®Œæ•´çš„Redux Toolkité…ç½®
- [x] AuthçŠ¶æ€ç®¡ç†åˆ‡ç‰‡
- [x] UIçŠ¶æ€ç®¡ç†åˆ‡ç‰‡  
- [x] è‡ªå®šä¹‰Redux hooks
- [x] æ•°æ®æŒä¹…åŒ–é…ç½®

## éªŒè¯æµ‹è¯•
1. æµ‹è¯•ç”¨æˆ·ç™»å½•çŠ¶æ€ç®¡ç†
2. éªŒè¯é€šçŸ¥ç³»ç»ŸåŠŸèƒ½
3. æ£€æŸ¥æ•°æ®æŒä¹…åŒ–
4. æµ‹è¯•Redux DevTools

## é£é™©æ§åˆ¶
- **çŠ¶æ€ç»“æ„è®¾è®¡**: ä¿æŒçŠ¶æ€ç»“æ„æ‰å¹³ï¼Œé¿å…æ·±å±‚åµŒå¥—
- **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨selectorä¼˜åŒ–é‡æ–°æ¸²æŸ“
- **æŒä¹…åŒ–å®‰å…¨**: é¿å…æŒä¹…åŒ–æ•æ„Ÿä¿¡æ¯

## éªŒæ”¶è®°å½•
**å®Œæˆæ—¶é—´**: 2025-01-09 12:30  
**éªŒæ”¶çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡  
**éªŒæ”¶äºº**: Claude Code  

### è¯¦ç»†éªŒæ”¶è®°å½•
1. **4.1 å®‰è£…Redux Toolkit**: âœ… é€šè¿‡ - Redux Toolkit v2.9.0, React Redux v9.2.0, Redux Persist v6.0.0 å®‰è£…å®Œæˆ
2. **4.2 Storeé…ç½®**: âœ… é€šè¿‡ - Storeé…ç½®å®Œæ•´ï¼ŒåŒ…å«æŒä¹…åŒ–ä¸­é—´ä»¶ï¼ŒDevToolså¯ç”¨
3. **4.3 AuthçŠ¶æ€ç®¡ç†**: âœ… é€šè¿‡ - è®¤è¯çŠ¶æ€ç®¡ç†å®Œæ•´å®ç°ï¼Œæ”¯æŒç™»å½•/ç™»å‡ºï¼ŒtokenæŒä¹…åŒ–
4. **4.4 UIçŠ¶æ€ç®¡ç†**: âœ… é€šè¿‡ - å…¨å±€UIçŠ¶æ€ç®¡ç†ï¼Œæ”¯æŒloadingã€é€šçŸ¥ã€æ¨¡æ€æ¡†ã€ä¸»é¢˜åˆ‡æ¢
5. **4.5 è‡ªå®šä¹‰Hooks**: âœ… é€šè¿‡ - ç±»å‹å®‰å…¨çš„Redux hooksï¼Œä¾¿æ·çš„é€šçŸ¥ç®¡ç†hook
6. **4.6 æ•°æ®æŒä¹…åŒ–**: âœ… é€šè¿‡ - é€‰æ‹©æ€§æŒä¹…åŒ–authå’ŒUIçŠ¶æ€ï¼Œå®‰å…¨é…ç½®

### æµ‹è¯•ç»“æœ
- âœ… `npm run build` - æ„å»ºæˆåŠŸï¼ŒReduxé›†æˆæ— é—®é¢˜
- âœ… `npm run lint` - ä»£ç æ£€æŸ¥é€šè¿‡ï¼Œç±»å‹å®‰å…¨
- âœ… çŠ¶æ€æŒä¹…åŒ–æµ‹è¯• - åˆ·æ–°åè®¤è¯çŠ¶æ€ä¿æŒ
- âœ… ç™»å½•æµç¨‹æµ‹è¯• - æ¨¡æ‹Ÿç™»å½•åŠŸèƒ½æ­£å¸¸
- âœ… è·¯ç”±å®ˆå«æµ‹è¯• - è®¤è¯çŠ¶æ€æ£€æŸ¥æ­£å¸¸å·¥ä½œ
- âœ… é€šçŸ¥ç³»ç»Ÿæµ‹è¯• - è‡ªåŠ¨æ¶ˆæ¯æç¤ºåŠŸèƒ½æ­£å¸¸

### æŠ€æœ¯å®ç°äº®ç‚¹
- ğŸ—„ï¸ **Redux Toolkit** - ç°ä»£åŒ–çŠ¶æ€ç®¡ç†ï¼Œå‡å°‘æ ·æ¿ä»£ç 
- ğŸ” **è®¤è¯ç®¡ç†** - å®Œæ•´çš„ç™»å½•çŠ¶æ€ç®¡ç†ï¼Œæ”¯æŒtokenæŒä¹…åŒ–  
- ğŸ¯ **ç±»å‹å®‰å…¨** - å®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰
- ğŸ’¾ **é€‰æ‹©æ€§æŒä¹…åŒ–** - åªæŒä¹…åŒ–å¿…è¦çŠ¶æ€ï¼Œä¿æŠ¤æ•æ„Ÿä¿¡æ¯
- ğŸ”” **é€šçŸ¥ç³»ç»Ÿ** - è‡ªåŠ¨æ¶ˆæ¯æç¤ºï¼Œæ”¯æŒå¤šç§ç±»å‹
- ğŸ¨ **ä¸»é¢˜æ”¯æŒ** - å†…ç½®ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
- ğŸ“± **å“åº”å¼** - æ”¯æŒä¾§è¾¹æ æŠ˜å çŠ¶æ€ç®¡ç†

### é—®é¢˜è§£å†³è®°å½•
- ğŸ”§ ä¿®å¤TypeScript verbatimModuleSyntaxå¯¼å…¥é”™è¯¯ï¼Œåˆ†ç¦»ç±»å‹å¯¼å…¥
- ğŸ”§ ä¿®å¤useNotificationä¸­çš„ç±»å‹æ¨æ–­é—®é¢˜
- ğŸ”§ ä¼˜åŒ–Redux persisté…ç½®ï¼Œé¿å…åºåˆ—åŒ–æ£€æŸ¥è­¦å‘Š
- ğŸ”§ å®ç°mockç™»å½•APIï¼Œæ”¯æŒå¼€å‘ç¯å¢ƒæµ‹è¯•

### é›†æˆçŠ¶æ€
- âœ… Headerç»„ä»¶å·²æ›´æ–°ï¼Œæ˜¾ç¤ºç”¨æˆ·çŠ¶æ€å’Œç™»å‡ºåŠŸèƒ½
- âœ… Loginé¡µé¢å·²é›†æˆReduxï¼Œæ”¯æŒè¡¨å•éªŒè¯å’ŒçŠ¶æ€æ˜¾ç¤º
- âœ… è·¯ç”±å®ˆå«å·²è¿æ¥çœŸå®è®¤è¯çŠ¶æ€
- âœ… Appç»„ä»¶é›†æˆProviderå’ŒPersistGate

## ä¸‹ä¸€æ­¥
å®Œæˆåè¿›å…¥ `01-5-HTTPè¯·æ±‚å°è£…å’Œå›½é™…åŒ–` âœ… **å‡†å¤‡å¼€å§‹**