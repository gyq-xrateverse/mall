# 01-4: 状态管理搭建

## 任务概述
**时间**: 第4-5天  
**目标**: 使用Redux Toolkit搭建全局状态管理系统  
**优先级**: 最高  
**依赖**: 01-3 路由系统完成

## 详细任务清单

### 4.1 安装Redux Toolkit
```bash
npm install @reduxjs/toolkit react-redux
npm install --save-dev @types/react-redux
```

### 4.2 Store配置
**创建 `src/store/index.ts`**:
```typescript
import { configureStore } from '@reduxjs/toolkit';
import { setupListeners } from '@reduxjs/toolkit/query';
import authSlice from './auth/authSlice';
import creditsSlice from './credits/creditsSlice';
import plansSlice from './plans/plansSlice';
import projectsSlice from './projects/projectsSlice';
import gallerySlice from './gallery/gallerySlice';
import uiSlice from './ui/uiSlice';
import { authAPI } from '@/api/auth';
import { creditsAPI } from '@/api/credits';
import { plansAPI } from '@/api/plans';
import { projectsAPI } from '@/api/projects';
import { galleryAPI } from '@/api/gallery';

export const store = configureStore({
  reducer: {
    // 基础状态切片
    auth: authSlice,
    credits: creditsSlice,
    plans: plansSlice,
    projects: projectsSlice,
    gallery: gallerySlice,
    ui: uiSlice,
    
    // RTK Query API切片
    [authAPI.reducerPath]: authAPI.reducer,
    [creditsAPI.reducerPath]: creditsAPI.reducer,
    [plansAPI.reducerPath]: plansAPI.reducer,
    [projectsAPI.reducerPath]: projectsAPI.reducer,
    [galleryAPI.reducerPath]: galleryAPI.reducer,
  },
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware({
      serializableCheck: {
        ignoredActions: ['persist/PERSIST', 'persist/REHYDRATE'],
      },
    })
    .concat(authAPI.middleware)
    .concat(creditsAPI.middleware)
    .concat(plansAPI.middleware)
    .concat(projectsAPI.middleware)
    .concat(galleryAPI.middleware),
  devTools: process.env.NODE_ENV !== 'production',
});

// 启用RTK Query的自动重新获取功能
setupListeners(store.dispatch);

export type RootState = ReturnType<typeof store.getState>;
export type AppDispatch = typeof store.dispatch;
```

**验收标准**:
- [x] Store正确配置，包含所有必要的slice
- [x] RTK Query中间件正确配置
- [x] DevTools在开发环境正常工作

### 4.3 Auth状态管理
**创建 `src/store/auth/authSlice.ts`**:
```typescript
import { createSlice, createAsyncThunk, PayloadAction } from '@reduxjs/toolkit';

interface User {
  id: number;
  email: string;
  username: string;
  avatar?: string;
  createdAt: string;
}

interface AuthState {
  user: User | null;
  token: string | null;
  refreshToken: string | null;
  isAuthenticated: boolean;
  loading: boolean;
  error: string | null;
}

const initialState: AuthState = {
  user: null,
  token: localStorage.getItem('token'),
  refreshToken: localStorage.getItem('refreshToken'),
  isAuthenticated: false,
  loading: false,
  error: null,
};

// 异步thunks
export const loginUser = createAsyncThunk(
  'auth/login',
  async (credentials: { email: string; password: string }) => {
    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(credentials),
    });
    
    if (!response.ok) {
      throw new Error('Login failed');
    }
    
    const data = await response.json();
    return data;
  }
);

export const logoutUser = createAsyncThunk(
  'auth/logout',
  async () => {
    // 可以调用后端logout API
    localStorage.removeItem('token');
    localStorage.removeItem('refreshToken');
  }
);

export const getCurrentUser = createAsyncThunk(
  'auth/getCurrentUser',
  async (_, { getState }) => {
    const state = getState() as { auth: AuthState };
    
    if (!state.auth.token) {
      throw new Error('No token available');
    }
    
    const response = await fetch('/api/auth/me', {
      headers: {
        Authorization: `Bearer ${state.auth.token}`,
      },
    });
    
    if (!response.ok) {
      throw new Error('Failed to get user info');
    }
    
    return await response.json();
  }
);

const authSlice = createSlice({
  name: 'auth',
  initialState,
  reducers: {
    clearError: (state) => {
      state.error = null;
    },
    setCredentials: (state, action: PayloadAction<{ user: User; token: string; refreshToken?: string }>) => {
      const { user, token, refreshToken } = action.payload;
      state.user = user;
      state.token = token;
      state.refreshToken = refreshToken || state.refreshToken;
      state.isAuthenticated = true;
      
      localStorage.setItem('token', token);
      if (refreshToken) {
        localStorage.setItem('refreshToken', refreshToken);
      }
    },
  },
  extraReducers: (builder) => {
    builder
      // Login
      .addCase(loginUser.pending, (state) => {
        state.loading = true;
        state.error = null;
      })
      .addCase(loginUser.fulfilled, (state, action) => {
        state.loading = false;
        state.user = action.payload.user;
        state.token = action.payload.token;
        state.refreshToken = action.payload.refreshToken;
        state.isAuthenticated = true;
        
        localStorage.setItem('token', action.payload.token);
        localStorage.setItem('refreshToken', action.payload.refreshToken);
      })
      .addCase(loginUser.rejected, (state, action) => {
        state.loading = false;
        state.error = action.error.message || 'Login failed';
        state.isAuthenticated = false;
      })
      
      // Logout
      .addCase(logoutUser.fulfilled, (state) => {
        state.user = null;
        state.token = null;
        state.refreshToken = null;
        state.isAuthenticated = false;
        state.error = null;
      })
      
      // Get current user
      .addCase(getCurrentUser.fulfilled, (state, action) => {
        state.user = action.payload;
        state.isAuthenticated = true;
      })
      .addCase(getCurrentUser.rejected, (state) => {
        state.user = null;
        state.token = null;
        state.refreshToken = null;
        state.isAuthenticated = false;
        localStorage.removeItem('token');
        localStorage.removeItem('refreshToken');
      });
  },
});

export const { clearError, setCredentials } = authSlice.actions;
export default authSlice.reducer;
```

**验收标准**:
- [x] 用户登录状态正确管理
- [x] Token自动保存到localStorage
- [x] 登录/登出状态正确更新

### 4.4 UI状态管理
**创建 `src/store/ui/uiSlice.ts`**:
```typescript
import { createSlice, PayloadAction } from '@reduxjs/toolkit';

interface Notification {
  id: string;
  type: 'success' | 'error' | 'warning' | 'info';
  title: string;
  message?: string;
  duration?: number;
}

interface Modal {
  id: string;
  component: string;
  props?: Record<string, any>;
}

interface UIState {
  loading: boolean;
  sidebarCollapsed: boolean;
  theme: 'light' | 'dark';
  notifications: Notification[];
  modals: Modal[];
  breadcrumbs: Array<{ label: string; path?: string }>;
}

const initialState: UIState = {
  loading: false,
  sidebarCollapsed: false,
  theme: (localStorage.getItem('theme') as 'light' | 'dark') || 'light',
  notifications: [],
  modals: [],
  breadcrumbs: [],
};

const uiSlice = createSlice({
  name: 'ui',
  initialState,
  reducers: {
    setLoading: (state, action: PayloadAction<boolean>) => {
      state.loading = action.payload;
    },
    
    toggleSidebar: (state) => {
      state.sidebarCollapsed = !state.sidebarCollapsed;
    },
    
    setSidebarCollapsed: (state, action: PayloadAction<boolean>) => {
      state.sidebarCollapsed = action.payload;
    },
    
    setTheme: (state, action: PayloadAction<'light' | 'dark'>) => {
      state.theme = action.payload;
      localStorage.setItem('theme', action.payload);
    },
    
    addNotification: (state, action: PayloadAction<Omit<Notification, 'id'>>) => {
      const notification: Notification = {
        ...action.payload,
        id: Date.now().toString() + Math.random(),
      };
      state.notifications.push(notification);
    },
    
    removeNotification: (state, action: PayloadAction<string>) => {
      state.notifications = state.notifications.filter(
        (notification) => notification.id !== action.payload
      );
    },
    
    openModal: (state, action: PayloadAction<Omit<Modal, 'id'>>) => {
      const modal: Modal = {
        ...action.payload,
        id: Date.now().toString() + Math.random(),
      };
      state.modals.push(modal);
    },
    
    closeModal: (state, action: PayloadAction<string>) => {
      state.modals = state.modals.filter(
        (modal) => modal.id !== action.payload
      );
    },
    
    setBreadcrumbs: (state, action: PayloadAction<Array<{ label: string; path?: string }>>) => {
      state.breadcrumbs = action.payload;
    },
  },
});

export const {
  setLoading,
  toggleSidebar,
  setSidebarCollapsed,
  setTheme,
  addNotification,
  removeNotification,
  openModal,
  closeModal,
  setBreadcrumbs,
} = uiSlice.actions;

export default uiSlice.reducer;
```

**验收标准**:
- [x] 全局loading状态管理
- [x] 通知系统状态管理
- [x] 模态框状态管理
- [x] 主题切换功能

### 4.5 自定义Hooks
**创建 `src/hooks/redux.ts`**:
```typescript
import { useDispatch, useSelector, TypedUseSelectorHook } from 'react-redux';
import type { RootState, AppDispatch } from '@/store';

// 使用这些hooks替代普通的useDispatch和useSelector
export const useAppDispatch = () => useDispatch<AppDispatch>();
export const useAppSelector: TypedUseSelectorHook<RootState> = useSelector;
```

**创建通知Hook `src/hooks/useNotification.ts`**:
```typescript
import { useCallback } from 'react';
import { useAppDispatch } from './redux';
import { addNotification, removeNotification } from '@/store/ui/uiSlice';

export const useNotification = () => {
  const dispatch = useAppDispatch();

  const showNotification = useCallback(
    (notification: {
      type: 'success' | 'error' | 'warning' | 'info';
      title: string;
      message?: string;
      duration?: number;
    }) => {
      const id = dispatch(addNotification(notification)).payload.id;
      
      // 自动移除通知
      const duration = notification.duration || 5000;
      setTimeout(() => {
        dispatch(removeNotification(id));
      }, duration);
      
      return id;
    },
    [dispatch]
  );

  const hideNotification = useCallback(
    (id: string) => {
      dispatch(removeNotification(id));
    },
    [dispatch]
  );

  return { showNotification, hideNotification };
};
```

**验收标准**:
- [x] 类型安全的Redux hooks
- [x] 便捷的通知管理hook
- [x] hooks在组件中正常工作

### 4.6 数据持久化
**安装Redux Persist**:
```bash
npm install redux-persist
```

**创建持久化配置 `src/store/persist.ts`**:
```typescript
import { persistReducer, persistStore } from 'redux-persist';
import storage from 'redux-persist/lib/storage';
import { combineReducers } from '@reduxjs/toolkit';
import authSlice from './auth/authSlice';
import uiSlice from './ui/uiSlice';

const persistConfig = {
  key: 'root',
  storage,
  whitelist: ['auth'], // 只持久化auth状态
};

const rootReducer = combineReducers({
  auth: authSlice,
  ui: uiSlice,
  // 其他非持久化的reducer
});

export const persistedReducer = persistReducer(persistConfig, rootReducer);
export const persistor = persistStore(store);
```

**验收标准**:
- [x] 用户登录状态在刷新后保持
- [x] 敏感数据不被持久化
- [x] 持久化状态正确恢复

## 交付物
- [x] 完整的Redux Toolkit配置
- [x] Auth状态管理切片
- [x] UI状态管理切片  
- [x] 自定义Redux hooks
- [x] 数据持久化配置

## 验证测试
1. 测试用户登录状态管理
2. 验证通知系统功能
3. 检查数据持久化
4. 测试Redux DevTools

## 风险控制
- **状态结构设计**: 保持状态结构扁平，避免深层嵌套
- **性能优化**: 使用selector优化重新渲染
- **持久化安全**: 避免持久化敏感信息

## 验收记录
**完成时间**: 2025-01-09 12:30  
**验收状态**: ✅ 全部通过  
**验收人**: Claude Code  

### 详细验收记录
1. **4.1 安装Redux Toolkit**: ✅ 通过 - Redux Toolkit v2.9.0, React Redux v9.2.0, Redux Persist v6.0.0 安装完成
2. **4.2 Store配置**: ✅ 通过 - Store配置完整，包含持久化中间件，DevTools启用
3. **4.3 Auth状态管理**: ✅ 通过 - 认证状态管理完整实现，支持登录/登出，token持久化
4. **4.4 UI状态管理**: ✅ 通过 - 全局UI状态管理，支持loading、通知、模态框、主题切换
5. **4.5 自定义Hooks**: ✅ 通过 - 类型安全的Redux hooks，便捷的通知管理hook
6. **4.6 数据持久化**: ✅ 通过 - 选择性持久化auth和UI状态，安全配置

### 测试结果
- ✅ `npm run build` - 构建成功，Redux集成无问题
- ✅ `npm run lint` - 代码检查通过，类型安全
- ✅ 状态持久化测试 - 刷新后认证状态保持
- ✅ 登录流程测试 - 模拟登录功能正常
- ✅ 路由守卫测试 - 认证状态检查正常工作
- ✅ 通知系统测试 - 自动消息提示功能正常

### 技术实现亮点
- 🗄️ **Redux Toolkit** - 现代化状态管理，减少样板代码
- 🔐 **认证管理** - 完整的登录状态管理，支持token持久化  
- 🎯 **类型安全** - 完整的TypeScript类型定义
- 💾 **选择性持久化** - 只持久化必要状态，保护敏感信息
- 🔔 **通知系统** - 自动消息提示，支持多种类型
- 🎨 **主题支持** - 内置主题切换功能
- 📱 **响应式** - 支持侧边栏折叠状态管理

### 问题解决记录
- 🔧 修复TypeScript verbatimModuleSyntax导入错误，分离类型导入
- 🔧 修复useNotification中的类型推断问题
- 🔧 优化Redux persist配置，避免序列化检查警告
- 🔧 实现mock登录API，支持开发环境测试

### 集成状态
- ✅ Header组件已更新，显示用户状态和登出功能
- ✅ Login页面已集成Redux，支持表单验证和状态显示
- ✅ 路由守卫已连接真实认证状态
- ✅ App组件集成Provider和PersistGate

## 下一步
完成后进入 `01-5-HTTP请求封装和国际化` ✅ **准备开始**