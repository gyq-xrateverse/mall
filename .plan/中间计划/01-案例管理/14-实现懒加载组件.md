# 14-实现懒加载组件

## 任务概述
在用户前端创建案例列表懒加载组件，实现无限滚动分页加载，优化用户体验和页面性能。

## 前置条件
- Redux store已重构完成
- 用户端案例查询API已完成
- React项目正常运行

## 实施步骤

### 1. 创建懒加载Hook
**文件路径：** `beilv-agent-web/src/hooks/useInfiniteScroll.ts`

```typescript
import { useEffect, useCallback, useRef } from 'react';

interface UseInfiniteScrollOptions {
  threshold?: number; // 距离底部多少像素时触发加载
  rootMargin?: string; // IntersectionObserver 的 rootMargin
  enabled?: boolean; // 是否启用无限滚动
}

interface UseInfiniteScrollReturn {
  targetRef: React.RefObject<HTMLDivElement>;
  isVisible: boolean;
}

export const useInfiniteScroll = (
  onLoadMore: () => void,
  hasMore: boolean,
  loading: boolean,
  options: UseInfiniteScrollOptions = {}
): UseInfiniteScrollReturn => {
  const {
    threshold = 100,
    rootMargin = '0px',
    enabled = true
  } = options;

  const targetRef = useRef<HTMLDivElement>(null);
  const observerRef = useRef<IntersectionObserver | null>(null);
  const isVisibleRef = useRef(false);

  const handleIntersection = useCallback((entries: IntersectionObserverEntry[]) => {
    const [entry] = entries;
    isVisibleRef.current = entry.isIntersecting;

    if (entry.isIntersecting && hasMore && !loading && enabled) {
      onLoadMore();
    }
  }, [onLoadMore, hasMore, loading, enabled]);

  useEffect(() => {
    const target = targetRef.current;
    
    if (!target || !enabled) {
      return;
    }

    // 创建 IntersectionObserver
    observerRef.current = new IntersectionObserver(handleIntersection, {
      root: null,
      rootMargin,
      threshold: 0.1
    });

    observerRef.current.observe(target);

    return () => {
      if (observerRef.current) {
        observerRef.current.disconnect();
      }
    };
  }, [handleIntersection, rootMargin, enabled]);

  // 滚动事件监听作为备用方案
  useEffect(() => {
    if (!enabled) return;

    const handleScroll = () => {
      const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
      const scrollHeight = document.documentElement.scrollHeight || document.body.scrollHeight;
      const clientHeight = document.documentElement.clientHeight || window.innerHeight;

      if (scrollTop + clientHeight >= scrollHeight - threshold && hasMore && !loading) {
        onLoadMore();
      }
    };

    // 防抖处理
    let timeoutId: NodeJS.Timeout;
    const debouncedHandleScroll = () => {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(handleScroll, 100);
    };

    window.addEventListener('scroll', debouncedHandleScroll);
    
    return () => {
      window.removeEventListener('scroll', debouncedHandleScroll);
      clearTimeout(timeoutId);
    };
  }, [onLoadMore, hasMore, loading, threshold, enabled]);

  return {
    targetRef,
    isVisible: isVisibleRef.current
  };
};
```

### 2. 创建案例卡片组件
**文件路径：** `beilv-agent-web/src/components/CaseCard/CaseCard.tsx`

```tsx
import React, { useState, useRef, useCallback } from 'react';
import { CaseData } from '@/types/cases';
import { formatDistanceToNow } from 'date-fns';
import { zhCN } from 'date-fns/locale';
import styles from './CaseCard.module.css';

interface CaseCardProps {
  case: CaseData;
  onLike: (caseId: number) => void;
  onView: (caseId: number) => void;
  onImageLoad?: () => void;
  loading?: boolean;
}

const CaseCard: React.FC<CaseCardProps> = ({
  case: caseItem,
  onLike,
  onView,
  onImageLoad,
  loading = false
}) => {
  const [imageLoaded, setImageLoaded] = useState(false);
  const [imageError, setImageError] = useState(false);
  const [isLiked, setIsLiked] = useState(false);
  const imageRef = useRef<HTMLImageElement>(null);

  const handleImageLoad = useCallback(() => {
    setImageLoaded(true);
    onImageLoad?.();
  }, [onImageLoad]);

  const handleImageError = useCallback(() => {
    setImageError(true);
    onImageLoad?.();
  }, [onImageLoad]);

  const handleLike = useCallback(() => {
    setIsLiked(prev => !prev);
    onLike(caseItem.id);
  }, [caseItem.id, onLike]);

  const handleClick = useCallback(() => {
    onView(caseItem.id);
  }, [caseItem.id, onView]);

  const formatTime = useCallback((dateString: string) => {
    return formatDistanceToNow(new Date(dateString), {
      addSuffix: true,
      locale: zhCN
    });
  }, []);

  if (loading) {
    return (
      <div className={styles.cardSkeleton}>
        <div className={styles.skeletonImage}></div>
        <div className={styles.skeletonContent}>
          <div className={styles.skeletonTitle}></div>
          <div className={styles.skeletonMeta}></div>
        </div>
      </div>
    );
  }

  return (
    <div 
      className={styles.caseCard}
      onClick={handleClick}
    >
      <div className={styles.imageContainer}>
        {!imageLoaded && !imageError && (
          <div className={styles.imagePlaceholder}>
            <div className={styles.spinner}></div>
          </div>
        )}
        
        {imageError ? (
          <div className={styles.imageError}>
            <span>图片加载失败</span>
          </div>
        ) : (
          <img
            ref={imageRef}
            src={caseItem.previewImageUrl}
            alt={caseItem.title}
            className={`${styles.image} ${imageLoaded ? styles.loaded : ''}`}
            onLoad={handleImageLoad}
            onError={handleImageError}
            loading="lazy"
          />
        )}

        {/* 视频标识 */}
        {caseItem.videoUrl && (
          <div className={styles.videoIndicator}>
            <svg viewBox="0 0 24 24" className={styles.playIcon}>
              <path d="M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18c.62-.39.62-1.29 0-1.68L9.54 5.98C8.87 5.55 8 6.03 8 6.82z"/>
            </svg>
          </div>
        )}

        {/* 热度标识 */}
        {caseItem.hotScore > 50 && (
          <div className={styles.hotBadge}>
            🔥 热门
          </div>
        )}
      </div>

      <div className={styles.content}>
        <h3 className={styles.title}>{caseItem.title}</h3>
        
        {caseItem.description && (
          <p className={styles.description}>
            {caseItem.description}
          </p>
        )}

        <div className={styles.meta}>
          <span className={styles.category}>
            {caseItem.categoryName}
          </span>
          <span className={styles.time}>
            {formatTime(caseItem.createTime)}
          </span>
        </div>

        <div className={styles.actions}>
          <button
            className={`${styles.actionBtn} ${isLiked ? styles.liked : ''}`}
            onClick={(e) => {
              e.stopPropagation();
              handleLike();
            }}
          >
            <svg viewBox="0 0 24 24" className={styles.actionIcon}>
              <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
            <span>{caseItem.likeCount}</span>
          </button>

          <button className={styles.actionBtn}>
            <svg viewBox="0 0 24 24" className={styles.actionIcon}>
              <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
            </svg>
            <span>{caseItem.viewCount}</span>
          </button>
        </div>
      </div>
    </div>
  );
};

export default CaseCard;
```

### 3. 创建案例卡片样式
**文件路径：** `beilv-agent-web/src/components/CaseCard/CaseCard.module.css`

```css
.caseCard {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
  cursor: pointer;
  break-inside: avoid;
  margin-bottom: 20px;
}

.caseCard:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

.imageContainer {
  position: relative;
  width: 100%;
  aspect-ratio: 4/3;
  overflow: hidden;
  background: #f5f5f5;
}

.image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: opacity 0.3s ease, transform 0.3s ease;
  opacity: 0;
}

.image.loaded {
  opacity: 1;
}

.caseCard:hover .image {
  transform: scale(1.05);
}

.imagePlaceholder {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
              linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
              linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
              linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
  background-size: 20px 20px;
  background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
}

.spinner {
  width: 32px;
  height: 32px;
  border: 3px solid #f3f3f3;
  border-top: 3px solid #3498db;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.imageError {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #f8f8f8;
  color: #999;
  font-size: 14px;
}

.videoIndicator {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 48px;
  height: 48px;
  background: rgba(0, 0, 0, 0.7);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.8;
  transition: opacity 0.3s ease;
}

.caseCard:hover .videoIndicator {
  opacity: 1;
}

.playIcon {
  width: 20px;
  height: 20px;
  fill: white;
}

.hotBadge {
  position: absolute;
  top: 8px;
  right: 8px;
  background: linear-gradient(45deg, #ff6b6b, #ff8e53);
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}

.content {
  padding: 16px;
}

.title {
  font-size: 16px;
  font-weight: 600;
  color: #333;
  margin: 0 0 8px 0;
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.description {
  font-size: 14px;
  color: #666;
  margin: 0 0 12px 0;
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  font-size: 12px;
  color: #999;
}

.category {
  background: #f0f0f0;
  padding: 2px 8px;
  border-radius: 4px;
  color: #666;
}

.actions {
  display: flex;
  gap: 16px;
}

.actionBtn {
  display: flex;
  align-items: center;
  gap: 4px;
  background: none;
  border: none;
  color: #666;
  font-size: 12px;
  cursor: pointer;
  transition: color 0.3s ease;
  padding: 4px;
  border-radius: 4px;
}

.actionBtn:hover {
  color: #333;
  background: rgba(0, 0, 0, 0.05);
}

.actionBtn.liked {
  color: #ff6b6b;
}

.actionIcon {
  width: 16px;
  height: 16px;
  fill: currentColor;
}

/* 骨架屏样式 */
.cardSkeleton {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  break-inside: avoid;
  margin-bottom: 20px;
  animation: pulse 1.5s ease-in-out infinite;
}

.skeletonImage {
  width: 100%;
  aspect-ratio: 4/3;
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
}

.skeletonContent {
  padding: 16px;
}

.skeletonTitle {
  height: 20px;
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 4px;
  margin-bottom: 8px;
}

.skeletonMeta {
  height: 12px;
  width: 60%;
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 4px;
}

@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

/* 响应式设计 */
@media (max-width: 768px) {
  .caseCard {
    margin-bottom: 16px;
  }
  
  .content {
    padding: 12px;
  }
  
  .title {
    font-size: 15px;
  }
  
  .description {
    font-size: 13px;
  }
}
```

### 4. 创建案例列表组件
**文件路径：** `beilv-agent-web/src/components/CaseList/CaseList.tsx`

```tsx
import React, { useCallback, useEffect } from 'react';
import { useCases } from '@/hooks/useCases';
import { useInfiniteScroll } from '@/hooks/useInfiniteScroll';
import CaseCard from '../CaseCard/CaseCard';
import styles from './CaseList.module.css';

interface CaseListProps {
  activeCategory: string;
  onCategoryChange: (category: string) => void;
}

const CaseList: React.FC<CaseListProps> = ({
  activeCategory,
  onCategoryChange
}) => {
  const {
    categories,
    cases,
    loading,
    error,
    hasMore,
    isLoadingMore,
    initialize,
    loadCases,
    loadMore,
    handleLike,
    handleView
  } = useCases();

  // 无限滚动
  const { targetRef } = useInfiniteScroll(
    loadMore,
    hasMore,
    isLoadingMore,
    {
      threshold: 200,
      enabled: !loading && !error
    }
  );

  useEffect(() => {
    initialize();
  }, [initialize]);

  useEffect(() => {
    if (categories.length > 0) {
      loadCases(1);
    }
  }, [activeCategory, categories, loadCases]);

  const handleRetry = useCallback(() => {
    loadCases(1);
  }, [loadCases]);

  const renderSkeletonCards = () => (
    <>
      {Array.from({ length: 6 }, (_, index) => (
        <CaseCard
          key={`skeleton-${index}`}
          case={{} as any}
          onLike={() => {}}
          onView={() => {}}
          loading={true}
        />
      ))}
    </>
  );

  const renderErrorState = () => (
    <div className={styles.errorState}>
      <div className={styles.errorIcon}>⚠️</div>
      <h3>加载失败</h3>
      <p>{error}</p>
      <button 
        className={styles.retryBtn}
        onClick={handleRetry}
      >
        重新加载
      </button>
    </div>
  );

  const renderEmptyState = () => (
    <div className={styles.emptyState}>
      <div className={styles.emptyIcon}>📋</div>
      <h3>暂无案例</h3>
      <p>当前分类下还没有案例，请尝试其他分类</p>
    </div>
  );

  const renderLoadMoreButton = () => {
    if (!hasMore) {
      return (
        <div className={styles.endMessage}>
          <span>已显示全部内容</span>
        </div>
      );
    }

    return (
      <div className={styles.loadMoreContainer}>
        {isLoadingMore ? (
          <div className={styles.loadingMore}>
            <div className={styles.spinner}></div>
            <span>加载中...</span>
          </div>
        ) : (
          <button 
            className={styles.loadMoreBtn}
            onClick={loadMore}
            disabled={loading}
          >
            加载更多
          </button>
        )}
      </div>
    );
  };

  if (loading && cases.length === 0) {
    return (
      <div className={styles.caseList}>
        {renderSkeletonCards()}
      </div>
    );
  }

  if (error && cases.length === 0) {
    return renderErrorState();
  }

  if (!loading && cases.length === 0) {
    return renderEmptyState();
  }

  return (
    <div className={styles.container}>
      <div className={styles.caseList}>
        {cases.map((caseItem, index) => (
          <CaseCard
            key={`${caseItem.id}-${index}`}
            case={caseItem}
            onLike={handleLike}
            onView={handleView}
          />
        ))}
      </div>

      {/* 加载更多 */}
      {renderLoadMoreButton()}

      {/* 无限滚动触发元素 */}
      <div 
        ref={targetRef} 
        className={styles.scrollTrigger}
        style={{ height: '20px' }}
      />
    </div>
  );
};

export default CaseList;
```

### 5. 创建案例列表样式
**文件路径：** `beilv-agent-web/src/components/CaseList/CaseList.module.css`

```css
.container {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}

.caseList {
  columns: 1;
  column-gap: 20px;
  margin-bottom: 40px;
}

/* 响应式瀑布流布局 */
@media (min-width: 768px) {
  .caseList {
    columns: 2;
  }
}

@media (min-width: 1024px) {
  .caseList {
    columns: 3;
  }
}

@media (min-width: 1440px) {
  .caseList {
    columns: 4;
  }
}

.errorState,
.emptyState {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  text-align: center;
  color: #666;
}

.errorIcon,
.emptyIcon {
  font-size: 48px;
  margin-bottom: 16px;
}

.errorState h3,
.emptyState h3 {
  font-size: 20px;
  font-weight: 600;
  color: #333;
  margin: 0 0 8px 0;
}

.errorState p,
.emptyState p {
  font-size: 14px;
  color: #999;
  margin: 0 0 24px 0;
  max-width: 400px;
  line-height: 1.5;
}

.retryBtn {
  padding: 12px 24px;
  background: #3498db;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s ease;
}

.retryBtn:hover {
  background: #2980b9;
}

.loadMoreContainer {
  display: flex;
  justify-content: center;
  padding: 40px 20px;
}

.loadMoreBtn {
  padding: 12px 32px;
  background: white;
  color: #333;
  border: 2px solid #e0e0e0;
  border-radius: 25px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.loadMoreBtn:hover {
  border-color: #3498db;
  color: #3498db;
  transform: translateY(-1px);
}

.loadMoreBtn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.loadingMore {
  display: flex;
  align-items: center;
  gap: 12px;
  color: #666;
  font-size: 14px;
}

.spinner {
  width: 20px;
  height: 20px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid #3498db;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.endMessage {
  text-align: center;
  padding: 20px;
  color: #999;
  font-size: 14px;
}

.scrollTrigger {
  visibility: hidden;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* 移动端优化 */
@media (max-width: 768px) {
  .container {
    padding: 0 16px;
  }
  
  .caseList {
    column-gap: 16px;
    margin-bottom: 32px;
  }
  
  .loadMoreContainer {
    padding: 32px 16px;
  }
}
```

## 验证步骤
1. 测试懒加载组件的基本功能
2. 验证无限滚动触发机制
3. 测试不同屏幕尺寸下的响应式布局
4. 验证骨架屏加载效果
5. 测试错误状态和重试功能
6. 验证图片懒加载功能
7. 测试滚动性能和内存使用
8. 验证分类切换时的状态重置

## 功能特性
1. **无限滚动**：IntersectionObserver + scroll事件双重保障
2. **响应式瀑布流**：CSS columns自适应布局
3. **骨架屏加载**：优化首屏加载体验
4. **图片懒加载**：节省带宽和提升性能
5. **错误处理**：完善的错误状态和重试机制
6. **性能优化**：防抖、节流、虚拟化等技术
7. **用户体验**：平滑动画、加载状态、空状态等

## 性能优化
1. **防抖滚动**：避免频繁触发加载
2. **图片懒加载**：按需加载图片资源
3. **组件重用**：减少不必要的重新渲染
4. **内存管理**：及时清理事件监听器

## 输出物
- useInfiniteScroll 无限滚动Hook
- CaseCard 案例卡片组件
- CaseList 案例列表组件
- 完整的懒加载功能实现
- 响应式瀑布流布局

## 后续任务
- 下一步：15-无限滚动功能.md