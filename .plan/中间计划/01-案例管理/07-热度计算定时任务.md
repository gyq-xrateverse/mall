# 07-热度计算定时任务

## 任务概述
创建定时任务，定期计算并更新案例的热度分数，同时更新相关的Redis缓存。

## 前置条件
- 案例数据管理API已完成
- Redis缓存配置可用
- Spring Task调度器已配置

## 实施步骤

### 1. 创建热度计算服务
**文件路径：** `mall-admin/src/main/java/com/macro/mall/service/CaseHotScoreService.java`

```java
package com.macro.mall.service;

/**
 * 案例热度分数计算服务
 */
public interface CaseHotScoreService {
    
    /**
     * 批量更新所有案例的热度分数
     */
    int batchUpdateAllHotScore();
    
    /**
     * 更新指定案例的热度分数
     */
    int updateCaseHotScore(Long caseId);
    
    /**
     * 更新热门案例缓存
     */
    void refreshHotCasesCache();
    
    /**
     * 清理过期的点赞记录
     */
    int cleanExpiredLikes();
}
```

### 2. 实现热度计算服务
**文件路径：** `mall-admin/src/main/java/com/macro/mall/service/impl/CaseHotScoreServiceImpl.java`

```java
package com.macro.mall.service.impl;

import com.macro.mall.mapper.CaseDataMapper;
import com.macro.mall.model.CaseData;
import com.macro.mall.model.CaseDataExample;
import com.macro.mall.service.CaseHotScoreService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.util.Date;
import java.util.List;
import java.util.Set;
import java.util.concurrent.TimeUnit;

@Service
public class CaseHotScoreServiceImpl implements CaseHotScoreService {
    
    private static final Logger LOGGER = LoggerFactory.getLogger(CaseHotScoreServiceImpl.class);
    
    @Autowired
    private CaseDataMapper caseDataMapper;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final String REDIS_PREFIX = "mall:case:";
    private static final String HOT_LIST_KEY = REDIS_PREFIX + "hot:list";
    private static final String LATEST_LIST_KEY = REDIS_PREFIX + "latest:list";
    private static final String ALL_LIST_KEY = REDIS_PREFIX + "all:list";
    
    @Override
    public int batchUpdateAllHotScore() {
        LOGGER.info("开始批量更新案例热度分数");
        
        // 查询所有启用的案例
        CaseDataExample example = new CaseDataExample();
        example.createCriteria()
                .andStatusEqualTo(1)
                .andShowStatusEqualTo(1)
                .andDeleteStatusEqualTo(0);
        
        List<CaseData> caseList = caseDataMapper.selectByExample(example);
        
        int updateCount = 0;
        for (CaseData caseData : caseList) {
            try {
                // 计算新的热度分数
                BigDecimal newHotScore = calculateHotScore(caseData);
                
                // 更新数据库
                CaseData updateRecord = new CaseData();
                updateRecord.setId(caseData.getId());
                updateRecord.setHotScore(newHotScore);
                updateRecord.setHotUpdateTime(new Date());
                
                if (caseDataMapper.updateByPrimaryKeySelective(updateRecord) > 0) {
                    updateCount++;
                }
                
            } catch (Exception e) {
                LOGGER.error("更新案例热度分数失败，案例ID: {}", caseData.getId(), e);
            }
        }
        
        // 刷新热门案例缓存
        refreshHotCasesCache();
        
        LOGGER.info("批量更新案例热度分数完成，共更新 {} 个案例", updateCount);
        return updateCount;
    }
    
    @Override
    public int updateCaseHotScore(Long caseId) {
        CaseData caseData = caseDataMapper.selectByPrimaryKey(caseId);
        if (caseData == null) {
            return 0;
        }
        
        BigDecimal newHotScore = calculateHotScore(caseData);
        
        CaseData updateRecord = new CaseData();
        updateRecord.setId(caseId);
        updateRecord.setHotScore(newHotScore);
        updateRecord.setHotUpdateTime(new Date());
        
        int result = caseDataMapper.updateByPrimaryKeySelective(updateRecord);
        
        if (result > 0) {
            // 清除相关缓存
            clearRelatedCache();
        }
        
        return result;
    }
    
    @Override
    public void refreshHotCasesCache() {
        try {
            LOGGER.info("开始刷新热门案例缓存");
            
            // 查询热门案例（按热度分数排序，取前30个）
            CaseDataExample hotExample = new CaseDataExample();
            hotExample.createCriteria()
                    .andStatusEqualTo(1)
                    .andShowStatusEqualTo(1)
                    .andDeleteStatusEqualTo(0);
            hotExample.setOrderByClause("hot_score DESC, create_time DESC LIMIT 30");
            
            List<CaseData> hotCases = caseDataMapper.selectByExample(hotExample);
            
            // 查询最新案例（按创建时间排序，取前30个）
            CaseDataExample latestExample = new CaseDataExample();
            latestExample.createCriteria()
                    .andStatusEqualTo(1)
                    .andShowStatusEqualTo(1)
                    .andDeleteStatusEqualTo(0);
            latestExample.setOrderByClause("create_time DESC LIMIT 30");
            
            List<CaseData> latestCases = caseDataMapper.selectByExample(latestExample);
            
            // 查询全部案例（按排序字段，取前30个）
            CaseDataExample allExample = new CaseDataExample();
            allExample.createCriteria()
                    .andStatusEqualTo(1)
                    .andShowStatusEqualTo(1)
                    .andDeleteStatusEqualTo(0);
            allExample.setOrderByClause("sort ASC, create_time DESC LIMIT 30");
            
            List<CaseData> allCases = caseDataMapper.selectByExample(allExample);
            
            // 更新缓存（缓存30分钟）
            redisTemplate.opsForValue().set(HOT_LIST_KEY, hotCases, 30, TimeUnit.MINUTES);
            redisTemplate.opsForValue().set(LATEST_LIST_KEY, latestCases, 30, TimeUnit.MINUTES);
            redisTemplate.opsForValue().set(ALL_LIST_KEY, allCases, 30, TimeUnit.MINUTES);
            
            // 刷新各分类的热门案例缓存
            refreshCategoryHotCache();
            
            LOGGER.info("刷新热门案例缓存完成");
            
        } catch (Exception e) {
            LOGGER.error("刷新热门案例缓存失败", e);
        }
    }
    
    @Override
    public int cleanExpiredLikes() {
        try {
            LOGGER.info("开始清理过期的点赞记录");
            
            String pattern = "mall:case:like:*";
            Set<String> keys = redisTemplate.keys(pattern);
            
            int cleanCount = 0;
            if (keys != null && !keys.isEmpty()) {
                for (String key : keys) {
                    Long expire = redisTemplate.getExpire(key);
                    if (expire != null && expire <= 0) {
                        redisTemplate.delete(key);
                        cleanCount++;
                    }
                }
            }
            
            LOGGER.info("清理过期点赞记录完成，共清理 {} 条记录", cleanCount);
            return cleanCount;
            
        } catch (Exception e) {
            LOGGER.error("清理过期点赞记录失败", e);
            return 0;
        }
    }
    
    /**
     * 计算案例热度分数
     */
    private BigDecimal calculateHotScore(CaseData caseData) {
        int likeCount = caseData.getLikeCount() != null ? caseData.getLikeCount() : 0;
        int viewCount = caseData.getViewCount() != null ? caseData.getViewCount() : 0;
        Date createTime = caseData.getCreateTime();
        
        // 基础热度 = 点赞数 * 0.7 + 浏览数 * 0.3
        double baseScore = likeCount * 0.7 + viewCount * 0.3;
        
        // 时间衰减因子：每7天衰减50%
        double timeDecayFactor = 1.0;
        if (createTime != null) {
            long daysSinceCreated = (System.currentTimeMillis() - createTime.getTime()) / (24 * 60 * 60 * 1000);
            timeDecayFactor = Math.pow(0.5, daysSinceCreated / 7.0);
            
            // 设置最小衰减因子，避免过度衰减
            timeDecayFactor = Math.max(timeDecayFactor, 0.1);
        }
        
        // 最终热度分数
        double finalScore = baseScore * timeDecayFactor;
        
        return BigDecimal.valueOf(finalScore).setScale(2, BigDecimal.ROUND_HALF_UP);
    }
    
    /**
     * 刷新各分类的热门案例缓存
     */
    private void refreshCategoryHotCache() {
        // 获取所有分类
        // 这里简化处理，实际可以查询分类表
        List<Long> categoryIds = List.of(1L, 2L, 3L, 4L, 5L, 6L, 7L);
        
        for (Long categoryId : categoryIds) {
            try {
                CaseDataExample example = new CaseDataExample();
                example.createCriteria()
                        .andCategoryIdEqualTo(categoryId)
                        .andStatusEqualTo(1)
                        .andShowStatusEqualTo(1)
                        .andDeleteStatusEqualTo(0);
                example.setOrderByClause("hot_score DESC, create_time DESC LIMIT 30");
                
                List<CaseData> categoryCases = caseDataMapper.selectByExample(example);
                String cacheKey = REDIS_PREFIX + "category:" + categoryId + ":list";
                
                redisTemplate.opsForValue().set(cacheKey, categoryCases, 30, TimeUnit.MINUTES);
                
            } catch (Exception e) {
                LOGGER.error("刷新分类 {} 的热门案例缓存失败", categoryId, e);
            }
        }
    }
    
    /**
     * 清除相关缓存
     */
    private void clearRelatedCache() {
        try {
            // 清除列表缓存
            Set<String> keys = redisTemplate.keys(REDIS_PREFIX + "*:page:1");
            if (keys != null && !keys.isEmpty()) {
                redisTemplate.delete(keys);
            }
            
            // 清除分类缓存
            redisTemplate.delete(REDIS_PREFIX + "categories:all");
            
        } catch (Exception e) {
            LOGGER.error("清除相关缓存失败", e);
        }
    }
}
```

### 3. 创建定时任务配置
**文件路径：** `mall-admin/src/main/java/com/macro/mall/config/ScheduleConfig.java`

```java
package com.macro.mall.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.annotation.EnableScheduling;

/**
 * 定时任务配置
 */
@Configuration
@EnableScheduling
public class ScheduleConfig {
}
```

### 4. 创建定时任务
**文件路径：** `mall-admin/src/main/java/com/macro/mall/task/CaseHotScoreTask.java`

```java
package com.macro.mall.task;

import com.macro.mall.service.CaseHotScoreService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

/**
 * 案例热度分数计算定时任务
 */
@Component
public class CaseHotScoreTask {
    
    private static final Logger LOGGER = LoggerFactory.getLogger(CaseHotScoreTask.class);
    
    @Autowired
    private CaseHotScoreService caseHotScoreService;
    
    /**
     * 每小时更新一次热度分数
     */
    @Scheduled(cron = "0 0 * * * ?")
    public void updateHotScore() {
        LOGGER.info("开始执行热度分数更新定时任务");
        try {
            int updateCount = caseHotScoreService.batchUpdateAllHotScore();
            LOGGER.info("热度分数更新定时任务完成，更新了 {} 个案例", updateCount);
        } catch (Exception e) {
            LOGGER.error("热度分数更新定时任务执行失败", e);
        }
    }
    
    /**
     * 每30分钟刷新一次热门案例缓存
     */
    @Scheduled(cron = "0 */30 * * * ?")
    public void refreshHotCache() {
        LOGGER.info("开始执行热门案例缓存刷新任务");
        try {
            caseHotScoreService.refreshHotCasesCache();
            LOGGER.info("热门案例缓存刷新任务完成");
        } catch (Exception e) {
            LOGGER.error("热门案例缓存刷新任务执行失败", e);
        }
    }
    
    /**
     * 每天凌晨2点清理过期点赞记录
     */
    @Scheduled(cron = "0 0 2 * * ?")
    public void cleanExpiredLikes() {
        LOGGER.info("开始执行过期点赞记录清理任务");
        try {
            int cleanCount = caseHotScoreService.cleanExpiredLikes();
            LOGGER.info("过期点赞记录清理任务完成，清理了 {} 条记录", cleanCount);
        } catch (Exception e) {
            LOGGER.error("过期点赞记录清理任务执行失败", e);
        }
    }
    
    /**
     * 系统启动后5分钟执行一次初始化缓存
     */
    @Scheduled(initialDelay = 300000, fixedDelay = Long.MAX_VALUE)
    public void initCache() {
        LOGGER.info("开始执行初始化缓存任务");
        try {
            caseHotScoreService.refreshHotCasesCache();
            LOGGER.info("初始化缓存任务完成");
        } catch (Exception e) {
            LOGGER.error("初始化缓存任务执行失败", e);
        }
    }
}
```

### 5. 添加手动触发接口
**文件路径：** 在`CaseDataController`中添加手动触发方法

```java
@Operation(summary = "手动刷新热度分数")
@PostMapping("/refreshHotScore")
public CommonResult refreshHotScore() {
    int count = caseHotScoreService.batchUpdateAllHotScore();
    return CommonResult.success("热度分数刷新完成，更新了 " + count + " 个案例");
}

@Operation(summary = "手动刷新热门缓存")
@PostMapping("/refreshHotCache")
public CommonResult refreshHotCache() {
    caseHotScoreService.refreshHotCasesCache();
    return CommonResult.success("热门缓存刷新完成");
}
```

### 6. 配置应用属性
**文件路径：** `mall-admin/src/main/resources/application.yml`

```yaml
# 定时任务相关配置
spring:
  task:
    scheduling:
      pool:
        size: 10
      thread-name-prefix: "case-task-"
      shutdown:
        await-termination: true
        await-termination-period: 60s
```

## 验证步骤
1. 启动mall-admin应用
2. 检查定时任务是否正常注册
3. 手动调用接口测试热度计算
4. 观察定时任务执行日志
5. 验证Redis缓存是否正常更新

## 定时任务说明
| 任务名称 | 执行时间 | 功能描述 |
|---------|---------|---------|
| updateHotScore | 每小时整点 | 更新所有案例的热度分数 |
| refreshHotCache | 每30分钟 | 刷新热门案例缓存 |
| cleanExpiredLikes | 每天凌晨2点 | 清理过期的点赞记录 |
| initCache | 启动后5分钟 | 初始化缓存数据 |

## 热度计算公式
```
基础分数 = 点赞数 × 0.7 + 浏览数 × 0.3
时间衰减因子 = 0.5^(天数/7)  （最小值0.1）
最终热度 = 基础分数 × 时间衰减因子
```

## 输出物
- CaseHotScoreService热度计算服务
- CaseHotScoreTask定时任务
- ScheduleConfig定时任务配置
- 手动触发接口
- 完整的缓存刷新机制

## 后续任务
- 下一步：08-Redis缓存集成.md