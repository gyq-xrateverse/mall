# 案例管理功能实现总体计划

## 一、项目架构概述

基于分析，此商城系统采用前后端分离架构：
- **后端**：Spring Boot + MyBatis Plus + Redis + MySQL
- **前端**：Vue 2.x (管理后台) + React (用户端)
- **文件存储**：MinIO对象存储
- **权限控制**：Spring Security + JWT

## 二、数据库设计

### 2.1 实体类存放策略
- **遵循现有架构**：案例相关实体类直接添加到现有的 `mall-mbg` 模块中
- **与商品实体类统一管理**：保持与 PmsProduct 等实体类相同的组织方式
- **利用现有工具链**：使用 MyBatis Generator 自动生成 Entity、Mapper、Example 类

### 2.2 数据库表结构
```sql
-- 1. 案例分类表
CREATE TABLE `case_category` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '分类ID',
  `name` varchar(100) NOT NULL COMMENT '分类名称',
  `sort` int(11) DEFAULT '0' COMMENT '排序字段',
  `status` int(1) DEFAULT '1' COMMENT '状态：0->禁用；1->启用',
  `show_status` int(1) DEFAULT '1' COMMENT '显示状态：0->不显示；1->显示',
  `delete_status` int(1) DEFAULT '0' COMMENT '删除状态：0->未删除；1->已删除',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `modify_time` datetime DEFAULT NULL COMMENT '修改时间',
  `create_by` varchar(100) DEFAULT NULL COMMENT '创建人',
  `modify_by` varchar(100) DEFAULT NULL COMMENT '修改人',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC COMMENT='案例分类表';

-- 2. 案例数据表
CREATE TABLE `case_data` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '案例ID',
  `category_id` bigint(20) NOT NULL COMMENT '分类类型ID',
  `title` varchar(200) NOT NULL COMMENT '案例标题',
  `description` text COMMENT '案例描述',
  `preview_image_url` varchar(500) DEFAULT NULL COMMENT '预览图URL',
  `video_url` varchar(500) DEFAULT NULL COMMENT '视频URL',
  `video_preview_url` varchar(500) DEFAULT NULL COMMENT '视频预览地址',
  `like_count` int(11) DEFAULT '0' COMMENT '点赞数',
  `view_count` int(11) DEFAULT '0' COMMENT '预览次数',
  `hot_score` decimal(10,2) DEFAULT '0' COMMENT '热度分数',
  `hot_update_time` datetime DEFAULT NULL COMMENT '热度更新时间',
  `sort` int(11) DEFAULT '0' COMMENT '排序字段',
  `status` int(1) DEFAULT '1' COMMENT '状态：0->禁用；1->启用',
  `show_status` int(1) DEFAULT '1' COMMENT '显示状态：0->不显示；1->显示',
  `delete_status` int(1) DEFAULT '0' COMMENT '删除状态：0->未删除；1->已删除',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `modify_time` datetime DEFAULT NULL COMMENT '修改时间',
  `create_by` varchar(100) DEFAULT NULL COMMENT '创建人',
  `modify_by` varchar(100) DEFAULT NULL COMMENT '修改人',
  PRIMARY KEY (`id`) USING BTREE,
  KEY `idx_category_id` (`category_id`) USING BTREE,
  KEY `idx_status` (`status`) USING BTREE,
  KEY `idx_hot_score` (`hot_score` DESC) USING BTREE COMMENT '热度排序索引',
  KEY `idx_create_time` (`create_time` DESC) USING BTREE COMMENT '最新排序索引'
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC COMMENT='案例数据表';
```

## 三、后端实现方案

### 3.1 实体类和数据访问层结构
```
mall-mbg/src/main/java/com/macro/mall/
├── model/
│   ├── CaseCategory.java        # 案例分类实体类
│   ├── CaseCategoryExample.java # MyBatis查询条件类
│   ├── CaseData.java            # 案例数据实体类
│   └── CaseDataExample.java     # MyBatis查询条件类
└── mapper/
    ├── CaseCategoryMapper.java   # 分类数据访问接口
    ├── CaseCategoryMapper.xml    # 分类SQL映射文件
    ├── CaseDataMapper.java       # 案例数据访问接口
    └── CaseDataMapper.xml        # 案例SQL映射文件
```

### 3.2 mall-admin 案例管理模块
```
mall-admin/src/main/java/com/macro/mall/
├── controller/
│   ├── CaseCategoryController.java  # 分类管理API
│   └── CaseDataController.java      # 案例数据管理API
├── service/
│   ├── CaseCategoryService.java
│   ├── impl/CaseCategoryServiceImpl.java
│   ├── CaseDataService.java
│   └── impl/CaseDataServiceImpl.java
└── dto/
    ├── CaseCategoryParam.java       # 分类参数DTO
    ├── CaseDataParam.java           # 案例参数DTO
    └── CaseDataResult.java          # 案例结果DTO
```

### 3.3 mall-portal 用户端模块
```
mall-portal/src/main/java/com/macro/mall/portal/
├── controller/
│   └── CaseController.java  # 用户端案例查询API
└── service/
    ├── CaseService.java
    └── impl/CaseServiceImpl.java
```

### 3.4 Redis 缓存策略

**分类缓存设计**：
```
前端分类结构：[全部] [最新] [热门] [服装] [模特] [餐饮] [建筑] [艺术] [科技] [自然]
│         │      │      │                                    │
虚拟分类    虚拟分类  虚拟分类        真实业务分类（数据库）
```

**对应缓存键**：
- **分类缓存**：`mall:case:category:list` (只包含真实业务分类)
- **虚拟分类缓存**：
  - `mall:case:all:list` (全部分类，前30条)
  - `mall:case:latest:list` (最新分类，按create_time排序，前30条)
  - `mall:case:hot:list` (热门分类，按hot_score排序，前30条)
- **真实分类缓存**：`mall:case:category:{categoryId}:list` (每分类前30条)
- **案例详情缓存**：`mall:case:detail:{caseId}`
- **统计缓存**：`mall:case:count:total` 和 `mall:case:count:category:{categoryId}`
- **分布式锁**：`mall:case:lock:{operation}:{id}`

**缓存说明**：
- 不缓存分页数据，避免缓存碎片化
- 只缓存热点数据，提高缓存命中率
- 用户浏览使用懒加载+滚动分页，实时查询数据库

## 四、管理后台前端实现

### 4.1 路由配置 (mall-admin-web)
```javascript
// router/index.js 新增案例管理路由
{
  path: '/case',
  component: Layout,
  redirect: '/case/category',
  name: 'case',
  meta: {title: '案例管理', icon: 'case'},
  children: [
    {
      path: 'category',
      name: 'caseCategory', 
      component: () => import('@/views/case/category/index'),
      meta: {title: '案例类型', icon: 'case-category'}
    },
    {
      path: 'data',
      name: 'caseData',
      component: () => import('@/views/case/data/index'), 
      meta: {title: '案例数据', icon: 'case-data'}
    }
  ]
}
```

### 4.2 页面组件结构
```
src/views/case/
├── category/
│   ├── index.vue          # 分类列表管理
│   ├── add.vue           # 添加分类
│   └── update.vue        # 编辑分类
├── data/
│   ├── index.vue          # 案例数据列表
│   ├── add.vue           # 添加案例
│   └── update.vue        # 编辑案例
└── components/
    ├── CategorySelect.vue  # 分类选择器
    ├── FileUpload.vue     # 文件上传组件
    └── CasePreview.vue    # 案例预览组件
```

## 五、用户前端实现

### 5.1 用户端接口调用 (beilv-agent-web)
- 修改现有 Redux store 中的 ai slice
- 替换写死的 galleryData 为真实API调用
- **实现懒加载和无限滚动**：
  - 初始加载前20条案例
  - 滚动到底部时自动加载下一页
  - 支持按分类筛选的懒加载
- **优化用户体验**：
  - 加载状态指示器
  - 骨架屏加载效果
  - 图片懒加载优化

### 5.2 API 集成方案
```typescript
// src/api/cases.ts
export interface CaseData {
  id: number;
  categoryId: number;
  title: string;
  description: string;
  previewImageUrl: string;
  videoUrl: string;
  videoPreviewUrl: string;
  likeCount: number;
  viewCount: number;
  hotScore: number;
}

export interface CaseCategory {
  id: number;
  name: string;
  type: 'all' | 'latest' | 'hot' | 'category';
}

export interface CaseListParams {
  categoryType: 'all' | 'latest' | 'hot' | 'category';
  categoryId?: number;  // categoryType为'category'时需要
  page: number;
  size: number;
}

export interface CaseListResponse {
  list: CaseData[];
  total: number;
  hasMore: boolean;
  currentPage: number;
}

export const casesApi = {
  // 获取分类列表（只返回真实业务分类）
  getCategories: () => request.get<CaseCategory[]>('/case/categories'),
  
  // 获取前端显示的完整分类列表（包含虚拟分类）
  getAllCategories: () => request.get<CaseCategory[]>('/case/categories/all'),
  
  // 根据分类类型获取案例列表（支持懒加载）
  getCaseList: (params: CaseListParams) => request.get<CaseListResponse>('/case/list', { params }),
  
  // 案例详情
  getCaseDetail: (id: number) => request.get(`/case/detail/${id}`),
  
  // 增加浏览量
  incrementView: (id: number) => request.post(`/case/view/${id}`),
  
  // 点赞/取消点赞
  toggleLike: (id: number) => request.post(`/case/like/${id}`)
};
```

## 六、实施步骤

### 阶段一：基础架构搭建
1. 设计并创建数据库表结构
2. 在 mall-mbg 中生成案例相关实体类和Mapper
3. 在各业务模块中创建相应的DTO类
4. 无需额外依赖配置（复用现有mall-mbg依赖）

### 阶段二：后端API开发
1. 实现 mall-admin 中的案例管理API
2. 实现 mall-portal 中的案例查询API
3. 集成Redis缓存和分布式锁
4. 编写单元测试

### 阶段三：管理后台前端开发
1. 添加案例管理菜单到路由配置
2. 实现案例分类管理页面
3. 实现案例数据管理页面
4. 集成文件上传功能（MinIO）

### 阶段四：用户前端集成
1. 重构现有首页案例展示逻辑
2. 替换写死数据为真实API调用
3. **实现懒加载和无限滚动**：
   - 首屏加载优化（前20条数据）
   - 滚动监听和自动分页加载
   - 加载状态和骨架屏
4. **实现动态分类筛选**：
   - 分类切换时重新初始化懒加载
   - 保持滚动位置和加载状态
5. **用户体验优化**：
   - 图片懒加载和预加载
   - 平滑滚动和加载动画
   - 错误状态处理

### 阶段五：测试和优化
1. 功能测试和集成测试
2. 性能优化（缓存策略调整）
3. 用户体验优化
4. 部署和上线

## 七、技术要点

1. **架构一致性**：通过 mall-mbg 模块实现实体类统一管理，与现有商品等实体类保持一致
2. **缓存策略**：Redis 多层缓存 + 分布式锁保证数据一致性
3. **热度算法**：使用独立的hot_score字段和索引，定时任务更新热度分数
3. **文件管理**：集成现有 MinIO 文件上传功能
4. **权限控制**：复用现有权限体系
5. **API规范**：遵循现有 CommonResult 响应格式
6. **前端集成**：最小化改动现有首页代码

此方案完全基于现有架构，最大化代码复用，确保系统一致性和可维护性。

## 八、开发任务列表

### 阶段一任务
- [x] 创建开发计划文档
- [ ] 设计并创建数据库表结构
- [ ] 在mall-mbg中生成案例实体类和Mapper
- [ ] 在各业务模块创建DTO类

### 阶段二任务
- [ ] 实现mall-admin案例管理API
- [ ] 实现mall-portal案例查询API
- [ ] 添加Redis缓存和分布式锁

### 阶段三任务
- [ ] 添加案例管理菜单到管理后台
- [ ] 实现案例分类管理页面
- [ ] 实现案例数据管理页面

### 阶段四任务
- [ ] 重构Redux store和API集成
- [ ] 实现案例列表懒加载组件
- [ ] 实现无限滚动分页功能
- [ ] 优化图片加载和用户体验
- [ ] 集成分类筛选和排序功能

### 阶段五任务
- [ ] 集成测试和优化

## 九、注意事项

1. **数据库字段设计**：严格遵循现有系统的字段命名规范和数据类型
2. **API接口规范**：使用CommonResult统一响应格式，支持分页查询
3. **权限控制**：案例管理功能需要集成到现有的权限体系中
4. **文件上传**：利用现有MinIO集成，确保文件URL的正确生成和访问
5. **缓存一致性**：使用Redis分布式锁确保缓存与数据库数据一致性
6. **数据库优化**：为热度排序和时间排序建立专门索引，提高查询性能
6. **前端集成**：最小化对现有用户前端代码的修改，保持向后兼容

## 十、风险评估

1. **数据迁移风险**：现有写死数据需要平滑迁移到数据库
2. **性能风险**：案例数据量大时的查询性能优化
3. **兼容性风险**：确保新功能不影响现有业务逻辑
4. **用户体验风险**：API切换过程中的用户体验保证