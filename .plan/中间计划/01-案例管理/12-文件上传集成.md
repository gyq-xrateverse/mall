# 12-文件上传集成

## 任务概述
集成MinIO文件上传功能到案例管理页面，支持图片和视频文件的上传、预览、删除等操作。

## 前置条件
- MinIO服务已配置并运行
- 后端文件上传API已完成
- 管理后台项目正常运行

## 实施步骤

### 1. 创建单文件上传组件
**文件路径：** `mall-admin-web/src/components/Upload/singleUpload.vue`

```vue
<template>
  <div>
    <el-upload
      :action="uploadUrl"
      :headers="headers"
      :show-file-list="false"
      :on-success="handleUploadSuccess"
      :on-error="handleUploadError"
      :before-upload="beforeUpload"
      :accept="acceptType"
      class="upload-container">
      <el-button size="small" type="primary" :loading="uploadLoading">
        <i class="el-icon-upload"></i> {{ uploadText }}
      </el-button>
    </el-upload>
    
    <!-- 文件预览 -->
    <div v-if="value" class="file-preview">
      <div v-if="isImage" class="image-preview">
        <el-image
          :src="value"
          fit="cover"
          style="width: 150px; height: 100px; border-radius: 4px;"
          :preview-src-list="[value]">
        </el-image>
      </div>
      <div v-else-if="isVideo" class="video-preview">
        <video
          :src="value"
          style="width: 150px; height: 100px; object-fit: cover;"
          controls>
        </video>
      </div>
      <div v-else class="file-info">
        <i class="el-icon-document"></i>
        <span>{{ fileName }}</span>
      </div>
      
      <div class="file-actions">
        <el-button 
          type="text" 
          size="small" 
          @click="handlePreview"
          v-if="value">
          预览
        </el-button>
        <el-button 
          type="text" 
          size="small" 
          @click="handleDelete"
          style="color: #f56c6c;">
          删除
        </el-button>
      </div>
    </div>
  </div>
</template>

<script>
import { getToken } from '@/utils/auth'

export default {
  name: 'SingleUpload',
  props: {
    value: {
      type: String,
      default: ''
    },
    fileType: {
      type: String,
      default: 'image', // image, video, file
      validator: value => ['image', 'video', 'file'].includes(value)
    },
    maxSize: {
      type: Number,
      default: 10 // MB
    }
  },
  data() {
    return {
      uploadLoading: false,
      headers: {
        'Authorization': 'Bearer ' + getToken()
      }
    }
  },
  computed: {
    uploadUrl() {
      return process.env.VUE_APP_BASE_API + '/minio/upload'
    },
    uploadText() {
      const textMap = {
        image: '上传图片',
        video: '上传视频',
        file: '上传文件'
      }
      return textMap[this.fileType] || '上传文件'
    },
    acceptType() {
      const acceptMap = {
        image: 'image/*',
        video: 'video/*',
        file: '*/*'
      }
      return acceptMap[this.fileType]
    },
    isImage() {
      return this.fileType === 'image' && this.value
    },
    isVideo() {
      return this.fileType === 'video' && this.value
    },
    fileName() {
      if (!this.value) return ''
      return this.value.split('/').pop()
    }
  },
  methods: {
    beforeUpload(file) {
      // 文件类型检查
      const isValidType = this.checkFileType(file)
      if (!isValidType) {
        this.$message.error(`请上传正确的${this.fileType === 'image' ? '图片' : '视频'}格式文件！`)
        return false
      }
      
      // 文件大小检查
      const isValidSize = file.size / 1024 / 1024 < this.maxSize
      if (!isValidSize) {
        this.$message.error(`文件大小不能超过 ${this.maxSize}MB!`)
        return false
      }
      
      this.uploadLoading = true
      return true
    },
    checkFileType(file) {
      const imageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']
      const videoTypes = ['video/mp4', 'video/avi', 'video/mov', 'video/wmv']
      
      switch (this.fileType) {
        case 'image':
          return imageTypes.includes(file.type)
        case 'video':
          return videoTypes.includes(file.type)
        case 'file':
          return true
        default:
          return false
      }
    },
    handleUploadSuccess(response) {
      this.uploadLoading = false
      if (response.code === 200) {
        this.$emit('input', response.data.url)
        this.$emit('success', response.data)
        this.$message.success('上传成功！')
      } else {
        this.$message.error(response.message || '上传失败')
      }
    },
    handleUploadError(error) {
      this.uploadLoading = false
      this.$message.error('上传失败：' + error.message)
    },
    handlePreview() {
      if (this.isImage) {
        // 图片预览
        const img = new Image()
        img.src = this.value
        const imgWindow = window.open()
        imgWindow.document.write(img.outerHTML)
      } else if (this.isVideo) {
        // 视频预览
        window.open(this.value, '_blank')
      } else {
        // 文件下载
        const link = document.createElement('a')
        link.href = this.value
        link.download = this.fileName
        link.click()
      }
    },
    handleDelete() {
      this.$confirm('确定要删除该文件吗？', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        this.$emit('input', '')
        this.$emit('delete')
        this.$message.success('删除成功！')
      })
    }
  }
}
</script>

<style scoped>
.upload-container {
  display: inline-block;
}

.file-preview {
  margin-top: 10px;
  padding: 10px;
  border: 1px solid #dcdfe6;
  border-radius: 4px;
  background-color: #fafafa;
}

.image-preview, .video-preview {
  margin-bottom: 10px;
}

.file-info {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
}

.file-info i {
  margin-right: 8px;
  font-size: 16px;
  color: #909399;
}

.file-actions {
  display: flex;
  gap: 10px;
}

.file-actions .el-button--text {
  padding: 0;
  margin: 0;
}
</style>
```

### 2. 创建多文件上传组件
**文件路径：** `mall-admin-web/src/components/Upload/multiUpload.vue`

```vue
<template>
  <div>
    <el-upload
      :action="uploadUrl"
      :headers="headers"
      :file-list="fileList"
      :on-success="handleUploadSuccess"
      :on-error="handleUploadError"
      :on-remove="handleRemove"
      :before-upload="beforeUpload"
      :accept="acceptType"
      :limit="maxCount"
      :on-exceed="handleExceed"
      multiple
      list-type="picture-card">
      <i class="el-icon-plus"></i>
      <div slot="tip" class="el-upload__tip">
        {{ tip }}
      </div>
    </el-upload>
  </div>
</template>

<script>
import { getToken } from '@/utils/auth'

export default {
  name: 'MultiUpload',
  props: {
    value: {
      type: Array,
      default: () => []
    },
    fileType: {
      type: String,
      default: 'image',
      validator: value => ['image', 'video', 'file'].includes(value)
    },
    maxSize: {
      type: Number,
      default: 10 // MB
    },
    maxCount: {
      type: Number,
      default: 9
    }
  },
  data() {
    return {
      fileList: [],
      headers: {
        'Authorization': 'Bearer ' + getToken()
      }
    }
  },
  computed: {
    uploadUrl() {
      return process.env.VUE_APP_BASE_API + '/minio/upload'
    },
    acceptType() {
      const acceptMap = {
        image: 'image/*',
        video: 'video/*',
        file: '*/*'
      }
      return acceptMap[this.fileType]
    },
    tip() {
      const typeText = this.fileType === 'image' ? '图片' : '文件'
      return `只能上传${typeText}文件，且不超过${this.maxSize}MB，最多${this.maxCount}个文件`
    }
  },
  watch: {
    value: {
      handler(newVal) {
        this.fileList = newVal.map((url, index) => ({
          uid: index,
          name: url.split('/').pop(),
          status: 'success',
          url: url
        }))
      },
      immediate: true
    }
  },
  methods: {
    beforeUpload(file) {
      const isValidType = this.checkFileType(file)
      if (!isValidType) {
        this.$message.error(`请上传正确的${this.fileType === 'image' ? '图片' : '文件'}格式文件！`)
        return false
      }
      
      const isValidSize = file.size / 1024 / 1024 < this.maxSize
      if (!isValidSize) {
        this.$message.error(`文件大小不能超过 ${this.maxSize}MB!`)
        return false
      }
      
      return true
    },
    checkFileType(file) {
      const imageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']
      const videoTypes = ['video/mp4', 'video/avi', 'video/mov', 'video/wmv']
      
      switch (this.fileType) {
        case 'image':
          return imageTypes.includes(file.type)
        case 'video':
          return videoTypes.includes(file.type)
        case 'file':
          return true
        default:
          return false
      }
    },
    handleUploadSuccess(response, file, fileList) {
      if (response.code === 200) {
        const urls = fileList
          .filter(item => item.status === 'success')
          .map(item => item.response ? item.response.data.url : item.url)
        
        this.$emit('input', urls)
        this.$emit('success', response.data)
        this.$message.success('上传成功！')
      } else {
        this.$message.error(response.message || '上传失败')
      }
    },
    handleUploadError(error) {
      this.$message.error('上传失败：' + error.message)
    },
    handleRemove(file, fileList) {
      const urls = fileList
        .filter(item => item.status === 'success')
        .map(item => item.response ? item.response.data.url : item.url)
      
      this.$emit('input', urls)
      this.$emit('remove', file)
    },
    handleExceed(files, fileList) {
      this.$message.warning(`当前限制选择 ${this.maxCount} 个文件，本次选择了 ${files.length} 个文件，共选择了 ${files.length + fileList.length} 个文件`)
    }
  }
}
</script>
```

### 3. 更新案例管理页面使用上传组件
在之前创建的案例数据管理页面中，已经使用了`SingleUpload`组件，确保正确导入：

```javascript
// 在需要使用的页面中导入
import SingleUpload from '@/components/Upload/singleUpload'
import MultiUpload from '@/components/Upload/multiUpload'

export default {
  components: {
    SingleUpload,
    MultiUpload
  },
  // ...
}
```

### 4. 创建文件管理工具
**文件路径：** `mall-admin-web/src/utils/file.js`

```javascript
/**
 * 文件处理工具函数
 */

/**
 * 获取文件扩展名
 */
export function getFileExtension(filename) {
  return filename.slice((filename.lastIndexOf('.') - 1 >>> 0) + 2)
}

/**
 * 格式化文件大小
 */
export function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes'
  
  const k = 1024
  const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
}

/**
 * 检查文件类型
 */
export function checkFileType(file, allowedTypes) {
  const fileType = file.type
  return allowedTypes.some(type => {
    if (type.endsWith('/*')) {
      return fileType.startsWith(type.slice(0, -1))
    }
    return fileType === type
  })
}

/**
 * 生成文件预览URL
 */
export function generatePreviewUrl(file) {
  if (file.type.startsWith('image/')) {
    return URL.createObjectURL(file)
  }
  return null
}

/**
 * 下载文件
 */
export function downloadFile(url, filename) {
  const link = document.createElement('a')
  link.href = url
  link.download = filename || url.split('/').pop()
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)
}

/**
 * 压缩图片
 */
export function compressImage(file, quality = 0.8, maxWidth = 1920, maxHeight = 1080) {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas')
    const ctx = canvas.getContext('2d')
    const img = new Image()
    
    img.onload = () => {
      // 计算压缩后的尺寸
      let { width, height } = img
      
      if (width > maxWidth || height > maxHeight) {
        const ratio = Math.min(maxWidth / width, maxHeight / height)
        width *= ratio
        height *= ratio
      }
      
      canvas.width = width
      canvas.height = height
      
      // 绘制压缩后的图片
      ctx.drawImage(img, 0, 0, width, height)
      
      // 转换为Blob
      canvas.toBlob(resolve, file.type, quality)
    }
    
    img.src = URL.createObjectURL(file)
  })
}
```

### 5. 添加上传配置
**文件路径：** `mall-admin-web/src/config/upload.js`

```javascript
/**
 * 文件上传配置
 */
export const uploadConfig = {
  // 图片上传配置
  image: {
    accept: ['.jpg', '.jpeg', '.png', '.gif', '.webp'],
    acceptTypes: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
    maxSize: 10, // MB
    maxCount: 9,
    compress: true,
    compressQuality: 0.8
  },
  
  // 视频上传配置
  video: {
    accept: ['.mp4', '.avi', '.mov', '.wmv', '.flv'],
    acceptTypes: ['video/mp4', 'video/avi', 'video/mov', 'video/wmv', 'video/x-flv'],
    maxSize: 100, // MB
    maxCount: 1,
    compress: false
  },
  
  // 文件上传配置
  file: {
    accept: ['.*'],
    acceptTypes: ['*/*'],
    maxSize: 50, // MB
    maxCount: 5,
    compress: false
  }
}

/**
 * 获取上传配置
 */
export function getUploadConfig(type) {
  return uploadConfig[type] || uploadConfig.file
}
```

## 验证步骤
1. 测试图片上传功能
2. 测试视频上传功能
3. 验证文件类型和大小限制
4. 测试文件预览功能
5. 验证文件删除功能
6. 测试多文件上传功能
7. 检查上传进度显示
8. 验证错误处理机制

## 功能特性
1. **文件类型限制**：支持图片、视频等不同文件类型
2. **大小限制**：可配置文件大小限制
3. **预览功能**：支持图片预览、视频播放
4. **进度显示**：显示上传进度和状态
5. **错误处理**：完善的错误提示和处理
6. **多文件上传**：支持批量文件上传
7. **拖拽上传**：支持拖拽方式上传文件

## 安全考虑
1. **文件类型验证**：前后端双重验证文件类型
2. **大小限制**：防止大文件攻击
3. **权限控制**：需要登录才能上传文件
4. **文件名处理**：防止特殊字符和路径穿越

## 输出物
- 单文件上传组件 (SingleUpload)
- 多文件上传组件 (MultiUpload)
- 文件处理工具函数
- 上传配置文件
- 完整的文件上传功能集成

## 后续任务
- 下一步：14-实现懒加载组件.md