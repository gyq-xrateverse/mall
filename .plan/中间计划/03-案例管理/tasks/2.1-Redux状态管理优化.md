# 2.1 Redux状态管理优化

## 目标
修正用户前端案例数据结构，严格对应CaseData实体，优化状态管理

## 优先级
高

## 改造内容

### 2.1.1 案例数据接口修正

**文件路径**: `beilv-agent-web/src/store/aiSlice.ts`

#### 数据接口设计（严格对应后端CaseData实体）

```typescript
// 修正的案例数据接口 - 严格对应后端CaseData实体
interface AICase {
  id: string;
  title: string;
  content: string;
  categoryId: number;
  category: string;         // 分类名称（前端显示用）

  // 媒体文件字段（对应CaseData实体）
  image: string;           // 图片ObjectName
  video: string;           // 视频ObjectName
  tags: string;            // 标签字符串，逗号分隔

  // 显示用完整URL (前端computed)
  imageUrl?: string;       // 图片完整URL
  videoUrl?: string;       // 视频完整URL
  tagList?: string[];      // 标签数组（前端显示用）

  // 系统字段
  status: number;          // 状态：0禁用，1启用
  showStatus: number;      // 显示状态：0不显示，1显示
  viewCount: number;       // 浏览数
  likeCount: number;       // 点赞数
  hotScore: number;        // 热度分数
  createTime: string;
  updateTime: string;
}
```

#### 数据转换函数

```typescript
// 案例数据转换函数 - 修正版
const transformCaseData = (item: any): AICase => {
  const buildUrl = (objectName: string) => {
    if (!objectName) return '';
    if (objectName.startsWith('http')) return objectName;
    return `${import.meta.env.VITE_STORAGE_BASE_URL}/${objectName}`;
  };

  return {
    id: item.id,
    title: item.title,
    content: item.content || '',
    categoryId: item.categoryId,
    category: item.categoryName || '默认分类',

    // 媒体文件字段（严格对应CaseData）
    image: item.image || '',           // 图片ObjectName
    video: item.video || '',           // 视频ObjectName
    tags: item.tags || '',             // 标签字符串

    // 前端显示用URL
    imageUrl: buildUrl(item.image || ''),
    videoUrl: buildUrl(item.video || ''),
    tagList: item.tags ? item.tags.split(',').filter(t => t.trim()) : [],

    // 系统字段
    status: item.status || 1,
    showStatus: item.showStatus || 1,
    viewCount: item.viewCount || 0,
    likeCount: item.likeCount || 0,
    hotScore: item.hotScore || 0,
    createTime: item.createTime || new Date().toISOString(),
    updateTime: item.updateTime || new Date().toISOString()
  };
};
```

### 2.1.2 异步Action更新

```typescript
// 获取案例列表
export const fetchCases = createAsyncThunk(
  'ai/fetchCases',
  async (params: { category?: string; page?: number; size?: number }) => {
    try {
      const response = await fetch('/api/cases', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${getToken()}`
        },
        body: JSON.stringify({
          pageNum: params.page || 1,
          pageSize: params.size || 20,
          categoryName: params.category !== '全部' ? params.category : undefined
        })
      });

      const result = await response.json();

      if (result.code === 200) {
        return {
          cases: result.data.list.map(transformCaseData),
          total: result.data.total,
          pageNum: result.data.pageNum,
          pageSize: result.data.pageSize
        };
      } else {
        throw new Error(result.message || '获取案例失败');
      }
    } catch (error) {
      // 降级策略：使用本地数据
      console.warn('API调用失败，使用本地数据:', error);
      const { galleryData } = await import('../data/galleryData');
      return {
        cases: galleryData.map(transformCaseData),
        total: galleryData.length,
        pageNum: 1,
        pageSize: galleryData.length
      };
    }
  }
);

// 获取案例分类
export const fetchCategories = createAsyncThunk(
  'ai/fetchCategories',
  async () => {
    try {
      const response = await fetch('/api/case/categories', {
        headers: {
          'Authorization': `Bearer ${getToken()}`
        }
      });

      const result = await response.json();

      if (result.code === 200) {
        return result.data.map((category: any) => ({
          id: category.id,
          name: category.name,
          sort: category.sort || 0
        }));
      } else {
        throw new Error(result.message || '获取分类失败');
      }
    } catch (error) {
      console.warn('获取分类失败，使用默认分类:', error);
      return [
        { id: 1, name: '前端开发', sort: 1 },
        { id: 2, name: '后端开发', sort: 2 },
        { id: 3, name: '移动开发', sort: 3 },
        { id: 4, name: '数据分析', sort: 4 }
      ];
    }
  }
);
```

### 2.1.3 State结构优化

```typescript
interface AIState {
  // 案例相关
  cases: AICase[];
  categories: Category[];
  casesLoading: boolean;
  casesError: string | null;

  // 分页信息
  pagination: {
    current: number;
    pageSize: number;
    total: number;
  };

  // 筛选条件
  filters: {
    category: string;
    keyword: string;
    status: number | null;
  };

  // UI状态
  selectedCase: AICase | null;
  showCaseDetail: boolean;

  // 项目相关（保持原有）
  projects: Project[];
  projectsLoading: boolean;
  projectsError: string | null;
}

const initialState: AIState = {
  cases: [],
  categories: [],
  casesLoading: false,
  casesError: null,

  pagination: {
    current: 1,
    pageSize: 20,
    total: 0
  },

  filters: {
    category: '全部',
    keyword: '',
    status: null
  },

  selectedCase: null,
  showCaseDetail: false,

  projects: [],
  projectsLoading: false,
  projectsError: null
};
```

### 2.1.4 Reducers更新

```typescript
const aiSlice = createSlice({
  name: 'ai',
  initialState,
  reducers: {
    // 设置筛选条件
    setFilters: (state, action) => {
      state.filters = { ...state.filters, ...action.payload };
    },

    // 设置分页
    setPagination: (state, action) => {
      state.pagination = { ...state.pagination, ...action.payload };
    },

    // 选择案例
    selectCase: (state, action) => {
      state.selectedCase = action.payload;
    },

    // 显示/隐藏案例详情
    setShowCaseDetail: (state, action) => {
      state.showCaseDetail = action.payload;
    },

    // 清除案例错误
    clearCasesError: (state) => {
      state.casesError = null;
    }
  },

  extraReducers: (builder) => {
    builder
      // 获取案例列表
      .addCase(fetchCases.pending, (state) => {
        state.casesLoading = true;
        state.casesError = null;
      })
      .addCase(fetchCases.fulfilled, (state, action) => {
        state.casesLoading = false;
        state.cases = action.payload.cases;
        state.pagination.total = action.payload.total;
        state.pagination.current = action.payload.pageNum;
        state.pagination.pageSize = action.payload.pageSize;
      })
      .addCase(fetchCases.rejected, (state, action) => {
        state.casesLoading = false;
        state.casesError = action.error.message || '获取案例失败';
      })

      // 获取分类
      .addCase(fetchCategories.pending, (state) => {
        // 不影响主要loading状态
      })
      .addCase(fetchCategories.fulfilled, (state, action) => {
        state.categories = action.payload;
      })
      .addCase(fetchCategories.rejected, (state, action) => {
        console.error('获取分类失败:', action.error.message);
      });
  }
});

export const {
  setFilters,
  setPagination,
  selectCase,
  setShowCaseDetail,
  clearCasesError
} = aiSlice.actions;

export default aiSlice.reducer;
```

### 2.1.5 Selectors优化

```typescript
// 选择器
export const selectCases = (state: RootState) => state.ai.cases;
export const selectCategories = (state: RootState) => state.ai.categories;
export const selectCasesLoading = (state: RootState) => state.ai.casesLoading;
export const selectCasesError = (state: RootState) => state.ai.casesError;
export const selectPagination = (state: RootState) => state.ai.pagination;
export const selectFilters = (state: RootState) => state.ai.filters;
export const selectSelectedCase = (state: RootState) => state.ai.selectedCase;
export const selectShowCaseDetail = (state: RootState) => state.ai.showCaseDetail;

// 复合选择器
export const selectFilteredCases = createSelector(
  [selectCases, selectFilters],
  (cases, filters) => {
    let filtered = cases;

    // 按分类筛选
    if (filters.category !== '全部') {
      filtered = filtered.filter(item => item.category === filters.category);
    }

    // 按关键词搜索
    if (filters.keyword.trim()) {
      const keyword = filters.keyword.toLowerCase();
      filtered = filtered.filter(item =>
        item.title.toLowerCase().includes(keyword) ||
        item.content.toLowerCase().includes(keyword) ||
        item.tagList.some(tag => tag.toLowerCase().includes(keyword))
      );
    }

    // 按状态筛选
    if (filters.status !== null) {
      filtered = filtered.filter(item => item.showStatus === filters.status);
    }

    return filtered;
  }
);

// 获取案例统计信息
export const selectCaseStats = createSelector(
  [selectCases],
  (cases) => ({
    total: cases.length,
    published: cases.filter(c => c.showStatus === 1).length,
    hidden: cases.filter(c => c.showStatus === 0).length,
    totalViews: cases.reduce((sum, c) => sum + c.viewCount, 0),
    totalLikes: cases.reduce((sum, c) => sum + c.likeCount, 0)
  })
);
```

## 验收标准

1. ✅ 案例数据结构严格对应CaseData实体
2. ✅ 支持图片和视频URL自动构建
3. ✅ 标签数据正确转换（字符串↔数组）
4. ✅ 分页和筛选功能正常
5. ✅ 错误处理和降级策略完善
6. ✅ 性能优化，避免不必要的重新渲染
7. ✅ 类型安全，TypeScript类型定义完整

## 测试要求

- 执行单元测试：`aiSlice.test.ts`
- 验证数据转换逻辑正确性
- 验证状态管理功能
- 验证选择器性能和准确性

## 依赖

- 后端API接口返回正确的数据格式
- 环境变量VITE_STORAGE_BASE_URL配置正确
- Redux Toolkit和相关依赖已安装

## 交付物

- [x] aiSlice.ts 状态管理优化完成
- [x] 类型定义文件更新
- [x] 相应的单元测试
- [x] 性能优化和错误处理完善