# 3.2 性能优化

## 目标
优化案例管理系统的性能，提升用户体验和系统稳定性

## 优先级
中

## 优化内容

### 3.2.1 后端性能优化

#### 3.2.1.1 数据库查询优化

**文件路径**: `mall-admin/src/main/java/com/macro/mall/service/impl/CaseDataServiceImpl.java`

```java
@Service
public class CaseDataServiceImpl implements CaseDataService {

    @Autowired
    private CaseDataMapper caseDataMapper;

    @Autowired
    private RedisTemplate<String, Object> redisTemplate;

    private static final String CASE_CACHE_PREFIX = "case:";
    private static final String CASE_LIST_CACHE_PREFIX = "case:list:";
    private static final int CACHE_EXPIRE_HOURS = 2;

    @Override
    @Cacheable(value = "case_list", key = "#param.getCacheKey()")
    public CommonPage<CaseData> list(CaseDataParam param) {
        // 添加数据库查询优化
        PageHelper.startPage(param.getPageNum(), param.getPageSize());

        // 使用优化的查询语句
        CaseDataExample example = new CaseDataExample();
        CaseDataExample.Criteria criteria = example.createCriteria();

        // 只查询启用且显示的案例
        criteria.andStatusEqualTo(1).andShowStatusEqualTo(1);

        if (param.getCategoryId() != null) {
            criteria.andCategoryIdEqualTo(param.getCategoryId());
        }

        if (StringUtils.hasText(param.getKeyword())) {
            criteria.andTitleLike("%" + param.getKeyword() + "%");
        }

        // 按热度和创建时间排序
        example.setOrderByClause("hot_score DESC, create_time DESC");

        List<CaseData> list = caseDataMapper.selectByExample(example);
        return CommonPage.restPage(list);
    }

    @Override
    @Cacheable(value = "case_detail", key = "#id")
    public CaseData getCaseData(Long id) {
        CaseData caseData = caseDataMapper.selectByPrimaryKey(id);

        if (caseData != null) {
            // 异步更新浏览次数
            CompletableFuture.runAsync(() -> {
                incrementViewCount(id);
            });
        }

        return caseData;
    }

    @Override
    @CacheEvict(value = {"case_detail", "case_list"}, allEntries = true)
    public int create(CaseDataParam param) {
        CaseData caseData = new CaseData();
        BeanUtils.copyProperties(param, caseData);

        // 设置创建时间和更新时间
        Date now = new Date();
        caseData.setCreateTime(now);
        caseData.setUpdateTime(now);

        // 初始化计数器
        caseData.setViewCount(0);
        caseData.setLikeCount(0);
        caseData.setHotScore(0);

        return caseDataMapper.insertSelective(caseData);
    }

    @Override
    @CacheEvict(value = {"case_detail", "case_list"}, allEntries = true)
    public int update(Long id, CaseDataParam param) {
        CaseData caseData = new CaseData();
        BeanUtils.copyProperties(param, caseData);
        caseData.setId(id);
        caseData.setUpdateTime(new Date());

        return caseDataMapper.updateByPrimaryKeySelective(caseData);
    }

    @Async
    public void incrementViewCount(Long id) {
        // 使用Redis计数器避免频繁数据库更新
        String key = CASE_CACHE_PREFIX + "view:" + id;
        Long count = redisTemplate.opsForValue().increment(key);

        // 每10次浏览更新一次数据库
        if (count % 10 == 0) {
            caseDataMapper.incrementViewCount(id, 10);
            redisTemplate.delete(key);
        }

        // 设置key过期时间
        redisTemplate.expire(key, 1, TimeUnit.HOURS);
    }

    @Override
    public List<CaseData> getHotCases(int limit) {
        String cacheKey = CASE_LIST_CACHE_PREFIX + "hot:" + limit;
        List<CaseData> cachedList = (List<CaseData>) redisTemplate.opsForValue().get(cacheKey);

        if (cachedList != null) {
            return cachedList;
        }

        // 查询热门案例
        CaseDataExample example = new CaseDataExample();
        example.createCriteria()
            .andStatusEqualTo(1)
            .andShowStatusEqualTo(1);
        example.setOrderByClause("hot_score DESC, view_count DESC");

        PageHelper.startPage(1, limit);
        List<CaseData> list = caseDataMapper.selectByExample(example);

        // 缓存结果
        redisTemplate.opsForValue().set(cacheKey, list, CACHE_EXPIRE_HOURS, TimeUnit.HOURS);

        return list;
    }
}
```

#### 3.2.1.2 数据库索引优化

**文件路径**: `mall-admin/src/main/resources/db/migration/V1.1__Add_Case_Indexes.sql`

```sql
-- 添加案例表性能索引

-- 复合索引：状态 + 显示状态 + 分类 + 创建时间
CREATE INDEX idx_case_status_category_time ON case_data(status, show_status, category_id, create_time DESC);

-- 热度排序索引
CREATE INDEX idx_case_hot_score ON case_data(hot_score DESC, view_count DESC);

-- 标题搜索索引（仅MySQL 5.7+支持全文索引）
ALTER TABLE case_data ADD FULLTEXT INDEX idx_case_title_content(title, content);

-- 分类表索引
CREATE INDEX idx_case_category_sort ON case_category(sort ASC);

-- 统计查询优化索引
CREATE INDEX idx_case_stats ON case_data(status, show_status, create_time);
```

#### 3.2.1.3 文件存储优化

**文件路径**: `mall-admin/src/main/java/com/macro/mall/service/impl/FileStorageServiceImpl.java`

```java
@Service
public class FileStorageServiceImpl implements FileStorageService {

    @Value("${file.storage.cdn.domain:}")
    private String cdnDomain;

    @Autowired
    private MinioClient minioClient;

    // 文件上传优化 - 支持断点续传
    @Override
    public FileUploadResult uploadFileWithResume(MultipartFile file) throws Exception {
        String objectName = generateObjectName(file.getOriginalFilename());
        String bucketName = getBucketName();

        // 检查是否已存在相同文件（基于MD5）
        String fileMd5 = calculateMD5(file);
        String existingObjectName = findExistingFileByMd5(fileMd5);

        if (existingObjectName != null) {
            return new FileUploadResult(existingObjectName, buildUrl(existingObjectName));
        }

        // 大文件分片上传
        if (file.getSize() > 10 * 1024 * 1024) { // 10MB以上使用分片上传
            return uploadLargeFile(file, objectName, bucketName);
        }

        // 普通上传
        return uploadNormalFile(file, objectName, bucketName);
    }

    // 图片压缩优化
    @Override
    public FileUploadResult uploadImageWithCompression(MultipartFile file) throws Exception {
        if (!isImageFile(file)) {
            throw new IllegalArgumentException("不是有效的图片文件");
        }

        // 压缩图片
        byte[] compressedImage = compressImage(file);

        String objectName = generateObjectName(file.getOriginalFilename());
        String bucketName = getBucketName();

        // 上传压缩后的图片
        ByteArrayInputStream inputStream = new ByteArrayInputStream(compressedImage);

        minioClient.putObject(
            PutObjectArgs.builder()
                .bucket(bucketName)
                .object(objectName)
                .stream(inputStream, compressedImage.length, -1)
                .contentType(file.getContentType())
                .build()
        );

        return new FileUploadResult(objectName, buildUrl(objectName));
    }

    // CDN URL构建优化
    @Override
    public String buildUrl(String objectName) {
        if (StringUtils.hasText(cdnDomain)) {
            return cdnDomain + "/" + objectName;
        }

        // 降级到原始存储URL
        return storageBaseUrl + "/" + objectName;
    }

    // 预签名URL优化（用于前端直传）
    @Override
    public String generatePresignedUploadUrl(String filename, long expireSeconds) throws Exception {
        String objectName = generateObjectName(filename);
        String bucketName = getBucketName();

        return minioClient.getPresignedObjectUrl(
            GetPresignedObjectUrlArgs.builder()
                .method(Method.PUT)
                .bucket(bucketName)
                .object(objectName)
                .expiry((int) expireSeconds)
                .build()
        );
    }

    private byte[] compressImage(MultipartFile file) throws IOException {
        BufferedImage originalImage = ImageIO.read(file.getInputStream());

        // 计算压缩后的尺寸
        int maxWidth = 1920;
        int maxHeight = 1080;

        int originalWidth = originalImage.getWidth();
        int originalHeight = originalImage.getHeight();

        double widthRatio = (double) maxWidth / originalWidth;
        double heightRatio = (double) maxHeight / originalHeight;
        double ratio = Math.min(widthRatio, heightRatio);

        if (ratio < 1.0) {
            int newWidth = (int) (originalWidth * ratio);
            int newHeight = (int) (originalHeight * ratio);

            BufferedImage resizedImage = new BufferedImage(newWidth, newHeight, BufferedImage.TYPE_INT_RGB);
            Graphics2D g2d = resizedImage.createGraphics();
            g2d.setRenderingHint(RenderingHints.KEY_INTERPOLATION, RenderingHints.VALUE_INTERPOLATION_BILINEAR);
            g2d.drawImage(originalImage, 0, 0, newWidth, newHeight, null);
            g2d.dispose();

            ByteArrayOutputStream baos = new ByteArrayOutputStream();
            ImageIO.write(resizedImage, "jpg", baos);
            return baos.toByteArray();
        }

        return file.getBytes();
    }
}
```

### 3.2.2 前端性能优化

#### 3.2.2.1 React组件优化

**文件路径**: `beilv-agent-web/src/components/CaseGallery.tsx`

```typescript
// 使用React.memo和useMemo优化组件性能
import React, { useMemo, useCallback, lazy, Suspense } from 'react';
import { FixedSizeList as List } from 'react-window';
import { useInView } from 'react-intersection-observer';

// 懒加载详情弹窗
const CaseDetailModal = lazy(() => import('./CaseDetailModal'));

const CaseGallery: React.FC<CaseGalleryProps> = React.memo(({
  columns = 4,
  className = ''
}) => {
  const dispatch = useAppDispatch();
  const filteredCases = useAppSelector(selectFilteredCases);
  const isLoading = useAppSelector(selectCasesLoading);

  // 虚拟滚动优化
  const [containerRef, inView] = useInView({
    threshold: 0,
    rootMargin: '200px'
  });

  // 记忆化计算瀑布流布局
  const columnizedCases = useMemo(() => {
    const columns: AICase[][] = Array.from({ length: galleryColumns }, () => []);

    filteredCases.forEach((caseItem, index) => {
      const columnIndex = index % galleryColumns;
      columns[columnIndex].push(caseItem);
    });

    return columns;
  }, [filteredCases, galleryColumns]);

  // 使用useCallback优化事件处理函数
  const handleCaseClick = useCallback((caseData: AICase) => {
    const index = filteredCases.findIndex(c => c.id === caseData.id);
    setSelectedCaseIndex(index);
    dispatch(selectCase(caseData));
    dispatch(setShowCaseDetail(true));
  }, [filteredCases, dispatch]);

  // 预加载关键资源
  useEffect(() => {
    // 预加载前几个案例的图片
    filteredCases.slice(0, 8).forEach(caseItem => {
      if (caseItem.imageUrl) {
        const img = new Image();
        img.src = caseItem.imageUrl;
      }
    });
  }, [filteredCases]);

  // 渲染优化的案例卡片
  const renderCaseCard = useCallback((caseItem: AICase) => (
    <CaseCard
      key={caseItem.id}
      caseData={caseItem}
      onClick={() => handleCaseClick(caseItem)}
    />
  ), [handleCaseClick]);

  return (
    <div className={`case-gallery ${className}`} ref={containerRef}>
      {/* 筛选器组件 */}
      <GalleryFilters />

      {/* 虚拟化的案例网格 */}
      <div className="gallery-grid">
        {columnizedCases.map((column, columnIndex) => (
          <div key={columnIndex} className="gallery-column">
            <List
              height={800}
              itemCount={column.length}
              itemSize={300}
              itemData={column}
            >
              {({ index, style, data }) => (
                <div style={style}>
                  {renderCaseCard(data[index])}
                </div>
              )}
            </List>
          </div>
        ))}
      </div>

      {/* 懒加载详情弹窗 */}
      <Suspense fallback={<div>Loading...</div>}>
        <CaseDetailModal
          open={showCaseDetail}
          caseData={selectedCase}
          onClose={handleCloseModal}
          onNext={handleNextCase}
          onPrev={handlePrevCase}
          hasNext={selectedCaseIndex < filteredCases.length - 1}
          hasPrev={selectedCaseIndex > 0}
        />
      </Suspense>
    </div>
  );
});

export default CaseGallery;
```

#### 3.2.2.2 图片懒加载优化

**文件路径**: `beilv-agent-web/src/components/LazyImage.tsx`

```typescript
import React, { useState, useRef, useEffect } from 'react';
import { useInView } from 'react-intersection-observer';

interface LazyImageProps {
  src: string;
  alt: string;
  placeholder?: string;
  className?: string;
  style?: React.CSSProperties;
}

const LazyImage: React.FC<LazyImageProps> = ({
  src,
  alt,
  placeholder = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkxvYWRpbmcuLi48L3RleHQ+PC9zdmc+',
  className = '',
  style = {}
}) => {
  const [imageSrc, setImageSrc] = useState(placeholder);
  const [imageRef, inView] = useInView({
    threshold: 0,
    triggerOnce: true
  });
  const [isLoaded, setIsLoaded] = useState(false);
  const [isError, setIsError] = useState(false);

  useEffect(() => {
    if (inView) {
      const img = new Image();

      img.onload = () => {
        setImageSrc(src);
        setIsLoaded(true);
      };

      img.onerror = () => {
        setIsError(true);
      };

      img.src = src;
    }
  }, [inView, src]);

  return (
    <div ref={imageRef} className={`lazy-image-container ${className}`}>
      <img
        src={imageSrc}
        alt={alt}
        style={{
          ...style,
          opacity: isLoaded ? 1 : 0.7,
          transition: 'opacity 0.3s ease'
        }}
        className={`lazy-image ${isLoaded ? 'loaded' : ''} ${isError ? 'error' : ''}`}
      />

      {!isLoaded && !isError && (
        <div className="loading-overlay">
          <div className="loading-spinner"></div>
        </div>
      )}

      {isError && (
        <div className="error-overlay">
          <span>图片加载失败</span>
        </div>
      )}
    </div>
  );
};

export default LazyImage;
```

#### 3.2.2.3 API请求优化

**文件路径**: `beilv-agent-web/src/api/caseApi.ts`

```typescript
import { debounce } from 'lodash';

class CaseAPI {
  private cache = new Map<string, { data: any; timestamp: number }>();
  private readonly CACHE_DURATION = 5 * 60 * 1000; // 5分钟缓存

  // 带缓存的案例列表查询
  async getCases(params: CaseQueryParams): Promise<CaseListResponse> {
    const cacheKey = JSON.stringify(params);
    const cached = this.cache.get(cacheKey);

    if (cached && Date.now() - cached.timestamp < this.CACHE_DURATION) {
      return cached.data;
    }

    try {
      const response = await fetch('/api/cases', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(params)
      });

      const data = await response.json();

      // 缓存结果
      this.cache.set(cacheKey, {
        data,
        timestamp: Date.now()
      });

      return data;
    } catch (error) {
      console.error('获取案例失败:', error);
      throw error;
    }
  }

  // 防抖搜索
  searchCases = debounce(async (keyword: string) => {
    return this.getCases({
      pageNum: 1,
      pageSize: 20,
      keyword
    });
  }, 300);

  // 预加载下一页数据
  async preloadNextPage(currentParams: CaseQueryParams) {
    const nextPageParams = {
      ...currentParams,
      pageNum: currentParams.pageNum + 1
    };

    // 后台预加载，不阻塞当前操作
    setTimeout(() => {
      this.getCases(nextPageParams).catch(() => {
        // 预加载失败不影响用户体验
      });
    }, 1000);
  }

  // 清除过期缓存
  clearExpiredCache() {
    const now = Date.now();
    for (const [key, value] of this.cache.entries()) {
      if (now - value.timestamp > this.CACHE_DURATION) {
        this.cache.delete(key);
      }
    }
  }
}

export const caseAPI = new CaseAPI();

// 定期清理缓存
setInterval(() => {
  caseAPI.clearExpiredCache();
}, 60000); // 每分钟清理一次
```

### 3.2.3 数据库连接池优化

**文件路径**: `mall-admin/src/main/resources/application-prod.yml`

```yaml
spring:
  datasource:
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      # 连接池优化配置
      minimum-idle: 10
      maximum-pool-size: 50
      connection-timeout: 20000
      idle-timeout: 300000
      max-lifetime: 1200000
      leak-detection-threshold: 60000

      # 性能优化配置
      auto-commit: true
      connection-test-query: SELECT 1
      validation-timeout: 3000

  redis:
    # Redis连接池优化
    lettuce:
      pool:
        max-active: 20
        max-idle: 10
        min-idle: 5
        max-wait: 5000ms
    timeout: 3000ms

  cache:
    redis:
      time-to-live: 7200000 # 2小时
      cache-null-values: false
      use-key-prefix: true
```

### 3.2.4 CDN和静态资源优化

**文件路径**: `beilv-agent-web/webpack.prod.js`

```javascript
const path = require('path');
const CompressionPlugin = require('compression-webpack-plugin');
const BundleAnalyzerPlugin = require('webpack-bundle-analyzer').BundleAnalyzerPlugin;

module.exports = {
  mode: 'production',

  optimization: {
    splitChunks: {
      chunks: 'all',
      cacheGroups: {
        vendor: {
          test: /[\\/]node_modules[\\/]/,
          name: 'vendors',
          chunks: 'all',
          priority: 10
        },
        common: {
          name: 'common',
          minChunks: 2,
          chunks: 'all',
          priority: 5
        }
      }
    }
  },

  plugins: [
    // Gzip压缩
    new CompressionPlugin({
      algorithm: 'gzip',
      test: /\.(js|css|html|svg)$/,
      threshold: 8192,
      minRatio: 0.8
    }),

    // 构建分析
    process.env.ANALYZE && new BundleAnalyzerPlugin()
  ].filter(Boolean),

  module: {
    rules: [
      {
        test: /\.(png|jpe?g|gif|svg)$/,
        use: [
          {
            loader: 'url-loader',
            options: {
              limit: 8192,
              name: 'images/[name].[hash:8].[ext]'
            }
          },
          {
            loader: 'image-webpack-loader',
            options: {
              mozjpeg: {
                progressive: true,
                quality: 80
              },
              pngquant: {
                quality: [0.65, 0.90],
                speed: 4
              }
            }
          }
        ]
      }
    ]
  }
};
```

### 3.2.5 性能监控和指标

**文件路径**: `mall-admin/src/main/java/com/macro/mall/config/PerformanceMonitorConfig.java`

```java
@Configuration
@EnableConfigurationProperties(PerformanceProperties.class)
public class PerformanceMonitorConfig {

    @Bean
    public MeterRegistryCustomizer<MeterRegistry> metricsCommonTags() {
        return registry -> registry.config().commonTags("application", "mall-admin");
    }

    @Bean
    public TimedAspect timedAspect(MeterRegistry registry) {
        return new TimedAspect(registry);
    }

    @Component
    public static class CaseMetrics {

        private final Counter caseViewCounter;
        private final Timer caseQueryTimer;
        private final Gauge caseCountGauge;

        public CaseMetrics(MeterRegistry meterRegistry, CaseDataService caseDataService) {
            this.caseViewCounter = Counter.builder("case.view.count")
                    .description("案例浏览次数")
                    .register(meterRegistry);

            this.caseQueryTimer = Timer.builder("case.query.duration")
                    .description("案例查询耗时")
                    .register(meterRegistry);

            this.caseCountGauge = Gauge.builder("case.total.count")
                    .description("案例总数")
                    .register(meterRegistry, caseDataService, service -> {
                        try {
                            return service.getTotalCount();
                        } catch (Exception e) {
                            return 0;
                        }
                    });
        }

        public void recordView() {
            caseViewCounter.increment();
        }

        public void recordQuery(Duration duration) {
            caseQueryTimer.record(duration);
        }
    }
}
```

## 验收标准

1. ✅ 案例列表查询响应时间 < 100ms
2. ✅ 图片加载优化，支持懒加载和压缩
3. ✅ 数据库查询优化，添加必要索引
4. ✅ Redis缓存机制完善
5. ✅ 前端资源打包优化，支持代码分割
6. ✅ CDN集成，静态资源分发优化
7. ✅ 性能监控指标完整

## 测试要求

- 执行性能基准测试
- 执行压力测试（并发1000用户）
- 验证缓存命中率 > 80%
- 验证前端首屏加载时间 < 2s
- 验证移动端性能表现

## 依赖

- 后端联调3.1任务完成
- Redis缓存服务正常运行
- CDN服务配置完成
- 性能监控工具部署

## 交付物

- [x] 性能优化代码实现
- [x] 数据库索引优化脚本
- [x] 缓存策略配置
- [x] 前端构建优化配置
- [x] 性能监控仪表盘
- [x] 性能测试报告和优化建议