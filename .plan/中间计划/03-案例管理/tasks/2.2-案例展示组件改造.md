# 2.2 案例展示组件改造

## 目标
创建支持图片展示和视频播放的媒体展示组件，优化用户前端案例浏览体验

## 优先级
高

## 改造内容

### 2.2.1 MediaDisplay组件创建

**文件路径**: `beilv-agent-web/src/components/MediaDisplay.tsx`

#### 组件接口设计

```typescript
interface MediaDisplayProps {
  caseData: AICase;
  className?: string;
  autoPlay?: boolean;
  showControls?: boolean;
  showVideo?: boolean;  // 是否显示视频（true）还是图片（false）
}

const MediaDisplay: React.FC<MediaDisplayProps> = ({
  caseData,
  className = '',
  autoPlay = false,
  showControls = true,
  showVideo = false
}) => {
  const [isVideoLoaded, setIsVideoLoaded] = useState(false);
  const videoRef = useRef<HTMLVideoElement>(null);

  const handleVideoLoad = () => {
    setIsVideoLoaded(true);
  };

  // 简化的媒体展示 - 每个案例都有图片和视频
  return (
    <div className={`media-display ${className}`}>
      {/* 根据显示模式决定展示内容 */}
      {showVideo && caseData.videoUrl ? (
        // 视频播放模式
        <div className="video-container">
          <video
            ref={videoRef}
            poster={caseData.imageUrl} // 使用图片作为视频封面
            controls={showControls}
            autoPlay={autoPlay}
            muted={autoPlay}
            onLoadedData={handleVideoLoad}
            style={{
              width: '100%',
              height: 'auto',
              borderRadius: '8px'
            }}
          >
            <source src={caseData.videoUrl} type="video/mp4" />
            您的浏览器不支持视频播放。
          </video>

          {!isVideoLoaded && (
            <div className="video-loading">
              <div className="loading-spinner"></div>
              <span>视频加载中...</span>
            </div>
          )}
        </div>
      ) : (
        // 图片显示模式（默认）
        <div className="image-container">
          <img
            src={caseData.imageUrl}
            alt={caseData.title}
            style={{
              width: '100%',
              height: 'auto',
              borderRadius: '8px'
            }}
            loading="lazy"
          />

          {/* 视频播放图标 */}
          {caseData.videoUrl && (
            <div className="play-button-overlay">
              <div className="play-icon">▶</div>
            </div>
          )}
        </div>
      )}
    </div>
  );
};

export default MediaDisplay;
```

### 2.2.2 CaseCard组件改造

**文件路径**: `beilv-agent-web/src/components/CaseCard.tsx`

```typescript
import React, { useState } from 'react';
import MediaDisplay from './MediaDisplay';
import { AICase } from '../types';

interface CaseCardProps {
  caseData: AICase;
  onClick?: () => void;
}

const CaseCard: React.FC<CaseCardProps> = ({ caseData, onClick }) => {
  const [isHovered, setIsHovered] = useState(false);

  const handleCardClick = () => {
    onClick?.();
  };

  return (
    <div
      className="case-card"
      onClick={handleCardClick}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
      style={{
        cursor: 'pointer',
        borderRadius: '12px',
        overflow: 'hidden',
        backgroundColor: '#fff',
        boxShadow: isHovered
          ? '0 8px 25px rgba(0, 0, 0, 0.15)'
          : '0 2px 10px rgba(0, 0, 0, 0.1)',
        transform: isHovered ? 'translateY(-2px)' : 'translateY(0)',
        transition: 'all 0.3s ease',
        marginBottom: '20px',
        breakInside: 'avoid'  // 防止瀑布流断裂
      }}
    >
      {/* 媒体展示区域 */}
      <div className="media-section">
        <MediaDisplay
          caseData={caseData}
          autoPlay={isHovered && !!caseData.videoUrl} // 悬停自动播放视频
          showControls={false} // 卡片中不显示控制条
          showVideo={false} // 默认显示图片
        />

        {/* 视频播放按钮 */}
        {caseData.videoUrl && !isHovered && (
          <div className="play-button">
            <div className="play-icon">▶</div>
          </div>
        )}
      </div>

      {/* 内容区域 */}
      <div className="content-section" style={{ padding: '16px' }}>
        <h3
          style={{
            margin: '0 0 8px 0',
            fontSize: '16px',
            fontWeight: '600',
            color: '#1a1a1a',
            lineHeight: '1.4'
          }}
        >
          {caseData.title}
        </h3>

        {caseData.content && (
          <p
            style={{
              margin: '0 0 12px 0',
              fontSize: '14px',
              color: '#666',
              lineHeight: '1.5',
              display: '-webkit-box',
              WebkitLineClamp: 2,
              WebkitBoxOrient: 'vertical',
              overflow: 'hidden'
            }}
          >
            {caseData.content}
          </p>
        )}

        {/* 标签 */}
        {caseData.tagList && caseData.tagList.length > 0 && (
          <div className="tags" style={{ marginBottom: '12px' }}>
            {caseData.tagList.slice(0, 3).map((tag, index) => (
              <span
                key={index}
                style={{
                  display: 'inline-block',
                  padding: '4px 8px',
                  margin: '0 6px 6px 0',
                  fontSize: '12px',
                  backgroundColor: '#f0f0f0',
                  color: '#666',
                  borderRadius: '12px'
                }}
              >
                {tag}
              </span>
            ))}
          </div>
        )}

        {/* 底部信息 */}
        <div
          style={{
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            fontSize: '12px',
            color: '#999'
          }}
        >
          <span>{caseData.category}</span>
          <span>{new Date(caseData.createTime).toLocaleDateString()}</span>
        </div>
      </div>
    </div>
  );
};

export default CaseCard;
```

### 2.2.3 CaseGallery组件改造

**文件路径**: `beilv-agent-web/src/components/CaseGallery.tsx`

```typescript
import React, { useEffect, useState, useMemo } from 'react';
import { useAppSelector, useAppDispatch } from '../hooks/redux';
import { fetchCases, setFilters, selectCase, setShowCaseDetail } from '../store/aiSlice';
import { selectFilteredCases, selectCasesLoading, selectFilters } from '../store/aiSlice';
import CaseCard from './CaseCard';
import { AICase } from '../types';

interface CaseGalleryProps {
  columns?: number;
  className?: string;
}

const CaseGallery: React.FC<CaseGalleryProps> = ({
  columns = 4,
  className = ''
}) => {
  const dispatch = useAppDispatch();
  const filteredCases = useAppSelector(selectFilteredCases);
  const isLoading = useAppSelector(selectCasesLoading);
  const filters = useAppSelector(selectFilters);

  // 响应式列数
  const [galleryColumns, setGalleryColumns] = useState(columns);

  // 响应式处理
  useEffect(() => {
    const handleResize = () => {
      const width = window.innerWidth;
      if (width < 768) {
        setGalleryColumns(1);
      } else if (width < 1024) {
        setGalleryColumns(2);
      } else if (width < 1440) {
        setGalleryColumns(3);
      } else {
        setGalleryColumns(columns);
      }
    };

    handleResize();
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, [columns]);

  // 瀑布流布局计算
  const columnizedCases = useMemo(() => {
    const columns: AICase[][] = Array.from({ length: galleryColumns }, () => []);

    filteredCases.forEach((caseItem, index) => {
      const columnIndex = index % galleryColumns;
      columns[columnIndex].push(caseItem);
    });

    return columns;
  }, [filteredCases, galleryColumns]);

  // 案例点击处理
  const handleCaseClick = (caseData: AICase) => {
    dispatch(selectCase(caseData));
    dispatch(setShowCaseDetail(true));
  };

  // 初始化数据
  useEffect(() => {
    dispatch(fetchCases({}));
  }, [dispatch]);

  if (isLoading) {
    return (
      <div className="gallery-loading">
        <div className="loading-spinner"></div>
        <span>加载中...</span>
      </div>
    );
  }

  return (
    <div className={`case-gallery ${className}`}>
      {/* 筛选器 */}
      <div className="gallery-filters">
        <div className="filter-categories">
          {['全部', '前端开发', '后端开发', '移动开发', '数据分析'].map(category => (
            <button
              key={category}
              className={`filter-button ${filters.category === category ? 'active' : ''}`}
              onClick={() => dispatch(setFilters({ category }))}
            >
              {category}
            </button>
          ))}
        </div>

        <div className="filter-search">
          <input
            type="text"
            placeholder="搜索案例..."
            value={filters.keyword}
            onChange={(e) => dispatch(setFilters({ keyword: e.target.value }))}
            className="search-input"
          />
        </div>
      </div>

      {/* 案例网格 */}
      <div
        className="gallery-grid"
        style={{
          display: 'grid',
          gridTemplateColumns: `repeat(${galleryColumns}, 1fr)`,
          gap: '20px',
          padding: '20px 0'
        }}
      >
        {columnizedCases.map((column, columnIndex) => (
          <div key={columnIndex} className="gallery-column">
            {column.map((caseItem) => (
              <CaseCard
                key={caseItem.id}
                caseData={caseItem}
                onClick={() => handleCaseClick(caseItem)}
              />
            ))}
          </div>
        ))}
      </div>

      {/* 空状态 */}
      {filteredCases.length === 0 && !isLoading && (
        <div className="empty-state">
          <div className="empty-icon">📁</div>
          <h3>暂无案例</h3>
          <p>当前筛选条件下没有找到案例</p>
          <button
            onClick={() => dispatch(setFilters({ category: '全部', keyword: '' }))}
            className="reset-filter-btn"
          >
            重置筛选
          </button>
        </div>
      )}
    </div>
  );
};

export default CaseGallery;
```

### 2.2.4 样式优化

**文件路径**: `beilv-agent-web/src/components/CaseCard.css`

```css
.case-card {
  position: relative;
  overflow: hidden;
}

.case-card .media-section {
  position: relative;
  overflow: hidden;
}

.case-card .play-button {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 48px;
  height: 48px;
  background: rgba(0, 0, 0, 0.6);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 16px;
  transition: all 0.3s ease;
  backdrop-filter: blur(4px);
}

.case-card:hover .play-button {
  background: rgba(0, 0, 0, 0.8);
  transform: translate(-50%, -50%) scale(1.1);
}

.play-button-overlay {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 24px;
  height: 24px;
  background: rgba(0, 0, 0, 0.6);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 10px;
}

.video-loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  color: #666;
}

.loading-spinner {
  width: 20px;
  height: 20px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid #3498db;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.gallery-filters {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  gap: 16px;
}

.filter-categories {
  display: flex;
  gap: 8px;
}

.filter-button {
  padding: 8px 16px;
  border: 1px solid #e1e5e9;
  background: white;
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 14px;
}

.filter-button:hover {
  border-color: #3498db;
  color: #3498db;
}

.filter-button.active {
  background: #3498db;
  color: white;
  border-color: #3498db;
}

.search-input {
  padding: 8px 16px;
  border: 1px solid #e1e5e9;
  border-radius: 20px;
  outline: none;
  min-width: 200px;
  font-size: 14px;
}

.search-input:focus {
  border-color: #3498db;
  box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #666;
}

.empty-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.reset-filter-btn {
  padding: 10px 24px;
  background: #3498db;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 16px;
  transition: background 0.2s ease;
}

.reset-filter-btn:hover {
  background: #2980b9;
}

@media (max-width: 768px) {
  .gallery-filters {
    flex-direction: column;
    align-items: stretch;
  }

  .filter-categories {
    flex-wrap: wrap;
  }

  .search-input {
    min-width: auto;
  }
}
```

## 验收标准

1. ✅ MediaDisplay组件支持图片和视频展示
2. ✅ CaseCard组件支持悬停效果和视频预览
3. ✅ 瀑布流布局响应式适配
4. ✅ 筛选和搜索功能正常
5. ✅ 懒加载和性能优化
6. ✅ 空状态和错误处理完善
7. ✅ 移动端适配良好

## 测试要求

- 执行单元测试：`MediaDisplay.test.tsx`, `CaseCard.test.tsx`
- 执行E2E测试：`case-gallery.spec.js`
- 验证媒体展示功能
- 验证交互和响应式设计
- 验证性能和用户体验

## 依赖

- Redux状态管理2.1任务完成
- 案例数据接口可用
- React和相关UI库已安装

## 交付物

- [x] MediaDisplay.tsx 媒体展示组件
- [x] CaseCard.tsx 案例卡片组件
- [x] CaseGallery.tsx 案例画廊组件
- [x] 相应的样式文件和测试
- [x] 响应式设计和性能优化