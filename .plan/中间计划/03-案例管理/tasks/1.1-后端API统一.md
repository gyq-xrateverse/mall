# 1.1 后端API统一

## 目标
将案例管理API统一使用FileStorageService，实现本地文件暂存机制

## 优先级
高

## 改造内容

### 1.1.1 案例Controller增加文件上传接口

**文件路径**: `mall-admin/src/main/java/com/macro/mall/controller/CaseDataController.java`

```java
@RestController
@RequestMapping("/admin/case")
public class CaseDataController {

    @Autowired
    private CaseDataService caseDataService;

    @Autowired
    private FileStorageService fileStorageService;

    @PostMapping("/create")
    public CommonResult<Void> createCase(
            @RequestParam Long categoryId,
            @RequestParam String title,
            @RequestParam(required = false) String content,
            @RequestParam(required = false) String tags,
            @RequestParam(defaultValue = "1") Integer status,
            @RequestParam(defaultValue = "1") Integer showStatus,
            @RequestParam("imageFile") MultipartFile imageFile,
            @RequestParam("videoFile") MultipartFile videoFile) {

        try {
            CaseDataParam param = new CaseDataParam();
            param.setCategoryId(categoryId);
            param.setTitle(title);
            param.setContent(content);
            param.setStatus(status);
            param.setShowStatus(showStatus);

            // 上传图片文件
            FileUploadResult imageResult = fileStorageService.uploadFile(imageFile);
            param.setImage(imageResult.getObjectName());

            // 上传视频文件
            FileUploadResult videoResult = fileStorageService.uploadFile(videoFile);
            param.setVideo(videoResult.getObjectName());

            // 处理标签
            if (StringUtils.hasText(tags)) {
                param.setTagList(Arrays.asList(tags.split(",")));
            }

            caseDataService.create(param);
            return CommonResult.success();

        } catch (Exception e) {
            log.error("创建案例失败", e);
            return CommonResult.failed("创建失败");
        }
    }

    @PostMapping("/update/{id}")
    public CommonResult<Void> updateCase(
            @PathVariable Long id,
            @RequestParam Long categoryId,
            @RequestParam String title,
            @RequestParam(required = false) String content,
            @RequestParam(required = false) String tags,
            @RequestParam(defaultValue = "1") Integer status,
            @RequestParam(defaultValue = "1") Integer showStatus,
            @RequestParam(required = false) MultipartFile imageFile,
            @RequestParam(required = false) MultipartFile videoFile) {

        try {
            CaseData existingCase = caseDataService.getCaseData(id);
            if (existingCase == null) {
                return CommonResult.failed("案例不存在");
            }

            CaseDataParam param = new CaseDataParam();
            param.setCategoryId(categoryId);
            param.setTitle(title);
            param.setContent(content);
            param.setStatus(status);
            param.setShowStatus(showStatus);

            // 处理图片文件
            if (imageFile != null && !imageFile.isEmpty()) {
                // 删除旧图片
                if (StringUtils.hasText(existingCase.getImage())) {
                    fileStorageService.deleteFile(existingCase.getImage());
                }
                // 上传新图片
                FileUploadResult imageResult = fileStorageService.uploadFile(imageFile);
                param.setImage(imageResult.getObjectName());
            } else {
                // 保持原图片
                param.setImage(existingCase.getImage());
            }

            // 处理视频文件
            if (videoFile != null && !videoFile.isEmpty()) {
                // 删除旧视频
                if (StringUtils.hasText(existingCase.getVideo())) {
                    fileStorageService.deleteFile(existingCase.getVideo());
                }
                // 上传新视频
                FileUploadResult videoResult = fileStorageService.uploadFile(videoFile);
                param.setVideo(videoResult.getObjectName());
            } else {
                // 保持原视频
                param.setVideo(existingCase.getVideo());
            }

            // 处理标签
            if (StringUtils.hasText(tags)) {
                param.setTagList(Arrays.asList(tags.split(",")));
            }

            caseDataService.update(id, param);
            return CommonResult.success();

        } catch (Exception e) {
            log.error("更新案例失败", e);
            return CommonResult.failed("更新失败");
        }
    }
}
```

### 1.1.2 文件清理接口

```java
// 清理临时文件接口
@DeleteMapping("/file/temp/{objectName}")
public CommonResult<Boolean> cleanupTempFile(@PathVariable String objectName) {
    try {
        boolean deleted = fileStorageService.deleteFile(objectName);
        return CommonResult.success(deleted);
    } catch (Exception e) {
        log.error("清理临时文件失败: " + objectName, e);
        return CommonResult.failed("清理失败");
    }
}
```

## 验收标准

1. ✅ 案例创建接口支持MultipartFile文件上传
2. ✅ 案例更新接口支持部分文件替换
3. ✅ 文件上传使用FileStorageService
4. ✅ 数据库存储objectName，不存储完整URL
5. ✅ 支持图片和视频两种文件类型
6. ✅ 错误处理完善，文件上传失败时回滚

## 测试要求

- 执行单元测试：`CaseDataControllerIntegrationTest.java`
- 验证文件上传、更新、删除功能
- 验证错误处理和边界条件
- 验证FileStorageService集成正常

## 依赖

- FileStorageService已完成并测试通过
- CaseData实体类字段对应正确
- MultipartFile处理逻辑完善

## 交付物

- [x] CaseDataController.java 修改完成
- [x] 相应的单元测试和集成测试
- [x] API文档更新
- [x] 错误处理机制完善