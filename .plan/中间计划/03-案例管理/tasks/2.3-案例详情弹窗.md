# 2.3 æ¡ˆä¾‹è¯¦æƒ…å¼¹çª—

## ç›®æ ‡
åˆ›å»ºæ¡ˆä¾‹è¯¦æƒ…å¼¹çª—ç»„ä»¶ï¼Œæ”¯æŒå…¨å±è§†é¢‘æ’­æ”¾å’Œå®Œæ•´å†…å®¹å±•ç¤º

## ä¼˜å…ˆçº§
ä¸­

## æ”¹é€ å†…å®¹

### 2.3.1 CaseDetailModalç»„ä»¶åˆ›å»º

**æ–‡ä»¶è·¯å¾„**: `beilv-agent-web/src/components/CaseDetailModal.tsx`

#### ç»„ä»¶æ¥å£è®¾è®¡

```typescript
interface CaseDetailModalProps {
  open: boolean;
  caseData: AICase | null;
  onClose: () => void;
  onNext?: () => void;
  onPrev?: () => void;
  hasNext?: boolean;
  hasPrev?: boolean;
}

const CaseDetailModal: React.FC<CaseDetailModalProps> = ({
  open,
  caseData,
  onClose,
  onNext,
  onPrev,
  hasNext = false,
  hasPrev = false
}) => {
  const [currentMediaType, setCurrentMediaType] = useState<'image' | 'video'>('image');
  const [isVideoLoaded, setIsVideoLoaded] = useState(false);
  const [isFullscreen, setIsFullscreen] = useState(false);
  const videoRef = useRef<HTMLVideoElement>(null);
  const modalRef = useRef<HTMLDivElement>(null);

  // é”®ç›˜å¯¼èˆª
  useEffect(() => {
    const handleKeyPress = (e: KeyboardEvent) => {
      if (!open) return;

      switch (e.key) {
        case 'Escape':
          onClose();
          break;
        case 'ArrowLeft':
          if (hasPrev) onPrev?.();
          break;
        case 'ArrowRight':
          if (hasNext) onNext?.();
          break;
        case ' ':
          e.preventDefault();
          if (caseData?.videoUrl) {
            setCurrentMediaType(currentMediaType === 'image' ? 'video' : 'image');
          }
          break;
      }
    };

    window.addEventListener('keydown', handleKeyPress);
    return () => window.removeEventListener('keydown', handleKeyPress);
  }, [open, currentMediaType, hasNext, hasPrev, onNext, onPrev, onClose, caseData]);

  // å…¨å±å¤„ç†
  const handleFullscreen = () => {
    if (!isFullscreen && modalRef.current) {
      modalRef.current.requestFullscreen?.();
      setIsFullscreen(true);
    }
  };

  const handleExitFullscreen = () => {
    if (document.fullscreenElement) {
      document.exitFullscreen();
      setIsFullscreen(false);
    }
  };

  if (!caseData) return null;

  return (
    <div
      className={`case-detail-modal ${open ? 'open' : ''} ${isFullscreen ? 'fullscreen' : ''}`}
      onClick={(e) => e.target === e.currentTarget && onClose()}
    >
      <div className="modal-content" ref={modalRef}>
        {/* å¤´éƒ¨æ§åˆ¶æ  */}
        <div className="modal-header">
          <div className="header-left">
            <h2 className="case-title">{caseData.title}</h2>
            <div className="case-meta">
              <span className="category">{caseData.category}</span>
              <span className="date">{new Date(caseData.createTime).toLocaleDateString()}</span>
              <span className="views">ğŸ‘ {caseData.viewCount}</span>
              <span className="likes">â¤ {caseData.likeCount}</span>
            </div>
          </div>

          <div className="header-right">
            {/* åª’ä½“åˆ‡æ¢æŒ‰é’® */}
            {caseData.videoUrl && (
              <div className="media-toggle">
                <button
                  className={`toggle-btn ${currentMediaType === 'image' ? 'active' : ''}`}
                  onClick={() => setCurrentMediaType('image')}
                >
                  ğŸ“· å›¾ç‰‡
                </button>
                <button
                  className={`toggle-btn ${currentMediaType === 'video' ? 'active' : ''}`}
                  onClick={() => setCurrentMediaType('video')}
                >
                  ğŸ¥ è§†é¢‘
                </button>
              </div>
            )}

            {/* å…¨å±æŒ‰é’® */}
            {!isFullscreen ? (
              <button className="fullscreen-btn" onClick={handleFullscreen}>
                â›¶
              </button>
            ) : (
              <button className="fullscreen-btn" onClick={handleExitFullscreen}>
                âš¬
              </button>
            )}

            {/* å…³é—­æŒ‰é’® */}
            <button className="close-btn" onClick={onClose}>
              âœ•
            </button>
          </div>
        </div>

        {/* åª’ä½“å±•ç¤ºåŒºåŸŸ */}
        <div className="modal-body">
          <div className="media-container">
            {currentMediaType === 'image' || !caseData.videoUrl ? (
              // å›¾ç‰‡å±•ç¤º
              <div className="image-display">
                <img
                  src={caseData.imageUrl}
                  alt={caseData.title}
                  style={{
                    width: '100%',
                    height: '100%',
                    objectFit: 'contain'
                  }}
                />
              </div>
            ) : (
              // è§†é¢‘å±•ç¤º
              <div className="video-display">
                <video
                  ref={videoRef}
                  poster={caseData.imageUrl}
                  controls
                  autoPlay={currentMediaType === 'video'}
                  onLoadedData={() => setIsVideoLoaded(true)}
                  style={{
                    width: '100%',
                    height: '100%',
                    objectFit: 'contain'
                  }}
                >
                  <source src={caseData.videoUrl} type="video/mp4" />
                  æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                </video>

                {!isVideoLoaded && (
                  <div className="video-loading">
                    <div className="loading-spinner"></div>
                    <span>è§†é¢‘åŠ è½½ä¸­...</span>
                  </div>
                )}
              </div>
            )}

            {/* å¯¼èˆªæŒ‰é’® */}
            {hasPrev && (
              <button className="nav-btn prev-btn" onClick={onPrev}>
                â€¹
              </button>
            )}
            {hasNext && (
              <button className="nav-btn next-btn" onClick={onNext}>
                â€º
              </button>
            )}
          </div>

          {/* æ¡ˆä¾‹ä¿¡æ¯é¢æ¿ */}
          <div className="info-panel">
            {/* æ¡ˆä¾‹æè¿° */}
            {caseData.content && (
              <div className="content-section">
                <h3>æ¡ˆä¾‹ä»‹ç»</h3>
                <p className="content-text">{caseData.content}</p>
              </div>
            )}

            {/* æ ‡ç­¾ */}
            {caseData.tagList && caseData.tagList.length > 0 && (
              <div className="tags-section">
                <h3>ç›¸å…³æ ‡ç­¾</h3>
                <div className="tags-container">
                  {caseData.tagList.map((tag, index) => (
                    <span key={index} className="tag-item">
                      {tag}
                    </span>
                  ))}
                </div>
              </div>
            )}

            {/* æ“ä½œæŒ‰é’® */}
            <div className="actions-section">
              <button className="action-btn like-btn">
                â¤ ç‚¹èµ ({caseData.likeCount})
              </button>
              <button className="action-btn share-btn">
                ğŸ“¤ åˆ†äº«
              </button>
              <button className="action-btn download-btn">
                ğŸ’¾ æ”¶è—
              </button>
            </div>
          </div>
        </div>

        {/* åº•éƒ¨æç¤º */}
        <div className="modal-footer">
          <div className="keyboard-hints">
            <span>ESC: å…³é—­</span>
            <span>ç©ºæ ¼: åˆ‡æ¢åª’ä½“</span>
            <span>â† â†’: åˆ‡æ¢æ¡ˆä¾‹</span>
          </div>
        </div>
      </div>
    </div>
  );
};

export default CaseDetailModal;
```

### 2.3.2 CaseGalleryé›†æˆè¯¦æƒ…å¼¹çª—

**æ–‡ä»¶è·¯å¾„**: `beilv-agent-web/src/components/CaseGallery.tsx`

```typescript
// åœ¨CaseGalleryç»„ä»¶ä¸­é›†æˆè¯¦æƒ…å¼¹çª—
import CaseDetailModal from './CaseDetailModal';

const CaseGallery: React.FC<CaseGalleryProps> = ({ columns = 4, className = '' }) => {
  // ... åŸæœ‰çŠ¶æ€
  const [selectedCaseIndex, setSelectedCaseIndex] = useState<number>(-1);

  // æ¡ˆä¾‹ç‚¹å‡»å¤„ç† - ä¿®æ”¹ä¸ºæ‰“å¼€è¯¦æƒ…å¼¹çª—
  const handleCaseClick = (caseData: AICase) => {
    const index = filteredCases.findIndex(c => c.id === caseData.id);
    setSelectedCaseIndex(index);
    dispatch(selectCase(caseData));
    dispatch(setShowCaseDetail(true));
  };

  // å¼¹çª—å…³é—­å¤„ç†
  const handleCloseModal = () => {
    setSelectedCaseIndex(-1);
    dispatch(setShowCaseDetail(false));
    dispatch(selectCase(null));
  };

  // ä¸‹ä¸€ä¸ªæ¡ˆä¾‹
  const handleNextCase = () => {
    if (selectedCaseIndex < filteredCases.length - 1) {
      const nextIndex = selectedCaseIndex + 1;
      setSelectedCaseIndex(nextIndex);
      dispatch(selectCase(filteredCases[nextIndex]));
    }
  };

  // ä¸Šä¸€ä¸ªæ¡ˆä¾‹
  const handlePrevCase = () => {
    if (selectedCaseIndex > 0) {
      const prevIndex = selectedCaseIndex - 1;
      setSelectedCaseIndex(prevIndex);
      dispatch(selectCase(filteredCases[prevIndex]));
    }
  };

  return (
    <div className={`case-gallery ${className}`}>
      {/* ... åŸæœ‰ç­›é€‰å™¨å’Œç½‘æ ¼ä»£ç  */}

      {/* æ¡ˆä¾‹è¯¦æƒ…å¼¹çª— */}
      <CaseDetailModal
        open={showCaseDetail}
        caseData={selectedCase}
        onClose={handleCloseModal}
        onNext={handleNextCase}
        onPrev={handlePrevCase}
        hasNext={selectedCaseIndex < filteredCases.length - 1}
        hasPrev={selectedCaseIndex > 0}
      />
    </div>
  );
};
```

### 2.3.3 æ ·å¼ä¼˜åŒ–

**æ–‡ä»¶è·¯å¾„**: `beilv-agent-web/src/components/CaseDetailModal.css`

```css
.case-detail-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.9);
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.case-detail-modal.open {
  opacity: 1;
  visibility: visible;
}

.case-detail-modal.fullscreen {
  background: black;
}

.modal-content {
  position: relative;
  width: 90vw;
  height: 90vh;
  margin: 5vh auto;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.case-detail-modal.fullscreen .modal-content {
  width: 100vw;
  height: 100vh;
  margin: 0;
  border-radius: 0;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  border-bottom: 1px solid #e1e5e9;
  background: white;
}

.header-left .case-title {
  margin: 0 0 8px 0;
  font-size: 20px;
  font-weight: 600;
  color: #1a1a1a;
}

.case-meta {
  display: flex;
  gap: 16px;
  font-size: 14px;
  color: #666;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.media-toggle {
  display: flex;
  background: #f5f5f5;
  border-radius: 6px;
  overflow: hidden;
}

.toggle-btn {
  padding: 8px 16px;
  border: none;
  background: transparent;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
}

.toggle-btn.active {
  background: #3498db;
  color: white;
}

.fullscreen-btn,
.close-btn {
  width: 36px;
  height: 36px;
  border: none;
  background: #f5f5f5;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.2s ease;
}

.fullscreen-btn:hover,
.close-btn:hover {
  background: #e1e5e9;
}

.modal-body {
  flex: 1;
  display: flex;
  overflow: hidden;
}

.media-container {
  flex: 2;
  position: relative;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.image-display,
.video-display {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.nav-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 48px;
  height: 48px;
  border: none;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 50%;
  cursor: pointer;
  font-size: 24px;
  font-weight: bold;
  color: #333;
  transition: all 0.2s ease;
}

.nav-btn:hover {
  background: white;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.prev-btn {
  left: 20px;
}

.next-btn {
  right: 20px;
}

.info-panel {
  flex: 1;
  padding: 24px;
  overflow-y: auto;
  background: #fafafa;
}

.content-section,
.tags-section,
.actions-section {
  margin-bottom: 24px;
}

.content-section h3,
.tags-section h3 {
  margin: 0 0 12px 0;
  font-size: 16px;
  font-weight: 600;
  color: #1a1a1a;
}

.content-text {
  line-height: 1.6;
  color: #333;
  margin: 0;
}

.tags-container {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.tag-item {
  display: inline-block;
  padding: 6px 12px;
  background: white;
  border: 1px solid #e1e5e9;
  border-radius: 16px;
  font-size: 12px;
  color: #666;
}

.actions-section {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.action-btn {
  padding: 12px;
  border: 1px solid #e1e5e9;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  text-align: left;
  transition: all 0.2s ease;
  font-size: 14px;
}

.action-btn:hover {
  border-color: #3498db;
  color: #3498db;
}

.modal-footer {
  padding: 12px 24px;
  border-top: 1px solid #e1e5e9;
  background: #f9f9f9;
}

.keyboard-hints {
  display: flex;
  gap: 16px;
  font-size: 12px;
  color: #666;
}

.video-loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  color: white;
}

.loading-spinner {
  width: 32px;
  height: 32px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-top: 3px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ç§»åŠ¨ç«¯é€‚é… */
@media (max-width: 768px) {
  .modal-content {
    width: 100vw;
    height: 100vh;
    margin: 0;
    border-radius: 0;
  }

  .modal-body {
    flex-direction: column;
  }

  .media-container {
    flex: 1;
  }

  .info-panel {
    flex: 0 0 auto;
    max-height: 40vh;
  }

  .nav-btn {
    width: 40px;
    height: 40px;
    font-size: 20px;
  }

  .prev-btn {
    left: 12px;
  }

  .next-btn {
    right: 12px;
  }
}
```

## éªŒæ”¶æ ‡å‡†

1. âœ… è¯¦æƒ…å¼¹çª—æ”¯æŒå›¾ç‰‡å’Œè§†é¢‘åˆ‡æ¢å±•ç¤º
2. âœ… æ”¯æŒé”®ç›˜å¯¼èˆªï¼ˆESCå…³é—­ã€ç©ºæ ¼åˆ‡æ¢ã€æ–¹å‘é”®å¯¼èˆªï¼‰
3. âœ… æ”¯æŒå…¨å±æ¨¡å¼æŸ¥çœ‹
4. âœ… å¼¹çª—ä¸­å¯æµè§ˆä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ªæ¡ˆä¾‹
5. âœ… å“åº”å¼è®¾è®¡ï¼Œç§»åŠ¨ç«¯å‹å¥½
6. âœ… æ¡ˆä¾‹ä¿¡æ¯å®Œæ•´å±•ç¤ºï¼ˆæ ‡é¢˜ã€å†…å®¹ã€æ ‡ç­¾ç­‰ï¼‰
7. âœ… äº¤äº’æµç•…ï¼Œè¿‡æ¸¡åŠ¨ç”»è‡ªç„¶

## æµ‹è¯•è¦æ±‚

- æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼š`CaseDetailModal.test.tsx`
- æ‰§è¡ŒE2Eæµ‹è¯•ï¼š`case-detail-modal.spec.js`
- éªŒè¯å¼¹çª—æ‰“å¼€ã€å…³é—­ã€å¯¼èˆªåŠŸèƒ½
- éªŒè¯åª’ä½“åˆ‡æ¢å’Œå…¨å±åŠŸèƒ½
- éªŒè¯é”®ç›˜å¿«æ·é”®åŠŸèƒ½
- éªŒè¯ç§»åŠ¨ç«¯é€‚é…

## ä¾èµ–

- ReduxçŠ¶æ€ç®¡ç†2.1ä»»åŠ¡å®Œæˆ
- æ¡ˆä¾‹å±•ç¤ºç»„ä»¶2.2ä»»åŠ¡å®Œæˆ
- é”®ç›˜äº‹ä»¶ç›‘å¬å™¨æ­£å¸¸å·¥ä½œ

## äº¤ä»˜ç‰©

- [x] CaseDetailModal.tsx è¯¦æƒ…å¼¹çª—ç»„ä»¶
- [x] CaseGallery.tsx é›†æˆå¼¹çª—åŠŸèƒ½
- [x] ç›¸åº”çš„æ ·å¼æ–‡ä»¶å’Œæµ‹è¯•
- [x] é”®ç›˜å¯¼èˆªå’Œå…¨å±åŠŸèƒ½å®ç°
- [x] ç§»åŠ¨ç«¯é€‚é…å’Œç”¨æˆ·ä½“éªŒä¼˜åŒ–