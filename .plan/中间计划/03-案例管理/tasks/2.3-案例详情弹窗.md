# 2.3 案例详情弹窗

## 目标
创建案例详情弹窗组件，支持全屏视频播放和完整内容展示

## 优先级
中

## 改造内容

### 2.3.1 CaseDetailModal组件创建

**文件路径**: `beilv-agent-web/src/components/CaseDetailModal.tsx`

#### 组件接口设计

```typescript
interface CaseDetailModalProps {
  open: boolean;
  caseData: AICase | null;
  onClose: () => void;
  onNext?: () => void;
  onPrev?: () => void;
  hasNext?: boolean;
  hasPrev?: boolean;
}

const CaseDetailModal: React.FC<CaseDetailModalProps> = ({
  open,
  caseData,
  onClose,
  onNext,
  onPrev,
  hasNext = false,
  hasPrev = false
}) => {
  const [currentMediaType, setCurrentMediaType] = useState<'image' | 'video'>('image');
  const [isVideoLoaded, setIsVideoLoaded] = useState(false);
  const [isFullscreen, setIsFullscreen] = useState(false);
  const videoRef = useRef<HTMLVideoElement>(null);
  const modalRef = useRef<HTMLDivElement>(null);

  // 键盘导航
  useEffect(() => {
    const handleKeyPress = (e: KeyboardEvent) => {
      if (!open) return;

      switch (e.key) {
        case 'Escape':
          onClose();
          break;
        case 'ArrowLeft':
          if (hasPrev) onPrev?.();
          break;
        case 'ArrowRight':
          if (hasNext) onNext?.();
          break;
        case ' ':
          e.preventDefault();
          if (caseData?.videoUrl) {
            setCurrentMediaType(currentMediaType === 'image' ? 'video' : 'image');
          }
          break;
      }
    };

    window.addEventListener('keydown', handleKeyPress);
    return () => window.removeEventListener('keydown', handleKeyPress);
  }, [open, currentMediaType, hasNext, hasPrev, onNext, onPrev, onClose, caseData]);

  // 全屏处理
  const handleFullscreen = () => {
    if (!isFullscreen && modalRef.current) {
      modalRef.current.requestFullscreen?.();
      setIsFullscreen(true);
    }
  };

  const handleExitFullscreen = () => {
    if (document.fullscreenElement) {
      document.exitFullscreen();
      setIsFullscreen(false);
    }
  };

  if (!caseData) return null;

  return (
    <div
      className={`case-detail-modal ${open ? 'open' : ''} ${isFullscreen ? 'fullscreen' : ''}`}
      onClick={(e) => e.target === e.currentTarget && onClose()}
    >
      <div className="modal-content" ref={modalRef}>
        {/* 头部控制栏 */}
        <div className="modal-header">
          <div className="header-left">
            <h2 className="case-title">{caseData.title}</h2>
            <div className="case-meta">
              <span className="category">{caseData.category}</span>
              <span className="date">{new Date(caseData.createTime).toLocaleDateString()}</span>
              <span className="views">👁 {caseData.viewCount}</span>
              <span className="likes">❤ {caseData.likeCount}</span>
            </div>
          </div>

          <div className="header-right">
            {/* 媒体切换按钮 */}
            {caseData.videoUrl && (
              <div className="media-toggle">
                <button
                  className={`toggle-btn ${currentMediaType === 'image' ? 'active' : ''}`}
                  onClick={() => setCurrentMediaType('image')}
                >
                  📷 图片
                </button>
                <button
                  className={`toggle-btn ${currentMediaType === 'video' ? 'active' : ''}`}
                  onClick={() => setCurrentMediaType('video')}
                >
                  🎥 视频
                </button>
              </div>
            )}

            {/* 全屏按钮 */}
            {!isFullscreen ? (
              <button className="fullscreen-btn" onClick={handleFullscreen}>
                ⛶
              </button>
            ) : (
              <button className="fullscreen-btn" onClick={handleExitFullscreen}>
                ⚬
              </button>
            )}

            {/* 关闭按钮 */}
            <button className="close-btn" onClick={onClose}>
              ✕
            </button>
          </div>
        </div>

        {/* 媒体展示区域 */}
        <div className="modal-body">
          <div className="media-container">
            {currentMediaType === 'image' || !caseData.videoUrl ? (
              // 图片展示
              <div className="image-display">
                <img
                  src={caseData.imageUrl}
                  alt={caseData.title}
                  style={{
                    width: '100%',
                    height: '100%',
                    objectFit: 'contain'
                  }}
                />
              </div>
            ) : (
              // 视频展示
              <div className="video-display">
                <video
                  ref={videoRef}
                  poster={caseData.imageUrl}
                  controls
                  autoPlay={currentMediaType === 'video'}
                  onLoadedData={() => setIsVideoLoaded(true)}
                  style={{
                    width: '100%',
                    height: '100%',
                    objectFit: 'contain'
                  }}
                >
                  <source src={caseData.videoUrl} type="video/mp4" />
                  您的浏览器不支持视频播放。
                </video>

                {!isVideoLoaded && (
                  <div className="video-loading">
                    <div className="loading-spinner"></div>
                    <span>视频加载中...</span>
                  </div>
                )}
              </div>
            )}

            {/* 导航按钮 */}
            {hasPrev && (
              <button className="nav-btn prev-btn" onClick={onPrev}>
                ‹
              </button>
            )}
            {hasNext && (
              <button className="nav-btn next-btn" onClick={onNext}>
                ›
              </button>
            )}
          </div>

          {/* 案例信息面板 */}
          <div className="info-panel">
            {/* 案例描述 */}
            {caseData.content && (
              <div className="content-section">
                <h3>案例介绍</h3>
                <p className="content-text">{caseData.content}</p>
              </div>
            )}

            {/* 标签 */}
            {caseData.tagList && caseData.tagList.length > 0 && (
              <div className="tags-section">
                <h3>相关标签</h3>
                <div className="tags-container">
                  {caseData.tagList.map((tag, index) => (
                    <span key={index} className="tag-item">
                      {tag}
                    </span>
                  ))}
                </div>
              </div>
            )}

            {/* 操作按钮 */}
            <div className="actions-section">
              <button className="action-btn like-btn">
                ❤ 点赞 ({caseData.likeCount})
              </button>
              <button className="action-btn share-btn">
                📤 分享
              </button>
              <button className="action-btn download-btn">
                💾 收藏
              </button>
            </div>
          </div>
        </div>

        {/* 底部提示 */}
        <div className="modal-footer">
          <div className="keyboard-hints">
            <span>ESC: 关闭</span>
            <span>空格: 切换媒体</span>
            <span>← →: 切换案例</span>
          </div>
        </div>
      </div>
    </div>
  );
};

export default CaseDetailModal;
```

### 2.3.2 CaseGallery集成详情弹窗

**文件路径**: `beilv-agent-web/src/components/CaseGallery.tsx`

```typescript
// 在CaseGallery组件中集成详情弹窗
import CaseDetailModal from './CaseDetailModal';

const CaseGallery: React.FC<CaseGalleryProps> = ({ columns = 4, className = '' }) => {
  // ... 原有状态
  const [selectedCaseIndex, setSelectedCaseIndex] = useState<number>(-1);

  // 案例点击处理 - 修改为打开详情弹窗
  const handleCaseClick = (caseData: AICase) => {
    const index = filteredCases.findIndex(c => c.id === caseData.id);
    setSelectedCaseIndex(index);
    dispatch(selectCase(caseData));
    dispatch(setShowCaseDetail(true));
  };

  // 弹窗关闭处理
  const handleCloseModal = () => {
    setSelectedCaseIndex(-1);
    dispatch(setShowCaseDetail(false));
    dispatch(selectCase(null));
  };

  // 下一个案例
  const handleNextCase = () => {
    if (selectedCaseIndex < filteredCases.length - 1) {
      const nextIndex = selectedCaseIndex + 1;
      setSelectedCaseIndex(nextIndex);
      dispatch(selectCase(filteredCases[nextIndex]));
    }
  };

  // 上一个案例
  const handlePrevCase = () => {
    if (selectedCaseIndex > 0) {
      const prevIndex = selectedCaseIndex - 1;
      setSelectedCaseIndex(prevIndex);
      dispatch(selectCase(filteredCases[prevIndex]));
    }
  };

  return (
    <div className={`case-gallery ${className}`}>
      {/* ... 原有筛选器和网格代码 */}

      {/* 案例详情弹窗 */}
      <CaseDetailModal
        open={showCaseDetail}
        caseData={selectedCase}
        onClose={handleCloseModal}
        onNext={handleNextCase}
        onPrev={handlePrevCase}
        hasNext={selectedCaseIndex < filteredCases.length - 1}
        hasPrev={selectedCaseIndex > 0}
      />
    </div>
  );
};
```

### 2.3.3 样式优化

**文件路径**: `beilv-agent-web/src/components/CaseDetailModal.css`

```css
.case-detail-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.9);
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.case-detail-modal.open {
  opacity: 1;
  visibility: visible;
}

.case-detail-modal.fullscreen {
  background: black;
}

.modal-content {
  position: relative;
  width: 90vw;
  height: 90vh;
  margin: 5vh auto;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.case-detail-modal.fullscreen .modal-content {
  width: 100vw;
  height: 100vh;
  margin: 0;
  border-radius: 0;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  border-bottom: 1px solid #e1e5e9;
  background: white;
}

.header-left .case-title {
  margin: 0 0 8px 0;
  font-size: 20px;
  font-weight: 600;
  color: #1a1a1a;
}

.case-meta {
  display: flex;
  gap: 16px;
  font-size: 14px;
  color: #666;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.media-toggle {
  display: flex;
  background: #f5f5f5;
  border-radius: 6px;
  overflow: hidden;
}

.toggle-btn {
  padding: 8px 16px;
  border: none;
  background: transparent;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
}

.toggle-btn.active {
  background: #3498db;
  color: white;
}

.fullscreen-btn,
.close-btn {
  width: 36px;
  height: 36px;
  border: none;
  background: #f5f5f5;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.2s ease;
}

.fullscreen-btn:hover,
.close-btn:hover {
  background: #e1e5e9;
}

.modal-body {
  flex: 1;
  display: flex;
  overflow: hidden;
}

.media-container {
  flex: 2;
  position: relative;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.image-display,
.video-display {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.nav-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 48px;
  height: 48px;
  border: none;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 50%;
  cursor: pointer;
  font-size: 24px;
  font-weight: bold;
  color: #333;
  transition: all 0.2s ease;
}

.nav-btn:hover {
  background: white;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.prev-btn {
  left: 20px;
}

.next-btn {
  right: 20px;
}

.info-panel {
  flex: 1;
  padding: 24px;
  overflow-y: auto;
  background: #fafafa;
}

.content-section,
.tags-section,
.actions-section {
  margin-bottom: 24px;
}

.content-section h3,
.tags-section h3 {
  margin: 0 0 12px 0;
  font-size: 16px;
  font-weight: 600;
  color: #1a1a1a;
}

.content-text {
  line-height: 1.6;
  color: #333;
  margin: 0;
}

.tags-container {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.tag-item {
  display: inline-block;
  padding: 6px 12px;
  background: white;
  border: 1px solid #e1e5e9;
  border-radius: 16px;
  font-size: 12px;
  color: #666;
}

.actions-section {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.action-btn {
  padding: 12px;
  border: 1px solid #e1e5e9;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  text-align: left;
  transition: all 0.2s ease;
  font-size: 14px;
}

.action-btn:hover {
  border-color: #3498db;
  color: #3498db;
}

.modal-footer {
  padding: 12px 24px;
  border-top: 1px solid #e1e5e9;
  background: #f9f9f9;
}

.keyboard-hints {
  display: flex;
  gap: 16px;
  font-size: 12px;
  color: #666;
}

.video-loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  color: white;
}

.loading-spinner {
  width: 32px;
  height: 32px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-top: 3px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* 移动端适配 */
@media (max-width: 768px) {
  .modal-content {
    width: 100vw;
    height: 100vh;
    margin: 0;
    border-radius: 0;
  }

  .modal-body {
    flex-direction: column;
  }

  .media-container {
    flex: 1;
  }

  .info-panel {
    flex: 0 0 auto;
    max-height: 40vh;
  }

  .nav-btn {
    width: 40px;
    height: 40px;
    font-size: 20px;
  }

  .prev-btn {
    left: 12px;
  }

  .next-btn {
    right: 12px;
  }
}
```

## 验收标准

1. ✅ 详情弹窗支持图片和视频切换展示
2. ✅ 支持键盘导航（ESC关闭、空格切换、方向键导航）
3. ✅ 支持全屏模式查看
4. ✅ 弹窗中可浏览上一个/下一个案例
5. ✅ 响应式设计，移动端友好
6. ✅ 案例信息完整展示（标题、内容、标签等）
7. ✅ 交互流畅，过渡动画自然

## 测试要求

- 执行单元测试：`CaseDetailModal.test.tsx`
- 执行E2E测试：`case-detail-modal.spec.js`
- 验证弹窗打开、关闭、导航功能
- 验证媒体切换和全屏功能
- 验证键盘快捷键功能
- 验证移动端适配

## 依赖

- Redux状态管理2.1任务完成
- 案例展示组件2.2任务完成
- 键盘事件监听器正常工作

## 交付物

- [x] CaseDetailModal.tsx 详情弹窗组件
- [x] CaseGallery.tsx 集成弹窗功能
- [x] 相应的样式文件和测试
- [x] 键盘导航和全屏功能实现
- [x] 移动端适配和用户体验优化