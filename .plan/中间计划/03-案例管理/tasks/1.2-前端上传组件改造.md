# 1.2 前端上传组件改造

## 目标
改造Vue案例编辑组件，实现本地文件暂存和统一提交机制

## 优先级
高

## 改造内容

### 1.2.1 CaseDataDetail组件改造

**文件路径**: `mall-admin-web/src/views/case/data/components/CaseDataDetail.vue`

#### 数据模型设计（严格对应CaseData实体）

```javascript
data() {
  return {
    // 严格按照CaseData实体字段
    caseData: {
      id: null,
      categoryId: null,        // 分类ID
      title: '',              // 案例标题
      content: '',            // 案例内容
      image: '',              // 图片ObjectName
      video: '',              // 视频ObjectName
      tags: '',               // 标签字符串，逗号分隔
      status: 1,              // 状态
      showStatus: 1           // 显示状态
    },

    // 前端辅助字段（不提交到后端）
    tagList: [],              // 标签数组，用于前端编辑
    imageFile: null,          // 本地暂存的图片文件
    videoFile: null,          // 本地暂存的视频文件
    imagePreviewUrl: '',      // 图片预览URL
    videoPreviewUrl: '',      // 视频预览URL
    submitting: false
  }
}
```

#### 本地文件暂存逻辑

```javascript
methods: {
  // 图片选择处理
  beforeImageUpload(file) {
    const isImage = /\.(jpg|jpeg|png|gif)$/i.test(file.name)
    const isLt10M = file.size / 1024 / 1024 < 10

    if (!isImage) {
      this.$message.error('只能上传jpg、png、gif格式的图片')
      return false
    }
    if (!isLt10M) {
      this.$message.error('图片大小不能超过10MB')
      return false
    }

    this.imageFile = file
    this.imagePreviewUrl = URL.createObjectURL(file)
    return false // 阻止自动上传
  },

  // 视频选择处理
  beforeVideoUpload(file) {
    const isVideo = /\.(mp4|avi|mov|mkv|wmv)$/i.test(file.name)
    const isLt500M = file.size / 1024 / 1024 < 500

    if (!isVideo) {
      this.$message.error('只能上传mp4、avi、mov等格式的视频')
      return false
    }
    if (!isLt500M) {
      this.$message.error('视频大小不能超过500MB')
      return false
    }

    this.videoFile = file
    this.videoPreviewUrl = URL.createObjectURL(file)
    return false // 阻止自动上传
  }
}
```

#### 统一提交逻辑

```javascript
// 提交表单
async handleSubmit() {
  try {
    await this.$refs.caseForm.validate()

    if (!this.isEdit && (!this.imageFile || !this.videoFile)) {
      this.$message.error('请选择图片和视频文件')
      return
    }

    this.submitting = true

    // 准备提交数据
    const formData = new FormData()

    // 添加表单字段
    formData.append('categoryId', this.caseData.categoryId)
    formData.append('title', this.caseData.title)
    formData.append('content', this.caseData.content || '')
    formData.append('tags', this.tagList.join(',')) // 转换为逗号分隔字符串
    formData.append('status', this.caseData.status)
    formData.append('showStatus', this.caseData.showStatus)

    // 添加文件（如果有选择）
    if (this.imageFile) {
      formData.append('imageFile', this.imageFile)
    }
    if (this.videoFile) {
      formData.append('videoFile', this.videoFile)
    }

    // 提交到后端
    if (this.isEdit) {
      formData.append('id', this.caseData.id)
      await this.updateCase(formData)
    } else {
      await this.createCase(formData)
    }

    this.$message.success(this.isEdit ? '更新成功' : '创建成功')
    this.$emit('success')

  } catch (error) {
    console.error('提交失败:', error)
    this.$message.error('提交失败')
  } finally {
    this.submitting = false
  }
}
```

### 1.2.2 模板改造

```vue
<template>
  <div class="case-data-detail">
    <el-form :model="caseData" :rules="rules" ref="caseForm" label-width="120px">

      <!-- 基础信息 -->
      <el-form-item label="案例标题：" prop="title">
        <el-input v-model="caseData.title" placeholder="请输入案例标题"></el-input>
      </el-form-item>

      <el-form-item label="案例分类：" prop="categoryId">
        <el-select v-model="caseData.categoryId" placeholder="请选择案例分类">
          <el-option
            v-for="category in categories"
            :key="category.id"
            :label="category.name"
            :value="category.id">
          </el-option>
        </el-select>
      </el-form-item>

      <!-- 图片上传（本地暂存） -->
      <el-form-item label="案例图片：" prop="image">
        <div class="upload-section">
          <el-upload
            :show-file-list="false"
            :before-upload="beforeImageUpload"
            action=""
            :auto-upload="false">
            <el-button size="small" type="primary">选择图片</el-button>
          </el-upload>

          <!-- 图片预览 -->
          <div v-if="imagePreviewUrl || caseData.image" class="preview-container">
            <img
              :src="imagePreviewUrl || buildUrl(caseData.image)"
              style="width: 200px; height: 150px; object-fit: cover; border-radius: 4px;"
            />
            <div class="preview-actions">
              <el-button size="mini" @click="removeImage">删除</el-button>
            </div>
          </div>
        </div>
        <div class="input-tip">用于列表展示的图片，支持jpg、png格式，不超过10MB</div>
      </el-form-item>

      <!-- 视频上传（本地暂存） -->
      <el-form-item label="案例视频：" prop="video">
        <div class="upload-section">
          <el-upload
            :show-file-list="false"
            :before-upload="beforeVideoUpload"
            action=""
            :auto-upload="false">
            <el-button size="small" type="primary">选择视频</el-button>
          </el-upload>

          <!-- 视频预览 -->
          <div v-if="videoPreviewUrl || caseData.video" class="preview-container">
            <video
              :src="videoPreviewUrl || buildUrl(caseData.video)"
              style="width: 300px; height: 200px;"
              controls>
            </video>
            <div class="preview-actions">
              <el-button size="mini" @click="removeVideo">删除</el-button>
            </div>
          </div>
        </div>
        <div class="input-tip">点击预览的视频文件，支持mp4、avi、mov格式，不超过500MB</div>
      </el-form-item>

      <!-- 其他表单字段... -->

      <!-- 提交按钮 -->
      <el-form-item>
        <el-button type="primary" @click="handleSubmit" :loading="submitting">
          {{ isEdit ? '更新案例' : '创建案例' }}
        </el-button>
        <el-button @click="handleCancel">取消</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>
```

## 验收标准

1. ✅ 文件选择后仅本地暂存，不立即上传
2. ✅ 支持图片和视频预览功能
3. ✅ 点击提交时统一上传文件和数据
4. ✅ 编辑模式只上传修改的文件
5. ✅ 表单验证包含文件格式和大小限制
6. ✅ 数据模型严格对应CaseData实体字段
7. ✅ 标签处理：前端数组 ↔ 后端逗号分隔字符串

## 测试要求

- 执行单元测试：`CaseDataDetail.spec.js`
- 执行E2E测试：`case-data-management.spec.js`
- 验证文件暂存、预览、替换、删除功能
- 验证表单提交和验证逻辑
- 验证编辑模式数据加载

## 依赖

- 后端1.1任务完成，API接口可用
- Element UI上传组件配置正确
- 文件预览功能浏览器兼容

## 交付物

- [x] CaseDataDetail.vue 组件改造完成
- [x] 相应的单元测试和E2E测试
- [x] 文件预览样式和交互优化
- [x] 错误处理和用户提示完善