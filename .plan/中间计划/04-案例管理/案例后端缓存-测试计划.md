# 案例后端缓存功能测试计划

## 🎯 测试目标
对案例后端缓存计划中实现的所有功能进行全面的单元测试和集成测试，确保缓存同步机制的正确性、安全性和可靠性。

## 📋 测试范围

### 1. 管理端缓存服务测试
- **CaseCacheServiceImpl** - 缓存CRUD操作和消息发布
- **CacheKeyConstants** - 缓存键常量管理
- **CacheSecurityGuard** - 安全防护机制
- **CacheFailureRecovery** - 故障恢复机制

### 2. 门户端缓存服务测试
- **PortalCaseCacheServiceImpl** - 门户端缓存操作
- **CacheUpdateListener** - 消息监听和处理

### 3. 控制器层测试
- **CaseDataController** - 案例管理操作后的缓存清理
- **CacheMonitorController** - 缓存监控接口

### 4. 消息机制测试
- **Redis发布/订阅** - 消息发布和监听
- **CacheUpdateMessage** - 消息格式和序列化

### 5. 集成测试
- **端到端缓存同步** - 管理端到门户端的完整流程
- **故障场景测试** - Redis故障时的降级和恢复

## 🧪 测试分类

### Unit Tests (单元测试)
- 测试单个组件的功能
- Mock外部依赖
- 覆盖率目标: 90%+

### Integration Tests (集成测试)
- 测试组件间交互
- 使用真实Redis环境
- 覆盖主要业务流程

### Security Tests (安全测试)
- 权限验证测试
- 频率限制测试
- 恶意输入测试

### Performance Tests (性能测试)
- 缓存操作性能
- 消息发布/订阅延迟
- 高并发场景

## 📊 测试用例清单

### 1. CaseCacheServiceImpl 测试
- [x] 基础缓存CRUD操作
- [x] 批量缓存清理
- [x] 消息发布功能
- [x] 安全验证集成
- [x] 异常处理

### 2. CacheSecurityGuard 测试
- [x] 权限验证
- [x] 频率限制
- [x] 消息来源验证
- [x] 安全事件记录

### 3. CacheUpdateListener 测试
- [x] 消息接收和解析
- [x] 不同操作类型处理
- [x] 消息安全验证
- [x] 异常容错

### 4. CacheMonitorController 测试
- [x] 缓存健康检查
- [x] 统计信息获取
- [x] 缓存清理操作
- [x] 测试消息发布

### 5. CacheFailureRecovery 测试
- [x] Redis故障检测
- [x] 自动恢复机制
- [x] 降级策略
- [x] 健康检查调度

### 6. 端到端集成测试
- [x] 案例创建缓存同步
- [x] 案例更新缓存同步
- [x] 案例删除缓存同步
- [x] 批量操作缓存同步
- [x] 状态更新缓存同步

## 🔧 测试环境要求

### 基础环境
```yaml
# 测试环境配置
spring:
  profiles:
    active: test
  redis:
    host: localhost
    port: 6379
    database: 15  # 使用独立的测试数据库
    timeout: 3000
    lettuce:
      pool:
        max-active: 8
        max-wait: -1ms
        max-idle: 8
        min-idle: 0

# 测试专用配置
redis:
  database: test_mall
  key:
    case: 'test_case'
  expire:
    common: 60    # 测试环境缩短过期时间
    case: 30

# 安全配置
cache:
  security:
    rate-limit:
      max-per-minute: 10  # 降低限制便于测试
      max-per-hour: 100
```

### Mock配置
```java
@TestConfiguration
public class CacheTestConfig {

    @Bean
    @Primary
    public RedisTemplate<String, Object> mockRedisTemplate() {
        // Mock Redis模板
    }

    @Bean
    @Primary
    public RedisService mockRedisService() {
        // Mock Redis服务
    }
}
```

## 📝 测试数据准备

### 测试案例数据
```java
public class CacheTestData {

    public static CaseData createTestCase(Long id) {
        CaseData caseData = new CaseData();
        caseData.setId(id);
        caseData.setTitle("测试案例" + id);
        caseData.setCategoryId(1L);
        caseData.setStatus(1);
        caseData.setShowStatus(1);
        return caseData;
    }

    public static CacheUpdateMessage createTestMessage(ActionType action, Long caseId) {
        return new CacheUpdateMessage(
            action,
            ResourceType.CASE,
            caseId.toString(),
            Arrays.asList("test:key:1", "test:key:2"),
            "test_user"
        );
    }
}
```

## 🚀 测试执行策略

### 测试阶段
1. **Phase 1**: 单元测试 (1-2天)
2. **Phase 2**: 集成测试 (1-2天)
3. **Phase 3**: 安全测试 (1天)
4. **Phase 4**: 性能测试 (1天)
5. **Phase 5**: 端到端测试 (1天)

### 测试执行顺序
```bash
# 1. 运行单元测试
mvn test -Dtest="*UnitTest"

# 2. 运行集成测试
mvn test -Dtest="*IntegrationTest" -Dspring.profiles.active=test

# 3. 运行完整测试套件
mvn test -Dspring.profiles.active=test

# 4. 生成测试报告
mvn jacoco:report
```

## ✅ 测试验收标准

### 覆盖率要求
- **代码覆盖率**: ≥ 90%
- **分支覆盖率**: ≥ 85%
- **方法覆盖率**: ≥ 95%

### 功能验收
- ✅ 所有缓存操作正常工作
- ✅ 消息发布/订阅机制正常
- ✅ 安全防护机制有效
- ✅ 故障恢复机制可靠
- ✅ 监控接口返回正确数据

### 性能验收
- **缓存操作延迟**: < 10ms
- **消息传递延迟**: < 100ms
- **故障检测时间**: < 30s
- **故障恢复时间**: < 60s

### 安全验收
- ✅ 权限验证阻止未授权操作
- ✅ 频率限制防止滥用
- ✅ 恶意消息被正确拒绝
- ✅ 安全事件被正确记录

## 📊 测试报告要求

### 报告内容
1. **测试执行摘要**
   - 测试用例总数
   - 通过/失败统计
   - 覆盖率数据

2. **功能测试结果**
   - 各模块测试详情
   - 发现的问题列表
   - 修复建议

3. **性能测试结果**
   - 响应时间统计
   - 吞吐量数据
   - 性能瓶颈分析

4. **安全测试结果**
   - 安全漏洞检查
   - 权限控制验证
   - 安全建议

### 报告格式
```
测试报告-案例后端缓存功能-YYYYMMDD.md
├── 执行摘要
├── 测试环境
├── 测试结果详情
├── 问题列表
├── 性能分析
├── 安全评估
└── 改进建议
```

## 🔄 持续集成

### CI/CD 集成
```yaml
# .github/workflows/cache-tests.yml
name: Cache Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:6
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'

    - name: Run Cache Tests
      run: |
        mvn test -Dtest="*CacheTest" -Dspring.profiles.active=test

    - name: Generate Test Report
      run: mvn jacoco:report

    - name: Upload Coverage
      uses: codecov/codecov-action@v1
```

## 📋 测试检查清单

### 测试前检查
- [ ] Redis测试环境已启动
- [ ] 测试数据库已清理
- [ ] 测试配置正确
- [ ] Mock对象已准备

### 测试执行检查
- [ ] 所有单元测试通过
- [ ] 集成测试通过
- [ ] 安全测试通过
- [ ] 性能测试达标
- [ ] 覆盖率达标

### 测试后检查
- [ ] 测试报告已生成
- [ ] 问题已记录
- [ ] 测试环境已清理
- [ ] 代码已提交

## 🎯 预期交付物

1. **测试代码**
   - 完整的单元测试套件
   - 集成测试用例
   - 性能测试脚本

2. **测试配置**
   - 测试环境配置文件
   - Mock配置类
   - 测试数据工厂

3. **测试文档**
   - 测试执行报告
   - 问题修复记录
   - 性能基准数据

4. **CI/CD配置**
   - 自动化测试脚本
   - 覆盖率报告配置
   - 测试结果通知

通过这套完整的测试计划，我们将确保案例后端缓存功能的高质量交付，为生产环境部署提供可靠保障。