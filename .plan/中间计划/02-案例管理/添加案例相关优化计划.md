# 案例管理系统优化计划（简化版）

## 项目概述

基于当前系统分析，案例管理系统专门用于视频案例的创建和展示。所有案例都是视频案例：用户在前端看到视频封面图片，点击后播放视频。

## 设计理念

**简化原则**：
- 所有案例都是视频案例，无需类型判断
- 不需要 `cover_image` 字段，直接使用 `image` 字段作为视频封面
- 不需要视频元数据（大小、时长等），保持简洁
- `image` 和 `video_url` 都是必填字段
- 向后兼容现有数据结构

## 现状分析

### ✅ 已实现功能
- 完整的案例管理CRUD操作
- 图片上传和展示功能（`image`字段，用作视频封面）
- 案例分类管理
- MinIO文件存储服务
- 响应式瀑布流展示
- 图片预览和交互功能

### ❌ 缺失功能
- 视频文件上传支持
- 视频预览播放功能
- 数据库视频字段支持
- 前端视频播放器组件

## 详细修改计划

### 一、数据库层面修改

#### 1.1 数据库表结构更新
**文件位置**: 需要执行SQL脚本更新数据库

**修改内容**:
```sql
-- 在 case_data 表中添加视频字段，简化设计
ALTER TABLE case_data ADD COLUMN video_url VARCHAR(500) COMMENT '视频文件URL';

-- 删除原有的 cover_image 字段，直接使用 image 字段作为预览图
ALTER TABLE case_data DROP COLUMN cover_image;

-- 重命名 images 为 image（单张图片）
ALTER TABLE case_data CHANGE COLUMN images image VARCHAR(1000) COMMENT '预览图片URL';

-- 数据迁移：将现有 cover_image 数据迁移到 image 字段（在重命名前执行）
-- UPDATE case_data SET images = cover_image WHERE images IS NULL AND cover_image IS NOT NULL;
```

### 二、后端项目修改

#### 2.1 实体类更新
**文件路径**: `/mnt/d/software/beilv-agent/mall/mall/mall-mbg/src/main/java/com/macro/mall/model/CaseData.java`

**修改内容**:
- 添加 `videoUrl` 字段 (String)
- 删除 `coverImage` 字段
- 将 `images` 字段重命名为 `image`，用作单张预览图片
- 所有案例都包含视频文件，`videoUrl` 为必填字段

#### 2.2 Mapper XML更新
**文件路径**: `/mnt/d/software/beilv-agent/mall/mall/mall-mbg/src/main/resources/com/macro/mall/mapper/CaseDataMapper.xml`

**修改内容**:
- 在 Base_Column_List 中添加 `video_url` 字段
- 在 insert 和 update 语句中添加 `video_url` 字段处理
- 移除 `cover_image` 相关的映射

#### 2.3 文件上传控制器扩展
**文件路径**: `/mnt/d/software/beilv-agent/mall/mall/mall-admin/src/main/java/com/macro/mall/controller/MinioController.java`

**修改内容**:
- 在现有的 `/minio/upload` 接口中扩展支持视频文件类型
- 扩展允许的文件类型：mp4, avi, mov, wmv, flv, webm
- 调整文件大小限制（视频文件通常较大，建议500MB以内）
- 无需额外的视频元数据处理

**修改现有上传方法**:
- 在现有的 `/minio/upload` 接口中扩展支持视频文件类型
- 无需新增单独的视频上传接口

#### 2.4 Service层更新
**文件路径**: `/mnt/d/software/beilv-agent/mall/mall/mall-admin/src/main/java/com/macro/mall/service/impl/CaseDataServiceImpl.java`

**修改内容**:
- 创建案例时处理视频URL和预览图片
- 更新案例时处理视频字段和图片字段
- 列表查询时所有案例都包含视频信息
- 将原来使用 coverImage 的地方改为使用 image 字段

### 三、管理后台前端修改

#### 3.1 视频上传组件开发
**新建文件**: `/mnt/d/software/beilv-agent/mall/mall-admin-web/src/components/Upload/videoUpload.vue`

**功能特点**:
- 支持视频文件拖拽上传
- 文件类型验证：mp4, avi, mov, wmv, flv, webm
- 文件大小限制：500MB以内
- 上传进度显示
- 视频预览功能
- 简化设计，无需时长显示

**技术实现**:
```vue
<template>
  <div class="video-upload-container">
    <el-upload
      :action="uploadUrl"
      :before-upload="beforeUpload"
      :on-success="handleSuccess"
      :on-progress="handleProgress"
      :show-file-list="false"
      accept=".mp4,.avi,.mov,.wmv,.flv,.webm"
      drag>
      <i class="el-icon-upload"></i>
      <div class="el-upload__text">将视频文件拖到此处，或<em>点击上传</em></div>
      <div class="el-upload__tip" slot="tip">只能上传mp4/avi/mov格式文件，且不超过500MB</div>
    </el-upload>

    <!-- 视频预览组件 -->
    <div v-if="videoUrl" class="video-preview">
      <video :src="videoUrl" controls width="300"></video>
      <el-button @click="handleRemove" type="danger" size="mini">删除</el-button>
    </div>
  </div>
</template>
```

#### 3.2 案例表单组件更新
**文件路径**: `/mnt/d/software/beilv-agent/mall/mall-admin-web/src/views/case/data/components/CaseDataDetail.vue`

**修改内容**:

1. **数据字段扩展**:
```javascript
data() {
  return {
    caseData: {
      // 现有字段...
      videoUrl: '', // 视频URL，必填
      image: ''     // 视频封面图片，必填
      // 删除 coverImage、videoSize、videoDuration、mediaType 字段，images改为image
    }
  }
}
```

2. **表单布局调整**:
```vue
<!-- 视频封面上传（必选） -->
<el-form-item label="视频封面:" prop="image">
  <single-upload v-model="caseData.image"></single-upload>
  <div class="input-tip">视频的封面图片，用于列表展示</div>
</el-form-item>

<!-- 视频文件上传（必选） -->
<el-form-item label="视频文件:" prop="videoUrl">
  <video-upload v-model="caseData.videoUrl"></video-upload>
  <div class="input-tip">视频文件，支持mp4、avi、mov等格式，文件大小不超过500MB</div>
</el-form-item>
```

3. **表单验证规则**:
```javascript
rules: {
  image: [
    {required: true, message: '请上传视频封面', trigger: 'change'}
  ],
  videoUrl: [
    {required: true, message: '请上传视频文件', trigger: 'change'}
  ]
}
```

#### 3.3 案例列表页面更新
**文件路径**: `/mnt/d/software/beilv-agent/mall/mall-admin-web/src/views/case/data/index.vue`

**修改内容**:
- 将原来使用 `coverImage` 的地方改为使用 `image` 字段
- 移除案例类型相关的筛选和显示（所有案例都是视频）
- 简化列表展示

```vue
<!-- 表格列中显示视频封面 -->
<el-table-column label="视频封面" width="100">
  <template slot-scope="scope">
    <img :src="scope.row.image" style="width: 60px; height: 40px; object-fit: cover;" />
  </template>
</el-table-column>

<!-- 可选：添加视频标识列 -->
<el-table-column label="类型" width="80" align="center">
  <template slot-scope="scope">
    <el-tag type="success">视频</el-tag>
  </template>
</el-table-column>
```

### 四、用户前端项目修改

#### 4.1 Gallery组件扩展
**文件路径**: `/mnt/d/software/beilv-agent/mall/beilv-agent-web/src/pages/gallery/Gallery.tsx`

**修改内容**:

1. **数据类型定义更新**:
```typescript
interface CaseItem {
  // 现有字段...
  videoUrl: string;   // 视频URL，必填
  image: string;      // 视频封面URL（原imageUrl字段重命名或映射）
  // 删除 videoSize、videoDuration、mediaType 字段
}
```

2. **案例卡片组件改进**:
```tsx
const CaseCard: React.FC<{case: CaseItem}> = ({ case: caseItem }) => (
  <div className="case-card">
    <div className="relative">
      <img src={caseItem.image} alt={caseItem.title} />

      {/* 视频标识 */}
      <div className="absolute top-2 right-2 bg-black/70 text-white px-2 py-1 rounded text-xs">
        <PlayCircleOutlined className="mr-1" />
        视频
      </div>
    </div>

    <div className="case-info">
      <h3>{caseItem.title}</h3>
      <p>{caseItem.description}</p>
    </div>
  </div>
);
```

3. **预览模态框扩展**:
```tsx
const PreviewModal: React.FC<{visible: boolean, case: CaseItem | null, onClose: () => void}> =
  ({ visible, case: caseItem, onClose }) => (
  <Modal visible={visible} onCancel={onClose} footer={null} width="90vw" style={{maxWidth: '1200px'}}>
    {caseItem && (
      <div className="preview-content">
        {/* 视频播放 */}
        <div className="video-container">
          <video
            src={caseItem.videoUrl}
            controls
            width="100%"
            poster={caseItem.image}
            preload="metadata"
          >
            您的浏览器不支持视频播放
          </video>
        </div>

        {/* 案例信息 */}
        <div className="case-details">
          <h2>{caseItem.title}</h2>
          <p>{caseItem.description}</p>
          <div className="meta-info">
            <span>类型: 视频</span>
          </div>

          {/* 操作按钮 */}
          <div className="actions">
            <Button onClick={() => handleLike(caseItem.id)}>点赞</Button>
            <Button onClick={() => handleCollect(caseItem.id)}>收藏</Button>
            <Button onClick={() => handleShare(caseItem)}>分享</Button>
          </div>
        </div>
      </div>
    )}
  </Modal>
);
```

#### 4.2 API接口更新
**文件路径**: `/mnt/d/software/beilv-agent/mall/beilv-agent-web/src/api/caseApi.ts`

**修改内容**:
- 更新接口返回类型定义
- 添加案例类型筛选参数

```typescript
export interface CaseListParams {
  // 现有参数...
  // 移除视频筛选参数，所有案例都是视频
}
```

### 五、实施步骤和注意事项

#### 5.1 实施顺序
1. **数据库层面**: 先执行SQL脚本更新表结构，迁移数据
2. **后端接口**: 更新实体类、Mapper、Service、Controller
3. **管理后台**: 开发视频上传组件，更新表单和列表
4. **用户前端**: 扩展Gallery组件支持视频预览
5. **测试验证**: 全链路测试功能

#### 5.2 技术注意事项

**文件存储**:
- 视频文件较大，需要确保MinIO存储空间充足
- 考虑添加视频压缩功能降低存储成本
- 建议配置CDN加速视频访问

**性能优化**:
- 视频文件懒加载，仅在点击时加载
- 使用 `preload="metadata"` 获取视频信息但不预加载内容
- 考虑添加视频缩略图生成功能

**用户体验**:
- 提供清晰的案例类型标识
- 视频加载时显示进度指示
- 支持视频播放控制（播放/暂停/音量/全屏）

**移动端适配**:
- 确保视频播放器在移动设备上正常工作
- 考虑移动端的网络条件，提供画质选择
- 适配不同屏幕尺寸的视频播放界面

#### 5.3 兼容性处理
- 需要对现有数据进行兼容性处理
- 新的 `videoUrl` 字段为必填，需要为旧数据提供默认值或迁移方案
- 需要将现有的 `coverImage` 数据迁移到 `image` 字段
- API接口向后兼容，不影响现有功能

#### 5.4 数据迁移计划
```sql
-- 在删除 cover_image 字段前，先迁移数据
UPDATE case_data
SET images = COALESCE(images, cover_image)
WHERE images IS NULL OR images = '';

-- 确保 image 字段有值的记录都有预览图（重命名后）
UPDATE case_data
SET image = cover_image
WHERE cover_image IS NOT NULL AND cover_image != ''
AND (image IS NULL OR image = '');
```

#### 5.5 测试要点
- 视频案例的上传、预览、播放
- 视频封面的正确显示
- 移动端的视频播放体验
- 文件上传的错误处理和进度显示
- 数据迁移的完整性验证

## 预期效果

实施此计划后，系统将支持：
1. **管理员**创建视频案例，必须上传视频封面图片和视频文件
2. **用户**在画廊中看到视频封面图片，点击后播放视频
3. **系统**专门针对视频案例优化，提供最佳的视频播放体验
4. **简化设计**去除复杂的类型判断，专注于视频展示功能

这个简化计划最小化了对现有代码的影响，去除了不必要的复杂性，采用更简洁的方式添加视频支持，确保系统的稳定性和用户体验的连续性。