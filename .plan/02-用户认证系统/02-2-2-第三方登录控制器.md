# 02-2-2: 第三方登录控制器

## 任务概述
**时间估算**: 2小时  
**优先级**: 高  
**依赖关系**: 02-2-1 邮箱验证码认证控制器完成  
**负责模块**: mall-portal后端

## 详细任务清单

### 1. 创建第三方登录DTO类
- [ ] 创建WeChatLoginRequest微信登录请求DTO
- [ ] 创建GoogleLoginRequest谷歌登录请求DTO
- [ ] 创建ThirdPartyUserInfo第三方用户信息DTO
- [ ] 添加参数验证注解
- [ ] 定义统一的第三方用户信息格式

### 2. 实现第三方认证服务
- [ ] 创建ThirdPartyAuthService服务类
- [ ] 注入必要的依赖（Mapper、MemberService、JwtUtils）
- [ ] 实现processThirdPartyLogin统一处理方法
- [ ] 查找现有第三方登录记录
- [ ] 实现首次登录用户创建逻辑
- [ ] 生成JWT令牌和更新登录时间

### 3. 创建第三方登录控制器
- [ ] 创建ThirdPartyAuthController控制器类
- [ ] 配置请求映射和验证注解
- [ ] 注入第三方认证服务
- [ ] 注入微信和谷歌登录服务

### 4. 实现微信登录接口
- [ ] 创建/api/auth/login/wechat POST接口
- [ ] 接收微信授权码
- [ ] 调用微信登录服务获取用户信息
- [ ] 处理第三方登录流程
- [ ] 返回统一认证响应
- [ ] 添加异常处理和日志记录

### 5. 实现Google登录接口
- [ ] 创建/api/auth/login/google POST接口
- [ ] 接收Google ID Token
- [ ] 验证ID Token并获取用户信息
- [ ] 处理第三方登录流程
- [ ] 返回统一认证响应
- [ ] 添加异常处理和日志记录

### 6. 实现第三方用户创建逻辑
- [ ] createMemberFromThirdParty方法创建新用户
- [ ] 设置用户基本信息（邮箱、用户名、头像）
- [ ] 根据第三方平台设置注册类型
- [ ] 设置第三方用户ID（微信OpenID或Google ID）
- [ ] 生成默认用户名逻辑

### 7. 实现第三方登录记录管理
- [ ] 创建和更新第三方登录记录
- [ ] 关联用户和第三方账户
- [ ] 处理令牌信息（访问令牌、刷新令牌）
- [ ] 设置令牌过期时间

### 8. 创建相关Mapper方法
- [ ] UmsThirdPartyAuthMapper接口设计
- [ ] 实现根据平台和第三方ID查询方法
- [ ] 实现插入第三方登录记录方法
- [ ] 实现更新令牌信息方法

## 验收标准
- [x] 第三方登录接口功能完整
- [x] 用户信息正确处理和存储
- [x] 首次登录自动创建用户账户
- [x] 第三方登录记录正确关联
- [x] JWT令牌生成和验证正常
- [x] 异常处理和日志记录完善

## 交付物
1. **第三方登录控制器**（ThirdPartyAuthController.java）
2. **第三方认证服务**（ThirdPartyAuthService.java）
3. **第三方登录DTO类**（WeChatLoginRequest.java、GoogleLoginRequest.java、ThirdPartyUserInfo.java）
4. **第三方登录Mapper**（UmsThirdPartyAuthMapper.java）
5. **集成测试类**（ThirdPartyAuthControllerTest.java）

## 技术要点

### 第三方认证服务结构
```java
@Service
@Slf4j
public class ThirdPartyAuthService {
    
    public AuthResponse processThirdPartyLogin(ThirdPartyUserInfo userInfo) {
        // 1. 查找现有第三方登录记录
        // 2. 存在则直接登录，不存在则创建新用户
        // 3. 生成JWT令牌
        // 4. 更新登录时间
        // 5. 返回认证响应
    }
    
    private UmsMember createMemberFromThirdParty(ThirdPartyUserInfo userInfo) {
        // 根据第三方信息创建用户
    }
}
```

### 控制器接口
- `POST /api/auth/login/wechat` - 微信扫码登录
- `POST /api/auth/login/google` - 谷歌账号登录

### 第三方用户信息映射
```java
@Data
public class ThirdPartyUserInfo {
    private String thirdPartyId;    // 第三方用户ID
    private String email;           // 邮箱
    private String name;            // 姓名
    private String avatar;          // 头像URL
    private String provider;        // 平台（wechat/google）
}
```

### 用户创建逻辑
- 设置邮箱和用户名
- 根据平台设置注册类型
- 设置第三方用户ID
- 邮箱验证状态处理
- 生成默认用户名

### 数据关联设计
```java
// 用户表字段
wechat_openid VARCHAR(64) UNIQUE    // 微信OpenID
google_id VARCHAR(128) UNIQUE       // Google用户ID
register_type TINYINT               // 注册方式

// 第三方登录记录表
member_id BIGINT                    // 关联用户ID
provider VARCHAR(32)                // 平台标识
third_party_id VARCHAR(128)         // 第三方用户ID
access_token VARCHAR(512)           // 访问令牌
refresh_token VARCHAR(512)          // 刷新令牌
```

## 登录流程设计

### 微信登录流程
1. 前端获取微信授权码
2. 后端通过授权码获取用户信息
3. 查找或创建用户账户
4. 生成JWT令牌返回

### Google登录流程
1. 前端获取Google ID Token
2. 后端验证ID Token获取用户信息
3. 查找或创建用户账户
4. 生成JWT令牌返回

## 异常处理
- 第三方服务不可用
- 用户信息获取失败
- 用户账户状态异常
- 令牌生成失败

## 安全考虑
- 验证第三方令牌真实性
- 防止用户信息伪造
- 第三方账户唯一性约束
- 敏感信息加密存储

## 下一步
完成后进入 `02-3-1-登录页面组件`