# 02-1-4: 验证码服务

## 任务概述
**时间估算**: 2小时  
**优先级**: 最高  
**依赖关系**: 02-1-2 邮件服务配置完成  
**负责模块**: mall-portal后端

## 详细任务清单

### 1. 创建验证码服务类
- [ ] 创建VerificationCodeService服务类
- [ ] 注入必要的依赖（Mapper、EmailService、RedisTemplate）
- [ ] 定义验证码相关常量（长度、过期时间、Redis key前缀）
- [ ] 添加日志记录功能

### 2. 实现验证码生成逻辑
- [ ] 实现generateCode方法生成6位数字验证码
- [ ] 确保验证码随机性和唯一性
- [ ] 支持自定义验证码长度
- [ ] 添加验证码格式验证

### 3. 实现验证码发送功能
- [ ] 实现sendVerificationCode方法
- [ ] 检查发送频率限制（1分钟内只能发送一次）
- [ ] 生成验证码并保存到数据库
- [ ] 同时将验证码保存到Redis（快速验证）
- [ ] 调用邮件服务发送验证码
- [ ] 设置Redis频率限制键
- [ ] 处理发送失败的异常情况

### 4. 实现验证码验证功能
- [ ] 实现verifyCode方法
- [ ] 首先从Redis中查找验证码（性能优化）
- [ ] Redis中没有时从数据库查询
- [ ] 验证码有效性检查（未过期、未使用）
- [ ] 验证成功后删除验证码（防止重复使用）
- [ ] 更新数据库中验证码使用状态
- [ ] 返回验证结果

### 5. 实现频率限制和安全机制
- [ ] 实现发送频率限制（防止恶意请求）
- [ ] 验证码尝试次数限制（防止暴力破解）
- [ ] 过期验证码清理机制
- [ ] 异常情况处理和日志记录

### 6. 创建相关Mapper方法
- [ ] 创建UmsVerificationCodeMapper接口
- [ ] 实现插入验证码记录方法
- [ ] 实现查询有效验证码方法
- [ ] 实现标记验证码已使用方法
- [ ] 实现清理过期验证码方法

## 验收标准
- [x] 验证码生成逻辑正确，随机性好
- [x] 支持不同类型验证码（注册、登录、重置密码）
- [x] 频率限制机制有效防止恶意请求
- [x] Redis缓存机制提高验证性能
- [x] 数据库和Redis数据一致性
- [x] 异常处理完善，日志信息详细
- [x] 验证码使用后立即失效

## 交付物
1. **验证码服务类**（VerificationCodeService.java）
2. **验证码Mapper接口**（UmsVerificationCodeMapper.java）
3. **验证码实体类**（UmsVerificationCode.java）
4. **Mapper XML文件**（UmsVerificationCodeMapper.xml）
5. **单元测试类**（VerificationCodeServiceTest.java）

## 技术要点

### 核心服务方法
```java
@Service
public class VerificationCodeService {
    
    // 发送验证码
    public boolean sendVerificationCode(String email, CodeType codeType) {
        // 1. 检查发送频率限制
        // 2. 生成验证码
        // 3. 保存到数据库和Redis
        // 4. 发送邮件
        // 5. 设置频率限制
    }
    
    // 验证验证码
    public boolean verifyCode(String email, String code, CodeType codeType) {
        // 1. 从Redis查询验证码
        // 2. Redis没有则查询数据库
        // 3. 验证码有效性检查
        // 4. 验证成功后删除验证码
    }
    
    // 生成验证码
    private String generateCode() {
        // 生成6位随机数字验证码
    }
}
```

### Redis缓存策略
- **Key格式**: `verification_code:email:codeType`
- **过期时间**: 5分钟
- **频率限制Key**: `verification_code:rate_limit:email`
- **频率限制时间**: 1分钟

### 数据库查询优化
- 使用复合索引（email, code_type）提高查询性能
- 定期清理过期验证码记录
- 使用数据库连接池优化并发性能

### 安全机制
- 验证码长度固定6位
- 发送频率限制（1分钟1次）
- 验证码过期时间（5分钟）
- 使用后立即失效
- 记录异常访问日志

## Mapper方法设计
```java
public interface UmsVerificationCodeMapper {
    // 插入验证码记录
    int insert(UmsVerificationCode record);
    
    // 查询有效的验证码
    UmsVerificationCode selectValidCode(
        @Param("email") String email, 
        @Param("codeType") Integer codeType
    );
    
    // 标记验证码为已使用
    int markAsUsed(
        @Param("email") String email,
        @Param("code") String code,
        @Param("codeType") Integer codeType,
        @Param("usedStatus") Integer usedStatus
    );
    
    // 清理过期验证码
    int deleteExpiredCodes();
}
```

## 异常处理
- **BusinessException**: 业务异常（频率限制、验证码无效等）
- **系统异常**: 数据库连接、Redis连接异常
- **邮件发送异常**: 邮件服务不可用
- **日志记录**: 详细记录异常信息和上下文

## 下一步
完成后进入 `02-1-5-JWT Token服务`