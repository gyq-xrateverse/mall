# 02-1-2: 邮件服务配置

## 任务概述
**时间估算**: 1.5小时  
**优先级**: 最高  
**依赖关系**: 02-1-1 数据库设计扩展完成  
**负责模块**: mall-portal后端

## 详细任务清单

### 1. 添加邮件相关依赖
- [ ] 在pom.xml中添加spring-boot-starter-mail依赖
- [ ] 添加spring-boot-starter-thymeleaf依赖（模板引擎）
- [ ] 检查版本兼容性
- [ ] 同步依赖到开发环境

### 2. 配置邮件服务参数
- [ ] 在application.yml中配置SMTP服务器
- [ ] 设置邮件服务器地址（smtp.qq.com）
- [ ] 配置端口和安全连接
- [ ] 设置邮箱用户名环境变量
- [ ] 配置应用程序专用密码
- [ ] 添加邮件编码和认证配置
- [ ] 设置邮件模板相关参数

### 3. 实现邮件服务类
- [ ] 创建EmailService服务类
- [ ] 注入JavaMailSender和TemplateEngine
- [ ] 实现sendVerificationCode方法
- [ ] 处理邮件发送异常和重试机制
- [ ] 添加日志记录功能
- [ ] 根据验证码类型设置不同主题
- [ ] 支持HTML格式邮件内容

### 4. 创建邮件模板
- [ ] 在templates/email目录创建邮件模板
- [ ] 设计验证码邮件HTML模板
- [ ] 添加响应式CSS样式
- [ ] 支持动态内容替换（验证码、类型、过期时间）
- [ ] 包含品牌标识和样式
- [ ] 添加免责声明和注意事项
- [ ] 测试模板在不同邮件客户端的兼容性

### 5. 邮件发送测试
- [ ] 编写邮件服务单元测试
- [ ] 测试不同类型验证码邮件
- [ ] 验证邮件内容格式正确性
- [ ] 测试邮件发送失败处理
- [ ] 检查日志输出完整性

## 验收标准
- [x] 邮件服务配置正确且可连接SMTP服务器
- [x] 邮件发送功能正常工作
- [x] 邮件模板样式美观且响应式
- [x] 支持HTML格式和动态内容
- [x] 异常处理完善，有详细日志
- [x] 支持不同类型验证码邮件

## 交付物
1. **邮件服务实现类**（EmailService.java）
2. **邮件配置文件**（application.yml邮件部分）
3. **HTML邮件模板**（verification-code.html）
4. **邮件服务单元测试**
5. **依赖配置**（pom.xml更新）

## 技术要点

### 依赖配置
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-mail</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-thymeleaf</artifactId>
</dependency>
```

### 邮件配置
```yaml
spring:
  mail:
    host: smtp.qq.com
    port: 587
    username: ${MAIL_USERNAME:your-email@qq.com}
    password: ${MAIL_PASSWORD:your-app-password}
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
            required: true

mail:
  from: ${MAIL_FROM:BEILV AI <your-email@qq.com>}
  verification-code:
    expire-minutes: 5
```

### 核心服务方法
```java
public boolean sendVerificationCode(String toEmail, String code, String type) {
    // 创建邮件消息
    // 设置发件人、收件人、主题
    // 使用Thymeleaf模板生成HTML内容
    // 发送邮件并处理异常
}
```

### HTML模板特性
- 响应式设计，适配移动端
- 清晰的验证码展示
- 品牌标识和专业外观
- 安全提示和使用说明

## 环境变量配置
需要在环境中设置以下变量：
- `MAIL_USERNAME`: 邮箱账号
- `MAIL_PASSWORD`: 应用程序专用密码
- `MAIL_FROM`: 发件人显示名称

## 安全考虑
- 使用应用程序专用密码而非账户密码
- 启用STARTTLS加密传输
- 不在代码中硬编码邮箱凭据
- 邮件内容包含安全提示

## 下一步
完成后进入 `02-1-4-验证码服务`