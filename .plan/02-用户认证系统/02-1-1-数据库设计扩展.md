# 02-1-1: 数据库设计扩展

## 任务概述
**时间估算**: 1.5小时  
**优先级**: 最高  
**依赖关系**: 01-前端基础架构完成  
**负责模块**: mall-portal后端

## 详细任务清单

### 1. 扩展现有用户表
- [ ] 分析现有ums_member表结构
- [ ] 编写ALTER TABLE语句添加认证相关字段
- [ ] 添加微信OpenID字段（wechat_openid）
- [ ] 添加Google用户ID字段（google_id）
- [ ] 添加注册方式字段（register_type）
- [ ] 添加邮箱验证状态字段（email_verified）
- [ ] 添加最后登录时间字段（last_login_time）
- [ ] 添加头像URL字段（avatar_url）
- [ ] 添加账户状态字段（account_status）
- [ ] 为新字段添加UNIQUE约束和索引

### 2. 创建验证码记录表
- [ ] 设计ums_verification_codes表结构
- [ ] 定义主键和自增ID
- [ ] 设计邮箱字段（email）
- [ ] 设计验证码字段（code）
- [ ] 设计验证码类型字段（code_type）
- [ ] 设计过期时间字段（expire_time）
- [ ] 设计使用状态字段（used_status）
- [ ] 添加创建时间字段（created_time）
- [ ] 创建复合索引（email, code_type）
- [ ] 创建过期时间索引（expire_time）

### 3. 创建第三方登录记录表
- [ ] 设计ums_third_party_auth表结构
- [ ] 定义主键和关联字段
- [ ] 设计第三方平台字段（provider）
- [ ] 设计第三方用户ID字段（third_party_id）
- [ ] 设计访问令牌字段（access_token）
- [ ] 设计刷新令牌字段（refresh_token）
- [ ] 设计令牌过期时间字段（expire_time）
- [ ] 添加时间戳字段
- [ ] 创建唯一约束（provider, third_party_id）
- [ ] 创建member_id索引

### 4. 数据库脚本执行
- [ ] 编写完整的数据库迁移脚本
- [ ] 验证SQL语法正确性
- [ ] 在开发环境执行脚本
- [ ] 检查表结构和约束
- [ ] 验证索引创建成功

## 验收标准
- [x] 所有表结构创建成功
- [x] 字段类型和长度合适
- [x] 索引和约束配置正确
- [x] 无外键约束，使用逻辑关联
- [x] 状态字段枚举值清晰
- [x] 支持并发访问的索引优化

## 交付物
1. **数据库迁移脚本**（V1.1__auth_schema_extension.sql）
2. **表结构文档**（包含字段说明和约束）
3. **索引优化说明**
4. **测试数据插入脚本**

## 技术要点

### 关键SQL语句
```sql
-- 用户表扩展
ALTER TABLE ums_member ADD COLUMN wechat_openid VARCHAR(64) UNIQUE COMMENT '微信OpenID';
ALTER TABLE ums_member ADD COLUMN google_id VARCHAR(128) UNIQUE COMMENT 'Google用户ID';
-- ... 其他字段

-- 验证码表
CREATE TABLE ums_verification_codes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    email VARCHAR(128) NOT NULL,
    code VARCHAR(6) NOT NULL,
    code_type TINYINT NOT NULL COMMENT '类型: 1-注册, 2-登录, 3-重置密码',
    -- ... 其他字段和索引
);

-- 第三方登录表
CREATE TABLE ums_third_party_auth (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    member_id BIGINT NOT NULL,
    provider VARCHAR(32) NOT NULL COMMENT '第三方平台: wechat, google',
    -- ... 其他字段和约束
);
```

### 设计原则
- 使用逻辑关联而非物理外键
- 为查询频繁的字段创建索引
- 状态字段使用TINYINT节省存储
- 时间字段使用DATETIME类型
- 第三方ID字段预留足够长度

## 注意事项
- 执行前备份现有数据
- 在低峰期执行表结构变更
- 验证现有业务功能不受影响
- 检查应用程序中的相关查询

## 下一步
完成后进入 `02-1-2-邮件服务配置`