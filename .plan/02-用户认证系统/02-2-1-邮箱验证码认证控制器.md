# 02-2-1: 邮箱验证码认证控制器

## 任务概述
**时间估算**: 2小时  
**优先级**: 最高  
**依赖关系**: 02-1-5 JWT Token服务完成  
**负责模块**: mall-portal后端

## 详细任务清单

### 1. 创建认证DTO类
- [ ] 创建SendCodeRequest验证码发送请求DTO
- [ ] 创建EmailRegisterRequest邮箱注册请求DTO
- [ ] 创建EmailLoginRequest邮箱登录请求DTO
- [ ] 创建AuthResponse统一认证响应DTO
- [ ] 添加参数验证注解（@NotBlank、@Email、@Length等）
- [ ] 创建嵌套的MemberInfo内部类

### 2. 实现认证控制器基础结构
- [ ] 创建AuthController控制器类
- [ ] 添加必要的注解（@RestController、@RequestMapping、@Validated）
- [ ] 注入所需服务（VerificationCodeService、UmsMemberService、JwtUtils）
- [ ] 配置Swagger文档注解

### 3. 实现验证码发送接口
- [ ] 创建/api/auth/send-code POST接口
- [ ] 验证请求参数格式和完整性
- [ ] 将字符串类型转换为CodeType枚举
- [ ] 调用验证码服务发送验证码
- [ ] 处理发送成功和失败的响应
- [ ] 添加异常处理和错误信息

### 4. 实现邮箱注册接口
- [ ] 创建/api/auth/register/email POST接口
- [ ] 验证验证码有效性
- [ ] 检查邮箱是否已注册
- [ ] 创建新用户记录
- [ ] 设置用户基本信息（邮箱验证状态、注册类型等）
- [ ] 密码加密处理（BCrypt）
- [ ] 生成JWT令牌
- [ ] 更新最后登录时间
- [ ] 构建统一响应格式

### 5. 实现邮箱登录接口
- [ ] 创建/api/auth/login/email POST接口
- [ ] 验证验证码有效性
- [ ] 查找用户记录
- [ ] 检查用户账户状态
- [ ] 生成JWT令牌
- [ ] 更新最后登录时间
- [ ] 构建登录响应信息

### 6. 实现Token刷新接口
- [ ] 创建/api/auth/refresh-token POST接口
- [ ] 验证刷新令牌有效性
- [ ] 检查用户状态
- [ ] 生成新的访问令牌和刷新令牌
- [ ] 返回新令牌信息

### 7. 实现用户登出接口
- [ ] 创建/api/auth/logout POST接口
- [ ] 提取请求中的令牌
- [ ] 记录登出日志
- [ ] 预留令牌黑名单机制

### 8. 实现获取当前用户信息接口
- [ ] 创建/api/auth/me GET接口
- [ ] 从请求头提取JWT令牌
- [ ] 验证令牌有效性
- [ ] 提取用户ID信息
- [ ] 查询并返回用户信息

### 9. 实现辅助方法
- [ ] buildMemberInfo方法构建用户信息响应
- [ ] getRegisterTypeString方法转换注册类型
- [ ] extractTokenFromRequest方法提取请求令牌
- [ ] 统一异常处理和日志记录

## 验收标准
- [x] 所有认证接口功能完整且正常工作
- [x] 请求参数验证规则正确有效
- [x] 错误处理机制完善，返回友好错误信息
- [x] JWT令牌生成和验证逻辑正确
- [x] 用户信息响应格式统一
- [x] 日志记录详细，便于问题排查
- [x] API文档完整清晰

## 交付物
1. **认证控制器类**（AuthController.java）
2. **请求DTO类**（SendCodeRequest.java、EmailRegisterRequest.java、EmailLoginRequest.java）
3. **响应DTO类**（AuthResponse.java）
4. **API集成测试**（AuthControllerTest.java）
5. **接口文档**（Swagger注解和文档）

## 技术要点

### 控制器结构
```java
@RestController
@RequestMapping("/api/auth")
@Validated
@Slf4j
public class AuthController {
    
    @Autowired
    private VerificationCodeService verificationCodeService;
    
    @Autowired
    private UmsMemberService memberService;
    
    @Autowired
    private JwtUtils jwtUtils;
    
    // 认证接口实现
}
```

### 核心接口
- `POST /api/auth/send-code` - 发送验证码
- `POST /api/auth/register/email` - 邮箱注册
- `POST /api/auth/login/email` - 邮箱登录
- `POST /api/auth/refresh-token` - 刷新令牌
- `POST /api/auth/logout` - 用户登出
- `GET /api/auth/me` - 获取当前用户信息

### 参数验证
- 使用JSR-303验证注解
- 邮箱格式验证：@Email
- 非空验证：@NotBlank
- 长度验证：@Length
- 自定义验证消息

### 异常处理策略
```java
try {
    // 业务逻辑处理
    return CommonResult.success(response, "操作成功");
} catch (BusinessException e) {
    return CommonResult.failed(e.getMessage());
} catch (Exception e) {
    log.error("操作失败", e);
    return CommonResult.failed("系统繁忙，请稍后重试");
}
```

### JWT令牌处理
- Authorization头格式：`Bearer <token>`
- 令牌提取和验证
- 用户信息解析
- 过期处理

## 响应格式设计
### 认证成功响应
```json
{
    "code": 200,
    "message": "操作成功",
    "data": {
        "token": "eyJhbGciOiJIUzUxMiJ9...",
        "refreshToken": "eyJhbGciOiJIUzUxMiJ9...",
        "expiresIn": 86400,
        "memberInfo": {
            "id": 1,
            "email": "user@example.com",
            "username": "用户名",
            "avatar": "头像URL",
            "emailVerified": true,
            "registerType": "email",
            "lastLoginTime": "2024-01-01T12:00:00"
        }
    }
}
```

### 验证失败响应
```json
{
    "code": 400,
    "message": "验证码无效或已过期",
    "data": null
}
```

## 安全考虑
- 密码使用BCrypt加密
- 验证码使用后立即失效
- 令牌安全传输和存储
- 用户状态检查
- 详细的安全审计日志

## 测试用例
- 发送验证码功能测试
- 邮箱注册流程测试
- 邮箱登录流程测试
- 参数验证测试
- 异常情况处理测试
- 令牌刷新测试

## 下一步
完成后进入 `02-2-2-第三方登录控制器`