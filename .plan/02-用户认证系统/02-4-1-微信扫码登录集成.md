# 02-4-1: 微信扫码登录集成

## 任务概述
**时间估算**: 2小时  
**优先级**: 中  
**依赖关系**: 02-3-4 认证相关Hooks完成  
**负责模块**: 前端React + 后端Java

## 详细任务清单

### 1. 微信开放平台配置
- [ ] 注册微信开放平台开发者账号
- [ ] 创建网站应用并获取AppID和AppSecret
- [ ] 配置授权回调域名
- [ ] 设置应用logo和基本信息
- [ ] 获取微信登录权限

### 2. 后端微信登录服务实现
- [ ] 创建WeChatLoginService服务类
- [ ] 配置微信应用参数（AppID、AppSecret）
- [ ] 实现通过授权码获取access_token
- [ ] 实现通过access_token获取用户信息
- [ ] 处理微信API调用异常
- [ ] 实现用户信息映射到系统格式

### 3. 前端微信SDK集成
- [ ] 安装微信JS-SDK相关依赖
- [ ] 创建微信登录组件
- [ ] 实现扫码登录二维码展示
- [ ] 处理扫码授权回调
- [ ] 集成到登录页面

### 4. 扫码登录组件开发
- [ ] 创建WeChatLogin组件
- [ ] 显示微信登录二维码
- [ ] 实现扫码状态检测
- [ ] 处理扫码成功后的跳转
- [ ] 添加扫码失效重新获取功能

### 5. 授权回调处理
- [ ] 创建微信授权回调页面
- [ ] 提取URL中的授权码
- [ ] 调用后端微信登录接口
- [ ] 处理登录成功/失败状态
- [ ] 跳转到目标页面或错误页面

### 6. 微信用户信息处理
- [ ] 定义微信用户信息接口
- [ ] 实现用户信息映射逻辑
- [ ] 处理用户头像和昵称
- [ ] 设置用户注册来源为微信
- [ ] 关联微信OpenID到用户记录

### 7. 错误处理和用户体验
- [ ] 处理微信API调用失败
- [ ] 显示网络错误提示
- [ ] 实现重试机制
- [ ] 添加加载状态指示
- [ ] 优化移动端扫码体验

## 验收标准
- [x] 微信扫码登录功能正常工作
- [x] 首次扫码自动创建用户账户
- [x] 用户信息正确获取和存储
- [x] 错误处理完善用户体验好
- [x] 移动端和桌面端都能正常使用
- [x] 安全性符合微信开放平台要求

## 交付物
1. **微信登录服务**（WeChatLoginService.java）
2. **微信登录组件**（WeChatLogin.tsx）
3. **授权回调页面**（WeChatCallback.tsx）
4. **微信API配置**（wechat.config.ts）
5. **微信登录Hook**（useWeChatLogin.ts）

## 技术要点

### 后端微信登录服务
```java
@Service
@Slf4j
public class WeChatLoginService {
    
    @Value("${wechat.app.id}")
    private String appId;
    
    @Value("${wechat.app.secret}")
    private String appSecret;
    
    @Value("${wechat.redirect.uri}")
    private String redirectUri;
    
    public ThirdPartyUserInfo getUserInfoByCode(String code) {
        try {
            // 1. 通过code获取access_token
            WeChatTokenResponse tokenResponse = getAccessToken(code);
            
            // 2. 通过access_token获取用户信息
            WeChatUserInfo userInfo = getUserInfo(
                tokenResponse.getAccessToken(), 
                tokenResponse.getOpenid()
            );
            
            // 3. 映射到系统用户信息格式
            return mapToThirdPartyUserInfo(userInfo);
            
        } catch (Exception e) {
            log.error("WeChat login failed for code: {}", code, e);
            throw new BusinessException("微信登录失败: " + e.getMessage());
        }
    }
    
    private WeChatTokenResponse getAccessToken(String code) {
        String url = "https://api.weixin.qq.com/sns/oauth2/access_token"
            + "?appid=" + appId
            + "&secret=" + appSecret
            + "&code=" + code
            + "&grant_type=authorization_code";
            
        RestTemplate restTemplate = new RestTemplate();
        WeChatTokenResponse response = restTemplate.getForObject(url, WeChatTokenResponse.class);
        
        if (response.getErrcode() != null) {
            throw new BusinessException("获取微信access_token失败: " + response.getErrmsg());
        }
        
        return response;
    }
    
    private WeChatUserInfo getUserInfo(String accessToken, String openid) {
        String url = "https://api.weixin.qq.com/sns/userinfo"
            + "?access_token=" + accessToken
            + "&openid=" + openid
            + "&lang=zh_CN";
            
        RestTemplate restTemplate = new RestTemplate();
        WeChatUserInfo userInfo = restTemplate.getForObject(url, WeChatUserInfo.class);
        
        if (userInfo.getErrcode() != null) {
            throw new BusinessException("获取微信用户信息失败: " + userInfo.getErrmsg());
        }
        
        return userInfo;
    }
    
    private ThirdPartyUserInfo mapToThirdPartyUserInfo(WeChatUserInfo wechatUser) {
        ThirdPartyUserInfo userInfo = new ThirdPartyUserInfo();
        userInfo.setThirdPartyId(wechatUser.getOpenid());
        userInfo.setName(wechatUser.getNickname());
        userInfo.setAvatar(wechatUser.getHeadimgurl());
        userInfo.setProvider("wechat");
        // 微信不提供邮箱信息
        return userInfo;
    }
}
```

### 前端微信登录组件
```typescript
// components/WeChatLogin.tsx
interface WeChatLoginProps {
  onSuccess?: (userInfo: any) => void;
  onError?: (error: string) => void;
}

export const WeChatLogin: React.FC<WeChatLoginProps> = ({
  onSuccess,
  onError
}) => {
  const [qrUrl, setQrUrl] = useState<string>('');
  const [loading, setLoading] = useState(false);

  const generateQRCode = useCallback(() => {
    const params = new URLSearchParams({
      appid: WECHAT_APP_ID,
      redirect_uri: encodeURIComponent(WECHAT_REDIRECT_URI),
      response_type: 'code',
      scope: 'snsapi_login',
      state: generateRandomState(),
    });

    const wechatUrl = `https://open.weixin.qq.com/connect/qrconnect?${params}#wechat_redirect`;
    setQrUrl(wechatUrl);
  }, []);

  useEffect(() => {
    generateQRCode();
  }, [generateQRCode]);

  const handleWeChatLogin = () => {
    setLoading(true);
    window.open(
      qrUrl,
      'wechat-login',
      'width=400,height=500,scrollbars=yes,resizable=yes'
    );

    // 监听登录结果
    window.addEventListener('message', handleLoginCallback);
  };

  const handleLoginCallback = (event: MessageEvent) => {
    if (event.origin !== window.location.origin) return;

    const { type, data, error } = event.data;
    
    if (type === 'WECHAT_LOGIN_SUCCESS') {
      setLoading(false);
      onSuccess?.(data);
    } else if (type === 'WECHAT_LOGIN_ERROR') {
      setLoading(false);
      onError?.(error);
    }

    window.removeEventListener('message', handleLoginCallback);
  };

  return (
    <button
      onClick={handleWeChatLogin}
      disabled={loading}
      className="flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
    >
      {loading ? (
        <Spinner className="w-4 h-4 mr-2" />
      ) : (
        <WeChatIcon className="w-4 h-4 mr-2" />
      )}
      {loading ? '登录中...' : '微信登录'}
    </button>
  );
};
```

### 微信授权回调页面
```typescript
// pages/auth/WeChatCallback.tsx
export const WeChatCallback: React.FC = () => {
  const [status, setStatus] = useState<'loading' | 'success' | 'error'>('loading');
  const [message, setMessage] = useState('');
  const { loginByWeChat } = useLogin();

  useEffect(() => {
    const handleCallback = async () => {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');

        if (error) {
          throw new Error('用户取消授权或授权失败');
        }

        if (!code) {
          throw new Error('未获取到授权码');
        }

        // 调用微信登录
        const result = await loginByWeChat(code);
        
        if (result.success) {
          setStatus('success');
          setMessage('登录成功，正在跳转...');
          
          // 通知父窗口登录成功
          if (window.opener) {
            window.opener.postMessage({
              type: 'WECHAT_LOGIN_SUCCESS',
              data: result.data
            }, window.location.origin);
            window.close();
          } else {
            // 如果不是弹窗，直接跳转
            setTimeout(() => {
              window.location.href = '/dashboard';
            }, 1000);
          }
        } else {
          throw new Error(result.error || '登录失败');
        }

      } catch (error) {
        setStatus('error');
        setMessage(error instanceof Error ? error.message : '登录失败');
        
        if (window.opener) {
          window.opener.postMessage({
            type: 'WECHAT_LOGIN_ERROR',
            error: message
          }, window.location.origin);
          
          setTimeout(() => window.close(), 3000);
        }
      }
    };

    handleCallback();
  }, [loginByWeChat]);

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="max-w-md w-full bg-white p-6 rounded-lg shadow-lg text-center">
        {status === 'loading' && (
          <>
            <Spinner className="w-8 h-8 mx-auto mb-4" />
            <p>正在处理微信登录...</p>
          </>
        )}
        
        {status === 'success' && (
          <>
            <CheckIcon className="w-8 h-8 mx-auto mb-4 text-green-500" />
            <p className="text-green-600">{message}</p>
          </>
        )}
        
        {status === 'error' && (
          <>
            <XCircleIcon className="w-8 h-8 mx-auto mb-4 text-red-500" />
            <p className="text-red-600 mb-4">{message}</p>
            <button
              onClick={() => window.close()}
              className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
            >
              关闭窗口
            </button>
          </>
        )}
      </div>
    </div>
  );
};
```

### 配置文件
```yaml
# application.yml
wechat:
  app:
    id: ${WECHAT_APP_ID:your-wechat-app-id}
    secret: ${WECHAT_APP_SECRET:your-wechat-app-secret}
  redirect:
    uri: ${WECHAT_REDIRECT_URI:http://localhost:3000/auth/wechat/callback}
```

## 安全考虑
- AppSecret不暴露到前端
- 使用HTTPS确保数据传输安全
- 验证授权回调的来源
- 防止CSRF攻击
- 合理设置Token过期时间

## 用户体验优化
- 扫码登录二维码自动刷新
- 移动端直接跳转微信授权
- 登录状态实时反馈
- 错误信息用户友好
- 支持取消登录操作

## 下一步
完成后进入 `02-4-2-Google OAuth登录集成`