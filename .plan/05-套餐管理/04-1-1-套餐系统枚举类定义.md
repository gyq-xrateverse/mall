# 04-1-1: 套餐系统枚举类定义

## 任务概述
**时间**: 第1天上午 (2小时)  
**目标**: 定义套餐管理系统相关的所有枚举类  
**优先级**: 最高  
**依赖**: 套餐系统数据库表结构设计完成

## 详细任务清单

### 1.1 套餐相关枚举

#### 1.1.1 套餐等级枚举
```java
// enums/SubscriptionLevel.java
package com.beilv.enums;

import lombok.AllArgsConstructor;
import lombok.Getter;

/**
 * 套餐等级枚举
 * 对应数据库字段: ums_member.subscription_level
 */
@Getter
@AllArgsConstructor
public enum SubscriptionLevel {
    FREE(0, "free", "免费版", 200, 1, 0),
    BASIC(1, "basic", "基础版", 500, 1, 1),
    STANDARD(2, "standard", "标准版", 1200, 2, 1),
    PROFESSIONAL(3, "professional", "专业版", 2500, 5, 2),
    ENTERPRISE(4, "enterprise", "企业版", 5000, 10, 2);
    
    private final Integer level;
    private final String code;
    private final String name;
    private final Integer dailyCredits;
    private final Integer maxConcurrentTasks;
    private final Integer priorityLevel;
    
    /**
     * 根据level获取枚举
     */
    public static SubscriptionLevel fromLevel(Integer level) {
        for (SubscriptionLevel sub : values()) {
            if (sub.getLevel().equals(level)) {
                return sub;
            }
        }
        throw new IllegalArgumentException("Invalid SubscriptionLevel: " + level);
    }
    
    /**
     * 根据code获取枚举
     */
    public static SubscriptionLevel fromCode(String code) {
        for (SubscriptionLevel sub : values()) {
            if (sub.getCode().equals(code)) {
                return sub;
            }
        }
        throw new IllegalArgumentException("Invalid SubscriptionLevel code: " + code);
    }
    
    /**
     * 判断是否为免费版
     */
    public boolean isFree() {
        return this == FREE;
    }
    
    /**
     * 判断是否为付费版
     */
    public boolean isPaid() {
        return this != FREE;
    }
    
    /**
     * 判断是否支持高级功能
     */
    public boolean supportsAdvancedFeatures() {
        return this.level >= STANDARD.level;
    }
    
    /**
     * 判断是否支持API访问
     */
    public boolean supportsAPI() {
        return this.level >= PROFESSIONAL.level;
    }
    
    /**
     * 获取下一个等级
     */
    public SubscriptionLevel getNextLevel() {
        SubscriptionLevel[] levels = values();
        for (int i = 0; i < levels.length - 1; i++) {
            if (levels[i] == this) {
                return levels[i + 1];
            }
        }
        return this; // 已经是最高等级
    }
    
    /**
     * 获取上一个等级
     */
    public SubscriptionLevel getPreviousLevel() {
        SubscriptionLevel[] levels = values();
        for (int i = 1; i < levels.length; i++) {
            if (levels[i] == this) {
                return levels[i - 1];
            }
        }
        return this; // 已经是最低等级
    }
}
```

#### 1.1.2 订阅状态枚举
```java
// enums/SubscriptionStatus.java
package com.beilv.enums;

import lombok.AllArgsConstructor;
import lombok.Getter;

/**
 * 订阅状态枚举
 * 对应数据库字段: oms_order.subscription_status
 */
@Getter
@AllArgsConstructor
public enum SubscriptionStatus {
    PENDING(0, "pending", "待生效"),
    ACTIVE(1, "active", "有效"),
    EXPIRED(2, "expired", "已过期"),
    CANCELLED(3, "cancelled", "已取消"),
    SUSPENDED(4, "suspended", "已暂停");
    
    private final Integer code;
    private final String status;
    private final String description;
    
    /**
     * 根据code获取枚举
     */
    public static SubscriptionStatus fromCode(Integer code) {
        for (SubscriptionStatus status : values()) {
            if (status.getCode().equals(code)) {
                return status;
            }
        }
        throw new IllegalArgumentException("Invalid SubscriptionStatus code: " + code);
    }
    
    /**
     * 根据status获取枚举
     */
    public static SubscriptionStatus fromStatus(String status) {
        for (SubscriptionStatus subscriptionStatus : values()) {
            if (subscriptionStatus.getStatus().equals(status)) {
                return subscriptionStatus;
            }
        }
        throw new IllegalArgumentException("Invalid SubscriptionStatus: " + status);
    }
    
    /**
     * 判断是否有效
     */
    public boolean isActive() {
        return this == ACTIVE;
    }
    
    /**
     * 判断是否已过期
     */
    public boolean isExpired() {
        return this == EXPIRED;
    }
    
    /**
     * 判断是否可用
     */
    public boolean isUsable() {
        return this == ACTIVE || this == PENDING;
    }
    
    /**
     * 判断是否可以续费
     */
    public boolean canRenew() {
        return this == ACTIVE || this == EXPIRED;
    }
    
    /**
     * 判断是否可以取消
     */
    public boolean canCancel() {
        return this == ACTIVE || this == PENDING;
    }
}
```

#### 1.1.3 套餐周期枚举
```java
// enums/SubscriptionPeriod.java
package com.beilv.enums;

import lombok.AllArgsConstructor;
import lombok.Getter;

/**
 * 套餐周期枚举
 * 对应数据库字段: pms_product.subscription_period
 */
@Getter
@AllArgsConstructor
public enum SubscriptionPeriod {
    MONTHLY(30, "monthly", "月", 1, 0),
    QUARTERLY(90, "quarterly", "季", 3, 15),
    YEARLY(365, "yearly", "年", 12, 25);
    
    private final Integer days;
    private final String code;
    private final String name;
    private final Integer months;
    private final Integer discountPercentage;
    
    /**
     * 根据天数获取枚举
     */
    public static SubscriptionPeriod fromDays(Integer days) {
        for (SubscriptionPeriod period : values()) {
            if (period.getDays().equals(days)) {
                return period;
            }
        }
        // 根据范围判断
        if (days <= 31) return MONTHLY;
        if (days <= 93) return QUARTERLY;
        return YEARLY;
    }
    
    /**
     * 根据code获取枚举
     */
    public static SubscriptionPeriod fromCode(String code) {
        for (SubscriptionPeriod period : values()) {
            if (period.getCode().equals(code)) {
                return period;
            }
        }
        throw new IllegalArgumentException("Invalid SubscriptionPeriod code: " + code);
    }
    
    /**
     * 判断是否有折扣
     */
    public boolean hasDiscount() {
        return this.discountPercentage > 0;
    }
    
    /**
     * 获取折扣后价格
     */
    public java.math.BigDecimal getDiscountedPrice(java.math.BigDecimal originalPrice) {
        if (!hasDiscount()) {
            return originalPrice;
        }
        return originalPrice.multiply(
            java.math.BigDecimal.valueOf(100 - discountPercentage).divide(
                java.math.BigDecimal.valueOf(100), 2, java.math.RoundingMode.HALF_UP
            )
        );
    }
}
```

### 1.2 权限相关枚举

#### 1.2.1 功能权限枚举
```java
// enums/FeaturePermission.java
package com.beilv.enums;

import lombok.AllArgsConstructor;
import lombok.Getter;

/**
 * 功能权限枚举
 * 定义不同套餐等级可使用的功能
 */
@Getter
@AllArgsConstructor
public enum FeaturePermission {
    BASIC_AI("basic_ai", "基础AI功能", SubscriptionLevel.FREE),
    ADVANCED_AI("advanced_ai", "高级AI功能", SubscriptionLevel.STANDARD),
    PRIORITY_QUEUE("priority_queue", "优先队列", SubscriptionLevel.STANDARD),
    API_ACCESS("api_access", "API接口访问", SubscriptionLevel.PROFESSIONAL),
    CUSTOM_MODELS("custom_models", "自定义模型", SubscriptionLevel.PROFESSIONAL),
    TEAM_MANAGEMENT("team_management", "团队管理", SubscriptionLevel.ENTERPRISE),
    ADVANCED_ANALYTICS("advanced_analytics", "高级分析", SubscriptionLevel.ENTERPRISE),
    WHITE_LABEL("white_label", "白标服务", SubscriptionLevel.ENTERPRISE);
    
    private final String feature;
    private final String description;
    private final SubscriptionLevel requiredLevel;
    
    /**
     * 根据feature获取枚举
     */
    public static FeaturePermission fromFeature(String feature) {
        for (FeaturePermission permission : values()) {
            if (permission.getFeature().equals(feature)) {
                return permission;
            }
        }
        throw new IllegalArgumentException("Invalid FeaturePermission: " + feature);
    }
    
    /**
     * 检查套餐等级是否有权限
     */
    public boolean hasPermission(SubscriptionLevel userLevel) {
        return userLevel.getLevel() >= this.requiredLevel.getLevel();
    }
    
    /**
     * 获取所有基础功能
     */
    public static FeaturePermission[] getBasicFeatures() {
        return new FeaturePermission[]{BASIC_AI};
    }
    
    /**
     * 获取高级功能
     */
    public static FeaturePermission[] getAdvancedFeatures() {
        return new FeaturePermission[]{
            ADVANCED_AI, PRIORITY_QUEUE, API_ACCESS, CUSTOM_MODELS
        };
    }
    
    /**
     * 获取企业功能
     */
    public static FeaturePermission[] getEnterpriseFeatures() {
        return new FeaturePermission[]{
            TEAM_MANAGEMENT, ADVANCED_ANALYTICS, WHITE_LABEL
        };
    }
}
```

#### 1.2.2 任务优先级枚举
```java
// enums/TaskPriority.java
package com.beilv.enums;

import lombok.AllArgsConstructor;
import lombok.Getter;

/**
 * 任务优先级枚举
 * 对应数据库字段: pms_product.priority_level
 */
@Getter
@AllArgsConstructor
public enum TaskPriority {
    NORMAL(0, "normal", "普通", 0),
    HIGH(1, "high", "高", -10),
    HIGHEST(2, "highest", "最高", -20);
    
    private final Integer level;
    private final String code;
    private final String name;
    private final Integer queueOffset; // 队列偏移量，负数表示提前
    
    /**
     * 根据level获取枚举
     */
    public static TaskPriority fromLevel(Integer level) {
        for (TaskPriority priority : values()) {
            if (priority.getLevel().equals(level)) {
                return priority;
            }
        }
        throw new IllegalArgumentException("Invalid TaskPriority level: " + level);
    }
    
    /**
     * 根据code获取枚举
     */
    public static TaskPriority fromCode(String code) {
        for (TaskPriority priority : values()) {
            if (priority.getCode().equals(code)) {
                return priority;
            }
        }
        throw new IllegalArgumentException("Invalid TaskPriority code: " + code);
    }
    
    /**
     * 判断是否为高优先级
     */
    public boolean isHigh() {
        return this.level > NORMAL.level;
    }
    
    /**
     * 获取队列权重
     */
    public int getQueueWeight() {
        return 100 + this.queueOffset;
    }
}
```

### 1.3 自动续费相关枚举

#### 1.3.1 自动续费状态枚举
```java
// enums/AutoRenewStatus.java
package com.beilv.enums;

import lombok.AllArgsConstructor;
import lombok.Getter;

/**
 * 自动续费状态枚举
 * 对应数据库字段: oms_order.auto_renew
 */
@Getter
@AllArgsConstructor
public enum AutoRenewStatus {
    DISABLED(0, "disabled", "未开启"),
    ENABLED(1, "enabled", "已开启"),
    PAUSED(2, "paused", "已暂停"),
    FAILED(3, "failed", "失败");
    
    private final Integer code;
    private final String status;
    private final String description;
    
    /**
     * 根据code获取枚举
     */
    public static AutoRenewStatus fromCode(Integer code) {
        for (AutoRenewStatus status : values()) {
            if (status.getCode().equals(code)) {
                return status;
            }
        }
        throw new IllegalArgumentException("Invalid AutoRenewStatus code: " + code);
    }
    
    /**
     * 根据status获取枚举
     */
    public static AutoRenewStatus fromStatus(String status) {
        for (AutoRenewStatus renewStatus : values()) {
            if (renewStatus.getStatus().equals(status)) {
                return renewStatus;
            }
        }
        throw new IllegalArgumentException("Invalid AutoRenewStatus: " + status);
    }
    
    /**
     * 判断是否启用
     */
    public boolean isEnabled() {
        return this == ENABLED;
    }
    
    /**
     * 判断是否可以续费
     */
    public boolean canRenew() {
        return this == ENABLED;
    }
    
    /**
     * 判断是否需要用户干预
     */
    public boolean needsUserIntervention() {
        return this == PAUSED || this == FAILED;
    }
}
```

### 1.4 订单业务类型枚举

#### 1.4.1 订单业务类型枚举
```java
// enums/OrderBusinessType.java
package com.beilv.enums;

import lombok.AllArgsConstructor;
import lombok.Getter;

/**
 * 订单业务类型枚举
 * 对应数据库字段: oms_order.business_type
 */
@Getter
@AllArgsConstructor
public enum OrderBusinessType {
    PRODUCT_PURCHASE(0, "product", "商品购买"),
    SUBSCRIPTION(1, "subscription", "套餐订阅"),
    CREDITS_RECHARGE(2, "credits", "积分充值"),
    SUBSCRIPTION_RENEWAL(3, "renewal", "套餐续费"),
    SUBSCRIPTION_UPGRADE(4, "upgrade", "套餐升级"),
    SUBSCRIPTION_DOWNGRADE(5, "downgrade", "套餐降级");
    
    private final Integer code;
    private final String type;
    private final String description;
    
    /**
     * 根据code获取枚举
     */
    public static OrderBusinessType fromCode(Integer code) {
        for (OrderBusinessType type : values()) {
            if (type.getCode().equals(code)) {
                return type;
            }
        }
        throw new IllegalArgumentException("Invalid OrderBusinessType code: " + code);
    }
    
    /**
     * 根据type获取枚举
     */
    public static OrderBusinessType fromType(String type) {
        for (OrderBusinessType businessType : values()) {
            if (businessType.getType().equals(type)) {
                return businessType;
            }
        }
        throw new IllegalArgumentException("Invalid OrderBusinessType: " + type);
    }
    
    /**
     * 判断是否为套餐相关业务
     */
    public boolean isSubscriptionRelated() {
        return this == SUBSCRIPTION || this == SUBSCRIPTION_RENEWAL || 
               this == SUBSCRIPTION_UPGRADE || this == SUBSCRIPTION_DOWNGRADE;
    }
    
    /**
     * 判断是否为升级/降级
     */
    public boolean isLevelChange() {
        return this == SUBSCRIPTION_UPGRADE || this == SUBSCRIPTION_DOWNGRADE;
    }
    
    /**
     * 判断是否需要即时生效
     */
    public boolean needsImmediateEffect() {
        return this == SUBSCRIPTION_UPGRADE || this == CREDITS_RECHARGE;
    }
}
```

### 1.5 推荐相关枚举

#### 1.5.1 套餐推荐动作枚举
```java
// enums/RecommendationAction.java
package com.beilv.enums;

import lombok.AllArgsConstructor;
import lombok.Getter;

/**
 * 套餐推荐动作枚举
 * 用于个性化套餐推荐
 */
@Getter
@AllArgsConstructor
public enum RecommendationAction {
    MAINTAIN("maintain", "保持当前套餐", "您的当前套餐很适合您的使用需求"),
    UPGRADE("upgrade", "建议升级套餐", "根据您的使用情况，建议升级以获得更好的体验"),
    DOWNGRADE("downgrade", "考虑降级套餐", "您的使用量较低，可以考虑更经济的套餐"),
    RENEW("renew", "建议续费", "您的套餐即将到期，建议及时续费"),
    REACTIVATE("reactivate", "建议重新订阅", "重新订阅以继续享受高级功能");
    
    private final String action;
    private final String title;
    private final String description;
    
    /**
     * 根据action获取枚举
     */
    public static RecommendationAction fromAction(String action) {
        for (RecommendationAction recommendationAction : values()) {
            if (recommendationAction.getAction().equals(action)) {
                return recommendationAction;
            }
        }
        throw new IllegalArgumentException("Invalid RecommendationAction: " + action);
    }
    
    /**
     * 判断是否为升级建议
     */
    public boolean isUpgrade() {
        return this == UPGRADE;
    }
    
    /**
     * 判断是否为降级建议
     */
    public boolean isDowngrade() {
        return this == DOWNGRADE;
    }
    
    /**
     * 判断是否为续费相关
     */
    public boolean isRenewalRelated() {
        return this == RENEW || this == REACTIVATE;
    }
}
```

### 1.6 枚举工具类

#### 1.6.1 套餐枚举工具类
```java
// utils/SubscriptionEnumUtils.java
package com.beilv.utils;

import com.beilv.enums.*;
import java.math.BigDecimal;
import java.time.LocalDate;

/**
 * 套餐相关枚举转换工具类
 */
public class SubscriptionEnumUtils {
    
    /**
     * 安全转换套餐等级枚举
     */
    public static SubscriptionLevel safeFromSubscriptionLevel(Integer level) {
        try {
            return level != null ? SubscriptionLevel.fromLevel(level) : SubscriptionLevel.FREE;
        } catch (IllegalArgumentException e) {
            return SubscriptionLevel.FREE;
        }
    }
    
    /**
     * 安全转换订阅状态枚举
     */
    public static SubscriptionStatus safeFromSubscriptionStatusCode(Integer code) {
        try {
            return code != null ? SubscriptionStatus.fromCode(code) : SubscriptionStatus.PENDING;
        } catch (IllegalArgumentException e) {
            return SubscriptionStatus.PENDING;
        }
    }
    
    /**
     * 安全转换套餐周期枚举
     */
    public static SubscriptionPeriod safeFromPeriodDays(Integer days) {
        try {
            return days != null ? SubscriptionPeriod.fromDays(days) : SubscriptionPeriod.MONTHLY;
        } catch (IllegalArgumentException e) {
            return SubscriptionPeriod.MONTHLY;
        }
    }
    
    /**
     * 检查用户是否有指定功能权限
     */
    public static boolean hasFeaturePermission(SubscriptionLevel userLevel, String feature) {
        try {
            FeaturePermission permission = FeaturePermission.fromFeature(feature);
            return permission.hasPermission(userLevel);
        } catch (IllegalArgumentException e) {
            return false;
        }
    }
    
    /**
     * 获取套餐升级建议
     */
    public static RecommendationAction getUpgradeRecommendation(
            SubscriptionLevel currentLevel, 
            double usagePercentage,
            LocalDate subscriptionEndDate) {
        
        // 套餐即将过期
        if (subscriptionEndDate != null && subscriptionEndDate.isBefore(LocalDate.now().plusDays(7))) {
            if (currentLevel.isFree()) {
                return RecommendationAction.REACTIVATE;
            } else {
                return RecommendationAction.RENEW;
            }
        }
        
        // 根据使用率推荐
        if (usagePercentage > 0.9) {
            return RecommendationAction.UPGRADE;
        } else if (usagePercentage < 0.3 && currentLevel.isPaid()) {
            return RecommendationAction.DOWNGRADE;
        } else {
            return RecommendationAction.MAINTAIN;
        }
    }
    
    /**
     * 计算套餐优惠价格
     */
    public static BigDecimal calculateDiscountPrice(
            BigDecimal originalPrice, 
            SubscriptionPeriod period) {
        
        return period.getDiscountedPrice(originalPrice);
    }
    
    /**
     * 判断是否可以执行套餐操作
     */
    public static boolean canPerformAction(
            SubscriptionStatus currentStatus, 
            OrderBusinessType actionType) {
        
        switch (actionType) {
            case SUBSCRIPTION_RENEWAL:
                return currentStatus.canRenew();
            case SUBSCRIPTION_UPGRADE:
            case SUBSCRIPTION_DOWNGRADE:
                return currentStatus.isActive();
            default:
                return currentStatus.canCancel();
        }
    }
    
    /**
     * 获取套餐功能描述
     */
    public static String getFeatureDescription(SubscriptionLevel level) {
        StringBuilder features = new StringBuilder();
        features.append("每日").append(level.getDailyCredits()).append("积分，");
        features.append("最多").append(level.getMaxConcurrentTasks()).append("个并发任务");
        
        if (level.supportsAdvancedFeatures()) {
            features.append("，高级AI功能");
        }
        if (level.supportsAPI()) {
            features.append("，API接口访问");
        }
        
        return features.toString();
    }
}
```

## 验收标准
- [x] 所有套餐相关状态字段都有对应枚举类
- [x] 枚举类包含完整的业务属性和方法
- [x] 提供安全转换和业务判断方法
- [x] 权限检查逻辑完整准确
- [x] 推荐算法枚举设计合理
- [x] 价格计算和折扣逻辑正确
- [x] 完整的异常处理机制
- [x] 符合Java命名规范和代码风格

## 交付物
- [x] SubscriptionLevel.java - 套餐等级枚举
- [x] SubscriptionStatus.java - 订阅状态枚举
- [x] SubscriptionPeriod.java - 套餐周期枚举
- [x] FeaturePermission.java - 功能权限枚举
- [x] TaskPriority.java - 任务优先级枚举
- [x] AutoRenewStatus.java - 自动续费状态枚举
- [x] OrderBusinessType.java - 订单业务类型枚举
- [x] RecommendationAction.java - 推荐动作枚举
- [x] SubscriptionEnumUtils.java - 套餐枚举工具类

## 验证测试
1. 编译所有枚举类无错误
2. 测试权限检查逻辑
3. 验证价格计算和折扣功能
4. 测试推荐算法枚举
5. 检查工具类转换功能
6. 验证业务判断方法

## 风险控制
- **权限安全**: 权限检查逻辑严格准确
- **业务逻辑**: 套餐升降级和续费逻辑清晰
- **价格计算**: 折扣和价格计算准确无误
- **扩展性**: 便于新增套餐等级和功能

## 下一步
完成后集成到 `04-1-2-套餐核心服务实现`