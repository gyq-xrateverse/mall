# 04-3: 套餐前端状态管理

## 任务概述
**时间**: 第6-7天  
**目标**: 实现前端套餐状态管理和API集成  
**优先级**: 最高  
**依赖**: 04-2 套餐API控制器开发完成

## 详细任务清单

### 3.1 套餐状态切片

#### 3.1.1 套餐状态定义
```typescript
// store/subscription/subscriptionSlice.ts
import { createSlice, createAsyncThunk } from '@reduxjs/toolkit';
import { subscriptionAPI } from '@/api/subscription';

interface UserSubscription {
  memberId: number;
  subscriptionId: number | null;
  planName: string;
  subscriptionLevel: number;
  subscriptionStatus: number;
  subscriptionStartDate: string | null;
  subscriptionEndDate: string | null;
  autoRenew: boolean;
  dailyCreditsLimit: number;
  dailyCreditsUsed: number;
  maxConcurrentTasks: number;
  priorityLevel: number;
  planFeatures: Record<string, any>;
}

interface SubscriptionPlan {
  id: number;
  name: string;
  description: string;
  price: number;
  originalPrice?: number;
  discountPercentage?: number;
  subscriptionPeriod: number;
  dailyCredits: number;
  totalCredits: number;
  maxConcurrentTasks: number;
  priorityLevel: number;
  features: Record<string, any>;
  isRecommended: boolean;
  isHot: boolean;
  periodText: string;
}

interface SubscriptionUsage {
  period: string;
  totalCreditsUsed: number;
  totalTasksCreated: number;
  averageDailyUsage: number;
  dailyUsage: Array<{
    date: string;
    creditsUsed: number;
    tasksCreated: number;
  }>;
}

interface PlanRecommendation {
  action: 'upgrade' | 'downgrade' | 'maintain';
  recommendedPlanId?: number;
  reason: string;
  potentialSavings?: number;
  additionalBenefits?: string[];
}

interface SubscriptionState {
  currentSubscription: UserSubscription | null;
  availablePlans: SubscriptionPlan[];
  usageStats: SubscriptionUsage | null;
  recommendation: PlanRecommendation | null;
  permissions: Record<string, boolean>;
  loading: boolean;
  subscribeLoading: boolean;
  cancelLoading: boolean;
  error: string | null;
}

const initialState: SubscriptionState = {
  currentSubscription: null,
  availablePlans: [],
  usageStats: null,
  recommendation: null,
  permissions: {},
  loading: false,
  subscribeLoading: false,
  cancelLoading: false,
  error: null,
};
```

#### 3.1.2 异步Actions
```typescript
// 获取当前订阅信息
export const fetchCurrentSubscription = createAsyncThunk(
  'subscription/fetchCurrent',
  async () => {
    const response = await subscriptionAPI.getCurrentSubscription();
    return response.data;
  }
);

// 获取可用套餐
export const fetchAvailablePlans = createAsyncThunk(
  'subscription/fetchPlans',
  async () => {
    const response = await subscriptionAPI.getAvailablePlans();
    return response.data;
  }
);

// 订阅套餐
export const subscribeToPlan = createAsyncThunk(
  'subscription/subscribe',
  async (params: { planId: number; autoRenew: boolean }) => {
    const response = await subscriptionAPI.subscribeToPlan(params);
    return response.data;
  }
);

// 取消订阅
export const cancelSubscription = createAsyncThunk(
  'subscription/cancel',
  async (subscriptionId: number) => {
    const response = await subscriptionAPI.cancelSubscription(subscriptionId);
    return response.data;
  }
);

// 获取使用统计
export const fetchUsageStats = createAsyncThunk(
  'subscription/fetchUsage',
  async (days: number = 30) => {
    const response = await subscriptionAPI.getUsageStatistics(days);
    return response.data;
  }
);

// 获取个性化推荐
export const fetchRecommendation = createAsyncThunk(
  'subscription/fetchRecommendation',
  async () => {
    const response = await subscriptionAPI.getPersonalizedRecommendation();
    return response.data;
  }
);

// 检查权限
export const checkPermissions = createAsyncThunk(
  'subscription/checkPermissions',
  async (features: string[]) => {
    const response = await subscriptionAPI.checkPermissions({ features });
    return { features, permissions: response.data };
  }
);

// 升级套餐
export const upgradeSubscription = createAsyncThunk(
  'subscription/upgrade',
  async (planId: number) => {
    const response = await subscriptionAPI.upgradeSubscription({ planId });
    return response.data;
  }
);
```

#### 3.1.3 Slice实现
```typescript
const subscriptionSlice = createSlice({
  name: 'subscription',
  initialState,
  reducers: {
    clearError: (state) => {
      state.error = null;
    },
    
    // 实时更新订阅状态
    updateSubscriptionStatus: (state, action) => {
      if (state.currentSubscription) {
        state.currentSubscription.subscriptionStatus = action.payload;
      }
    },
    
    // 更新每日使用量
    updateDailyUsage: (state, action) => {
      if (state.currentSubscription) {
        state.currentSubscription.dailyCreditsUsed = action.payload;
      }
    },
    
    // 重置每日统计
    resetDailyStats: (state) => {
      if (state.currentSubscription) {
        state.currentSubscription.dailyCreditsUsed = 0;
      }
    },
    
    // 清除推荐
    clearRecommendation: (state) => {
      state.recommendation = null;
    },
  },
  
  extraReducers: (builder) => {
    builder
      // 获取当前订阅
      .addCase(fetchCurrentSubscription.pending, (state) => {
        state.loading = true;
        state.error = null;
      })
      .addCase(fetchCurrentSubscription.fulfilled, (state, action) => {
        state.loading = false;
        state.currentSubscription = action.payload;
      })
      .addCase(fetchCurrentSubscription.rejected, (state, action) => {
        state.loading = false;
        state.error = action.error.message || '获取套餐信息失败';
      })
      
      // 获取可用套餐
      .addCase(fetchAvailablePlans.fulfilled, (state, action) => {
        state.availablePlans = action.payload;
      })
      
      // 订阅套餐
      .addCase(subscribeToPlan.pending, (state) => {
        state.subscribeLoading = true;
        state.error = null;
      })
      .addCase(subscribeToPlan.fulfilled, (state, action) => {
        state.subscribeLoading = false;
        // 订阅成功后通常需要跳转到支付页面
      })
      .addCase(subscribeToPlan.rejected, (state, action) => {
        state.subscribeLoading = false;
        state.error = action.error.message || '订阅失败';
      })
      
      // 取消订阅
      .addCase(cancelSubscription.pending, (state) => {
        state.cancelLoading = true;
        state.error = null;
      })
      .addCase(cancelSubscription.fulfilled, (state) => {
        state.cancelLoading = false;
        // 重新获取订阅信息
      })
      .addCase(cancelSubscription.rejected, (state, action) => {
        state.cancelLoading = false;
        state.error = action.error.message || '取消订阅失败';
      })
      
      // 获取使用统计
      .addCase(fetchUsageStats.fulfilled, (state, action) => {
        state.usageStats = action.payload;
      })
      
      // 获取推荐
      .addCase(fetchRecommendation.fulfilled, (state, action) => {
        state.recommendation = action.payload;
      })
      
      // 检查权限
      .addCase(checkPermissions.fulfilled, (state, action) => {
        const { features, permissions } = action.payload;
        features.forEach(feature => {
          state.permissions[feature] = permissions[feature];
        });
      })
      
      // 升级套餐
      .addCase(upgradeSubscription.pending, (state) => {
        state.subscribeLoading = true;
        state.error = null;
      })
      .addCase(upgradeSubscription.fulfilled, (state) => {
        state.subscribeLoading = false;
      })
      .addCase(upgradeSubscription.rejected, (state, action) => {
        state.subscribeLoading = false;
        state.error = action.error.message || '升级失败';
      });
  },
});

export const {
  clearError,
  updateSubscriptionStatus,
  updateDailyUsage,
  resetDailyStats,
  clearRecommendation,
} = subscriptionSlice.actions;

export default subscriptionSlice.reducer;
```

**验收标准**:
- [x] 状态结构合理完整
- [x] 异步操作正确处理
- [x] 错误处理机制完善
- [x] 状态更新逻辑正确

### 3.2 RTK Query API集成

#### 3.2.1 套餐API定义
```typescript
// api/subscriptionApi.ts
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react';
import type { RootState } from '@/store';

export const subscriptionApi = createApi({
  reducerPath: 'subscriptionApi',
  baseQuery: fetchBaseQuery({
    baseUrl: '/api/subscription',
    prepareHeaders: (headers, { getState }) => {
      const state = getState() as RootState;
      const token = state.auth.token;
      
      if (token) {
        headers.set('authorization', `Bearer ${token}`);
      }
      
      return headers;
    },
  }),
  tagTypes: ['Subscription', 'Plans', 'Usage', 'Permissions'],
  
  endpoints: (builder) => ({
    // 获取当前订阅
    getCurrentSubscription: builder.query<UserSubscription, void>({
      query: () => '/current',
      providesTags: ['Subscription'],
    }),
    
    // 获取可用套餐
    getAvailablePlans: builder.query<SubscriptionPlan[], void>({
      query: () => '/plans',
      providesTags: ['Plans'],
    }),
    
    // 获取套餐比较
    getPlanComparison: builder.query<any, void>({
      query: () => '/compare',
      providesTags: ['Plans'],
    }),
    
    // 订阅套餐
    subscribeToPlan: builder.mutation<any, {
      planId: number;
      autoRenew: boolean;
    }>({
      query: (data) => ({
        url: '/subscribe',
        method: 'POST',
        body: data,
      }),
      invalidatesTags: ['Subscription'],
    }),
    
    // 取消订阅
    cancelSubscription: builder.mutation<string, number>({
      query: (subscriptionId) => ({
        url: `/cancel/${subscriptionId}`,
        method: 'POST',
      }),
      invalidatesTags: ['Subscription'],
    }),
    
    // 续费订阅
    renewSubscription: builder.mutation<any, number>({
      query: (subscriptionId) => ({
        url: `/renew/${subscriptionId}`,
        method: 'POST',
      }),
      invalidatesTags: ['Subscription'],
    }),
    
    // 获取使用统计
    getUsageStatistics: builder.query<SubscriptionUsage, number>({
      query: (days = 30) => ({
        url: '/usage',
        params: { days },
      }),
      providesTags: ['Usage'],
    }),
    
    // 检查权限
    checkPermissions: builder.query<Record<string, boolean>, {
      features: string[];
    }>({
      query: ({ features }) => ({
        url: '/check-permission',
        method: 'POST',
        body: { features },
      }),
      providesTags: ['Permissions'],
    }),
    
    // 升级套餐
    upgradeSubscription: builder.mutation<any, { planId: number }>({
      query: (data) => ({
        url: '/upgrade',
        method: 'POST',
        body: data,
      }),
      invalidatesTags: ['Subscription'],
    }),
    
    // 获取个性化推荐
    getPersonalizedRecommendation: builder.query<PlanRecommendation, void>({
      query: () => '/recommend',
    }),
    
    // 获取订单历史
    getSubscriptionOrders: builder.query<any, {
      pageNum?: number;
      pageSize?: number;
    }>({
      query: (params) => ({
        url: '/orders',
        params,
      }),
    }),
  }),
});

export const {
  useGetCurrentSubscriptionQuery,
  useGetAvailablePlansQuery,
  useGetPlanComparisonQuery,
  useSubscribeToPlanMutation,
  useCancelSubscriptionMutation,
  useRenewSubscriptionMutation,
  useGetUsageStatisticsQuery,
  useCheckPermissionsQuery,
  useUpgradeSubscriptionMutation,
  useGetPersonalizedRecommendationQuery,
  useGetSubscriptionOrdersQuery,
} = subscriptionApi;
```

**验收标准**:
- [x] RTK Query API定义完整
- [x] 自动缓存和失效机制
- [x] 类型安全的API调用
- [x] 错误处理和重试机制

### 3.3 自定义Hooks

#### 3.3.1 套餐管理Hook
```typescript
// hooks/useSubscription.ts
import { useAppSelector, useAppDispatch } from './redux';
import { 
  fetchCurrentSubscription,
  fetchAvailablePlans,
  subscribeToPlan,
  cancelSubscription,
  clearError 
} from '@/store/subscription/subscriptionSlice';
import { useGetCurrentSubscriptionQuery } from '@/api/subscriptionApi';

export const useSubscription = () => {
  const dispatch = useAppDispatch();
  const subscription = useAppSelector(state => state.subscription);
  
  // 使用RTK Query获取实时数据
  const { 
    data: currentSubscription, 
    isLoading, 
    error,
    refetch 
  } = useGetCurrentSubscriptionQuery();

  const refreshSubscription = () => {
    refetch();
  };

  const clearSubscriptionError = () => {
    dispatch(clearError());
  };

  // 计算订阅状态
  const isSubscribed = currentSubscription?.subscriptionLevel > 0;
  const isExpiringSoon = currentSubscription?.subscriptionEndDate 
    ? new Date(currentSubscription.subscriptionEndDate) < new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
    : false;

  // 计算剩余积分百分比
  const creditsUsagePercentage = currentSubscription 
    ? Math.round((currentSubscription.dailyCreditsUsed / currentSubscription.dailyCreditsLimit) * 100)
    : 0;

  return {
    currentSubscription: currentSubscription || subscription.currentSubscription,
    availablePlans: subscription.availablePlans,
    isLoading: isLoading || subscription.loading,
    error: error || subscription.error,
    isSubscribed,
    isExpiringSoon,
    creditsUsagePercentage,
    refreshSubscription,
    clearSubscriptionError,
  };
};
```

#### 3.3.2 套餐权限Hook
```typescript
// hooks/useSubscriptionPermissions.ts
import { useMemo } from 'react';
import { useSubscription } from './useSubscription';
import { useCheckPermissionsQuery } from '@/api/subscriptionApi';

export const useSubscriptionPermissions = (features: string[] = []) => {
  const { currentSubscription } = useSubscription();
  
  const { data: permissions, isLoading } = useCheckPermissionsQuery(
    { features },
    { skip: features.length === 0 }
  );

  const permissionHelpers = useMemo(() => ({
    // 检查单个权限
    hasPermission: (feature: string): boolean => {
      return permissions?.[feature] || false;
    },
    
    // 检查多个权限（都需要有）
    hasAllPermissions: (requiredFeatures: string[]): boolean => {
      return requiredFeatures.every(feature => permissions?.[feature]);
    },
    
    // 检查多个权限（任一即可）
    hasAnyPermission: (requiredFeatures: string[]): boolean => {
      return requiredFeatures.some(feature => permissions?.[feature]);
    },
    
    // 获取权限级别
    getPermissionLevel: (): number => {
      return currentSubscription?.subscriptionLevel || 0;
    },
    
    // 检查是否可以使用高级功能
    canUseAdvancedFeatures: (): boolean => {
      return currentSubscription?.subscriptionLevel >= 2;
    },
    
    // 检查是否可以使用API
    canUseAPI: (): boolean => {
      return currentSubscription?.subscriptionLevel >= 3;
    },
    
    // 检查每日积分限制
    hasCreditsRemaining: (): boolean => {
      if (!currentSubscription) return false;
      return currentSubscription.dailyCreditsUsed < currentSubscription.dailyCreditsLimit;
    },
    
    // 获取剩余积分
    getRemainingCredits: (): number => {
      if (!currentSubscription) return 0;
      return Math.max(0, currentSubscription.dailyCreditsLimit - currentSubscription.dailyCreditsUsed);
    },
  }), [permissions, currentSubscription]);

  return {
    permissions: permissions || {},
    isLoading,
    ...permissionHelpers,
  };
};
```

#### 3.3.3 套餐推荐Hook
```typescript
// hooks/useSubscriptionRecommendation.ts
import { useEffect } from 'react';
import { useAppDispatch, useAppSelector } from './redux';
import { fetchRecommendation, clearRecommendation } from '@/store/subscription/subscriptionSlice';
import { useGetPersonalizedRecommendationQuery } from '@/api/subscriptionApi';

export const useSubscriptionRecommendation = () => {
  const dispatch = useAppDispatch();
  const { recommendation } = useAppSelector(state => state.subscription);
  
  const { 
    data: apiRecommendation, 
    isLoading,
    error 
  } = useGetPersonalizedRecommendationQuery();

  const clearRecommendationData = () => {
    dispatch(clearRecommendation());
  };

  // 推荐相关的辅助方法
  const recommendationHelpers = {
    shouldUpgrade: (): boolean => {
      return apiRecommendation?.action === 'upgrade';
    },
    
    shouldDowngrade: (): boolean => {
      return apiRecommendation?.action === 'downgrade';
    },
    
    shouldMaintain: (): boolean => {
      return apiRecommendation?.action === 'maintain';
    },
    
    getRecommendationText: (): string => {
      if (!apiRecommendation) return '';
      
      const { action, reason } = apiRecommendation;
      const actionTexts = {
        upgrade: '建议升级套餐',
        downgrade: '建议使用更经济的套餐',
        maintain: '当前套餐很适合您',
      };
      
      return `${actionTexts[action]}: ${reason}`;
    },
    
    getPotentialSavings: (): number => {
      return apiRecommendation?.potentialSavings || 0;
    },
    
    getAdditionalBenefits: (): string[] => {
      return apiRecommendation?.additionalBenefits || [];
    },
  };

  return {
    recommendation: apiRecommendation || recommendation,
    isLoading,
    error,
    clearRecommendationData,
    ...recommendationHelpers,
  };
};
```

**验收标准**:
- [x] 自定义Hooks功能完整
- [x] 状态管理逻辑正确
- [x] 权限检查准确
- [x] 性能优化合理

## 交付物
- [x] 套餐Redux状态切片
- [x] RTK Query API集成
- [x] 套餐相关自定义Hooks
- [x] 权限管理Hook
- [x] 推荐系统Hook

## 验证测试
1. 测试套餐状态管理
2. 验证API自动缓存
3. 测试权限检查功能
4. 检查推荐系统准确性
5. 验证实时状态更新

## 风险控制
- **状态同步**: 确保前后端状态同步
- **权限安全**: 前端权限检查与后端一致
- **缓存策略**: 合理的缓存失效机制

## 下一步
完成后进入 `04-4-套餐界面组件开发`