# 04-2: 套餐API控制器开发

## 任务概述
**时间**: 第4-5天  
**目标**: 开发套餐管理相关的REST API控制器  
**优先级**: 最高  
**依赖**: 04-1 套餐数据模型和服务完成

## 详细任务清单

### 2.1 套餐控制器实现

#### 2.1.1 套餐相关DTO
```java
// 用户套餐信息响应
@Data
public class UserSubscriptionVO {
    private Long memberId;
    private Long subscriptionId;
    private String planName;
    private Integer subscriptionLevel;        // 套餐等级
    private Integer subscriptionStatus;       // 订阅状态
    private Date subscriptionStartDate;      // 开始日期
    private Date subscriptionEndDate;        // 结束日期
    private Boolean autoRenew;               // 自动续费
    private Integer dailyCreditsLimit;       // 每日积分限额
    private Integer dailyCreditsUsed;        // 当日已用积分
    private Integer maxConcurrentTasks;      // 最大并发任务数
    private Integer priorityLevel;           // 优先级等级
    private Map<String, Object> planFeatures; // 套餐特性
}

// 套餐计划VO
@Data
public class SubscriptionPlanVO {
    private Long id;
    private String name;
    private String description;
    private BigDecimal price;
    private BigDecimal originalPrice;
    private Integer discountPercentage;
    private Integer subscriptionPeriod;      // 订阅周期(天)
    private Integer dailyCredits;           // 每日积分
    private Integer totalCredits;           // 总积分(展示用)
    private Integer maxConcurrentTasks;     // 最大并发任务
    private Integer priorityLevel;          // 优先级
    private Map<String, Object> features;   // 特性配置
    private Boolean isRecommended;          // 是否推荐
    private Boolean isHot;                  // 是否热门
    private String periodText;              // 周期文本: "月"/"季"/"年"
}

// 订阅请求
@Data
public class SubscribeRequest {
    @NotNull(message = "套餐ID不能为空")
    private Long planId;
    
    private Boolean autoRenew = false;      // 默认不自动续费
}

// 套餐使用统计VO
@Data
public class SubscriptionUsageVO {
    private String period;                  // 统计周期
    private Integer totalCreditsUsed;       // 总使用积分
    private Integer totalTasksCreated;      // 总创建任务
    private Integer averageDailyUsage;      // 平均日使用量
    private List<DailyUsageVO> dailyUsage; // 每日使用详情
}

@Data
public class DailyUsageVO {
    private String date;
    private Integer creditsUsed;
    private Integer tasksCreated;
}
```

#### 2.1.2 套餐控制器实现
```java
// SubscriptionController.java
@RestController
@RequestMapping("/api/subscription")
@Validated
@Slf4j
public class SubscriptionController {
    
    @Autowired
    private SubscriptionService subscriptionService;
    
    @Autowired
    private OmsOrderService orderService;
    
    @GetMapping("/current")
    @ApiOperation("获取当前用户套餐信息")
    public CommonResult<UserSubscriptionVO> getCurrentSubscription(HttpServletRequest request) {
        try {
            Long memberId = getCurrentMemberId(request);
            UserSubscriptionVO subscription = subscriptionService.getCurrentSubscription(memberId);
            
            return CommonResult.success(subscription);
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Get current subscription failed", e);
            return CommonResult.failed("获取套餐信息失败");
        }
    }
    
    @GetMapping("/plans")
    @ApiOperation("获取所有可用套餐计划")
    public CommonResult<List<SubscriptionPlanVO>> getAvailablePlans() {
        try {
            List<SubscriptionPlanVO> plans = subscriptionService.getAvailablePlans();
            
            // 按价格排序，添加周期文本
            plans.forEach(plan -> {
                int period = plan.getSubscriptionPeriod();
                if (period <= 31) {
                    plan.setPeriodText("月");
                } else if (period <= 93) {
                    plan.setPeriodText("季");
                } else {
                    plan.setPeriodText("年");
                }
            });
            
            return CommonResult.success(plans);
            
        } catch (Exception e) {
            log.error("Get available plans failed", e);
            return CommonResult.failed("获取套餐计划失败");
        }
    }
    
    @PostMapping("/subscribe")
    @ApiOperation("订阅套餐")
    public CommonResult<Map<String, Object>> subscribeToPlan(
            HttpServletRequest request,
            @Valid @RequestBody SubscribeRequest subscribeRequest) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            
            // 创建订阅订单
            OmsOrder order = subscriptionService.subscribeToplan(
                memberId, 
                subscribeRequest.getPlanId(), 
                subscribeRequest.getAutoRenew()
            );
            
            Map<String, Object> result = new HashMap<>();
            result.put("orderId", order.getId());
            result.put("orderSn", order.getOrderSn());
            result.put("payAmount", order.getPayAmount());
            result.put("autoRenew", subscribeRequest.getAutoRenew());
            
            return CommonResult.success(result, "套餐订单创建成功");
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Subscribe to plan failed", e);
            return CommonResult.failed("订阅套餐失败");
        }
    }
    
    @PostMapping("/cancel/{subscriptionId}")
    @ApiOperation("取消订阅")
    public CommonResult<String> cancelSubscription(
            HttpServletRequest request,
            @PathVariable Long subscriptionId) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            boolean success = subscriptionService.cancelSubscription(memberId, subscriptionId);
            
            if (success) {
                return CommonResult.success("订阅已取消");
            } else {
                return CommonResult.failed("取消订阅失败");
            }
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Cancel subscription failed", e);
            return CommonResult.failed("取消订阅失败");
        }
    }
    
    @PostMapping("/renew/{subscriptionId}")
    @ApiOperation("续费套餐")
    public CommonResult<Map<String, Object>> renewSubscription(
            HttpServletRequest request,
            @PathVariable Long subscriptionId) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            OmsOrder renewOrder = subscriptionService.renewSubscription(memberId, subscriptionId);
            
            Map<String, Object> result = new HashMap<>();
            result.put("orderId", renewOrder.getId());
            result.put("orderSn", renewOrder.getOrderSn());
            result.put("payAmount", renewOrder.getPayAmount());
            
            return CommonResult.success(result, "续费订单创建成功");
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Renew subscription failed", e);
            return CommonResult.failed("续费失败");
        }
    }
    
    @GetMapping("/usage")
    @ApiOperation("获取套餐使用统计")
    public CommonResult<SubscriptionUsageVO> getUsageStatistics(
            HttpServletRequest request,
            @RequestParam(defaultValue = "30") Integer days) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            SubscriptionUsageVO usage = subscriptionService.getUsageStatistics(memberId, days);
            
            return CommonResult.success(usage);
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Get usage statistics failed", e);
            return CommonResult.failed("获取使用统计失败");
        }
    }
    
    @PostMapping("/check-permission")
    @ApiOperation("检查套餐权限")
    public CommonResult<Map<String, Boolean>> checkPermissions(
            HttpServletRequest request,
            @RequestBody Map<String, List<String>> params) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            List<String> features = params.get("features");
            
            if (features == null || features.isEmpty()) {
                return CommonResult.validateFailed("特性列表不能为空");
            }
            
            Map<String, Boolean> permissions = new HashMap<>();
            for (String feature : features) {
                boolean hasPermission = subscriptionService.checkPermission(memberId, feature);
                permissions.put(feature, hasPermission);
            }
            
            return CommonResult.success(permissions);
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Check permissions failed", e);
            return CommonResult.failed("权限检查失败");
        }
    }
    
    @PostMapping("/upgrade")
    @ApiOperation("升级套餐")
    public CommonResult<Map<String, Object>> upgradeSubscription(
            HttpServletRequest request,
            @RequestBody Map<String, Long> params) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            Long newPlanId = params.get("planId");
            
            if (newPlanId == null) {
                return CommonResult.validateFailed("新套餐ID不能为空");
            }
            
            Map<String, Object> result = subscriptionService.upgradeSubscription(memberId, newPlanId);
            
            return CommonResult.success(result, "升级申请已提交");
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Upgrade subscription failed", e);
            return CommonResult.failed("升级套餐失败");
        }
    }
    
    @GetMapping("/orders")
    @ApiOperation("获取套餐订单历史")
    public CommonResult<CommonPage<SubscriptionOrderVO>> getSubscriptionOrders(
            HttpServletRequest request,
            @RequestParam(defaultValue = "1") Integer pageNum,
            @RequestParam(defaultValue = "10") Integer pageSize) {
        
        try {
            Long memberId = getCurrentMemberId(request);
            PageHelper.startPage(pageNum, pageSize);
            
            List<SubscriptionOrderVO> orders = subscriptionService.getSubscriptionOrders(memberId);
            
            return CommonResult.success(CommonPage.restPage(orders));
            
        } catch (BusinessException e) {
            return CommonResult.failed(e.getMessage());
        } catch (Exception e) {
            log.error("Get subscription orders failed", e);
            return CommonResult.failed("获取订单历史失败");
        }
    }
    
    private Long getCurrentMemberId(HttpServletRequest request) {
        String token = extractTokenFromRequest(request);
        if (!StringUtils.hasText(token)) {
            throw new BusinessException("未登录");
        }
        
        return JwtUtils.getMemberIdFromToken(token);
    }
    
    private String extractTokenFromRequest(HttpServletRequest request) {
        String authHeader = request.getHeader("Authorization");
        if (StringUtils.hasText(authHeader) && authHeader.startsWith("Bearer ")) {
            return authHeader.substring(7);
        }
        return null;
    }
}
```

**验收标准**:
- [x] 所有API接口功能完整
- [x] 请求参数验证正确
- [x] 错误处理和日志完善
- [x] 响应格式统一规范

### 2.2 套餐比较和推荐接口

#### 2.2.1 套餐比较服务
```java
// SubscriptionComparisonService.java
@Service
public class SubscriptionComparisonService {
    
    @Autowired
    private PmsProductMapper productMapper;
    
    public SubscriptionComparisonVO compareAll() {
        List<PmsProduct> plans = productMapper.selectByProductType(3);
        
        SubscriptionComparisonVO comparison = new SubscriptionComparisonVO();
        
        // 按套餐等级分组
        Map<Integer, List<PmsProduct>> plansByLevel = plans.stream()
            .collect(Collectors.groupingBy(this::getPlanLevel));
        
        // 构建比较表格
        comparison.setFeatureMatrix(buildFeatureMatrix(plansByLevel));
        comparison.setPriceComparison(buildPriceComparison(plansByLevel));
        comparison.setRecommendations(buildRecommendations(plans));
        
        return comparison;
    }
    
    public PlanRecommendationVO getRecommendation(Long memberId) {
        // 基于用户历史使用情况推荐套餐
        UserSubscriptionVO current = subscriptionService.getCurrentSubscription(memberId);
        SubscriptionUsageVO usage = subscriptionService.getUsageStatistics(memberId, 30);
        
        PlanRecommendationVO recommendation = new PlanRecommendationVO();
        
        // 分析使用模式
        int avgDailyUsage = usage.getAverageDailyUsage();
        int currentLevel = current.getSubscriptionLevel();
        
        if (avgDailyUsage > current.getDailyCreditsLimit() * 0.9) {
            // 使用量接近限额，推荐升级
            recommendation.setAction("upgrade");
            recommendation.setRecommendedPlanId(findNextLevelPlan(currentLevel));
            recommendation.setReason("根据您的使用情况，建议升级以获得更多积分");
        } else if (avgDailyUsage < current.getDailyCreditsLimit() * 0.3) {
            // 使用量很低，推荐降级
            recommendation.setAction("downgrade");
            recommendation.setRecommendedPlanId(findPreviousLevelPlan(currentLevel));
            recommendation.setReason("您的使用量较低，可以考虑更经济的套餐");
        } else {
            // 使用量适中，保持当前
            recommendation.setAction("maintain");
            recommendation.setReason("您的当前套餐很适合您的使用需求");
        }
        
        return recommendation;
    }
    
    private int getPlanLevel(PmsProduct product) {
        String name = product.getName();
        if (name.contains("基础")) return 1;
        if (name.contains("标准")) return 2;
        if (name.contains("专业")) return 3;
        if (name.contains("企业")) return 4;
        return 0;
    }
    
    private Map<String, Map<String, Object>> buildFeatureMatrix(Map<Integer, List<PmsProduct>> plansByLevel) {
        Map<String, Map<String, Object>> matrix = new LinkedHashMap<>();
        
        // 特性列表
        String[] features = {
            "每日积分", "AI模型", "并发任务", "优先级", "客服支持", "文件大小", "历史记录"
        };
        
        for (String feature : features) {
            Map<String, Object> featureRow = new LinkedHashMap<>();
            for (int level = 0; level <= 4; level++) {
                List<PmsProduct> plans = plansByLevel.get(level);
                if (plans != null && !plans.isEmpty()) {
                    featureRow.put("level" + level, getFeatureValue(plans.get(0), feature));
                }
            }
            matrix.put(feature, featureRow);
        }
        
        return matrix;
    }
    
    private Object getFeatureValue(PmsProduct plan, String feature) {
        switch (feature) {
            case "每日积分":
                return plan.getDailyCredits() + "分";
            case "AI模型":
                return getPlanLevel(plan) == 0 ? "基础" : 
                       getPlanLevel(plan) <= 2 ? "标准" : "高级";
            case "并发任务":
                return plan.getMaxConcurrentTasks() + "个";
            case "优先级":
                return plan.getPriorityLevel() == 0 ? "普通" :
                       plan.getPriorityLevel() == 1 ? "高" : "最高";
            default:
                return "✓";
        }
    }
}
```

#### 2.2.2 比较接口
```java
@GetMapping("/compare")
@ApiOperation("获取套餐比较信息")
public CommonResult<SubscriptionComparisonVO> compareAllPlans() {
    try {
        SubscriptionComparisonVO comparison = subscriptionComparisonService.compareAll();
        return CommonResult.success(comparison);
        
    } catch (Exception e) {
        log.error("Compare plans failed", e);
        return CommonResult.failed("获取套餐比较失败");
    }
}

@GetMapping("/recommend")
@ApiOperation("获取个性化套餐推荐")
public CommonResult<PlanRecommendationVO> getPersonalizedRecommendation(HttpServletRequest request) {
    try {
        Long memberId = getCurrentMemberId(request);
        PlanRecommendationVO recommendation = subscriptionComparisonService.getRecommendation(memberId);
        
        return CommonResult.success(recommendation);
        
    } catch (BusinessException e) {
        return CommonResult.failed(e.getMessage());
    } catch (Exception e) {
        log.error("Get recommendation failed", e);
        return CommonResult.failed("获取推荐失败");
    }
}
```

**验收标准**:
- [x] 套餐比较功能完整
- [x] 个性化推荐算法合理
- [x] 数据展示清晰直观

### 2.3 套餐管理员接口

#### 2.3.1 管理员套餐操作
```java
@RestController
@RequestMapping("/api/admin/subscription")
@Validated
@Slf4j
public class AdminSubscriptionController {
    
    @Autowired
    private SubscriptionService subscriptionService;
    
    @PostMapping("/member/{memberId}/grant")
    @ApiOperation("管理员赠送套餐")
    @PreAuthorize("hasRole('ADMIN')")
    public CommonResult<String> grantSubscription(
            @PathVariable Long memberId,
            @RequestBody Map<String, Object> params) {
        
        try {
            Long planId = Long.valueOf(params.get("planId").toString());
            Integer days = Integer.valueOf(params.get("days").toString());
            String reason = params.get("reason").toString();
            
            subscriptionService.grantSubscription(memberId, planId, days, reason);
            
            return CommonResult.success("套餐赠送成功");
            
        } catch (Exception e) {
            log.error("Grant subscription failed", e);
            return CommonResult.failed("赠送套餐失败");
        }
    }
    
    @GetMapping("/statistics")
    @ApiOperation("获取套餐统计数据")
    @PreAuthorize("hasRole('ADMIN')")
    public CommonResult<SubscriptionStatisticsVO> getStatistics(
            @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate startDate,
            @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate endDate) {
        
        try {
            if (startDate == null) startDate = LocalDate.now().minusDays(30);
            if (endDate == null) endDate = LocalDate.now();
            
            SubscriptionStatisticsVO statistics = subscriptionService.getStatistics(startDate, endDate);
            
            return CommonResult.success(statistics);
            
        } catch (Exception e) {
            log.error("Get subscription statistics failed", e);
            return CommonResult.failed("获取统计数据失败");
        }
    }
}
```

**验收标准**:
- [x] 管理员权限控制正确
- [x] 赠送套餐功能完整
- [x] 统计数据准确详细

## 交付物
- [x] 完整的套餐API控制器
- [x] 套餐相关DTO类
- [x] 套餐比较和推荐服务
- [x] 管理员套餐管理接口

## 验证测试
1. 测试套餐订阅流程
2. 验证权限检查功能
3. 测试套餐比较接口
4. 检查使用统计数据
5. 验证管理员功能

## 风险控制
- **权限安全**: 确保权限检查的准确性
- **数据一致性**: 订阅状态变更的原子性
- **业务规则**: 严格执行套餐使用规则

## 下一步
完成后进入 `04-3-套餐前端状态管理`