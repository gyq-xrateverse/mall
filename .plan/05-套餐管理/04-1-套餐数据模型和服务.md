# 04-1: 套餐数据模型和服务

## 任务概述
**时间**: 第1-3天  
**目标**: 基于现有mall表结构设计套餐系统，实现核心后端服务  
**优先级**: 最高  
**依赖**: 03-积分系统完成

## 详细任务清单

### 1.1 数据库扩展设计

#### 1.1.1 扩展pms_product表（套餐商品）
```sql
-- 扩展商品表，支持套餐类型
ALTER TABLE pms_product ADD COLUMN product_type TINYINT DEFAULT 1 COMMENT '商品类型: 1-普通商品, 2-积分商品, 3-套餐商品';
ALTER TABLE pms_product ADD COLUMN subscription_period INT COMMENT '套餐周期(天): 30-月套餐, 90-季套餐, 365-年套餐';
ALTER TABLE pms_product ADD COLUMN daily_credits INT COMMENT '每日积分额度';
ALTER TABLE pms_product ADD COLUMN total_credits INT COMMENT '总积分额度(用于显示)';
ALTER TABLE pms_product ADD COLUMN max_concurrent_tasks INT DEFAULT 1 COMMENT '最大并发任务数';
ALTER TABLE pms_product ADD COLUMN priority_level TINYINT DEFAULT 0 COMMENT '任务优先级: 0-普通, 1-高, 2-最高';
ALTER TABLE pms_product ADD COLUMN features JSON COMMENT '套餐特性配置JSON';
```

#### 1.1.2 用户套餐订阅表
```sql
-- 利用现有oms_order表存储套餐订单
-- 扩展oms_order表
ALTER TABLE oms_order ADD COLUMN subscription_start_date DATE COMMENT '套餐开始日期';
ALTER TABLE oms_order ADD COLUMN subscription_end_date DATE COMMENT '套餐结束日期';
ALTER TABLE oms_order ADD COLUMN subscription_status TINYINT DEFAULT 0 COMMENT '订阅状态: 0-待生效, 1-有效, 2-过期, 3-已取消';
ALTER TABLE oms_order ADD COLUMN auto_renew TINYINT DEFAULT 0 COMMENT '是否自动续费: 0-否, 1-是';
```

#### 1.1.3 用户套餐使用记录表
```sql
-- 扩展ums_member表记录当前套餐
ALTER TABLE ums_member ADD COLUMN current_subscription_id BIGINT COMMENT '当前有效套餐订单ID';
ALTER TABLE ums_member ADD COLUMN subscription_level TINYINT DEFAULT 0 COMMENT '套餐等级: 0-免费, 1-基础, 2-标准, 3-专业, 4-企业';
ALTER TABLE ums_member ADD COLUMN daily_credits_limit INT DEFAULT 200 COMMENT '每日积分限额';
ALTER TABLE ums_member ADD COLUMN daily_credits_used INT DEFAULT 0 COMMENT '当日已使用积分';
ALTER TABLE ums_member ADD COLUMN subscription_end_date DATE COMMENT '套餐到期日期';

-- 创建套餐使用统计表
CREATE TABLE ums_subscription_usage (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    member_id BIGINT NOT NULL COMMENT '用户ID',
    subscription_order_id BIGINT NOT NULL COMMENT '套餐订单ID',
    usage_date DATE NOT NULL COMMENT '使用日期',
    credits_used INT DEFAULT 0 COMMENT '当日使用积分',
    tasks_created INT DEFAULT 0 COMMENT '当日创建任务数',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_member_date (member_id, usage_date),
    INDEX idx_subscription_order (subscription_order_id),
    INDEX idx_usage_date (usage_date)
) COMMENT='套餐使用统计表';
```

**验收标准**:
- [x] 所有表结构扩展成功
- [x] 字段类型和约束正确
- [x] 索引优化合理
- [x] 支持套餐层级管理

### 1.2 套餐配置数据

#### 1.2.1 套餐商品初始化
```sql
-- 初始化套餐商品数据
INSERT INTO pms_product (
    brand_id, product_category_id, name, sub_title, description, price, original_price, 
    stock, unit, weight, sort, gift_growth, gift_point, use_point_limit, product_sn, 
    keywords, publish_status, new_status, recommend_status, verify_status, sale, 
    product_type, subscription_period, daily_credits, total_credits, max_concurrent_tasks, 
    priority_level, features
) VALUES 
-- 基础套餐
(1, 2, '基础月套餐', '适合个人轻量使用', '每日500积分，基础功能完备', 29.90, 39.90, 999, '月', 0, 1, 0, 0, 0, 'SUB_BASIC_MONTHLY', '套餐,月付,基础', 1, 1, 0, 1, 0, 3, 30, 500, 15000, 1, 0, '{"features": ["基础AI模型", "标准生成速度", "邮件支持"], "limitations": {"max_file_size": "10MB", "max_history": 30}}'),

-- 标准套餐  
(1, 2, '标准月套餐', '适合专业设计师', '每日1200积分，高级功能解锁', 59.90, 79.90, 999, '月', 0, 2, 0, 0, 0, 'SUB_STANDARD_MONTHLY', '套餐,月付,标准', 1, 1, 1, 1, 0, 3, 30, 1200, 36000, 2, 1, '{"features": ["高级AI模型", "优先生成队列", "在线客服"], "limitations": {"max_file_size": "50MB", "max_history": 90}}'),

-- 专业套餐
(1, 2, '专业月套餐', '适合专业团队', '每日2500积分，专业功能全开', 119.90, 159.90, 999, '月', 0, 3, 0, 0, 0, 'SUB_PRO_MONTHLY', '套餐,月付,专业', 1, 1, 1, 1, 0, 3, 30, 2500, 75000, 5, 2, '{"features": ["顶级AI模型", "最高优先级", "专属客服", "API接口"], "limitations": {"max_file_size": "200MB", "max_history": 365}}'),

-- 企业套餐
(1, 2, '企业月套餐', '适合大型团队', '每日5000积分，企业级管理', 299.90, 399.90, 999, '月', 0, 4, 0, 0, 0, 'SUB_ENTERPRISE_MONTHLY', '套餐,月付,企业', 1, 0, 1, 1, 0, 3, 30, 5000, 150000, 10, 2, '{"features": ["企业级AI", "无限并发", "团队管理", "数据分析", "定制服务"], "limitations": {"max_file_size": "1GB", "max_history": -1}}'),

-- 季度套餐(15%折扣)
(1, 2, '标准季套餐', '季付更优惠', '标准版3个月，享85折优惠', 152.75, 179.70, 999, '季', 0, 12, 0, 0, 0, 'SUB_STANDARD_QUARTERLY', '套餐,季付,标准,优惠', 1, 1, 1, 1, 0, 3, 90, 1200, 108000, 2, 1, '{"features": ["高级AI模型", "优先生成队列", "在线客服"], "limitations": {"max_file_size": "50MB", "max_history": 90}}'),

-- 年度套餐(25%折扣)
(1, 2, '专业年套餐', '年付最划算', '专业版12个月，享75折优惠', 1079.10, 1439.40, 999, '年', 0, 13, 0, 0, 0, 'SUB_PRO_YEARLY', '套餐,年付,专业,最优惠', 1, 1, 1, 1, 0, 3, 365, 2500, 912500, 5, 2, '{"features": ["顶级AI模型", "最高优先级", "专属客服", "API接口"], "limitations": {"max_file_size": "200MB", "max_history": 365}}');
```

**验收标准**:
- [x] 套餐商品数据正确初始化
- [x] 价格策略和积分配置合理
- [x] 特性配置JSON结构正确
- [x] 支持多种订阅周期

### 1.3 套餐服务实现

#### 1.3.1 套餐服务接口
```java
// SubscriptionService.java
public interface SubscriptionService {
    
    /**
     * 获取用户当前套餐信息
     */
    UserSubscriptionVO getCurrentSubscription(Long memberId);
    
    /**
     * 获取所有可用套餐
     */
    List<SubscriptionPlanVO> getAvailablePlans();
    
    /**
     * 订阅套餐
     */
    OmsOrder subscribeToplan(Long memberId, Long planId, boolean autoRenew);
    
    /**
     * 取消订阅
     */
    boolean cancelSubscription(Long memberId, Long subscriptionId);
    
    /**
     * 续费套餐
     */
    OmsOrder renewSubscription(Long memberId, Long subscriptionId);
    
    /**
     * 检查套餐权限
     */
    boolean checkPermission(Long memberId, String feature);
    
    /**
     * 更新套餐使用统计
     */
    void updateUsageStats(Long memberId, int creditsUsed, int tasksCreated);
    
    /**
     * 每日套餐重置
     */
    void resetDailyLimits();
    
    /**
     * 套餐到期处理
     */
    void handleExpiredSubscriptions();
}
```

#### 1.3.2 套餐服务实现
```java
// SubscriptionServiceImpl.java
@Service
@Transactional
@Slf4j
public class SubscriptionServiceImpl implements SubscriptionService {
    
    @Autowired
    private UmsMemberMapper memberMapper;
    
    @Autowired
    private PmsProductMapper productMapper;
    
    @Autowired
    private OmsOrderMapper orderMapper;
    
    @Autowired
    private UmsSubscriptionUsageMapper usageMapper;
    
    @Override
    public UserSubscriptionVO getCurrentSubscription(Long memberId) {
        UmsMember member = memberMapper.selectByPrimaryKey(memberId);
        if (member == null) {
            throw new BusinessException("用户不存在");
        }
        
        UserSubscriptionVO vo = new UserSubscriptionVO();
        vo.setMemberId(memberId);
        vo.setSubscriptionLevel(member.getSubscriptionLevel());
        vo.setDailyCreditsLimit(member.getDailyCreditsLimit());
        vo.setDailyCreditsUsed(member.getDailyCreditsUsed());
        vo.setSubscriptionEndDate(member.getSubscriptionEndDate());
        
        // 获取当前套餐订单信息
        if (member.getCurrentSubscriptionId() != null) {
            OmsOrder order = orderMapper.selectByPrimaryKey(member.getCurrentSubscriptionId());
            if (order != null) {
                vo.setSubscriptionId(order.getId());
                vo.setSubscriptionStatus(order.getSubscriptionStatus());
                vo.setAutoRenew(order.getAutoRenew() == 1);
                vo.setSubscriptionStartDate(order.getSubscriptionStartDate());
                
                // 获取套餐商品信息
                PmsProduct product = productMapper.selectByPrimaryKey(order.getProductId());
                if (product != null) {
                    vo.setPlanName(product.getName());
                    vo.setPlanFeatures(parseFeatures(product.getFeatures()));
                    vo.setMaxConcurrentTasks(product.getMaxConcurrentTasks());
                    vo.setPriorityLevel(product.getPriorityLevel());
                }
            }
        }
        
        return vo;
    }
    
    @Override
    public List<SubscriptionPlanVO> getAvailablePlans() {
        // 查询套餐商品 (product_type = 3)
        List<PmsProduct> products = productMapper.selectByProductType(3);
        
        return products.stream()
            .filter(p -> p.getPublishStatus() == 1) // 已发布
            .sorted(Comparator.comparing(PmsProduct::getSort))
            .map(this::convertToPlanVO)
            .collect(Collectors.toList());
    }
    
    @Override
    public OmsOrder subscribeToplan(Long memberId, Long planId, boolean autoRenew) {
        UmsMember member = memberMapper.selectByPrimaryKey(memberId);
        if (member == null) {
            throw new BusinessException("用户不存在");
        }
        
        PmsProduct plan = productMapper.selectByPrimaryKey(planId);
        if (plan == null || plan.getProductType() != 3) {
            throw new BusinessException("套餐不存在");
        }
        
        // 检查是否有有效套餐
        if (member.getCurrentSubscriptionId() != null) {
            OmsOrder currentOrder = orderMapper.selectByPrimaryKey(member.getCurrentSubscriptionId());
            if (currentOrder != null && currentOrder.getSubscriptionStatus() == 1) {
                throw new BusinessException("已有有效套餐，请先取消或等待过期");
            }
        }
        
        // 创建订阅订单
        OmsOrder order = new OmsOrder();
        order.setMemberId(memberId);
        order.setProductId(planId);
        order.setOrderSn(generateOrderSn());
        order.setTotalAmount(plan.getPrice());
        order.setPayAmount(plan.getPrice());
        order.setOrderType(1); // 套餐订单
        order.setStatus(0); // 待支付
        order.setAutoRenew(autoRenew ? 1 : 0);
        order.setCreateTime(new Date());
        
        orderMapper.insert(order);
        
        log.info("Subscription order created for member {}: {}", memberId, order.getId());
        return order;
    }
    
    @Override
    public boolean cancelSubscription(Long memberId, Long subscriptionId) {
        OmsOrder order = orderMapper.selectByPrimaryKey(subscriptionId);
        if (order == null || !order.getMemberId().equals(memberId)) {
            throw new BusinessException("订阅不存在或无权限");
        }
        
        if (order.getSubscriptionStatus() != 1) {
            throw new BusinessException("套餐未处于有效状态");
        }
        
        // 取消订阅，设置为到期后不续费
        order.setAutoRenew(0);
        order.setSubscriptionStatus(3); // 已取消
        orderMapper.updateByPrimaryKey(order);
        
        // 更新用户套餐信息
        UmsMember member = memberMapper.selectByPrimaryKey(memberId);
        if (member.getCurrentSubscriptionId().equals(subscriptionId)) {
            member.setCurrentSubscriptionId(null);
            member.setSubscriptionLevel(0); // 回到免费版
            member.setDailyCreditsLimit(200); // 免费版限额
            memberMapper.updateByPrimaryKey(member);
        }
        
        log.info("Subscription cancelled for member {}: {}", memberId, subscriptionId);
        return true;
    }
    
    @Override
    public boolean checkPermission(Long memberId, String feature) {
        UserSubscriptionVO subscription = getCurrentSubscription(memberId);
        
        // 免费用户权限检查
        if (subscription.getSubscriptionLevel() == 0) {
            return checkFreeUserPermission(feature);
        }
        
        // 付费用户根据套餐等级检查权限
        Map<String, Object> features = subscription.getPlanFeatures();
        if (features == null) return false;
        
        switch (feature) {
            case "advanced_ai":
                return subscription.getSubscriptionLevel() >= 2;
            case "priority_queue":
                return subscription.getSubscriptionLevel() >= 2;
            case "api_access":
                return subscription.getSubscriptionLevel() >= 3;
            case "team_management":
                return subscription.getSubscriptionLevel() >= 4;
            default:
                return true;
        }
    }
    
    @Override
    public void updateUsageStats(Long memberId, int creditsUsed, int tasksCreated) {
        LocalDate today = LocalDate.now();
        
        UmsMember member = memberMapper.selectByPrimaryKey(memberId);
        if (member != null) {
            // 更新用户当日使用量
            int currentUsed = member.getDailyCreditsUsed() != null ? member.getDailyCreditsUsed() : 0;
            member.setDailyCreditsUsed(currentUsed + creditsUsed);
            memberMapper.updateByPrimaryKey(member);
            
            // 更新统计记录
            UmsSubscriptionUsage usage = usageMapper.selectByMemberAndDate(memberId, today);
            if (usage == null) {
                usage = new UmsSubscriptionUsage();
                usage.setMemberId(memberId);
                usage.setSubscriptionOrderId(member.getCurrentSubscriptionId());
                usage.setUsageDate(today);
                usage.setCreditsUsed(creditsUsed);
                usage.setTasksCreated(tasksCreated);
                usageMapper.insert(usage);
            } else {
                usage.setCreditsUsed(usage.getCreditsUsed() + creditsUsed);
                usage.setTasksCreated(usage.getTasksCreated() + tasksCreated);
                usageMapper.updateByPrimaryKey(usage);
            }
        }
    }
    
    @Override
    @Scheduled(cron = "0 0 0 * * ?") // 每天0点执行
    public void resetDailyLimits() {
        // 重置所有用户的每日积分使用量
        memberMapper.resetDailyCreditsUsed();
        log.info("Daily subscription limits reset completed");
    }
    
    @Override
    @Scheduled(cron = "0 0 1 * * ?") // 每天1点执行
    public void handleExpiredSubscriptions() {
        LocalDate today = LocalDate.now();
        List<OmsOrder> expiredOrders = orderMapper.selectExpiredSubscriptions(today);
        
        for (OmsOrder order : expiredOrders) {
            // 处理到期订阅
            if (order.getAutoRenew() == 1) {
                // 自动续费逻辑
                try {
                    renewSubscription(order.getMemberId(), order.getId());
                } catch (Exception e) {
                    log.error("Auto renewal failed for order {}: {}", order.getId(), e.getMessage());
                    handleSubscriptionExpiry(order);
                }
            } else {
                // 直接过期
                handleSubscriptionExpiry(order);
            }
        }
        
        log.info("Processed {} expired subscriptions", expiredOrders.size());
    }
    
    private void handleSubscriptionExpiry(OmsOrder order) {
        // 设置订阅为过期状态
        order.setSubscriptionStatus(2); // 过期
        orderMapper.updateByPrimaryKey(order);
        
        // 更新用户套餐信息
        UmsMember member = memberMapper.selectByPrimaryKey(order.getMemberId());
        if (member != null && order.getId().equals(member.getCurrentSubscriptionId())) {
            member.setCurrentSubscriptionId(null);
            member.setSubscriptionLevel(0);
            member.setDailyCreditsLimit(200);
            member.setSubscriptionEndDate(null);
            memberMapper.updateByPrimaryKey(member);
        }
    }
    
    private SubscriptionPlanVO convertToPlanVO(PmsProduct product) {
        SubscriptionPlanVO vo = new SubscriptionPlanVO();
        vo.setId(product.getId());
        vo.setName(product.getName());
        vo.setDescription(product.getSubTitle());
        vo.setPrice(product.getPrice());
        vo.setOriginalPrice(product.getOriginalPrice());
        vo.setSubscriptionPeriod(product.getSubscriptionPeriod());
        vo.setDailyCredits(product.getDailyCredits());
        vo.setTotalCredits(product.getTotalCredits());
        vo.setMaxConcurrentTasks(product.getMaxConcurrentTasks());
        vo.setPriorityLevel(product.getPriorityLevel());
        vo.setFeatures(parseFeatures(product.getFeatures()));
        vo.setIsRecommended(product.getRecommendStatus() == 1);
        vo.setIsHot(product.getNewStatus() == 1);
        
        // 计算折扣
        if (product.getOriginalPrice() != null && product.getOriginalPrice().compareTo(product.getPrice()) > 0) {
            BigDecimal discount = product.getPrice().divide(product.getOriginalPrice(), 2, RoundingMode.HALF_UP);
            vo.setDiscountPercentage(100 - discount.multiply(new BigDecimal("100")).intValue());
        }
        
        return vo;
    }
    
    private Map<String, Object> parseFeatures(String featuresJson) {
        try {
            return JSON.parseObject(featuresJson, new TypeReference<Map<String, Object>>(){});
        } catch (Exception e) {
            log.warn("Failed to parse features JSON: {}", featuresJson);
            return new HashMap<>();
        }
    }
    
    private boolean checkFreeUserPermission(String feature) {
        // 免费用户权限白名单
        Set<String> freeFeatures = Set.of("basic_ai", "standard_speed", "email_support");
        return freeFeatures.contains(feature);
    }
    
    private String generateOrderSn() {
        return "SUB" + System.currentTimeMillis() + (int)(Math.random() * 1000);
    }
}
```

**验收标准**:
- [x] 套餐服务核心逻辑正确
- [x] 权限检查机制完善
- [x] 订阅状态管理正确
- [x] 自动续费和到期处理完整

## 交付物
- [x] 数据库表结构扩展脚本
- [x] 套餐核心服务实现
- [x] 套餐商品初始化数据
- [x] 权限管理和统计服务

## 验证测试
1. 执行数据库扩展脚本
2. 测试套餐服务各方法
3. 验证权限检查机制
4. 测试订阅和取消流程
5. 验证自动续费逻辑

## 风险控制
- **数据一致性**: 使用事务确保订阅操作的原子性
- **权限安全**: 严格的权限检查机制
- **自动续费**: 完善的续费失败处理机制

## 下一步
完成后进入 `04-2-套餐API控制器开发`