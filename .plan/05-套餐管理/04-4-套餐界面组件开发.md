# 04-4: 套餐界面组件开发

## 任务概述
**时间**: 第8-9天  
**目标**: 开发完整的套餐管理界面组件  
**优先级**: 最高  
**依赖**: 04-3 套餐前端状态管理完成

## 详细任务清单

### 4.1 套餐展示组件

#### 4.1.1 套餐卡片组件
```tsx
// components/subscription/PlanCard.tsx
import React from 'react';
import { Card, Button, Badge, Tooltip, Divider } from 'antd';
import { CheckOutlined, CrownOutlined, FireOutlined } from '@ant-design/icons';
import { SubscriptionPlan } from '@/types/subscription';

interface PlanCardProps {
  plan: SubscriptionPlan;
  isCurrentPlan?: boolean;
  isRecommended?: boolean;
  onSelect: (planId: number) => void;
  loading?: boolean;
}

export const PlanCard: React.FC<PlanCardProps> = ({
  plan,
  isCurrentPlan,
  isRecommended,
  onSelect,
  loading = false,
}) => {
  const getPriorityIcon = (level: number) => {
    switch (level) {
      case 2: return <CrownOutlined style={{ color: '#faad14' }} />;
      case 1: return <FireOutlined style={{ color: '#f5222d' }} />;
      default: return null;
    }
  };

  const formatFeatures = (features: Record<string, any>) => {
    const featureList = features?.features || [];
    return featureList.map((feature: string, index: number) => (
      <div key={index} className="flex items-center mb-2">
        <CheckOutlined className="text-green-500 mr-2 text-xs" />
        <span className="text-sm text-gray-700">{feature}</span>
      </div>
    ));
  };

  const getDiscountBadge = () => {
    if (plan.discountPercentage && plan.discountPercentage > 0) {
      return (
        <Badge.Ribbon 
          text={`省${plan.discountPercentage}%`} 
          color="red"
        />
      );
    }
    return null;
  };

  return (
    <div className="relative">
      {getDiscountBadge()}
      <Card
        className={`h-full transition-all duration-300 hover:shadow-lg ${
          isCurrentPlan ? 'ring-2 ring-blue-500' : ''
        } ${isRecommended ? 'ring-2 ring-yellow-400' : ''}`}
        actions={[
          <Button
            key="select"
            type={isCurrentPlan ? "default" : "primary"}
            size="large"
            block
            loading={loading}
            disabled={isCurrentPlan}
            onClick={() => onSelect(plan.id)}
            className="mx-4"
          >
            {isCurrentPlan ? '当前套餐' : `选择${plan.periodText}套餐`}
          </Button>
        ]}
      >
        {/* 套餐头部 */}
        <div className="text-center mb-4">
          <div className="flex items-center justify-center mb-2">
            <h3 className="text-xl font-bold mr-2">{plan.name}</h3>
            {plan.isHot && <FireOutlined className="text-red-500" />}
            {getPriorityIcon(plan.priorityLevel)}
          </div>
          
          {isRecommended && (
            <Badge count="推荐" style={{ backgroundColor: '#52c41a' }} />
          )}
          
          <p className="text-gray-500 text-sm mt-2">{plan.description}</p>
        </div>

        {/* 价格展示 */}
        <div className="text-center mb-6">
          <div className="flex items-center justify-center">
            <span className="text-3xl font-bold text-blue-600">
              ¥{plan.price}
            </span>
            <span className="text-gray-500 ml-1">/{plan.periodText}</span>
          </div>
          
          {plan.originalPrice && plan.originalPrice > plan.price && (
            <div className="mt-1">
              <span className="text-sm text-gray-400 line-through">
                原价 ¥{plan.originalPrice}
              </span>
            </div>
          )}
          
          <div className="mt-2 text-sm text-gray-600">
            每日{plan.dailyCredits}积分
          </div>
        </div>

        {/* 功能特性 */}
        <div className="mb-4">
          <h4 className="font-semibold mb-3 text-center">套餐特权</h4>
          <div className="space-y-2">
            {formatFeatures(plan.features)}
            <div className="flex items-center mb-2">
              <CheckOutlined className="text-green-500 mr-2 text-xs" />
              <span className="text-sm text-gray-700">
                最多{plan.maxConcurrentTasks}个并发任务
              </span>
            </div>
          </div>
        </div>

        {/* 限制说明 */}
        {plan.features?.limitations && (
          <div className="pt-3 border-t border-gray-100">
            <div className="text-xs text-gray-500 space-y-1">
              {Object.entries(plan.features.limitations).map(([key, value], index) => (
                <div key={index}>
                  {key === 'max_file_size' && `最大文件: ${value}`}
                  {key === 'max_history' && value !== -1 && `历史记录: ${value}天`}
                </div>
              ))}
            </div>
          </div>
        )}
      </Card>
    </div>
  );
};
```

#### 4.1.2 套餐比较表格
```tsx
// components/subscription/PlanComparison.tsx
import React from 'react';
import { Table, Tag, Tooltip, Button } from 'antd';
import { CheckOutlined, CloseOutlined, InfoCircleOutlined } from '@ant-design/icons';

interface PlanComparisonProps {
  plans: SubscriptionPlan[];
  onSelectPlan: (planId: number) => void;
  currentPlanId?: number;
}

export const PlanComparison: React.FC<PlanComparisonProps> = ({
  plans,
  onSelectPlan,
  currentPlanId,
}) => {
  const formatValue = (value: any, type: string) => {
    switch (type) {
      case 'boolean':
        return value ? 
          <CheckOutlined className="text-green-500" /> : 
          <CloseOutlined className="text-red-500" />;
      case 'credits':
        return `${value}分/天`;
      case 'tasks':
        return `${value}个`;
      case 'priority':
        const priorities = ['普通', '高', '最高'];
        return <Tag color={value === 2 ? 'gold' : value === 1 ? 'orange' : 'default'}>
          {priorities[value] || '普通'}
        </Tag>;
      case 'price':
        return `¥${value}`;
      default:
        return value;
    }
  };

  const columns = [
    {
      title: '功能特性',
      dataIndex: 'feature',
      key: 'feature',
      width: 200,
      render: (text: string, record: any) => (
        <div className="flex items-center">
          <span className="font-medium">{text}</span>
          {record.tooltip && (
            <Tooltip title={record.tooltip}>
              <InfoCircleOutlined className="ml-2 text-gray-400" />
            </Tooltip>
          )}
        </div>
      ),
    },
    ...plans.map(plan => ({
      title: (
        <div className="text-center">
          <div className="font-semibold">{plan.name}</div>
          <div className="text-sm text-gray-500 mt-1">
            ¥{plan.price}/{plan.periodText}
          </div>
          {currentPlanId === plan.id && (
            <Tag color="blue" className="mt-1">当前套餐</Tag>
          )}
        </div>
      ),
      dataIndex: `plan_${plan.id}`,
      key: plan.id,
      align: 'center' as const,
      render: (value: any, record: any) => formatValue(value, record.type),
    })),
  ];

  const dataSource = [
    {
      key: 'price',
      feature: '月付价格',
      type: 'price',
      tooltip: '按月订阅的价格',
      ...plans.reduce((acc, plan) => ({ ...acc, [`plan_${plan.id}`]: plan.price }), {}),
    },
    {
      key: 'credits',
      feature: '每日积分',
      type: 'credits',
      tooltip: '每天可使用的积分数量',
      ...plans.reduce((acc, plan) => ({ ...acc, [`plan_${plan.id}`]: plan.dailyCredits }), {}),
    },
    {
      key: 'concurrent',
      feature: '并发任务',
      type: 'tasks',
      tooltip: '同时进行的任务数量',
      ...plans.reduce((acc, plan) => ({ ...acc, [`plan_${plan.id}`]: plan.maxConcurrentTasks }), {}),
    },
    {
      key: 'priority',
      feature: '任务优先级',
      type: 'priority',
      tooltip: '任务处理的优先级别',
      ...plans.reduce((acc, plan) => ({ ...acc, [`plan_${plan.id}`]: plan.priorityLevel }), {}),
    },
    {
      key: 'ai_model',
      feature: 'AI模型',
      type: 'string',
      tooltip: '可使用的AI模型级别',
      ...plans.reduce((acc, plan) => {
        const level = plan.features?.features?.includes('顶级AI模型') ? '顶级' :
                    plan.features?.features?.includes('高级AI模型') ? '高级' : '基础';
        return { ...acc, [`plan_${plan.id}`]: level };
      }, {}),
    },
    {
      key: 'support',
      feature: '客服支持',
      type: 'boolean',
      tooltip: '是否包含专属客服',
      ...plans.reduce((acc, plan) => ({ 
        ...acc, 
        [`plan_${plan.id}`]: plan.features?.features?.includes('专属客服') ||
                            plan.features?.features?.includes('在线客服')
      }), {}),
    },
    {
      key: 'api',
      feature: 'API接口',
      type: 'boolean',
      tooltip: '是否提供API接口调用',
      ...plans.reduce((acc, plan) => ({ 
        ...acc, 
        [`plan_${plan.id}`]: plan.features?.features?.includes('API接口') 
      }), {}),
    },
  ];

  return (
    <div className="bg-white rounded-lg shadow">
      <Table
        columns={columns}
        dataSource={dataSource}
        pagination={false}
        scroll={{ x: 800 }}
        className="comparison-table"
      />
      
      <div className="p-4 bg-gray-50 text-center">
        <div className="flex justify-center space-x-4">
          {plans.map(plan => (
            <Button
              key={plan.id}
              type={currentPlanId === plan.id ? "default" : "primary"}
              size="large"
              disabled={currentPlanId === plan.id}
              onClick={() => onSelectPlan(plan.id)}
            >
              {currentPlanId === plan.id ? '当前套餐' : `选择 ${plan.name}`}
            </Button>
          ))}
        </div>
      </div>
    </div>
  );
};
```

**验收标准**:
- [x] 套餐卡片展示完整信息
- [x] 比较表格直观易懂
- [x] 交互反馈及时准确
- [x] 响应式设计适配

### 4.2 订阅管理组件

#### 4.2.1 当前订阅状态组件
```tsx
// components/subscription/CurrentSubscription.tsx
import React from 'react';
import { Card, Progress, Tag, Button, Divider, Alert, Tooltip } from 'antd';
import { CalendarOutlined, CreditCardOutlined, SettingOutlined, 
         ExclamationCircleOutlined } from '@ant-design/icons';
import { UserSubscription } from '@/types/subscription';
import { formatDate, calculateDaysRemaining } from '@/utils/date';

interface CurrentSubscriptionProps {
  subscription: UserSubscription;
  onCancel: () => void;
  onRenew: () => void;
  onUpgrade: () => void;
  loading?: boolean;
}

export const CurrentSubscription: React.FC<CurrentSubscriptionProps> = ({
  subscription,
  onCancel,
  onRenew,
  onUpgrade,
  loading = false,
}) => {
  const creditsUsagePercent = subscription.dailyCreditsLimit > 0 
    ? Math.round((subscription.dailyCreditsUsed / subscription.dailyCreditsLimit) * 100)
    : 0;

  const daysRemaining = subscription.subscriptionEndDate 
    ? calculateDaysRemaining(subscription.subscriptionEndDate)
    : 0;

  const isExpiringSoon = daysRemaining <= 7 && daysRemaining > 0;
  const isExpired = daysRemaining <= 0;

  const getStatusTag = () => {
    if (subscription.subscriptionStatus === 0) {
      return <Tag color="orange">待生效</Tag>;
    }
    if (subscription.subscriptionStatus === 1) {
      return <Tag color="green">有效</Tag>;
    }
    if (subscription.subscriptionStatus === 2) {
      return <Tag color="red">已过期</Tag>;
    }
    if (subscription.subscriptionStatus === 3) {
      return <Tag color="gray">已取消</Tag>;
    }
    return <Tag>未知</Tag>;
  };

  const getProgressColor = () => {
    if (creditsUsagePercent >= 90) return '#f5222d';
    if (creditsUsagePercent >= 70) return '#faad14';
    return '#52c41a';
  };

  return (
    <Card
      title={
        <div className="flex items-center justify-between">
          <span>我的套餐</span>
          {getStatusTag()}
        </div>
      }
      extra={
        <Button
          icon={<SettingOutlined />}
          type="link"
          onClick={onUpgrade}
        >
          管理
        </Button>
      }
    >
      {/* 过期提醒 */}
      {(isExpiringSoon || isExpired) && (
        <Alert
          message={
            isExpired 
              ? "套餐已过期" 
              : `套餐将在 ${daysRemaining} 天后过期`
          }
          description={
            isExpired 
              ? "您的套餐已过期，请续费以继续使用高级功能" 
              : "建议及时续费以免影响使用"
          }
          type={isExpired ? "error" : "warning"}
          showIcon
          className="mb-4"
        />
      )}

      {/* 套餐信息 */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h3 className="text-lg font-semibold mb-4 flex items-center">
            <CreditCardOutlined className="mr-2" />
            {subscription.planName || '免费版'}
          </h3>
          
          <div className="space-y-3">
            <div className="flex justify-between">
              <span className="text-gray-600">套餐等级</span>
              <span className="font-medium">
                {['免费版', '基础版', '标准版', '专业版', '企业版'][subscription.subscriptionLevel]}
              </span>
            </div>
            
            <div className="flex justify-between">
              <span className="text-gray-600">自动续费</span>
              <Tag color={subscription.autoRenew ? 'green' : 'default'}>
                {subscription.autoRenew ? '已开启' : '已关闭'}
              </Tag>
            </div>
            
            <div className="flex justify-between">
              <span className="text-gray-600">最大并发</span>
              <span className="font-medium">{subscription.maxConcurrentTasks}个任务</span>
            </div>
          </div>
        </div>

        <div>
          <h4 className="text-base font-semibold mb-4 flex items-center">
            <CalendarOutlined className="mr-2" />
            使用情况
          </h4>
          
          {/* 积分使用进度 */}
          <div className="mb-4">
            <div className="flex justify-between mb-2">
              <span className="text-gray-600">今日积分</span>
              <span className="font-medium">
                {subscription.dailyCreditsUsed} / {subscription.dailyCreditsLimit}
              </span>
            </div>
            <Progress
              percent={creditsUsagePercent}
              strokeColor={getProgressColor()}
              size="small"
            />
          </div>

          {/* 到期时间 */}
          {subscription.subscriptionEndDate && (
            <div className="flex justify-between">
              <span className="text-gray-600">到期时间</span>
              <Tooltip title={formatDate(subscription.subscriptionEndDate)}>
                <span className={`font-medium ${isExpiringSoon || isExpired ? 'text-red-500' : ''}`}>
                  {daysRemaining > 0 ? `${daysRemaining}天后` : '已过期'}
                </span>
              </Tooltip>
            </div>
          )}
        </div>
      </div>

      <Divider />

      {/* 操作按钮 */}
      <div className="flex space-x-3">
        <Button type="primary" onClick={onUpgrade} loading={loading}>
          升级套餐
        </Button>
        
        {subscription.subscriptionLevel > 0 && (
          <>
            <Button onClick={onRenew} loading={loading}>
              续费
            </Button>
            
            {subscription.subscriptionStatus === 1 && (
              <Button 
                danger 
                ghost 
                onClick={onCancel}
                loading={loading}
                icon={<ExclamationCircleOutlined />}
              >
                取消订阅
              </Button>
            )}
          </>
        )}
      </div>
    </Card>
  );
};
```

#### 4.2.2 使用统计组件
```tsx
// components/subscription/UsageStatistics.tsx
import React from 'react';
import { Card, Statistic, Progress, Empty } from 'antd';
import { Line } from '@ant-design/charts';
import { SubscriptionUsage } from '@/types/subscription';
import { formatDate } from '@/utils/date';

interface UsageStatisticsProps {
  usage: SubscriptionUsage;
  period?: number;
}

export const UsageStatistics: React.FC<UsageStatisticsProps> = ({
  usage,
  period = 30,
}) => {
  if (!usage || !usage.dailyUsage?.length) {
    return (
      <Card title="使用统计">
        <Empty description="暂无使用数据" />
      </Card>
    );
  }

  const chartData = usage.dailyUsage.map(item => ({
    date: formatDate(item.date, 'MM/DD'),
    积分使用: item.creditsUsed,
    任务创建: item.tasksCreated,
  }));

  const chartConfig = {
    data: chartData,
    xField: 'date',
    yField: '积分使用',
    height: 300,
    smooth: true,
    point: {
      size: 3,
      shape: 'circle',
    },
    tooltip: {
      formatter: (datum: any) => ({
        name: '积分使用',
        value: `${datum.积分使用}分`,
      }),
    },
    color: '#1890ff',
  };

  return (
    <Card title={`使用统计 (最近${period}天)`}>
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <Statistic
          title="总积分使用"
          value={usage.totalCreditsUsed}
          suffix="分"
          valueStyle={{ color: '#3f8600' }}
        />
        <Statistic
          title="总任务数"
          value={usage.totalTasksCreated}
          suffix="个"
          valueStyle={{ color: '#1890ff' }}
        />
        <Statistic
          title="平均每日使用"
          value={usage.averageDailyUsage}
          suffix="分"
          valueStyle={{ color: '#722ed1' }}
        />
        <Statistic
          title="使用效率"
          value={Math.round((usage.totalCreditsUsed / (period * 200)) * 100)}
          suffix="%"
          valueStyle={{ color: '#faad14' }}
        />
      </div>

      <div className="mb-4">
        <h4 className="font-semibold mb-2">每日积分使用趋势</h4>
        <Line {...chartConfig} />
      </div>
    </Card>
  );
};
```

**验收标准**:
- [x] 订阅状态展示准确
- [x] 使用统计图表清晰
- [x] 操作功能完整
- [x] 响应式布局适配

### 4.3 套餐购买流程

#### 4.3.1 套餐选择页面
```tsx
// pages/subscription/SubscriptionPlans.tsx
import React, { useState, useEffect } from 'react';
import { Row, Col, Tabs, Button, message, Modal } from 'antd';
import { useNavigate } from 'react-router-dom';
import { PlanCard } from '@/components/subscription/PlanCard';
import { PlanComparison } from '@/components/subscription/PlanComparison';
import { useSubscription } from '@/hooks/useSubscription';
import { useSubscribeToPlanMutation } from '@/api/subscriptionApi';
import type { SubscriptionPlan } from '@/types/subscription';

const SubscriptionPlans: React.FC = () => {
  const navigate = useNavigate();
  const { currentSubscription, availablePlans, isLoading } = useSubscription();
  const [subscribeToPlan, { isLoading: subscribeLoading }] = useSubscribeToPlanMutation();
  
  const [selectedPlan, setSelectedPlan] = useState<SubscriptionPlan | null>(null);
  const [showConfirm, setShowConfirm] = useState(false);
  const [autoRenew, setAutoRenew] = useState(false);

  const monthlyPlans = availablePlans.filter(plan => plan.subscriptionPeriod <= 31);
  const yearlyPlans = availablePlans.filter(plan => plan.subscriptionPeriod > 90);

  const handleSelectPlan = (planId: number) => {
    const plan = availablePlans.find(p => p.id === planId);
    if (plan) {
      setSelectedPlan(plan);
      setShowConfirm(true);
    }
  };

  const handleConfirmSubscription = async () => {
    if (!selectedPlan) return;

    try {
      const result = await subscribeToPlan({
        planId: selectedPlan.id,
        autoRenew,
      }).unwrap();

      message.success('订阅订单创建成功，即将跳转到支付页面');
      
      // 跳转到支付页面
      navigate(`/payment/subscription/${result.orderId}`, {
        state: { orderData: result }
      });

    } catch (error: any) {
      message.error(error.data?.message || '订阅失败，请重试');
    } finally {
      setShowConfirm(false);
    }
  };

  const tabItems = [
    {
      key: 'monthly',
      label: '按月订阅',
      children: (
        <Row gutter={[24, 24]}>
          {monthlyPlans.map(plan => (
            <Col xs={24} sm={12} lg={8} key={plan.id}>
              <PlanCard
                plan={plan}
                isCurrentPlan={currentSubscription?.subscriptionId === plan.id}
                isRecommended={plan.isRecommended}
                onSelect={handleSelectPlan}
                loading={subscribeLoading}
              />
            </Col>
          ))}
        </Row>
      ),
    },
    {
      key: 'yearly',
      label: '按年订阅',
      children: (
        <Row gutter={[24, 24]}>
          {yearlyPlans.map(plan => (
            <Col xs={24} sm={12} lg={8} key={plan.id}>
              <PlanCard
                plan={plan}
                isCurrentPlan={currentSubscription?.subscriptionId === plan.id}
                isRecommended={plan.isRecommended}
                onSelect={handleSelectPlan}
                loading={subscribeLoading}
              />
            </Col>
          ))}
        </Row>
      ),
    },
    {
      key: 'compare',
      label: '功能对比',
      children: (
        <PlanComparison
          plans={availablePlans}
          currentPlanId={currentSubscription?.subscriptionId}
          onSelectPlan={handleSelectPlan}
        />
      ),
    },
  ];

  return (
    <div className="max-w-7xl mx-auto px-4 py-8">
      <div className="text-center mb-8">
        <h1 className="text-3xl font-bold mb-4">选择适合您的套餐</h1>
        <p className="text-gray-600 text-lg">
          解锁更多功能，提升创作效率
        </p>
      </div>

      <Tabs
        defaultActiveKey="monthly"
        items={tabItems}
        size="large"
        centered
      />

      {/* 订阅确认弹窗 */}
      <Modal
        title="确认订阅"
        open={showConfirm}
        onOk={handleConfirmSubscription}
        onCancel={() => setShowConfirm(false)}
        confirmLoading={subscribeLoading}
        okText="确认订阅"
        cancelText="取消"
      >
        {selectedPlan && (
          <div className="py-4">
            <div className="text-center mb-4">
              <h3 className="text-xl font-semibold">{selectedPlan.name}</h3>
              <div className="text-2xl font-bold text-blue-600 mt-2">
                ¥{selectedPlan.price} / {selectedPlan.periodText}
              </div>
            </div>
            
            <div className="space-y-2 text-sm">
              <div className="flex justify-between">
                <span>每日积分：</span>
                <span>{selectedPlan.dailyCredits}分</span>
              </div>
              <div className="flex justify-between">
                <span>并发任务：</span>
                <span>{selectedPlan.maxConcurrentTasks}个</span>
              </div>
              <div className="flex justify-between">
                <span>优先级：</span>
                <span>{['普通', '高', '最高'][selectedPlan.priorityLevel]}</span>
              </div>
            </div>

            <div className="mt-4">
              <label className="flex items-center">
                <input
                  type="checkbox"
                  checked={autoRenew}
                  onChange={(e) => setAutoRenew(e.target.checked)}
                  className="mr-2"
                />
                自动续费
              </label>
            </div>
          </div>
        )}
      </Modal>
    </div>
  );
};

export default SubscriptionPlans;
```

**验收标准**:
- [x] 套餐展示清晰完整
- [x] 选择流程顺畅
- [x] 确认信息准确
- [x] 支付跳转正常

## 交付物
- [x] 套餐展示组件
- [x] 订阅管理组件
- [x] 使用统计组件
- [x] 购买流程页面

## 验证测试
1. 测试套餐卡片展示
2. 验证比较表格功能
3. 测试订阅管理操作
4. 检查统计图表展示
5. 验证购买流程完整性

## 风险控制
- **用户体验**: 确保界面清晰易懂
- **数据准确性**: 展示信息与后端同步
- **操作安全**: 重要操作需要确认

## 下一步
完成后进入 `04-5-套餐系统集成测试`